function e(...e){const t={};for(const s of e)t[s]=s;return Object.freeze(t)}function t(e){try{return new URL(e).origin}catch(t){return new URL(`https://${e}`).origin}}class s{constructor(e){this._abortable=null;this.result=e((e=>(this._abortable=e,e)))}abort(){this._abortable?.abort(),this._abortable=null}}class i extends Error{get name(){return"AbortError"}}class r{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),1===this._handlers.size&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),0===this._handlers.size&&this.onUnsubscribeLast())}unsubscribeAll(){0!==this._handlers.size&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return 0!==this._handlers.size}}class n extends r{emit(e){for(const t of this._handlers)t(e)}waitFor(e){return e(this.get())?new a(Promise.resolve(this.get())):new o(this,e)}}class o{constructor(e,t){this._promise=new Promise(((s,i)=>{this._reject=i,this._subscription=e.subscribe((e=>{t(e)&&(this._reject=null,s(e),this.dispose())}))}))}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new i),this._reject=null)}}class a{constructor(e){this.promise=e}dispose(){}}class h extends n{constructor(e){super(),this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}}class c extends h{constructor(e,t){super(e),this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}}const l={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0};class d{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",l[t]||(t="application/octet-stream"),new d(new Blob([e],{type:t}),e)}static fromBlob(e){return new d(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{const e=new FileReader,t=new Promise(((t,s)=>{e.addEventListener("load",(e=>t(e.target.result))),e.addEventListener("error",(e=>s(e.target.error)))}));return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||"application/octet-stream"}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}}function u(e){return Object.entries(e||{}).filter((([,e])=>void 0!==e)).map((([e,t])=>("object"==typeof t&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`))).join("&")}class m extends Error{constructor(e,t){super(`${e}: ${t.message}`),this.cause=t}get name(){return"WrappedError"}}class p extends Error{constructor(e,t,s,i){super(`${s?s.error:i} on ${e} ${t}`),this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=i}get name(){return"HomeServerError"}}class _ extends Error{constructor(e,t){super(e||"ConnectionError"),this.isTimeout=t}get name(){return"ConnectionError"}}class g{constructor(e,t,s,i){this._log=i,this._sourceRequest=s,this._promise=s.response().then((s=>{if(i?.set("status",s.status),s.status>=200&&s.status<300)return i?.finish(),s.body;if(s.status>=500){const e=new _("Internal Server Error");throw i?.catch(e),e}if(s.status>=400&&!s.body?.errcode){const e=new _(`HTTP error status ${s.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw i?.catch(e),e}{const r=new p(e,t,s.body,s.status);throw i?.set("errcode",r.errcode),i?.catch(r),r}}),(e=>{if("AbortError"===e.name&&this._sourceRequest){const e=new _("Service worker aborted, either updating or hit #187.");throw i?.catch(e),e}throw"ConnectionError"===e.name&&i?.set("timeout",e.isTimeout),i?.catch(e),e}))}abort(){this._sourceRequest&&(this._log?.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}}const y="/_matrix/client/unstable/org.matrix.msc2697.v2";class f{constructor({homeserver:e,accessToken:t,request:s,reconnector:i}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=i}_url(e,t="/_matrix/client/r0"){return this._homeserver+t+e}_baseRequest(e,t,s,i,r,n){let o,a;if(t=`${t}?${u(s)}`,r?.log){const s=r?.log;o=s.child({t:"network",url:t,method:e},s.level.Info)}const h=new Map;if(n&&h.set("Authorization",`Bearer ${n}`),h.set("Accept","application/json"),i){const e=function(e){if(e instanceof d){const t=e;return{mimeType:t.mimeType,body:t}}if("object"==typeof e)return{mimeType:"application/json",body:JSON.stringify(e)};throw new Error("Unknown body type: "+e)}(i);h.set("Content-Type",e.mimeType),a=e.body}const c=this._requestFn(t,{method:e,headers:h,body:a,timeout:r?.timeout,uploadProgress:r?.uploadProgress,format:"json"}),l=new g(e,t,c,o);return this._reconnector&&l.response().catch((e=>{"ConnectionError"===e.name&&this._reconnector.onRequestFailed(this)})),l}_unauthedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r)}_authedRequest(e,t,s,i,r){return this._baseRequest(e,t,s,i,r,this._accessToken)}_post(e,t,s,i){return this._authedRequest("POST",this._url(e,i?.prefix||"/_matrix/client/r0"),t,s,i)}_put(e,t,s,i){return this._authedRequest("PUT",this._url(e,i?.prefix||"/_matrix/client/r0"),t,s,i)}_get(e,t,s,i){return this._authedRequest("GET",this._url(e,i?.prefix||"/_matrix/client/r0"),t,s,i)}sync(e,t,s,i){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,i)}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}redact(e,t,s,i,r){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},i,r)}receipt(e,t,s,i){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},i)}state(e,t,s,i){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,i)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}passwordLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},i)}tokenLogin(e,t,s,i){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},i)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let i="/keys/upload";return e&&(i+=`/${encodeURIComponent(e)}`),this._post(i,{},t,s)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,i){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,i)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,i){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,i)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e){return e.prefix=y,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t){return t.prefix=y,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t){return t.prefix=y,this._post("/dehydrated_device/claim",{},{device_id:e},t)}}class v{constructor(e){this._start=2e3,this._current=2e3;this._start=2e3,this._current=2e3,this._createTimeout=e,this._max=3e5}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();const e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof i))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}}var w;!function(e){e[e.Waiting=0]="Waiting",e[e.Reconnecting=1]="Reconnecting",e[e.Online=2]="Online"}(w||(w={}));class b{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new h(w.Online),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===w.Waiting?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;const t=this._onlineStatus&&this._onlineStatus.subscribe((e=>{e&&this.tryNow()}));try{await this._reconnectLoop(e)}catch(e){console.error(e)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===w.Waiting?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(w.Reconnecting);const t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(w.Online)}catch(e){if("ConnectionError"!==e.name)throw e;this._setState(w.Waiting),await this._retryDelay.waitForRetry()}}}class S{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,i){const r=this._parseMxcUrl(e);if(r){const[e,n]=r;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(e)}/${encodeURIComponent(n)}`+"?"+u({width:Math.round(t),height:Math.round(s),method:i})}return null}mxcUrl(e){const t=this._parseMxcUrl(e);if(t){const[e,s]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(e)}/${encodeURIComponent(s)}`}return null}_parseMxcUrl(e){const t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){const s=this.mxcUrl(e.url),{body:i}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),r=await async function(e,t,s){if(void 0===s||void 0===s.key||void 0===s.iv||void 0===s.hashes||void 0===s.hashes.sha256)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");const{crypto:i}=e,{base64:r}=e.encoding;var n=r.decode(s.iv),o=r.encode(r.decode(s.hashes.sha256));const a=await i.digest("SHA-256",t);if(r.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var h;return h="v1"==s.v||"v2"==s.v?64:128,await i.aes.decryptCTR({jwkKey:s.key,iv:n,data:t,counterLength:h})}(this._platform,i,e);return this._platform.createBlob(r,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){const i=this.mxcUrl(e),{body:r}=await this._platform.request(i,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(r,t)}async downloadAttachment(e,t=!1){return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,e.info?.mimetype,t)}}class I{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}abort(){this.requestResult?this.requestResult.abort():this.reject(new i)}response(){return this._responsePromise}}class E{constructor(e){this._scheduler=e}}for(const e of Object.getOwnPropertyNames(f.prototype))"constructor"===e||e.startsWith("_")||(E.prototype[e]=function(...t){return this._scheduler._hsApiRequest(e,t)});class k{constructor({hsApi:e,clock:t}){this._requests=new Set,this._stopped=!1,this._wrapper=new E(this),this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(const e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){const s=new I(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{const t=this._hsApi[e.methodName].apply(this._hsApi,e.args);e.requestResult=t;const s=await t.response();return void e.resolve(s)}catch(s){if(!(s instanceof p&&"M_LIMIT_EXCEEDED"===s.errcode))return void e.reject(s);Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new v(this._clock.createTimeout)),await t.waitForRetry())}this._stopped&&e.abort()}finally{this._requests.delete(e)}}}const R=e("InitialSync","CatchupSync","Syncing","Stopped");function C(e){try{const t=e?.timeline?.events;return Array.isArray(t)&&0===t.length}catch(e){return!0}}class A{constructor({hsApi:e,session:t,storage:s,logger:i}){this._hsApi=e,this._logger=i,this._session=t,this._storage=s,this._currentRequest=null,this._status=new h(R.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==R.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(R.CatchupSync):this._status.set(R.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==R.Stopped;){let t,s,i=this._status.get()===R.CatchupSync||this._status.get()===R.InitialSync;await this._logger.run("sync",(async i=>{i.set("token",e),i.set("status",this._status.get());try{const r=this._status.get()===R.Syncing?3e4:0,n=await this._syncRequest(e,r,i);e=n.syncToken,t=n.roomStates,s=n.sessionChanges,this._status.get()!==R.Syncing&&n.hadToDeviceMessages?this._status.set(R.CatchupSync):this._status.set(R.Syncing)}catch(e){if("ConnectionError"===e.name&&e.isTimeout)return;this._error=e,"AbortError"!==e.name&&(i.error=e,i.logLevel=i.level.Fatal),i.set("stopping",!0),this._status.set(R.Stopped)}this._status.get()!==R.Stopped&&await i.wrap("afterSyncCompleted",(e=>this._runAfterSyncCompleted(s,t,e)))}),this._logger.level.Info,((e,t)=>t.durationWithoutType("network")>=2e3||t.error||i?e.minLevel(t.level.Detail):e.minLevel(t.level.Info)))}}async _runAfterSyncCompleted(e,t,s){const i=this._status.get()===R.CatchupSync,r=(async()=>{try{await s.wrap("session",(t=>this._session.afterSyncCompleted(e,i,t)),s.level.Detail)}catch(e){}})(),n=t.filter((e=>e.room.needsAfterSyncCompleted(e.changes))).map((async e=>{try{await s.wrap("room",(t=>e.room.afterSyncCompleted(e.changes,t)),s.level.Detail)}catch(e){}}));await Promise.all(n.concat(r))}async _syncRequest(e,t,s){let{syncFilterId:i}=this._session;"string"!=typeof i&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),i=(await this._currentRequest.response()).filter_id);const r=t+8e4;this._currentRequest=this._hsApi.sync(e,i,t,{timeout:r,log:s});const n=await this._currentRequest.response(),o=!e,a=new M,h=this._parseInvites(n.rooms),{roomStates:c,archivedRoomStates:l}=await this._parseRoomsResponse(n.rooms,h,o,s);try{a.lock=await s.wrap("obtainSyncLock",(()=>this._session.obtainSyncLock(n))),await s.wrap("prepare",(e=>this._prepareSync(a,c,n,e))),await s.wrap("afterPrepareSync",(e=>Promise.all(c.map((t=>t.room.afterPrepareSync(t.preparation,e)))))),await s.wrap("write",(async e=>this._writeSync(a,h,c,l,n,i,o,e)))}finally{a.dispose()}s.wrap("after",(e=>this._afterSync(a,h,c,l,e)));const d=n.to_device?.events;return{syncToken:n.next_batch,roomStates:c,sessionChanges:a.changes,hadToDeviceMessages:Array.isArray(d)&&d.length>0}}_openPrepareSyncTxn(){const e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,i){const r=await this._openPrepareSyncTxn();e.preparation=await i.wrap("session",(t=>this._session.prepareSync(s,e.lock,r,t)));const n=e.preparation?.newKeysByRoom;if(n){const{hasOwnProperty:e}=Object.prototype;for(const i of n.keys()){if(!(s.rooms?.join&&e.call(s.rooms.join,i))){let e=this._session.rooms.get(i);e&&t.push(new T(e,!1,null,{},e.membership))}}}await Promise.all(t.map((async e=>{const t=n?.get(e.room.id);e.preparation=await i.wrap("room",(async s=>(e.isNewRoom&&await e.room.load(null,r,s),e.room.prepareSync(e.roomResponse,e.membership,e.invite,t,r,s))),i.level.Detail)}))),await r.complete()}async _writeSync(e,t,s,i,r,n,o,a){const h=await this._openSyncTxn();try{e.changes=await a.wrap("session",(t=>this._session.writeSync(r,n,e.preparation,h,t))),await Promise.all(t.map((async e=>{e.changes=await a.wrap("invite",(t=>e.invite.writeSync(e.membership,e.roomResponse,h,t)))}))),await Promise.all(s.map((async e=>{e.changes=await a.wrap("room",(t=>e.room.writeSync(e.roomResponse,o,e.preparation,h,t)))}))),await Promise.all(i.map((async e=>{const t=e.roomState?.summaryChanges;e.changes=await a.wrap("archivedRoom",(s=>e.archivedRoom.writeSync(t,e.roomResponse,e.membership,h,s)))})))}catch(e){throw h.abort(a),h.getCause(e)}await h.complete(a)}_afterSync(e,t,s,i,r){r.wrap("session",(t=>this._session.afterSync(e.changes,t)),r.level.Detail);for(let e of i)r.wrap("archivedRoom",(t=>{e.archivedRoom.afterSync(e.changes,t),e.archivedRoom.release()}),r.level.Detail);for(let e of s)r.wrap("room",(t=>e.room.afterSync(e.changes,t)),r.level.Detail);for(let e of t)r.wrap("invite",(t=>e.invite.afterSync(e.changes,t)),r.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,i)}_openSyncTxn(){const e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,s,i){const r=[],n=[];if(e){const o=["join","leave"];for(const a of o){const o=e[a];if(o)for(const[e,h]of Object.entries(o)){if(s&&C(h))continue;const o=this._session.invites.get(e);o&&t.push(new N(o,!1,null,a));const c=this._createRoomSyncState(e,o,h,a,s);c&&r.push(c);const l=await this._createArchivedRoomSyncState(e,c,h,a,s,i);l&&n.push(l)}}}return{roomStates:r,archivedRoomStates:n}}_createRoomSyncState(e,t,s,i,r){let n=!1,o=this._session.rooms.get(e);if(!o&&("join"===i||r&&"leave"===i)&&(o=this._session.createRoom(e),n=!0),o)return new T(o,n,t,s,i)}async _createArchivedRoomSyncState(e,t,s,i,r,n){let o;if(t?.shouldAdd&&!r?o=this._session.createOrGetArchivedRoomForSync(e):"leave"===i&&(o=t?this._session.createOrGetArchivedRoomForSync(e):await this._session.loadArchivedRoom(e,n)),o)return new x(o,t,s,i)}_parseInvites(e){const t=[];if(e?.invite)for(const[s,i]of Object.entries(e.invite)){let e=this._session.invites.get(s),r=!1;e||(e=this._session.createInvite(s),r=!0),t.push(new N(e,r,i,"invite"))}return t}stop(){this._status.get()!==R.Stopped&&(this._status.set(R.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}}class M{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){this.lock?.release()}}class T{constructor(e,t,s,i,r){this.room=e,this.isNewRoom=t,this.invite=s,this.roomResponse=i,this.membership=r,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&"join"===this.membership}get shouldRemove(){return!this.isNewRoom&&"join"!==this.membership}get summaryChanges(){return this.changes?.summaryChanges}}class x{constructor(e,t,s,i,r){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=i,this.isInitialSync=r,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&"leave"===this.membership}get shouldRemove(){return"join"===this.membership}}class N{constructor(e,t,s,i){this.invite=e,this.isNewInvite=t,this.membership=i,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return"invite"!==this.membership}}class U{constructor(){this._handlersByName={}}emit(e,t){const s=this._handlersByName[e];s&&s.forEach((e=>e(t)))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){const s=this._handlersByName[e];s&&(s.delete(t),0===s.size&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;for(var L=/[\\\"\x00-\x1F]/g,O={},D=0;D<32;++D)O[String.fromCharCode(D)]="\\U"+("0000"+D.toString(16)).slice(-4).toUpperCase();function B(e){return L.lastIndex=0,e.replace(L,(function(e){return O[e]}))}function P(e){switch(typeof e){case"string":return'"'+B(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",s="",i=0;i<e.length;++i)s+=t,t=",",s+=P(e[i]);return","!=t?"[]":s+"]"}(e):function(e){var t="{",s="",i=Object.keys(e);i.sort();for(var r=0;r<i.length;++r){var n=i[r];s+=t+'"'+B(n)+'":',t=",",s+=P(e[n])}return","!=t?"{}":s+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}O["\b"]="\\b",O["\t"]="\\t",O["\n"]="\\n",O["\f"]="\\f",O["\r"]="\\r",O['"']='\\"',O["\\"]="\\\\";var K={stringify:P};const V=e("Sync","Timeline","Retry"),F="m.olm.v1.curve25519-aes-sha2",$="m.megolm.v1.aes-sha2";class j extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`),this.code=e,this.event=t,this.details=s}}function q(e,t,s,i,r,n){const o=Object.assign({},r);delete o.unsigned,delete o.signatures;const a=K.stringify(o),h=r?.signatures?.[t]?.[`ed25519:${s}`];try{if(!h)throw new Error("no signature");return e.ed25519_verify(i,a,h),!0}catch(e){if(n){const t=n.log({l:"Invalid signature, ignoring.",ed25519Key:i,canonicalJson:a,signature:h});t.error=e,t.logLevel=n.level.Warn}return!1}}function W(e,t,s){const i=e?.state?.events;Array.isArray(i)&&(s=i.reduce(t,s));const r=e?.timeline?.events;return Array.isArray(r)&&(s=r.reduce(((e,i)=>("string"==typeof i.state_key&&(s=t(s,i)),s)),s)),s}function H(e,t,s){t.summary&&(e=function(e,t){const s=t["m.heroes"],i=t["m.joined_member_count"],r=t["m.invited_member_count"];s&&Array.isArray(s)&&((e=e.cloneIfNeeded()).heroes=s);Number.isInteger(r)&&((e=e.cloneIfNeeded()).inviteCount=r);Number.isInteger(i)&&((e=e.cloneIfNeeded()).joinCount=i);return e}(e,t.summary)),s!==e.membership&&((e=e.cloneIfNeeded()).membership=s),t.account_data&&(e=t.account_data.events.reduce(z,e)),e=W(t,G,e);const i=t.unread_notifications;return i&&(e=function(e,t){const s=t.highlight_count||0;s!==e.highlightCount&&((e=e.cloneIfNeeded()).highlightCount=s);const i=t.notification_count;i!==e.notificationCount&&((e=e.cloneIfNeeded()).notificationCount=i);return e}(e,i)),e}function z(e,t){if("m.tag"===t?.type){let s=t?.content?.tags;s&&!Array.isArray(s)&&"object"==typeof s||(s=null),(e=e.cloneIfNeeded()).tags=s}return e}function G(e,t){if("m.room.encryption"===t.type){const s=t.content?.algorithm;e.encryption||s!==$||((e=e.cloneIfNeeded()).encryption=t.content)}else if("m.room.name"===t.type){const s=t.content?.name;s!==e.name&&((e=e.cloneIfNeeded()).name=s)}else if("m.room.avatar"===t.type){const s=t.content?.url;s!==e.avatarUrl&&((e=e.cloneIfNeeded()).avatarUrl=s)}else if("m.room.canonical_alias"===t.type){const s=t.content;(e=e.cloneIfNeeded()).canonicalAlias=s.alias}return e}class Q{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=!!e&&e.isUnread,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=!!e&&e.hasFetchedMembers,this.isTrackingMembers=!!e&&e.isTrackingMembers,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=!!e&&e.isDirectMessage,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}diff(e){return Object.getOwnPropertyNames(this).reduce(((t,s)=>("cloned"!==s&&this[s]!==e[s]&&(t[s]=this[s]),t)),{})}cloneIfNeeded(){return this.cloned?this:new Q(this)}serialize(){return Object.entries(this).reduce(((e,[t,s])=>("cloned"!==t&&null!==s&&(e[t]=s),e)),{})}applyTimelineEntries(e,t,s,i){return function(e,t,s,i,r){return t.length&&(e=t.reduce(((e,t)=>function(e,t,s,i,r){return"m.room.message"===t.eventType&&((!e.lastMessageTimestamp||t.timestamp>e.lastMessageTimestamp)&&((e=e.cloneIfNeeded()).lastMessageTimestamp=t.timestamp),!s&&t.sender!==r&&i&&((e=e.cloneIfNeeded()).isUnread=!0)),e}(e,t,s,i,r)),e)),e}(this,e,t,s,i)}applySyncResponse(e,t){return H(this,e,t)}applyInvite(e){return function(e,t){return e.isDirectMessage!==t.isDirectMessage&&((e=e.cloneIfNeeded()).isDirectMessage=t.isDirectMessage,t.isDirectMessage?e.dmUserId=t.inviter?.userId:e.dmUserId=null),e}(this,e)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return"join"===this.membership&&"join"!==e.membership}}class J{constructor(e){this._data=null,this.applyChanges(new Q(null,e))}get data(){return this._data}writeClearUnread(e){const t=new Q(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){const s=new Q(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){const s=new Q(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;const s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(e){throw s.abort(),e}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new Q(e))}}var Y;!function(e){e.session="session",e.roomState="roomState",e.roomSummary="roomSummary",e.archivedRoomSummary="archivedRoomSummary",e.invites="invites",e.roomMembers="roomMembers",e.timelineEvents="timelineEvents",e.timelineRelations="timelineRelations",e.timelineFragments="timelineFragments",e.pendingEvents="pendingEvents",e.userIdentities="userIdentities",e.deviceIdentities="deviceIdentities",e.olmSessions="olmSessions",e.inboundGroupSessions="inboundGroupSessions",e.outboundGroupSessions="outboundGroupSessions",e.groupSessionDecryptions="groupSessionDecryptions",e.operations="operations",e.accountData="accountData"}(Y||(Y={}));const X=Object.values(Y);class Z extends Error{constructor(e,t=null){super(e),t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}}const ee={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};class te{constructor(e,t){this.fragmentId=e,this.eventIndex=t}nextFragmentKey(){return new te(this.fragmentId+1,ee.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new te(this.fragmentId,this.eventIndex-1)}nextKey(){return new te(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new te(ee.maxStorageKey,ee.maxStorageKey)}static get minKey(){return new te(ee.minStorageKey,ee.minStorageKey)}static get defaultLiveKey(){return te.defaultFragmentKey(ee.minStorageKey)}static defaultFragmentKey(e){return new te(e,ee.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===e?.fragmentId&&this.eventIndex===e?.eventIndex}}const se=Number.MAX_SAFE_INTEGER;class ie{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===se?1:e.fragmentId===se?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new te(this.fragmentId,this.entryIndex)}}function re(e){return e.unsigned?.prev_content||e.prev_content}const ne="m.room.redaction";function oe(e){return!!e?.unsigned?.redacted_because}function ae(e){return e.event_id||e["m.in_reply_to"]?.event_id}function he(e,t){void 0!==e.event_id?e.event_id=t:e["m.in_reply_to"]&&(e["m.in_reply_to"].event_id=t)}function ce(e){return e?.["m.relates_to"]}function le(e){return ce(e.content)}class de{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce(((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e)),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find((e=>!e.isRedaction))}get redactionEntry(){return this._entries.find((e=>e.isRedaction))}get count(){return this._entries.reduce(((e,t)=>e+(t.isRedaction?-1:1)),0)}add(e){this._entries.push(e)}remove(e){const t=this._entries.indexOf(e);return-1!==t&&(this._entries.splice(t,1),!0)}get willAnnotate(){const e=this._entries.reduce(((e,t)=>!e||t.pendingEvent.queueIndex>e.pendingEvent.queueIndex?t:e),null);return!!e&&!e.isRedaction}get isEmpty(){return 0===this._entries.length}}function ue(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}class me extends ie{constructor(e){super(e),this._pendingRedactions=null,this._pendingAnnotations=null}get isReply(){return!!this.relation?.["m.in_reply_to"]}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===ne}get redactionReason(){return this._pendingRedactions?this._pendingRedactions[0].content?.reason:null}addLocalRelation(e){if(e.eventType===ne&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),1===this._pendingRedactions.length)return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&"m.annotation"===t.relation.rel_type&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){if(e.eventType===ne&&e.isRelatedToId(this.id)&&this._pendingRedactions){const t=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter((t=>t!==e)),0===this._pendingRedactions.length&&(this._pendingRedactions=null,0!==t))return"isRedacted"}else{const t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&"m.annotation"===t.relation?.rel_type&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new de,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){const{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),0===this._pendingAnnotations.size&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(const e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return function(e,t){return{"m.relates_to":{event_id:e,key:t,rel_type:"m.annotation"}}}(this.id,e)}reply(e,t){return function(e,t,s){const i=function(e){switch(e){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}(e.content.msgtype),r=function(e){return"m.emote"===e?"* ":""}(e.content.msgtype),n=e.sender,o=`<mx-reply><blockquote>In reply to ${r}<a href="https://matrix.to/#/${n}">${e.displayName||n}</a><br />${i||e.content.formatted_body||e.content.body&&ue(e.content.body)||""}</blockquote></mx-reply>`,a=(i||e.content.body||"").split("\n");a[0]=`> ${r}<${n}> ${a[0]}`;const h=a.join("\n> ")+"\n\n"+s,c=o+ue(s);return function(e,t,s,i){return{msgtype:t,body:s,format:"org.matrix.custom.html",formatted_body:i,"m.relates_to":{"m.in_reply_to":{event_id:e}}}}(e.id,t,h,c)}(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){const t=this.annotations?.[e]?.me||!1,s=this.pendingAnnotations?.get(e),i=s?.willAnnotate||!1;return t&&(!s||i)||!t&&i}get relation(){return ce(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}}class pe extends me{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:i}){super(null),this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=i}get fragmentId(){return se}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){return this._member?.userId}get displayName(){return this._member?.name}get avatarUrl(){return this._member?.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return!(!e||e!==this._pendingEvent.relatedTxnId)||super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}}const _e=e("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),ge=["m.relates_to"];class ye{constructor({data:e,remove:t,emitUpdate:s,attachments:i}){this._data=e,this._attachments=i,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=_e.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce(((e,t)=>e+t.size),0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){const e=ce(this.content);return e?ae(e):this._data.relatedEventId}setRelatedEventId(e){const t=ce(this.content);t?he(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=_e.Encrypting,this._emitUpdate("status")}get contentForEncryption(){const e=Object.assign({},this._data.content);for(const t of ge)delete e[t];return e}_preserveContentFields(e){const t=this._data.content;for(const s of ge)void 0!==t[s]&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=_e.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=_e.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===_e.Sending||this._status===_e.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce(((e,t)=>e+t.sentBytes),0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=_e.EncryptingAttachments,this._emitUpdate("status");for(const e of Object.values(this._attachments))if(await t.wrap("encrypt",(()=>(t.set("size",e.size),e.encrypt()))),this.aborted)throw new i}this._status=_e.UploadingAttachments,this._emitUpdate("status");const s=Object.entries(this._attachments);s.sort((([,e],[,t])=>e.size-t.size));for(const[i,r]of s)await t.wrap("upload",(t=>(t.set("size",r.size),r.upload(e,(()=>{this._emitUpdate("attachmentsSentBytes")}),t)))),r.applyToContent(i,this.content);this._data.needsUpload=!1}async abort(){if(!this._aborted){if(this._aborted=!0,this._attachments)for(const e of Object.values(this._attachments))e.abort();this._sendRequest?.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=_e.Sending,this._emitUpdate("status");const s=this._data.encryptedEventType||this._data.eventType,i=this._data.encryptedContent||this._data.content;this._sendRequest=s===ne?e.redact(this.roomId,this._data.relatedEventId,this.txnId,i,{log:t}):e.send(this.roomId,s,this.txnId,i,{log:t});const r=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=r.event_id,t.set("id",this._data.remoteId),this._status=_e.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(const e of Object.values(this._attachments))e.dispose()}}class fe extends me{constructor(e,t){super(t),this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){const e=new fe(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError)}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){return this._decryptionResult?.event?.content||this._eventEntry.event.content}get prevContent(){return re(this._eventEntry.event)}get eventType(){return this._decryptionResult?.event?.type||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return"m.room.encrypted"===this._eventEntry.event.type}get isDecrypted(){return!!this._decryptionResult?.event}get isVerified(){return this.isEncrypted&&this._decryptionResult?.isVerified}get isUnverified(){return this.isEncrypted&&this._decryptionResult?.isUnverified}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return function(e){if(e.type===ne)return e.redacts;{const t=le(e);if(t)return ae(t)}return null}(this.event)}get isRedacted(){return super.isRedacted||oe(this._eventEntry.event)}get redactionReason(){const e=this._eventEntry.event.unsigned?.redacted_because;return e?e.content?.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){const e=this._eventEntry.event.content;return e&&ce(e)||ce(this.content)}}function ve(e,t,s){return{fragmentId:e.fragmentId,eventIndex:e.eventIndex,roomId:t,event:s}}function we(e,t,s){s.isForward?e.push(t):e.unshift(t)}function be(e,t,s){return s.isForward?e.concat(t):t.concat(e)}const Se="m.room.member";class Ie{constructor(e){this._data=e}static fromUserId(e,t,s){return new Ie({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){const s=t?.state_key;if("string"!=typeof s)return;const i=t.content,r=re(t),n=i?.membership,o=i?.displayname||r?.displayname,a=i?.avatar_url||r?.avatar_url;return this._validateAndCreateMember(e,s,n,o,a)}static fromReplacingMemberEvent(e,t){const s=t&&t.state_key;if("string"!=typeof s)return;const i=re(t);return this._validateAndCreateMember(e,s,i?.membership,i?.displayname,i?.avatar_url)}static _validateAndCreateMember(e,t,s,i,r){if("string"==typeof s)return new Ie({roomId:e,userId:t,membership:s,avatarUrl:r,displayName:i})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){const t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}}class Ee{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get hasLeft(){return"join"===this.previousMembership&&"join"!==this.membership}get hasJoined(){return"join"!==this.previousMembership&&"join"===this.membership}}function ke(e){return"number"==typeof e}function Re(e,t){const s=[];for(;ke(e.previousId);){const i=t.get(e.previousId);if(!i)break;if(i.nextId!==e.id)throw new Error(`Previous fragment ${i.id} doesn't point back to ${e.id}`);t.delete(e.previousId),s.unshift(i),e=i}return s}function Ce(e,t){const s=[];for(;ke(e.nextId);){const i=t.get(e.nextId);if(!i)break;if(i.previousId!==e.id)throw new Error(`Next fragment ${i.id} doesn't point back to ${e.id}`);t.delete(e.nextId),s.push(i),e=i}return s}class Ae{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}}class Me{constructor(e){this._idToSortIndex=new Map,e.forEach(((e,t)=>{this._idToSortIndex.set(e.id,t)}))}compare(e,t){const s=this._idToSortIndex.get(e);if(void 0===s)throw new Error(`first id ${e} isn't part of this island`);const i=this._idToSortIndex.get(t);if(void 0===i)throw new Error(`second id ${t} isn't part of this island`);return s-i}get fragmentIds(){return this._idToSortIndex.keys()}}class Te extends Error{get name(){return"CompareError"}}class xe{constructor(e){this._fragmentsById=e.reduce(((e,t)=>(e.set(t.id,t),e)),new Map),this.rebuild(e)}_getIsland(e){const t=this._idToIsland.get(e);if(void 0===t)throw new Te(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;const s=this._getIsland(e);if(s!==this._getIsland(t))throw new Te(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){const t=function(e){const t=new Map;for(let s of e)t.set(s.id,s);const s=[];for(;t.size;){const e=t.values().next().value;t.delete(e.id);const i=Re(e,t),r=Ce(e,t),n=i.concat(e,r);s.push(n)}return s.map((e=>new Me(e)))}(e);this._idToIsland=new Map;for(let e of t)for(let t of e.fragmentIds)this._idToIsland.set(t,e)}add(e){const t=new Ae(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){const s=new Ae(e,t,null),i=this._fragmentsById.get(t);i&&(i.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){const s=new Ae(e,null,t),i=this._fragmentsById.get(t);i&&(i.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}}class Ne extends Z{constructor(e,t,s=null){const i=t&&"source"in t?t.source:t,r=i?function(e){return"objectStore"in e?`${e.objectStore.name}.${e.name}`:e.name}(i):"",n=i?function(e){return"objectStore"in e?e.objectStore?.transaction?.db?.name:e.transaction?.db?.name}(i):"";let o=`${e} on ${n}.${r}`;s&&(o+=": ","string"==typeof s.name&&(o+=`(name: ${s.name}) `),"number"==typeof s.code&&(o+=`(code: ${s.code}) `)),s&&(o+=s.message),super(o,s),this.storeName=r,this.databaseName=n}}class Ue extends Ne{constructor(e){const t=e.target;super("IDBRequest failed",t.source,t.error),this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}}class Le extends Ne{constructor(e,t,s,i){super(`${e}(${i.map((e=>JSON.stringify(e))).join(", ")}) failed`,t,s)}}const Oe={done:!0},De={done:!1};function Be(e){const t=e.toString(16);return"0".repeat(8-t.length)+t}function Pe(e){return parseInt(e,16)}function Ke(e,t,s,i=window.indexedDB){const r=i.open(e,s);return r.onupgradeneeded=async e=>{const i=e.target,r=i.result,n=i.transaction,o=e.oldVersion;try{await t(r,n,o,s)}catch(e){try{n.abort()}catch(e){}}},Ve(r)}function Ve(e){return new Promise(((t,s)=>{e.addEventListener("success",(e=>{t(e.target.result)})),e.addEventListener("error",(e=>{const t=new Ue(e);s(t)}))}))}function Fe(e){return new Promise(((t,s)=>{e.addEventListener("complete",(()=>{t()})),e.addEventListener("abort",(e=>{s(new i)}))}))}function $e(e,t){return new Promise(((s,i)=>{e.onerror=e=>{i(new Ue(e))},e.onsuccess=e=>{const i=e.target.result;if(!i)return void s(!1);const r=t(i.value,i.key,i),n=r?.done,o=r?.jumpTo;n?s(!0):o?i.continue(o):i.continue()}})).catch((e=>{throw new Z("iterateCursor failed",e)}))}class je{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}get(e){return Ve(this._target.get(e))}getKey(e){return this._target.supports("getKey")?Ve(this._target.getKey(e)):Ve(this._target.get(e)).then((e=>{if(e){let t=this._target.keyPath;return"string"==typeof t&&(t=[t]),t.reduce(((e,t)=>e[t]),e)}}))}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){const s=this._openCursor(e,t),i=[];return await $e(s,(e=>(i.push(e),De))),i}selectFirst(e){return this._find(e,(()=>!0),"next")}selectLast(e){return this._find(e,(()=>!0),"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){const t=this._target.openKeyCursor(e,"prev");let s;return await $e(t,((e,t)=>(s=t,Oe))),s}async iterateValues(e,t){const s=this._target.openCursor(e,"next");await $e(s,((e,s,i)=>({done:t(e,s,i)})))}async iterateKeys(e,t){const s=this._target.openKeyCursor(e,"next");await $e(s,((e,s,i)=>({done:t(s,i)})))}async findExistingKeys(e,t,s){const i=(e,s)=>t?-this.idbFactory.cmp(e,s):this.idbFactory.cmp(e,s),r=e.slice().sort(i),n=r[0],o=r[r.length-1],a=t?"prev":"next",h=this._target.openKeyCursor(this.IDBKeyRange.bound(n,o),a);let c=0;await $e(h,((e,t,n)=>{for(;c<r.length&&i(r[c],t)<0;)c+=1;let o=!1;if(r[c]===t){const e=n.primaryKey;o=s(t,e),c+=1}return o||c>=r.length?Oe:{done:!1,jumpTo:r[c]}}))}_reduce(e,t,s,i){let r=s;return $e(this._openCursor(e,i),(e=>(r=t(r,e),De)))}_selectLimit(e,t,s){return this._selectUntil(e,(e=>e.length===t),s)}async _selectUntil(e,t,s){const i=this._openCursor(e,s),r=[];return await $e(i,(e=>(r.push(e),{done:t(r,e)}))),r}async _selectWhile(e,t,s){const i=this._openCursor(e,s),r=[];return await $e(i,(e=>{const s=t(e);return s&&r.push(e),{done:!s}})),r}async iterateWhile(e,t){const s=this._openCursor(e,"next");await $e(s,(e=>({done:!t(e)})))}async _find(e,t,s){const i=this._openCursor(e,s);let r;if(await $e(i,(e=>{const s=t(e);return s&&(r=e),{done:s}})))return r}}class qe{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?this._qt.openKeyCursor(e,t):this.openCursor(e,t)}catch(s){throw new Le("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return this._qt.openCursor(e,t)}catch(s){throw new Le("openCursor",this._qt,s,[e,t])}}put(e,t){try{return this._qtStore.put(e,t)}catch(s){throw new Le("put",this._qt,s,[e,t])}}add(e,t){try{return this._qtStore.add(e,t)}catch(s){throw new Le("add",this._qt,s,[e,t])}}get(e){try{return this._qt.get(e)}catch(t){throw new Le("get",this._qt,t,[e])}}getKey(e){try{return this._qt.getKey(e)}catch(t){throw new Le("getKey",this._qt,t,[e])}}delete(e){try{return this._qtStore.delete(e)}catch(t){throw new Le("delete",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Le("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}}class We extends je{constructor(e,t){super(new qe(e),t)}get _idbStore(){return this._target}index(e){return new je(new qe(this._idbStore.index(e)),this._transaction)}put(e,t){const s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){const s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await Ve(this._idbStore.add(e)),!0}catch(s){if(s instanceof Ue)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){const s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,i,r){t&&t.ensureRefId(),Ve(e).catch((e=>{let n;r?n=this._getKeys(r):i&&(n=[i]),this._transaction.addWriteError(e,t,s,n)}))}_getKeys(e){const t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch(e){console.warn("could not read keyPath",s)}for(const s of this._idbStore.indexNames)try{const i=this._idbStore.index(s);t.push(this._readKeyPath(e,i.keyPath))}catch(e){console.warn("could not read index",s)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(const e of t){if("object"!=typeof s)break;s=s[e]}return s}return e[t]}}function He(e){return JSON.stringify(Ge(e))}function ze(e){return Qe(JSON.parse(e))}function Ge(e){if("object"!=typeof e||null===e||Array.isArray(e))return e;{if(e.byteLength)return{_type:e.constructor.name,value:Array.from(e)};let t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=Ge(e[s]));return t}}function Qe(e){if("object"!=typeof e||null===e||Array.isArray(e))return e;{if("string"==typeof e._type)switch(e._type){case"Int8Array":return Int8Array.from(e.value);case"Uint8Array":return Uint8Array.from(e.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(e.value);case"Int16Array":return Int16Array.from(e.value);case"Uint16Array":return Uint16Array.from(e.value);case"Int32Array":return Int32Array.from(e.value);case"Uint32Array":return Uint32Array.from(e.value);case"Float32Array":return Float32Array.from(e.value);case"Float64Array":return Float64Array.from(e.value);case"BigInt64Array":return BigInt64Array.from(e.value);case"BigUint64Array":return BigUint64Array.from(e.value);default:return e.value}let t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=Qe(e[s]));return t}}class Je{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){const t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{const s=this._localStorageKeyPrefix+e,i=He(t);this._localStorage.setItem(s,i)}catch(e){console.error("could not write to localStorage",e)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,((e,t)=>(t.startsWith("e2ee:")&&this._writeKeyToLocalStorage(t,e.value),!1)))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1;const s=this._localStorageKeyPrefix,i=s+"e2ee:";for(let r=0;r<this._localStorage.length;r+=1){const n=this._localStorage.key(r);if(n.startsWith(i)){const i=ze(this._localStorage.getItem(n)),r=n.substr(s.length),o=await this._sessionStore.getKey(r)===r;e.set(r,!o),o||(this._sessionStore.put({key:r,value:i}),t=!0)}}return t}set(e,t){e.startsWith("e2ee:")&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith("e2ee:")&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith("e2ee:")&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}}class Ye{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){return e===await this._summaryStore.getKey(e)}remove(e){this._summaryStore.delete(e)}}class Xe{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}}var Ze;!function(e){e[e.All=1]="All",e[e.Debug=2]="Debug",e[e.Detail=3]="Detail",e[e.Info=4]="Info",e[e.Warn=5]="Warn",e[e.Error=6]="Error",e[e.Fatal=7]="Fatal",e[e.Off=8]="Off"}(Ze||(Ze={}));class et{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t))&&!(void 0!==this._min&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}}function tt(){}class st{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){}runDetached(e,t){return new Promise((e=>e(t(this)))).then(tt,tt),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return Ze}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}}const it=new class{constructor(){this.item=new st(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise((e=>e(t(this.item)))).then(tt,tt),this.item}async export(){}get level(){return Ze}};function rt(e,t,s){return`${e}|${Be(t)}|${Be(s)}`}function nt(e,t){return`${e}|${t}`}function ot(e){const[t,s]=e.split("|");return{roomId:t,eventId:s}}class at{constructor(e,t,s,i,r=!1,n=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=i,this._lowerOpen=r,this._upperOpen=n}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(rt(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(rt(e,this._lower.fragmentId,this._lower.eventIndex),rt(e,this._lower.fragmentId,ee.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(rt(e,this._upper.fragmentId,ee.minStorageKey),rt(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(rt(e,this._lower.fragmentId,this._lower.eventIndex),rt(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(e){throw new Z("IDBKeyRange failed with data: "+JSON.stringify(this),e)}}}class ht{constructor(e){this._timelineStore=e}onlyRange(e){return new at(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new at(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new at(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,i=!1){return new at(this._timelineStore.IDBKeyRange,void 0,e,t,s,i)}async lastEvents(e,t,s){const i=te.maxKey;return i.fragmentId=t,this.eventsBefore(e,i,s)}async firstEvents(e,t,s){const i=te.minKey;return i.fragmentId=t,this.eventsAfter(e,i,s)}eventsAfter(e,t,s){const i=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(i,s)}async eventsBefore(e,t,s){const i=this.upperBoundRange(t,!0).asIDBKeyRange(e),r=await this._timelineStore.selectLimitReverse(i,s);return r.reverse(),r}async getEventKeysForIds(e,t){const s=this._timelineStore.index("byEventId"),i=t.map((t=>nt(e,t))),r=new Map;return await s.findExistingKeys(i,!1,((e,t)=>{const{eventId:s}=ot(e),{eventKey:i}=function(e){const[t,s,i]=e.split("|");return{roomId:t,eventKey:new te(Pe(s),Pe(i))}}(t);return r.set(s,i),!1})),r}async findFirstOccurringEventId(e,t){const s=this._timelineStore.index("byEventId"),i=t.map((t=>nt(e,t))),r=new Array(i.length);let n;return await s.findExistingKeys(i,!1,((e,t)=>{const s=i.indexOf(e);return r[s]=t,n=function(){for(let e=0;e<r.length;++e){if(void 0===r[e])return;if(!0===r[e])return i[e]}}(),!!n})),n&&ot(n).eventId}tryInsert(e,t){return e.key=rt(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=nt(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(rt(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(nt(e,t))}removeAllForRoom(e){const t=rt(e,ee.minStorageKey,ee.minStorageKey),s=rt(e,ee.maxStorageKey,ee.maxStorageKey),i=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(i)}}function ct(e,t,s,i){return`${e}|${t}|${s}|${i}`}function lt(e){const[t,s,i,r]=e.split("|");return{roomId:t,targetEventId:s,relType:i,sourceEventId:r}}class dt{constructor(e){this._store=e}add(e,t,s,i){this._store.add({key:ct(e,t,s,i)})}remove(e,t,s,i){this._store.delete(ct(e,t,s,i))}removeAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ct(e,t,"\0","\0"),ct(e,t,"􏿿","􏿿"),!0,!0);this._store.delete(s)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(ct(e,"\0","\0","\0"),ct(e,"􏿿","􏿿","􏿿"),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){const i=this._store.IDBKeyRange.bound(ct(e,t,s,"\0"),ct(e,t,s,"􏿿"),!0,!0);return(await this._store.selectAll(i)).map((e=>lt(e.key)))}async getAllForTarget(e,t){const s=this._store.IDBKeyRange.bound(ct(e,t,"\0","\0"),ct(e,t,"􏿿","􏿿"),!0,!0);return(await this._store.selectAll(s)).map((e=>lt(e.key)))}}function ut(e,t,s){return`${e}|${t}|${s}`}class mt{constructor(e){this._roomStateStore=e}get(e,t,s){const i=ut(e,t,s);return this._roomStateStore.get(i)}set(e,t){const s={roomId:e,event:t,key:ut(e,t.type,t.state_key)};this._roomStateStore.put(s)}removeAllForRoom(e){const t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|􏿿`,!0,!0);this._roomStateStore.delete(t)}}function pt(e,t){return`${e}|${t}`}class _t{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(pt(e,t))}set(e){e.key=pt(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){const t=this._roomMembersStore.IDBKeyRange.lowerBound(pt(e,""));return this._roomMembersStore.selectWhile(t,(t=>t.roomId===e))}async getAllUserIds(e){const t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(pt(e,""));return await this._roomMembersStore.iterateKeys(s,(s=>{const i=function(e){const[t,s]=e.split("|");return{roomId:t,userId:s}}(s);return i.roomId!==e||(t.push(i.userId),!1)})),t}removeAllForRoom(e){const t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|􏿿`,!0,!0);this._roomMembersStore.delete(t)}}function gt(e,t){return`${e}|${Be(t)}`}class yt{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(gt(e,ee.minStorageKey),gt(e,ee.maxStorageKey))}catch(t){throw new Z(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),(e=>"number"!=typeof e.nextId&&"string"!=typeof e.nextToken))}add(e){e.key=gt(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(gt(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}}function ft(e,t){return`${e}|${Be(t)}`}class vt{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){const t=this._eventStore.IDBKeyRange.bound(ft(e,ee.minStorageKey),ft(e,ee.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return function(e){const[t,s]=e.split("|");return{roomId:t,queueIndex:Pe(s)}}(s).queueIndex}remove(e,t){const s=this._eventStore.IDBKeyRange.only(ft(e,t));this._eventStore.delete(s)}async exists(e,t){const s=this._eventStore.IDBKeyRange.only(ft(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=ft(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){const t=ft(e,ee.minStorageKey),s=ft(e,ee.maxStorageKey),i=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(i)}}class wt{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}}function bt(e,t){return`${e}|${t}`}class St{constructor(e){this._store=e}getAllForUserId(e){const t=this._store.IDBKeyRange.lowerBound(bt(e,""));return this._store.selectWhile(t,(t=>t.userId===e))}async getAllDeviceIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(bt(e,""));return await this._store.iterateKeys(s,(s=>{const i=function(e){const[t,s]=e.split("|");return{userId:t,deviceId:s}}(s);return i.userId!==e||(t.push(i.deviceId),!1)})),t}get(e,t){return this._store.get(bt(e,t))}set(e){e.key=bt(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(bt(e,t))}removeAllForUser(e){const t=this._store.IDBKeyRange.bound(bt(e,"\0"),bt(e,"􏿿"),!0,!0);this._store.delete(t)}}function It(e,t){return`${e}|${t}`}class Et{constructor(e){this._store=e}async getSessionIds(e){const t=[],s=this._store.IDBKeyRange.lowerBound(It(e,""));return await this._store.iterateKeys(s,(s=>{const i=function(e){const[t,s]=e.split("|");return{senderKey:t,sessionId:s}}(s);return i.senderKey!==e||(t.push(i.sessionId),!1)})),t}getAll(e){const t=this._store.IDBKeyRange.lowerBound(It(e,""));return this._store.selectWhile(t,(t=>t.senderKey===e))}get(e,t){return this._store.get(It(e,t))}set(e){e.key=It(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(It(e,t))}}function kt(e,t,s){return`${e}|${t}|${s}`}class Rt{constructor(e){this._store=e}async has(e,t,s){const i=kt(e,t,s);return i===await this._store.getKey(i)}get(e,t,s){return this._store.get(kt(e,t,s))}set(e){const t=e;t.key=kt(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(kt(e,"\0","\0"),kt(e,"􏿿","􏿿"));this._store.delete(t)}}class Ct{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}}function At(e,t,s){return`${e}|${t}|${s}`}class Mt{constructor(e){this._store=e}get(e,t,s){return this._store.get(At(e,t,s))}set(e,t,s,i){i.key=At(e,t,s),this._store.put(i)}removeAllForRoom(e){const t=this._store.IDBKeyRange.bound(At(e,"\0","\0"),At(e,"􏿿","􏿿"));this._store.delete(t)}}function Tt(e,t){return`${e}|${t}`}class xt{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){const s=Tt(t,e),i=[];return await this._store.index("byScopeAndType").iterateWhile(s,(e=>e.scopeTypeKey===s&&(i.push(e),!0))),i}add(e){e.scopeTypeKey=Tt(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){const t=this._store.IDBKeyRange.bound(Tt(e,"\0"),Tt(e,"􏿿")),s=this._store.index("byScopeAndType");await s.iterateValues(t,((e,t,s)=>(s.delete(),!0)))}}class Nt{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}}class Ut{constructor(e,t,s,i){this.error=e,this.refItem=t,this.operationName=s,this.keys=i}}class Lt{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new Z(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new We(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){const s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store(Y.session,(e=>new Je(e,this._storage.localStorage)))}get roomSummary(){return this._store(Y.roomSummary,(e=>new Ye(e)))}get archivedRoomSummary(){return this._store(Y.archivedRoomSummary,(e=>new Ye(e)))}get invites(){return this._store(Y.invites,(e=>new Xe(e)))}get timelineFragments(){return this._store(Y.timelineFragments,(e=>new yt(e)))}get timelineEvents(){return this._store(Y.timelineEvents,(e=>new ht(e)))}get timelineRelations(){return this._store(Y.timelineRelations,(e=>new dt(e)))}get roomState(){return this._store(Y.roomState,(e=>new mt(e)))}get roomMembers(){return this._store(Y.roomMembers,(e=>new _t(e)))}get pendingEvents(){return this._store(Y.pendingEvents,(e=>new vt(e)))}get userIdentities(){return this._store(Y.userIdentities,(e=>new wt(e)))}get deviceIdentities(){return this._store(Y.deviceIdentities,(e=>new St(e)))}get olmSessions(){return this._store(Y.olmSessions,(e=>new Et(e)))}get inboundGroupSessions(){return this._store(Y.inboundGroupSessions,(e=>new Rt(e)))}get outboundGroupSessions(){return this._store(Y.outboundGroupSessions,(e=>new Ct(e)))}get groupSessionDecryptions(){return this._store(Y.groupSessionDecryptions,(e=>new Mt(e)))}get operations(){return this._store(Y.operations,(e=>new xt(e)))}get accountData(){return this._store(Y.accountData,(e=>new Nt(e)))}async complete(e){try{await Fe(this._txn)}catch(t){if(this._writeErrors.length)throw this._logWriteErrors(e),this._writeErrors[0].error;throw t}}getCause(e){return e instanceof Z&&"AbortError"===e.errcode&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch(t){e?.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,i){"AbortError"===e.errcode&&0!==this._writeErrors.length||this._writeErrors.push(new Ut(e,t,s,i))}_logWriteErrors(e){const t=t=>{e||t.set("allowedStoreNames",this._allowedStoreNames);for(const e of this._writeErrors)t.wrap({l:e.operationName,id:e.keys},(t=>{e.refItem&&t.refDetached(e.refItem),t.catch(e.error)}))},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}}class Ot{constructor(e,t,s,i,r,n){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=i,this.storeNames=Y,this.localStorage=r,this.logger=n}_validateStoreNames(e){const t=e.findIndex((e=>!X.includes(e)));if(-1!==t)throw new Z(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await Ve(t.objectStore(e[0]).get("782rh281re38-boguskey")),new Lt(t,e,this)}catch(e){throw new Z("readTxn failed",e)}}async readWriteTxn(e){this._validateStoreNames(e);try{const t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await Ve(t.objectStore(e[0]).get("782rh281re38-boguskey")),new Lt(t,e,this)}catch(e){throw new Z("readWriteTxn failed",e)}}close(){this._db.close()}get databaseName(){return this._db.name}}function Dt(e,t,s){return e?e.roomIds.includes(s)?void 0:(e.roomIds.push(s),e):e={userId:t,roomIds:[s],deviceTrackingStatus:0}}function Bt(e){const t=e.device_id;return{userId:e.user_id,deviceId:t,ed25519Key:e.keys[`ed25519:${t}`],curve25519Key:e.keys[`curve25519:${t}`],algorithms:e.algorithms,displayName:e.unsigned?.device_display_name}}class Pt{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:i,ownDeviceId:r}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=i,this._ownDeviceId=r}async writeDeviceChanges(e,t,s){const{userIdentities:i}=t;s.set("changed",e.length),await Promise.all(e.map((async e=>{const t=await i.get(e);t&&(s.log({l:"outdated",id:e}),t.deviceTrackingStatus=0,i.set(t))})))}writeMemberChanges(e,t,s){return Promise.all(Array.from(t.values()).map((async e=>this._applyMemberChange(e,s))))}async trackRoom(e,t){if(e.isTrackingMembers||!e.isEncrypted)return;const s=await e.loadMemberList(t);try{const i=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]);let r;try{r=e.writeIsTrackingMembers(!0,i);const n=Array.from(s.members.values());t.set("members",n.length),await this._writeJoinedMembers(n,i)}catch(e){throw i.abort(),e}await i.complete(),e.applyIsTrackingMembersChanges(r)}finally{s.release()}}async _writeJoinedMembers(e,t){await Promise.all(e.map((async e=>{"join"===e.membership&&await this._writeMember(e,t)})))}async _writeMember(e,t){const{userIdentities:s}=t,i=Dt(await s.get(e.userId),e.userId,e.roomId);i&&s.set(i)}async _removeRoomFromUserIdentity(e,t,s){const{userIdentities:i,deviceIdentities:r}=s,n=await i.get(t);n&&(n.roomIds=n.roomIds.filter((t=>t!==e)),0===n.roomIds.length?(i.remove(t),r.removeAllForUser(t)):i.set(n))}async _applyMemberChange(e,t){if(e.hasJoined)await this._writeMember(e.member,t);else if(e.hasLeft){const{roomId:s}=e;if(e.userId===this._ownUserId){const e=await t.roomMembers.getAllUserIds(s);await Promise.all(e.map((e=>this._removeRoomFromUserIdentity(s,e,t))))}else await this._removeRoomFromUserIdentity(s,e.userId,t)}}async _queryKeys(e,t,s){const i=await t.queryKeys({timeout:1e4,device_keys:e.reduce(((e,t)=>(e[t]=[],e)),{}),token:this._getSyncToken()},{log:s}).response(),r=s.wrap("verify",(e=>this._filterVerifiedDeviceKeys(i.device_keys,e))),n=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]);let o;try{const e=await Promise.all(r.map((async({userId:e,verifiedKeys:t})=>{const s=t.map(Bt);return await this._storeQueriedDevicesForUserId(e,s,n)})));o=e.reduce(((e,t)=>e.concat(t)),[]),s.set("devices",o.length)}catch(e){throw n.abort(),e}return await n.complete(),o}async _storeQueriedDevicesForUserId(e,t,s){const i=await s.deviceIdentities.getAllDeviceIds(e);for(const r of i)t.every((e=>e.deviceId!==r))&&s.deviceIdentities.remove(e,r);const r=[],n=[];t=await Promise.all(t.map((async e=>{if(i.includes(e.deviceId)){const t=await s.deviceIdentities.get(e.userId,e.deviceId);t.ed25519Key!==e.ed25519Key&&r.push(t)}r.push(e),n.push(e)})));for(const e of n)s.deviceIdentities.set(e);const o=await s.userIdentities.get(e);return o.deviceTrackingStatus=1,s.userIdentities.set(o),r}_filterVerifiedDeviceKeys(e,t){const s=new Set;return Object.entries(e).map((([e,i])=>{const r=Object.entries(i).filter((([i,r])=>{const n=r.device_id;if(r.user_id!==e)return!1;if(n!==i)return!1;const o=r.keys?.[`ed25519:${i}`],a=r.keys?.[`curve25519:${i}`];if("string"!=typeof o||"string"!=typeof a)return!1;if(s.has(a))return t.log({l:"ignore device with duplicate curve25519 key",keys:r},t.level.Warn),!1;s.add(a);const h=this._hasValidSignature(r,t);return h||t.log({l:"ignore device with invalid signature",keys:r},t.level.Warn),h})).map((([,e])=>e));return{userId:e,verifiedKeys:r}}))}_hasValidSignature(e,t){const s=e.device_id,i=e.user_id,r=e?.keys?.[`ed25519:${s}`];return q(this._olmUtil,i,s,r,e,t)}async devicesForTrackedRoom(e,t,s){const i=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),r=await i.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,r,i,t,s)}async devicesForRoomMembers(e,t,s,i){const r=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,r,s,i)}async _devicesForUserIds(e,t,s,i,r){const n=(await Promise.all(t.map((e=>s.userIdentities.get(e))))).filter((t=>t&&t.roomIds.includes(e))),o=n.filter((e=>1===e.deviceTrackingStatus)),a=n.filter((e=>0===e.deviceTrackingStatus));let h;r.set("uptodate",o.length),r.set("outdated",a.length),a.length&&(h=await this._queryKeys(a.map((e=>e.userId)),i,r));const c=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]);let l=(await Promise.all(o.map((e=>c.deviceIdentities.getAllForUserId(e.userId))))).reduce(((e,t)=>e.concat(t)),[]);h&&h.length&&(l=l.concat(h));return l.filter((e=>!(e.userId===this._ownUserId&&e.deviceId===this._ownDeviceId)))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}}const Kt=[function(e){e.createObjectStore("session",{keyPath:"key"}),e.createObjectStore("roomSummary",{keyPath:"roomId"}),e.createObjectStore("timelineFragments",{keyPath:"key"});e.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),e.createObjectStore("roomState",{keyPath:"key"}),e.createObjectStore("pendingEvents",{keyPath:"key"})},async function(e,t){const s=new _t(e.createObjectStore("roomMembers",{keyPath:"key"})),i=t.objectStore("roomState");await $e(i.openCursor(),(e=>{if(e.event.type===Se){i.delete(e.key);const t=Ie.fromMemberEvent(e.roomId,e.event);t&&s.set(t.serialize())}return De}))},async function(e,t,s){const i=t.objectStore("session");try{const e=1,t=await Ve(i.get(e));if(t){i.delete(e);const{syncToken:r,syncFilterId:n,serverVersions:o}=t.value,a=new Je(i,s);a.set("sync",{token:r,filterId:n}),a.set("serverVersions",o)}}catch(e){t.abort(),console.error("could not migrate session",e.stack)}},function(e){e.createObjectStore("userIdentities",{keyPath:"userId"});e.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),e.createObjectStore("olmSessions",{keyPath:"key"}),e.createObjectStore("inboundGroupSessions",{keyPath:"key"}),e.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),e.createObjectStore("groupSessionDecryptions",{keyPath:"key"});e.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})},async function(e,t){const s=t.objectStore("roomSummary"),i=t.objectStore("roomState"),r=[];await $e(s.openCursor(),(e=>(r.push(e),De)));for(const e of r){const t=await Ve(i.get(`${e.roomId}|m.room.encryption|`));t&&(e.encryption=t?.event?.content,delete e.isEncrypted,s.put(e))}},function(e){e.createObjectStore("accountData",{keyPath:"type"})},function(e){e.createObjectStore("invites",{keyPath:"roomId"})},function(e){e.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})},async function(e,t){try{const e=t.objectStore("operations");e.deleteIndex("byTypeAndScope"),await $e(e.openCursor(),((e,t,s)=>{const{typeScopeKey:i}=e;delete e.typeScopeKey;const[r,n]=i.split("|");return e.scopeTypeKey=Tt(n,r),s.update(e),De})),e.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(e){t.abort(),console.error("could not migrate operations",e.stack)}},function(e){e.createObjectStore("timelineRelations",{keyPath:"key"})},async function(e,t,s,i){const r=t.objectStore("roomSummary"),n=[];await $e(r.openCursor(),(e=>(e.isTrackingMembers&&n.push(e.roomId),De)));const o=t.objectStore("outboundGroupSessions"),a=t.objectStore("userIdentities"),h=t.objectStore("roomMembers");for(const e of n){let t=!1;const s=[],r=IDBKeyRange.bound(e,`${e}|􏿿`,!0,!0);await i.wrap({l:"room",id:e},(async i=>{await $e(h.openCursor(r),(e=>("join"===e.membership&&s.push(e.userId),De))),i.set("joinedUserIds",s.length);for(const r of s){const s=await Ve(a.get(r)),n=s?.roomIds?.length,o=Dt(s,r,e);o&&(i.log({l:"fixing up",id:r,roomsBefore:n,roomsAfter:o.roomIds.length}),a.put(o),t=!0)}i.set("foundMissing",t),t&&o.delete(e)}))}},async function(e,t){const s=t.objectStore("session"),i=await Ve(s.get("ssssKey"));i&&s.put({key:"e2ee:ssssKey",value:i.value})},async function(e,t,s,i){const r=t.objectStore("session"),n={databaseName:e.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}},o=new Je(new We(r,n),s);o.writeE2EEIdentityToLocalStorage();const a=await o.tryRestoreE2EEIdentityFromLocalStorage(i);i.set("restored",a)},async function(e,t){for(const s of e.objectStoreNames){const e=t.objectStore(s);switch(s){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":await $e(e.openCursor(),((e,t,s)=>(t.startsWith("e2ee:")||s.delete(),De)));break;default:e.clear()}}}];const Vt=e=>`hydrogen_session_${e}`,Ft=function(e,t,s,i){return Ke(Vt(e),((e,t,r,n)=>async function(e,t,s,i,r,n){const o=s||0;return n.wrap({l:"storage migration",oldVersion:s,version:i},(async s=>{for(let n=o;n<i;++n){const i=Kt[n];await s.wrap(`v${n+1}`,(s=>i(e,t,r,s)))}}))}(e,t,r,n,s,i)),Kt.length,t)};class $t{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,i=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=i}async create(e,t){await(this._serviceWorkerHandler?.preventConcurrentSessionAccess(e)),async function(){const e=this;if(e?.navigator?.storage?.persist)return await e.navigator.storage.persist();if(!e?.document.requestStorageAccess)return!1;try{return await e.document.requestStorageAccess(),!0}catch(e){return!1}}().then((e=>{e||console.warn("no persisted storage, database can be evicted by browser")}));const s=await async function(e){try{const t=await Ke("hydrogen_webkit_test_inactive_txn_bug",(e=>{e.createObjectStore("test",{keyPath:"key"})}),1,e),s=t.transaction(["test"],"readonly");await Ve(s.objectStore("test").get("somekey")),await new Promise((e=>setTimeout(e,0)));const i=t.transaction(["test"],"readwrite");await Promise.resolve(),i.objectStore("test").add({key:"somekey",value:"foo"}),await Fe(i),t.close()}catch(e){if("TransactionInactiveError"===e.name)return!0}return!1}(this._idbFactory),i=await Ft(e,this._idbFactory,this._localStorage,t);return new Ot(i,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}delete(e){const t=Vt(e);return Ve(this._idbFactory.deleteDatabase(t))}async export(e,t){const s=await Ft(e,this._idbFactory,this._localStorage,t);return await async function(e){const t=e.transaction(X,"readonly"),s={};return await Promise.all(X.map((async e=>{const i=s[e]=[],r=t.objectStore(e);await $e(r.openCursor(),(e=>(i.push(e),De)))}))),s}(s)}async import(e,t,s){const i=await Ft(e,this._idbFactory,this._localStorage,s);return await async function(e,t){const s=e.transaction(X,"readwrite");for(const e of X){const i=s.objectStore(e);for(const s of t[e])i.add(s)}await Fe(s)}(i,t)}}class jt{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){const{relatedEventId:i}=e;if(i){const r=le(e.event);r&&r.rel_type&&t.timelineRelations.add(this._roomId,r.event_id,r.rel_type,e.id);const n=await t.timelineEvents.getByEventId(this._roomId,i);if(n){const i=await this._applyRelation(e,n,t,s);if(i)return i.map((e=>(t.timelineEvents.update(e),new fe(e,this._fragmentIdComparer))))}}return null}async writeGapRelation(e,t,s,i){const r=new fe(e,this._fragmentIdComparer),n=await this.writeRelation(r,s,i);if(t.isBackward&&!oe(e.event)){const t=await s.timelineRelations.getAllForTarget(this._roomId,r.id);if(t.length)for(const r of t){const t=await s.timelineEvents.getByEventId(this._roomId,r.sourceEventId);if(t){const r=new fe(t,this._fragmentIdComparer);await this._applyRelation(r,e,s,i)}}}return n}async _applyRelation(e,t,s,i){if(e.eventType===ne)return i.wrap("redact",(async i=>{const r=t.event,n=le(r);if(this._applyRedaction(e.event,t,s,i)){const e=[t];if(n){const t=await this._reaggregateRelation(r,n,s,i);t&&e.push(t)}return e}return null}));{const s=le(e.event);if(s&&!oe(t.event)){if("m.annotation"===s.rel_type){if(i.wrap("react",(s=>this._aggregateAnnotation(e.event,t,s))))return[t]}}}return null}_applyRedaction(e,t,s,i){const r=t.event;i.set("redactionId",e.event_id),i.set("id",r.event_id);const n=le(r);n&&n.rel_type&&s.timelineRelations.remove(this._roomId,n.event_id,n.rel_type,r.event_id),s.timelineRelations.removeAllForTarget(this._roomId,r.event_id);for(const e of Object.keys(r))qt[e]||delete r[e];const{content:o}=r,a=Wt[r.type];for(const e of Object.keys(o))a?.[e]||delete o[e];return r.unsigned=r.unsigned||{},r.unsigned.redacted_because=e,delete t.annotations,!0}_aggregateAnnotation(e,t){const s=le(e);if(!s)return!1;let{annotations:i}=t;i||(t.annotations=i={});let r=i[s.key];r||(i[s.key]=r={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});const n=e.sender===this._ownUserId;return r.me=r.me||n,r.count+=1,r.firstTimestamp=Math.min(r.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,i){return"m.annotation"===t.rel_type?i.wrap("reaggregate annotations",(e=>this._reaggregateAnnotation(t.event_id,t.key,s,e))):null}async _reaggregateAnnotation(e,t,s,i){const r=await s.timelineEvents.getByEventId(this._roomId,e);if(!r||!r.annotations)return null;i.set("id",e);const n=await s.timelineRelations.getForTargetAndType(this._roomId,e,"m.annotation");return i.set("relations",n.length),delete r.annotations[t],function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}(r.annotations)&&delete r.annotations,await Promise.all(n.map((async e=>{const n=await s.timelineEvents.getByEventId(this._roomId,e.sourceEventId);n||i.log({l:"missing annotation",id:e.sourceEventId}),le(n.event).key===t&&this._aggregateAnnotation(n.event,r,i)}))),r}}const qt=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),Wt={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};class Ht{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?Ht.Backward:Ht.Forward}static get Forward(){return zt}static get Backward(){return Gt}}const zt=new Ht(!0),Gt=new Ht(!1);class Qt extends ie{constructor(e,t,s){super(s),this._fragment=e,this._isFragmentStart=t}static start(e,t){return new Qt(e,!0,t)}static end(e,t){return new Qt(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?ee.minStorageKey:ee.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return ke(this.linkedFragmentId)}get direction(){return this.started?Ht.Backward:Ht.Forward}withUpdatedFragment(e){return new Qt(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new Qt(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}}class Jt{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:i}){this._roomId=e,this._memberWriter=s,this._relationWriter=i,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s){const[t]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),i=t?t.eventIndex:te.defaultLiveKey.eventIndex;this._lastLiveKey=new te(s.id,i)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){const s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);const s={roomId:this._roomId,id:te.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(s),this._fragmentIdComparer.add(s),s}}async _replaceLiveFragment(e,t,s,i){const r=await i.timelineFragments.get(this._roomId,e);if(!r)throw new Error(`old live fragment doesn't exist: ${e}`);r.nextId=t,i.timelineFragments.update(r);const n={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return i.timelineFragments.add(n),this._fragmentIdComparer.append(t,e),{oldFragment:r,newFragment:n}}async _ensureLiveFragment(e,t,s,i,r){if(e){if(s.limited){const n=e.fragmentId;e=e.nextFragmentKey();const{oldFragment:o,newFragment:a}=await this._replaceLiveFragment(n,e.fragmentId,s.prev_batch,i);t.push(Qt.end(o,this._fragmentIdComparer)),t.push(Qt.start(a,this._fragmentIdComparer)),r.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let n=await this._createLiveFragment(i,s.prev_batch);e=new te(n.id,te.defaultLiveKey.eventIndex),t.push(Qt.start(n,this._fragmentIdComparer)),r.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let i=0;for(const s of e)s.type!==Se&&(t.roomState.set(this._roomId,s),i+=1);s.set("stateEvents",i)}async _writeTimeline(e,t,s,i,r,n){const o=[],a=[];if(e?.length){i=await this._ensureLiveFragment(i,o,t,r,n),n.set("timelineEvents",e.length);let h=0;for(const t of e){const e=ve(i=i.nextKey(),this._roomId,t);let c=await s.lookupMemberAtEvent(t.sender,t,r);c&&(e.displayName=c.displayName,e.avatarUrl=c.avatarUrl);if(!await r.timelineEvents.tryInsert(e,n))continue;const l=new fe(e,this._fragmentIdComparer);o.push(l);const d=await this._relationWriter.writeRelation(l,r,n);d&&a.push(...d),"string"==typeof t.state_key&&t.type!==Se&&(h+=1,r.roomState.set(this._roomId,t))}n.set("timelineStateEventCount",h)}return{currentKey:i,entries:o,updatedEntries:a}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){const{fragmentId:i}=this._lastLiveKey,[r]=await t.timelineEvents.lastEvents(this._roomId,i,1);if(r){const t=r.event.event_id,{events:i}=e,n=i.findIndex((e=>e.event_id===t));if(-1!==n)return s.set("overlap_event_id",t),Object.assign({},e,{limited:!1,events:i.slice(n+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,i,r){let n,{timeline:o}=e;r.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,i,r)),Array.isArray(o?.events)&&(n=function(e){const t=new Set;return e.filter((e=>!t.has(e.event_id)&&(t.add(e.event_id),!0)))}(o.events));const{state:a}=e;let h;Array.isArray(a?.events)&&(h=a.events);const c=this._memberWriter.prepareMemberSync(h,n,s);h&&await this._writeStateEvents(h,i,r);const{currentKey:l,entries:d,updatedEntries:u}=await this._writeTimeline(n,o,c,this._lastLiveKey,i,r);return{entries:d,updatedEntries:u,newLiveKey:l,memberChanges:await c.write(i)}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}}class Yt{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(-1!==e){const t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),-1===s?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,-1!==s&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}}class Xt extends Yt{constructor(e,t){super(e),this._keyFn=t}get(e){return this._get((t=>this._keyFn(t)===e))}set(e){const t=this._keyFn(e);this._set(e,(e=>this._keyFn(e)===t))}}class Zt{constructor(e){this._roomId=e,this._cache=new Xt(5,(e=>e.userId))}prepareMemberSync(e,t,s){return new es(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){const i=await t.roomMembers.get(this._roomId,e.userId);i&&(s=new Ie(i))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new Ee(e,s?.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){const i=await t.roomMembers.get(this._roomId,e);i&&(s=new Ie(i),this._cache.set(s))}return s}}class es{constructor(e,t,s,i){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=i,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(const s of e)if(s.type===Se){const e=Ie.fromMemberEvent(this._roomId,s);e&&(t||(t=new Map),t.set(e.userId,e))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){const i=e[s],r=i.state_key;if(i.type===Se&&!t?.has(r)){const e=Ie.fromMemberEvent(this._roomId,i);e&&(t||(t=new Map),t.set(e.userId,e))}}return t}async lookupMemberAtEvent(e,t,s){let i;return this._timelineEvents&&(i=this._findPrecedingMemberEventInTimeline(e,t),i)?i:(i=this._newStateMembers?.get(e),i||await this._memberWriter.lookupMember(e,s))}async write(e){const t=new Map;let s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers)for(const i of this._newStateMembers.values())if(!s?.has(i.userId)){const s=await this._memberWriter._writeMember(i,e);if(s){!this._hasFetchedMembers&&!s.previousMembership&&(s.previousMembership=i.membership),t.set(s.userId,s)}}if(s)for(const i of s.values()){const s=await this._memberWriter._writeMember(i,e);s&&t.set(s.userId,s)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let e=this._timelineEvents.length-1;e>=0;e--){if(this._timelineEvents[e].event_id===t.event_id){s=e;break}}for(let t=s-1;t>=0;t--){const s=this._timelineEvents[t];if(s.type===Se&&s.state_key===e){const e=Ie.fromMemberEvent(this._roomId,s);if(e)return e}}}}class ts{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:i}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=i}async _findOverlappingEvents(e,t,s,i){const r=t.map((e=>e.event_id)),n=await s.timelineEvents.getEventKeysForIds(this._roomId,r);i.set("existingEvents",n.size);const o=t.filter((e=>!n.has(e.event_id)));let a;if(i.set("nonOverlappingEvents",o.length),e.hasLinkedFragment){i.set("linkedFragmentId",e.linkedFragmentId);for(const t of n.values())if(t.fragmentId===e.linkedFragmentId){i.set("foundLinkedFragment",!0);const t=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);a=e.createNeighbourEntry(t);break}}return{nonOverlappingEvents:o,neighbourFragmentEntry:a}}async _findFragmentEdgeEventKey(e,t){const{fragmentId:s,direction:i}=e,r=await this._findFragmentEdgeEvent(s,i,t);return r?new te(r.fragmentId,r.eventIndex):te.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){const[t]=await s.timelineEvents.firstEvents(this._roomId,e,1);return t}{const[t]=await s.timelineEvents.lastEvents(this._roomId,e,1);return t}}async _storeEvents(e,t,s,i,r,n){const o=[],a=[];let h=t;for(let t=0;t<e.length;++t){const c=e[t];h=h.nextKeyForDirection(s);const l=ve(h,this._roomId,c),d=this._findMember(c.sender,i,e,t,s);d&&(l.displayName=d.displayName,l.avatarUrl=d.avatarUrl);const u=await this._relationWriter.writeGapRelation(l,s,r,n);if(u&&a.push(...u),await r.timelineEvents.tryInsert(l,n)){we(o,new fe(l,this._fragmentIdComparer),s)}}return{entries:o,updatedEntries:a}}_findMember(e,t,s,i,r){function n(t){return t.type===Se&&t.state_key===e}const o=r.isBackward?1:-1;for(let e=i+o;e>=0&&e<s.length;e+=o){const t=s[e];if(n(t))return Ie.fromMemberEvent(this._roomId,t)}for(let e=i;e>=0&&e<s.length;e-=o){const t=s[e];if(n(t))return Ie.fromReplacingMemberEvent(this._roomId,t)}const a=t?.find(n);if(a)return Ie.fromMemberEvent(this._roomId,a)}async _updateFragments(e,t,s,i,r,n){const{direction:o}=e,a=[];return we(i,e,o),t?(n.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,r.timelineFragments.update(t.fragment),we(i,t,o),a.push(e.fragment),a.push(t.fragment)):e.token=s,r.timelineFragments.update(e.fragment),a}async writeFragmentFill(e,t,s,i){const{fragmentId:r,direction:n}=e,{chunk:o,start:a,state:h}=t;let{end:c}=t;if(!Array.isArray(o))throw new Error("Invalid chunk in response");if("string"!=typeof c)throw new Error("Invalid end token in response");const l=await s.timelineFragments.get(this._roomId,r);if(!l)throw new Error(`Unknown fragment: ${r}`);if((e=e.withUpdatedFragment(l)).token!==a)throw new Error("start is not equal to prev_batch or next_batch");if(0===o.length)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let d=await this._findFragmentEdgeEventKey(e,s);i.set("lastKey",d.toString());const{nonOverlappingEvents:u,neighbourFragmentEntry:m}=await this._findOverlappingEvents(e,o,s,i),{entries:p,updatedEntries:_}=await this._storeEvents(u,d,n,h,s,i);return{entries:p,updatedEntries:_,fragments:await this._updateFragments(e,m,c,p,s,i)}}}class ss extends r{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let i of this._handlers)i.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let i of this._handlers)i.onMove(e,t,s,this)}}
/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */function is(e,t,s){let i=0,r=e.length;for(;i<r;){let n=i+r>>>1,o=s(t,e[n]);o>0?i=n+1:o<0?r=n:i=r=n}return r}class rs extends r{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,...s){for(let i of this._handlers)i.onUpdate(e,t,...s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}[Symbol.iterator](){throw new Error("unimplemented")}get size(){throw new Error("unimplemented")}get(e){throw new Error("unimplemented")}}class ns extends rs{constructor(e){super(),this._values=new Map(e)}update(e,t){const s=this._values.get(e);return void 0!==s&&(this._values.set(e,s),this.emitUpdate(e,s,t),!0)}add(e,t){return!this._values.has(e)&&(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){const t=this._values.get(e);return void 0!==t&&(this._values.delete(e),this.emitRemove(e,t),!0)}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}}class os extends ss{constructor(e,t){super(),this._sourceMap=e,this._comparator=(e,s)=>t(e.value,s.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){const s={key:e,value:t},i=is(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,0,s),this.emitAdd(i,t)}onRemove(e,t){const s={key:e,value:t},i=is(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(i,1),this.emitRemove(i,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;const i=this._sortedPairs.findIndex((t=>t.key===e));this._sortedPairs.splice(i,1);const r={key:e,value:t},n=is(this._sortedPairs,r,this._comparator);this._sortedPairs.splice(n,0,r),i!==n&&this.emitMove(i,n,t),this.emitUpdate(n,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){const e=this._sortedPairs.values();return{next(){const t=e.next();return t.value&&(t.value=t.value.value),t}}}}class as extends rs{constructor(e,t){super(),this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){const t=this._included;this._included=this._included||new Map;for(const[s,i]of this._source){const r=this._filter(i,s);if(this._included.set(s,r),!e){const e=!t||t.get(s);this._emitForUpdate(e,r,s,i)}}}else{if(this._included&&!e)for(const[e,t]of this._source)this._included.get(e)||this.emitAdd(e,t);this._included=null}}onAdd(e,t){if(this._filter){const s=this._filter(t,e);if(this._included.set(e,s),!s)return}this.emitAdd(e,t)}onRemove(e,t){const s=!this._filter||this._included.get(e);this._included.delete(e),s&&this.emitRemove(e,t)}onUpdate(e,t,s){if(this._included)if(this._filter){const i=this._included.get(e),r=this._filter(t,e);this._included.set(e,r),this._emitForUpdate(i,r,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,i,r=null){e&&!t?this.emitRemove(s,i):!e&&t?this.emitAdd(s,i):e&&t&&this.emitUpdate(s,i,r)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new hs(this._source,this._included)}get size(){let e=0;return this._included.forEach((t=>{t&&(e+=1)})),e}get(e){const t=this._source.get(e);if(t&&this._filter(t,e))return t}}class hs{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){const e=this._sourceIterator.next();if(e.done)return e;const t=e.value[0];if(this._included.get(t))return e}}}class cs extends rs{constructor(e,t,s){super(),this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){const s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i),this.emitAdd(e,i)}onRemove(e){const t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!this._mappedValues)return;const i=this._mappedValues.get(e);void 0!==i&&(this._updater?.(i,s,t),this.emitUpdate(e,i,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){const s=this._emitSpontaneousUpdate.bind(this,e),i=this._mapper(t,s);this._mappedValues.set(e,i)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}}class ls extends rs{constructor(e){super(),this._sources=e,this._subscriptions=null}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){const i=this._getValueFromOccludedSources(e,t);void 0!==i&&this.emitRemove(t,i),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);const i=this._getValueFromOccludedSources(e,t);void 0!==i&&this.emitAdd(t,i)}}onUpdate(e,t,s,i){this._subscriptions&&(this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,i))}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map((e=>new us(e,this).subscribe())),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){const s=this._sources.indexOf(e);for(let e=0;e<s;e+=1)if(void 0!==this._sources[e].get(t))return!0;return!1}_getValueFromOccludedSources(e,t){for(let s=this._sources.indexOf(e)+1;s<this._sources.length;s+=1){const e=this._sources[s].get(t);if(void 0!==e)return e}}onUnsubscribeLast(){super.onUnsubscribeLast();for(const e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new ds(this._sources)}get size(){return this._sources.reduce(((e,t)=>e+t.size),0)}get(e){for(const t of this._sources){const s=t.get(e);if(s)return s}return null}}class ds{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}const t=this._currentIterator.next();if(t.done)this._currentIterator=null;else{const s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}}class us{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset(this._source)}}class ms extends ss{constructor(e=[]){super(),this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){const[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){const[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}}function ps(e,t,s,i){const r=t.findIndex(e);if(-1!==r){const e=t[r],n=i(e);return!1!==n&&s.emitUpdate(r,e,n),!0}return!1}class _s extends ss{constructor(e){super(),this._items=[],this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return ps(e,this._items,this,t)}getAndUpdate(e,t,s=null){const i=this.indexOf(e);if(-1!==i){const r=t(this._items[i],e);this._items[i]=r,this.emitUpdate(i,r,s)}}update(e,t=null){const s=this.indexOf(e);-1!==s&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){const t=is(this._items,e,this._comparator);return t<this._items.length&&0===this._comparator(this._items[t],e)?t:-1}_getNext(e){let t=is(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){const s=is(this._items,e,this._comparator);s>=this._items.length||0!==this._comparator(this._items[s],e)?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){const t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new gs(this)}}class gs{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}}class ys extends ss{constructor(e,t,s,i){super(),this._sourceUnsubscribe=null,this._mappedValues=null,this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=i}findAndUpdate(e,t){return ps(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}}class fs extends ys{constructor(){super(...arguments),this._eventQueue=null,this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(const t of this._sourceList)this._eventQueue.push(new vs(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;){const e=this._eventQueue.shift();await e.run(this)}}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Is),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new vs(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new ws(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new bs(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new Ss(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}}class vs{constructor(e,t){this.index=e,this.value=t}async run(e){const t=await e._mapper(this.value);!function(e,t,s){e._mappedValues.splice(t,0,s),e.emitAdd(t,s)}(e,this.index,t)}}class ws{constructor(e,t,s){this.index=e,this.value=t,this.params=s}async run(e){!function(e,t,s,i){const r=e._mappedValues[t];e._updater&&e._updater(r,i,s),e.emitUpdate(t,r,i)}(e,this.index,this.value,this.params)}}class bs{constructor(e){this.index=e}async run(e){!function(e,t){const s=e._mappedValues[t];e._mappedValues.splice(t,1),e._removeCallback&&e._removeCallback(s),e.emitRemove(t,s)}(e,this.index)}}class Ss{constructor(e,t){this.fromIdx=e,this.toIdx=t}async run(e){!function(e,t,s){const i=e._mappedValues[t];e._mappedValues.splice(t,1),e._mappedValues.splice(s,0,i),e.emitMove(t,s,i)}(e,this.fromIdx,this.toIdx)}}class Is{async run(e){!function(e){e._mappedValues=[],e.emitReset()}(e)}}class Es extends ss{constructor(...e){super(),this._sourceUnsubscribes=null,this._sourceLists=e}_offsetForSource(e){const t=this._sourceLists.indexOf(e);let s=0;for(let e=0;e<t;++e)s+=this._sourceLists[e].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map((e=>e.subscribe(this)))}onUnsubscribeLast(){for(const e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(const t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,i){this._sourceUnsubscribes&&this.emitUpdate(this._offsetForSource(i)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,i){const r=this._offsetForSource(i);this.emitMove(r+e,r+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}}function ks(e){"function"==typeof e?e():e.dispose()}Object.assign(rs.prototype,{sortValues(e){return new os(this,e)},mapValues(e,t){return new cs(this,e,t)},filterValues(e){return new as(this,e)},join(...e){return new ls([this].concat(e))}});class Rs{constructor(){this._disposables=[]}track(e){if(!(t=e)||"function"!=typeof t&&"function"!=typeof t.dispose)throw new Error("Not a disposable");var t;return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),ks(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed)return console.warn("Disposables already disposed, cannot untrack"),null;const t=this._disposables.indexOf(e);return t>=0&&this._disposables.splice(t,1),null}dispose(){if(this._disposables){for(const e of this._disposables)ks(e);this._disposables=null}}get isDisposed(){return null===this._disposables}disposeTracked(e){if(null==e||this.isDisposed)return null;const t=this._disposables.indexOf(e);if(-1!==t){const[e]=this._disposables.splice(t,1);ks(e)}else console.warn("disposable not found, did it leak?",e);return null}}class Cs{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}}class As{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){const e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,i){return new Cs((async(i,r)=>{const n=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,i,n,r)}),i)}readFromEnd(e,t=null,s){return new Cs((async(s,i)=>{const r=t||await this._storage.readTxn(this.readTxnStores),n=await r.timelineFragments.liveFragment(this._roomId);let o;if(n){this._fragmentIdComparer.add(n);const t=Qt.end(n,this._fragmentIdComparer),a=t.asEventKey();o=await this._readFrom(a,Ht.Backward,e,s,r,i),o.unshift(t)}else o=[];return o}),s)}async _readFrom(e,t,s,i,r,n){const o=await async function(e,t,s,i,r,n){let o=[];const a=n.timelineEvents,h=n.timelineFragments;for(;o.length<i&&t;){let n;if(n=s.isForward?await a.eventsAfter(e,t,i):await a.eventsBefore(e,t,i),o=be(o,n.map((e=>new fe(e,r))),s),o.length<i){const i=await h.get(e,t.fragmentId);let n=new Qt(i,s.isBackward,r);if(we(o,n,s),!n.token&&n.hasLinkedFragment){const i=await h.get(e,n.linkedFragmentId);r.add(i);const a=new Qt(i,s.isForward,r);we(o,a,s),t=a.asEventKey()}else t=null}}return o}(this._roomId,e,t,s,this._fragmentIdComparer,r);if(this._decryptEntries){i.decryptRequest=this._decryptEntries(o,r,n);try{await i.decryptRequest.complete()}finally{i.decryptRequest=null}}return o}}class Ms{constructor(e){this._userId=e}get id(){return this._userId}}class Ts{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:i,pendingEvents:r,clock:n,powerLevelsObservable:o}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=i,this._disposables=new Rs,this._pendingEvents=r,this._clock=n,this._remoteEntries=new _s(((e,t)=>e.compare(t))),this._ownMember=null,this._timelineReader=new As({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this.initializePowerLevels(o)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe((e=>this._powerLevels=e))))}async load(e,t,s){const i=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),r=await i.roomMembers.get(this._roomId,e.id);this._ownMember=r?new Ie(r):Ie.fromUserId(this._roomId,e.id,t);const n=this._disposables.track(this._timelineReader.readFromEnd(20,i,s));try{const e=await n.complete();this._setupEntries(e)}finally{this._disposables.disposeTracked(n)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new fs(this._pendingEvents,(e=>this._mapPendingEventToEntry(e)),((e,t)=>{e.notifyUpdate(t)}),(e=>this._applyAndEmitLocalRelationChange(e,(t=>t.removeLocalRelation(e))))):this._localEntries=new ms,this._allEntries=new Es(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===ne&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));const s=new pe({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._applyAndEmitLocalRelationChange(s,(e=>e.addLocalRelation(s))),s}_applyAndEmitLocalRelationChange(e,t){const s=e=>{const s=t(e);return s||!1};if(this._findAndUpdateRelatedEntry(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){const t=e.redactingEntry.pendingEvent?.relatedTxnId;this._findAndUpdateRelatedEntry(t,e.redactingEntry.relatedEventId,s)}}_findAndUpdateRelatedEntry(e,t,s){let i=!1;e&&(i=this._localEntries.findAndUpdate((t=>t.id===e),s)),!i&&t&&this._remoteEntries.findAndUpdate((e=>e.id===t),s)}async getOwnAnnotationEntry(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),i=await s.timelineRelations.getForTargetAndType(this._roomId,e,"m.annotation");for(const e of i){const i=await s.timelineEvents.getByEventId(this._roomId,e.sourceEventId);if(i&&i.event.sender===this._ownMember.userId&&le(i.event).key===t){const e=new fe(i,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([e]),e}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){if(this._localEntries?.hasSubscriptions)for(const t of this._localEntries){if(t.relatedEventId){e.find((e=>e.id===t.relatedEventId))?.addLocalRelation(t)}if(t.redactingEntry){const s=t.redactingEntry.relatedEventId;e.find((e=>e.id===s))?.addLocalRelation(t)}}}static _entryUpdater(e,t){return t.updateFrom(e),t}replaceEntries(e){this._addLocalRelationsToNewRemoteEntries(e);for(const t of e)try{this._remoteEntries.getAndUpdate(t,Ts._entryUpdater)}catch(e){if("CompareError"===e.name)continue;throw e}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._remoteEntries.setManySorted(e)}async loadAtTop(e){if(this._disposables.isDisposed)return!0;const t=this._remoteEntries.array.find((e=>!!e.eventType));if(!t)return!0;const s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),Ht.Backward,e));try{const t=await s.complete();return this.addEntries(t),t.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){if(e)for(const t of this._localEntries)if(t.id===e)return t;if(t){const e=this.getByEventId(t);if(e)return e;{const e=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents]),s=await e.timelineEvents.getByEventId(this._roomId,t);if(s)return new fe(s,this._fragmentIdComparer)}}return null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){const s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}}async function xs(e,t){const{summary:s}=e;return s.data.hasFetchedMembers?async function({roomId:e,storage:t}){const s=await t.readTxn([t.storeNames.roomMembers]);return(await s.roomMembers.getAll(e)).map((e=>new Ie(e)))}(e):t.wrapOrRun(e.log,"fetchMembers",(t=>async function({summary:e,syncToken:t,roomId:s,hsApi:i,storage:r,setChangedMembersMap:n},o){const a=new Map;n(a);const h=await i.members(s,{at:t},{log:o}).response(),c=await r.readWriteTxn([r.storeNames.roomSummary,r.storeNames.roomMembers]);let l,d;try{l=e.writeHasFetchedMembers(!0,c);const{roomMembers:t}=c,i=h.chunk;if(!Array.isArray(i))throw new Error("malformed");o.set("members",i.length),d=await Promise.all(i.map((async e=>{const i=e?.state_key;if(!i)throw new Error("malformed");const r=a.get(i);if(r)return r;{const i=Ie.fromMemberEvent(s,e);return i&&t.set(i.serialize()),i}})))}catch(e){throw c.abort(),e}finally{n(null)}return await c.complete(),e.applyChanges(l),d}(e,t)))}async function Ns(e,t){const s=await async function({roomId:e,userId:t,storage:s}){const i=await s.readTxn([s.storeNames.roomMembers]),r=await i.roomMembers.get(e,t);return r?new Ie(r):null}(e),{summary:i}=e;return i.data.hasFetchedMembers||s?s:t.wrapOrRun(e.log,"fetchMember",(t=>async function({roomId:e,userId:t,hsApi:s,storage:i},r){let n;try{n=await s.state(e,"m.room.member",t,{log:r}).response()}catch(e){if("HomeServerError"===e.name&&"M_NOT_FOUND"===e.errcode)return null;throw e}const o=new Ie({roomId:e,userId:t,membership:n.membership,avatarUrl:n.avatar_url,displayName:n.displayname}),a=await i.readWriteTxn([i.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(e){throw a.abort(),e}return await a.complete(),o}(e,t)))}class Us extends class{constructor(e){this._retentionCount=1,this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,0===this._retentionCount&&this._freeCallback()}}{constructor({members:e,closeCallback:t}){super(t),this._members=new ns;for(const t of e)this._members.add(t.userId,t)}afterSync(e){for(const[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}}class Ls{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){const i=new Map,r=[];for(const t of this._members.keys())-1===e.indexOf(t)&&r.push(t);for(const[s,r]of t.entries())(this._members.has(s)||-1!==e.indexOf(s))&&i.set(s,r.member);for(const t of e)if(!this._members.has(t)&&!i.has(t)){const e=await s.roomMembers.get(this._roomId,t);if(e){const t=new Ie(e);i.set(t.userId,t)}}return{updatedHeroMembers:i.values(),removedUserIds:r}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,i){for(const e of t)this._members.delete(e);for(const t of e)this._members.set(t.userId,t);const r=Array.from(this._members.values()).sort(((e,t)=>e.name.localeCompare(t.name)));this._roomName=function(e,t,s){const i=t.joinCount+t.inviteCount-1;if(e.length>=i){if(e.length>1){const t=e[e.length-1];return e.slice(0,e.length-1).map((e=>e.name)).join(", ")+" and "+t.name}{const t=e[0];return t?t.name:(s.log({l:"could get get other member name",length:e.length,otherMember:!!t,otherMemberMembership:t?.membership}),"Unknown DM Name")}}return e.length<i?e.map((e=>e.name)).join(", ")+` and ${i} others`:null}(r,s,i)}get roomName(){return this._roomName}get roomAvatarUrl(){if(1===this._members.size)for(const e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(1===this._members.size)for(const e of this._members.keys())return e;return null}}class Os{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new Ds(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){const s=e[t];this._map.get(s.id)?.update(s)}}_remove(e){this._map.delete(e),0===this._map.size&&this._notifyEmpty()}}class Ds extends n{constructor(e,t,s){super(),this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then((()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)}))}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}}class Bs{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:i}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=i}canRedactFromSender(e){return e===this._ownUserId&&"join"===this._membership||this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return"join"!==this._membership?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){if(this._plEvent){let t=this._plEvent.content?.users?.[e];if("number"!=typeof t&&(t=this._plEvent.content?.users_default),"number"==typeof t)return t}else if(this._createEvent&&e===this._createEvent.content?.creator)return 100;return 0}_getActionLevel(e){const t=this._plEvent?.content[e];return"number"==typeof t?t:50}_getEventTypeLevel(e){const t=this._plEvent?.content.events?.[e];if("number"==typeof t)return t;{const e=this._plEvent?.content.events_default;return"number"==typeof e?e:0}}}class Ps extends U{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:i,emitCollectionChange:r,user:n,createRoomEncryption:o,getSyncToken:a,platform:h}){super(),this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=i,this._summary=new J(e),this._fragmentIdComparer=new xe([]),this._emitCollectionChange=r,this._timeline=null,this._user=n,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=o,this._roomEncryption=null,this._getSyncToken=a,this._platform=h,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){const s=[];return await Promise.all(e.map((async e=>{const i=await t.timelineEvents.getByEventId(this._roomId,e);i&&s.push(new fe(i,this._fragmentIdComparer))}))),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t);const i=e.reduce(((e,t)=>(e.add(t.id),e)),new Set);return s=s.filter((e=>!i.has(e.id))),s}async notifyRoomKey(e,t,s){if(!this._roomEncryption)return;const i=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]);let r=await this._eventIdsToEntries(t,i);if(this._timeline){const t=this._getAdditionalTimelineRetryEntries(r,[e]);r=r.concat(t)}if(r.length){const e=this._decryptEntries(V.Retry,r,i,s);await e.complete(),this._timeline?.replaceEntries(r);const t=this._summary.data.applyTimelineEntries(r,!1,!1);await this._summary.writeAndApplyData(t,this._storage)&&this._emitUpdate()}}_setEncryption(e){return!(!e||this._roomEncryption)&&(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,V.Timeline)),!0)}_decryptEntries(e,t,s,i=null){return new Ks((async(i,r)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),i.cancelled)return;const n=t.filter((e=>"m.room.encrypted"===e.eventType)).map((e=>e.event));if(i.preparation=await this._roomEncryption.prepareDecryptAll(n,null,e,s),i.cancelled)return;const o=await i.preparation.decrypt();if(i.preparation=null,i.cancelled)return;const a=[this._storage.storeNames.groupSessionDecryptions],h=this._isTimelineOpen;h&&a.push(this._storage.storeNames.deviceIdentities);const c=await this._storage.readWriteTxn(a);let l;try{l=await o.write(c,r),h&&await l.verifySenders(c)}catch(e){throw c.abort(),e}await c.complete(),l.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)}),i||it.item)}async _getSyncRetryDecryptEntries(e,t,s){let i=(await Promise.all(e.map((async e=>{const i=await t.getEventIdsForMissingKey(e,s);if(i)return this._eventIdsToEntries(i,s)})))).reduce(((e,t)=>t?e.concat(t):e),[]);if(this._timeline){const t=this._getAdditionalTimelineRetryEntries(i,e).map((e=>e.clone()));i=i.concat(t)}return i}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){const e=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(e)}if(this._summary.data.needsHeroes){this._heroes=new Ls(this._roomId);const e=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(e,this._summary.data,s)}}catch(e){throw new m(`Could not load room ${this._roomId}`,e)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);const t=this._observedMembers.get(e);if(t)return t;const s=await Ns({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;const i=new c(s,(()=>this._observedMembers.delete(e)));return this._observedMembers.set(e,i),i}async loadMemberList(e=null){if(this._memberList)return this._memberList.retain(),this._memberList;{const t=await xs({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,syncToken:this._getSyncToken(),setChangedMembersMap:e=>this._changedMembersDuringSync=e,log:e},this._platform.logger);return this._memberList=new Us({members:t,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",(async s=>{if(s.set("id",this.id),s.set("fragment",e.fragmentId),s.set("dir",e.direction.asApiString()),e.edgeReached)return void s.set("edgeReached",!0);const i=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:s}).response(),r=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]);let n,o;try{n=await this._writeGapFill(i.chunk,r,s);const t=new jt({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id}),a=new ts({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:t});o=await a.writeFragmentFill(e,i,r,s)}catch(e){throw r.abort(),e}if(await r.complete(),this._roomEncryption){const e=this._decryptEntries(V.Timeline,o.entries,null,s);await e.complete()}for(const e of o.fragments)this._fragmentIdComparer.add(e);n&&this._applyGapFill(n),this._timeline&&(this._timeline.replaceEntries(o.updatedEntries),this._timeline.addEntries(o.entries))}))}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;const e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){const e=this._summary.data.tags;return!(!e||!e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return"join"===this.membership}get isLeft(){return"leave"===this.membership}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}async _loadPowerLevels(){const e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new Bs({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});const s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new Bs({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{const e=this.membership;return new Bs({ownUserId:this._user.id,membership:e})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();const t=await this._powerLevelLoading;e=new c(t,(()=>{this._powerLevels=null})),this._powerLevels=e,this._powerLevelLoading=null}return e}enableSessionBackup(e){this._roomEncryption?.enableSessionBackup(e),this._timeline&&e&&this._platform.logger.run("enableSessionBackup",(e=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,e)))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",(async e=>{if(e.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new Ts({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels()});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,V.Timeline)),await this._timeline.load(this._user,this.membership,e)}catch(e){throw this._timeline.dispose(),e}return this._timeline}))}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new Os((()=>{this._observedEvents=null})));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));const s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then((e=>{s.update(e)})).catch((t=>{console.warn(`could not load event ${e} from storage`,t)})),s}async _readEventById(e){let t=[this._storage.storeNames.timelineEvents];this.isEncrypted&&t.push(this._storage.storeNames.inboundGroupSessions);const s=await this._storage.readTxn(t),i=await s.timelineEvents.getByEventId(this._roomId,e);if(i){const e=new fe(i,this._fragmentIdComparer);if("m.room.encrypted"===e.eventType){const t=this._decryptEntries(V.Timeline,[e],s);await t.complete()}return e}}dispose(){this._roomEncryption?.dispose(),this._timeline?.dispose()}}class Ks{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",(t=>e(this,t)))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}}function Vs(){const e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function Fs(e){return e.startsWith("t")&&15===e.length}class $s{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:i}){i=i||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new _s(((e,t)=>e.queueIndex-t.queueIndex)),this._pendingEvents.setManyUnsorted(i.map((e=>this._createPendingEvent(e)))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){const s=new ye({data:e,remove:()=>this._removeEvent(s),emitUpdate:e=>this._pendingEvents.update(s,e),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",(async e=>{try{for(const t of this._pendingEvents)await e.wrap("send event",(async e=>{e.set("queueIndex",t.queueIndex);try{this._currentQueueIndex=t.queueIndex,await this._sendEvent(t,e)}catch(s){if(s instanceof _)this._offline=!0,e.set("offline",!0),t.setWaiting();else{e.catch(s);"HomeServerError"===s.name&&(400===s.statusCode||403===s.statusCode||404===s.statusCode)?(e.set("remove",!0),await t.abort()):t.setError(s)}}finally{this._currentQueueIndex=0}}))}finally{this._isSending=!1,this._sendLoopLogItem=null}}))}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",(t=>e.uploadAttachments(this._hsApi,t))),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();const s=e.contentForEncryption,{type:i,content:r}=await t.wrap("encrypt",(t=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,t)));e.setEncrypted(i,r),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);const s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(e){throw s.abort(),e}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){const i=this._pendingEvents.array.filter((s=>s.relatedTxnId===e&&s.relatedEventId!==t));for(const e of i)e.setRelatedEventId(t),await this._tryUpdateEventWithTxn(e,s);return i}async removeRemoteEchos(e,t,s){const i=[];for(const r of e){const e=r.unsigned&&r.unsigned.transaction_id;let n;if(n=e?this._pendingEvents.array.findIndex((t=>t.txnId===e)):this._pendingEvents.array.findIndex((e=>e.remoteId===r.event_id)),-1!==n){const o=this._pendingEvents.get(n),a=r.event_id;s.log({l:"removeRemoteEcho",queueIndex:o.queueIndex,remoteId:a,txnId:e}),t.pendingEvents.remove(o.roomId,o.queueIndex),i.push(o),await this._resolveRemoteIdInPendingRelations(e,a,t)}}return i}async _removeEvent(e){if(-1!==this._pendingEvents.array.indexOf(e)){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{t.pendingEvents.remove(e.roomId,e.queueIndex)}catch(e){t.abort()}await t.complete();const s=this._pendingEvents.array.indexOf(e);-1!==s&&this._pendingEvents.remove(s)}e.dispose()}emitRemovals(e){for(const t of e){const e=this._pendingEvents.array.indexOf(t);-1!==e&&this._pendingEvents.remove(e),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",(e=>{e.set("id",this._roomId),e.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(e),this._sendLoopLogItem&&e.refDetached(this._sendLoopLogItem)}))}async enqueueEvent(e,t,s,i){const r=ce(t);let n=null;if(r){const t=ae(r);if(Fs(t)&&(n=t,he(r,null)),"m.annotation"===r.rel_type){if(this._pendingEvents.array.some((t=>{const s=ce(t.content);return t.eventType===e&&s&&s.key===r.key&&(t.relatedTxnId===n||s.event_id===r.event_id)})))return void i.set("already_annotating",!0)}}await this._enqueueEvent(e,t,s,n,null,i)}async _enqueueEvent(e,t,s,i,r,n){const o=await this._createAndStoreEvent(e,t,i,r,s);this._pendingEvents.set(o),n.set("queueIndex",o.queueIndex),n.set("pendingEvents",this._pendingEvents.length),this._isSending||this._offline||this._sendLoop(n),this._sendLoopLogItem&&n.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some((t=>t.eventType===ne&&(t.relatedTxnId===e||t.relatedEventId===e))))return void s.set("already_redacting",!0);let i,r;if(Fs(e)){i=e;const t=e,n=this._pendingEvents.array.find((e=>e.txnId===t));if(n&&!n.remoteId&&n.status!==_e.Sending)return s.set("remove",i),void await n.abort();if(!n)return;r=n.remoteId}else{r=e;const t=this._pendingEvents.array.find((e=>e.remoteId===r));t&&(i=t.txnId)}s.set("relatedTxnId",i),s.set("relatedEventId",r),await this._enqueueEvent(ne,{reason:t},null,i,r,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(e){throw t.abort(),e}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,i,r){const n=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);let o;try{const a=n.pendingEvents,h=await a.getMaxQueueIndex(this._roomId)||0,c=Math.max(h,this._currentQueueIndex)+1,l=e!==ne&&"m.reaction"!==e&&!!this._roomEncryption;o=this._createPendingEvent({roomId:this._roomId,queueIndex:c,eventType:e,content:t,relatedTxnId:s,relatedEventId:i,txnId:Vs(),needsEncryption:l,needsUpload:!!r},r),a.add(o.data)}catch(e){throw n.abort(),e}return await n.complete(),o}dispose(){for(const e of this._pendingEvents)e.dispose()}}class js{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){this._uploadRequest?.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");const{info:e,blob:t}=await async function(e,t){const{crypto:s}=e,{base64:i}=e.encoding,r=await s.aes.generateIV(),n=await s.aes.generateKey("jwk",256),o=await t.readAsBuffer(),a=await s.aes.encryptCTR({jwkKey:n,iv:r,data:o}),h=await s.digest("SHA-256",a);return{blob:e.createBlob(a,"application/octet-stream"),info:{v:"v2",key:n,iv:i.encodeUnpadded(r),hashes:{sha256:i.encodeUnpadded(h)}}}}(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:e=>{this._sentBytes=e,t()},log:s});const{content_uri:i}=await this._uploadRequest.response();this._mxcUrl=i}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));qs(`${s}info.size`,t,this._transferredBlob.size),qs(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?qs(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):qs(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}}function qs(e,t,s){const i=e.split(".");let r=t;for(let e=0;e<i.length-1;e+=1){const t=i[e];r[t]||(r[t]={}),r=r[t]}r[i[i.length-1]]=s}class Ws extends Ps{constructor(e){super(e);const{pendingEvents:t}=e,s=new jt({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new Jt({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new Zt(this.id)}),this._sendQueue=new $s({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return!!super._setEncryption(e)&&(this._sendQueue.enableEncryption(this._roomEncryption),!0)}async prepareSync(e,t,s,i,r,n){n.set("id",this.id),i&&n.set("newKeys",i.length);let o=this._summary.data.applySyncResponse(e,t);"join"===t&&s&&(o=o.applyInvite(s));let a,h,c=this._roomEncryption;if(!c&&o.encryption&&(n.set("enableEncryption",!0),c=this._createRoomEncryption(this,o.encryption)),c){let t=e?.timeline?.events||[];i&&(a=await this._getSyncRetryDecryptEntries(i,c,r),a.length&&(n.set("retry",a.length),t=t.concat(a.map((e=>e.event))))),t=t.filter((e=>"m.room.encrypted"===e?.type)),t.length&&(h=await c.prepareDecryptAll(t,i,V.Sync,r))}return{roomEncryption:c,summaryChanges:o,decryptPreparation:h,decryptChanges:null,retryEntries:a}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",(async t=>{t.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null}),t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:i,roomEncryption:r,retryEntries:n},o,a){a.set("id",this.id);const h=s.isNewJoin(this._summary.data);h&&(o.roomState.removeAllForRoom(this.id),o.roomMembers.removeAllForRoom(this.id));const{entries:c,updatedEntries:l,newLiveKey:d,memberChanges:u}=await a.wrap("syncWriter",(t=>this._syncWriter.writeSync(e,h,s.hasFetchedMembers,o,t)),a.level.Detail);if(i){const e=await a.wrap("decryptChanges",(e=>i.write(o,e)));a.set("decryptionResults",e.results.size),a.set("decryptionErrors",e.errors.size),this._isTimelineOpen&&await e.verifySenders(o),e.applyToEntries(c),n?.length&&(e.applyToEntries(n),l.push(...n))}a.set("newEntries",c.length),a.set("updatedEntries",l.length);let m=!1;r&&this.isTrackingMembers&&u?.size&&(m=await r.writeMemberChanges(u,o,a),a.set("shouldFlushKeyShares",m));const p=c.concat(l);let _,g;"join"!==(s=s.applyTimelineEntries(p,t,!this._isTimelineOpen,this._user.id)).membership?o.roomSummary.remove(this.id):s=this._summary.writeData(s,o),s&&a.set("summaryChanges",s.diff(this._summary.data)),s?.needsHeroes&&(this._heroes||(this._heroes=new Ls(this._roomId)),_=await this._heroes.calculateChanges(s.heroes,u,o)),Array.isArray(e.timeline?.events)&&(g=await this._sendQueue.removeRemoteEchos(e.timeline.events,o,a));const y=this._getPowerLevelsEvent(e);return{summaryChanges:s,roomEncryption:r,newEntries:c,updatedEntries:l,newLiveKey:d,removedPendingEvents:g,memberChanges:u,heroChanges:_,powerLevelsEvent:y,shouldFlushKeyShares:m}}afterSync(e,t){const{summaryChanges:s,newEntries:i,updatedEntries:r,newLiveKey:n,removedPendingEvents:o,memberChanges:a,powerLevelsEvent:h,heroChanges:c,roomEncryption:l}=e;if(t.set("id",this.id),this._syncWriter.afterSync(n),this._setEncryption(l),a.size){if(this._changedMembersDuringSync)for(const[e,t]of a.entries())this._changedMembersDuringSync.set(e,t.member);if(this._memberList&&this._memberList.afterSync(a),this._observedMembers&&this._updateObservedMembers(a),this._timeline)for(const[e,t]of a.entries())if(e===this._user.id){this._timeline.updateOwnMember(t.member);break}}let d=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),d=!0),this._heroes&&c){const e=this.name;this._heroes.applyChanges(c,this._summary.data,t),e!==this.name&&(d=!0)}h&&this._updatePowerLevels(h),d&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(r),this._timeline.addEntries(i)),this._observedEvents&&(this._observedEvents.updateEvents(r),this._observedEvents.updateEvents(i)),o&&this._sendQueue.emitRemovals(o)}_updateObservedMembers(e){for(const[t,s]of e){const e=this._observedMembers.get(t);e&&e.set(s.member)}}_getPowerLevelsEvent(e){const t=e=>""===e.state_key&&"m.room.power_levels"===e.type;return e.timeline?.events.find(t)??e.state?.events.find(t)}_updatePowerLevels(e){if(this._powerLevels){const t=new Bs({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({shouldFlushKeyShares:e}){return e}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){const s=e?.get("share_room_key");s&&t.wrapDetached("flush room keys",(e=>(e.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,e))))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(e){throw new m(`Could not load room ${this._roomId}`,e)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,i=null){return this._platform.logger.wrapOrRun(i,"send",(i=>(i.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,i))))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",(s=>(s.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,s))))}async ensureMessageKeyIsShared(e=null){if(this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",(e=>(e.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,e))))}get avatarColorId(){return this._heroes?.roomAvatarColorId||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){const e=this._syncWriter.lastMessageKey;if(e){const t=await this._storage.readTxn([this._storage.storeNames.timelineEvents]);return(await t.timelineEvents.get(this._roomId,e))?.event?.event_id}}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",(async e=>{e.set("id",this.id);const t=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]);let s;try{s=this._summary.writeClearUnread(t)}catch(e){throw t.abort(),e}await t.complete(),this._summary.applyChanges(s),this._emitUpdate();try{const e=await this._getLastEventId();e&&await this._hsApi.receipt(this._roomId,"m.read",e)}catch(e){if("ConnectionError"!==e.name)throw e}}))}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",(async e=>{e.set("id",this.id),await this._hsApi.leave(this.id,{log:e}).response()}))}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new js({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}}class Hs extends Ps{constructor(e){super(e),this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,0===this._retentionCount&&this._releaseCallback()}async _getKickAuthor(e,t){const s=await t.roomMembers.get(this.id,e);return s?new Ie(s):Ie.fromUserId(this.id,e,"join")}async load(e,t,s){const{summary:i,kickDetails:r}=e;return this._kickDetails=r,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(i,t,s)}async writeSync(e,t,s,i,r){if(r.set("id",this.id),"leave"===s){const s=function(e,t){const s=W(e,((e,s)=>(s.type===Se&&s.state_key===t&&s.sender!==s.state_key&&(e=s),e)),null);if(s)return{membership:s.content?.membership,reason:s.content?.reason,sender:s.sender}}(t,this._user.id);if(s||e){const t=s||this._kickDetails;let r;s&&(r=await this._getKickAuthor(s.sender,i));const n=e||this._summary.data;return i.archivedRoomSummary.set({summary:n.serialize(),kickDetails:t}),{kickDetails:t,kickedBy:r,summaryData:n}}}else"join"===s&&i.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},i){i.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){return"leave"===this._kickDetails?.membership}get isBanned(){return"ban"===this._kickDetails?.membership}get kickedBy(){return this._kickedBy}get kickReason(){return this._kickDetails?.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",(async e=>{e.set("id",this.id),await this._hsApi.forget(this.id,{log:e}).response();const t=this._storage.storeNames,s=await this._storage.readWriteTxn([t.roomState,t.archivedRoomSummary,t.roomMembers,t.timelineEvents,t.timelineFragments,t.timelineRelations,t.pendingEvents,t.inboundGroupSessions,t.groupSessionDecryptions,t.operations]);s.roomState.removeAllForRoom(this.id),s.archivedRoomSummary.remove(this.id),s.roomMembers.removeAllForRoom(this.id),s.timelineEvents.removeAllForRoom(this.id),s.timelineFragments.removeAllForRoom(this.id),s.timelineRelations.removeAllForRoom(this.id),s.pendingEvents.removeAllForRoom(this.id),s.inboundGroupSessions.removeAllForRoom(this.id),s.groupSessionDecryptions.removeAllForRoom(this.id),await s.operations.removeAllForScope(this.id),await s.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)}))}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",(async e=>{await this._hsApi.join(this.id,{log:e}).response()}))}}class zs{constructor(e,t,s){this.joined=e,this.invited=t,this.archived=s}withInvited(){return this.invited?this:this.archived?zs.invitedAndArchived:zs.invited}withoutInvited(){return this.invited?this.joined?zs.joined:this.archived?zs.archived:zs.none:this}withoutArchived(){return this.archived?this.invited?zs.invited:zs.none:this}}zs.joined=new zs(!0,!1,!1),zs.archived=new zs(!1,!1,!0),zs.invited=new zs(!1,!0,!1),zs.invitedAndArchived=new zs(!1,!0,!0),zs.none=new zs(!1,!1,!1);class Gs extends U{constructor({roomId:e,user:t,hsApi:s,mediaRepository:i,emitCollectionRemove:r,emitCollectionUpdate:n,platform:o}){super(),this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=r,this._emitCollectionUpdate=n,this._mediaRepository=i,this._platform=o,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}get isPublic(){return"public"===this._inviteData.joinRule}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",(async e=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:e}).response()}))}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",(async e=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:e}).response()}))}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new Ie(e.inviter):null}async writeSync(e,t,s,i){if("invite"===e){i.set("id",this.id),i.set("add",!0);const e=t.invite_state?.events;if(!Array.isArray(e))return null;const r=this._createSummaryData(e);let n;r.name||r.canonicalAlias||(n=await this._createHeroes(e,i));const o=this._getMyInvite(e);if(!o)return null;const a=this._getInviter(o,e),h=this._createData(e,o,a,r,n);return s.invites.set(h),{inviteData:h,inviter:a}}return i.set("id",this.id),i.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,"join"===e.membership?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,i,r){const n=r?r.roomName:i.name,o=r?r.roomAvatarUrl:i.avatarUrl,a=r?.roomAvatarColorId||this.id;return{roomId:this.id,isEncrypted:!!i.encryption,isDirectMessage:this._isDirectMessage(t),name:n,avatarUrl:o,avatarColorId:a,canonicalAlias:i.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s?.serialize()}}_isDirectMessage(e){return!!e?.content?.is_direct}_createSummaryData(e){return e.reduce(G,new Q(null,this.id))}async _createHeroes(e,t){const s=e.filter((e=>e.type===Se)),i=s.filter((e=>e.state_key!==this._user.id)),r=i.reduce(((e,t)=>{const s=Ie.fromMemberEvent(this.id,t);return e.set(s.userId,new Ee(s,null)),e}),new Map),n=i.map((e=>e.state_key)),o=new Ls(this.id),a=await o.calculateChanges(n,r,null),h=new Q(null,this.id);return h.joinCount=s.reduce(((e,t)=>e+("join"===t.content?.membership?1:0)),0),h.inviteCount=s.reduce(((e,t)=>e+("invite"===t.content?.membership?1:0)),0),o.applyChanges(a,h,t),o}_getMyInvite(e){return e.find((e=>e.type===Se&&e.state_key===this._user.id))}_getInviter(e,t){const s=t.find((t=>t.type===Se&&t.state_key===e.sender));if(s)return Ie.fromMemberEvent(this.id,s)}_getJoinRule(e){const t=e.find((e=>"m.room.join_rules"===e.type));return t?t.content?.join_rule:null}}class Qs{constructor(e){this._description=e}static httpPusher(e,t,s,i){return new Qs({kind:"http",append:!0,data:Object.assign({},i,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){const s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id===e._description.app_id&&(this._description.pushkey===e._description.pushkey&&JSON.stringify(this._description.data)===JSON.stringify(e._description.data))}}function Js(e,t){return Ys(e,t,(()=>[]),((e,t)=>e.push(t)))}function Ys(e,t,s,i){return e.reduce(((e,r)=>{const n=t(r);let o=e.get(n);return o||(o=s(),e.set(n,o)),i(o,r),e}),new Map)}function Xs(e,t){return e.reduce(((e,s)=>{const i=t(s);return e[i]?e[i]+=1:e[i]=1,e}),{})}class Zs{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){return this._olmDecryption?.obtainDecryptionLock(e)}async prepareSync(e,t,s,i){i.set("messageTypes",Xs(e,(e=>e.type)));const r=e.filter((e=>"m.room.encrypted"===e.type));if(!this._olmDecryption)return void i.log("can't decrypt, encryption not enabled",i.level.Warn);const n=r.filter((e=>e.content?.algorithm===F));if(n.length){const e=await this._olmDecryption.decryptAll(n,t,s);i.set("decryptedTypes",Xs(e.results,(e=>e.event?.type)));for(const t of e.errors)i.child("decrypt_error").catch(t);const r=this._megolmDecryption.roomKeysFromDeviceMessages(e.results,i);return new ei(e,r)}}async writeSync(e,t){e.olmDecryptChanges.write(t),await Promise.all(e.newRoomKeys.map((e=>this._megolmDecryption.writeRoomKey(e,t))))}}class ei{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=Js(t,(e=>e.roomId))}}async function ti(e,t,s,i,r){const n=e.pickle(t),o=await r.readWriteTxn([r.storeNames.session]);try{o.session.add("e2ee:olmAccount",n),o.session.add("e2ee:areDeviceKeysUploaded",s),o.session.add("e2ee:serverOTKCount",i)}catch(e){throw o.abort(),e}await o.complete()}class si{static async load({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:n,txn:o}){const a=await o.session.get("e2ee:olmAccount");if(a){const h=new e.Account,c=await o.session.get("e2ee:areDeviceKeysUploaded");h.unpickle(t,a);const l=await o.session.get("e2ee:serverOTKCount");return new si({pickleKey:t,hsApi:s,account:h,userId:i,deviceId:r,areDeviceKeysUploaded:c,serverOTKCount:l,olm:e,olmWorker:n})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:i,userId:r,olmWorker:n,storage:o}){const a=t.adoptUnpickledOlmAccount(),h=JSON.parse(a.one_time_keys()),c=Object.entries(h.curve25519).length;return await ti(a,s,true,c,o),new si({pickleKey:s,hsApi:i,account:a,userId:r,deviceId:t.deviceId,areDeviceKeysUploaded:true,serverOTKCount:c,olm:e,olmWorker:n})}static async create({olm:e,pickleKey:t,hsApi:s,userId:i,deviceId:r,olmWorker:n,storage:o}){const a=new e.Account;n?await n.createAccountAndOTKs(a,a.max_number_of_one_time_keys()):(a.create(),a.generate_one_time_keys(a.max_number_of_one_time_keys()));return o&&await ti(a,t,false,0,o),new si({pickleKey:t,hsApi:s,account:a,userId:i,deviceId:r,areDeviceKeysUploaded:false,serverOTKCount:0,olm:e,olmWorker:n})}constructor({pickleKey:e,hsApi:t,account:s,userId:i,deviceId:r,areDeviceKeysUploaded:n,serverOTKCount:o,olm:a,olmWorker:h}){this._olm=a,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=i,this._deviceId=r,this._areDeviceKeysUploaded=n,this._serverOTKCount=o,this._olmWorker=h,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){const i=JSON.parse(this._account.one_time_keys()),r=Object.entries(i.curve25519);if(r.length||!this._areDeviceKeysUploaded){const i={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);const e=JSON.parse(this._account.identity_keys());i.device_keys=this._deviceKeysPayload(e)}r.length&&(s.set("otks",!0),i.one_time_keys=this._oneTimeKeysPayload(r));const n=t?this._deviceId:void 0,o=await this._hsApi.uploadKeys(n,i,{log:s}).response();this._serverOTKCount=o?.one_time_key_counts?.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,(e=>{r.length&&(this._account.mark_keys_as_published(),e?.set("e2ee:olmAccount",this._account.pickle(this._pickleKey)),e?.set("e2ee:serverOTKCount",this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,e?.set("e2ee:areDeviceKeysUploaded",this._areDeviceKeysUploaded))}))}}async generateOTKsIfNeeded(e,t){const s=this._account.max_number_of_one_time_keys(),i=Math.floor(s/2);if(this._serverOTKCount<i){const r=JSON.parse(this._account.one_time_keys()),n=Object.entries(r.curve25519).length,o=i-n-this._serverOTKCount;return o>0&&await t.wrap("generate otks",(t=>{t.set("max",s),t.set("server",this._serverOTKCount),t.set("unpublished",n),t.set("new",o),t.set("limit",i),this._account.generate_one_time_keys(o),this._updateSessionStorage(e,(e=>{e.set("e2ee:olmAccount",this._account.pickle(this._pickleKey))}))})),!0}return!1}createInboundOlmSession(e,t){const s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(e){throw s.free(),e}}async createOutboundOlmSession(e,t){const s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(e){throw s.free(),e}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set("e2ee:olmAccount",this._account.pickle(this._pickleKey))}writeSync(e,t,s){const i=e.signed_curve25519||0;if(Number.isSafeInteger(i)&&i!==this._serverOTKCount)return t.session.set("e2ee:serverOTKCount",i),s.set("otkCount",i),i}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){const t={user_id:this._userId,device_id:this._deviceId,algorithms:[F,$],keys:{}};for(const[s,i]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=i;return this.signObject(t),t}_oneTimeKeysPayload(e){const t={};for(const[s,i]of e){const e={key:i};this.signObject(e),t[`signed_curve25519:${s}`]=e}return t}async _updateSessionStorage(e,t){if(e){const s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(e){throw s.abort(),e}await s.complete()}else await t(void 0)}signObject(e){const t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(K.stringify(e)),e.signatures=t,void 0!==s&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}}class ii{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){return this._keyDescription?.passphrase}get algorithm(){return this._keyDescription?.algorithm}async isCompatible(e,t){if("m.secret_storage.v1.aes-hmac-sha2"===this.algorithm){const s=this._keyDescription;if(s.mac){const i=await async function(e,t,s){const{crypto:i,encoding:r}=s,{utf8:n,base64:o}=r,{derive:a,aes:h,hmac:c}=i,l=o.decode(t),d=new Uint8Array(8),u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",m=n.encode(""),p=await a.hkdf(e,d,m,"SHA-256",512),_=p.slice(0,32),g=p.slice(32),y=await h.encryptCTR({key:_,iv:l,data:n.encode(u)}),f=await c.compute(g,y,"SHA-256");return o.encode(f)}(e.binaryKey,s.iv,t);return s.mac===i}if(s.passphrase){const t=e.description._keyDescription;return!!t.passphrase&&(s.passphrase.algorithm===t.passphrase.algorithm&&s.passphrase.iterations===t.passphrase.iterations&&s.passphrase.salt===t.passphrase.salt)}}return!1}}class ri{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new ri(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}}const ni=[139,1];var oi;async function ai(e){const t=await e.readTxn([e.storeNames.accountData]),s=(await t.accountData.get("m.secret_storage.default_key"))?.content?.key;if(!s)return;const i=await t.accountData.get(`m.secret_storage.key.${s}`);return i?new ii(s,i.content):void 0}async function hi(e,t,s,i,r){let n;if(e===oi.Passphrase)n=await async function(e,t,s){const{passphraseParams:i}=e;if(!i)throw new Error("not a passphrase key");if("m.pbkdf2"!==i.algorithm)throw new Error(`Unsupported passphrase algorithm: ${i.algorithm}`);const{utf8:r}=s.encoding,n=await s.crypto.derive.pbkdf2(r.encode(t),i.iterations||5e5,r.encode(i.salt),"SHA-512",i.bits||256);return new ri(e,n)}(s,t,i);else{if(e!==oi.RecoveryKey)throw new Error(`Invalid type: ${e}`);n=function(e,t,s,i){const r=i.encoding.base58.decode(t.replace(/ /g,""));let n=0;for(const e of r)n^=e;if(0!==n)throw new Error("Incorrect parity");for(let e=0;e<ni.length;++e)if(r[e]!==ni[e])throw new Error("Incorrect prefix");if(r.length!==ni.length+s.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");const o=Uint8Array.from(r.slice(ni.length,ni.length+s.PRIVATE_KEY_LENGTH));return new ri(e,o)}(s,t,r,i)}return n}!function(e){e[e.RecoveryKey=0]="RecoveryKey",e[e.Passphrase=1]="Passphrase"}(oi||(oi={}));class ci{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){const s=new ii("dehydrated_device",this._dehydratedDevice.device_data.passphrase),i=await hi(e,t,s,this._platform,this._olm),r=new this._olm.Account;try{const e=this._dehydratedDevice.device_data.account;return r.unpickle(i.binaryKey.slice(),e),new li(this._dehydratedDevice,r,i)}catch(e){if(r.free(),"OLM.BAD_ACCOUNT_KEY"===e.message)return;throw e}}get deviceId(){return this._dehydratedDevice.device_id}}class li{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch(e){return!1}}adoptUnpickledOlmAccount(){const e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){this._account?.free(),this._account=void 0}}class di{tryTake(){return!this._promise&&(this._promise=new Promise((e=>{this._resolve=e})),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;const e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}}class ui{constructor(e){this.locks=e}release(){for(const e of this.locks)e.release()}}function mi(e,t,s,i){return{session:e.pickle(i),sessionId:e.session_id(),senderKey:t,lastUsed:s}}class pi{constructor(e,t,s,i=!1){this.data=e,this._olm=s,this._pickleKey=t,this.isNew=i,this.isModified=i}static create(e,t,s,i,r){const n=mi(t,e,r,i);return new pi(n,i,s,!0)}get id(){return this.data.sessionId}load(){const e=new this._olm.Session;return e.unpickle(this._pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this._pickleKey),this.isModified=!0}}class _i{constructor(e,t,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this._device=null,this._roomTracked=!0}setDevice(e){this._device=e}setRoomNotTrackedYet(){this._roomTracked=!1}get isVerified(){if(this._device){return this._device.ed25519Key===this.claimedEd25519Key}return!1}get isUnverified(){return this._device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this._device&&!this._roomTracked}}function gi(e){return 0===e.type}function yi(e){e.sort(((e,t)=>t.data.lastUsed-e.data.lastUsed))}class fi{constructor({account:e,pickleKey:t,now:s,ownUserId:i,storage:r,olm:n,senderKeyLock:o}){this._account=e,this._pickleKey=t,this._now=s,this._ownUserId=i,this._storage=r,this._olm=n,this._senderKeyLock=o}async obtainDecryptionLock(e){const t=new Set;for(const s of e){const e=s.content?.sender_key;e&&t.add(e)}const s=await Promise.all(Array.from(t).map((e=>this._senderKeyLock.takeLock(e))));return new ui(s)}async decryptAll(e,t,s){try{const i=Js(e,(e=>e.content?.sender_key)),r=this._now(),n=await Promise.all(Array.from(i.entries()).map((([e,t])=>this._decryptAllForSenderKey(e,t,r,s)))),o=n.reduce(((e,t)=>e.concat(t.results)),[]),a=n.reduce(((e,t)=>e.concat(t.errors)),[]),h=n.map((e=>e.senderKeyDecryption));return new wi(h,o,a,this._account,t)}catch(e){throw t.release(),e}}async _decryptAllForSenderKey(e,t,s,i){const r=await this._getSessions(e,i),n=new vi(e,r,this._olm,s),o=[],a=[];for(const e of t)try{const t=this._decryptForSenderKey(n,e,s);o.push(t)}catch(e){a.push(e)}return{results:o,errors:a,senderKeyDecryption:n}}_decryptForSenderKey(e,t,s){const i=e.senderKey,r=this._getMessageAndValidateEvent(t);let n;try{n=e.decrypt(r)}catch(e){throw new j("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:i,error:e.message})}if("string"!=typeof n&&gi(r)){let o;try{o=this._createSessionAndDecrypt(i,r,s)}catch(e){throw new j(`Could not create inbound olm session: ${e.message}`,t,{senderKey:i,error:e})}e.addNewSession(o.session),n=o.plaintext}if("string"==typeof n){let e;try{e=JSON.parse(n)}catch(e){throw new j("PLAINTEXT_NOT_JSON",t,{plaintext:n,error:e})}return this._validatePayload(e,t),new _i(e,i,e.keys.ed25519)}throw new j("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map((e=>e.id))})}_createSessionAndDecrypt(e,t,s){let i;const r=this._account.createInboundOlmSession(e,t.body);try{i=r.decrypt(t.type,t.body);const n=pi.create(e,r,this._olm,this._pickleKey,s);return n.unload(r),{session:n,plaintext:i}}catch(e){throw r.free(),e}}_getMessageAndValidateEvent(e){const t=e.content?.ciphertext;if(!t)throw new j("OLM_MISSING_CIPHERTEXT",e);const s=t?.[this._account.identityKeys.curve25519];if(!s)throw new j("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){const s=(await t.olmSessions.getAll(e)).map((e=>new pi(e,this._pickleKey,this._olm)));return yi(s),s}_validatePayload(e,t){if(e.sender!==t.sender)throw new j("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this._ownUserId)throw new j("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(e.recipient_keys?.ed25519!==this._account.identityKeys.ed25519)throw new j("OLM_BAD_RECIPIENT_KEY",t,{key:e.recipient_keys?.ed25519});if(!e.type)throw new j("missing type on payload",t,{payload:e});if("string"!=typeof e.keys?.ed25519)throw new j("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}}class vi{constructor(e,t,s,i){this.senderKey=e,this.sessions=t,this._olm=s,this._timestamp=i}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(const t of this.sessions){const s=this._decryptWithSession(t,e);if("string"==typeof s)return yi(this.sessions),s}}getModifiedSessions(){return this.sessions.filter((e=>e.isModified))}get hasNewSessions(){return this.sessions.some((e=>e.isNew))}_decryptWithSession(e,t){const s=e.load();try{if(gi(t)&&!s.matches_inbound(t.body))return;try{const i=s.decrypt(t.type,t.body);return e.save(s),e.lastUsed=this._timestamp,i}catch(s){if(gi(t))throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${s.message}`);return}}finally{e.unload(s)}}}class wi{constructor(e,t,s,i,r){this._senderKeyDecryptions=e,this._account=i,this.results=t,this.errors=s,this._lock=r}get hasNewSessions(){return this._senderKeyDecryptions.some((e=>e.hasNewSessions))}write(e){try{for(const t of this._senderKeyDecryptions){for(const s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){const t=s.load();try{this._account.writeRemoveOneTimeKey(t,e)}finally{s.unload(t)}}if(t.sessions.length>4){const{senderKey:s,sessions:i}=t;for(let t=i.length-1;t>=4;t-=1){const r=i[t];e.olmSessions.remove(s,r.id)}}}}finally{this._lock.release()}}}class bi{constructor({account:e,olm:t,olmUtil:s,ownUserId:i,storage:r,now:n,pickleKey:o,senderKeyLock:a}){this._account=e,this._olm=t,this._olmUtil=s,this._ownUserId=i,this._storage=r,this._now=n,this._pickleKey=o,this._senderKeyLock=a}async encrypt(e,t,s,i,r){let n=[];for(let o=0;o<s.length;o+=20){const a=s.slice(o,o+20),h=await this._encryptForMaxDevices(e,t,a,i,r);n=n.concat(h)}return n}async _encryptForMaxDevices(e,t,s,i,r){const n=await Promise.all(s.map((e=>this._senderKeyLock.takeLock(e.curve25519Key))));try{const{devicesWithoutSession:o,existingEncryptionTargets:a}=await this._findExistingSessions(s),h=this._now();let c=[];try{if(o.length){const e=await r.wrap("create sessions",(e=>this._createNewSessions(o,i,h,e)));c=c.concat(e)}await this._loadSessions(a),c=c.concat(a);const s={l:"encrypt",targets:c.length},n=r.wrap(s,(()=>c.map((s=>{const i=this._encryptForDevice(e,t,s);return new Ii(i,s.device)}))));return await this._storeSessions(c,h),n}finally{for(const e of c)e.dispose()}}finally{for(const e of n)e.release()}}async _findExistingSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]),s=await Promise.all(e.map((async e=>await t.olmSessions.getSessionIds(e.curve25519Key)))),i=e.filter(((e,t)=>!s[t]?.length)),r=e.map(((e,t)=>{const i=s[t];if(i?.length>0){const t=function(e){return e.reduce(((e,t)=>!e||t<e?t:e),null)}(i);return Si.fromSessionId(e,t)}})).filter((e=>!!e));return{devicesWithoutSession:i,existingEncryptionTargets:r}}_encryptForDevice(e,t,s){const{session:i,device:r}=s,n=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,r)),o=i.encrypt(n);return{algorithm:F,sender_key:this._account.identityKeys.curve25519,ciphertext:{[r.curve25519Key]:o}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this._account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this._ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,i){const r=await i.wrap("claim",(s=>this._claimOneTimeKeys(t,e,s)));try{for(const e of r){const{device:t,oneTimeKey:s}=e;e.session=await this._account.createOutboundOlmSession(t.curve25519Key,s)}await this._storeSessions(r,s)}catch(e){for(const e of r)e.dispose();throw e}return r}async _claimOneTimeKeys(e,t,s){const i=Ys(t,(e=>e.userId),(()=>new Map),((e,t)=>e.set(t.deviceId,t))),r=Array.from(i.entries()).reduce(((e,[t,s])=>(e[t]=Array.from(s.values()).reduce(((e,t)=>(e[t.deviceId]="signed_curve25519",e)),{}),e)),{}),n=await e.claimKeys({timeout:1e4,one_time_keys:r},{log:s}).response();Object.keys(n.failures).length&&s.log({l:"failures",servers:Object.keys(n.failures)},s.level.Warn);const o=n?.one_time_keys;return this._verifyAndCreateOTKTargets(o,i,s)}_verifyAndCreateOTKTargets(e,t,s){const i=[];for(const[r,n]of Object.entries(e))for(const[e,o]of Object.entries(n)){const[n,a]=Object.entries(o)[0],[h]=n.split(":");if("signed_curve25519"===h){const n=t.get(r)?.get(e);if(n){if(q(this._olmUtil,r,e,n.ed25519Key,a,s)){const e=Si.fromOTK(n,a.key);i.push(e)}}}}return i}async _loadSessions(e){const t=await this._storage.readTxn([this._storage.storeNames.olmSessions]);let s=!1;try{await Promise.all(e.map((async e=>{const i=await t.olmSessions.get(e.device.curve25519Key,e.sessionId);if(i&&!s){const t=new this._olm.Session;t.unpickle(this._pickleKey,i.session),e.session=t}})))}catch(t){s=!0;for(const t of e)t.dispose();throw t}}async _storeSessions(e,t){const s=await this._storage.readWriteTxn([this._storage.storeNames.olmSessions]);try{for(const i of e){const e=mi(i.session,i.device.curve25519Key,t,this._pickleKey);s.olmSessions.set(e)}}catch(e){throw s.abort(),e}await s.complete()}}class Si{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new Si(e,t,null)}static fromSessionId(e,t){return new Si(e,null,t)}dispose(){this.session&&this.session.free()}}class Ii{constructor(e,t){this.content=e,this.device=t}}class Ei{constructor(e,t,s,i){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=i}async write(e){return await Promise.all(this._replayEntries.map((async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(e){this._errors.set(t.eventId,e)}}))),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){const{messageIndex:i,sessionId:r,eventId:n,timestamp:o}=t,a=await s.groupSessionDecryptions.get(e,r,i);if(a&&a.eventId!==n){const e=a.timestamp<o?n:a.eventId;throw this._results.delete(n),new j("MEGOLM_REPLAYED_INDEX",event,{messageIndex:i,badEventId:e,otherEventId:a.eventId})}a||s.groupSessionDecryptions.set(e,r,i,{eventId:n,timestamp:o})}}function ki(e,t){if(e)for(const[s,i]of e.entries())t.set(s,i)}class Ri{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{const e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map((async i=>{const r=await i.decryptAll();ki(r.errors,e),ki(r.results,t),s.push(...r.replayEntries)}))),new Ei(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(const e of this._sessionDecryptions)e.dispose()}}class Ci{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}}class Ai{constructor(e,t,s,i){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=i,this.decryptionRequests=s?[]:void 0}async decryptAll(){const e=[],t=new Map;let s;return await this.keyLoader.useKey(this.key,(async i=>{for(const r of this.events)try{const s=r.content.ciphertext;let n;if(this.olmWorker){const e=this.olmWorker.megolmDecrypt(i,s);this.decryptionRequests.push(e),n=await e.response()}else n=i.decrypt(s);const{plaintext:o}=n;let a;try{a=JSON.parse(o)}catch(e){throw new j("PLAINTEXT_NOT_JSON",r,{plaintext:o,err:e})}if(a.room_id!==this.key.roomId)throw new j("MEGOLM_WRONG_ROOM",r,{encryptedRoomId:a.room_id,eventRoomId:this.key.roomId});e.push(new Ci(this.key.sessionId,n.message_index,r));const h=new _i(a,this.key.senderKey,this.key.claimedEd25519Key);t.set(r.event_id,h)}catch(e){if("AbortError"===e.name)return;s||(s=new Map),s.set(r.event_id,e)}})),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(const e of this.decryptionRequests)e.abort()}}function Mi(e){return e.content?.sender_key}function Ti(e){return e.content?.session_id}function xi(e){return"string"==typeof Mi(e)&&"string"==typeof Ti(e)&&"string"==typeof function(e){return e.content?.ciphertext}(e)}class Ni{constructor(){this.events=[]}get senderKey(){return Mi(this.events[0])}get sessionId(){return Ti(this.events[0])}}function Ui(e){return Ys(e,(e=>`${Mi(e)}|${Ti(e)}`),(()=>new Ni),((e,t)=>e.events.push(t)))}class Li{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}}function Oi(e,t){return e.first_known_index()<t.first_known_index()}class Di extends Li{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(void 0===this.isBetter&&await this._checkBetterThanKeyInStorage(e,((e,t)=>{s=e.pickle(t)}),t),!1===this.isBetter)return!1;s||(s=await e.useKey(this,((e,t)=>e.pickle(t))));const i={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(i),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(void 0!==this.isBetter)return this.isBetter;let i=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!i){const e=await Fi(this.roomId,this.senderKey,this.sessionId,s);e&&(e.hasSession?i=e:e.eventIds&&(this._eventIds=e.eventIds))}if(i){const s=i;await e.useKey(this,(async i=>{await e.useKey(s,((e,r)=>{this.isBetter=Oi(i,e),s.isBetter=!this.isBetter,this.isBetter&&t&&t(i,r)}))}))}else this.isBetter=!0;return this.isBetter}}class Bi extends Di{constructor(e){super(),this._decryptionResult=e}get roomId(){return this._decryptionResult.event.content?.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){return this._decryptionResult.event.content?.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){return this._decryptionResult.event.content?.session_key}get serializationType(){return"create"}loadInto(e){e.create(this.serializationKey)}}class Pi extends Di{constructor(e,t,s){super(),this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){return this._backupInfo.sender_claimed_keys?.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}loadInto(e){e.import_session(this.serializationKey)}}class Ki extends Li{constructor(e){super(),this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}}function Vi(e){const t=e.event.content?.session_key,s=new Bi(e);if("string"==typeof s.roomId&&"string"==typeof s.sessionId&&"string"==typeof s.senderKey&&"string"==typeof t)return s}async function Fi(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r)return new Ki(r)}class $i{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,i,r){let n=await r.inboundGroupSessions.get(e,t,s);if(!n?.session){if(n){const e=new Set(n.eventIds);for(const t of i)e.add(t);n.eventIds=Array.from(e)}else n={roomId:e,senderKey:t,sessionId:s,eventIds:i};r.inboundGroupSessions.set(n)}}async getEventIdsForMissingKey(e,t,s,i){const r=await i.inboundGroupSessions.get(e,t,s);if(r&&!r.session)return r.eventIds}async hasSession(e,t,s,i){return"string"==typeof(await i.inboundGroupSessions.get(e,t,s))?.session}async prepareDecryptAll(e,t,s,i){const r=new Map,n=[];for(const e of t)xi(e)?n.push(e):r.set(e.event_id,new j("MEGOLM_INVALID_EVENT",e));const o=Ui(n),a=[];return await Promise.all(Array.from(o.values()).map((async t=>{const n=await this.getRoomKey(e,t.senderKey,t.sessionId,s,i);if(n)a.push(new Ai(n,t.events,this.olmWorker,this.keyLoader));else for(const e of t.events)r.set(e.event_id,new j("MEGOLM_NO_SESSION",e))}))),new Ri(e,a,r)}async getRoomKey(e,t,s,i,r){if(i){const n=i.find((i=>i.isForSession(e,t,s)));if(n&&await n.checkBetterThanKeyInStorage(this.keyLoader,r))return n}const n=this.keyLoader.getCachedKey(e,t,s);if(n)return n;const o=await Fi(e,t,s,r);return o&&o.serializationKey?o:void 0}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){const s=[];for(const i of e)"m.room_key"===i.event?.type&&i.event.content?.algorithm===$&&t.wrap("room_key",(e=>{const t=Vi(i);t?(e.set("roomId",t.roomId),e.set("id",t.sessionId),s.push(t)):(e.logLevel=e.level.Warn,e.set("invalid",!0))}),t.level.Detail);return s}roomKeyFromBackup(e,t,s){return function(e,t,s){const i=s.session_key,r=s.sender_key,n=s.sender_claimed_keys?.ed25519;if("string"==typeof e&&"string"==typeof t&&"string"==typeof r&&"string"==typeof i&&"string"==typeof n)return new Pi(e,t,s)}(e,t,s)}dispose(){this.keyLoader.dispose()}}class ji extends Yt{constructor(e,t,s){super(s),this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){const i=this.findCachedKeyIndex(e,t,s);if(-1!==i)return this._getByIndexAndMoveUp(i).key}async useKey(e,t){const s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some((e=>0!==e.refCount))}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;-1===(t=this.findIndexForAllocation(e));)await this.operationBecomesUnused();if(t<this.size){const s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}{const t=new this.olm.InboundGroupSession;e.loadInto(t,this.pickleKey);const s=new qi(e,t);return this._set(s),s}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise((e=>{this.resolveUnusedOperation=e}))),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return-1===t&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),-1===t&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce(((i,r,n,o)=>{const a=-1===i?void 0:o[i];return!0!==r.isBest||!r.isForSameSession(e,t,s)||a&&!r.isBetter(a)?i:n}),-1)}findIndexSameKey(e){return this._entries.findIndex((t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e)))}findIndexSameSessionUnused(e){return this._entries.reduce(((t,s,i,r)=>{const n=-1===t?void 0:r[t];return 0!==s.refCount||!s.isForSameSession(e.roomId,e.senderKey,e.sessionId)||n&&s.isBetter(n)?t:i}),-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1){if(0===this._entries[e].refCount)return e}return-1}}class qi{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return Oi(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}}class Wi{constructor({backupInfo:e,decryption:t,hsApi:s}){this._backupInfo=e,this._decryption=t,this._hsApi=s}async getSession(e,t,s){const i=await this._hsApi.roomKeyForRoomAndSession(this._backupInfo.version,e,t,{log:s}).response(),r=this._decryption.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext);return JSON.parse(r)}get version(){return this._backupInfo.version}dispose(){this._decryption.free()}static async fromSecretStorage({platform:e,olm:t,secretStorage:s,hsApi:i,txn:r}){const n=await s.readSecret("m.megolm_backup.v1",r);if(n){const s=new Uint8Array(e.encoding.base64.decode(n)),r=await i.roomKeysVersion().response(),o=r.auth_data.public_key,a=new t.PkDecryption;try{const e=a.init_with_private_key(s);if(e!==o)throw new Error(`Bad backup key, public key does not match. Calculated ${e} but expected ${o}`)}catch(e){throw a.free(),e}return new Wi({backupInfo:r,decryption:a,hsApi:i})}}}class Hi{constructor({pickleKey:e,olm:t,account:s,storage:i,now:r,ownDeviceId:n}){this._pickleKey=e,this._olm=t,this._account=s,this._storage=i,this._now=r,this._ownDeviceId=n}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){const t=new this._olm.OutboundGroupSession;try{return t.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(t,e)}finally{t.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{const i=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let r;try{let n=await i.outboundGroupSessions.get(e);r=this._readOrCreateSession(s,n,e,t,i),r&&this._writeSession(this._now(),s,e,i)}catch(e){throw i.abort(),e}return await i.complete(),r}finally{s.free()}}_readOrCreateSession(e,t,s,i,r){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,i)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();const i=this._createRoomKeyMessage(e,s);return this._storeAsInboundSession(e,s,r),i}}_writeSession(e,t,s,i){i.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,i){let r=new this._olm.OutboundGroupSession;try{const n=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]);let o,a;try{let h=await n.outboundGroupSessions.get(e);o=this._readOrCreateSession(r,h,e,i,n),a=this._encryptContent(e,r,t,s);const c=o?this._now():h.createdAt;this._writeSession(c,r,e,n)}catch(e){throw n.abort(),e}return await n.complete(),new zi(a,o)}finally{r&&r.free()}}_needsToRotate(e,t,s){let i=6048e5;Number.isSafeInteger(s?.rotation_period_ms)&&(i=s?.rotation_period_ms);let r=100;return Number.isSafeInteger(s?.rotation_period_msgs)&&(r=s?.rotation_period_msgs),this._now()>t+i||(e.message_index()>=r||void 0)}_encryptContent(e,t,s,i){const r=JSON.stringify({room_id:e,type:s,content:i}),n=t.encrypt(r);return{algorithm:$,sender_key:this._account.identityKeys.curve25519,ciphertext:n,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:$,chain_index:e.message_index()}}_storeAsInboundSession(e,t,s){const{identityKeys:i}=this._account,r={ed25519:i.ed25519},n=new this._olm.InboundGroupSession;try{n.create(e.session_key());const o={roomId:t,senderKey:i.curve25519,sessionId:n.session_id(),session:n.pickle(this._pickleKey),claimedKeys:r};return s.inboundGroupSessions.set(o),o}finally{n.free()}}}class zi{constructor(e,t){this.content=e,this.roomKeyMessage=t}}class Gi{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:i,megolmDecryption:r,encryptionParams:n,storage:o,sessionBackup:a,notifyMissingMegolmSession:h,clock:c}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=i,this._megolmDecryption=r,this._encryptionParams=n,this._senderDeviceCache=new Map,this._storage=o,this._sessionBackup=a,this._notifyMissingMegolmSession=h,this._clock=c,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._disposed=!1}enableSessionBackup(e){this._sessionBackup&&e||(this._sessionBackup=e)}async restoreMissingSessionsFromBackup(e,t){const s=Ui(e.filter((e=>e.isEncrypted&&!e.isDecrypted&&e.event)).map((e=>e.event))),i=Array.from(s.values()),r=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),n=await Promise.all(i.map((async e=>this._megolmDecryption.hasSession(this._room.id,e.senderKey,e.sessionId,r)))),o=i.filter(((e,t)=>!n[t]));if(o.length)for(var a=o.length-1;a>=0;a--){const e=o[a];await t.wrap("session",(t=>this._requestMissingSessionFromBackup(e.senderKey,e.sessionId,t)))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeMemberChanges(e,t,s){let i=!1;const r=Array.from(e.values());return r.some((e=>e.hasLeft))&&(s.log({l:"discardOutboundSession",leftUsers:r.filter((e=>e.hasLeft)).map((e=>e.userId))}),this._megolmEncryption.discardOutboundSession(this._room.id,t)),r.some((e=>e.hasJoined))&&(i=await this._addShareRoomKeyOperationForNewMembers(r,t,s)),await this._deviceTracker.writeMemberChanges(this._room,e,t),i}async prepareDecryptAll(e,t,s,i){const r=new Map,n=[];for(const t of e)t.redacted_because||t.unsigned?.redacted_because||(t.content?.algorithm!==$&&r.set(t.event_id,new Error("Unsupported algorithm: "+t.content?.algorithm)),n.push(t));const o=await this._megolmDecryption.prepareDecryptAll(this._room.id,n,t,i);return new Qi(o,r,s,this,e)}async _processDecryptionResults(e,t,s,i,r,n){const o=e.filter((e=>"MEGOLM_NO_SESSION"===s.get(e.event_id)?.code));if(!o.length)return;const a=Ui(o);i===V.Sync&&await Promise.all(Array.from(a.values()).map((async e=>{const t=e.events.map((e=>e.event_id));return this._megolmDecryption.addMissingKeyEventIds(this._room.id,e.senderKey,e.sessionId,t,r)}))),this._sessionBackup&&n.wrapDetached("check key backup",(async e=>{if(e.set("source",i),e.set("events",o.length),e.set("sessions",a.size),i===V.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;const e=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(a).map((async([t,s])=>{await this._megolmDecryption.hasSession(this._room.id,s.senderKey,s.sessionId,e)&&a.delete(t)})))}await Promise.all(Array.from(a.values()).map((t=>e.wrap("session",(e=>this._requestMissingSessionFromBackup(t.senderKey,t.sessionId,e))))))}))}async _verifyDecryptionResult(e,t){let s=this._senderDeviceCache.get(e.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,s)),s?e.setDevice(s):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,s){if(!this._sessionBackup)return s.set("enabled",!1),void this._notifyMissingMegolmSession();s.set("id",t),s.set("senderKey",e);try{const i=await this._sessionBackup.getSession(this._room.id,t,s);if(i?.algorithm===$){let r=this._megolmDecryption.roomKeyFromBackup(this._room.id,t,i);if(r){if(r.senderKey!==e)return s.set("wrong_sender_key",r.senderKey),void(s.logLevel=s.level.Warn);let t,i=!1;const n=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{i=await this._megolmDecryption.writeRoomKey(r,n),s.set("isBetter",i),i&&(t=r.eventIds)}catch(e){throw n.abort(),e}await n.complete(),i&&await s.wrap("retryDecryption",(e=>this._room.notifyRoomKey(r,t||[],e)))}}else i?.algorithm&&s.set("unknown algorithm",i.algorithm)}catch(e){"HomeServerError"!==e.name||"M_NOT_FOUND"!==e.errcode?s.set("not_found",!0):(s.error=e,s.logLevel=s.level.Error)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){if(!(this._lastKeyPreShareTime?.measure()<6e4)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{const s=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);s&&await t.wrap("share key",(t=>this._shareNewRoomKey(s,e,t)))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,i){this._keySharePromise&&(i.set("waitForRunningKeyShare",!0),await this._keySharePromise);const r=await i.wrap("megolm encrypt",(()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams)));return r.roomKeyMessage&&await i.wrap("share key",(e=>this._shareNewRoomKey(r.roomKeyMessage,s,e))),{type:"m.room.encrypted",content:r.content}}needsToShareKeys(e){for(const t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){let i,r=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{i=this._writeRoomKeyShareOperation(e,null,r)}catch(e){throw r.abort(),e}await this._processShareRoomKeyOperation(i,t,s)}async _addShareRoomKeyOperationForNewMembers(e,t,s){const i=e.filter((e=>e.hasJoined)).map((e=>e.userId)),r=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return!!r&&(s.log({l:"share key for new members",userIds:i,id:r.session_id,chain_index:r.chain_index}),this._writeRoomKeyShareOperation(r,i,t),!0)}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{if(!t){const e=await this._storage.readTxn([this._storage.storeNames.operations]);t=await e.operations.getAllByTypeAndScope("share_room_key",this._room.id)}for(const i of t)"share_room_key"===i.type&&await s.wrap("operation",(t=>this._processShareRoomKeyOperation(i,e,t)))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){const i={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(i),i}async _processShareRoomKeyOperation(e,t,s){let i;if(s.set("id",e.id),await this._deviceTracker.trackRoom(this._room,s),null===e.userIds){i=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s);const r=Array.from(i.reduce(((e,t)=>e.add(t.userId)),new Set));e.userIds=r,await this._updateOperationsStore((t=>t.update(e)))}else i=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s);const r=await s.wrap("olm encrypt",(s=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,i,t,s))),n=i.filter((e=>!r.some((t=>t.device===e))));await s.wrap("send",(e=>this._sendMessagesToDevices("m.room.encrypted",r,t,e))),n.length&&await s.wrap("missingDevices",(async s=>{s.set("devices",n.map((e=>e.deviceId)));const i=e.userIds.filter((e=>n.some((t=>t.userId===e))));s.set("unsentUserIds",i),e.userIds=i,await this._updateOperationsStore((t=>t.update(e)));const r=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",r,n,t,s)})),await this._updateOperationsStore((t=>t.remove(e.id)))}async _updateOperationsStore(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(e){throw t.abort(),e}await t.complete()}async _sendSharedMessageToDevices(e,t,s,i,r){const n=Js(s,(e=>e.userId)),o={messages:Array.from(n.entries()).reduce(((e,[s,i])=>(e[s]=i.reduce(((e,s)=>(e[s.deviceId]=t,e)),{}),e)),{})},a=Vs();await i.sendToDevice(e,o,a,{log:r}).response()}async _sendMessagesToDevices(e,t,s,i){i.set("messages",t.length);const r=Js(t,(e=>e.device.userId)),n={messages:Array.from(r.entries()).reduce(((e,[t,s])=>(e[t]=s.reduce(((e,t)=>(e[t.device.deviceId]=t.content,e)),{}),e)),{})},o=Vs();await s.sendToDevice(e,n,o,{log:i}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter((e=>{if(e.isEncrypted&&!e.isDecrypted){const{event:s}=e;if(s){const e=s.content?.sender_key,i=s.content?.session_id;return t.some((t=>e===t.senderKey&&i===t.sessionId))}}return!1}))}dispose(){this._disposed=!0}}class Qi{constructor(e,t,s,i,r){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async decrypt(){return new Ji(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}}class Ji{constructor(e,t,s,i,r){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=i,this._events=r}async write(e,t){const{results:s,errors:i}=await this._megolmDecryptionChanges.write(e);return ki(this._extraErrors,i),await this._roomEncryption._processDecryptionResults(this._events,s,i,this._source,e,t),new Yi(s,i,this._roomEncryption)}}class Yi{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e){for(const t of e){const e=this.results.get(t.id);if(e)t.setDecryptionResult(e);else{const e=this.errors.get(t.id);e&&t.setDecryptionError(e)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map((t=>this._roomEncryption._verifyDecryptionResult(t,e))))}}class Xi{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new di,t.tryTake(),this._map.set(e,t)),t.released().then((()=>{Promise.resolve().then((()=>{t.isTaken||this._map.delete(e)}))})),t}}class Zi{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){const s=await t.accountData.get(e);if(!s)return;const i=s?.content?.encrypted?.[this._key.id];if(!i)throw new Error(`Secret ${s.type} is not encrypted for key ${this._key.id}`);if("m.secret_storage.v1.aes-hmac-sha2"===this._key.algorithm)return await this._decryptAESSecret(s.type,i);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){const{base64:s,utf8:i}=this._platform.encoding,r=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,i.encode(e),"SHA-256",512),n=r.slice(0,32),o=r.slice(32),a=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(o,s.decode(t.mac),a,"SHA-256"))throw new Error("Bad MAC");const h=await this._platform.crypto.aes.decryptCTR({key:n,iv:s.decode(t.iv),data:a});return i.decode(h)}}class er{constructor({storage:e,hsApi:t,sessionInfo:s,olm:i,olmWorker:r,platform:n,mediaRepository:o}){this._platform=n,this._storage=e,this._hsApi=t,this._mediaRepository=o,this._syncInfo=null,this._sessionInfo=s,this._rooms=new ns,this._roomUpdateCallback=(e,t)=>this._rooms.update(e.id,t),this._activeArchivedRooms=new Map,this._invites=new ns,this._inviteUpdateCallback=(e,t)=>this._invites.update(e.id,t),this._user=new Ms(s.userId),this._deviceMessageHandler=new Zs({storage:e}),this._olm=i,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=r,this._sessionBackup=null,this._hasSecretStorageKey=new h(null),this._observedRoomStatus=new Map,i&&(this._olmUtil=new i.Utility,this._deviceTracker=new Pt({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsSessionBackup=new h(!1)}get fingerprintKey(){return this._e2eeAccount?.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}async logout(e){await this._hsApi.logout({log:e}).response()}_setupEncryption(){const e=new Xi,t=new fi({account:this._e2eeAccount,pickleKey:"DEFAULT_KEY",olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,senderKeyLock:e});this._olmEncryption=new bi({account:this._e2eeAccount,pickleKey:"DEFAULT_KEY",olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,olmUtil:this._olmUtil,senderKeyLock:e}),this._megolmEncryption=new Hi({account:this._e2eeAccount,pickleKey:"DEFAULT_KEY",olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId});const s=new ji(this._olm,"DEFAULT_KEY",20);this._megolmDecryption=new $i(s,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==$?null:new Gi({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,sessionBackup:this._sessionBackup,encryptionParams:t,notifyMissingMegolmSession:()=>{this._sessionBackup||this.needsSessionBackup.set(!0)},clock:this._platform.clock})}async enableSecretStorage(e,t){if(!this._olm)throw new Error("olm required");if(this._sessionBackup)return!1;const s=await async function(e,t,s,i,r){const n=await ai(s);if(!n)throw new Error("Could not find a default secret storage key in account data");return await hi(e,t,n,i,r)}(e,t,this._storage,this._platform,this._olm),i=await this._storage.readTxn([this._storage.storeNames.accountData]);return await this._createSessionBackup(s,i),await this._writeSSSSKey(s),this._hasSecretStorageKey.set(!0),s}async _writeSSSSKey(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{!async function(e,t){t.session.set("e2ee:ssssKey",{id:e.id,binaryKey:e.binaryKey})}(e,t)}catch(e){throw t.abort(),e}await t.complete()}async disableSecretStorage(){const e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{!async function(e){e.session.remove("e2ee:ssssKey")}(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._sessionBackup){for(const e of this._rooms.values())e.isEncrypted&&e.enableSessionBackup(void 0);this._sessionBackup?.dispose(),this._sessionBackup=void 0}this._hasSecretStorageKey.set(!1)}async _createSessionBackup(e,t){const s=new Zi({key:e,platform:this._platform});if(this._sessionBackup=await Wi.fromSecretStorage({platform:this._platform,olm:this._olm,secretStorage:s,hsApi:this._hsApi,txn:t}),this._sessionBackup)for(const e of this._rooms.values())e.isEncrypted&&e.enableSessionBackup(this._sessionBackup);this.needsSessionBackup.set(!1)}get sessionBackup(){return this._sessionBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",(e=>this._e2eeAccount.uploadKeys(this._storage,!1,e))))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await si.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:"DEFAULT_KEY",userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t){return si.create({hsApi:this._hsApi,olm:this._olm,pickleKey:"DEFAULT_KEY",userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",(async t=>{const s=await this._createNewAccount("temp-device-id");try{const i=await async function(e,t,s,i,r){const n=(await t.createDehydratedDevice({device_data:{algorithm:"org.matrix.msc2697.v1.olm.libolm_pickle",account:e.pickleWithKey(s.binaryKey.slice()),passphrase:s.description?.passphraseParams||{}},initial_device_display_name:i}).response()).device_id;return e.setDeviceId(n),await e.uploadKeys(void 0,!0,r),n}(s,this._hsApi,e,"Dehydrated device",t);return t.set("deviceId",i),i}finally{s.dispose()}}))}async load(e){const t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await si.load({hsApi:this._hsApi,olm:this._olm,pickleKey:"DEFAULT_KEY",userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));const s=await this._getPendingEventsByRoom(t),i=await t.invites.getAll(),r=Promise.all(i.map((async t=>{const s=this.createInvite(t.roomId);e.wrap("invite",(e=>s.load(t,e))),this._invites.add(s.id,s)}))),n=await t.roomSummary.getAll(),o=Promise.all(n.map((async i=>{const r=this.createRoom(i.roomId,s.get(i.roomId));await e.wrap("room",(e=>r.load(i,t,e))),this._rooms.add(r.id,r)})));await Promise.all([r,o]);for(const[e,t]of this.invites){const s=this.rooms.get(e);s&&s.setInvite(t)}}dispose(){this._olmWorker?.dispose(),this._olmWorker=void 0,this._sessionBackup?.dispose(),this._sessionBackup=void 0,this._megolmDecryption?.dispose(),this._megolmDecryption=void 0,this._e2eeAccount?.dispose(),this._e2eeAccount=void 0;for(const e of this._rooms.values())e.dispose();this._rooms=void 0}async start(e,t,s){if(e){const t=await this._storage.readWriteTxn([this._storage.storeNames.session]);t.session.set("serverVersions",e),await t.complete()}if(!this._sessionBackup){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",(async e=>{const s=await async function(e,t,s){const i=await ai(t);if(await(i?.isCompatible(e,s)))return e.withDescription(i)}(t.key,this._storage,this._platform);s&&(e.set("success",!0),await this._writeSSSSKey(s))}));const e=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),i=await async function(e){const t=await e.session.get("e2ee:ssssKey");if(!t)return;const s=await e.accountData.get(`m.secret_storage.key.${t.id}`);return s?new ri(new ii(t.id,s.content),t.binaryKey):void 0}(e);i&&await this._createSessionBackup(i,e),this._hasSecretStorageKey.set(!!i)}const i=await this._storage.readWriteTxn([this._storage.storeNames.operations]),r=Js(await i.operations.getAll(),(e=>e.scope));for(const e of this._rooms.values()){let t;const i=r.get(e.id);i&&(t=Js(i,(e=>e.type))),e.start(t,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce(((e,t)=>{const s=e.get(t.roomId);return s?s.push(t):e.set(t.roomId,[t]),e}),new Map)}get rooms(){return this._rooms}createRoom(e,t){return new Ws({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){const t=new Hs({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new Gs({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}async obtainSyncLock(e){const t=e.to_device?.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,i){const r=e.to_device?.events;if(Array.isArray(r)&&r.length)return await i.wrap("deviceMsgs",(e=>this._deviceMessageHandler.prepareSync(r,t,s,e)))}async writeSync(e,t,s,i,r){const n={syncInfo:null,e2eeAccountChanges:null},o=e.next_batch;if(o!==this.syncToken){const e={token:o,filterId:t};i.session.set("sync",e),n.syncInfo=e}const a=e.device_one_time_keys_count;this._e2eeAccount&&a&&(n.e2eeAccountChanges=this._e2eeAccount.writeSync(a,i,r));const h=e.device_lists;this._deviceTracker&&Array.isArray(h?.changed)&&h.changed.length&&await r.wrap("deviceLists",(e=>this._deviceTracker.writeDeviceChanges(h.changed,i,e))),s&&await r.wrap("deviceMsgs",(e=>this._deviceMessageHandler.writeSync(s,i,e)));const c=e.account_data;if(Array.isArray(c?.events))for(const e of c.events)"string"==typeof e.type&&i.accountData.set(e);return n}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){if(!t){await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",(e=>this._e2eeAccount.uploadKeys(this._storage,!1,e)))}}applyRoomCollectionChangesAfterSync(e,t,s){for(const e of t)e.shouldAdd?this._rooms.add(e.id,e.room):e.shouldRemove&&this._rooms.remove(e.id);for(const t of e)t.shouldAdd?this._invites.add(t.id,t.invite):t.shouldRemove&&this._invites.remove(t.id);if(0!==this._observedRoomStatus.size){for(const e of s)e.shouldAdd&&this._observedRoomStatus.get(e.id)?.set(zs.archived);for(const e of t)e.shouldAdd&&this._observedRoomStatus.get(e.id)?.set(zs.joined);for(const t of e){const e=this._observedRoomStatus.get(t.id);e&&(t.shouldAdd?e.set(e.get().withInvited()):t.shouldRemove&&e.set(e.get().withoutInvited()))}}}_forgetArchivedRoom(e){const t=this._observedRoomStatus.get(e);t&&t.set(t.get().withoutArchived())}get syncToken(){return this._syncInfo?.token}get syncFilterId(){return this._syncInfo?.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",(async e=>{const t=Qs.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(Qs,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);const i=await this._storage.readWriteTxn([this._storage.storeNames.session]);return i.session.set("pusher",s.serialize()),await i.complete(),!0}))}async _disablePush(){return this._platform.logger.run("disablePush",(async e=>{await this._platform.notificationService.disablePush();const t=await this._storage.readTxn([this._storage.storeNames.session]),s=await t.session.get("pusher");if(!s)return!0;const i=new Qs(s);await i.disable(this._hsApi,e);const r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.remove("pusher"),await r.complete(),!0}))}async arePushNotificationsEnabled(){if(!await this._platform.notificationService.isPushEnabled())return!1;const e=await this._storage.readTxn([this._storage.storeNames.session]);return!!await e.session.get("pusher")}async checkPusherEnabledOnHomeserver(){const e=await this._storage.readTxn([this._storage.storeNames.session]),t=await e.session.get("pusher");if(!t)return!1;const s=new Qs(t);return((await this._hsApi.getPushers().response())?.pushers||[]).map((e=>new Qs(e))).some((e=>e.equals(s)))}async getRoomStatus(e){if(!!this._rooms.get(e))return zs.joined;{const t=!!this._invites.get(e),s=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary]),i=await s.archivedRoomSummary.has(e);return t&&i?zs.invitedAndArchived:t?zs.invited:i?zs.archived:zs.none}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){const s=await this.getRoomStatus(e);t=new c(s,(()=>{this._observedRoomStatus.delete(e)})),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",(async t=>{t.set("id",e);const s=this._activeArchivedRooms.get(e);if(s)return s.retain(),s;const i=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),r=await i.archivedRoomSummary.get(e);if(r){const s=this._createArchivedRoom(e);return await s.load(r,i,t),s}}))}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",(async t=>(await this._hsApi.joinIdOrAlias(e,{log:t}).response()).room_id))}}class tr{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}}class sr{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Vs(),t,{log:s}).response()}}class ir{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}}const rr=e("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),nr=e("Connection","Credentials","Unknown");class or{constructor({platform:e,olmPromise:t,workerPromise:s}){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new h(rr.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=t,this._workerPromise=s,this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===rr.NotLoading&&(this._status.set(rr.Loading),await this._platform.logger.run("load session",(async t=>{t.set("id",e);try{const s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(e){t.catch(e),this._error=e,this._status.set(rr.Error)}})))}_parseLoginOptions(e,t){const s=e.flows,i={homeserver:t};for(const e of s)"m.login.password"===e.type?i.password=(e,s)=>new tr({homeserver:t,username:e,password:s}):"m.login.sso"===e.type&&s.find((e=>"m.login.token"===e.type))?i.sso=new ir(t):"m.login.token"===e.type&&(i.token=e=>new sr({homeserver:t,loginToken:e}));return i}queryLogin(e){return new s((async s=>{e=await async function(e,s){e=t(e);const i=await async function(e,t){const s={format:"json",timeout:3e4,method:"GET"};try{const i=`${e}/.well-known/matrix/client`;return await t(i,s).response()}catch(e){if("ConnectionError"===e.name)return null;throw e}}(e,s);if(i&&200===i.status){const{body:s}=i,r=s["m.homeserver"]?.base_url;"string"==typeof r&&(e=t(r))}return e}(e,((e,t)=>s(this._platform.request(e,t))));const i=new f({homeserver:e,request:this._platform.request}),r=await s(i.getLoginFlows()).response();return this._parseLoginOptions(r,e)}))}async startWithLogin(e,{inspectAccountSetup:t}={}){const s=this._status.get();s!==rr.LoginFailed&&s!==rr.NotLoading&&s!==rr.Error||(this._resetStatus(),await this._platform.logger.run("login",(async s=>{this._status.set(rr.Login);const i=this._platform.clock;let r,n;try{const t=this._platform.request,n=new f({homeserver:e.homeserver,request:t}),o=await e.login(n,"Hydrogen",s),a=this.createNewSessionId();r={id:a,deviceId:o.device_id,userId:o.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:o.access_token,lastUsed:i.now()},s.set("id",a)}catch(e){return this._error=e,void("HomeServerError"===e.name?("M_FORBIDDEN"===e.errcode?this._loginFailure=nr.Credentials:this._loginFailure=nr.Unknown,s.set("loginFailure",this._loginFailure),this._status.set(rr.LoginFailed)):"ConnectionError"===e.name?(this._loginFailure=nr.Connection,this._status.set(rr.LoginFailed)):this._status.set(rr.Error))}t&&(n=await this._inspectAccountAfterLogin(r,s),n&&(r.deviceId=n.deviceId)),await this._platform.sessionInfoStorage.add(r);try{await this._loadSessionInfo(r,n,s),s.set("status",this._status.get())}catch(e){s.catch(e),n?.dispose(),this._error=e,this._status.set(rr.Error)}})))}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);const i=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(rr.Loading),this._reconnector=new b({onlineStatus:this._platform.onlineStatus,retryDelay:new v(i.createTimeout),createMeasure:i.createMeasure});const r=new f({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);const n={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},o=await this._olmPromise;let a=null;this._workerPromise&&(a=await this._workerPromise),this._requestScheduler=new k({hsApi:r,clock:i}),this._requestScheduler.start();const h=new S({homeserver:e.homeServer,platform:this._platform});if(this._session=new er({storage:this._storage,sessionInfo:n,hsApi:this._requestScheduler.hsApi,olm:o,olmWorker:a,mediaRepository:h,platform:this._platform}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",(e=>this._session.dehydrateIdentity(t,e))),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(rr.SessionSetup),await s.wrap("createIdentity",(e=>this._session.createIdentity(e)))),this._sync=new A({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe((e=>{e===w.Online&&this._platform.logger.runDetached("reconnect",(async e=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;const s=t;t=void 0,await e.wrap("session start",(e=>this._session.start(this._reconnector.lastVersionsResponse,s,e)))}))})),await s.wrap("wait first sync",(()=>this._waitForFirstSync())),!this._isDisposed&&(this._status.set(rr.Ready),!this._sessionStartedByReconnector)){const e=await r.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;const i=t;t=void 0,await s.wrap("session start",(t=>this._session.start(e,i,t)))}}async _waitForFirstSync(){this._sync.start(),this._status.set(rr.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor((e=>e===R.Stopped?"ConnectionError"!==this._sync.error?.name:e===R.Syncing));try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===R.Stopped&&this._sync.error)throw this._sync.error}catch(e){if("AbortError"===e.name)return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",(async t=>{this._status.set(rr.QueryAccount);const s=new f({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),i=await this._olmPromise;let r;try{r=await async function(e,t,s,i){try{const r=await e.getDehydratedDevice({log:i}).response();if("org.matrix.msc2697.v1.olm.libolm_pickle"===r.device_data.algorithm)return new ci(r,t,s)}catch(e){return void("HomeServerError"!==e.name&&(i.error=e))}}(s,i,this._platform,t)}catch(e){if("HomeServerError"!==e.name)throw e;t.set("not_supported",!0)}if(r){let e;const t=new Promise((t=>e=t));this._accountSetup=new ar(r,e),this._status.set(rr.AccountSetup),await t;const s=this._accountSetup?._dehydratedDevice;return this._accountSetup=null,s}}))}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}logout(){return this._platform.logger.run("logout",(async e=>{try{await(this._session?.logout(e))}catch(e){}await this.deleteSession(e)}))}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",(()=>this._platform.storageFactory.delete(this._sessionId))),e.wrap("sessionInfoStorage",(()=>this._platform.sessionInfoStorage.delete(this._sessionId)))]),this._sessionId=null)}_resetStatus(){this._status.set(rr.NotLoading),this._error=null,this._loginFailure=null}}class ar{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}}class hr{constructor(e){this._allowsChild=e,this._path=new lr([],e),this._observables=new Map,this._pathObservable=new h(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,t){return this.applyPath(this.path.with(new cr(e,t)))}applyPath(e){const t=this._path;this._path=e;for(let e=t.segments.length-1;e>=0;e-=1){const s=t.segments[e];if(!this._path.get(s.type)){this._observables.get(s.type)?.emitIfChanged()}}for(const e of this._path.segments){this._observables.get(e.type)?.emitIfChanged()}this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new dr(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new lr(e.slice(0,s),this._allowsChild);t=e[s]}return new lr(e,this._allowsChild)}segment(e,t){return new cr(e,t)}}class cr{constructor(e,t){this.type=e,this.value=void 0===t||t}}class lr{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new lr(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){const s=this._segments.slice(0,t+1);return s.push(e),new lr(s,this._allowsChild)}t-=1}while(t>=-1);return null}until(e){const t=this._segments.findIndex((t=>t.type===e));return new lr(-1!==t?this._segments.slice(0,t+1):[],this._allowsChild)}get(e){return this._segments.find((t=>t.type===e))}replace(e){const t=this._segments.findIndex((t=>t.type===e.type));if(-1!==t){const s=this._segments[t-1];if(this._allowsChild(s,e)){const s=this._segments[t+1];if(!s||this._allowsChild(e,s)){const s=this._segments.slice();return s[t]=e,new lr(s,this._allowsChild)}}}return null}get segments(){return this._segments}}class dr extends n{constructor(e,t){super(),this._navigation=e,this._type=t,this._lastSetValue=e.path.get(t)?.value}get(){const e=this._navigation.path.get(this._type)?.value;return e}emitIfChanged(){const e=this.get();(function(e,t){if(e===t)return!0;if(Array.isArray(e)&&Array.isArray(t)){const s=Math.max(e.length,t.length);for(let i=0;i<s;i+=1)if(e[i]!==t[i])return!1;return!0}return!1})(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}}class ur{constructor({history:e,navigation:t,parseUrlPath:s,stringifyPath:i}){this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=i,this._subscription=null,this._pathSubscription=null,this._isApplyingUrl=!1,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){const e=this._urlAsNavPath(this._history.getLastUrl()||"").get("session")?.value;return"string"==typeof e?e:null}attach(){this._subscription=this._history.subscribe((e=>this._applyUrl(e))),this._pathSubscription=this._navigation.pathObservable.subscribe((e=>this._applyNavPathToHistory(e))),this._applyUrl(this._history.get())}dispose(){this._subscription=this._subscription(),this._pathSubscription=this._pathSubscription()}_applyNavPathToHistory(e){const t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){const t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){const t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){const e=this._urlAsNavPath(this._history.getLastUrl()||"");return 0!==e.segments.length&&(this._applyNavPathToNavigation(e),!0)}urlForSegments(e){let t=this._navigation.path;for(const s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,t){return this.urlForSegments([this._navigation.segment(e,t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){const t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}}function mr(){return new hr(_r)}function pr({history:e,navigation:t}){return new ur({history:e,navigation:t,stringifyPath:wr,parseUrlPath:vr})}function _r(e,t){const{type:s}=t;switch(e?.type){case void 0:return"login"===s||"session"===s||"sso"===s;case"session":return"room"===s||"rooms"===s||"settings"===s;case"rooms":return"room"===s||"empty-grid-tile"===s;case"room":return"lightbox"===s||"right-panel"===s;case"right-panel":return"details"===s||"members"===s||"member"===s;default:return!1}}function gr(e,t,s){if(e.value.includes(t))return e;{const i=s.get("empty-grid-tile"),r=s.get("room");let n=0;i?n=i.value:r&&(n=e.value.indexOf(r.value));const o=e.value.slice();return o[n]=t,new cr("rooms",o)}}function yr(e,t,s=!0){e.push(new cr("right-panel")),e.push(new cr(t,s))}function fr(e,t){const s=e.path.segments,i=s.findIndex((e=>"right-panel"===e.type));let r=t;return-1!==i&&(r=t.until("room"),r=r.with(s[i]),r=r.with(s[i+1])),r}function vr(e,t,s){const i=e.substr(1).split("/"),r=i[Symbol.iterator](),n=[];let o;for(;!(o=r.next()).done;){const e=o.value;if("rooms"===e){const t=r.next().value;if(void 0===t)break;const s=t.split(",");n.push(new cr(e,s));const i=parseInt(r.next().value||"0",10),o=s[i];o?n.push(new cr("room",o)):n.push(new cr("empty-grid-tile",i))}else if("open-room"===e){const e=r.next().value;if(!e)break;const s=t.get("rooms");s&&n.push(gr(s,e,t)),n.push(new cr("room",e));if(i.findIndex((e=>"open-room"===e))>=i.length-2){const e=t.segments,s=e.findIndex((e=>"right-panel"===e.type));-1!==s&&n.push(...e.slice(s))}}else if("last-session"===e){let e=t.get("session");"string"!=typeof e?.value&&s&&(e=new cr("session",s)),e&&n.push(e)}else if("details"===e||"members"===e)yr(n,e);else if("member"===e){const t=r.next().value;if(!t)break;yr(n,e,t)}else if(e.includes("loginToken")){const t=e.split("=").pop();n.push(new cr("sso",t))}else{const t=r.next().value;n.push(new cr(e,t))}}return n}function wr(e){let t,s="";for(const i of e.segments){switch(i.type){case"rooms":s+=`/rooms/${i.value.join(",")}`;break;case"empty-grid-tile":s+=`/${i.value}`;break;case"room":if("rooms"===t?.type){s+=`/${t.value.indexOf(i.value)}`}else s+=`/${i.type}/${i.value}`;break;case"right-panel":case"sso":continue;default:s+=`/${i.type}`,i.value&&!0!==i.value&&(s+=`/${i.value}`)}t=i}return s}function br(e,t=Math.random){return e.includes("?")?e+="&":e+="?",e+`_cacheBuster=${Math.ceil(t()*Number.MAX_SAFE_INTEGER)}`}class Sr{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}}function Ir(e,t){let{cache:s,format:r,body:n,method:o}=t;s||(e=br(e));const a=function(e,{method:t,headers:s,timeout:i,format:r,uploadProgress:n}){const o=new XMLHttpRequest;if(n&&o.upload.addEventListener("progress",(e=>n(e.loaded))),o.open(t,e),"buffer"===r&&(o.responseType="arraybuffer"),s)for(const[e,t]of s.entries())try{o.setRequestHeader(e,t)}catch(t){console.info(`Could not set ${e} header: ${t.message}`)}return i&&(o.timeout=i),o}(e,t),h=function(e,t,s){return new Promise(((r,n)=>{e.addEventListener("load",(()=>r(e))),e.addEventListener("abort",(()=>n(new i))),e.addEventListener("error",(()=>n(new _(`Error ${t} ${s}`)))),e.addEventListener("timeout",(()=>n(new _(`Timeout ${t} ${s}`,!0))))}))}(a,o,e).then((e=>{const{status:t}=e;let s=null;return"buffer"===r?s=e.response:"application/json"===e.getResponseHeader("Content-Type")&&(s=JSON.parse(e.responseText)),{status:t,body:s}}));return n?.nativeBlob&&(n=n.nativeBlob),a.send(n||null),new Sr(h,a)}class Er{constructor(e,t){if(t)this.promise=e,this._controller=t;else{const t=new Promise(((e,t)=>{this._controller={abort(){const e=new Error("fetch request aborted");e.name="AbortError",t(e)}}}));this.promise=Promise.race([e,t])}}abort(){this._controller.abort()}response(){return this.promise}}function kr(e,t){return function(s,r){if(t?.haltRequests)return new Er(new Promise((()=>{})),{});if(r?.uploadProgress)return Ir(s,r);let{method:n,headers:o,body:a,timeout:h,format:c,cache:l=!1}=r;const d="function"==typeof AbortController?new AbortController:null;a?.nativeBlob&&(a=a.nativeBlob);let u={method:n,body:a};if(d&&(u=Object.assign(u,{signal:d.signal})),l||(s=br(s)),u=Object.assign(u,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){const e=new Headers;for(const[t,s]of o.entries())e.append(t,s);u.headers=e}const m=fetch(s,u).then((async e=>{const{status:t}=e;let s;try{"json"===c?s=await e.json():"buffer"===c&&(s=await e.arrayBuffer())}catch(e){if(!("SyntaxError"===e.name&&t>=400))throw e}return{status:t,body:s}}),(e=>{if("AbortError"===e.name)throw new i;if(e instanceof TypeError)throw new _(`${n} ${s}: ${e.message}`);throw e})),p=new Er(m,d);return h&&(p.promise=function(e,t,s,i){const r=e(t);let n=!1;return r.elapsed().then((()=>{n=!0,s.abort()}),(()=>{})),i.then((e=>(r.abort(),e)),(e=>{throw r.abort(),"AbortError"===e.name&&n?new _(`Request timed out after ${t}ms`,!0):e}))}(e,h,p,p.promise)),p}}class Rr{constructor(e){this._name=e}getAll(){const e=localStorage.getItem(this._name);if(e){const t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){const s=await this.getAll();if(s){const i=s.find((t=>t.id===e));i&&(i.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){const t=await this.getAll();if(t)return t.find((t=>t.id===e))}async add(e){const t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter((t=>t.id!==e)),localStorage.setItem(this._name,JSON.stringify(t))}}class Cr{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){const s=window.localStorage.getItem(`${this._prefix}${e}`);return"string"==typeof s?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){const s=window.localStorage.getItem(`${this._prefix}${e}`);return"string"==typeof s?"true"===s:t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}}class Ar{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}}var Mr={};!function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=new Uint8Array(256),s=0;s<e.length;s++)t[e.charCodeAt(s)]=s;Mr.encode=function(t){var s,i=new Uint8Array(t),r=i.length,n="";for(s=0;s<r;s+=3)n+=e[i[s]>>2],n+=e[(3&i[s])<<4|i[s+1]>>4],n+=e[(15&i[s+1])<<2|i[s+2]>>6],n+=e[63&i[s+2]];return r%3==2?n=n.substring(0,n.length-1)+"=":r%3==1&&(n=n.substring(0,n.length-2)+"=="),n},Mr.decode=function(e){var s,i,r,n,o,a=.75*e.length,h=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var l=new ArrayBuffer(a),d=new Uint8Array(l);for(s=0;s<h;s+=4)i=t[e.charCodeAt(s)],r=t[e.charCodeAt(s+1)],n=t[e.charCodeAt(s+2)],o=t[e.charCodeAt(s+3)],d[c++]=i<<2|r>>4,d[c++]=(15&r)<<4|n>>2,d[c++]=(3&n)<<6|63&o;return l}}();class Tr{encodeUnpadded(e){const t=Mr.encode(e),s=t.indexOf("=");return-1!==s?t.substr(0,s):t}encode(e){return Mr.encode(e)}decode(e){return Mr.decode(e)}}for(var xr={exports:{}},Nr={},Ur={byteLength:function(e){var t=Vr(e),s=t[0],i=t[1];return 3*(s+i)/4-i},toByteArray:function(e){var t,s,i=Vr(e),r=i[0],n=i[1],o=new Dr(function(e,t,s){return 3*(t+s)/4-s}(0,r,n)),a=0,h=n>0?r-4:r;for(s=0;s<h;s+=4)t=Or[e.charCodeAt(s)]<<18|Or[e.charCodeAt(s+1)]<<12|Or[e.charCodeAt(s+2)]<<6|Or[e.charCodeAt(s+3)],o[a++]=t>>16&255,o[a++]=t>>8&255,o[a++]=255&t;2===n&&(t=Or[e.charCodeAt(s)]<<2|Or[e.charCodeAt(s+1)]>>4,o[a++]=255&t);1===n&&(t=Or[e.charCodeAt(s)]<<10|Or[e.charCodeAt(s+1)]<<4|Or[e.charCodeAt(s+2)]>>2,o[a++]=t>>8&255,o[a++]=255&t);return o},fromByteArray:function(e){for(var t,s=e.length,i=s%3,r=[],n=16383,o=0,a=s-i;o<a;o+=n)r.push(Fr(e,o,o+n>a?a:o+n));1===i?(t=e[s-1],r.push(Lr[t>>2]+Lr[t<<4&63]+"==")):2===i&&(t=(e[s-2]<<8)+e[s-1],r.push(Lr[t>>10]+Lr[t>>4&63]+Lr[t<<2&63]+"="));return r.join("")}},Lr=[],Or=[],Dr="undefined"!=typeof Uint8Array?Uint8Array:Array,Br="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Pr=0,Kr=Br.length;Pr<Kr;++Pr)Lr[Pr]=Br[Pr],Or[Br.charCodeAt(Pr)]=Pr;function Vr(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=e.indexOf("=");return-1===s&&(s=t),[s,s===t?0:4-s%4]}function Fr(e,t,s){for(var i,r,n=[],o=t;o<s;o+=3)i=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),n.push(Lr[(r=i)>>18&63]+Lr[r>>12&63]+Lr[r>>6&63]+Lr[63&r]);return n.join("")}Or["-".charCodeAt(0)]=62,Or["_".charCodeAt(0)]=63;var $r={/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(e,t,s,i,r){var n,o,a=8*r-i-1,h=(1<<a)-1,c=h>>1,l=-7,d=s?r-1:0,u=s?-1:1,m=e[t+d];for(d+=u,n=m&(1<<-l)-1,m>>=-l,l+=a;l>0;n=256*n+e[t+d],d+=u,l-=8);for(o=n&(1<<-l)-1,n>>=-l,l+=i;l>0;o=256*o+e[t+d],d+=u,l-=8);if(0===n)n=1-c;else{if(n===h)return o?NaN:1/0*(m?-1:1);o+=Math.pow(2,i),n-=c}return(m?-1:1)*o*Math.pow(2,n-i)},write:function(e,t,s,i,r,n){var o,a,h,c=8*n-r-1,l=(1<<c)-1,d=l>>1,u=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,m=i?0:n-1,p=i?1:-1,_=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=l):(o=Math.floor(Math.log(t)/Math.LN2),t*(h=Math.pow(2,-o))<1&&(o--,h*=2),(t+=o+d>=1?u/h:u*Math.pow(2,1-d))*h>=2&&(o++,h/=2),o+d>=l?(a=0,o=l):o+d>=1?(a=(t*h-1)*Math.pow(2,r),o+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,r),o=0));r>=8;e[s+m]=255&a,m+=p,a/=256,r-=8);for(o=o<<r|a,c+=r;c>0;e[s+m]=255&o,m+=p,o/=256,c-=8);e[s+m-p]|=128*_}};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
(function(e){const t=Ur,s=$r,i="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=o,e.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},e.INSPECT_MAX_BYTES=50;const r=2147483647;function n(e){if(e>r)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,o.prototype),t}function o(e,t,s){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return c(e)}return a(e,t,s)}function a(e,t,s){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!o.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const s=0|m(e,t);let i=n(s);const r=i.write(e,t);r!==s&&(i=i.slice(0,r));return i}(e,t);if(ArrayBuffer.isView(e))return function(e){if(z(e,Uint8Array)){const t=new Uint8Array(e);return d(t.buffer,t.byteOffset,t.byteLength)}return l(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(z(e,ArrayBuffer)||e&&z(e.buffer,ArrayBuffer))return d(e,t,s);if("undefined"!=typeof SharedArrayBuffer&&(z(e,SharedArrayBuffer)||e&&z(e.buffer,SharedArrayBuffer)))return d(e,t,s);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const i=e.valueOf&&e.valueOf();if(null!=i&&i!==e)return o.from(i,t,s);const r=function(e){if(o.isBuffer(e)){const t=0|u(e.length),s=n(t);return 0===s.length||e.copy(s,0,0,t),s}if(void 0!==e.length)return"number"!=typeof e.length||G(e.length)?n(0):l(e);if("Buffer"===e.type&&Array.isArray(e.data))return l(e.data)}(e);if(r)return r;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function h(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function c(e){return h(e),n(e<0?0:0|u(e))}function l(e){const t=e.length<0?0:0|u(e.length),s=n(t);for(let i=0;i<t;i+=1)s[i]=255&e[i];return s}function d(e,t,s){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(s||0))throw new RangeError('"length" is outside of buffer bounds');let i;return i=void 0===t&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,t):new Uint8Array(e,t,s),Object.setPrototypeOf(i,o.prototype),i}function u(e){if(e>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return 0|e}function m(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||z(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const s=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===s)return 0;let r=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*s;case"hex":return s>>>1;case"base64":return W(e).length;default:if(r)return i?-1:q(e).length;t=(""+t).toLowerCase(),r=!0}}function p(e,t,s){let i=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===s||s>this.length)&&(s=this.length),s<=0)return"";if((s>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return A(this,t,s);case"utf8":case"utf-8":return E(this,t,s);case"ascii":return R(this,t,s);case"latin1":case"binary":return C(this,t,s);case"base64":return I(this,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,t,s);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function _(e,t,s){const i=e[t];e[t]=e[s],e[s]=i}function g(e,t,s,i,r){if(0===e.length)return-1;if("string"==typeof s?(i=s,s=0):s>2147483647?s=2147483647:s<-2147483648&&(s=-2147483648),G(s=+s)&&(s=r?0:e.length-1),s<0&&(s=e.length+s),s>=e.length){if(r)return-1;s=e.length-1}else if(s<0){if(!r)return-1;s=0}if("string"==typeof t&&(t=o.from(t,i)),o.isBuffer(t))return 0===t.length?-1:y(e,t,s,i,r);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,s):Uint8Array.prototype.lastIndexOf.call(e,t,s):y(e,[t],s,i,r);throw new TypeError("val must be string, number or Buffer")}function y(e,t,s,i,r){let n,o=1,a=e.length,h=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;o=2,a/=2,h/=2,s/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(r){let i=-1;for(n=s;n<a;n++)if(c(e,n)===c(t,-1===i?0:n-i)){if(-1===i&&(i=n),n-i+1===h)return i*o}else-1!==i&&(n-=n-i),i=-1}else for(s+h>a&&(s=a-h),n=s;n>=0;n--){let s=!0;for(let i=0;i<h;i++)if(c(e,n+i)!==c(t,i)){s=!1;break}if(s)return n}return-1}function f(e,t,s,i){s=Number(s)||0;const r=e.length-s;i?(i=Number(i))>r&&(i=r):i=r;const n=t.length;let o;for(i>n/2&&(i=n/2),o=0;o<i;++o){const i=parseInt(t.substr(2*o,2),16);if(G(i))return o;e[s+o]=i}return o}function v(e,t,s,i){return H(q(t,e.length-s),e,s,i)}function w(e,t,s,i){return H(function(e){const t=[];for(let s=0;s<e.length;++s)t.push(255&e.charCodeAt(s));return t}(t),e,s,i)}function b(e,t,s,i){return H(W(t),e,s,i)}function S(e,t,s,i){return H(function(e,t){let s,i,r;const n=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)s=e.charCodeAt(o),i=s>>8,r=s%256,n.push(r),n.push(i);return n}(t,e.length-s),e,s,i)}function I(e,s,i){return 0===s&&i===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(s,i))}function E(e,t,s){s=Math.min(e.length,s);const i=[];let r=t;for(;r<s;){const t=e[r];let n=null,o=t>239?4:t>223?3:t>191?2:1;if(r+o<=s){let s,i,a,h;switch(o){case 1:t<128&&(n=t);break;case 2:s=e[r+1],128==(192&s)&&(h=(31&t)<<6|63&s,h>127&&(n=h));break;case 3:s=e[r+1],i=e[r+2],128==(192&s)&&128==(192&i)&&(h=(15&t)<<12|(63&s)<<6|63&i,h>2047&&(h<55296||h>57343)&&(n=h));break;case 4:s=e[r+1],i=e[r+2],a=e[r+3],128==(192&s)&&128==(192&i)&&128==(192&a)&&(h=(15&t)<<18|(63&s)<<12|(63&i)<<6|63&a,h>65535&&h<1114112&&(n=h))}}null===n?(n=65533,o=1):n>65535&&(n-=65536,i.push(n>>>10&1023|55296),n=56320|1023&n),i.push(n),r+=o}return function(e){const t=e.length;if(t<=k)return String.fromCharCode.apply(String,e);let s="",i=0;for(;i<t;)s+=String.fromCharCode.apply(String,e.slice(i,i+=k));return s}(i)}e.kMaxLength=r,o.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),o.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}}),o.poolSize=8192,o.from=function(e,t,s){return a(e,t,s)},Object.setPrototypeOf(o.prototype,Uint8Array.prototype),Object.setPrototypeOf(o,Uint8Array),o.alloc=function(e,t,s){return function(e,t,s){return h(e),e<=0?n(e):void 0!==t?"string"==typeof s?n(e).fill(t,s):n(e).fill(t):n(e)}(e,t,s)},o.allocUnsafe=function(e){return c(e)},o.allocUnsafeSlow=function(e){return c(e)},o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.compare=function(e,t){if(z(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),z(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let s=e.length,i=t.length;for(let r=0,n=Math.min(s,i);r<n;++r)if(e[r]!==t[r]){s=e[r],i=t[r];break}return s<i?-1:i<s?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);let s;if(void 0===t)for(t=0,s=0;s<e.length;++s)t+=e[s].length;const i=o.allocUnsafe(t);let r=0;for(s=0;s<e.length;++s){let t=e[s];if(z(t,Uint8Array))r+t.length>i.length?(o.isBuffer(t)||(t=o.from(t)),t.copy(i,r)):Uint8Array.prototype.set.call(i,t,r);else{if(!o.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(i,r)}r+=t.length}return i},o.byteLength=m,o.prototype._isBuffer=!0,o.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)_(this,t,t+1);return this},o.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)_(this,t,t+3),_(this,t+1,t+2);return this},o.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)_(this,t,t+7),_(this,t+1,t+6),_(this,t+2,t+5),_(this,t+3,t+4);return this},o.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?E(this,0,e):p.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){let t="";const s=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,s).replace(/(.{2})/g,"$1 ").trim(),this.length>s&&(t+=" ... "),"<Buffer "+t+">"},i&&(o.prototype[i]=o.prototype.inspect),o.prototype.compare=function(e,t,s,i,r){if(z(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===s&&(s=e?e.length:0),void 0===i&&(i=0),void 0===r&&(r=this.length),t<0||s>e.length||i<0||r>this.length)throw new RangeError("out of range index");if(i>=r&&t>=s)return 0;if(i>=r)return-1;if(t>=s)return 1;if(this===e)return 0;let n=(r>>>=0)-(i>>>=0),a=(s>>>=0)-(t>>>=0);const h=Math.min(n,a),c=this.slice(i,r),l=e.slice(t,s);for(let e=0;e<h;++e)if(c[e]!==l[e]){n=c[e],a=l[e];break}return n<a?-1:a<n?1:0},o.prototype.includes=function(e,t,s){return-1!==this.indexOf(e,t,s)},o.prototype.indexOf=function(e,t,s){return g(this,e,t,s,!0)},o.prototype.lastIndexOf=function(e,t,s){return g(this,e,t,s,!1)},o.prototype.write=function(e,t,s,i){if(void 0===t)i="utf8",s=this.length,t=0;else if(void 0===s&&"string"==typeof t)i=t,s=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(s)?(s>>>=0,void 0===i&&(i="utf8")):(i=s,s=void 0)}const r=this.length-t;if((void 0===s||s>r)&&(s=r),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");let n=!1;for(;;)switch(i){case"hex":return f(this,e,t,s);case"utf8":case"utf-8":return v(this,e,t,s);case"ascii":case"latin1":case"binary":return w(this,e,t,s);case"base64":return b(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,e,t,s);default:if(n)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),n=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const k=4096;function R(e,t,s){let i="";s=Math.min(e.length,s);for(let r=t;r<s;++r)i+=String.fromCharCode(127&e[r]);return i}function C(e,t,s){let i="";s=Math.min(e.length,s);for(let r=t;r<s;++r)i+=String.fromCharCode(e[r]);return i}function A(e,t,s){const i=e.length;(!t||t<0)&&(t=0),(!s||s<0||s>i)&&(s=i);let r="";for(let i=t;i<s;++i)r+=Q[e[i]];return r}function M(e,t,s){const i=e.slice(t,s);let r="";for(let e=0;e<i.length-1;e+=2)r+=String.fromCharCode(i[e]+256*i[e+1]);return r}function T(e,t,s){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>s)throw new RangeError("Trying to access beyond buffer length")}function x(e,t,s,i,r,n){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<n)throw new RangeError('"value" argument is out of bounds');if(s+i>e.length)throw new RangeError("Index out of range")}function N(e,t,s,i,r){V(t,i,r,e,s,7);let n=Number(t&BigInt(4294967295));e[s++]=n,n>>=8,e[s++]=n,n>>=8,e[s++]=n,n>>=8,e[s++]=n;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[s++]=o,o>>=8,e[s++]=o,o>>=8,e[s++]=o,o>>=8,e[s++]=o,s}function U(e,t,s,i,r){V(t,i,r,e,s,7);let n=Number(t&BigInt(4294967295));e[s+7]=n,n>>=8,e[s+6]=n,n>>=8,e[s+5]=n,n>>=8,e[s+4]=n;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[s+3]=o,o>>=8,e[s+2]=o,o>>=8,e[s+1]=o,o>>=8,e[s]=o,s+8}function L(e,t,s,i,r,n){if(s+i>e.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("Index out of range")}function O(e,t,i,r,n){return t=+t,i>>>=0,n||L(e,0,i,4),s.write(e,t,i,r,23,4),i+4}function D(e,t,i,r,n){return t=+t,i>>>=0,n||L(e,0,i,8),s.write(e,t,i,r,52,8),i+8}o.prototype.slice=function(e,t){const s=this.length;(e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e);const i=this.subarray(e,t);return Object.setPrototypeOf(i,o.prototype),i},o.prototype.readUintLE=o.prototype.readUIntLE=function(e,t,s){e>>>=0,t>>>=0,s||T(e,t,this.length);let i=this[e],r=1,n=0;for(;++n<t&&(r*=256);)i+=this[e+n]*r;return i},o.prototype.readUintBE=o.prototype.readUIntBE=function(e,t,s){e>>>=0,t>>>=0,s||T(e,t,this.length);let i=this[e+--t],r=1;for(;t>0&&(r*=256);)i+=this[e+--t]*r;return i},o.prototype.readUint8=o.prototype.readUInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),this[e]},o.prototype.readUint16LE=o.prototype.readUInt16LE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUint16BE=o.prototype.readUInt16BE=function(e,t){return e>>>=0,t||T(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUint32LE=o.prototype.readUInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUint32BE=o.prototype.readUInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readBigUInt64LE=J((function(e){F(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||$(e,this.length-8);const i=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,r=this[++e]+256*this[++e]+65536*this[++e]+s*2**24;return BigInt(i)+(BigInt(r)<<BigInt(32))})),o.prototype.readBigUInt64BE=J((function(e){F(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||$(e,this.length-8);const i=t*2**24+65536*this[++e]+256*this[++e]+this[++e],r=this[++e]*2**24+65536*this[++e]+256*this[++e]+s;return(BigInt(i)<<BigInt(32))+BigInt(r)})),o.prototype.readIntLE=function(e,t,s){e>>>=0,t>>>=0,s||T(e,t,this.length);let i=this[e],r=1,n=0;for(;++n<t&&(r*=256);)i+=this[e+n]*r;return r*=128,i>=r&&(i-=Math.pow(2,8*t)),i},o.prototype.readIntBE=function(e,t,s){e>>>=0,t>>>=0,s||T(e,t,this.length);let i=t,r=1,n=this[e+--i];for(;i>0&&(r*=256);)n+=this[e+--i]*r;return r*=128,n>=r&&(n-=Math.pow(2,8*t)),n},o.prototype.readInt8=function(e,t){return e>>>=0,t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){e>>>=0,t||T(e,2,this.length);const s=this[e]|this[e+1]<<8;return 32768&s?4294901760|s:s},o.prototype.readInt16BE=function(e,t){e>>>=0,t||T(e,2,this.length);const s=this[e+1]|this[e]<<8;return 32768&s?4294901760|s:s},o.prototype.readInt32LE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e>>>=0,t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readBigInt64LE=J((function(e){F(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||$(e,this.length-8);const i=this[e+4]+256*this[e+5]+65536*this[e+6]+(s<<24);return(BigInt(i)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),o.prototype.readBigInt64BE=J((function(e){F(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||$(e,this.length-8);const i=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(i)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+s)})),o.prototype.readFloatLE=function(e,t){return e>>>=0,t||T(e,4,this.length),s.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e>>>=0,t||T(e,4,this.length),s.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e>>>=0,t||T(e,8,this.length),s.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e>>>=0,t||T(e,8,this.length),s.read(this,e,!1,52,8)},o.prototype.writeUintLE=o.prototype.writeUIntLE=function(e,t,s,i){if(e=+e,t>>>=0,s>>>=0,!i){x(this,e,t,s,Math.pow(2,8*s)-1,0)}let r=1,n=0;for(this[t]=255&e;++n<s&&(r*=256);)this[t+n]=e/r&255;return t+s},o.prototype.writeUintBE=o.prototype.writeUIntBE=function(e,t,s,i){if(e=+e,t>>>=0,s>>>=0,!i){x(this,e,t,s,Math.pow(2,8*s)-1,0)}let r=s-1,n=1;for(this[t+r]=255&e;--r>=0&&(n*=256);)this[t+r]=e/n&255;return t+s},o.prototype.writeUint8=o.prototype.writeUInt8=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,1,255,0),this[t]=255&e,t+1},o.prototype.writeUint16LE=o.prototype.writeUInt16LE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeUint16BE=o.prototype.writeUInt16BE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeUint32LE=o.prototype.writeUInt32LE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},o.prototype.writeUint32BE=o.prototype.writeUInt32BE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeBigUInt64LE=J((function(e,t=0){return N(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),o.prototype.writeBigUInt64BE=J((function(e,t=0){return U(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),o.prototype.writeIntLE=function(e,t,s,i){if(e=+e,t>>>=0,!i){const i=Math.pow(2,8*s-1);x(this,e,t,s,i-1,-i)}let r=0,n=1,o=0;for(this[t]=255&e;++r<s&&(n*=256);)e<0&&0===o&&0!==this[t+r-1]&&(o=1),this[t+r]=(e/n>>0)-o&255;return t+s},o.prototype.writeIntBE=function(e,t,s,i){if(e=+e,t>>>=0,!i){const i=Math.pow(2,8*s-1);x(this,e,t,s,i-1,-i)}let r=s-1,n=1,o=0;for(this[t+r]=255&e;--r>=0&&(n*=256);)e<0&&0===o&&0!==this[t+r+1]&&(o=1),this[t+r]=(e/n>>0)-o&255;return t+s},o.prototype.writeInt8=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeInt32LE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,s){return e=+e,t>>>=0,s||x(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeBigInt64LE=J((function(e,t=0){return N(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),o.prototype.writeBigInt64BE=J((function(e,t=0){return U(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),o.prototype.writeFloatLE=function(e,t,s){return O(this,e,t,!0,s)},o.prototype.writeFloatBE=function(e,t,s){return O(this,e,t,!1,s)},o.prototype.writeDoubleLE=function(e,t,s){return D(this,e,t,!0,s)},o.prototype.writeDoubleBE=function(e,t,s){return D(this,e,t,!1,s)},o.prototype.copy=function(e,t,s,i){if(!o.isBuffer(e))throw new TypeError("argument should be a Buffer");if(s||(s=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<s&&(i=s),i===s)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-s&&(i=e.length-t+s);const r=i-s;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,s,i):Uint8Array.prototype.set.call(e,this.subarray(s,i),t),r},o.prototype.fill=function(e,t,s,i){if("string"==typeof e){if("string"==typeof t?(i=t,t=0,s=this.length):"string"==typeof s&&(i=s,s=this.length),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!o.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(1===e.length){const t=e.charCodeAt(0);("utf8"===i&&t<128||"latin1"===i)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<s)throw new RangeError("Out of range index");if(s<=t)return this;let r;if(t>>>=0,s=void 0===s?this.length:s>>>0,e||(e=0),"number"==typeof e)for(r=t;r<s;++r)this[r]=e;else{const n=o.isBuffer(e)?e:o.from(e,i),a=n.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(r=0;r<s-t;++r)this[r+t]=n[r%a]}return this};const B={};function P(e,t,s){B[e]=class extends s{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function K(e){let t="",s=e.length;const i="-"===e[0]?1:0;for(;s>=i+4;s-=3)t=`_${e.slice(s-3,s)}${t}`;return`${e.slice(0,s)}${t}`}function V(e,t,s,i,r,n){if(e>s||e<t){const i="bigint"==typeof t?"n":"";let r;throw r=n>3?0===t||t===BigInt(0)?`>= 0${i} and < 2${i} ** ${8*(n+1)}${i}`:`>= -(2${i} ** ${8*(n+1)-1}${i}) and < 2 ** ${8*(n+1)-1}${i}`:`>= ${t}${i} and <= ${s}${i}`,new B.ERR_OUT_OF_RANGE("value",r,e)}!function(e,t,s){F(t,"offset"),void 0!==e[t]&&void 0!==e[t+s]||$(t,e.length-(s+1))}(i,r,n)}function F(e,t){if("number"!=typeof e)throw new B.ERR_INVALID_ARG_TYPE(t,"number",e)}function $(e,t,s){if(Math.floor(e)!==e)throw F(e,s),new B.ERR_OUT_OF_RANGE(s||"offset","an integer",e);if(t<0)throw new B.ERR_BUFFER_OUT_OF_BOUNDS;throw new B.ERR_OUT_OF_RANGE(s||"offset",`>= ${s?1:0} and <= ${t}`,e)}P("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),P("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),P("ERR_OUT_OF_RANGE",(function(e,t,s){let i=`The value of "${e}" is out of range.`,r=s;return Number.isInteger(s)&&Math.abs(s)>2**32?r=K(String(s)):"bigint"==typeof s&&(r=String(s),(s>BigInt(2)**BigInt(32)||s<-(BigInt(2)**BigInt(32)))&&(r=K(r)),r+="n"),i+=` It must be ${t}. Received ${r}`,i}),RangeError);const j=/[^+/0-9A-Za-z-_]/g;function q(e,t){let s;t=t||1/0;const i=e.length;let r=null;const n=[];for(let o=0;o<i;++o){if(s=e.charCodeAt(o),s>55295&&s<57344){if(!r){if(s>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(o+1===i){(t-=3)>-1&&n.push(239,191,189);continue}r=s;continue}if(s<56320){(t-=3)>-1&&n.push(239,191,189),r=s;continue}s=65536+(r-55296<<10|s-56320)}else r&&(t-=3)>-1&&n.push(239,191,189);if(r=null,s<128){if((t-=1)<0)break;n.push(s)}else if(s<2048){if((t-=2)<0)break;n.push(s>>6|192,63&s|128)}else if(s<65536){if((t-=3)<0)break;n.push(s>>12|224,s>>6&63|128,63&s|128)}else{if(!(s<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}}return n}function W(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(j,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function H(e,t,s,i){let r;for(r=0;r<i&&!(r+s>=t.length||r>=e.length);++r)t[r+s]=e[r];return r}function z(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function G(e){return e!=e}const Q=function(){const e="0123456789abcdef",t=new Array(256);for(let s=0;s<16;++s){const i=16*s;for(let r=0;r<16;++r)t[i+r]=e[s]+e[r]}return t}();function J(e){return"undefined"==typeof BigInt?Y:e}function Y(){throw new Error("BigInt not supported")}})(Nr),/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
function(e,t){var s=Nr,i=s.Buffer;function r(e,t){for(var s in e)t[s]=e[s]}function n(e,t,s){return i(e,t,s)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=s:(r(s,t),t.Buffer=n),n.prototype=Object.create(i.prototype),r(i,n),n.from=function(e,t,s){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,s)},n.alloc=function(e,t,s){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"==typeof s?r.fill(t,s):r.fill(t):r.fill(0),r},n.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},n.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return s.SlowBuffer(e)}}(xr,xr.exports);var jr=xr.exports.Buffer;var qr=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var i=0;i<e.length;i++){var r=e.charAt(i),n=r.charCodeAt(0);if(255!==t[n])throw new TypeError(r+" is ambiguous");t[n]=i}var o=e.length,a=e.charAt(0),h=Math.log(o)/Math.log(256),c=Math.log(256)/Math.log(o);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return jr.alloc(0);for(var s=0,i=0,r=0;e[s]===a;)i++,s++;for(var n=(e.length-s)*h+1>>>0,c=new Uint8Array(n);e[s];){var l=t[e.charCodeAt(s)];if(255===l)return;for(var d=0,u=n-1;(0!==l||d<r)&&-1!==u;u--,d++)l+=o*c[u]>>>0,c[u]=l%256>>>0,l=l/256>>>0;if(0!==l)throw new Error("Non-zero carry");r=d,s++}for(var m=n-r;m!==n&&0===c[m];)m++;var p=jr.allocUnsafe(i+(n-m));p.fill(0,0,i);for(var _=i;m!==n;)p[_++]=c[m++];return p}return{encode:function(t){if((Array.isArray(t)||t instanceof Uint8Array)&&(t=jr.from(t)),!jr.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var s=0,i=0,r=0,n=t.length;r!==n&&0===t[r];)r++,s++;for(var h=(n-r)*c+1>>>0,l=new Uint8Array(h);r!==n;){for(var d=t[r],u=0,m=h-1;(0!==d||u<i)&&-1!==m;m--,u++)d+=256*l[m]>>>0,l[m]=d%o>>>0,d=d/o>>>0;if(0!==d)throw new Error("Non-zero carry");i=u,r++}for(var p=h-i;p!==h&&0===l[p];)p++;for(var _=a.repeat(s);p<h;++p)_+=e.charAt(l[p]);return _},decodeUnsafe:l,decode:function(e){var t=l(e);if(t)return t;throw new Error("Non-base"+o+" character")}}},Wr=qr("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");class Hr{encode(e){return Wr.encode(e)}decode(e){return Wr.decode(e)}}class zr{constructor(){this.utf8=new Ar,this.base64=new Tr,this.base58=new Hr}}class Gr{constructor(e){this._workerPool=e}megolmDecrypt(e,t){const s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(32*t))]);const i=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",i)}async createOutboundOlmSession(e,t,s,i){const r=e.pickle("");let n;window.msCrypto&&(n=[window.msCrypto.getRandomValues(new Uint8Array(64))]);const o=await this._workerPool.send({type:"olm_create_outbound",accountPickle:r,theirIdentityKey:s,theirOneTimeKey:i,randomValues:n}).response();t.unpickle("",o)}dispose(){this._workerPool.dispose()}}class Qr{constructor(e,t,s,i){this._logger=s,this.start=s._now(),this._values="string"==typeof e?{l:e}:e,this.logLevel=t,this._filterCreator=i}runDetached(e,t,s,i){return this._logger.runDetached(e,t,s,i)}wrapDetached(e,t,s,i){this.refDetached(this.runDetached(e,t,s,i))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,i){return this.child(e,s,i).run(t)}get duration(){return this.end?this.end-this.start:void 0}durationWithoutType(e){const t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce(((t,s)=>t+(s.durationOfType(e)??0)),0):0}log(e,t){const s=this.child(e,t);return s.end=s.start,s}set(e,t){if("object"==typeof e){const t=e;Object.assign(this._values,t)}else this._values[e]=t}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new et(e),this)}catch(e){console.error("Error creating log filter",e)}let i=null;if(this._children&&(i=this._children.reduce(((t,s)=>{const i=s.serialize(e,this.start,!1);return i&&(null===t&&(t=[]),t.push(i)),t}),null)),e&&!e.filter(this,i))return;const r={s:"number"==typeof t?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(r.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split("\n")[0]}),s&&(r.f=!0),i&&(r.c=i),r}run(e){void 0!==this.end&&console.trace("log item is finished, additional logs will likely not be recorded");try{const t=e(this);return t instanceof Promise?t.then((e=>(this.finish(),e)),(e=>{throw this.catch(e)})):(this.finish(),t)}catch(e){throw this.catch(e)}}finish(){if(void 0===this.end){if(this._children)for(const e of this._children)e.finish();this.end=this._logger._now()}}get level(){return Ze}catch(e){return this.error=e,this.logLevel=Ze.Error,this.finish(),e}child(e,t,s){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||Ze.Info);const i=new Qr(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(i),i}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}}class Jr{constructor({platform:e,serializedTransformer:t=(e=>e)}){this._openItems=new Set,this._platform=e,this._serializedTransformer=t}log(e,t=Ze.Info){const s=new Qr(e,t,this);s.end=s.start,this._persistItem(s,void 0,!1)}wrapOrRun(e,t,s,i,r){return e?e.wrap(t,s,i,r):this.run(t,s,i,r)}runDetached(e,t,s,i){s||(s=Ze.Info);const r=new Qr(e,s,this);return this._run(r,t,s,!1,i),r}run(e,t,s,i){void 0===s&&(s=Ze.Info);const r=new Qr(e,s,this);return this._run(r,t,s,!0,i)}_run(e,t,s,i,r){this._openItems.add(e);const n=()=>{let t=new et;if(r)try{t=r(t,e)}catch(e){console.error("Error while creating log filter",e)}else t=t.minLevel(s);try{this._persistItem(e,t,!1)}catch(e){console.error("Could not persist log item",e)}this._openItems.delete(e)};try{let s=e.run(t);if(s instanceof Promise){if(s=s.then((e=>(n(),e)),(e=>{if(n(),i)throw e})),i)return s}else if(n(),i)return s}catch(e){if(n(),i)throw e}}_finishOpenItems(){for(const e of this._openItems){e.finish();try{this._persistItem(e,new et,!0)}catch(e){console.error("Could not serialize log item",e)}}this._openItems.clear()}get level(){return Ze}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}}class Yr extends Jr{constructor(e){super(e);const{name:t,flushInterval:s=6e4,limit:i=3e3}=e;this._name=t,this._limit=i,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval((()=>this._tryFlush()),s)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){"pagehide"===e.type&&this._finishAllAndFlush()}async _tryFlush(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),i=this._queuedItems.length;for(const e of this._queuedItems)s.add(e);const r=await Ve(s.count());if(r>this._limit){let e=r-this._limit+Math.round(.1*this._limit);await $e(s.openCursor(),((t,s,i)=>(i.delete(),e-=1,{done:0===e})))}await Fe(t),this._queuedItems.splice(0,i)}catch(e){console.error("Could not flush logs",e)}finally{try{e.close()}catch(e){}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){const e=`${this._name}_queuedItems`;try{const t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(e){console.error("Could not load queued log items",e)}return[]}_openDB(){return Ke(this._name,(e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0})),1)}_persistItem(e,t,s){const i=e.serialize(t,void 0,s);if(i){const e=this._serializedTransformer(i);this._queuedItems.push({json:JSON.stringify(e)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(e){console.error("Could not persist queued log items in localStorage, they will likely be lost",e)}}async export(){const e=await this._openDB();try{const t=e.transaction(["logs"],"readonly").objectStore("logs"),s=(await async function(e,t){const s=[];return await $e(e,(e=>(s.push(e),{done:t(s)}))),s}(t.openCursor(),(()=>!1))).concat(this._queuedItems);return new Xr(s,this,this._platform)}finally{try{e.close()}catch(e){}}}async _removeItems(e){const t=await this._openDB();try{const s=t.transaction(["logs"],"readwrite"),i=s.objectStore("logs");for(const t of e)if("number"==typeof t.id)i.delete(t.id);else{const e=this._queuedItems.indexOf(t);-1===e&&this._queuedItems.splice(e,1)}await Fe(s)}finally{try{t.close()}catch(e){}}}}class Xr{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){const e={formatVersion:1,appVersion:this._platform.updateService?.version,items:this._items.map((e=>JSON.parse(e.json)))},t=JSON.stringify(e),s=this._platform.encoding.utf8.encode(t);return this._platform.createBlob(s,"application/json")}}class Zr extends Jr{_persistItem(e){tn(e)}async export(){}}const en=["l","id"];function tn(e){const t=`${function(e){return"network"===e.values.t?`${e.values.method} ${e.values.url}`:e.values.l&&void 0!==e.values.id?`${e.values.l} ${e.values.id}`:e.values.l&&void 0!==e.values.status?`${e.values.l} (${e.values.status})`:e.values.l&&e.error?`${e.values.l} failed`:void 0!==e.values.ref?`ref ${e.values.ref}`:e.values.l||e.values.type}(e)} (${e.duration}ms)`,s=(i=e.values,Object.entries(i).filter((([e])=>!en.includes(e))).reduce(((e,[t,s])=>((e=e||{})[t]=s,e)),null));var i;const r=e.children||s;if(r?(e.error?console.group(t):console.groupCollapsed(t),e.error&&console.error(e.error)):e.error?console.error(e.error):console.log(t),s&&console.table(s),e.children)for(const t of e.children)tn(t);r&&console.groupEnd()}function sn(e){return"object"!=typeof e||"nodeType"in e||Array.isArray(e)}function rn(e,t){return Object.entries(e).reduce(((e,[s,i])=>("function"==typeof i&&(i=i(t)),i?e+(e.length?" ":"")+s:e)),"")}function nn(e,t,s){"className"===t&&(t="class"),!1===s?e.removeAttribute(t):(!0===s&&(s=t),e.setAttribute(t,s))}function on(e,t,s,i){s&&sn(s)&&(i=s,s=void 0);const r=document.createElementNS(e,t);if(s)for(let[e,t]of Object.entries(s))"object"==typeof t&&(t=null!==t&&"className"===e&&rn(t,void 0)),nn(r,e,t);if(i){Array.isArray(i)||(i=[i]);for(let e of i)"string"==typeof e&&(e=an(e)),r.appendChild(e)}return r}function an(e){return document.createTextNode(e)}const hn="http://www.w3.org/1999/xhtml",cn={[hn]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","label","form","progress","output","video"],"http://www.w3.org/2000/svg":["svg","circle"]},ln={};for(const[e,t]of Object.entries(cn))for(const s of t)ln[s]=function(t,i){return on(e,s,t,i)};function dn(e,t){let s;try{s=e.mount(t)}catch(e){s=function(e){const t=(new Error).stack;let s=null;t&&(s=t.split("\n")[1]);return ln.div([ln.h2("Something went wrong…"),ln.h3(e.message),ln.p(`This occurred while running ${s}.`),ln.pre(e.stack)])}(e)}return s}function un(e,t,s){if(t===e.childElementCount)e.appendChild(s);else{const i=e.children[t];e.insertBefore(s,i)}}class mn{constructor({list:e,onItemClick:t,className:s,tagName:i="ul",parentProvidesUpdates:r=!0},n){this._onItemClick=t,this._list=e,this._className=s,this._tagName=i,this._root=void 0,this._subscription=void 0,this._childCreator=n,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:r}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){const e={};this._className&&(e.className=this._className);const t=this._root=(s=this._tagName,on(hn,s,e,i));var s,i;return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){"click"===e.type&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;const s=Array.prototype.indexOf.call(this._root.childNodes,t),i=this._childInstances[s];i&&this._onItemClick(i,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];const e=document.createDocumentFragment();for(let t of this._list){const s=this._childCreator(t);this._childInstances.push(s),e.appendChild(dn(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(const e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){const s=this._childCreator(t);this._childInstances.splice(e,0,s),un(this._root,e,dn(s,this._mountArgs))}removeChild(e){const[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){const[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),un(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){const i=this._childInstances[e];i&&i.update(t,s)}}recreateItem(e,t){if(this._childInstances){const s=this._childCreator(t);if(s){const[t]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),t.root()),t.unmount()}else this.onRemove(e,t)}}getChildInstanceByIndex(e){return this._childInstances?.[e]}}class pn{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){"function"==typeof this._value?.on&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&("function"==typeof this._value.off&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}}function _n(e){for(const t of Object.values(e))if("function"==typeof t)return!0;return!1}class gn extends pn{constructor(e,t){super(e),this._eventListeners=void 0,this._bindings=void 0,this._root=void 0,this._subViews=void 0,this._render=t}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.addEventListener(t,s,i)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:i}of this._eventListeners)e.removeEventListener(t,s,i)}mount(e){const t=new yn(this);try{if(this._render)this._root=this._render(t,this._value);else{if(!this.render)throw new Error("no render function passed in, or overriden in subclass");this._root=this.render(t,this._value)}}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(const e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(const e of this._bindings)e()}_addEventListener(e,t,s,i=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:i})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;const t=this._subViews.indexOf(e);-1!==t&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(const s of this._subViews)s.update(e,t)}}class yn{constructor(e){this._closed=!1,this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,i=!1){this._templateView._addEventListener(e,t,s,i)}_addAttributeBinding(e,t,s){let i;const r=()=>{const r=s(this._value);i!==r&&(i=r,nn(e,t,r))};this._addBinding(r),r()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",(e=>rn(t,e)))}_addTextBinding(e){const t=e(this._value),s=an(t);let i=t;return this._addBinding((()=>{const t=e(this._value);i!==t&&(i=t,s.textContent=t+"")})),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&"function"==typeof t}_setNodeAttributes(e,t){for(let[s,i]of Object.entries(t))if("object"==typeof i){if("className"!==s||null===i)continue;_n(i)?this._addClassNamesBinding(e,i):nn(e,s,rn(i,this._value))}else if(this._isEventHandler(s,i)){const t=s.substr(2,1).toLowerCase()+s.substr(3),r=i;this._templateView._addEventListener(e,t,r)}else"function"==typeof i?this._addAttributeBinding(e,s,i):nn(e,s,i)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)"function"==typeof s?s=this._addTextBinding(s):"string"==typeof s&&(s=an(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),i=t(null);return this._addBinding((()=>{const r=e(this._value);if(s!==r){s=r;const e=t(i);i.parentNode&&i.parentNode.replaceChild(e,i),i=e}})),i}el(e,t,s){return this.elNS(hn,e,t,s)}elNS(e,t,s,i){void 0!==s&&sn(s)&&(i=s,s=void 0);const r=document.createElementNS(e,t);return s&&this._setNodeAttributes(r,s),i&&this._setNodeChildren(r,i),r}view(e,t){return this._templateView.addSubView(e),dn(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,(s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){const e=this._templateView._subViews;if(e){const t=e.findIndex((e=>e.root()===s));if(-1!==t){const[s]=e.splice(t,1);s.unmount()}}}const i=t(e(this._value));return i?this.view(i):document.createComment("node binding placeholder")}))}map(e,t){return this.mapView(e,(e=>new gn(this._value,((s,i)=>{const r=t(e,s,i);return r||document.createComment("map placeholder")}))))}ifView(e,t){return this.mapView((t=>!!e(t)),(e=>e?t(this._value):null))}if(e,t){return this.ifView(e,(e=>new gn(e,t)))}mapSideEffect(e,t){let s=e(this._value);this._addBinding((()=>{const i=e(this._value);s!==i&&(t(i,s),s=i)})),t(s,void 0)}}for(const[e,t]of Object.entries(cn))for(const s of t)yn.prototype[s]=function(t,i){return this.elNS(e,s,t,i)};function fn(e,t,s){const i=!!e.avatarUrl(t);let r=rn({avatar:!0,[`size-${t}`]:!0,[`usercolor${e.avatarColorNumber}`]:!i});s&&(r+=` ${s}`);const n=i?vn(e,t):an(e.avatarLetter),o=ln.div({className:r},[n]);return i&&(nn(o,"data-avatar-letter",e.avatarLetter),nn(o,"data-avatar-color",e.avatarColorNumber)),o}function vn(e,t){const s=t.toString();return ln.img({src:e.avatarUrl(t),width:s,height:s,title:e.avatarTitle})}function wn(e){if(!function(e){const t=e.target,s=t.parentElement;return"IMG"===t.tagName&&s.classList.contains("avatar")}(e))return;const t=e.target.parentElement,s=t.getAttribute("data-avatar-color");t.classList.add(`usercolor${s}`);const i=t.getAttribute("data-avatar-letter");t.textContent=i}class bn extends pn{constructor(e,t){super(e),this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl&&(this._avatarUrl=this.value.avatarUrl(this._size),!0)}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle&&(this._avatarTitle=this.value.avatarTitle,!0)}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter&&(this._avatarLetter=this.value.avatarLetter,!0)}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=fn(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){const t=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(vn(e,this._size),this._root.firstChild),this._root.classList.remove(t)):(this._root.textContent=e.avatarLetter,this._root.classList.add(t))}const t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){const t=this._root.firstChild;"IMG"===t.tagName&&t.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}}class Sn extends gn{render(e,t){return e.li({className:{active:e=>e.isOpen,hidden:e=>e.hidden}},[e.a({href:t.url},[e.view(new bn(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:e=>e.isUnread}},(e=>e.name)),e.div({className:{badge:!0,highlighted:e=>e.isHighlighted,hidden:e=>!e.badgeCount}},(e=>e.badgeCount))])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}}let In;function En(e,t){return void 0===In&&(In=document.querySelector(".hydrogen")),In?.classList.contains("legacy")?e.div({className:"spinner"},[e.div(),e.div(),e.div(),e.div()]):e.svg({className:Object.assign({spinner:!0},t),viewBox:"0 0 100 100"},e.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}class kn extends gn{render(e,t){return e.li({className:{active:e=>e.isOpen,hidden:e=>e.hidden}},[e.a({href:t.url},[fn(t,32),e.div({className:"description"},[e.div({className:"name"},t.name),e.map((e=>e.busy),(t=>t?En(e):e.div({className:"badge highlighted"},"!")))])])])}}class Rn extends gn{render(e,t){const s=()=>{i.value="",i.blur(),r.blur(),t.clear()},i=e.input({type:"text",placeholder:t?.label,"aria-label":t?.label,autocomplete:t?.autocomplete,enterkeyhint:"search",name:t?.name,onInput:e=>t.set(e.target.value),onKeydown:e=>{"Escape"!==e.key&&"Esc"!==e.key||s()},onFocus:()=>i.select()}),r=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[i,r])}}class Cn extends gn{render(e,t){const s=e=>e.gridEnabled?e.i18n`Show single room`:e.i18n`Enable grid layout`,i=e.view(new mn({className:"RoomList",list:t.tileViewModels},(e=>"invite"===e.kind?new kn(e):new Sn(e)))),r=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new Rn({i18n:t.i18n,label:t.i18n`Filter rooms…`,name:"room-filter",autocomplete:!0,set:e=>{t.setFilter(e)&&(i.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:e=>e.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`})]);return e.div({className:"LeftPanel"},[r,i])}}class An{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){const e=this._target.closest(".hydrogen");let t=e.querySelector(".popupContainer");return t||(t=ln.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=function(e){let t=e;do{if(t=t.parentElement,t.scrollHeight>t.clientHeight){const e=window.getComputedStyle(t).getPropertyValue("overflow-y");if("auto"===e||"scroll"===e)return t}}while(t!==document.body)}(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout((()=>{document.body.addEventListener("click",this,!1)}),10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){"scroll"===e.type?this._position()||this.close():"click"===e.type&&this._onClick(e)}_onClick(){this.close()}_position(){const e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,i=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>i.bottom||e.left>i.right||e.bottom<i.top||e.right<i.left)return!1;if(i.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else{if(!(i.top<=e.top-s))return!1;this._popup.style.top=e.top-s-this._verticalPadding+"px"}if(i.right>=e.right+t)this._popup.style.left=`${e.left}px`;else{if(!(i.left<=e.left-t))return!1;this._popup.style.left=e.right-t+"px"}return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}}class Mn extends gn{static option(e,t){return new Tn(e,t)}constructor(e){super(),this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map((t=>t.toDOM(e))))}}class Tn{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){const t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}}class xn extends gn{render(e){return e.li({className:{GapView:!0,isLoading:e=>e.isLoading,isAtTop:e=>e.isAtTop}},[En(e),e.div((e=>e.isLoading?e.i18n`Loading more messages …`:e.i18n`Not loading!`)),e.if((e=>e.error),(e=>e.strong((e=>e.error))))])}onClick(){}}class Nn extends mn{constructor(e){super({className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:e=>e.onClick()},(e=>new Un(e)))}}class Un extends gn{render(e,t){return e.button({className:{active:e=>e.isActive,pending:e=>e.isPending}},[t.key," ",e=>`${e.count}`])}onClick(){this.value.toggle()}}class Ln extends gn{constructor(e,t=!0,s="li"){super(e),this._menuPopup=null,this._tagName=s,this._interactive=t}render(e,t){const s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"⋯"));const i=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:e=>e.isContinuation}},s);e.mapSideEffect((e=>e.isContinuation),((e,s)=>{if(e&&!1===s)i.removeChild(i.querySelector(".Timeline_messageAvatar")),i.removeChild(i.querySelector(".Timeline_messageSender"));else if(!e){const e=ln.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[fn(t,30)]),s=ln.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);i.insertBefore(e,i.firstChild),i.insertBefore(s,i.firstChild)}}));let r=null;return e.mapSideEffect((e=>e.reactions),(e=>{e&&this._interactive&&!r?(r=new Nn(e),this.addSubView(r),i.appendChild(dn(r))):!e&&r&&(i.removeChild(r.root()),r.unmount(),this.removeSubView(r),r=null)})),i}onClick(e){"Timeline_messageOptions"===e.target.className&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{const t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");const s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new An(new Mn(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){const t=[];return e.canReact&&"redacted"!==e.shape&&(t.push(new On(e)),t.push(Mn.option(e.i18n`Reply`,(()=>e.startReply())))),e.canAbortSending?t.push(Mn.option(e.i18n`Cancel`,(()=>e.abortSending()))):e.canRedact&&t.push(Mn.option(e.i18n`Delete`,(()=>e.redact())).setDestructive()),t}renderMessageBody(){}}class On{constructor(e){this._vm=e}toDOM(e){const t=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map((t=>e.button({onClick:()=>this._vm.react(t)},t))),s=e.button({onClick:()=>{const e=prompt("Enter your reaction (emoji)");e&&this._vm.react(e)}},"…");return e.li({className:"quick-reactions"},[...t,s])}}class Dn extends Ln{renderMessageBody(e,t){const s=e.time({className:{hidden:!t.date}},t.date+" "+t.time),i=e.div({className:{Timeline_messageBody:!0,statusMessage:e=>"message-status"===e.shape}});return e.mapSideEffect((e=>e.body),(e=>{for(;i.lastChild;)i.removeChild(i.lastChild);for(const t of e.parts)i.appendChild(Pn(t));i.appendChild(s)})),i}}const Bn={header:e=>ln["h"+Math.min(6,e.level)](Kn(e.inlines)),codeblock:e=>ln.pre(ln.code(an(e.text))),table:e=>function(e){const t=[];if(e.head){const s=e.head.map((e=>ln.th(Kn(e))));t.push(ln.thead(ln.tr(s)))}const s=[];for(const t of e.body){const e=t.map((e=>ln.td(Kn(e))));s.push(ln.tr(e))}return t.push(ln.tbody(s)),ln.table(t)}(e),code:e=>ln.code(an(e.text)),text:e=>an(e.text),link:e=>ln.a({href:e.url,className:"link",target:"_blank",rel:"noopener"},Kn(e.inlines)),pill:function(e){const t=`avatar size-12 usercolor${e.avatarColorNumber}`,s=ln.div({class:t},an(e.avatarInitials)),i=Kn(e.children);return i.unshift(s),ln.a({class:"pill",href:e.href,rel:"noopener",target:"_blank"},i)},format:e=>ln[e.format](Kn(e.children)),rule:()=>ln.hr(),list:function(e){const t=e.items.map((e=>ln.li(Kn(e)))),s=e.startOffset;return s?ln.ol({start:s},t):ln.ul(t)},image:function(e){const t={src:e.src};return e.width&&(t.width=e.width),e.height&&(t.height=e.height),e.alt&&(t.alt=e.alt),e.title&&(t.title=e.title),ln.img(t)},newline:()=>ln.br()};function Pn(e){const t=Bn[e.type];return t?t(e):an(`[unknown part type ${e.type}]`)}function Kn(e){return Array.from(e,Pn)}class Vn extends Ln{renderMessageBody(e,t){let s=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(s=`height: ${t.height}px`);const i=[e.div({className:"spacer",style:s}),this.renderMedia(e,t),e.time(t.date+" "+t.time)];if(t.isPending){const t=e.div({className:{sendStatus:!0,hidden:e=>!e.sendStatus}},(e=>e.sendStatus)),s=e.progress({min:0,max:100,value:e=>e.uploadPercentage,className:{hidden:e=>!e.isUploading}});i.push(t,s)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`},i),e.if((e=>e.error),(e=>e.p({className:"error"},t.error)))])}}class Fn extends Vn{renderMedia(e,t){const s=e.img({loading:"lazy",src:e=>e.thumbnailUrl,alt:e=>e.label,title:e=>e.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending?s:e.a({href:t.lightboxUrl},s)}}function $n(e,t){return new Promise(((s,i)=>{let r;const n=e=>{r(),i(e.target.error)},o=()=>{r(),s()};r=()=>{e.removeEventListener(t,o),e.removeEventListener("error",n)},e.addEventListener(t,o),e.addEventListener("error",n)}))}class jn extends Vn{renderMedia(e){const t=e.video({src:e=>e.videoUrl||`data:${e.mimeType},`,title:e=>e.label,controls:!0,preload:"none",poster:e=>e.thumbnailUrl,onPlay:this._onPlay.bind(this),style:e=>`max-width: ${e.width}px; max-height: ${e.height}px;${e.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){const t=this.value;if(!t.videoUrl)try{const s=e.target;await t.loadVideo();const i=$n(s,"loadeddata");s.load(),await i,s.play()}catch(e){}}_onError(e){const t=this.value,s=e.target,i=s.error;if(i instanceof window.MediaError&&4===i.code){if(s.src.startsWith("data:"))return;t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`))}else t.setViewError(i)}}class qn extends Ln{renderMessageBody(e,t){const s=[];return t.isPending?s.push((e=>e.label)):s.push(e.button({className:"link",onClick:()=>t.download()},(e=>e.label)),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}}class Wn extends Ln{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}}class Hn extends gn{render(e){return e.li({className:"AnnouncementView"},e.div((e=>e.announcement)))}onClick(){}}class zn extends Ln{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},(e=>e.description))}createMenuOptions(e){const t=super.createMenuOptions(e);return e.isRedacting&&t.push(Mn.option(e.i18n`Cancel`,(()=>e.abortPendingRedaction()))),t}}function Gn(e){switch(e.shape){case"gap":return xn;case"announcement":return Hn;case"message":case"message-status":return Dn;case"image":return Fn;case"video":return jn;case"file":return qn;case"missing-attachment":return Wn;case"redacted":return zn}}function Qn(e){return e.offsetTop+e.clientHeight}function Jn(e,t,s=e.children.length-1){for(var i=s;i>=0;i--){if(e.children[i].offsetTop<t)return i}return 0}class Yn extends gn{constructor(){super(...arguments),this.anchoredBottom=0,this.stickToBottom=!0}render(e,t){requestAnimationFrame((()=>{this.restoreScrollPosition()})),this.tilesView=new Xn(t.tiles,(()=>this.restoreScrollPosition()));const s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:e=>!e.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return"function"==typeof ResizeObserver&&(this.resizeObserver=new ResizeObserver((()=>{this.restoreScrollPosition()})),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){const{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){const{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);const e=this.value.tiles.length;this.updateVisibleRange(0,e-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){const t=Qn(this.anchoredNode);if(t!==this.anchoredBottom){const s=t-this.anchoredBottom;"function"==typeof e.scrollBy?e.scrollBy(0,s):e.scrollTop=e.scrollTop+s,this.anchoredBottom=t}}}onScroll(){const{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:i,clientHeight:r}=e;let n;if(this.stickToBottom=Math.abs(s-(i+r))<1,this.stickToBottom){n=this.value.tiles.length-1}else{const e=Jn(t,i+r);this.anchoredNode=t.childNodes[e],this.anchoredBottom=Qn(this.anchoredNode),n=e}let o=Jn(t,i,n);this.updateVisibleRange(o,n)}updateVisibleRange(e,t){const s=this.tilesView.getChildInstanceByIndex(e),i=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s?.value,i?.value)}}class Xn extends mn{constructor(e,t){super({list:e,onItemClick:(e,t)=>e.onClick(t)},(e=>{const t=Gn(e);if(t)return new t(e)})),this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if("shape"===s){const s=Gn(t),i=this.getChildInstanceByIndex(e);if(!(s&&i instanceof s))return void super.recreateItem(e,t)}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}}class Zn extends gn{render(e,t){return e.div({className:"TimelineLoadingView"},[En(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages…`:t.i18n`Loading messages…`)])}}class eo extends gn{constructor(e){super(e),this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({enterkeyhint:"send",onKeydown:e=>this._onKeyDown(e),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:t.isEncrypted?"Send an encrypted message…":"Send a message…",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);const s=e.map((e=>e.replyViewModel),((e,t)=>{const s=e&&Gn(e);return s?t.div({className:"MessageComposer_replyPreview"},[t.span({className:"replying"},"Replying"),t.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),t.view(new s(e,!1,"div"))]):null})),i=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:e=>this._toggleAttachmentMenu(e)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:e=>e.canSend}},[s,i])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();const{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(e){t(),console.error(e)}}_onKeyDown(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{const t=this.value;this._attachmentPopup=new An(new Mn([Mn.option(t.i18n`Send video`,(()=>t.sendVideo())).setIcon("video"),Mn.option(t.i18n`Send picture`,(()=>t.sendPicture())).setIcon("picture"),Mn.option(t.i18n`Send file`,(()=>t.sendFile())).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame((()=>{const e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0})))}_clearHeight(){this._input.style.removeProperty("height")}}class to extends gn{render(e){return e.div({className:"RoomArchivedView"},e.h3((e=>e.description)))}}class so extends gn{constructor(e){super(e),this._optionsPopup=null}render(e,t){let s;return"composer"===t.composerViewModel.kind?s=new eo(t.composerViewModel):"archived"===t.composerViewModel.kind&&(s=new to(t.composerViewModel)),e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new bn(t,32)),e.div({className:"room-description"},[e.h2((e=>e.name))]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:e=>this._toggleOptionsMenu(e)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},(e=>e.error)),e.mapView((e=>e.timelineViewModel),(e=>e?new Yn(e):new Zn(t))),e.view(s)])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{const t=this.value,s=[];if(s.push(Mn.option(t.i18n`Room details`,(()=>t.openDetailsPanel()))),t.canLeave&&s.push(Mn.option(t.i18n`Leave room`,(()=>this._confirmToLeaveRoom())).setDestructive()),t.canForget&&s.push(Mn.option(t.i18n`Forget room`,(()=>t.forgetRoom())).setDestructive()),t.canRejoin&&s.push(Mn.option(t.i18n`Rejoin room`,(()=>t.rejoinRoom()))),!s.length)return;this._optionsPopup=new An(new Mn(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}}class io extends gn{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:e=>e.busy},t.i18n`Join room`),e.if((e=>e.error),(e=>e.p({className:"error"},t.error)))]))}}class ro extends gn{render(e,t){let s,i=[];return t.isDirectMessage&&i.push(fn(t,128,"InviteView_dmAvatar")),s=t.isDirectMessage?[e.strong(t.name),` (${t.inviter?.id}) wants to chat with you.`]:t.inviter?[fn(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:"You were invited to join.",i.push(e.p({className:"InviteView_inviter"},s)),t.isDirectMessage||i.push(e.div({className:"InviteView_roomProfile"},[fn(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),fn(t,32),e.div({className:"room-description"},[e.h2((e=>e.name))])]),e.if((e=>e.error),(e=>e.div({className:"RoomView_error"},(e=>e.error)))),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...i,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:e=>e.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:e=>e.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}}class no extends gn{render(e,t){const s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),i=e.div({role:"img","aria-label":e=>e.name,title:e=>e.name,className:{picture:!0,hidden:e=>!e.imageUrl},style:e=>`background-image: url('${e.imageUrl}'); max-width: ${e.imageWidth}px; max-height: ${e.imageHeight}px;`}),r=e.div({className:{loading:!0,hidden:e=>!!e.imageUrl}},[En(e),e.div(t.i18n`Loading image…`)]),n=e.div({className:"details"},[e.strong((e=>e.name)),e.br(),"uploaded by ",e.strong((e=>e.sender)),e=>` at ${e.time} on ${e.date}.`]),o=e.div({role:"dialog",className:"lightbox",onClick:e=>this.clickToClose(e),onKeydown:e=>this.closeOnEscKey(e)},[i,r,n,s]);return function(e,t){const s=function(e){return e.querySelectorAll("a[href], button, textarea, input, select")}(t),i=s[0],r=s[s.length-1];e.addEventListener(t,"keydown",(e=>{"Tab"===e.key&&(e.shiftKey?document.activeElement===i&&(r.focus(),e.preventDefault()):document.activeElement===r&&(i.focus(),e.preventDefault()))}),!0),Promise.resolve().then((()=>{i.focus()}))}(e,o),o}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){"Escape"!==e.key&&"Esc"!==e.key||this.value.close()}}class oo{constructor(e,t){"function"!=typeof e||t||(t=e,e=null),this._root=t?t(ln,e):this.render(ln,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}}class ao extends gn{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:e=>!e.isShown}},[En(e,{hidden:e=>!e.isWaiting}),e.p((e=>e.statusLabel)),e.if((e=>e.isConnectNowShown),(e=>e.button({className:"link",onClick:()=>t.connectNow()},"Retry now"))),e.if((e=>e.isSecretStorageShown),(e=>e.a({href:t.setupSessionBackupUrl},"Go to settings"))),e.if((e=>e.canDismiss),(e=>e.div({className:"end"},e.button({className:"dismiss",onClick:()=>t.dismiss()}))))])}}class ho extends gn{render(e,t){const s=[];for(let i=0;i<t.height*t.width;i+=1)s.push(e.div({onClick:()=>t.focusTile(i),onFocusin:()=>t.focusTile(i),className:{container:!0,[`tile${i}`]:!0,focused:e=>e.focusIndex===i}},e.mapView((e=>e.roomViewModelAt(i)),(e=>e?"invite"===e.kind?new ro(e):new so(e):new oo((e=>e.div({className:"room-placeholder"},[e.h2({className:"focused"},t.i18n`Select a room on the left`),e.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))))));return s.push(e.div({className:e=>`focus-ring tile${e.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}}class co extends gn{render(e,t){return e.mapView((e=>e.status),(e=>{switch(e){case"Enabled":return new gn(t,lo);case"SetupKey":return new gn(t,uo);case"SetupPhrase":return new gn(t,mo);case"Pending":return new oo(t,(e=>e.p(t.i18n`Waiting to go online…`)))}}))}}function lo(e,t){const s=[e.p([t.i18n`Session backup is enabled, using backup version ${t.backupVersion}. `,e.button({onClick:()=>t.disable()},t.i18n`Disable`)])];return t.dehydratedDeviceId&&s.push(e.p(t.i18n`A dehydrated device id was set up with id ${t.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),e.div(s)}function uo(e,t){const s=e.button({className:"link",onClick:()=>t.showPhraseSetup()},t.i18n`use a security phrase`);return e.div([e.p(t.i18n`Enter your secret storage security key below to ${t.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),_o(e),po(e,t,t.i18n`Security key`,((e,s)=>t.enterSecurityKey(e,s))),e.p([t.i18n`Alternatively, you can `,s,t.i18n` if you have one.`])])}function mo(e,t){const s=e.button({className:"link",onClick:()=>t.showKeySetup()},t.i18n`use your security key`);return e.div([e.p(t.i18n`Enter your secret storage security phrase below to ${t.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),_o(e),po(e,t,t.i18n`Security phrase`,((e,s)=>t.enterSecurityPhrase(e,s))),e.p([t.i18n`You can also `,s,t.i18n`.`])])}function po(e,t,s,i){let r;const n=e.input({type:"password",disabled:e=>e.isBusy,placeholder:s}),o=[e.p([n,e.button({disabled:e=>e.isBusy,onClick:()=>i(n.value,r?.checked||!1)},t.decryptAction)])];if(t.offerDehydratedDeviceSetup){r=e.input({type:"checkbox",id:"enable-dehydrated-device"});const s=e.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");o.push(e.p([r,e.label({for:r.id},[t.i18n`Back up my device as well (`,s,")"])]))}return e.div({className:"row"},[e.div({className:"label"},s),e.div({className:"content"},o)])}function _o(e){return e.if((e=>e.error),((e,t)=>e.div([e.p({className:"error"},(e=>e.i18n`Could not enable session backup: ${e.error}.`)),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)])))}class go extends gn{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));const i=(e,t,s,i="")=>e.div({className:`row ${i}`},[e.div({className:"label"},t),e.div({className:"content"},s)]),r=[];return r.push(e.h3("Session"),i(e,t.i18n`User ID`,t.userId),i(e,t.i18n`Session ID`,t.deviceId,"code"),i(e,t.i18n`Session key`,t.fingerprintKey,"code"),i(e,"",e.button({onClick:()=>{confirm(t.i18n`Are you sure you want to log out?`)&&t.logout()},disabled:e=>e.isLoggingOut},t.i18n`Log out`))),r.push(e.h3("Session Backup"),e.view(new co(t.sessionBackupViewModel))),r.push(e.h3("Notifications"),e.map((e=>e.pushNotifications.supported),((e,s)=>{if(null===e)return s.p(t.i18n`Loading…`);if(e){const e=e=>e.pushNotifications.enabled?e.i18n`Push notifications are enabled`:e.i18n`Push notifications are disabled`,r=e=>e.pushNotifications.enabled?e.i18n`Disable`:e.i18n`Enable`;return i(s,e,s.button({onClick:()=>t.togglePushNotifications(),disabled:e=>e.pushNotifications.updating},r))}return s.p(t.i18n`Push notifications are not supported on this browser`)})),e.if((e=>e.pushNotifications.supported&&e.pushNotifications.enabled),(e=>e.div([e.p(["If you think push notifications are not being delivered, ",e.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),e.map((e=>e.pushNotifications.enabledOnServer),((e,t)=>!0===e?t.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time."):!1===e?t.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above."):void 0)),e.map((e=>e.pushNotifications.serverError),((e,t)=>{if(e)return t.p("Couldn't not check on server: "+e.message)}))])))),r.push(e.h3("Preferences"),i(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t))),r.push(e.h3("Application"),i(e,t.i18n`Version`,s),i(e,t.i18n`Storage usage`,(e=>`${e.storageUsage} / ${e.storageQuota}`)),i(e,t.i18n`Debug logs`,e.button({onClick:()=>t.exportLogs()},"Export")),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},r)])}_imageCompressionRange(e,t){const s=32*Math.ceil(t.minSentImageSizeLimit/32),i=32*(Math.floor(t.maxSentImageSizeLimit/32)+1),r=e=>t.setSentImageSizeLimit(parseInt(e.target.value,10));return[e.input({type:"range",step:32,min:s,max:i,value:e=>e.sentImageSizeLimit||i,onInput:r,onChange:r})," ",e.output((e=>e.sentImageSizeLimit?e.i18n`resize to ${e.sentImageSizeLimit}px`:e.i18n`no resizing`))]}}class yo extends gn{render(e,t){return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new bn(t,52)),e.mapView((e=>e.isEncrypted),(e=>new fo(e)))]),e.div({className:"RoomDetailsView_name"},[e.h2((e=>e.name))]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},(e=>e.memberCount),(()=>t.openPanel("members"))),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},(()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`))])])}_createRoomAliasDisplay(e){return e.canonicalAlias?ln.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,i){const r=rn({RoomDetailsView_label:!0,...s});return e.div({className:"RoomDetailsView_row"},[e.div({className:r},[t]),e.div({className:"RoomDetailsView_value"},i)])}_createRightPanelButtonRow(e,t,s,i,r){const n=rn({RoomDetailsView_label:!0,...s});return e.button({className:"RoomDetailsView_row",onClick:r},[e.div({className:n},[t]),e.div({className:"RoomDetailsView_value"},i)])}}class fo extends gn{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}}class vo{constructor(e,t){this.start=e,this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){const i=e.next();if(i.done)break;t(i.value,this.start+s)}}[Symbol.iterator](){return new So(this)}reverseIterable(){return new Io(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?wo.Before:e<this.end?wo.Inside:wo.After}}var wo,bo;!function(e){e[e.Before=1]="Before",e[e.Inside=2]="Inside",e[e.After=3]="After"}(wo||(wo={}));class So{constructor(e){this.range=e,this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}class Io{constructor(e){this.range=e,this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}}function Eo(e,t){if(function(e,t){let s=0;for(;s<t;)if(s+=1,e.next().done)return!1;return!0}(e,t)){const t=e.next();if(!t.done)return t.value}}!function(e){e[e.Move=0]="Move",e[e.Add=1]="Add",e[e.Remove=2]="Remove",e[e.RemoveAndAdd=3]="RemoveAndAdd",e[e.UpdateRange=4]="UpdateRange"}(bo||(bo={}));class ko extends vo{constructor(e,t,s,i=t-e){super(e,t),this._totalLength=s,this._viewportItemCount=i}expand(e){if(0===this.length)return this;const t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new ko(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,i){const r=Math.min(Math.max(0,Math.floor(i/t)),e),n=e-r,o=0!==s?Math.ceil(s/t):0,a=Math.min(o,n);return new ko(r,r+a,e,o)}queryAdd(e,t,s){const i=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=i){const r=this.clampIndex(e,i),n=r===e?t:Eo(s[Symbol.iterator](),r);return this.createAddResult(r,n)}return{type:bo.UpdateRange,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){const s=this.clampIndex(e);return this.createRemoveResult(s,t)}return{type:bo.UpdateRange,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,i){const r=this.getIndexZone(e);if(r!==this.getIndexZone(t)){const r=this.clampIndex(t),n=this.clampIndex(e),o=r===t?s:Eo(i[Symbol.iterator](),r);return{type:bo.RemoveAndAdd,removeIdx:n,addIdx:r,value:o}}if(r!==wo.Before&&r!==wo.After)return r===wo.Inside?{type:bo.Move,fromIdx:e,toIdx:t}:void 0}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:bo.Add,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{const s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:bo.RemoveAndAdd,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){const s=this.clampIndex(Number.MAX_SAFE_INTEGER),i=Eo(t[Symbol.iterator](),s);return{type:bo.RemoveAndAdd,removeIdx:e,value:i,addIdx:s,newRange:this.deriveRange(-1,0)}}if(0!==this.start){const s=this.deriveRange(-1,0,1),i=s.start,r=Eo(t[Symbol.iterator](),i);return{type:bo.RemoveAndAdd,removeIdx:e,value:r,addIdx:i,newRange:s}}return{type:bo.Remove,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){const i=this.start-s,r=this.totalLength+e,n=Math.min(Math.max(i,this.end-s+t),r);return new ko(i,n,r,this.viewportItemCount)}}class Ro extends mn{constructor({itemHeight:e,overflowItems:t=20,...s},i){super(s,i),this.itemHeight=e,this.overflowItems=t}handleEvent(e){"scroll"===e.type?this.handleScroll():super.handleEvent(e)}handleScroll(){const e=this._getVisibleRange();if(0!==e.length&&!this.renderRange.contains(e)){const t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise((e=>requestAnimationFrame(e))),await new Promise((e=>requestAnimationFrame(e))),!this._list)return;this._subscription=this._list.subscribe(this);const e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){const{clientHeight:e,scrollTop:t}=this.root();if(0===e)throw new Error("LazyListView height is 0");return ko.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){this._listElement.innerHTML="";const t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,(e=>{const s=this._childCreator(e);this._childInstances.push(s),t.appendChild(dn(s,this._mountArgs))})),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(const s of e.reverseIterable())if(!t.containsIndex(s)){const t=s-e.start;this.removeChild(t)}t.forEachInIterator(this._list[Symbol.iterator](),((s,i)=>{if(!e.containsIndex(i)){const e=i-t.start;this.addChild(e,s)}})),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){const t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,i=this._listElement.style;i.paddingTop=`${t}px`,i.paddingBottom=`${s}px`}mount(){const e=super.mount();return this.scrollContainer=ln.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){const s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){const s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){const i=this.renderRange.queryMove(e,t,s,this._list);i&&(i.type===bo.Move?this.moveChild(this.renderRange.toLocalIndex(i.fromIdx),this.renderRange.toLocalIndex(i.toIdx)):this.applyRemoveAddResult(i))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){e.type!==bo.Remove&&e.type!==bo.RemoveAndAdd||this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),e.type!==bo.Add&&e.type!==bo.RemoveAndAdd||this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}}class Co extends gn{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new bn(t,32)),e.div({className:"MemberTileView_name"},(e=>e.name))]))}}class Ao extends Ro{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},(e=>new Co(e)))}}class Mo extends gn{render(e){return e.div({className:"LoadingView"},[En(e),"Loading"])}}class To extends gn{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new bn(t,128)),e.div({className:"MemberDetailsView_name"},e.h2((e=>e.name))),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,(e=>e.role)),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`)])])}}class xo extends gn{render(e){return e.div({className:"RightPanelView"},[e.ifView((e=>e.activeViewModel),(e=>new No(e))),e.mapView((e=>e.activeViewModel),(e=>this._viewFromType(e)))])}_viewFromType(e){const t=e?.type;switch(t){case"room-details":return new yo(e);case"member-list":return new Ao(e);case"member-details":return new To(e);default:return new Mo}}}class No extends gn{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}}class Uo extends gn{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":e=>!!e.activeMiddleViewModel,"right-shown":e=>!!e.rightPanelViewModel}},[e.view(new ao(t.sessionStatusViewModel)),e.view(new Cn(t.leftPanelViewModel)),e.mapView((e=>e.activeMiddleViewModel),(()=>t.roomGridViewModel?new ho(t.roomGridViewModel):t.settingsViewModel?new go(t.settingsViewModel):t.currentRoomViewModel?"invite"===t.currentRoomViewModel.kind?new ro(t.currentRoomViewModel):"room"===t.currentRoomViewModel.kind?new so(t.currentRoomViewModel):new io(t.currentRoomViewModel):new oo((e=>e.div({className:"room-placeholder"},e.h2(t.i18n`Choose a room on the left side.`)))))),e.mapView((e=>e.lightboxViewModel),(e=>e?new no(e):null)),e.mapView((e=>e.rightPanelViewModel),(e=>e?new xo(e):null))])}}function Lo(e){return DEFINE_GLOBAL_HASH?e.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.2.22"},`Hydrogen v0.2.22 (${DEFINE_GLOBAL_HASH}) on Github`):e.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}class Oo extends gn{render(e,t){const s=e=>!!e.isBusy,i=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),r=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if((e=>e.error),(e=>e.div({className:"error"},(e=>e.error)))),e.form({onSubmit:e=>{e.preventDefault(),t.login(i.value,r.value)}},[e.if((e=>e.errorMessage),((e,t)=>e.p({className:"error"},t.i18n(t.errorMessage)))),e.div({className:"form-row"},[e.label({for:"username"},t.i18n`Username`),i]),e.div({className:"form-row"},[e.label({for:"password"},t.i18n`Password`),r]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}}class Do extends gn{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView((e=>e.decryptDehydratedDeviceViewModel),(e=>new co(e.decryptDehydratedDeviceViewModel))),e.map((e=>e.deviceDecrypted),((e,s)=>e?s.p(t.i18n`That worked out, you're good to go!`):s.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`))),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},(e=>e.deviceDecrypted?e.i18n`Continue`:e.i18n`Continue without restoring`))])])}}class Bo extends gn{render(e){const t=e.if((e=>e.hasError),((e,t)=>e.button({onClick:()=>t.exportLogs()},t.i18n`Export logs`))),s=e.if((e=>e.hasError),((e,t)=>e.button({onClick:()=>t.logout()},t.i18n`Log out`)));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[En(e,{hidden:e=>!e.loading}),e.p((e=>e.loadLabel)),t,s]),e.ifView((e=>e.accountSetupViewModel),(e=>new Do(e.accountSetupViewModel)))])}}class Po extends gn{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if((e=>e.errorMessage),((e,t)=>e.p({className:"error"},t.i18n(t.errorMessage)))),e.mapView((e=>e.loadViewModel),(e=>e?new Bo(e):null))])}}class Ko extends gn{render(e,t){const s=e=>e.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView((e=>e.completeSSOLoginViewModel),(e=>e?new Po(e):null)),e.if((e=>e.showHomeserver),((e,t)=>e.div({className:"LoginView_sso form form-row"},[e.label({for:"homeserver"},t.i18n`Homeserver`),e.input({id:"homeserver",type:"text",placeholder:t.i18n`Your matrix homeserver`,value:t.homeserver,disabled:s,onInput:e=>t.setHomeserver(e.target.value),onChange:()=>t.queryHomeserver()}),e.p({className:{LoginView_forwardInfo:!0,hidden:e=>!e.resolvedHomeserver}},(e=>e.i18n`You will connect to ${e.resolvedHomeserver}.`)),e.if((e=>e.errorMessage),((e,t)=>e.p({className:"error"},t.i18n(t.errorMessage))))]))),e.if((e=>e.isFetchingLoginOptions),(e=>e.div({className:"LoginView_query-spinner"},[En(e),e.p("Fetching available login options...")]))),e.mapView((e=>e.passwordLoginViewModel),(e=>e?new Oo(e):null)),e.if((e=>e.passwordLoginViewModel&&e.startSSOLoginViewModel),(e=>e.p({className:"LoginView_separator"},t.i18n`or`))),e.mapView((e=>e.startSSOLoginViewModel),(e=>e?new Vo(e):null)),e.mapView((e=>e.loadViewModel),(e=>e?new Bo(e):null)),e.p(Lo(e))])}}class Vo extends gn{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:e=>e.isBusy},t.i18n`Log in with SSO`))}}class Fo extends gn{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new Bo(t))]),e.div({className:{"button-row":!0,hidden:e=>e.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}}class $o extends gn{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},(e=>e.avatarInitials)),e.div({className:"user-id"},(e=>e.label))])])}}class jo extends gn{render(e,t){const s=new mn({list:t.sessions,parentProvidesUpdates:!1},(e=>new $o(e)));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as …"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView((e=>e.loadViewModel),(()=>new Bo(t.loadViewModel))),e.p(Lo(e))])])}}class qo extends gn{render(e,t){return e.mapView((e=>e.activeSection),(e=>{switch(e){case"error":return new oo((e=>e.div({className:"StatusView"},[e.h1("Something went wrong"),e.p(t.errorText)])));case"session":return new Uo(t.sessionViewModel);case"login":return new Ko(t.loginViewModel);case"picker":return new jo(t.sessionPickerViewModel);case"redirecting":return new oo((e=>e.p("Redirecting...")));case"loading":return new Fo(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}}))}}class Wo{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise(((t,s)=>{this._reject=s,this._handle=setTimeout((()=>{this._reject=null,t()}),e)}))}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new i),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}}class Ho{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}}class zo{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}}class Go{createMeasure(){return new zo}createTimeout(e){return new Wo(e)}createInterval(e,t){return new Ho(t,e)}now(){return Date.now()}}class Qo{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){const{data:t}=e,s=t.replyTo;if(s){const e=this._waitingForReply.get(s);e&&(this._waitingForReply.delete(s),e(t.payload))}if("hasSessionOpen"===t.type){const s=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:s})}else if("hasRoomOpen"===t.type){const s=this._navigation.observe("session").get()===t.payload.sessionId,i=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:s&&i})}else if("closeSession"===t.type){const{sessionId:s}=t.payload;this._closeSessionIfNeeded(s).finally((()=>{e.source.postMessage({replyTo:t.id})}))}else"haltRequests"===t.type?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):"openRoom"===t.type&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){const t=this._navigation?.path.get("session");return e&&t?.value===e?new Promise((t=>{const s=this._navigation.pathObservable.subscribe((i=>{const r=i.get("session");r&&r.value===e||(s(),t())}));this._navigation.push("session")})):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;const e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":"installed"===e.target.state&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break;case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller}}async _send(e,t,s){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;const i=this._messageIdCounter,r=new Promise((e=>{this._waitingForReply.set(i,e)}));return s.postMessage({type:e,id:i,payload:t}),await r}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.2.22"}get buildHash(){return DEFINE_GLOBAL_HASH}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}}class Jo{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){const s=await(this._serviceWorkerHandler?.getRegistration());if(s?.pushManager){const i=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),r=i.keys.p256dh,n={endpoint:i.endpoint,auth:i.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,r,n)}}async disablePush(){const e=await(this._serviceWorkerHandler?.getRegistration());if(e?.pushManager){const t=await e.pushManager.getSubscription();t&&await t.unsubscribe()}}async isPushEnabled(){const e=await(this._serviceWorkerHandler?.getRegistration());if(e?.pushManager){return!!await e.pushManager.getSubscription()}return!1}async supportsPush(){if(!this._pushConfig)return!1;const e=await(this._serviceWorkerHandler?.getRegistration());return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window&&"granted"===await Notification.requestPermission()}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window&&"granted"===Notification.permission}async showNotification(e,t){if("Notification"in window)return void new Notification(e,{body:t});(await(this._serviceWorkerHandler?.getRegistration()))?.showNotification(e,{body:t})}}class Yo extends n{handleEvent(e){"hashchange"===e.type&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){window.localStorage?.setItem("hydrogen_last_url_hash",e)}getLastUrl(){return window.localStorage?.getItem("hydrogen_last_url_hash")}}class Xo extends n{constructor(){super(),this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}}function Zo(e,t){return e instanceof Promise?e:new Promise(((s,i)=>{e.oncomplete=e=>s(e.target.result),e.onerror=()=>i(new Error("Crypto error on "+t))}))}class ea{constructor(e){this._subtleCrypto=e}async verify(e,t,s,i){const r={name:"HMAC",hash:{name:aa(i)}},n=await Zo(this._subtleCrypto.importKey("raw",e,r,!1,["verify"]),"importKey");return await Zo(this._subtleCrypto.verify(r,n,t,s),"verify")}async compute(e,t,s){const i={name:"HMAC",hash:{name:aa(s)}},r=await Zo(this._subtleCrypto.importKey("raw",e,i,!1,["sign"]),"importKey"),n=await Zo(this._subtleCrypto.sign(i,r,t),"sign");return new Uint8Array(n)}}class ta{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");const n=await Zo(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),o=await Zo(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:aa(i)},n,r),"deriveBits");return new Uint8Array(o)}async hkdf(e,t,s,i,r){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,i,r);const n=await Zo(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),o=await Zo(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:aa(i)},n,r),"deriveBits");return new Uint8Array(o)}}class sa{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){const n={name:"AES-CTR",counter:s,length:r};let o;try{const s=e||t,i=t?"jwk":"raw";o=await Zo(this._subtleCrypto.importKey(i,s,n,!1,["decrypt"]),"importKey")}catch(e){throw new Error(`Could not import key for AES-CTR decryption: ${e.message}`)}try{const e=await Zo(this._subtleCrypto.decrypt(n,o,i),"decrypt");return new Uint8Array(e)}catch(e){throw new Error(`Could not decrypt with AES-CTR: ${e.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){const r={name:"AES-CTR",counter:s,length:64};let n;const o=e||t,a=t?"jwk":"raw";try{n=await Zo(this._subtleCrypto.importKey(a,o,r,!1,["encrypt"]),"importKey")}catch(e){throw new Error(`Could not import key for AES-CTR encryption: ${e.message}`)}try{const e=await Zo(this._subtleCrypto.encrypt(r,n,i),"encrypt");return new Uint8Array(e)}catch(e){throw new Error(`Could not encrypt with AES-CTR: ${e.message}`)}}async generateKey(e,t=256){const s=await Zo(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return Zo(this._subtleCrypto.exportKey(e,s))}async generateIV(){return ia(this._crypto)}}function ia(e){const t=e.getRandomValues(new Uint8Array(8)),s=new Uint8Array(16);for(let e=0;e<t.length;e+=1)s[e]=t[e];return s}function ra(e){if("A256CTR"!==e.alg)throw new Error(`Unknown algorithm: ${e.alg}`);if(!e.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if("oct"!==e.kty)throw new Error(`Invalid key type, "oct" expected: ${e.kty}`);const t=e.k.replace(/-/g,"+").replace(/_/g,"/");return Mr.decode(t)}function na(e){const t=function(e){const t=Mr.encode(e),s=t.indexOf("=");return-1!==s?t.substr(0,s):t}(e);return t.replace(/\+/g,"-").replace(/\//g,"_")}class oa{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:i,counterLength:r=64}){if(64!==r)throw new Error(`Unsupported counter length: ${r}`);t&&(e=ra(t));const n=this._aesjs;return new n.ModeOfOperation.ctr(new Uint8Array(e),new n.Counter(new Uint8Array(s))).decrypt(new Uint8Array(i))}async encryptCTR({key:e,jwkKey:t,iv:s,data:i}){t&&(e=ra(t));const r=this._aesjs;return new r.ModeOfOperation.ctr(new Uint8Array(e),new r.Counter(new Uint8Array(s))).encrypt(new Uint8Array(i))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return"jwk"===e&&(s=function(e){return{alg:"A256CTR",ext:!0,k:na(e),key_ops:["encrypt","decrypt"],kty:"oct"}}(s)),s}async generateIV(){return ia(this._crypto)}}function aa(e){if("SHA-256"!==e&&"SHA-512"!==e)throw new Error(`Invalid hash name: ${e}`);return e}class ha{constructor(e){const t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&e?.aesjs?this.aes=new oa(e.aesjs,t):this.aes=new sa(s,t),this.hmac=new ea(s),this.derive=new ta(s,this,e)}async digest(e,t){return await Zo(this._subtleCrypto.digest(aa(e),t))}digestSize(e){switch(aa(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${aa(e)}`)}}}async function ca(){if(navigator?.storage?.estimate){const{quota:e,usage:t}=await navigator.storage.estimate();return{quota:e,usage:t}}return{quota:null,usage:null}}class la{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}}class da{constructor(e,t){this._promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}}class ua{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){const t=new la(new Worker(e));t.attach(this),this._workers[s]=t}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){const e=new Promise(((e,t)=>{this._init={resolve:e,reject:t}}));return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally((()=>{this._init=null})),e}handleEvent(e){if("message"===e.type){const t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if("success"===t.type)s._resolve(t.payload);else if("error"===t.type){const e=new Error(t.message);e.stack=t.stack,s._reject(e)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else"error"===e.type&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(const e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(const e of this._workers)if(!e.busy)return e}_sendPending(){let e;this._pendingFlag=!1;do{e=!1;const t=this._getPendingRequest();if(t){const s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;const t=new da(e,this);return this._requests.set(e.id,t),t}send(e){const t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){const t=this._workers.map((t=>{const s=this._enqueueRequest(Object.assign({},e));return this._sendWith(s,t),s.response()}));return Promise.all(t)}dispose(){for(const e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then((()=>{this._sendPending()})))}_abortRequest(e){e._reject(new i),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}}class ma{static async fromBlob(e){const t=await _a(e),{width:s,height:i}=t;return new ma(e,s,i,t)}constructor(e,t,s,i){this.blob=e,this.width=t,this.height=s,this._domElement=i}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await _a(this.blob)),this._domElement}async scale(e){const t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),i=Math.round(this.width*s),r=Math.round(this.height*s),n=document.createElement("canvas");n.width=i,n.height=r;const o=n.getContext("2d"),a=await this._getDomElement();o.drawImage(a,0,0,i,r);let h,c="image/jpeg"===this.blob.mimeType?"image/jpeg":"image/png";if(n.toBlob)h=await new Promise((e=>n.toBlob(e,c)));else{if(!n.msToBlob)throw new Error("canvas can't be turned into blob");c="image/png",h=n.msToBlob()}const l=d.fromBlob(h);return new ma(l,i,r,null)}dispose(){this.blob.dispose()}}class pa extends ma{get duration(){if("number"==typeof this._domElement.duration)return Math.round(1e3*this._domElement.duration)}static async fromBlob(e){const t=await async function(e){const t=document.createElement("video");t.muted=!0;const s=$n(t,"loadedmetadata");t.src=e.url,t.load(),await s;const i=$n(t,"seeked");return await new Promise((e=>setTimeout(e,200))),t.currentTime=.1,await i,t}(e),{videoWidth:s,videoHeight:i}=t;return new pa(e,s,i,t)}}async function _a(e){const t=document.createElement("img"),s=$n(t,"load");return t.src=e.url,await s,t}var ga={exports:{}},ya=ga.exports=function(){function e(e){if(Array.isArray(e)){for(var t=0,s=Array(e.length);t<e.length;t++)s[t]=e[t];return s}return Array.from(e)}var t=Object.hasOwnProperty,s=Object.setPrototypeOf,i=Object.isFrozen,r=Object.getPrototypeOf,n=Object.getOwnPropertyDescriptor,o=Object.freeze,a=Object.seal,h=Object.create,c="undefined"!=typeof Reflect&&Reflect,l=c.apply,d=c.construct;l||(l=function(e,t,s){return e.apply(t,s)}),o||(o=function(e){return e}),a||(a=function(e){return e}),d||(d=function(t,s){return new(Function.prototype.bind.apply(t,[null].concat(e(s))))});var u=S(Array.prototype.forEach),m=S(Array.prototype.pop),p=S(Array.prototype.push),_=S(String.prototype.toLowerCase),g=S(String.prototype.match),y=S(String.prototype.replace),f=S(String.prototype.indexOf),v=S(String.prototype.trim),w=S(RegExp.prototype.test),b=I(TypeError);function S(e){return function(t){for(var s=arguments.length,i=Array(s>1?s-1:0),r=1;r<s;r++)i[r-1]=arguments[r];return l(e,t,i)}}function I(e){return function(){for(var t=arguments.length,s=Array(t),i=0;i<t;i++)s[i]=arguments[i];return d(e,s)}}function E(e,t){s&&s(e,null);for(var r=t.length;r--;){var n=t[r];if("string"==typeof n){var o=_(n);o!==n&&(i(t)||(t[r]=o),n=o)}e[n]=!0}return e}function k(e){var s=h(null),i=void 0;for(i in e)l(t,e,[i])&&(s[i]=e[i]);return s}function R(e,t){for(;null!==e;){var s=n(e,t);if(s){if(s.get)return S(s.get);if("function"==typeof s.value)return S(s.value)}e=r(e)}function i(e){return console.warn("fallback value for",e),null}return i}var C=o(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),A=o(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),M=o(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),T=o(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),x=o(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),N=o(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),U=o(["#text"]),L=o(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),O=o(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),D=o(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),B=o(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),P=a(/\{\{[\s\S]*|[\s\S]*\}\}/gm),K=a(/<%[\s\S]*|[\s\S]*%>/gm),V=a(/^data-[\-\w.\u00B7-\uFFFF]/),F=a(/^aria-[\-\w]+$/),$=a(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),j=a(/^(?:\w+script|data):/i),q=a(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function H(e){if(Array.isArray(e)){for(var t=0,s=Array(e.length);t<e.length;t++)s[t]=e[t];return s}return Array.from(e)}var z=function(){return"undefined"==typeof window?null:window},G=function(e,t){if("object"!==(void 0===e?"undefined":W(e))||"function"!=typeof e.createPolicy)return null;var s=null,i="data-tt-policy-suffix";t.currentScript&&t.currentScript.hasAttribute(i)&&(s=t.currentScript.getAttribute(i));var r="dompurify"+(s?"#"+s:"");try{return e.createPolicy(r,{createHTML:function(e){return e}})}catch(e){return console.warn("TrustedTypes policy "+r+" could not be created."),null}};function Q(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:z(),t=function(e){return Q(e)};if(t.version="2.3.4",t.removed=[],!e||!e.document||9!==e.document.nodeType)return t.isSupported=!1,t;var s=e.document,i=e.document,r=e.DocumentFragment,n=e.HTMLTemplateElement,a=e.Node,h=e.Element,c=e.NodeFilter,l=e.NamedNodeMap,d=void 0===l?e.NamedNodeMap||e.MozNamedAttrMap:l,S=e.HTMLFormElement,I=e.DOMParser,J=e.trustedTypes,Y=h.prototype,X=R(Y,"cloneNode"),Z=R(Y,"nextSibling"),ee=R(Y,"childNodes"),te=R(Y,"parentNode");if("function"==typeof n){var se=i.createElement("template");se.content&&se.content.ownerDocument&&(i=se.content.ownerDocument)}var ie=G(J,s),re=ie&&De?ie.createHTML(""):"",ne=i,oe=ne.implementation,ae=ne.createNodeIterator,he=ne.createDocumentFragment,ce=ne.getElementsByTagName,le=s.importNode,de={};try{de=k(i).documentMode?i.documentMode:{}}catch(e){}var ue={};t.isSupported="function"==typeof te&&oe&&void 0!==oe.createHTMLDocument&&9!==de;var me=P,pe=K,_e=V,ge=F,ye=j,fe=q,ve=$,we=null,be=E({},[].concat(H(C),H(A),H(M),H(x),H(U))),Se=null,Ie=E({},[].concat(H(L),H(O),H(D),H(B))),Ee=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ke=null,Re=null,Ce=!0,Ae=!0,Me=!1,Te=!1,xe=!1,Ne=!1,Ue=!1,Le=!1,Oe=!1,De=!1,Be=!0,Pe=!0,Ke=!1,Ve={},Fe=null,$e=E({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),je=null,qe=E({},["audio","video","img","source","image","track"]),We=null,He=E({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ze="http://www.w3.org/1998/Math/MathML",Ge="http://www.w3.org/2000/svg",Qe="http://www.w3.org/1999/xhtml",Je=Qe,Ye=!1,Xe=void 0,Ze=["application/xhtml+xml","text/html"],et="text/html",tt=void 0,st=null,it=i.createElement("form"),rt=function(e){return e instanceof RegExp||e instanceof Function},nt=function(e){st&&st===e||(e&&"object"===(void 0===e?"undefined":W(e))||(e={}),e=k(e),we="ALLOWED_TAGS"in e?E({},e.ALLOWED_TAGS):be,Se="ALLOWED_ATTR"in e?E({},e.ALLOWED_ATTR):Ie,We="ADD_URI_SAFE_ATTR"in e?E(k(He),e.ADD_URI_SAFE_ATTR):He,je="ADD_DATA_URI_TAGS"in e?E(k(qe),e.ADD_DATA_URI_TAGS):qe,Fe="FORBID_CONTENTS"in e?E({},e.FORBID_CONTENTS):$e,ke="FORBID_TAGS"in e?E({},e.FORBID_TAGS):{},Re="FORBID_ATTR"in e?E({},e.FORBID_ATTR):{},Ve="USE_PROFILES"in e&&e.USE_PROFILES,Ce=!1!==e.ALLOW_ARIA_ATTR,Ae=!1!==e.ALLOW_DATA_ATTR,Me=e.ALLOW_UNKNOWN_PROTOCOLS||!1,Te=e.SAFE_FOR_TEMPLATES||!1,xe=e.WHOLE_DOCUMENT||!1,Le=e.RETURN_DOM||!1,Oe=e.RETURN_DOM_FRAGMENT||!1,De=e.RETURN_TRUSTED_TYPE||!1,Ue=e.FORCE_BODY||!1,Be=!1!==e.SANITIZE_DOM,Pe=!1!==e.KEEP_CONTENT,Ke=e.IN_PLACE||!1,ve=e.ALLOWED_URI_REGEXP||ve,Je=e.NAMESPACE||Qe,e.CUSTOM_ELEMENT_HANDLING&&rt(e.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(Ee.tagNameCheck=e.CUSTOM_ELEMENT_HANDLING.tagNameCheck),e.CUSTOM_ELEMENT_HANDLING&&rt(e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(Ee.attributeNameCheck=e.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),e.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(Ee.allowCustomizedBuiltInElements=e.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Xe=Xe=-1===Ze.indexOf(e.PARSER_MEDIA_TYPE)?et:e.PARSER_MEDIA_TYPE,tt="application/xhtml+xml"===Xe?function(e){return e}:_,Te&&(Ae=!1),Oe&&(Le=!0),Ve&&(we=E({},[].concat(H(U))),Se=[],!0===Ve.html&&(E(we,C),E(Se,L)),!0===Ve.svg&&(E(we,A),E(Se,O),E(Se,B)),!0===Ve.svgFilters&&(E(we,M),E(Se,O),E(Se,B)),!0===Ve.mathMl&&(E(we,x),E(Se,D),E(Se,B))),e.ADD_TAGS&&(we===be&&(we=k(we)),E(we,e.ADD_TAGS)),e.ADD_ATTR&&(Se===Ie&&(Se=k(Se)),E(Se,e.ADD_ATTR)),e.ADD_URI_SAFE_ATTR&&E(We,e.ADD_URI_SAFE_ATTR),e.FORBID_CONTENTS&&(Fe===$e&&(Fe=k(Fe)),E(Fe,e.FORBID_CONTENTS)),Pe&&(we["#text"]=!0),xe&&E(we,["html","head","body"]),we.table&&(E(we,["tbody"]),delete ke.tbody),o&&o(e),st=e)},ot=E({},["mi","mo","mn","ms","mtext"]),at=E({},["foreignobject","desc","title","annotation-xml"]),ht=E({},A);E(ht,M),E(ht,T);var ct=E({},x);E(ct,N);var lt=function(e){var t=te(e);t&&t.tagName||(t={namespaceURI:Qe,tagName:"template"});var s=_(e.tagName),i=_(t.tagName);if(e.namespaceURI===Ge)return t.namespaceURI===Qe?"svg"===s:t.namespaceURI===ze?"svg"===s&&("annotation-xml"===i||ot[i]):Boolean(ht[s]);if(e.namespaceURI===ze)return t.namespaceURI===Qe?"math"===s:t.namespaceURI===Ge?"math"===s&&at[i]:Boolean(ct[s]);if(e.namespaceURI===Qe){if(t.namespaceURI===Ge&&!at[i])return!1;if(t.namespaceURI===ze&&!ot[i])return!1;var r=E({},["title","style","font","a","script"]);return!ct[s]&&(r[s]||!ht[s])}return!1},dt=function(e){p(t.removed,{element:e});try{e.parentNode.removeChild(e)}catch(t){try{e.outerHTML=re}catch(t){e.remove()}}},ut=function(e,s){try{p(t.removed,{attribute:s.getAttributeNode(e),from:s})}catch(e){p(t.removed,{attribute:null,from:s})}if(s.removeAttribute(e),"is"===e&&!Se[e])if(Le||Oe)try{dt(s)}catch(e){}else try{s.setAttribute(e,"")}catch(e){}},mt=function(e){var t=void 0,s=void 0;if(Ue)e="<remove></remove>"+e;else{var r=g(e,/^[\r\n\t ]+/);s=r&&r[0]}"application/xhtml+xml"===Xe&&(e='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+e+"</body></html>");var n=ie?ie.createHTML(e):e;if(Je===Qe)try{t=(new I).parseFromString(n,Xe)}catch(e){}if(!t||!t.documentElement){t=oe.createDocument(Je,"template",null);try{t.documentElement.innerHTML=Ye?"":n}catch(e){}}var o=t.body||t.documentElement;return e&&s&&o.insertBefore(i.createTextNode(s),o.childNodes[0]||null),Je===Qe?ce.call(t,xe?"html":"body")[0]:xe?t.documentElement:o},pt=function(e){return ae.call(e.ownerDocument||e,e,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT,null,!1)},_t=function(e){return e instanceof S&&("string"!=typeof e.nodeName||"string"!=typeof e.textContent||"function"!=typeof e.removeChild||!(e.attributes instanceof d)||"function"!=typeof e.removeAttribute||"function"!=typeof e.setAttribute||"string"!=typeof e.namespaceURI||"function"!=typeof e.insertBefore)},gt=function(e){return"object"===(void 0===a?"undefined":W(a))?e instanceof a:e&&"object"===(void 0===e?"undefined":W(e))&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},yt=function(e,s,i){ue[e]&&u(ue[e],(function(e){e.call(t,s,i,st)}))},ft=function(e){var s=void 0;if(yt("beforeSanitizeElements",e,null),_t(e))return dt(e),!0;if(g(e.nodeName,/[\u0080-\uFFFF]/))return dt(e),!0;var i=tt(e.nodeName);if(yt("uponSanitizeElement",e,{tagName:i,allowedTags:we}),!gt(e.firstElementChild)&&(!gt(e.content)||!gt(e.content.firstElementChild))&&w(/<[/\w]/g,e.innerHTML)&&w(/<[/\w]/g,e.textContent))return dt(e),!0;if("select"===i&&w(/<template/i,e.innerHTML))return dt(e),!0;if(!we[i]||ke[i]){if(Pe&&!Fe[i]){var r=te(e)||e.parentNode,n=ee(e)||e.childNodes;if(n&&r)for(var o=n.length-1;o>=0;--o)r.insertBefore(X(n[o],!0),Z(e))}if(!ke[i]&&wt(i)){if(Ee.tagNameCheck instanceof RegExp&&w(Ee.tagNameCheck,i))return!1;if(Ee.tagNameCheck instanceof Function&&Ee.tagNameCheck(i))return!1}return dt(e),!0}return e instanceof h&&!lt(e)?(dt(e),!0):"noscript"!==i&&"noembed"!==i||!w(/<\/no(script|embed)/i,e.innerHTML)?(Te&&3===e.nodeType&&(s=e.textContent,s=y(s,me," "),s=y(s,pe," "),e.textContent!==s&&(p(t.removed,{element:e.cloneNode()}),e.textContent=s)),yt("afterSanitizeElements",e,null),!1):(dt(e),!0)},vt=function(e,t,s){if(Be&&("id"===t||"name"===t)&&(s in i||s in it))return!1;if(Ae&&!Re[t]&&w(_e,t));else if(Ce&&w(ge,t));else if(!Se[t]||Re[t]){if(!(wt(e)&&(Ee.tagNameCheck instanceof RegExp&&w(Ee.tagNameCheck,e)||Ee.tagNameCheck instanceof Function&&Ee.tagNameCheck(e))&&(Ee.attributeNameCheck instanceof RegExp&&w(Ee.attributeNameCheck,t)||Ee.attributeNameCheck instanceof Function&&Ee.attributeNameCheck(t))||"is"===t&&Ee.allowCustomizedBuiltInElements&&(Ee.tagNameCheck instanceof RegExp&&w(Ee.tagNameCheck,s)||Ee.tagNameCheck instanceof Function&&Ee.tagNameCheck(s))))return!1}else if(We[t]);else if(w(ve,y(s,fe,"")));else if("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==f(s,"data:")||!je[e])if(Me&&!w(ye,y(s,fe,"")));else if(s)return!1;return!0},wt=function(e){return e.indexOf("-")>0},bt=function(e){var s=void 0,i=void 0,r=void 0,n=void 0;yt("beforeSanitizeAttributes",e,null);var o=e.attributes;if(o){var a={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:Se};for(n=o.length;n--;){var h=s=o[n],c=h.name,l=h.namespaceURI;if(i=v(s.value),r=tt(c),a.attrName=r,a.attrValue=i,a.keepAttr=!0,a.forceKeepAttr=void 0,yt("uponSanitizeAttribute",e,a),i=a.attrValue,!a.forceKeepAttr&&(ut(c,e),a.keepAttr))if(w(/\/>/i,i))ut(c,e);else{Te&&(i=y(i,me," "),i=y(i,pe," "));var d=tt(e.nodeName);if(vt(d,r,i))try{l?e.setAttributeNS(l,c,i):e.setAttribute(c,i),m(t.removed)}catch(e){}}}yt("afterSanitizeAttributes",e,null)}},St=function e(t){var s=void 0,i=pt(t);for(yt("beforeSanitizeShadowDOM",t,null);s=i.nextNode();)yt("uponSanitizeShadowNode",s,null),ft(s)||(s.content instanceof r&&e(s.content),bt(s));yt("afterSanitizeShadowDOM",t,null)};return t.sanitize=function(i,n){var o=void 0,h=void 0,c=void 0,l=void 0,d=void 0;if((Ye=!i)&&(i="\x3c!--\x3e"),"string"!=typeof i&&!gt(i)){if("function"!=typeof i.toString)throw b("toString is not a function");if("string"!=typeof(i=i.toString()))throw b("dirty is not a string, aborting")}if(!t.isSupported){if("object"===W(e.toStaticHTML)||"function"==typeof e.toStaticHTML){if("string"==typeof i)return e.toStaticHTML(i);if(gt(i))return e.toStaticHTML(i.outerHTML)}return i}if(Ne||nt(n),t.removed=[],"string"==typeof i&&(Ke=!1),Ke);else if(i instanceof a)1===(h=(o=mt("\x3c!----\x3e")).ownerDocument.importNode(i,!0)).nodeType&&"BODY"===h.nodeName||"HTML"===h.nodeName?o=h:o.appendChild(h);else{if(!Le&&!Te&&!xe&&-1===i.indexOf("<"))return ie&&De?ie.createHTML(i):i;if(!(o=mt(i)))return Le?null:re}o&&Ue&&dt(o.firstChild);for(var u=pt(Ke?i:o);c=u.nextNode();)3===c.nodeType&&c===l||ft(c)||(c.content instanceof r&&St(c.content),bt(c),l=c);if(l=null,Ke)return i;if(Le){if(Oe)for(d=he.call(o.ownerDocument);o.firstChild;)d.appendChild(o.firstChild);else d=o;return Se.shadowroot&&(d=le.call(s,d,!0)),d}var m=xe?o.outerHTML:o.innerHTML;return Te&&(m=y(m,me," "),m=y(m,pe," ")),ie&&De?ie.createHTML(m):m},t.setConfig=function(e){nt(e),Ne=!0},t.clearConfig=function(){st=null,Ne=!1},t.isValidAttribute=function(e,t,s){st||nt({});var i=tt(e),r=tt(t);return vt(i,r,s)},t.addHook=function(e,t){"function"==typeof t&&(ue[e]=ue[e]||[],p(ue[e],t))},t.removeHook=function(e){ue[e]&&m(ue[e])},t.removeHooks=function(e){ue[e]&&(ue[e]=[])},t.removeAllHooks=function(){ue={}},t}return Q()}();/*! @license DOMPurify 2.3.4 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.4/LICENSE */class fa{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}}const va={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,ADD_TAGS:["mx-reply"]};function wa(e){return new Promise((function(t,s){var i=document.createElement("script");i.setAttribute("src",e),i.onload=t,i.onerror=s,document.body.appendChild(i)}))}class ba{constructor(e,t,s=null,i=null){this._config=t,this._container=e,this.settingsStorage=new Cr("hydrogen_setting_v1_"),this.clock=new Go,this.encoding=new zr,this.random=Math.random,this._createLogger(i?.development),this.history=new Yo,this.onlineStatus=new Xo,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new Qo,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=new Jo(this._serviceWorkerHandler,t.push),this.crypto=new ha(s),this.storageFactory=new $t(this._serviceWorkerHandler),this.sessionInfoStorage=new Rr("hydrogen_sessions_v1"),this.estimateStorageUsage=ca,"function"==typeof fetch?this.request=kr(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Ir;const r=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=r;const n=/iPad|iPhone|iPod/.test(navigator.platform)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=n,this._disposables=new Rs}_createLogger(e){const t=e=>(e.e?.stack&&(e.e.stack=e.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),e);this.logger=e?new Zr({platform:this}):new Yr({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return async function(e){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),e?(window.WebAssembly?(await wa(e.wasmBundle),await window.Olm.init({locateFile:()=>e.wasm})):(await wa(e.legacyBundle),await window.Olm.init()),window.Olm):null}(this._config.olm)}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return await async function(e){const t=new ua(e.worker,4);var s;return await t.init(),await t.sendAll({type:"load_olm",path:(s=e.olm.legacyBundle,s.startsWith("/")?s:new URL(s,document.location.href).pathname)}),new Gr(t)}(this._config)}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";const e=function(e){if(!window.visualViewport)return;const t=()=>{const t=e.querySelector(".SessionView");if(!t)return;const s=e.querySelector(".bottom-aligned-scroll");let i,r,n;s&&(i=s.scrollTop,r=s.offsetHeight);const o=t.offsetTop+t.offsetHeight-window.visualViewport.height;e.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),e.style.setProperty("--ios-viewport-top",o.toString()+"px"),s&&(n=s.offsetHeight,s.scrollTop=i+r-n)};return window.visualViewport.addEventListener("resize",t),()=>{window.visualViewport.removeEventListener("resize",t)}}(this._container);e&&this._disposables.track(e)}this._container.addEventListener("error",wn,!0),this._disposables.track((()=>this._container.removeEventListener("error",wn,!0))),window.__hydrogenViewModel=e;const t=new qo(e);this._container.appendChild(t.mount())}setNavigation(e){this._serviceWorkerHandler?.setNavigation(e)}createBlob(e,t){return d.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):async function(e,t,s,i,r){let n=e.querySelector("iframe.downloadSandbox");if(!n){let s;n=document.createElement("iframe"),n.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),n.setAttribute("src",t),n.className="hidden downloadSandbox",e.appendChild(n),await new Promise(((e,t)=>{s=()=>{n.removeEventListener("load",e),n.removeEventListener("error",t)},n.addEventListener("load",e),n.addEventListener("error",t)})),s()}if(r){const e=await s.readAsBuffer();n.contentWindow.postMessage({type:"downloadBuffer",buffer:e,mimeType:s.mimeType,filename:i},"*")}else n.contentWindow.postMessage({type:"downloadBlob",blob:s.nativeBlob,filename:i},"*")}(this._container,this._config.downloadSandbox,e,t,this.isIOS)}openFile(e=null){const t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);const s=new Promise((e=>{const s=()=>{t.removeEventListener("change",s,!0);const i=t.files[0];this._container.removeChild(t),i?e({name:i.name,blob:d.fromBlob(i)}):e()};t.addEventListener("change",s,!0)}));return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return function(e){const t=ya.sanitize(e,va),s=(new DOMParser).parseFromString(t,"text/html").body;return new fa(s)}(e)}async loadImage(e){return ma.fromBlob(e)}async loadVideo(e){return pa.fromBlob(e)}hasReadPixelPermission(){return function(){const e=document.createElement("canvas");e.width=1,e.height=1;const t=e.getContext("2d"),s=[Math.round(255*Math.random()),Math.round(255*Math.random()),Math.round(255*Math.random())];t.fillStyle=`rgb(${s[0]}, ${s[1]}, ${s[2]})`,t.fillRect(0,0,1,1);const i=t.getImageData(0,0,1,1).data;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]}()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.2.22"}dispose(){this._disposables.dispose()}}class Sa extends U{constructor(e={}){super(),this.disposables=null,this._isDisposed=!1,this._options=e}childOptions(e){const{navigation:t,urlCreator:s,platform:i}=this._options;return Object.assign({navigation:t,urlCreator:s,platform:i},e)}getOption(e){return this._options[e]}track(e){return this.disposables||(this.disposables=new Rs),this.disposables.track(e)}untrack(e){return this.disposables?this.disposables.untrack(e):null}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){return this.disposables?this.disposables.disposeTracked(e):null}i18n(e,...t){let s="";for(let i=0;i<e.length;++i)s+=e[i],i<t.length&&(s+=t[i]);return s}updateOptions(e){this._options=Object.assign(this._options,e)}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}}function Ia(e){let t=e.charAt(0);return"!"!==t&&"@"!==t&&"#"!==t||(t=e.charAt(1)),t.toUpperCase()}function Ea(e){return function(e){let t,s,i=0;if(0===e.length)return i;for(t=0;t<e.length;t++)s=e.charCodeAt(t),i=(i<<5)-i+s,i|=0;return Math.abs(i)}(e)%8+1}function ka(e,t,s,i){if(e){const r=t*s.devicePixelRatio;return i.mxcUrlThumbnail(e,r,r,"crop")}return null}const Ra=["invite","room"];class Ca extends Sa{constructor(e){super(e),this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Ra.indexOf(this.kind)-Ra.indexOf(e.kind):0}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this._avatarSource.avatarColorId)}avatarUrl(e){return ka(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}}class Aa extends Ca{constructor(e){super(e);const{room:t}=e;this._room=t,this._url=this.urlCreator.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){const t=super.compare(e);if(0!==t)return t;const s=this._room,i=e._room;if(s.isLowPriority!==i.isLowPriority)return s.isLowPriority?1:-1;const r=s.lastMessageTimestamp,n=i.lastMessageTimestamp,o=Number.isSafeInteger(r),a=Number.isSafeInteger(n);if(o!==a)return a?1:-1;const h=n-r;if(0===h||!a||!o){const t=this.name.localeCompare(e.name);return 0===t?this._room.id.localeCompare(e._room.id):t}return h}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return 0!==this._room.highlightCount}get _avatarSource(){return this._room}}class Ma extends Ca{constructor(e){super(e);const{invite:t}=e;this._invite=t,this._url=this.urlCreator.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}compare(e){const t=super.compare(e);return 0!==t?t:e._invite.timestamp-this._invite.timestamp}get name(){return this._invite.name}get _avatarSource(){return this._invite}}class Ta{constructor(e){this._parts=e.split(" ").map((e=>e.toLowerCase().trim()))}matches(e){const t=e.name.toLowerCase();return this._parts.every((e=>t.includes(e)))}}class xa extends rs{constructor(e,t){super(),this._source=e,this._apply=t,this._subscription=null}hasApply(){return!!this._apply}setApply(e){this._apply=e,e&&this.applyOnce(this._apply)}applyOnce(e){for(const[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription()}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}}class Na extends Sa{constructor(e){super(e);const{rooms:t,invites:s}=e;this._tileViewModelsMap=this._mapTileViewModels(t,s),this._tileViewModelsFilterMap=new xa(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues(((e,t)=>e.compare(t))),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlCreator.urlForSegment("session"),this._settingsUrl=this.urlCreator.urlForSegment("settings")}_mapTileViewModels(e,t){return t.join(e).mapValues(((e,t)=>{let s;s=e.isInvite?new Ma(this.childOptions({invite:e,emitChange:t})):new Aa(this.childOptions({room:e,emitChange:t}));return this.navigation.path.get("room")?.value===e.id&&(s.open(),this._updateCurrentVM(s)),s}))}_updateCurrentVM(e){this._currentTileVM?.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}_setupNavigation(){const e=this.navigation.observe("room");this.track(e.subscribe((e=>this._open(e))));const t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe((e=>{const t=this.gridEnabled^!!e;this.gridEnabled=!!e,t&&this.emitChange("gridEnabled")})))}_open(e){this._currentTileVM?.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),this._currentTileVM?.open())}toggleGrid(){const e=this.navigation.path.get("room");let t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=fr(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=fr(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce(((e,t)=>t.hidden=!1))}setFilter(e){if(0===(e=e.trim()).length)return this.clearFilter(),!1;{const t=!this._tileViewModelsFilterMap.hasApply(),s=new Ta(e);return this._tileViewModelsFilterMap.setApply(((e,t)=>{t.hidden=!s.matches(t)})),t}}}class Ua{constructor(e,t,s,i){this._remove=e,this._update=t,this._replace=s,this._updateParams=i}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new Ua(!0,!1,!1,null)}static Update(e){return new Ua(!1,!0,!1,e)}static Nothing(){return new Ua(!1,!1,!1,null)}static Replace(e){return new Ua(!1,!1,!0,e)}}class La extends ss{constructor(e,t){super(),this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileCreator=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_emitSpontanousUpdate(e,t){const s=e.lowerEntry,i=this._findTileIdx(s);this.emitUpdate(i,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let t of this._entries)e&&e.tryIncludeEntry(t)||(e=this._tileCreator(t),e&&this._tiles.push(e));let t=null;for(let e of this._tiles)t&&t.updateNextSibling(e),e.updatePreviousSibling(t),t=e;t&&t.updateNextSibling(null);for(const e of this._tiles)e.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return is(this._tiles,e,((e,t)=>-t.compareEntry(e)))}_findTileAtIdx(e,t){const s=this._getTileAtIdx(t);if(s&&0===s.compareEntry(e))return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){const s=this._findTileIdx(t),i=this._getTileAtIdx(s-1);if(i&&i.tryIncludeEntry(t))return void this.emitUpdate(s-1,i);const r=this._getTileAtIdx(s);if(r&&r.tryIncludeEntry(t))return void this.emitUpdate(s,r);const n=this._tileCreator(t);n&&(i&&(i.updateNextSibling(n),n.updatePreviousSibling(i)),r&&(n.updateNextSibling(r),r.updatePreviousSibling(n)),this._tiles.splice(s,0,n),this.emitAdd(s,n),n.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,s){if(!this._tiles)return;const i=this._findTileIdx(t),r=this._findTileAtIdx(t,i);if(r){const e=r.updateEntry(t,s);if(e.shouldReplace){const s=this._tileCreator(t);s?(this._replaceTile(i,r,s,e.updateParams),s.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(i,r)}e.shouldRemove&&this._removeTile(i,r),e.shouldUpdate&&this.emitUpdate(i,r,e.updateParams)}}_replaceTile(e,t,s,i){t.dispose();const r=this._getTileAtIdx(e-1),n=this._getTileAtIdx(e+1);this._tiles[e]=s,r?.updateNextSibling(s),s.updatePreviousSibling(r),s.updateNextSibling(n),n?.updatePreviousSibling(s),this.emitUpdate(e,s,i)}_removeTile(e,t){const s=this._getTileAtIdx(e-1),i=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s?.updateNextSibling(i),i?.updatePreviousSibling(s)}onRemove(e,t){const s=this._findTileIdx(t),i=this._findTileAtIdx(t,s);if(i){i.removeEntry(t)?this._removeTile(s,i):this.emitUpdate(s,i)}}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){const t=is(this._tiles,e,((e,t)=>e.compare(t)));return 0===this._tiles[t]?.compare(e)?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}}class Oa extends Sa{constructor(e){super(e);const{timeline:t,tilesCreator:s}=e;this._timeline=this.track(t),this._tiles=new La(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then((()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1})),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;const i=this._tiles.getTileIndex(this._startTile),r=this._tiles.getTileIndex(this._endTile);for(const e of this._tiles.sliceIterator(i,r+1))e.notifyVisible();s=i<10,this._setShowJumpDown(r<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then((e=>{this._topLoadingPromise=null,e||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)})))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}}class Da extends Sa{constructor(e){super(),this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){(new Boolean(e)!==new Boolean(this._replyVM)||!this._replyVM?.id.equals(e.asEventKey()))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e))),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){const t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){const t=this._isEmpty;this._isEmpty=0===e.length,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}}class Ba extends Sa{constructor(e){super(e),this._entry=e.entry}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==_e.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){this._entry.pendingEvent?.abort()}setUpdateEmit(e){this.updateOptions({emitChange:t=>{e&&e(this,t)}})}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){const s="redacted"===this.shape;return e.isGap||e.isRedacted===s?(this._entry=e,Ua.Update(t)):Ua.Replace("shape")}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}}class Pa extends Ba{constructor(e){super(e),this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:\n${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e,t=0;this._siblingChanged=!1;do{e=await this.fill(),t+=1}while(t<10&&!this._siblingChanged&&e&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);const t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?Ua.Nothing():Ua.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){if(this._error){return`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`}return null}}class Ka{constructor(e){this._parentTile=e,this._map=new ns,this._reactions=this._map.sortValues(((e,t)=>e._compare(t)))}update(e,t){if(e)for(const t in e)if(e.hasOwnProperty(t)){const s=e[t],i=this._map.get(t);i?i._tryUpdate(s)&&this._map.update(t):this._map.add(t,new Va(t,s,null,this._parentTile))}if(t)for(const[e,s]of t.entries()){const t=this._map.get(e);t?(t._tryUpdatePending(s),this._map.update(e)):this._map.add(e,new Va(e,null,s,this._parentTile))}for(const s of this._map.keys()){const i=t?.has(s),r=e?.hasOwnProperty(s);r||i?r?i||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s):this._map.remove(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}}class Va{constructor(e,t,s,i){this._key=e,this._annotation=t,this._pending=s,this._parentTile=i,this._isToggling=!1}_tryUpdate(e){const t=!!this._annotation!=!!e,s=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return!(!t&&!s)&&(this._annotation=e,!0)}_tryUpdatePending(e){return!(!e&&!this._pending)&&(this._pending=e,!0)}get key(){return this._key}get count(){return(this._pending?.count||0)+(this._annotation?.count||0)}get isPending(){return null!==this._pending}get isActive(){return this._annotation?.me||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{const t=this.firstTimestamp-e.firstTimestamp;return 0===t?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling)console.log("busy toggling reaction already");else{this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}}}class Fa extends Ba{constructor(e){super(e),this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions()}get _mediaRepository(){return this._room.mediaRepository}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return Ea(this._entry.sender)}avatarUrl(e){return ka(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return Ia(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof Fa&&e.sender===this.sender){t=this._entry.timestamp-e._entry.timestamp<3e5}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){const s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),s}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,s=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,s)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return"redacted"!==this.shape?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",(async t=>{if(!this.canReact)return void t.set("powerlevel_lacking",!0);if(this._entry.haveAnnotation(e))return void t.set("already_reacted",!0);const s=this._entry.pendingAnnotations?.get(e)?.redactionEntry;s&&!s.pendingEvent.hasStartedSending?(t.set("abort_redaction",!0),await s.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,t)}))}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",(async t=>{if(!this._powerLevels.canRedactFromSender(this._ownMember.userId))return void t.set("powerlevel_lacking",!0);if(!this._entry.haveAnnotation(e))return void t.set("not_yet_reacted",!0);let s=this._entry.pendingAnnotations?.get(e)?.annotationEntry;s||(s=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),s?await this._room.sendRedaction(s.id,null,t):t.set("no_reaction",!0)}))}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",(async t=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,t):await this.react(e,t)}))}_updateReactions(){const{annotations:e,pendingAnnotations:t}=this._entry;e||t?(this._reactions||(this._reactions=new Ka(this)),this._reactions.update(e,t)):this._reactions&&(this._reactions=null)}}const $a=new RegExp("(?:https|http|ftp):\\/\\/[a-zA-Z0-9:.\\[\\]-]*(?=[a-zA-Z0-9:.\\[\\]-])[^\\s.,?!)](?:[\\/#](?:[^\\s]*[^\\s.,?!)])?)?","gi");function ja(e,t){const s=e.matchAll($a);let i=0;for(let r of s){t(e.slice(i,r.index),!1),t(r[0],!0);const s=r[0].length;i=r.index+s}t(e.slice(i),!1)}class qa{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}}class Wa{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}}class Ha{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}}class za{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}}class Ga{get type(){return"rule"}}class Qa{get type(){return"newline"}}class Ja{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}}class Ya{constructor(e,t,s,i,r){this.src=e,this.width=t,this.height=s,this.alt=i,this.title=r}get type(){return"image"}}class Xa{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return Ea(this.id)}get avatarInitials(){return Ia(this.id)}}class Za{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}}class eh{constructor(e){this.text=e}get type(){return"text"}}class th{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&("format"===(s=this.parts[t]).type&&"blockquote"===s.format);t++);var s;this.parts.splice(t,0,new eh(e))}}const sh=e("Plain","Html");class ih extends Fa{constructor(e){super(e),this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return function(e){return new th(e,[new eh(e)])}(e)}_getBodyFormat(){return sh.Plain}get body(){const e=this._getBody(),t=this._getBodyFormat();return this._messageBody&&this._messageBody.sourceString===e&&this._format===t||(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}}const rh=["EM","STRONG","CODE","DEL","SPAN"],nh=["DIV","BLOCKQUOTE"],oh=["https","http","ftp","mailto","magnet"].map((e=>`${e}://`));class ah{constructor(e,t,s){this.allowReplies=s,this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith("https://matrix.to/#/"))return null;const t=e.substring("https://matrix.to/#/".length);return"@"===t[0]?t:null}parseLink(e,t){const s=this.result.getAttributeValue(e,"href"),i=s?.toLowerCase();if(!i||!oh.some((e=>i.startsWith(e))))return new Ja("span",t);const r=this.parsePillLink(s);return r?new Xa(r,s,t):new Za(s,t)}parseList(e){const t=this.result;let s=null;"OL"===t.getNodeElementName(e)&&(s=parseInt(t.getAttributeValue(e,"start"))||1);const i=[];for(const s of t.getChildNodes(e)){if("LI"!==t.getNodeElementName(s))continue;const e=this.parseAnyNodes(t.getChildNodes(s));i.push(e)}return new Ha(s,i)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){const t=this.result;let s;for(const i of t.getChildNodes(e)){s=i;break}let i=null;if(!this._ensureElement(s,"CODE"))return new Wa(i,this.result.getNodeText(e));const r=t.getAttributeValue(s,"class")||"";for(const e of r.split(" "))if(e.startsWith("language-")&&!e.startsWith("language-_")){i=e.substring(9);break}return new Wa(i,this.result.getNodeText(s))}parseImage(e){const t=this.result,s=t.getAttributeValue(e,"src")||"",i=this.mediaRepository.mxcUrl(s);if(!i)return null;const r=parseInt(t.getAttributeValue(e,"width"))||null,n=parseInt(t.getAttributeValue(e,"height"))||null,o=t.getAttributeValue(e,"alt"),a=t.getAttributeValue(e,"title");return new Ya(i,r,n,o,a)}parseTableRow(e,t){const s=[];for(const i of this.result.getChildNodes(e)){if(!this._ensureElement(i,t))continue;const e=this.result.getChildNodes(i),r=this.parseInlineNodes(e);s.push(r)}return s}parseTableHead(e){let t=null;for(const s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){const t=[];for(const s of this.result.getChildNodes(e))this._ensureElement(s,"TR")&&t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){const t=Array.from(this.result.getChildNodes(e));let s,i;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),i=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,i=this.parseTableBody(t[0])),new za(s,i)}parseInlineElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"A":{const t=this.parseInlineNodes(i);return this.parseLink(e,t)}case"BR":return new Qa;default:{if(!rh.includes(s))return null;const e=this.parseInlineNodes(i);return new Ja(s,e)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){const t=this.result,s=t.getNodeElementName(e),i=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{const e=this.parseInlineNodes(i);return new qa(parseInt(s[1]),e)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Ga;case"IMG":return this.parseImage(e);case"P":{const e=this.parseInlineNodes(i);return new Ja(s,e)}case"TABLE":return this.parseTable(e);default:{if(!nh.includes(s))return null;const e=this.parseAnyNodes(i);return new Ja(s,e)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;return ja(this.result.getNodeText(e),((e,s)=>{s?t.push(new Za(e,[new eh(e)])):t.push(new eh(e))})),!0}_isAllowedNode(e){return this.allowReplies||!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const e=this.parseInlineNode(s);e?t.push(e):this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){const t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(const s of e){if(this._parseTextParts(s,t))continue;const e=this.parseInlineNode(s)||this.parseBlockNode(s);e?t.push(e):this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){const t=[];return this._parseAnyNodes(e,t),t}}class hh extends ih{_getContentString(e){return this._getContent()?.[e]||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===sh.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){return"org.matrix.custom.html"===this._getContent()?.format?sh.Html:sh.Plain}_parseBody(e,t){let s;return s=t===sh.Html?function(e,t,s,i){const r=e.parseHTML(i),n=new ah(r,t,s).parseAnyNodes(r.rootNodes);return new th(i,n)}(this.platform,this._mediaRepository,this._entry.isReply,e):function(e){const t=[],s=e.split("\n"),i=(e,s)=>{s?t.push(new Za(e,[new eh(e)])):t.push(new eh(e))};for(let e=0;e<s.length;e+=1){const r=s[e];r.length&&ja(r,i),e>=s.length-1||t.push(new Qa)}return new th(e,t)}(e),"m.emote"===this._getContent()?.msgtype&&s.insertEmote(`* ${this.displayName} `),s}}class ch extends Fa{get shape(){return"redacted"}get description(){const{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})…`:this.i18n`This message is being deleted…`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}}class lh extends Fa{constructor(e){super(e),this._decryptedThumbnail=null,this._decryptedFile=null,this._error=null,this.isPending||this._tryLoadEncryptedThumbnail()}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===_e.UploadingAttachments}get uploadPercentage(){const{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get sendStatus(){const{pendingEvent:e}=this._entry;switch(e?.status){case _e.Waiting:return this.i18n`Waiting…`;case _e.EncryptingAttachments:case _e.Encrypting:return this.i18n`Encrypting…`;case _e.UploadingAttachments:return this.i18n`Uploading…`;case _e.Sending:return this.i18n`Sending…`;case _e.Error:return this.i18n`Error: ${e.error.message}`;default:return""}}get thumbnailUrl(){if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{const e=this._getContent().info?.thumbnail_url;if(e)return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}if(this._entry.isPending){const e=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return e&&e.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{const e=this._getContent()?.url;if("string"==typeof e)return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}}return""}get width(){const e=this._getContent()?.info;return Math.round(e?.w*this._scaleFactor())}get height(){const e=this._getContent()?.info;return Math.round(e?.h*this._scaleFactor())}get mimeType(){const e=this._getContent()?.info;return e?.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){const t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(!this.isDisposed)return this.track(t);t.dispose()}async _tryLoadEncryptedThumbnail(){try{const e=this._getContent().info?.thumbnail_file,t=this._getContent().file;e?(this._decryptedThumbnail=await this._loadEncryptedFile(e),this.emitChange("thumbnailUrl")):t&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl"))}catch(e){this._error=e,this.emitChange("error")}}_scaleFactor(){const e=this._getContent()?.info,t=300/e?.h,s=400/e?.w;return Math.min(s,t,1)}_isMainResourceImage(){return!0}}class dh extends lh{constructor(e){super(e),this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}}class uh extends lh{async loadVideo(){const e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){if(this._decryptedFile)return this._decryptedFile.url;const e=this._getContent()?.url;return"string"==typeof e?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}}class mh extends Fa{constructor(e){super(e),this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;const e=this._getContent(),t=e.body;let s;this._downloading=!0,this.emitChange("label");try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(e){this._downloadError=e}finally{s?.dispose(),this._downloading=!1}this.emitChange("label")}get label(){if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;const e=this._getContent().body;if(!this._entry.isPending){const t=function(e,t=2){if(Number.isSafeInteger(e)){const s=Math.min(3,Math.floor(Math.log(e)/Math.log(1024))),i=Math.round(e/Math.pow(1024,s)).toFixed(t);switch(s){case 0:return`${i} bytes`;case 1:return`${i} KB`;case 2:return`${i} MB`;case 3:return`${i} GB`}}return""}(this._getContent().info?.size);return this._downloading?this.i18n`Downloading ${e} (${t})…`:this.i18n`Download ${e} (${t})`}{const{pendingEvent:t}=this._entry;switch(t?.status){case _e.Waiting:return this.i18n`Waiting to send ${e}…`;case _e.EncryptingAttachments:case _e.Encrypting:return this.i18n`Encrypting ${e}…`;case _e.UploadingAttachments:{const s=Math.round(t.attachmentsSentBytes/t.attachmentsTotalBytes*100);return this.i18n`Uploading ${e}: ${s}%`}case _e.Sending:case _e.Sent:return this.i18n`Sending ${e}…`;case _e.Error:return this.i18n`Error: could not send ${e}: ${t.error.message}`;default:return`Unknown send status for ${e}`}}}get shape(){return"file"}}class ph extends Fa{get mapsLink(){const e=this._getContent().geo_uri,[t,s]=e.split(":")[1].split(",");return`maps:${t} ${s}`}get label(){return`${this.sender} sent their location, click to see it in maps.`}}class _h extends Ba{get shape(){return"announcement"}get announcement(){const e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e?.name}"`}}class gh extends Ba{get shape(){return"announcement"}get announcement(){const{sender:e,content:t,prevContent:s,stateKey:i}=this._entry,r=this._entry.displayName||e,n=e===i?r:this._entry.content?.displayname||i,o=t&&t.membership,a=s&&s.membership;if("join"===a&&"join"===o){if(t.avatar_url!==s.avatar_url)return`${r} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${s.displayname??i} changed their name to ${t.displayname}`:`${i} removed their name (${s.displayname})`}else{if("join"===o)return`${n} joined the room`;if("invite"===o)return`${n} was invited to the room by ${r}`;if("invite"===a){if("join"===o)return`${n} accepted the invitation to join the room`;if("leave"===o)return`${n} declined the invitation to join the room`}else{if("leave"===o){if(i===e)return`${n} left the room`;{const e=t.reason;return`${n} was kicked from the room by ${r}${e?`: ${e}`:""}`}}if("ban"===o)return`${n} was banned from the room by ${r}`}}return`${e} membership changed to ${t.membership}`}}class yh extends ih{updateEntry(e,t){const s=super.updateEntry(e,t);return"m.room.encrypted"!==e.eventType?Ua.Replace("shape"):s}get shape(){return"message-status"}_getBody(){const e=this._entry.decryptionError,t=e?.code;let s;return s="MEGOLM_NO_SESSION"===t?this.i18n`The sender hasn't sent us the key for this message yet.`:e?.message||this.i18n`Could not decrypt message because of unknown reason.`,s}}class fh extends Ba{get shape(){return"announcement"}get announcement(){const e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}}class vh extends Fa{get shape(){return"missing-attachment"}get label(){const e=this._getContent().body;return"m.image"===this._getContent().msgtype?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}}class wh extends Sa{constructor(e){super(e);const{room:t}=e;this._room=t,this._timelineVM=null,this._tilesCreator=null,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=new Ih(this.childOptions({archivedRoom:t})):this._composerVM=new Da(this),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{const t=await this._room.openTimeline();this._tilesCreator=(e=this.childOptions({roomVM:this,timeline:t}),function(t,s){const i=Object.assign({entry:t,emitUpdate:s},e);if(t.isGap)return new Pa(i);if(t.isPending&&t.pendingEvent.isMissingAttachments)return new vh(i);if(t.eventType)switch(t.eventType){case"m.room.message":{if(t.isRedacted)return new ch(i);const e=t.content;switch(e&&e.msgtype){case"m.text":case"m.notice":case"m.emote":return new hh(i);case"m.image":return new dh(i);case"m.video":return new uh(i);case"m.file":return new mh(i);case"m.location":return new ph(i);default:return null}}case"m.room.name":return new _h(i);case"m.room.member":return new gh(i);case"m.room.encrypted":return t.isRedacted?new ch(i):new yh(i);case"m.room.encryption":return new fh(i);default:return null}}),this._timelineVM=this.track(new Oa(this.childOptions({tilesCreator:this._tilesCreator,timeline:t}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:\n${e.stack}`),this._timelineError=e,this.emitChange("error")}var e;this._clearUnreadAfterDelay()}async _clearUnreadAfterDelay(){if(!this._room.isArchived&&!this._clearUnreadTimout){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if("AbortError"!==e.name)throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._room.isArchived&&this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this._room.avatarColorId)}avatarUrl(e){return ka(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){return this._tilesCreator(e)}async _sendMessage(e,t){if(!this._room.isArchived&&e){try{let s="m.text";e.startsWith("/me ")&&(e=e.substr(4).trim(),s="m.emote"),t?await t.reply(s,e):await this._room.sendEvent("m.room.message",{msgtype:s,body:e})}catch(e){return console.error(`room.sendMessage(): ${e.message}:\n${e.stack}`),this._sendError=e,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{const e=await this.platform.openFile();if(!e)return;return this._sendFile(e)}catch(e){console.error(e)}}async _sendFile(e){const t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission())return void alert("Please allow canvas image data access, so we can scale your images down.");const e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(t){throw t instanceof window.MediaError&&4===t.code?new Error(`this browser does not support videos of type ${e?.blob.mimeType}.`):t}const s={body:e.name,msgtype:"m.video",info:Sh(t)},i={url:this._room.createAttachment(t.blob,e.name)},r=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),n=await t.scale(r);s.info.thumbnail_info=bh(n),i["info.thumbnail_url"]=this._room.createAttachment(n.blob,e.name),await this._room.sendEvent("m.room.message",s,i)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission())return void alert("Please allow canvas image data access, so we can scale your images down.");const e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob);const s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");s&&t.maxDimension>s&&(t=await t.scale(s));const i={body:e.name,msgtype:"m.image",info:bh(t)},r={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){const s=await t.scale(400);i.info.thumbnail_info=bh(s),r["info.thumbnail_url"]=this._room.createAttachment(s.blob,e.name)}await this._room.sendEvent("m.room.message",i,r)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}}function bh(e){return{w:e.width,h:e.height,mimetype:e.blob.mimeType,size:e.blob.size}}function Sh(e){const t=bh(e);return t.duration=e.duration,t}class Ih extends Sa{constructor(e){super(e),this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"archived"}}class Eh extends Sa{constructor(e){super(e);const{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1}get error(){return this._error?.message}async join(){this._busy=!0,this.emitChange("busy");try{const e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}}class kh extends Sa{constructor(e){super(e);const{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new Rh(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this._invite.avatarColorId)}avatarUrl(e){return ka(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){const e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" • ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}}class Rh{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this._member.userId)}avatarUrl(e){return ka(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}}class Ch extends Sa{constructor(e){super(e),this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlCreator.urlUntilSegment("room"),this._eventEntry=null,this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){const s=e.observeEvent(t);this.track(s.subscribe((t=>{this._loadEvent(e,t)}))),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;const{mediaRepository:s}=e;this._eventEntry=t;const{content:i}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,i.url?(this._unencryptedImageUrl=s.mxcUrl(i.url),this.emitChange("imageUrl")):i.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(i.file)),this.emitChange("imageUrl"))}get imageWidth(){return this._eventEntry?.content?.info?.w}get imageHeight(){return this._eventEntry?.content?.info?.h}get name(){return this._eventEntry?.content?.body}get sender(){return this._eventEntry?.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}}const Ah=e("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError");class Mh extends Sa{constructor(e){super(e);const{sync:t,reconnector:s,session:i}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=i,this._setupSessionBackupUrl=this.urlCreator.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){const e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsSessionBackup.subscribe((()=>{this.emitChange()})))}get setupSessionBackupUrl(){return this._setupSessionBackupUrl}get isShown(){return this._session.needsSessionBackup.get()&&!this._dismissSecretStorage||this._status!==Ah.Syncing}get statusLabel(){switch(this._status){case Ah.Disconnected:{const e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s…`}case Ah.Connecting:return this.i18n`Trying to reconnect now…`;case Ah.FirstSync:return this.i18n`Catching up with your conversations…`;case Ah.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsSessionBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case Ah.Connecting:case Ah.FirstSync:return!0;default:return!1}}_updateStatus(){const e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===Ah.Disconnected?this._retryTimer=this.track(this.clock.createInterval((()=>{this.emitChange("statusLabel")}),1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==w.Online)switch(e){case w.Reconnecting:return Ah.Connecting;case w.Waiting:return Ah.Disconnected}else{if(t===R.Syncing)return Ah.Syncing;switch(t){case R.InitialSync:case R.CatchupSync:return Ah.FirstSync;case R.Stopped:return Ah.SyncError}}}get isConnectNowShown(){return this._status===Ah.Disconnected}get isSecretStorageShown(){return this._status===Ah.Syncing&&this._session.needsSessionBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}}function Th(e){return e.map(((t,s)=>e.slice(0,s).includes(t)?void 0:t))}class xh extends Sa{constructor(e){super(e),this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe((e=>{"number"==typeof e&&this._setFocusIndex(e)}))),"number"==typeof e.get()&&(this._selectedIndex=e.get());const t=this.navigation.observe("room");this.track(t.subscribe((e=>{e&&this._setFocusRoom(e)})))}roomViewModelAt(e){return this._viewModelsObservables[e]?.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=fr(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;const t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=Th(e);let s=!1;if(t){const i=e.indexOf(t.id);-1!==i&&(this._viewModelsObservables[i]=this.track(t),t.subscribe((e=>this._refreshRoomViewModel(e))),s=!0)}this.setRoomIds(e);const i=this.navigation.path.get("room");if(i){const e=this._viewModelsObservables.findIndex((e=>e&&e.id===i.value));-1!==e&&(this._selectedIndex=e)}return s}setRoomIds(e){e=Th(e);let t=!1;const s=this._height*this._width;for(let i=0;i<s;i+=1){const s=e[i],r=this._viewModelsObservables[i];if(!r&&s||r&&r.id!==s){if(r&&(this._viewModelsObservables[i]=this.disposeTracked(r)),s){const e=this._createRoomViewModelObservable(s);this._viewModelsObservables[i]=this.track(e),e.subscribe((e=>this._refreshRoomViewModel(e))),e.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e?.focus()}releaseRoomViewModel(e){const t=this._viewModelsObservables.findIndex((t=>t&&t.id===e));if(-1!==t){const e=this._viewModelsObservables[t];return this.untrack(e),e.unsubscribeAll(),this._viewModelsObservables[t]=null,e}}_setFocusIndex(e){if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e;this._viewModelsObservables[this._selectedIndex]?.get()?.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){const t=this._viewModelsObservables.findIndex((t=>t?.id===e));t>=0&&this._setFocusIndex(t)}}const Nh=e("Enabled","SetupKey","SetupPhrase","Pending");class Uh extends Sa{constructor(e){super(e),this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._reevaluateStatus(),this.track(this._session.hasSecretStorageKey.subscribe((()=>{this._reevaluateStatus()&&this.emitChange("status")})))}_reevaluateStatus(){if(this._isBusy)return!1;let e;const t=this._session.hasSecretStorageKey.get();e=!0===t?this._session.sessionBackup?Nh.Enabled:Nh.SetupKey:!1===t?Nh.SetupKey:Nh.Pending;const s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up session backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){return this._session.sessionBackup?.version}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===Nh.SetupKey&&(this._status=Nh.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===Nh.SetupPhrase&&(this._status=Nh.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const i=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(i))}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials(oi.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials(oi.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}}class Lh{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}}class Oh extends Sa{constructor(e){super(e),this._updateService=e.updateService;const{sessionContainer:t}=e;this._sessionContainer=t,this._sessionBackupViewModel=this.track(new Uh(this.childOptions({session:this._session}))),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new Lh,this._isLoggingOut=!1}get _session(){return this._sessionContainer.session}async logout(){this._isLoggingOut=!0,await this._sessionContainer.logout(),this.emitChange("isLoggingOut"),this.navigation.push("session",!0)}get isLoggingOut(){return this._isLoggingOut}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){const e=this._session.fingerprintKey;return e?function(e){const t=Math.ceil(e.length/4);let s="";for(let i=0;i<t;i+=1)s+=(s.length?" ":"")+e.slice(4*i,4*(i+1));return s}(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){const{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){this.platform.updateService?.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get sessionBackupViewModel(){return this._sessionBackupViewModel}get storageQuota(){return this._formatBytes(this._estimate?.quota)}get storageUsage(){return this._formatBytes(this._estimate?.usage)}_formatBytes(e){return"number"==typeof e?Math.round(e/1048576).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}}class Dh extends h{constructor(e,t){super(null),this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){const{session:e}=this._sessionViewModel._sessionContainer,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe((async e=>{this.get()?.dispose(),this.set(await this._statusToViewModel(e))}))}async _statusToViewModel(e){return e.invited?this._sessionViewModel._createInviteViewModel(this.id):e.joined?this._sessionViewModel._createRoomViewModel(this.id):e.archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),this.get()?.dispose()}}class Bh extends Sa{constructor(e){super(e),this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this._room.avatarColorId)}avatarUrl(e){return ka(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}class Ph extends Sa{constructor(e){super(e),this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){const e=this.navigation.path.get("room").value;return`${this.urlCreator.openRoomActionUrl(e)}/member/${this._member.userId}`}_updatePreviousName(e){const t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this.userId)}avatarUrl(e){return ka(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}}class Kh{constructor(){this._map=new Map}_unDisambiguate(e,t){const s=t.indexOf(e);if(-1!==s){const[e]=t.splice(s,1);e.setDisambiguation(!1)}}_handlePreviousName(e){const t=e.previousName;if("string"!=typeof t)return;const s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),1===s.length){const e=s[0];e.setDisambiguation(!1),this._map.set(t,e)}}else this._map.delete(t)}_updateMap(e){const t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s)){if(-1!==s.findIndex((t=>t.userId===e.userId)))return;return s.push(e),s}if(e.userId!==s.userId){const i=[s,e];return this._map.set(t,i),i}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e);this._updateMap(e)?.forEach((e=>e.setDisambiguation(!0)))}}class Vh extends Sa{constructor(e){super(e);const t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe((()=>{})));const i=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues((e=>"join"===e.membership))).sortValues(function(e){const t=new Intl.Collator,s=e=>"@"===e.charAt(0)?e.slice(1):e;return function(i,r){const n=e.getUserLevel(i.userId),o=e.getUserLevel(r.userId);if(n!==o)return o-n;const a=s(i.name),h=s(r.name);return t.compare(a,h)}}(i)),this.nameDisambiguator=new Kh,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){return e.mapValues(((e,t)=>{const s=this.mediaRepository,i=new Ph(this.childOptions({member:e,emitChange:t,mediaRepository:s}));return this.nameDisambiguator.disambiguate(i),i}),((e,t,s)=>{e.updateFrom(s),this.nameDisambiguator.disambiguate(e)}))}}class Fh extends Sa{constructor(e){super(e),this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this.track(this._powerLevelsObservable.subscribe((()=>this._onPowerLevelsChange()))),this.track(this._observableMember.subscribe((()=>this._onMemberChange())))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:0===this.powerLevel?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return Ia(this.name)}get avatarColorNumber(){return Ea(this.userId)}avatarUrl(e){return ka(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){return this._powerLevelsObservable.get()?.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${this._member.userId}`}}class $h extends Sa{constructor(e){super(e),this._room=e.room,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track((()=>this._members.release())));const e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){const e=this.navigation.path.get("member").value,t=await this._room.observeMember(e);if(!t)return!1;return{observableMember:t,isEncrypted:this._room.isEncrypted,powerLevelsObservable:await this._room.observePowerLevels(),mediaRepository:this._room.mediaRepository}}_setupNavigation(){this._hookUpdaterToSegment("details",Bh,(()=>({room:this._room}))),this._hookUpdaterToSegment("members",Vh,(()=>this._getMemberListArguments())),this._hookUpdaterToSegment("member",Fh,(()=>this._getMemberDetailsArguments()),(()=>{const e=`${this.urlCreator.urlUntilSegment("room")}/members`;this.urlCreator.pushUrl(e)}))}_hookUpdaterToSegment(e,t,s,i){const r=this.navigation.observe(e),n=this._setupUpdater(e,t,s,i);this.track(r.subscribe(n))}_setupUpdater(e,t,s,i){const r=async(r=!1)=>{r||(this._activeViewModel=this.disposeTracked(this._activeViewModel));if(!!this.navigation.path.get(e)?.value){const e=await s();if(!e&&i)return void i();this._activeViewModel=this.track(new t(this.childOptions(e)))}this.emitChange("activeViewModel")};return r(!0),r}closePanel(){const e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){const e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}}class jh extends Sa{constructor(e){super(e);const{sessionContainer:t}=e;this._sessionContainer=this.track(t),this._sessionStatusViewModel=this.track(new Mh(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new Na(this.childOptions({invites:this._sessionContainer.session.invites,rooms:this._sessionContainer.session.rooms}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._setupNavigation()}_setupNavigation(){const e=this.navigation.observe("rooms");this.track(e.subscribe((e=>{this._updateGrid(e)}))),e.get()&&this._updateGrid(e.get());const t=this.navigation.observe("room");this.track(t.subscribe((e=>{this._gridViewModel||this._updateRoom(e),this._updateRightPanel()}))),this._gridViewModel||this._updateRoom(t.get());const s=this.navigation.observe("settings");this.track(s.subscribe((e=>{this._updateSettings(e)}))),this._updateSettings(s.get());const i=this.navigation.observe("lightbox");this.track(i.subscribe((e=>{this._updateLightbox(e)}))),this._updateLightbox(i.get());const r=this.navigation.observe("right-panel");this.track(r.subscribe((()=>this._updateRightPanel()))),this._updateRightPanel()}get id(){return this._sessionContainer.sessionId}start(){this._sessionStatusViewModel.start()}get activeMiddleViewModel(){return this._roomViewModelObservable?.get()||this._gridViewModel||this._settingsViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){return this._roomViewModelObservable?.get()}get rightPanelViewModel(){return this._rightPanelViewModel}_updateGrid(e){const t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new xh(this.childOptions({width:3,height:2,createRoomViewModelObservable:e=>new Dh(this,e)}))),this._roomViewModelObservable?.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){const e=this._gridViewModel.releaseRoomViewModel(s.value);e&&(this._roomViewModelObservable=this.track(e),this._roomViewModelObservable.subscribe((()=>{this.emitChange("activeMiddleViewModel")})))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModel(e){const t=this._sessionContainer.session.rooms.get(e);if(t){const e=new wh(this.childOptions({room:t}));return e.load(),e}return null}_createUnknownRoomViewModel(e){return new Eh(this.childOptions({roomIdOrAlias:e,session:this._sessionContainer.session}))}async _createArchivedRoomViewModel(e){const t=await this._sessionContainer.session.loadArchivedRoom(e);if(t){const e=new wh(this.childOptions({room:t}));return e.load(),e}return null}_createInviteViewModel(e){const t=this._sessionContainer.session.invites.get(e);return t?new kh(this.childOptions({invite:t,mediaRepository:this._sessionContainer.session.mediaRepository})):null}_updateRoom(e){if(this._roomViewModelObservable?.id===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e)return void this.emitChange("activeMiddleViewModel");const t=new Dh(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe((()=>{this.emitChange("activeMiddleViewModel")})),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new Oh(this.childOptions({sessionContainer:this._sessionContainer}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){const t=this._roomFromNavigation();this._lightboxViewModel=this.track(new Ch(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){const e=this.navigation.path.get("room")?.value;return this._sessionContainer.session.rooms.get(e)}_updateRightPanel(){this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel);if(!!this.navigation.path.get("right-panel")?.value){const e=this._roomFromNavigation();this._rightPanelViewModel=this.track(new $h(this.childOptions({room:e})))}this.emitChange("rightPanelViewModel")}}class qh extends Sa{constructor(e){super(),this._accountSetup=e,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new Wh(this,(e=>{this._dehydratedDevice=e,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")})))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}}class Wh extends Sa{constructor(e,t){super(),this._accountSetupViewModel=e,this._isBusy=!1,this._status=Nh.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){return this._accountSetupViewModel._dehydratedDevice?.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===Nh.SetupKey&&(this._status=Nh.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===Nh.SetupPhrase&&(this._status=Nh.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");const{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,i=await s.decrypt(e,t);this._decryptedCallback(i)}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(oi.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(oi.RecoveryKey,e)}disable(){}}class Hh extends Sa{constructor(e){super(e);const{sessionContainer:t,ready:s,homeserver:i,deleteSessionOnCancel:r}=e;this._sessionContainer=t,this._ready=s,this._homeserver=i,this._deleteSessionOnCancel=r,this._loading=!1,this._error=null,this.backUrl=this.urlCreator.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._sessionContainer.loadStatus.waitFor((e=>{e===rr.AccountSetup?this._accountSetupViewModel=new qh(this._sessionContainer.accountSetup):this._accountSetupViewModel=void 0,this.emitChange("loadLabel");return e===rr.FirstSync&&this._sessionContainer.sync.status.get()===R.CatchupSync||e===rr.LoginFailed||e===rr.Error||e===rr.Ready}));try{await this._waitHandle.promise}catch(e){return}const e=this._sessionContainer.loadStatus.get(),t=this._sessionContainer.loadError;if(e===rr.FirstSync||e===rr.Ready){const e=this._sessionContainer;this._sessionContainer=null,this._ready(e)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._sessionContainer&&(this._sessionContainer.dispose(),this._sessionContainer=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){const e=this._sessionContainer;return(!e||e.loadStatus.get()!==rr.AccountSetup)&&this._loading}get loadLabel(){const e=this._sessionContainer,t=this._getError();if(t||e&&e.loadStatus.get()===rr.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case rr.QueryAccount:return"Querying account encryption setup…";case rr.AccountSetup:return"";case rr.SessionSetup:return"Setting up your encryption keys…";case rr.Loading:return"Loading your conversations…";case rr.FirstSync:return"Getting your conversations from the server…";default:return this._sessionContainer.loadStatus.get()}return"Preparing…"}_getError(){return this._error||this._sessionContainer?.loadError}get hasError(){return!!this._getError()}async exportLogs(){const e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._sessionContainer.logout(),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}}class zh extends Sa{constructor(e){super(e);const{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s,this._isBusy=!1,this._errorMessage=""}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");let s="";switch(await this._attemptLogin(this._loginOptions.password(e,t))){case nr.Credentials:s=this.i18n`Your username and/or password don't seem to be correct.`;break;case nr.Connection:s=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case nr.Unknown:s=this.i18n`Something went wrong while checking your login and password.`}s&&this._showError(s)}}class Gh extends Sa{constructor(e){super(e),this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);const e=this._sso.createSSORedirectURL(this.urlCreator.createSSOCallbackURL());this.platform.openUrl(e)}}class Qh extends Sa{constructor(e){super(e);const{loginToken:t,sessionContainer:s,attemptLogin:i}=e;this._loginToken=t,this._sessionContainer=s,this._attemptLogin=i,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;const e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver");let t;try{t=await this._sessionContainer.queryLogin(e).result}catch(e){return void this._showError(e.message)}if(!t.token)return void this.navigation.push("session");let s="";switch(await this._attemptLogin(t.token(this._loginToken))){case nr.Credentials:s=this.i18n`Your login token is invalid.`;break;case nr.Connection:s=this.i18n`Can't connect to ${e}.`;break;case nr.Unknown:s=this.i18n`Something went wrong while checking your login token.`}s&&this._showError(s)}}class Jh extends Sa{constructor(e){super(e);const{ready:t,defaultHomeserver:s,createSessionContainer:i,loginToken:r}=e;this._createSessionContainer=i,this._ready=t,this._loginToken=r,this._sessionContainer=this._createSessionContainer(),this._loginOptions=null,this._passwordLoginViewModel=null,this._startSSOLoginViewModel=null,this._completeSSOLoginViewModel=null,this._loadViewModel=null,this._loadViewModelSubscription=null,this._homeserver=s,this._queriedHomeserver=null,this._errorMessage="",this._hideHomeserver=!1,this._isBusy=!1,this._abortHomeserverQueryTimeout=null,this._abortQueryOperation=null,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){return this._loginOptions?.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}async _initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new Qh(this.childOptions({sessionContainer:this._sessionContainer,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):await this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new zh(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new Gh(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){this._isBusy=e,this._passwordLoginViewModel?.setBusy(e),this._startSSOLoginViewModel?.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._sessionContainer.startWithLogin(e,{inspectAccountSetup:!0});const t=this._sessionContainer.loadStatus,s=t.waitFor((e=>e!==rr.Login));await s.promise,this._setBusy(!1);return t.get()===rr.LoginFailed?this._sessionContainer.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new Hh(this.childOptions({ready:e=>{this._sessionContainer=null,this._ready(e)},sessionContainer:this._sessionContainer,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",(()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)})))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._ssoLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=null,this._queriedHomeserver=null,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange(),this.disposeTracked(this._abortHomeserverQueryTimeout);const t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track((()=>t.abort()));try{await t.elapsed()}catch(e){if("AbortError"===e.name)return;throw e}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(this._homeserver!==this._queriedHomeserver&&""!==this._homeserver){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{const e=this._sessionContainer.queryLogin(this._homeserver);this._abortQueryOperation=this.track((()=>e.abort())),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if("AbortError"===e.name)return;this._loginOptions=null}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),this._loginOptions.sso||this._loginOptions.password||this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._sessionContainer&&this._sessionContainer.deleteSession()}}class Yh extends Sa{constructor(e,t){super(e),this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlCreator.urlForSegment("session",this.id)}get label(){const{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return Ea(this._sessionInfo.userId)}get avatarInitials(){return Ia(this._sessionInfo.userId)}}class Xh extends Sa{constructor(e){super(e),this._sessions=new _s(((e,t)=>e.id.localeCompare(t.id))),this._loadViewModel=null,this._error=null}async load(){const e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map((e=>new Yh(this.childOptions({sessionInfo:e}),this))))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlCreator.urlForSegment("login")}}class Zh extends Sa{constructor(e){super(e),this._createSessionContainer=e.createSessionContainer,this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._sessionViewModel=null,this._pendingSessionContainer=null}async load(){this.track(this.navigation.observe("login").subscribe((()=>this._applyNavigation()))),this.track(this.navigation.observe("session").subscribe((()=>this._applyNavigation()))),this.track(this.navigation.observe("sso").subscribe((()=>this._applyNavigation()))),this._applyNavigation(!0)}async _applyNavigation(e){const t=this.navigation.path.get("login"),s=this.navigation.path.get("session")?.value,i=this.navigation.path.get("sso")?.value;if(t)"login"!==this.activeSection&&this._showLogin();else if(!0===s)"picker"!==this.activeSection&&this._showPicker();else if(s){if(!this._sessionViewModel||this._sessionViewModel.id!==s)if(this._pendingSessionContainer&&this._pendingSessionContainer.sessionId===s){const e=this._pendingSessionContainer;this._pendingSessionContainer=null,this._showSession(e)}else this._pendingSessionContainer&&(this._pendingSessionContainer.dispose(),this._pendingSessionContainer=null),this._showSessionLoader(s)}else if(i)this.urlCreator.normalizeUrl(),"login"!==this.activeSection&&this._showLogin(i);else try{if(!e||!this.urlCreator.tryRestoreLastUrl()){const e=await this.platform.sessionInfoStorage.getAll();0===e.length?this.navigation.push("login"):1===e.length?this.navigation.push("session",e[0].id):this.navigation.push("session")}}catch(e){this._setSection((()=>this._error=e))}}async _showPicker(){this._setSection((()=>{this._sessionPickerViewModel=new Xh(this.childOptions())}));try{await this._sessionPickerViewModel.load()}catch(e){this._setSection((()=>this._error=e))}}_showLogin(e){this._setSection((()=>{this._loginViewModel=new Jh(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,createSessionContainer:this._createSessionContainer,ready:e=>{this._pendingSessionContainer=e,this.navigation.push("session",e.sessionId)},loginToken:e}))}))}_showSession(e){this._setSection((()=>{this._sessionViewModel=new jh(this.childOptions({sessionContainer:e})),this._sessionViewModel.start()}))}_showSessionLoader(e){const t=this._createSessionContainer();t.startWithExistingSession(e),this._setSection((()=>{this._sessionLoadViewModel=new Hh(this.childOptions({sessionContainer:t,ready:e=>this._showSession(e)})),this._sessionLoadViewModel.start()}))}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}}export{rr as LoadStatus,ba as Platform,Ws as Room,so as RoomView,wh as RoomViewModel,qo as RootView,Zh as RootViewModel,er as Session,or as SessionContainer,Uo as SessionView,jh as SessionViewModel,A as Sync,Ts as Timeline,Yn as TimelineView,Oa as TimelineViewModel,mr as createNavigation,pr as createRouter};//# sourceMappingURL=hydrogen-web.js.map
