var Yh=Object.create;var fn=Object.defineProperty;var Jh=Object.getOwnPropertyDescriptor;var Xh=Object.getOwnPropertyNames;var Zh=Object.getPrototypeOf,ep=Object.prototype.hasOwnProperty;var tp=i=>fn(i,"__esModule",{value:!0});var ut=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var sp=(i,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Xh(e))!ep.call(i,s)&&s!=="default"&&fn(i,s,{get:()=>e[s],enumerable:!(t=Jh(e,s))||t.enumerable});return i},vs=i=>sp(tp(fn(i!=null?Yh(Zh(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var Tn=ut((j_,nu)=>{"use strict";var ru=/[\\\"\x00-\x1F]/g,dt={};for(Gs=0;Gs<32;++Gs)dt[String.fromCharCode(Gs)]="\\U"+("0000"+Gs.toString(16)).slice(-4).toUpperCase();var Gs;dt["\b"]="\\b";dt["	"]="\\t";dt[`
`]="\\n";dt["\f"]="\\f";dt["\r"]="\\r";dt['"']='\\"';dt["\\"]="\\\\";function iu(i){return ru.lastIndex=0,i.replace(ru,function(e){return dt[e]})}function xn(i){switch(typeof i){case"string":return'"'+iu(i)+'"';case"number":return isFinite(i)?i:"null";case"boolean":return i;case"object":return i===null?"null":Array.isArray(i)?ap(i):lp(i);default:throw new Error("Cannot stringify: "+typeof i)}}function ap(i){for(var e="[",t="",s=0;s<i.length;++s)t+=e,e=",",t+=xn(i[s]);return e!=","?"[]":t+"]"}function lp(i){var e="{",t="",s=Object.keys(i);s.sort();for(var r=0;r<s.length;++r){var n=s[r];t+=e+'"'+iu(n)+'":',e=",",t+=xn(i[n])}return e!=","?"{}":t+"}"}nu.exports={stringify:xn}});var ca=ut(la=>{(function(){"use strict";for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),t=0;t<i.length;t++)e[i.charCodeAt(t)]=t;la.encode=function(s){var r=new Uint8Array(s),n,o=r.length,a="";for(n=0;n<o;n+=3)a+=i[r[n]>>2],a+=i[(r[n]&3)<<4|r[n+1]>>4],a+=i[(r[n+1]&15)<<2|r[n+2]>>6],a+=i[r[n+2]&63];return o%3==2?a=a.substring(0,a.length-1)+"=":o%3==1&&(a=a.substring(0,a.length-2)+"=="),a},la.decode=function(s){var r=s.length*.75,n=s.length,o,a=0,l,c,u,d;s[s.length-1]==="="&&(r--,s[s.length-2]==="="&&r--);var p=new ArrayBuffer(r),f=new Uint8Array(p);for(o=0;o<n;o+=4)l=e[s.charCodeAt(o)],c=e[s.charCodeAt(o+1)],u=e[s.charCodeAt(o+2)],d=e[s.charCodeAt(o+3)],f[a++]=l<<2|c>>4,f[a++]=(c&15)<<4|u>>2,f[a++]=(u&3)<<6|d&63;return p}})()});var Nd=ut(Ti=>{"use strict";Ti.byteLength=Rf;Ti.toByteArray=Mf;Ti.fromByteArray=Lf;var rt=[],qe=[],Tf=typeof Uint8Array!="undefined"?Uint8Array:Array,da="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(ss=0,Bd=da.length;ss<Bd;++ss)rt[ss]=da[ss],qe[da.charCodeAt(ss)]=ss;var ss,Bd;qe["-".charCodeAt(0)]=62;qe["_".charCodeAt(0)]=63;function Od(i){var e=i.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=i.indexOf("=");t===-1&&(t=e);var s=t===e?0:4-t%4;return[t,s]}function Rf(i){var e=Od(i),t=e[0],s=e[1];return(t+s)*3/4-s}function kf(i,e,t){return(e+t)*3/4-t}function Mf(i){var e,t=Od(i),s=t[0],r=t[1],n=new Tf(kf(i,s,r)),o=0,a=r>0?s-4:s,l;for(l=0;l<a;l+=4)e=qe[i.charCodeAt(l)]<<18|qe[i.charCodeAt(l+1)]<<12|qe[i.charCodeAt(l+2)]<<6|qe[i.charCodeAt(l+3)],n[o++]=e>>16&255,n[o++]=e>>8&255,n[o++]=e&255;return r===2&&(e=qe[i.charCodeAt(l)]<<2|qe[i.charCodeAt(l+1)]>>4,n[o++]=e&255),r===1&&(e=qe[i.charCodeAt(l)]<<10|qe[i.charCodeAt(l+1)]<<4|qe[i.charCodeAt(l+2)]>>2,n[o++]=e>>8&255,n[o++]=e&255),n}function Af(i){return rt[i>>18&63]+rt[i>>12&63]+rt[i>>6&63]+rt[i&63]}function Cf(i,e,t){for(var s,r=[],n=e;n<t;n+=3)s=(i[n]<<16&16711680)+(i[n+1]<<8&65280)+(i[n+2]&255),r.push(Af(s));return r.join("")}function Lf(i){for(var e,t=i.length,s=t%3,r=[],n=16383,o=0,a=t-s;o<a;o+=n)r.push(Cf(i,o,o+n>a?a:o+n));return s===1?(e=i[t-1],r.push(rt[e>>2]+rt[e<<4&63]+"==")):s===2&&(e=(i[t-2]<<8)+i[t-1],r.push(rt[e>>10]+rt[e>>4&63]+rt[e<<2&63]+"=")),r.join("")}});var Pd=ut(ma=>{ma.read=function(i,e,t,s,r){var n,o,a=r*8-s-1,l=(1<<a)-1,c=l>>1,u=-7,d=t?r-1:0,p=t?-1:1,f=i[e+d];for(d+=p,n=f&(1<<-u)-1,f>>=-u,u+=a;u>0;n=n*256+i[e+d],d+=p,u-=8);for(o=n&(1<<-u)-1,n>>=-u,u+=s;u>0;o=o*256+i[e+d],d+=p,u-=8);if(n===0)n=1-c;else{if(n===l)return o?NaN:(f?-1:1)*(1/0);o=o+Math.pow(2,s),n=n-c}return(f?-1:1)*o*Math.pow(2,n-s)};ma.write=function(i,e,t,s,r,n){var o,a,l,c=n*8-r-1,u=(1<<c)-1,d=u>>1,p=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=s?0:n-1,g=s?1:-1,w=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=u):(o=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-o))<1&&(o--,l*=2),o+d>=1?e+=p/l:e+=p*Math.pow(2,1-d),e*l>=2&&(o++,l/=2),o+d>=u?(a=0,o=u):o+d>=1?(a=(e*l-1)*Math.pow(2,r),o=o+d):(a=e*Math.pow(2,d-1)*Math.pow(2,r),o=0));r>=8;i[t+f]=a&255,f+=g,a/=256,r-=8);for(o=o<<r|a,c+=r;c>0;i[t+f]=o&255,f+=g,o/=256,c-=8);i[t+f-g]|=w*128}});var sm=ut(Os=>{"use strict";var ha=Nd(),Vs=Pd(),Fd=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;Os.Buffer=h;Os.SlowBuffer=Nf;Os.INSPECT_MAX_BYTES=50;var Ri=2147483647;Os.kMaxLength=Ri;h.TYPED_ARRAY_SUPPORT=Df();!h.TYPED_ARRAY_SUPPORT&&typeof console!="undefined"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Df(){try{let i=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(i,e),i.foo()===42}catch{return!1}}Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){if(!!h.isBuffer(this))return this.buffer}});Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){if(!!h.isBuffer(this))return this.byteOffset}});function yt(i){if(i>Ri)throw new RangeError('The value "'+i+'" is invalid for option "size"');let e=new Uint8Array(i);return Object.setPrototypeOf(e,h.prototype),e}function h(i,e,t){if(typeof i=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return pa(i)}return Ud(i,e,t)}h.poolSize=8192;function Ud(i,e,t){if(typeof i=="string")return qf(i,e);if(ArrayBuffer.isView(i))return Bf(i);if(i==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i);if(it(i,ArrayBuffer)||i&&it(i.buffer,ArrayBuffer)||typeof SharedArrayBuffer!="undefined"&&(it(i,SharedArrayBuffer)||i&&it(i.buffer,SharedArrayBuffer)))return ga(i,e,t);if(typeof i=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let s=i.valueOf&&i.valueOf();if(s!=null&&s!==i)return h.from(s,e,t);let r=Of(i);if(r)return r;if(typeof Symbol!="undefined"&&Symbol.toPrimitive!=null&&typeof i[Symbol.toPrimitive]=="function")return h.from(i[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i)}h.from=function(i,e,t){return Ud(i,e,t)};Object.setPrototypeOf(h.prototype,Uint8Array.prototype);Object.setPrototypeOf(h,Uint8Array);function Kd(i){if(typeof i!="number")throw new TypeError('"size" argument must be of type number');if(i<0)throw new RangeError('The value "'+i+'" is invalid for option "size"')}function Vf(i,e,t){return Kd(i),i<=0?yt(i):e!==void 0?typeof t=="string"?yt(i).fill(e,t):yt(i).fill(e):yt(i)}h.alloc=function(i,e,t){return Vf(i,e,t)};function pa(i){return Kd(i),yt(i<0?0:_a(i)|0)}h.allocUnsafe=function(i){return pa(i)};h.allocUnsafeSlow=function(i){return pa(i)};function qf(i,e){if((typeof e!="string"||e==="")&&(e="utf8"),!h.isEncoding(e))throw new TypeError("Unknown encoding: "+e);let t=jd(i,e)|0,s=yt(t),r=s.write(i,e);return r!==t&&(s=s.slice(0,r)),s}function fa(i){let e=i.length<0?0:_a(i.length)|0,t=yt(e);for(let s=0;s<e;s+=1)t[s]=i[s]&255;return t}function Bf(i){if(it(i,Uint8Array)){let e=new Uint8Array(i);return ga(e.buffer,e.byteOffset,e.byteLength)}return fa(i)}function ga(i,e,t){if(e<0||i.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(i.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');let s;return e===void 0&&t===void 0?s=new Uint8Array(i):t===void 0?s=new Uint8Array(i,e):s=new Uint8Array(i,e,t),Object.setPrototypeOf(s,h.prototype),s}function Of(i){if(h.isBuffer(i)){let e=_a(i.length)|0,t=yt(e);return t.length===0||i.copy(t,0,0,e),t}if(i.length!==void 0)return typeof i.length!="number"||va(i.length)?yt(0):fa(i);if(i.type==="Buffer"&&Array.isArray(i.data))return fa(i.data)}function _a(i){if(i>=Ri)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Ri.toString(16)+" bytes");return i|0}function Nf(i){return+i!=i&&(i=0),h.alloc(+i)}h.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==h.prototype};h.compare=function(e,t){if(it(e,Uint8Array)&&(e=h.from(e,e.offset,e.byteLength)),it(t,Uint8Array)&&(t=h.from(t,t.offset,t.byteLength)),!h.isBuffer(e)||!h.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let s=e.length,r=t.length;for(let n=0,o=Math.min(s,r);n<o;++n)if(e[n]!==t[n]){s=e[n],r=t[n];break}return s<r?-1:r<s?1:0};h.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};h.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return h.alloc(0);let s;if(t===void 0)for(t=0,s=0;s<e.length;++s)t+=e[s].length;let r=h.allocUnsafe(t),n=0;for(s=0;s<e.length;++s){let o=e[s];if(it(o,Uint8Array))n+o.length>r.length?(h.isBuffer(o)||(o=h.from(o)),o.copy(r,n)):Uint8Array.prototype.set.call(r,o,n);else if(h.isBuffer(o))o.copy(r,n);else throw new TypeError('"list" argument must be an Array of Buffers');n+=o.length}return r};function jd(i,e){if(h.isBuffer(i))return i.length;if(ArrayBuffer.isView(i)||it(i,ArrayBuffer))return i.byteLength;if(typeof i!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof i);let t=i.length,s=arguments.length>2&&arguments[2]===!0;if(!s&&t===0)return 0;let r=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return wa(i).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return tm(i).length;default:if(r)return s?-1:wa(i).length;e=(""+e).toLowerCase(),r=!0}}h.byteLength=jd;function Pf(i,e,t){let s=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(i||(i="utf8");;)switch(i){case"hex":return Qf(this,e,t);case"utf8":case"utf-8":return Wd(this,e,t);case"ascii":return zf(this,e,t);case"latin1":case"binary":return Gf(this,e,t);case"base64":return Hf(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Yf(this,e,t);default:if(s)throw new TypeError("Unknown encoding: "+i);i=(i+"").toLowerCase(),s=!0}}h.prototype._isBuffer=!0;function rs(i,e,t){let s=i[e];i[e]=i[t],i[t]=s}h.prototype.swap16=function(){let e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)rs(this,t,t+1);return this};h.prototype.swap32=function(){let e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)rs(this,t,t+3),rs(this,t+1,t+2);return this};h.prototype.swap64=function(){let e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)rs(this,t,t+7),rs(this,t+1,t+6),rs(this,t+2,t+5),rs(this,t+3,t+4);return this};h.prototype.toString=function(){let e=this.length;return e===0?"":arguments.length===0?Wd(this,0,e):Pf.apply(this,arguments)};h.prototype.toLocaleString=h.prototype.toString;h.prototype.equals=function(e){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:h.compare(this,e)===0};h.prototype.inspect=function(){let e="",t=Os.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"};Fd&&(h.prototype[Fd]=h.prototype.inspect);h.prototype.compare=function(e,t,s,r,n){if(it(e,Uint8Array)&&(e=h.from(e,e.offset,e.byteLength)),!h.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),s===void 0&&(s=e?e.length:0),r===void 0&&(r=0),n===void 0&&(n=this.length),t<0||s>e.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&t>=s)return 0;if(r>=n)return-1;if(t>=s)return 1;if(t>>>=0,s>>>=0,r>>>=0,n>>>=0,this===e)return 0;let o=n-r,a=s-t,l=Math.min(o,a),c=this.slice(r,n),u=e.slice(t,s);for(let d=0;d<l;++d)if(c[d]!==u[d]){o=c[d],a=u[d];break}return o<a?-1:a<o?1:0};function $d(i,e,t,s,r){if(i.length===0)return-1;if(typeof t=="string"?(s=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,va(t)&&(t=r?0:i.length-1),t<0&&(t=i.length+t),t>=i.length){if(r)return-1;t=i.length-1}else if(t<0)if(r)t=0;else return-1;if(typeof e=="string"&&(e=h.from(e,s)),h.isBuffer(e))return e.length===0?-1:Hd(i,e,t,s,r);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?r?Uint8Array.prototype.indexOf.call(i,e,t):Uint8Array.prototype.lastIndexOf.call(i,e,t):Hd(i,[e],t,s,r);throw new TypeError("val must be string, number or Buffer")}function Hd(i,e,t,s,r){let n=1,o=i.length,a=e.length;if(s!==void 0&&(s=String(s).toLowerCase(),s==="ucs2"||s==="ucs-2"||s==="utf16le"||s==="utf-16le")){if(i.length<2||e.length<2)return-1;n=2,o/=2,a/=2,t/=2}function l(u,d){return n===1?u[d]:u.readUInt16BE(d*n)}let c;if(r){let u=-1;for(c=t;c<o;c++)if(l(i,c)===l(e,u===-1?0:c-u)){if(u===-1&&(u=c),c-u+1===a)return u*n}else u!==-1&&(c-=c-u),u=-1}else for(t+a>o&&(t=o-a),c=t;c>=0;c--){let u=!0;for(let d=0;d<a;d++)if(l(i,c+d)!==l(e,d)){u=!1;break}if(u)return c}return-1}h.prototype.includes=function(e,t,s){return this.indexOf(e,t,s)!==-1};h.prototype.indexOf=function(e,t,s){return $d(this,e,t,s,!0)};h.prototype.lastIndexOf=function(e,t,s){return $d(this,e,t,s,!1)};function Ff(i,e,t,s){t=Number(t)||0;let r=i.length-t;s?(s=Number(s),s>r&&(s=r)):s=r;let n=e.length;s>n/2&&(s=n/2);let o;for(o=0;o<s;++o){let a=parseInt(e.substr(o*2,2),16);if(va(a))return o;i[t+o]=a}return o}function Uf(i,e,t,s){return ki(wa(e,i.length-t),i,t,s)}function Kf(i,e,t,s){return ki(eg(e),i,t,s)}function jf(i,e,t,s){return ki(tm(e),i,t,s)}function $f(i,e,t,s){return ki(tg(e,i.length-t),i,t,s)}h.prototype.write=function(e,t,s,r){if(t===void 0)r="utf8",s=this.length,t=0;else if(s===void 0&&typeof t=="string")r=t,s=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(s)?(s=s>>>0,r===void 0&&(r="utf8")):(r=s,s=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let n=this.length-t;if((s===void 0||s>n)&&(s=n),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let o=!1;for(;;)switch(r){case"hex":return Ff(this,e,t,s);case"utf8":case"utf-8":return Uf(this,e,t,s);case"ascii":case"latin1":case"binary":return Kf(this,e,t,s);case"base64":return jf(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return $f(this,e,t,s);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}};h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Hf(i,e,t){return e===0&&t===i.length?ha.fromByteArray(i):ha.fromByteArray(i.slice(e,t))}function Wd(i,e,t){t=Math.min(i.length,t);let s=[],r=e;for(;r<t;){let n=i[r],o=null,a=n>239?4:n>223?3:n>191?2:1;if(r+a<=t){let l,c,u,d;switch(a){case 1:n<128&&(o=n);break;case 2:l=i[r+1],(l&192)==128&&(d=(n&31)<<6|l&63,d>127&&(o=d));break;case 3:l=i[r+1],c=i[r+2],(l&192)==128&&(c&192)==128&&(d=(n&15)<<12|(l&63)<<6|c&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:l=i[r+1],c=i[r+2],u=i[r+3],(l&192)==128&&(c&192)==128&&(u&192)==128&&(d=(n&15)<<18|(l&63)<<12|(c&63)<<6|u&63,d>65535&&d<1114112&&(o=d))}}o===null?(o=65533,a=1):o>65535&&(o-=65536,s.push(o>>>10&1023|55296),o=56320|o&1023),s.push(o),r+=a}return Wf(s)}var zd=4096;function Wf(i){let e=i.length;if(e<=zd)return String.fromCharCode.apply(String,i);let t="",s=0;for(;s<e;)t+=String.fromCharCode.apply(String,i.slice(s,s+=zd));return t}function zf(i,e,t){let s="";t=Math.min(i.length,t);for(let r=e;r<t;++r)s+=String.fromCharCode(i[r]&127);return s}function Gf(i,e,t){let s="";t=Math.min(i.length,t);for(let r=e;r<t;++r)s+=String.fromCharCode(i[r]);return s}function Qf(i,e,t){let s=i.length;(!e||e<0)&&(e=0),(!t||t<0||t>s)&&(t=s);let r="";for(let n=e;n<t;++n)r+=sg[i[n]];return r}function Yf(i,e,t){let s=i.slice(e,t),r="";for(let n=0;n<s.length-1;n+=2)r+=String.fromCharCode(s[n]+s[n+1]*256);return r}h.prototype.slice=function(e,t){let s=this.length;e=~~e,t=t===void 0?s:~~t,e<0?(e+=s,e<0&&(e=0)):e>s&&(e=s),t<0?(t+=s,t<0&&(t=0)):t>s&&(t=s),t<e&&(t=e);let r=this.subarray(e,t);return Object.setPrototypeOf(r,h.prototype),r};function se(i,e,t){if(i%1!=0||i<0)throw new RangeError("offset is not uint");if(i+e>t)throw new RangeError("Trying to access beyond buffer length")}h.prototype.readUintLE=h.prototype.readUIntLE=function(e,t,s){e=e>>>0,t=t>>>0,s||se(e,t,this.length);let r=this[e],n=1,o=0;for(;++o<t&&(n*=256);)r+=this[e+o]*n;return r};h.prototype.readUintBE=h.prototype.readUIntBE=function(e,t,s){e=e>>>0,t=t>>>0,s||se(e,t,this.length);let r=this[e+--t],n=1;for(;t>0&&(n*=256);)r+=this[e+--t]*n;return r};h.prototype.readUint8=h.prototype.readUInt8=function(e,t){return e=e>>>0,t||se(e,1,this.length),this[e]};h.prototype.readUint16LE=h.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||se(e,2,this.length),this[e]|this[e+1]<<8};h.prototype.readUint16BE=h.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||se(e,2,this.length),this[e]<<8|this[e+1]};h.prototype.readUint32LE=h.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||se(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216};h.prototype.readUint32BE=h.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||se(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])};h.prototype.readBigUInt64LE=Mt(function(e){e=e>>>0,Bs(e,"offset");let t=this[e],s=this[e+7];(t===void 0||s===void 0)&&br(e,this.length-8);let r=t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,n=this[++e]+this[++e]*2**8+this[++e]*2**16+s*2**24;return BigInt(r)+(BigInt(n)<<BigInt(32))});h.prototype.readBigUInt64BE=Mt(function(e){e=e>>>0,Bs(e,"offset");let t=this[e],s=this[e+7];(t===void 0||s===void 0)&&br(e,this.length-8);let r=t*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],n=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+s;return(BigInt(r)<<BigInt(32))+BigInt(n)});h.prototype.readIntLE=function(e,t,s){e=e>>>0,t=t>>>0,s||se(e,t,this.length);let r=this[e],n=1,o=0;for(;++o<t&&(n*=256);)r+=this[e+o]*n;return n*=128,r>=n&&(r-=Math.pow(2,8*t)),r};h.prototype.readIntBE=function(e,t,s){e=e>>>0,t=t>>>0,s||se(e,t,this.length);let r=t,n=1,o=this[e+--r];for(;r>0&&(n*=256);)o+=this[e+--r]*n;return n*=128,o>=n&&(o-=Math.pow(2,8*t)),o};h.prototype.readInt8=function(e,t){return e=e>>>0,t||se(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]};h.prototype.readInt16LE=function(e,t){e=e>>>0,t||se(e,2,this.length);let s=this[e]|this[e+1]<<8;return s&32768?s|4294901760:s};h.prototype.readInt16BE=function(e,t){e=e>>>0,t||se(e,2,this.length);let s=this[e+1]|this[e]<<8;return s&32768?s|4294901760:s};h.prototype.readInt32LE=function(e,t){return e=e>>>0,t||se(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24};h.prototype.readInt32BE=function(e,t){return e=e>>>0,t||se(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]};h.prototype.readBigInt64LE=Mt(function(e){e=e>>>0,Bs(e,"offset");let t=this[e],s=this[e+7];(t===void 0||s===void 0)&&br(e,this.length-8);let r=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(s<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)});h.prototype.readBigInt64BE=Mt(function(e){e=e>>>0,Bs(e,"offset");let t=this[e],s=this[e+7];(t===void 0||s===void 0)&&br(e,this.length-8);let r=(t<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+s)});h.prototype.readFloatLE=function(e,t){return e=e>>>0,t||se(e,4,this.length),Vs.read(this,e,!0,23,4)};h.prototype.readFloatBE=function(e,t){return e=e>>>0,t||se(e,4,this.length),Vs.read(this,e,!1,23,4)};h.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||se(e,8,this.length),Vs.read(this,e,!0,52,8)};h.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||se(e,8,this.length),Vs.read(this,e,!1,52,8)};function xe(i,e,t,s,r,n){if(!h.isBuffer(i))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>r||e<n)throw new RangeError('"value" argument is out of bounds');if(t+s>i.length)throw new RangeError("Index out of range")}h.prototype.writeUintLE=h.prototype.writeUIntLE=function(e,t,s,r){if(e=+e,t=t>>>0,s=s>>>0,!r){let a=Math.pow(2,8*s)-1;xe(this,e,t,s,a,0)}let n=1,o=0;for(this[t]=e&255;++o<s&&(n*=256);)this[t+o]=e/n&255;return t+s};h.prototype.writeUintBE=h.prototype.writeUIntBE=function(e,t,s,r){if(e=+e,t=t>>>0,s=s>>>0,!r){let a=Math.pow(2,8*s)-1;xe(this,e,t,s,a,0)}let n=s-1,o=1;for(this[t+n]=e&255;--n>=0&&(o*=256);)this[t+n]=e/o&255;return t+s};h.prototype.writeUint8=h.prototype.writeUInt8=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,1,255,0),this[t]=e&255,t+1};h.prototype.writeUint16LE=h.prototype.writeUInt16LE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2};h.prototype.writeUint16BE=h.prototype.writeUInt16BE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2};h.prototype.writeUint32LE=h.prototype.writeUInt32LE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4};h.prototype.writeUint32BE=h.prototype.writeUInt32BE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function Gd(i,e,t,s,r){em(e,s,r,i,t,7);let n=Number(e&BigInt(4294967295));i[t++]=n,n=n>>8,i[t++]=n,n=n>>8,i[t++]=n,n=n>>8,i[t++]=n;let o=Number(e>>BigInt(32)&BigInt(4294967295));return i[t++]=o,o=o>>8,i[t++]=o,o=o>>8,i[t++]=o,o=o>>8,i[t++]=o,t}function Qd(i,e,t,s,r){em(e,s,r,i,t,7);let n=Number(e&BigInt(4294967295));i[t+7]=n,n=n>>8,i[t+6]=n,n=n>>8,i[t+5]=n,n=n>>8,i[t+4]=n;let o=Number(e>>BigInt(32)&BigInt(4294967295));return i[t+3]=o,o=o>>8,i[t+2]=o,o=o>>8,i[t+1]=o,o=o>>8,i[t]=o,t+8}h.prototype.writeBigUInt64LE=Mt(function(e,t=0){return Gd(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});h.prototype.writeBigUInt64BE=Mt(function(e,t=0){return Qd(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});h.prototype.writeIntLE=function(e,t,s,r){if(e=+e,t=t>>>0,!r){let l=Math.pow(2,8*s-1);xe(this,e,t,s,l-1,-l)}let n=0,o=1,a=0;for(this[t]=e&255;++n<s&&(o*=256);)e<0&&a===0&&this[t+n-1]!==0&&(a=1),this[t+n]=(e/o>>0)-a&255;return t+s};h.prototype.writeIntBE=function(e,t,s,r){if(e=+e,t=t>>>0,!r){let l=Math.pow(2,8*s-1);xe(this,e,t,s,l-1,-l)}let n=s-1,o=1,a=0;for(this[t+n]=e&255;--n>=0&&(o*=256);)e<0&&a===0&&this[t+n+1]!==0&&(a=1),this[t+n]=(e/o>>0)-a&255;return t+s};h.prototype.writeInt8=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1};h.prototype.writeInt16LE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2};h.prototype.writeInt16BE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2};h.prototype.writeInt32LE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4};h.prototype.writeInt32BE=function(e,t,s){return e=+e,t=t>>>0,s||xe(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};h.prototype.writeBigInt64LE=Mt(function(e,t=0){return Gd(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});h.prototype.writeBigInt64BE=Mt(function(e,t=0){return Qd(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Yd(i,e,t,s,r,n){if(t+s>i.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function Jd(i,e,t,s,r){return e=+e,t=t>>>0,r||Yd(i,e,t,4,34028234663852886e22,-34028234663852886e22),Vs.write(i,e,t,s,23,4),t+4}h.prototype.writeFloatLE=function(e,t,s){return Jd(this,e,t,!0,s)};h.prototype.writeFloatBE=function(e,t,s){return Jd(this,e,t,!1,s)};function Xd(i,e,t,s,r){return e=+e,t=t>>>0,r||Yd(i,e,t,8,17976931348623157e292,-17976931348623157e292),Vs.write(i,e,t,s,52,8),t+8}h.prototype.writeDoubleLE=function(e,t,s){return Xd(this,e,t,!0,s)};h.prototype.writeDoubleBE=function(e,t,s){return Xd(this,e,t,!1,s)};h.prototype.copy=function(e,t,s,r){if(!h.isBuffer(e))throw new TypeError("argument should be a Buffer");if(s||(s=0),!r&&r!==0&&(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<s&&(r=s),r===s||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-s&&(r=e.length-t+s);let n=r-s;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,s,r):Uint8Array.prototype.set.call(e,this.subarray(s,r),t),n};h.prototype.fill=function(e,t,s,r){if(typeof e=="string"){if(typeof t=="string"?(r=t,t=0,s=this.length):typeof s=="string"&&(r=s,s=this.length),r!==void 0&&typeof r!="string")throw new TypeError("encoding must be a string");if(typeof r=="string"&&!h.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(e.length===1){let o=e.charCodeAt(0);(r==="utf8"&&o<128||r==="latin1")&&(e=o)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<s)throw new RangeError("Out of range index");if(s<=t)return this;t=t>>>0,s=s===void 0?this.length:s>>>0,e||(e=0);let n;if(typeof e=="number")for(n=t;n<s;++n)this[n]=e;else{let o=h.isBuffer(e)?e:h.from(e,r),a=o.length;if(a===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(n=0;n<s-t;++n)this[n+t]=o[n%a]}return this};var qs={};function ya(i,e,t){qs[i]=class extends t{constructor(){super();Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${i}]`,this.stack,delete this.name}get code(){return i}set code(r){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:r,writable:!0})}toString(){return`${this.name} [${i}]: ${this.message}`}}}ya("ERR_BUFFER_OUT_OF_BOUNDS",function(i){return i?`${i} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);ya("ERR_INVALID_ARG_TYPE",function(i,e){return`The "${i}" argument must be of type number. Received type ${typeof e}`},TypeError);ya("ERR_OUT_OF_RANGE",function(i,e,t){let s=`The value of "${i}" is out of range.`,r=t;return Number.isInteger(t)&&Math.abs(t)>2**32?r=Zd(String(t)):typeof t=="bigint"&&(r=String(t),(t>BigInt(2)**BigInt(32)||t<-(BigInt(2)**BigInt(32)))&&(r=Zd(r)),r+="n"),s+=` It must be ${e}. Received ${r}`,s},RangeError);function Zd(i){let e="",t=i.length,s=i[0]==="-"?1:0;for(;t>=s+4;t-=3)e=`_${i.slice(t-3,t)}${e}`;return`${i.slice(0,t)}${e}`}function Jf(i,e,t){Bs(e,"offset"),(i[e]===void 0||i[e+t]===void 0)&&br(e,i.length-(t+1))}function em(i,e,t,s,r,n){if(i>t||i<e){let o=typeof e=="bigint"?"n":"",a;throw n>3?e===0||e===BigInt(0)?a=`>= 0${o} and < 2${o} ** ${(n+1)*8}${o}`:a=`>= -(2${o} ** ${(n+1)*8-1}${o}) and < 2 ** ${(n+1)*8-1}${o}`:a=`>= ${e}${o} and <= ${t}${o}`,new qs.ERR_OUT_OF_RANGE("value",a,i)}Jf(s,r,n)}function Bs(i,e){if(typeof i!="number")throw new qs.ERR_INVALID_ARG_TYPE(e,"number",i)}function br(i,e,t){throw Math.floor(i)!==i?(Bs(i,t),new qs.ERR_OUT_OF_RANGE(t||"offset","an integer",i)):e<0?new qs.ERR_BUFFER_OUT_OF_BOUNDS:new qs.ERR_OUT_OF_RANGE(t||"offset",`>= ${t?1:0} and <= ${e}`,i)}var Xf=/[^+/0-9A-Za-z-_]/g;function Zf(i){if(i=i.split("=")[0],i=i.trim().replace(Xf,""),i.length<2)return"";for(;i.length%4!=0;)i=i+"=";return i}function wa(i,e){e=e||1/0;let t,s=i.length,r=null,n=[];for(let o=0;o<s;++o){if(t=i.charCodeAt(o),t>55295&&t<57344){if(!r){if(t>56319){(e-=3)>-1&&n.push(239,191,189);continue}else if(o+1===s){(e-=3)>-1&&n.push(239,191,189);continue}r=t;continue}if(t<56320){(e-=3)>-1&&n.push(239,191,189),r=t;continue}t=(r-55296<<10|t-56320)+65536}else r&&(e-=3)>-1&&n.push(239,191,189);if(r=null,t<128){if((e-=1)<0)break;n.push(t)}else if(t<2048){if((e-=2)<0)break;n.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;n.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;n.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return n}function eg(i){let e=[];for(let t=0;t<i.length;++t)e.push(i.charCodeAt(t)&255);return e}function tg(i,e){let t,s,r,n=[];for(let o=0;o<i.length&&!((e-=2)<0);++o)t=i.charCodeAt(o),s=t>>8,r=t%256,n.push(r),n.push(s);return n}function tm(i){return ha.toByteArray(Zf(i))}function ki(i,e,t,s){let r;for(r=0;r<s&&!(r+t>=e.length||r>=i.length);++r)e[r+t]=i[r];return r}function it(i,e){return i instanceof e||i!=null&&i.constructor!=null&&i.constructor.name!=null&&i.constructor.name===e.name}function va(i){return i!==i}var sg=function(){let i="0123456789abcdef",e=new Array(256);for(let t=0;t<16;++t){let s=t*16;for(let r=0;r<16;++r)e[s+r]=i[t]+i[r]}return e}();function Mt(i){return typeof BigInt=="undefined"?rg:i}function rg(){throw new Error("BigInt not supported")}});var nm=ut((ba,im)=>{var Mi=sm(),nt=Mi.Buffer;function rm(i,e){for(var t in i)e[t]=i[t]}nt.from&&nt.alloc&&nt.allocUnsafe&&nt.allocUnsafeSlow?im.exports=Mi:(rm(Mi,ba),ba.Buffer=is);function is(i,e,t){return nt(i,e,t)}is.prototype=Object.create(nt.prototype);rm(nt,is);is.from=function(i,e,t){if(typeof i=="number")throw new TypeError("Argument must not be a number");return nt(i,e,t)};is.alloc=function(i,e,t){if(typeof i!="number")throw new TypeError("Argument must be a number");var s=nt(i);return e!==void 0?typeof t=="string"?s.fill(e,t):s.fill(e):s.fill(0),s};is.allocUnsafe=function(i){if(typeof i!="number")throw new TypeError("Argument must be a number");return nt(i)};is.allocUnsafeSlow=function(i){if(typeof i!="number")throw new TypeError("Argument must be a number");return Mi.SlowBuffer(i)}});var am=ut((TR,om)=>{"use strict";var Ai=nm().Buffer;function ig(i){if(i.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var s=0;s<i.length;s++){var r=i.charAt(s),n=r.charCodeAt(0);if(e[n]!==255)throw new TypeError(r+" is ambiguous");e[n]=s}var o=i.length,a=i.charAt(0),l=Math.log(o)/Math.log(256),c=Math.log(256)/Math.log(o);function u(f){if((Array.isArray(f)||f instanceof Uint8Array)&&(f=Ai.from(f)),!Ai.isBuffer(f))throw new TypeError("Expected Buffer");if(f.length===0)return"";for(var g=0,w=0,C=0,R=f.length;C!==R&&f[C]===0;)C++,g++;for(var M=(R-C)*c+1>>>0,W=new Uint8Array(M);C!==R;){for(var P=f[C],Oe=0,K=M-1;(P!==0||Oe<w)&&K!==-1;K--,Oe++)P+=256*W[K]>>>0,W[K]=P%o>>>0,P=P/o>>>0;if(P!==0)throw new Error("Non-zero carry");w=Oe,C++}for(var Ae=M-w;Ae!==M&&W[Ae]===0;)Ae++;for(var T=a.repeat(g);Ae<M;++Ae)T+=i.charAt(W[Ae]);return T}function d(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return Ai.alloc(0);for(var g=0,w=0,C=0;f[g]===a;)w++,g++;for(var R=(f.length-g)*l+1>>>0,M=new Uint8Array(R);f[g];){var W=e[f.charCodeAt(g)];if(W===255)return;for(var P=0,Oe=R-1;(W!==0||P<C)&&Oe!==-1;Oe--,P++)W+=o*M[Oe]>>>0,M[Oe]=W%256>>>0,W=W/256>>>0;if(W!==0)throw new Error("Non-zero carry");C=P,g++}for(var K=R-C;K!==R&&M[K]===0;)K++;var Ae=Ai.allocUnsafe(w+(R-K));Ae.fill(0,0,w);for(var T=w;K!==R;)Ae[T++]=M[K++];return Ae}function p(f){var g=d(f);if(g)return g;throw new Error("Non-base"+o+" character")}return{encode:u,decodeUnsafe:d,decode:p}}om.exports=ig});var cm=ut((RR,lm)=>{var ng=am(),og="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";lm.exports=ng(og)});var Wm=ut((Sl,El)=>{(function(i,e){typeof Sl=="object"&&typeof El!="undefined"?El.exports=e():typeof define=="function"&&define.amd?define(e):(i=i||self,i.DOMPurify=e())})(Sl,function(){"use strict";function i(b){if(Array.isArray(b)){for(var I=0,k=Array(b.length);I<b.length;I++)k[I]=b[I];return k}else return Array.from(b)}var e=Object.hasOwnProperty,t=Object.setPrototypeOf,s=Object.isFrozen,r=Object.getPrototypeOf,n=Object.getOwnPropertyDescriptor,o=Object.freeze,a=Object.seal,l=Object.create,c=typeof Reflect!="undefined"&&Reflect,u=c.apply,d=c.construct;u||(u=function(I,k,D){return I.apply(k,D)}),o||(o=function(I){return I}),a||(a=function(I){return I}),d||(d=function(I,k){return new(Function.prototype.bind.apply(I,[null].concat(i(k))))});var p=K(Array.prototype.forEach),f=K(Array.prototype.pop),g=K(Array.prototype.push),w=K(String.prototype.toLowerCase),C=K(String.prototype.match),R=K(String.prototype.replace),M=K(String.prototype.indexOf),W=K(String.prototype.trim),P=K(RegExp.prototype.test),Oe=Ae(TypeError);function K(b){return function(I){for(var k=arguments.length,D=Array(k>1?k-1:0),ne=1;ne<k;ne++)D[ne-1]=arguments[ne];return u(b,I,D)}}function Ae(b){return function(){for(var I=arguments.length,k=Array(I),D=0;D<I;D++)k[D]=arguments[D];return d(b,k)}}function T(b,I){t&&t(b,null);for(var k=I.length;k--;){var D=I[k];if(typeof D=="string"){var ne=w(D);ne!==D&&(s(I)||(I[k]=ne),D=ne)}b[D]=!0}return b}function Vt(b){var I=l(null),k=void 0;for(k in b)u(e,b,[k])&&(I[k]=b[k]);return I}function qr(b,I){for(;b!==null;){var k=n(b,I);if(k){if(k.get)return K(k.get);if(typeof k.value=="function")return K(k.value)}b=r(b)}function D(ne){return console.warn("fallback value for",ne),null}return D}var gc=o(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Wi=o(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),zi=o(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),_h=o(["animate","color-profile","cursor","discard","fedropshadow","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Gi=o(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),yh=o(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),_c=o(["#text"]),yc=o(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns","slot"]),Qi=o(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),wc=o(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Br=o(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),wh=a(/\{\{[\s\S]*|[\s\S]*\}\}/gm),vh=a(/<%[\s\S]*|[\s\S]*%>/gm),bh=a(/^data-[\-\w.\u00B7-\uFFFF]/),Ih=a(/^aria-[\-\w]+$/),Sh=a(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Eh=a(/^(?:\w+script|data):/i),xh=a(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Ks=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b};function Qe(b){if(Array.isArray(b)){for(var I=0,k=Array(b.length);I<b.length;I++)k[I]=b[I];return k}else return Array.from(b)}var Th=function(){return typeof window=="undefined"?null:window},Rh=function(I,k){if((typeof I=="undefined"?"undefined":Ks(I))!=="object"||typeof I.createPolicy!="function")return null;var D=null,ne="data-tt-policy-suffix";k.currentScript&&k.currentScript.hasAttribute(ne)&&(D=k.currentScript.getAttribute(ne));var Or="dompurify"+(D?"#"+D:"");try{return I.createPolicy(Or,{createHTML:function(Nr){return Nr}})}catch{return console.warn("TrustedTypes policy "+Or+" could not be created."),null}};function vc(){var b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Th(),I=function(m){return vc(m)};if(I.version="2.3.4",I.removed=[],!b||!b.document||b.document.nodeType!==9)return I.isSupported=!1,I;var k=b.document,D=b.document,ne=b.DocumentFragment,Or=b.HTMLTemplateElement,ds=b.Node,Nr=b.Element,Yi=b.NodeFilter,bc=b.NamedNodeMap,Mh=bc===void 0?b.NamedNodeMap||b.MozNamedAttrMap:bc,Ah=b.HTMLFormElement,Ch=b.DOMParser,Lh=b.trustedTypes,Pr=Nr.prototype,Dh=qr(Pr,"cloneNode"),Vh=qr(Pr,"nextSibling"),qh=qr(Pr,"childNodes"),Ji=qr(Pr,"parentNode");if(typeof Or=="function"){var Xi=D.createElement("template");Xi.content&&Xi.content.ownerDocument&&(D=Xi.content.ownerDocument)}var It=Rh(Lh,k),Ic=It&&jr?It.createHTML(""):"",Fr=D,Zi=Fr.implementation,Bh=Fr.createNodeIterator,Oh=Fr.createDocumentFragment,Nh=Fr.getElementsByTagName,Ph=k.importNode,Sc={};try{Sc=Vt(D).documentMode?D.documentMode:{}}catch{}var Ye={};I.isSupported=typeof Ji=="function"&&Zi&&typeof Zi.createHTMLDocument!="undefined"&&Sc!==9;var en=wh,tn=vh,Fh=bh,Uh=Ih,Kh=Eh,Ec=xh,sn=Sh,oe=null,xc=T({},[].concat(Qe(gc),Qe(Wi),Qe(zi),Qe(Gi),Qe(_c))),re=null,Tc=T({},[].concat(Qe(yc),Qe(Qi),Qe(wc),Qe(Br))),Q=Object.seal(Object.create(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Ur=null,rn=null,Rc=!0,nn=!0,kc=!1,ms=!1,hs=!1,on=!1,an=!1,ps=!1,Kr=!1,jr=!1,Mc=!0,ln=!0,js=!1,fs={},gs=null,Ac=T({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Cc=null,Lc=T({},["audio","video","img","source","image","track"]),cn=null,Dc=T({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),un="http://www.w3.org/1998/Math/MathML",dn="http://www.w3.org/2000/svg",St="http://www.w3.org/1999/xhtml",$r=St,mn=!1,_s=void 0,jh=["application/xhtml+xml","text/html"],$h="text/html",ys=void 0,ws=null,Hh=D.createElement("form"),Vc=function(m){return m instanceof RegExp||m instanceof Function},hn=function(m){ws&&ws===m||((!m||(typeof m=="undefined"?"undefined":Ks(m))!=="object")&&(m={}),m=Vt(m),oe="ALLOWED_TAGS"in m?T({},m.ALLOWED_TAGS):xc,re="ALLOWED_ATTR"in m?T({},m.ALLOWED_ATTR):Tc,cn="ADD_URI_SAFE_ATTR"in m?T(Vt(Dc),m.ADD_URI_SAFE_ATTR):Dc,Cc="ADD_DATA_URI_TAGS"in m?T(Vt(Lc),m.ADD_DATA_URI_TAGS):Lc,gs="FORBID_CONTENTS"in m?T({},m.FORBID_CONTENTS):Ac,Ur="FORBID_TAGS"in m?T({},m.FORBID_TAGS):{},rn="FORBID_ATTR"in m?T({},m.FORBID_ATTR):{},fs="USE_PROFILES"in m?m.USE_PROFILES:!1,Rc=m.ALLOW_ARIA_ATTR!==!1,nn=m.ALLOW_DATA_ATTR!==!1,kc=m.ALLOW_UNKNOWN_PROTOCOLS||!1,ms=m.SAFE_FOR_TEMPLATES||!1,hs=m.WHOLE_DOCUMENT||!1,ps=m.RETURN_DOM||!1,Kr=m.RETURN_DOM_FRAGMENT||!1,jr=m.RETURN_TRUSTED_TYPE||!1,an=m.FORCE_BODY||!1,Mc=m.SANITIZE_DOM!==!1,ln=m.KEEP_CONTENT!==!1,js=m.IN_PLACE||!1,sn=m.ALLOWED_URI_REGEXP||sn,$r=m.NAMESPACE||St,m.CUSTOM_ELEMENT_HANDLING&&Vc(m.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(Q.tagNameCheck=m.CUSTOM_ELEMENT_HANDLING.tagNameCheck),m.CUSTOM_ELEMENT_HANDLING&&Vc(m.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(Q.attributeNameCheck=m.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),m.CUSTOM_ELEMENT_HANDLING&&typeof m.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(Q.allowCustomizedBuiltInElements=m.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),_s=jh.indexOf(m.PARSER_MEDIA_TYPE)===-1?_s=$h:_s=m.PARSER_MEDIA_TYPE,ys=_s==="application/xhtml+xml"?function(_){return _}:w,ms&&(nn=!1),Kr&&(ps=!0),fs&&(oe=T({},[].concat(Qe(_c))),re=[],fs.html===!0&&(T(oe,gc),T(re,yc)),fs.svg===!0&&(T(oe,Wi),T(re,Qi),T(re,Br)),fs.svgFilters===!0&&(T(oe,zi),T(re,Qi),T(re,Br)),fs.mathMl===!0&&(T(oe,Gi),T(re,wc),T(re,Br))),m.ADD_TAGS&&(oe===xc&&(oe=Vt(oe)),T(oe,m.ADD_TAGS)),m.ADD_ATTR&&(re===Tc&&(re=Vt(re)),T(re,m.ADD_ATTR)),m.ADD_URI_SAFE_ATTR&&T(cn,m.ADD_URI_SAFE_ATTR),m.FORBID_CONTENTS&&(gs===Ac&&(gs=Vt(gs)),T(gs,m.FORBID_CONTENTS)),ln&&(oe["#text"]=!0),hs&&T(oe,["html","head","body"]),oe.table&&(T(oe,["tbody"]),delete Ur.tbody),o&&o(m),ws=m)},qc=T({},["mi","mo","mn","ms","mtext"]),Bc=T({},["foreignobject","desc","title","annotation-xml"]),Hr=T({},Wi);T(Hr,zi),T(Hr,_h);var pn=T({},Gi);T(pn,yh);var Wh=function(m){var _=Ji(m);(!_||!_.tagName)&&(_={namespaceURI:St,tagName:"template"});var v=w(m.tagName),q=w(_.tagName);if(m.namespaceURI===dn)return _.namespaceURI===St?v==="svg":_.namespaceURI===un?v==="svg"&&(q==="annotation-xml"||qc[q]):Boolean(Hr[v]);if(m.namespaceURI===un)return _.namespaceURI===St?v==="math":_.namespaceURI===dn?v==="math"&&Bc[q]:Boolean(pn[v]);if(m.namespaceURI===St){if(_.namespaceURI===dn&&!Bc[q]||_.namespaceURI===un&&!qc[q])return!1;var ae=T({},["title","style","font","a","script"]);return!pn[v]&&(ae[v]||!Hr[v])}return!1},at=function(m){g(I.removed,{element:m});try{m.parentNode.removeChild(m)}catch{try{m.outerHTML=Ic}catch{m.remove()}}},Oc=function(m,_){try{g(I.removed,{attribute:_.getAttributeNode(m),from:_})}catch{g(I.removed,{attribute:null,from:_})}if(_.removeAttribute(m),m==="is"&&!re[m])if(ps||Kr)try{at(_)}catch{}else try{_.setAttribute(m,"")}catch{}},Nc=function(m){var _=void 0,v=void 0;if(an)m="<remove></remove>"+m;else{var q=C(m,/^[\r\n\t ]+/);v=q&&q[0]}_s==="application/xhtml+xml"&&(m='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+m+"</body></html>");var ae=It?It.createHTML(m):m;if($r===St)try{_=new Ch().parseFromString(ae,_s)}catch{}if(!_||!_.documentElement){_=Zi.createDocument($r,"template",null);try{_.documentElement.innerHTML=mn?"":ae}catch{}}var le=_.body||_.documentElement;return m&&v&&le.insertBefore(D.createTextNode(v),le.childNodes[0]||null),$r===St?Nh.call(_,hs?"html":"body")[0]:hs?_.documentElement:le},Pc=function(m){return Bh.call(m.ownerDocument||m,m,Yi.SHOW_ELEMENT|Yi.SHOW_COMMENT|Yi.SHOW_TEXT,null,!1)},zh=function(m){return m instanceof Ah&&(typeof m.nodeName!="string"||typeof m.textContent!="string"||typeof m.removeChild!="function"||!(m.attributes instanceof Mh)||typeof m.removeAttribute!="function"||typeof m.setAttribute!="function"||typeof m.namespaceURI!="string"||typeof m.insertBefore!="function")},$s=function(m){return(typeof ds=="undefined"?"undefined":Ks(ds))==="object"?m instanceof ds:m&&(typeof m=="undefined"?"undefined":Ks(m))==="object"&&typeof m.nodeType=="number"&&typeof m.nodeName=="string"},lt=function(m,_,v){!Ye[m]||p(Ye[m],function(q){q.call(I,_,v,ws)})},Fc=function(m){var _=void 0;if(lt("beforeSanitizeElements",m,null),zh(m)||C(m.nodeName,/[\u0080-\uFFFF]/))return at(m),!0;var v=ys(m.nodeName);if(lt("uponSanitizeElement",m,{tagName:v,allowedTags:oe}),!$s(m.firstElementChild)&&(!$s(m.content)||!$s(m.content.firstElementChild))&&P(/<[/\w]/g,m.innerHTML)&&P(/<[/\w]/g,m.textContent)||v==="select"&&P(/<template/i,m.innerHTML))return at(m),!0;if(!oe[v]||Ur[v]){if(ln&&!gs[v]){var q=Ji(m)||m.parentNode,ae=qh(m)||m.childNodes;if(ae&&q)for(var le=ae.length,ce=le-1;ce>=0;--ce)q.insertBefore(Dh(ae[ce],!0),Vh(m))}return!Ur[v]&&Kc(v)&&(Q.tagNameCheck instanceof RegExp&&P(Q.tagNameCheck,v)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(v))?!1:(at(m),!0)}return m instanceof Nr&&!Wh(m)||(v==="noscript"||v==="noembed")&&P(/<\/no(script|embed)/i,m.innerHTML)?(at(m),!0):(ms&&m.nodeType===3&&(_=m.textContent,_=R(_,en," "),_=R(_,tn," "),m.textContent!==_&&(g(I.removed,{element:m.cloneNode()}),m.textContent=_)),lt("afterSanitizeElements",m,null),!1)},Uc=function(m,_,v){if(Mc&&(_==="id"||_==="name")&&(v in D||v in Hh))return!1;if(!(nn&&!rn[_]&&P(Fh,_))){if(!(Rc&&P(Uh,_))){if(!re[_]||rn[_]){if(!(Kc(m)&&(Q.tagNameCheck instanceof RegExp&&P(Q.tagNameCheck,m)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(m))&&(Q.attributeNameCheck instanceof RegExp&&P(Q.attributeNameCheck,_)||Q.attributeNameCheck instanceof Function&&Q.attributeNameCheck(_))||_==="is"&&Q.allowCustomizedBuiltInElements&&(Q.tagNameCheck instanceof RegExp&&P(Q.tagNameCheck,v)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(v))))return!1}else if(!cn[_]){if(!P(sn,R(v,Ec,""))){if(!((_==="src"||_==="xlink:href"||_==="href")&&m!=="script"&&M(v,"data:")===0&&Cc[m])){if(!(kc&&!P(Kh,R(v,Ec,"")))){if(v)return!1}}}}}}return!0},Kc=function(m){return m.indexOf("-")>0},jc=function(m){var _=void 0,v=void 0,q=void 0,ae=void 0;lt("beforeSanitizeAttributes",m,null);var le=m.attributes;if(!!le){var ce={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:re};for(ae=le.length;ae--;){_=le[ae];var ct=_,Hs=ct.name,$c=ct.namespaceURI;if(v=W(_.value),q=ys(Hs),ce.attrName=q,ce.attrValue=v,ce.keepAttr=!0,ce.forceKeepAttr=void 0,lt("uponSanitizeAttribute",m,ce),v=ce.attrValue,!ce.forceKeepAttr&&(Oc(Hs,m),!!ce.keepAttr)){if(P(/\/>/i,v)){Oc(Hs,m);continue}ms&&(v=R(v,en," "),v=R(v,tn," "));var Qh=ys(m.nodeName);if(!!Uc(Qh,q,v))try{$c?m.setAttributeNS($c,Hs,v):m.setAttribute(Hs,v),f(I.removed)}catch{}}}lt("afterSanitizeAttributes",m,null)}},Gh=function E(m){var _=void 0,v=Pc(m);for(lt("beforeSanitizeShadowDOM",m,null);_=v.nextNode();)lt("uponSanitizeShadowNode",_,null),!Fc(_)&&(_.content instanceof ne&&E(_.content),jc(_));lt("afterSanitizeShadowDOM",m,null)};return I.sanitize=function(E,m){var _=void 0,v=void 0,q=void 0,ae=void 0,le=void 0;if(mn=!E,mn&&(E="<!-->"),typeof E!="string"&&!$s(E)){if(typeof E.toString!="function")throw Oe("toString is not a function");if(E=E.toString(),typeof E!="string")throw Oe("dirty is not a string, aborting")}if(!I.isSupported){if(Ks(b.toStaticHTML)==="object"||typeof b.toStaticHTML=="function"){if(typeof E=="string")return b.toStaticHTML(E);if($s(E))return b.toStaticHTML(E.outerHTML)}return E}if(on||hn(m),I.removed=[],typeof E=="string"&&(js=!1),!js)if(E instanceof ds)_=Nc("<!---->"),v=_.ownerDocument.importNode(E,!0),v.nodeType===1&&v.nodeName==="BODY"||v.nodeName==="HTML"?_=v:_.appendChild(v);else{if(!ps&&!ms&&!hs&&E.indexOf("<")===-1)return It&&jr?It.createHTML(E):E;if(_=Nc(E),!_)return ps?null:Ic}_&&an&&at(_.firstChild);for(var ce=Pc(js?E:_);q=ce.nextNode();)q.nodeType===3&&q===ae||Fc(q)||(q.content instanceof ne&&Gh(q.content),jc(q),ae=q);if(ae=null,js)return E;if(ps){if(Kr)for(le=Oh.call(_.ownerDocument);_.firstChild;)le.appendChild(_.firstChild);else le=_;return re.shadowroot&&(le=Ph.call(k,le,!0)),le}var ct=hs?_.outerHTML:_.innerHTML;return ms&&(ct=R(ct,en," "),ct=R(ct,tn," ")),It&&jr?It.createHTML(ct):ct},I.setConfig=function(E){hn(E),on=!0},I.clearConfig=function(){ws=null,on=!1},I.isValidAttribute=function(E,m,_){ws||hn({});var v=ys(E),q=ys(m);return Uc(v,q,_)},I.addHook=function(E,m){typeof m=="function"&&(Ye[E]=Ye[E]||[],g(Ye[E],m))},I.removeHook=function(E){Ye[E]&&f(Ye[E])},I.removeHooks=function(E){Ye[E]&&(Ye[E]=[])},I.removeAllHooks=function(){Ye={}},I}var kh=vc();return kh})});function fe(...i){let e={};for(let t of i)e[t]=t;return Object.freeze(e)}function Hc(i){try{return new URL(i).origin}catch{return new URL(`https://${i}`).origin}}async function rp(i,e){let t={format:"json",timeout:3e4,method:"GET"};try{let s=`${i}/.well-known/matrix/client`;return await e(s,t).response()}catch(s){if(s.name==="ConnectionError")return null;throw s}}async function Wc(i,e){i=Hc(i);let t=await rp(i,e);if(t&&t.status===200){let{body:s}=t,r=s["m.homeserver"]?.base_url;typeof r=="string"&&(i=Hc(r))}return i}var gn=class{constructor(e){this._abortable=null;let t=s=>(this._abortable=s,s);this.result=e(t)}abort(){this._abortable?.abort(),this._abortable=null}};var j=class extends Error{get name(){return"AbortError"}};var qt=class{constructor(){this._handlers=new Set}onSubscribeFirst(){}onUnsubscribeLast(){}subscribe(e){return this._handlers.add(e),this._handlers.size===1&&this.onSubscribeFirst(),()=>this.unsubscribe(e)}unsubscribe(e){e&&(this._handlers.delete(e),this._handlers.size===0&&this.onUnsubscribeLast())}unsubscribeAll(){this._handlers.size!==0&&(this._handlers.clear(),this.onUnsubscribeLast())}get hasSubscriptions(){return this._handlers.size!==0}};var Je=class extends qt{emit(e){for(let t of this._handlers)t(e)}waitFor(e){return e(this.get())?new Gc(Promise.resolve(this.get())):new zc(this,e)}},zc=class{constructor(e,t){this._promise=new Promise((s,r)=>{this._reject=r,this._subscription=e.subscribe(n=>{t(n)&&(this._reject=null,s(n),this.dispose())})})}get promise(){return this._promise}dispose(){this._subscription&&(this._subscription(),this._subscription=null),this._reject&&(this._reject(new j),this._reject=null)}},Gc=class{constructor(e){this.promise=e}dispose(){}},te=class extends Je{constructor(e){super();this._value=e}get(){return this._value}set(e){e!==this._value&&(this._value=e,this.emit(this._value))}},bs=class extends te{constructor(e,t){super(e);this._freeCallback=t}onUnsubscribeLast(){super.onUnsubscribeLast(),this._freeCallback()}};var ip={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"video/quicktime":!0,"video/VP8":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0},Qc="application/octet-stream",Ne=class{constructor(e,t=null){this._blob=e,this._buffer=t,this._url=null}static fromBuffer(e,t){return t=t?t.split(";")[0].trim():"",ip[t]||(t=Qc),new Ne(new Blob([e],{type:t}),e)}static fromBlob(e){return new Ne(e)}get nativeBlob(){return this._blob}async readAsBuffer(){if(this._buffer)return this._buffer;{let e=new FileReader,t=new Promise((s,r)=>{e.addEventListener("load",n=>s(n.target.result)),e.addEventListener("error",n=>r(n.target.error))});return e.readAsArrayBuffer(this._blob),t}}get url(){return this._url||(this._url=URL.createObjectURL(this._blob)),this._url}get size(){return this._blob.size}get mimeType(){return this._blob.type||Qc}dispose(){this._url&&(URL.revokeObjectURL(this._url),this._url=null)}};function Wr(i){return Object.entries(i||{}).filter(([,e])=>e!==void 0).map(([e,t])=>(typeof t=="object"&&(t=JSON.stringify(t)),`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")}function Yc(i){if(i instanceof Ne){let e=i;return{mimeType:e.mimeType,body:e}}else if(typeof i=="object"){let e=JSON.stringify(i);return{mimeType:"application/json",body:e}}else throw new Error("Unknown body type: "+i)}var Ws=class extends Error{constructor(e,t){super(`${e}: ${t.message}`);this.cause=t}get name(){return"WrappedError"}},zs=class extends Error{constructor(e,t,s,r){super(`${s?s.error:r} on ${e} ${t}`);this.errcode=s?s.errcode:null,this.retry_after_ms=s?s.retry_after_ms:0,this.statusCode=r}get name(){return"HomeServerError"}},ge=class extends Error{constructor(e,t){super(e||"ConnectionError");this.isTimeout=t}get name(){return"ConnectionError"}};var _n=class{constructor(e,t,s,r){this._log=r,this._sourceRequest=s,this._promise=s.response().then(n=>{if(r?.set("status",n.status),n.status>=200&&n.status<300)return r?.finish(),n.body;if(n.status>=500){let o=new ge("Internal Server Error");throw r?.catch(o),o}else if(n.status>=400&&!n.body?.errcode){let o=new ge(`HTTP error status ${n.status} without errcode in body, assume this is a load balancer complaining the server is offline.`);throw r?.catch(o),o}else{let o=new zs(e,t,n.body,n.status);throw r?.set("errcode",o.errcode),r?.catch(o),o}},n=>{if(n.name==="AbortError"&&this._sourceRequest){let o=new ge("Service worker aborted, either updating or hit #187.");throw r?.catch(o),o}else throw n.name==="ConnectionError"&&r?.set("timeout",n.isTimeout),r?.catch(n),n})}abort(){this._sourceRequest&&(this._log?.set("aborted",!0),this._sourceRequest.abort(),this._sourceRequest=void 0)}response(){return this._promise}};var zr="/_matrix/client/r0",yn="/_matrix/client/unstable/org.matrix.msc2697.v2",Et=class{constructor({homeserver:e,accessToken:t,request:s,reconnector:r}){this._homeserver=e,this._accessToken=t,this._requestFn=s,this._reconnector=r}_url(e,t=zr){return this._homeserver+t+e}_baseRequest(e,t,s,r,n,o){let a=Wr(s);t=`${t}?${a}`;let l;if(n?.log){let f=n?.log;l=f.child({t:"network",url:t,method:e},f.level.Info)}let c,u=new Map;if(o&&u.set("Authorization",`Bearer ${o}`),u.set("Accept","application/json"),r){let f=Yc(r);u.set("Content-Type",f.mimeType),c=f.body}let d=this._requestFn(t,{method:e,headers:u,body:c,timeout:n?.timeout,uploadProgress:n?.uploadProgress,format:"json"}),p=new _n(e,t,d,l);return this._reconnector&&p.response().catch(f=>{f.name==="ConnectionError"&&this._reconnector.onRequestFailed(this)}),p}_unauthedRequest(e,t,s,r,n){return this._baseRequest(e,t,s,r,n)}_authedRequest(e,t,s,r,n){return this._baseRequest(e,t,s,r,n,this._accessToken)}_post(e,t,s,r){return this._authedRequest("POST",this._url(e,r?.prefix||zr),t,s,r)}_put(e,t,s,r){return this._authedRequest("PUT",this._url(e,r?.prefix||zr),t,s,r)}_get(e,t,s,r){return this._authedRequest("GET",this._url(e,r?.prefix||zr),t,s,r)}sync(e,t,s,r){return this._get("/sync",{since:e,timeout:s,filter:t},void 0,r)}messages(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/messages`,t,void 0,s)}members(e,t,s){return this._get(`/rooms/${encodeURIComponent(e)}/members`,t,void 0,s)}send(e,t,s,r,n){return this._put(`/rooms/${encodeURIComponent(e)}/send/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},r,n)}redact(e,t,s,r,n){return this._put(`/rooms/${encodeURIComponent(e)}/redact/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},r,n)}receipt(e,t,s,r){return this._post(`/rooms/${encodeURIComponent(e)}/receipt/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},{},r)}state(e,t,s,r){return this._get(`/rooms/${encodeURIComponent(e)}/state/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{},void 0,r)}getLoginFlows(){return this._unauthedRequest("GET",this._url("/login"))}passwordLogin(e,t,s,r){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.password",identifier:{type:"m.id.user",user:e},password:t,initial_device_display_name:s},r)}tokenLogin(e,t,s,r){return this._unauthedRequest("POST",this._url("/login"),void 0,{type:"m.login.token",identifier:{type:"m.id.user"},token:e,txn_id:t,initial_device_display_name:s},r)}createFilter(e,t,s){return this._post(`/user/${encodeURIComponent(e)}/filter`,{},t,s)}versions(e){return this._unauthedRequest("GET",`${this._homeserver}/_matrix/client/versions`,void 0,void 0,e)}uploadKeys(e,t,s){let r="/keys/upload";return e&&(r=r+`/${encodeURIComponent(e)}`),this._post(r,{},t,s)}queryKeys(e,t){return this._post("/keys/query",{},e,t)}claimKeys(e,t){return this._post("/keys/claim",{},e,t)}sendToDevice(e,t,s,r){return this._put(`/sendToDevice/${encodeURIComponent(e)}/${encodeURIComponent(s)}`,{},t,r)}roomKeysVersion(e,t){let s="";return e&&(s=`/${encodeURIComponent(e)}`),this._get(`/room_keys/version${s}`,void 0,void 0,t)}roomKeyForRoomAndSession(e,t,s,r){return this._get(`/room_keys/keys/${encodeURIComponent(t)}/${encodeURIComponent(s)}`,{version:e},void 0,r)}uploadAttachment(e,t,s){return this._authedRequest("POST",`${this._homeserver}/_matrix/media/r0/upload`,{filename:t},e,s)}setPusher(e,t){return this._post("/pushers/set",{},e,t)}getPushers(e){return this._get("/pushers",void 0,void 0,e)}join(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/join`,{},{},t)}joinIdOrAlias(e,t){return this._post(`/join/${encodeURIComponent(e)}`,{},{},t)}leave(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/leave`,{},{},t)}forget(e,t){return this._post(`/rooms/${encodeURIComponent(e)}/forget`,{},{},t)}logout(e){return this._post("/logout",{},{},e)}getDehydratedDevice(e){return e.prefix=yn,this._get("/dehydrated_device",void 0,void 0,e)}createDehydratedDevice(e,t){return t.prefix=yn,this._put("/dehydrated_device",{},e,t)}claimDehydratedDevice(e,t){return t.prefix=yn,this._post("/dehydrated_device/claim",{},{device_id:e},t)}};var Ss=class{constructor(e){this._start=2e3;this._current=2e3;let t=2e3;this._start=t,this._current=t,this._createTimeout=e,this._max=60*5*1e3}async waitForRetry(){this._timeout=this._createTimeout(this._current);try{await this._timeout.elapsed();let e=2*this._current;this._current=Math.min(this._max,e)}catch(e){if(!(e instanceof j))throw e}finally{this._timeout=void 0}}abort(){this._timeout&&this._timeout.abort()}reset(){this._current=this._start,this.abort()}get nextValue(){return this._current}};var Bt=(s=>(s[s.Waiting=0]="Waiting",s[s.Reconnecting=1]="Reconnecting",s[s.Online=2]="Online",s))(Bt||{}),wn=class{constructor({retryDelay:e,createMeasure:t,onlineStatus:s}){this._onlineStatus=s,this._retryDelay=e,this._createTimeMeasure=t,this._state=new te(2),this._isReconnecting=!1}get lastVersionsResponse(){return this._versionsResponse}get connectionStatus(){return this._state}get retryIn(){return this._state.get()===0?this._retryDelay.nextValue-this._stateSince.measure():0}async onRequestFailed(e){if(!this._isReconnecting){this._isReconnecting=!0;let t=this._onlineStatus&&this._onlineStatus.subscribe(s=>{s&&this.tryNow()});try{await this._reconnectLoop(e)}catch(s){console.error(s)}finally{t&&t(),this._isReconnecting=!1}}}tryNow(){this._retryDelay&&this._retryDelay.abort()}_setState(e){e!==this._state.get()&&(e===0?this._stateSince=this._createTimeMeasure():this._stateSince=null,this._state.set(e))}async _reconnectLoop(e){for(this._versionsResponse=void 0,this._retryDelay.reset();!this._versionsResponse;)try{this._setState(1);let t=e.versions({timeout:3e4});this._versionsResponse=await t.response(),this._setState(2)}catch(t){if(t.name==="ConnectionError")this._setState(0),await this._retryDelay.waitForRetry();else throw t}}};async function Xc(i,e,t){if(t===void 0||t.key===void 0||t.iv===void 0||t.hashes===void 0||t.hashes.sha256===void 0)throw new Error("Invalid info. Missing info.key, info.iv or info.hashes.sha256 key");let{crypto:s}=i,{base64:r}=i.encoding;var n=r.decode(t.iv),o=r.encode(r.decode(t.hashes.sha256));let a=await s.digest("SHA-256",e);if(r.encode(new Uint8Array(a))!=o)throw new Error("Mismatched SHA-256 digest");var l;return t.v=="v1"||t.v=="v2"?l=64:l=128,await s.aes.decryptCTR({jwkKey:t.key,iv:n,data:e,counterLength:l})}async function Zc(i,e){let{crypto:t}=i,{base64:s}=i.encoding,r=await t.aes.generateIV(),n=await t.aes.generateKey("jwk",256),o=await e.readAsBuffer(),a=await t.aes.encryptCTR({jwkKey:n,iv:r,data:o}),l=await t.digest("SHA-256",a);return{blob:i.createBlob(a,"application/octet-stream"),info:{v:"v2",key:n,iv:s.encodeUnpadded(r),hashes:{sha256:s.encodeUnpadded(l)}}}}var vn=class{constructor({homeserver:e,platform:t}){this._homeserver=e,this._platform=t}mxcUrlThumbnail(e,t,s,r){let n=this._parseMxcUrl(e);if(n){let[o,a]=n;return`${this._homeserver}/_matrix/media/r0/thumbnail/${encodeURIComponent(o)}/${encodeURIComponent(a)}`+"?"+Wr({width:Math.round(t),height:Math.round(s),method:r})}return null}mxcUrl(e){let t=this._parseMxcUrl(e);if(t){let[s,r]=t;return`${this._homeserver}/_matrix/media/r0/download/${encodeURIComponent(s)}/${encodeURIComponent(r)}`}else return null}_parseMxcUrl(e){let t="mxc://";return e.startsWith(t)?e.substr(t.length).split("/",2):null}async downloadEncryptedFile(e,t=!1){let s=this.mxcUrl(e.url),{body:r}=await this._platform.request(s,{method:"GET",format:"buffer",cache:t}).response(),n=await Xc(this._platform,r,e);return this._platform.createBlob(n,e.mimetype)}async downloadPlaintextFile(e,t,s=!1){let r=this.mxcUrl(e),{body:n}=await this._platform.request(r,{method:"GET",format:"buffer",cache:s}).response();return this._platform.createBlob(n,t)}async downloadAttachment(e,t=!1){return e.file?this.downloadEncryptedFile(e.file,t):this.downloadPlaintextFile(e.url,e.info?.mimetype,t)}};var eu=class{constructor(e,t){this.methodName=e,this.args=t,this._responsePromise=new Promise((s,r)=>{this.resolve=s,this.reject=r})}abort(){this.requestResult?this.requestResult.abort():this.reject(new j)}response(){return this._responsePromise}},bn=class{constructor(e){this._scheduler=e}};for(let i of Object.getOwnPropertyNames(Et.prototype))i!=="constructor"&&!i.startsWith("_")&&(bn.prototype[i]=function(...e){return this._scheduler._hsApiRequest(i,e)});var In=class{constructor({hsApi:e,clock:t}){this._requests=new Set;this._stopped=!1;this._wrapper=new bn(this);this._hsApi=e,this._clock=t}get hsApi(){return this._wrapper}stop(){this._stopped=!0;for(let e of this._requests)e.abort();this._requests.clear()}start(){this._stopped=!1}_hsApiRequest(e,t){let s=new eu(e,t);return this._doSend(s),s}async _doSend(e){this._requests.add(e);try{let t;for(;!this._stopped;)try{let s=this._hsApi[e.methodName].apply(this._hsApi,e.args);e.requestResult=s;let r=await s.response();e.resolve(r);return}catch(s){if(s instanceof zs&&s.errcode==="M_LIMIT_EXCEEDED")Number.isSafeInteger(s.retry_after_ms)?await this._clock.createTimeout(s.retry_after_ms).elapsed():(t||(t=new Ss(this._clock.createTimeout)),await t.waitForRetry());else{e.reject(s);return}}this._stopped&&e.abort()}finally{this._requests.delete(e)}}};var np=3e4,B=fe("InitialSync","CatchupSync","Syncing","Stopped");function op(i){try{let e=i?.timeline?.events;return Array.isArray(e)&&e.length===0}catch{return!0}}var Gr=class{constructor({hsApi:e,session:t,storage:s,logger:r}){this._hsApi=e,this._logger=r,this._session=t,this._storage=s,this._currentRequest=null,this._status=new te(B.Stopped),this._error=null}get status(){return this._status}get error(){return this._error}start(){if(this._status.get()!==B.Stopped)return;this._error=null;let e=this._session.syncToken;e?this._status.set(B.CatchupSync):this._status.set(B.InitialSync),this._syncLoop(e)}async _syncLoop(e){for(;this._status.get()!==B.Stopped;){let t,s,r=this._status.get()===B.CatchupSync||this._status.get()===B.InitialSync;await this._logger.run("sync",async n=>{n.set("token",e),n.set("status",this._status.get());try{let o=this._status.get()===B.Syncing?np:0,a=await this._syncRequest(e,o,n);e=a.syncToken,t=a.roomStates,s=a.sessionChanges,this._status.get()!==B.Syncing&&a.hadToDeviceMessages?this._status.set(B.CatchupSync):this._status.set(B.Syncing)}catch(o){if(o.name==="ConnectionError"&&o.isTimeout)return;this._error=o,o.name!=="AbortError"&&(n.error=o,n.logLevel=n.level.Fatal),n.set("stopping",!0),this._status.set(B.Stopped)}this._status.get()!==B.Stopped&&await n.wrap("afterSyncCompleted",o=>this._runAfterSyncCompleted(s,t,o))},this._logger.level.Info,(n,o)=>o.durationWithoutType("network")>=2e3||o.error||r?n.minLevel(o.level.Detail):n.minLevel(o.level.Info))}}async _runAfterSyncCompleted(e,t,s){let r=this._status.get()===B.CatchupSync,n=(async()=>{try{await s.wrap("session",l=>this._session.afterSyncCompleted(e,r,l),s.level.Detail)}catch{}})(),a=t.filter(l=>l.room.needsAfterSyncCompleted(l.changes)).map(async l=>{try{await s.wrap("room",c=>l.room.afterSyncCompleted(l.changes,c),s.level.Detail)}catch{}});await Promise.all(a.concat(n))}async _syncRequest(e,t,s){let{syncFilterId:r}=this._session;typeof r!="string"&&(this._currentRequest=this._hsApi.createFilter(this._session.user.id,{room:{state:{lazy_load_members:!0}}},{log:s}),r=(await this._currentRequest.response()).filter_id);let n=t+80*1e3;this._currentRequest=this._hsApi.sync(e,r,t,{timeout:n,log:s});let o=await this._currentRequest.response(),a=!e,l=new tu,c=this._parseInvites(o.rooms),{roomStates:u,archivedRoomStates:d}=await this._parseRoomsResponse(o.rooms,c,a,s);try{l.lock=await s.wrap("obtainSyncLock",()=>this._session.obtainSyncLock(o)),await s.wrap("prepare",f=>this._prepareSync(l,u,o,f)),await s.wrap("afterPrepareSync",f=>Promise.all(u.map(g=>g.room.afterPrepareSync(g.preparation,f)))),await s.wrap("write",async f=>this._writeSync(l,c,u,d,o,r,a,f))}finally{l.dispose()}s.wrap("after",f=>this._afterSync(l,c,u,d,f));let p=o.to_device?.events;return{syncToken:o.next_batch,roomStates:u,sessionChanges:l.changes,hadToDeviceMessages:Array.isArray(p)&&p.length>0}}_openPrepareSyncTxn(){let e=this._storage.storeNames;return this._storage.readTxn([e.olmSessions,e.inboundGroupSessions,e.timelineFragments,e.timelineEvents])}async _prepareSync(e,t,s,r){let n=await this._openPrepareSyncTxn();e.preparation=await r.wrap("session",a=>this._session.prepareSync(s,e.lock,n,a));let o=e.preparation?.newKeysByRoom;if(o){let{hasOwnProperty:a}=Object.prototype;for(let l of o.keys())if(!(s.rooms?.join&&a.call(s.rooms.join,l))){let u=this._session.rooms.get(l);u&&t.push(new Sn(u,!1,null,{},u.membership))}}await Promise.all(t.map(async a=>{let l=o?.get(a.room.id);a.preparation=await r.wrap("room",async c=>(a.isNewRoom&&await a.room.load(null,n,c),a.room.prepareSync(a.roomResponse,a.membership,a.invite,l,n,c)),r.level.Detail)})),await n.complete()}async _writeSync(e,t,s,r,n,o,a,l){let c=await this._openSyncTxn();try{e.changes=await l.wrap("session",u=>this._session.writeSync(n,o,e.preparation,c,u)),await Promise.all(t.map(async u=>{u.changes=await l.wrap("invite",d=>u.invite.writeSync(u.membership,u.roomResponse,c,d))})),await Promise.all(s.map(async u=>{u.changes=await l.wrap("room",d=>u.room.writeSync(u.roomResponse,a,u.preparation,c,d))})),await Promise.all(r.map(async u=>{let d=u.roomState?.summaryChanges;u.changes=await l.wrap("archivedRoom",p=>u.archivedRoom.writeSync(d,u.roomResponse,u.membership,c,p))}))}catch(u){throw c.abort(l),c.getCause(u)}await c.complete(l)}_afterSync(e,t,s,r,n){n.wrap("session",o=>this._session.afterSync(e.changes,o),n.level.Detail);for(let o of r)n.wrap("archivedRoom",a=>{o.archivedRoom.afterSync(o.changes,a),o.archivedRoom.release()},n.level.Detail);for(let o of s)n.wrap("room",a=>o.room.afterSync(o.changes,a),n.level.Detail);for(let o of t)n.wrap("invite",a=>o.invite.afterSync(o.changes,a),n.level.Detail);this._session.applyRoomCollectionChangesAfterSync(t,s,r)}_openSyncTxn(){let e=this._storage.storeNames;return this._storage.readWriteTxn([e.session,e.roomSummary,e.archivedRoomSummary,e.invites,e.roomState,e.roomMembers,e.timelineEvents,e.timelineRelations,e.timelineFragments,e.pendingEvents,e.userIdentities,e.groupSessionDecryptions,e.deviceIdentities,e.outboundGroupSessions,e.operations,e.accountData,e.olmSessions,e.inboundGroupSessions])}async _parseRoomsResponse(e,t,s,r){let n=[],o=[];if(e){let a=["join","leave"];for(let l of a){let c=e[l];if(c)for(let[u,d]of Object.entries(c)){if(s&&op(d))continue;let p=this._session.invites.get(u);p&&t.push(new En(p,!1,null,l));let f=this._createRoomSyncState(u,p,d,l,s);f&&n.push(f);let g=await this._createArchivedRoomSyncState(u,f,d,l,s,r);g&&o.push(g)}}}return{roomStates:n,archivedRoomStates:o}}_createRoomSyncState(e,t,s,r,n){let o=!1,a=this._session.rooms.get(e);if(!a&&(r==="join"||n&&r==="leave")&&(a=this._session.createRoom(e),o=!0),a)return new Sn(a,o,t,s,r)}async _createArchivedRoomSyncState(e,t,s,r,n,o){let a;if(t?.shouldAdd&&!n?a=this._session.createOrGetArchivedRoomForSync(e):r==="leave"&&(t?a=this._session.createOrGetArchivedRoomForSync(e):a=await this._session.loadArchivedRoom(e,o)),a)return new su(a,t,s,r)}_parseInvites(e){let t=[];if(e?.invite)for(let[s,r]of Object.entries(e.invite)){let n=this._session.invites.get(s),o=!1;n||(n=this._session.createInvite(s),o=!0),t.push(new En(n,o,r,"invite"))}return t}stop(){this._status.get()!==B.Stopped&&(this._status.set(B.Stopped),this._currentRequest&&(this._currentRequest.abort(),this._currentRequest=null))}},tu=class{constructor(){this.lock=null,this.preparation=null,this.changes=null}dispose(){this.lock?.release()}},Sn=class{constructor(e,t,s,r,n){this.room=e,this.isNewRoom=t,this.invite=s,this.roomResponse=r,this.membership=n,this.preparation=null,this.changes=null}get id(){return this.room.id}get shouldAdd(){return this.isNewRoom&&this.membership==="join"}get shouldRemove(){return!this.isNewRoom&&this.membership!=="join"}get summaryChanges(){return this.changes?.summaryChanges}},su=class{constructor(e,t,s,r,n){this.archivedRoom=e,this.roomState=t,this.roomResponse=s,this.membership=r,this.isInitialSync=n,this.changes=null}get id(){return this.archivedRoom.id}get shouldAdd(){return(this.roomState||this.isInitialSync)&&this.membership==="leave"}get shouldRemove(){return this.membership==="join"}},En=class{constructor(e,t,s,r){this.invite=e,this.isNewInvite=t,this.membership=r,this.roomResponse=s,this.changes=null}get id(){return this.invite.id}get shouldAdd(){return this.isNewInvite}get shouldRemove(){return this.membership!=="invite"}};var Ot=class{constructor(){this._handlersByName={}}emit(e,t){let s=this._handlersByName[e];s&&s.forEach(r=>r(t))}disposableOn(e,t){return this.on(e,t),()=>{this.off(e,t)}}on(e,t){let s=this._handlersByName[e];s||(this.onFirstSubscriptionAdded(e),this._handlersByName[e]=s=new Set),s.add(t)}off(e,t){let s=this._handlersByName[e];s&&(s.delete(t),s.size===0&&(delete this._handlersByName[e],this.onLastSubscriptionRemoved(e)))}onFirstSubscriptionAdded(e){}onLastSubscriptionRemoved(e){}};var ou=vs(Tn());var Pe=fe("Sync","Timeline","Retry"),_e="e2ee:",Es="m.olm.v1.curve25519-aes-sha2",Ie="m.megolm.v1.aes-sha2",G=class extends Error{constructor(e,t,s=null){super(`Decryption error ${e}${s?": "+JSON.stringify(s):""}`);this.code=e,this.event=t,this.details=s}},Rn="ed25519";function Qr(i,e,t,s,r,n=void 0){let o=Object.assign({},r);delete o.unsigned,delete o.signatures;let a=ou.default.stringify(o),l=r?.signatures?.[e]?.[`${Rn}:${t}`];try{if(!l)throw new Error("no signature");return i.ed25519_verify(s,a,l),!0}catch(c){if(n){let u=n.log({l:"Invalid signature, ignoring.",ed25519Key:s,canonicalJson:a,signature:l});u.error=c,u.logLevel=n.level.Warn}return!1}}function cp(i,e,t,s,r){return e.length&&(i=e.reduce((n,o)=>hp(n,o,t,s,r),i)),i}function kn(i,e,t){let s=i?.state?.events;Array.isArray(s)&&(t=s.reduce(e,t));let r=i?.timeline?.events;return Array.isArray(r)&&(t=r.reduce((n,o)=>(typeof o.state_key=="string"&&(t=e(t,o)),t),t)),t}function up(i,e,t){e.summary&&(i=pp(i,e.summary)),t!==i.membership&&(i=i.cloneIfNeeded(),i.membership=t),e.account_data&&(i=e.account_data.events.reduce(mp,i)),i=kn(e,Mn,i);let s=e.unread_notifications;return s&&(i=dp(i,s)),i}function dp(i,e){let t=e.highlight_count||0;t!==i.highlightCount&&(i=i.cloneIfNeeded(),i.highlightCount=t);let s=e.notification_count;return s!==i.notificationCount&&(i=i.cloneIfNeeded(),i.notificationCount=s),i}function mp(i,e){if(e?.type==="m.tag"){let t=e?.content?.tags;(!t||Array.isArray(t)||typeof t!="object")&&(t=null),i=i.cloneIfNeeded(),i.tags=t}return i}function Mn(i,e){if(e.type==="m.room.encryption"){let t=e.content?.algorithm;!i.encryption&&t===Ie&&(i=i.cloneIfNeeded(),i.encryption=e.content)}else if(e.type==="m.room.name"){let t=e.content?.name;t!==i.name&&(i=i.cloneIfNeeded(),i.name=t)}else if(e.type==="m.room.avatar"){let t=e.content?.url;t!==i.avatarUrl&&(i=i.cloneIfNeeded(),i.avatarUrl=t)}else if(e.type==="m.room.canonical_alias"){let t=e.content;i=i.cloneIfNeeded(),i.canonicalAlias=t.alias}return i}function hp(i,e,t,s,r){return e.eventType==="m.room.message"&&((!i.lastMessageTimestamp||e.timestamp>i.lastMessageTimestamp)&&(i=i.cloneIfNeeded(),i.lastMessageTimestamp=e.timestamp),!t&&e.sender!==r&&s&&(i=i.cloneIfNeeded(),i.isUnread=!0)),i}function pp(i,e){let t=e["m.heroes"],s=e["m.joined_member_count"],r=e["m.invited_member_count"];return t&&Array.isArray(t)&&(i=i.cloneIfNeeded(),i.heroes=t),Number.isInteger(r)&&(i=i.cloneIfNeeded(),i.inviteCount=r),Number.isInteger(s)&&(i=i.cloneIfNeeded(),i.joinCount=s),i}function fp(i,e){return i.isDirectMessage!==e.isDirectMessage&&(i=i.cloneIfNeeded(),i.isDirectMessage=e.isDirectMessage,e.isDirectMessage?i.dmUserId=e.inviter?.userId:i.dmUserId=null),i}var Fe=class{constructor(e,t){this.roomId=e?e.roomId:t,this.name=e?e.name:null,this.lastMessageTimestamp=e?e.lastMessageTimestamp:null,this.isUnread=e?e.isUnread:!1,this.encryption=e?e.encryption:null,this.membership=e?e.membership:null,this.inviteCount=e?e.inviteCount:0,this.joinCount=e?e.joinCount:0,this.heroes=e?e.heroes:null,this.canonicalAlias=e?e.canonicalAlias:null,this.hasFetchedMembers=e?e.hasFetchedMembers:!1,this.isTrackingMembers=e?e.isTrackingMembers:!1,this.avatarUrl=e?e.avatarUrl:null,this.notificationCount=e?e.notificationCount:0,this.highlightCount=e?e.highlightCount:0,this.tags=e?e.tags:null,this.isDirectMessage=e?e.isDirectMessage:!1,this.dmUserId=e?e.dmUserId:null,this.cloned=!!e}diff(e){return Object.getOwnPropertyNames(this).reduce((s,r)=>(r!=="cloned"&&this[r]!==e[r]&&(s[r]=this[r]),s),{})}cloneIfNeeded(){return this.cloned?this:new Fe(this)}serialize(){return Object.entries(this).reduce((e,[t,s])=>(t!=="cloned"&&s!==null&&(e[t]=s),e),{})}applyTimelineEntries(e,t,s,r){return cp(this,e,t,s,r)}applySyncResponse(e,t){return up(this,e,t)}applyInvite(e){return fp(this,e)}get needsHeroes(){return!this.name&&!this.canonicalAlias&&this.heroes&&this.heroes.length>0}isNewJoin(e){return this.membership==="join"&&e.membership!=="join"}},An=class{constructor(e){this._data=null,this.applyChanges(new Fe(null,e))}get data(){return this._data}writeClearUnread(e){let t=new Fe(this._data);return t.isUnread=!1,t.notificationCount=0,t.highlightCount=0,e.roomSummary.set(t.serialize()),t}writeHasFetchedMembers(e,t){let s=new Fe(this._data);return s.hasFetchedMembers=e,t.roomSummary.set(s.serialize()),s}writeIsTrackingMembers(e,t){let s=new Fe(this._data);return s.isTrackingMembers=e,t.roomSummary.set(s.serialize()),s}writeData(e,t){if(e!==this._data)return t.roomSummary.set(e.serialize()),e}writeArchivedData(e,t){if(e!==this._data)return t.archivedRoomSummary.set(e.serialize()),e}async writeAndApplyData(e,t){if(e===this._data)return!1;let s=await t.readWriteTxn([t.storeNames.roomSummary]);try{s.roomSummary.set(e.serialize())}catch(r){throw s.abort(),r}return await s.complete(),this.applyChanges(e),!0}applyChanges(e){this._data=e,this._data.cloned=!1}async load(e){this.applyChanges(new Fe(e))}};var $=(M=>(M.session="session",M.roomState="roomState",M.roomSummary="roomSummary",M.archivedRoomSummary="archivedRoomSummary",M.invites="invites",M.roomMembers="roomMembers",M.timelineEvents="timelineEvents",M.timelineRelations="timelineRelations",M.timelineFragments="timelineFragments",M.pendingEvents="pendingEvents",M.userIdentities="userIdentities",M.deviceIdentities="deviceIdentities",M.olmSessions="olmSessions",M.inboundGroupSessions="inboundGroupSessions",M.outboundGroupSessions="outboundGroupSessions",M.groupSessionDecryptions="groupSessionDecryptions",M.operations="operations",M.accountData="accountData",M))($||{}),Nt=Object.values($),ue=class extends Error{constructor(e,t=null){super(e);t&&(this.errcode=t.name),this.cause=t}get name(){return"StorageError"}},O={get minStorageKey(){return 0},get middleStorageKey(){return 2147483647},get maxStorageKey(){return 4294967295}};var U=class{constructor(e,t){this.fragmentId=e;this.eventIndex=t}nextFragmentKey(){return new U(this.fragmentId+1,O.middleStorageKey)}nextKeyForDirection(e){return e.isForward?this.nextKey():this.previousKey()}previousKey(){return new U(this.fragmentId,this.eventIndex-1)}nextKey(){return new U(this.fragmentId,this.eventIndex+1)}static get maxKey(){return new U(O.maxStorageKey,O.maxStorageKey)}static get minKey(){return new U(O.minStorageKey,O.minStorageKey)}static get defaultLiveKey(){return U.defaultFragmentKey(O.minStorageKey)}static defaultFragmentKey(e){return new U(e,O.middleStorageKey)}toString(){return`[${this.fragmentId}/${this.eventIndex}]`}equals(e){return this.fragmentId===e?.fragmentId&&this.eventIndex===e?.eventIndex}};var Yr=Number.MAX_SAFE_INTEGER,Qs=class{constructor(e){this._fragmentIdComparer=e}compare(e){return this.fragmentId===e.fragmentId?this.entryIndex-e.entryIndex:this.fragmentId===Yr?1:e.fragmentId===Yr?-1:this._fragmentIdComparer.compare(this.fragmentId,e.fragmentId)}asEventKey(){return new U(this.fragmentId,this.entryIndex)}};function Ys(i){return i.unsigned?.prev_content||i.prev_content}var de="m.room.redaction";function Js(i){return!!i?.unsigned?.redacted_because}var au="m.reaction",Ce="m.annotation";function Pt(i,e){return{"m.relates_to":{event_id:i,key:e,rel_type:Ce}}}function Xs(i){return i.event_id||i["m.in_reply_to"]?.event_id}function Jr(i,e){i.event_id!==void 0?i.event_id=e:i["m.in_reply_to"]&&(i["m.in_reply_to"].event_id=e)}function lu(i){if(i.type===de)return i.redacts;{let e=Xe(i);if(e)return Xs(e)}return null}function Le(i){return i?.["m.relates_to"]}function Xe(i){return Le(i.content)}var Cn=class{constructor(){this._entries=[]}get firstTimestamp(){return this._entries.reduce((e,t)=>t.isRedaction?e:Math.min(t.timestamp,e),Number.MAX_SAFE_INTEGER)}get annotationEntry(){return this._entries.find(e=>!e.isRedaction)}get redactionEntry(){return this._entries.find(e=>e.isRedaction)}get count(){return this._entries.reduce((e,t)=>e+(t.isRedaction?-1:1),0)}add(e){this._entries.push(e)}remove(e){let t=this._entries.indexOf(e);return t===-1?!1:(this._entries.splice(t,1),!0)}get willAnnotate(){let e=this._entries.reduce((t,s)=>!t||s.pendingEvent.queueIndex>t.pendingEvent.queueIndex?s:t,null);return e?!e.isRedaction:!1}get isEmpty(){return this._entries.length===0}};function cu(i){return i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function gp(i){switch(i){case"m.file":return"sent a file.";case"m.image":return"sent an image.";case"m.video":return"sent a video.";case"m.audio":return"sent an audio file."}return null}function _p(i){return i==="m.emote"?"* ":""}function yp(i,e,t,s){return{msgtype:e,body:t,format:"org.matrix.custom.html",formatted_body:s,"m.relates_to":{"m.in_reply_to":{event_id:i}}}}function uu(i,e,t){let s=gp(i.content.msgtype),r=_p(i.content.msgtype),n=i.sender,o=i.displayName||n,a=s||i.content.formatted_body||i.content.body&&cu(i.content.body)||"",l=`<mx-reply><blockquote>In reply to ${r}<a href="https://matrix.to/#/${n}">${o}</a><br />${a}</blockquote></mx-reply>`,u=(s||i.content.body||"").split(`
`);u[0]=`> ${r}<${n}> ${u[0]}`;let p=u.join(`
> `)+`

`+t,f=l+cu(t);return yp(i.id,e,p,f)}var Zs=class extends Qs{constructor(e){super(e);this._pendingRedactions=null,this._pendingAnnotations=null}get isReply(){return!!this.relation?.["m.in_reply_to"]}get isRedacting(){return!!this._pendingRedactions}get isRedacted(){return this.isRedacting}get isRedaction(){return this.eventType===de}get redactionReason(){return this._pendingRedactions?this._pendingRedactions[0].content?.reason:null}addLocalRelation(e){if(e.eventType===de&&e.isRelatedToId(this.id)){if(this._pendingRedactions||(this._pendingRedactions=[]),this._pendingRedactions.push(e),this._pendingRedactions.length===1)return"isRedacted"}else{let t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation.rel_type===Ce&&this._addPendingAnnotation(e))return"pendingAnnotations"}}removeLocalRelation(e){if(e.eventType===de&&e.isRelatedToId(this.id)&&this._pendingRedactions){let t=this._pendingRedactions.length;if(this._pendingRedactions=this._pendingRedactions.filter(s=>s!==e),this._pendingRedactions.length===0&&(this._pendingRedactions=null,t!==0))return"isRedacted"}else{let t=e.redactingEntry||e;if(t.isRelatedToId(this.id)&&t.relation?.rel_type===Ce&&this._pendingAnnotations&&this._removePendingAnnotation(e))return"pendingAnnotations"}}_addPendingAnnotation(e){this._pendingAnnotations||(this._pendingAnnotations=new Map);let{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s||(s=new Cn,this._pendingAnnotations.set(t,s)),s.add(e),!0}return!1}_removePendingAnnotation(e){let{key:t}=(e.redactingEntry||e).relation;if(t){let s=this._pendingAnnotations.get(t);return s.remove(e)&&s.isEmpty&&this._pendingAnnotations.delete(t),this._pendingAnnotations.size===0&&(this._pendingAnnotations=null),!0}return!1}async abortPendingRedaction(){if(this._pendingRedactions)for(let e of this._pendingRedactions)await e.pendingEvent.abort()}get pendingRedaction(){return this._pendingRedactions?this._pendingRedactions[0]:null}annotate(e){return Pt(this.id,e)}reply(e,t){return uu(this,e,t)}isRelatedToId(e){return e&&this.relatedEventId===e}haveAnnotation(e){let t=this.annotations?.[e]?.me||!1,s=this.pendingAnnotations?.get(e),r=s?.willAnnotate||!1;return t&&(!s||r)||!t&&r}get relation(){return Le(this.content)}get pendingAnnotations(){return this._pendingAnnotations}get annotations(){return null}};var Xr=class extends Zs{constructor({pendingEvent:e,member:t,clock:s,redactingEntry:r}){super(null);this._pendingEvent=e,this._member=t,this._timestamp=s.now()-(100-e.queueIndex),this._redactingEntry=r}get fragmentId(){return Yr}get entryIndex(){return this._pendingEvent.queueIndex}get content(){return this._pendingEvent.content}get event(){return null}get eventType(){return this._pendingEvent.eventType}get stateKey(){return null}get sender(){return this._member?.userId}get displayName(){return this._member?.name}get avatarUrl(){return this._member?.avatarUrl}get timestamp(){return this._timestamp}get isPending(){return!0}get id(){return this._pendingEvent.txnId}get pendingEvent(){return this._pendingEvent}notifyUpdate(){}isRelatedToId(e){return e&&e===this._pendingEvent.relatedTxnId?!0:super.isRelatedToId(e)}get relatedEventId(){return this._pendingEvent.relatedEventId}get redactingEntry(){return this._redactingEntry}};var V=fe("Waiting","EncryptingAttachments","UploadingAttachments","Encrypting","Sending","Sent","Error"),du=["m.relates_to"],er=class{constructor({data:e,remove:t,emitUpdate:s,attachments:r}){this._data=e,this._attachments=r,this._emitUpdate=s,this._removeFromQueueCallback=t,this._aborted=!1,this._status=V.Waiting,this._sendRequest=null,this._attachmentsTotalBytes=0,this._attachments&&(this._attachmentsTotalBytes=Object.values(this._attachments).reduce((n,o)=>n+o.size,0))}get roomId(){return this._data.roomId}get queueIndex(){return this._data.queueIndex}get eventType(){return this._data.eventType}get txnId(){return this._data.txnId}get remoteId(){return this._data.remoteId}get content(){return this._data.content}get relatedTxnId(){return this._data.relatedTxnId}get relatedEventId(){let e=Le(this.content);return e?Xs(e):this._data.relatedEventId}setRelatedEventId(e){let t=Le(this.content);t?Jr(t,e):this._data.relatedEventId=e}get data(){return this._data}getAttachment(e){return this._attachments&&this._attachments[e]}get needsSending(){return!this.remoteId&&!this.aborted}get needsEncryption(){return this._data.needsEncryption&&!this.aborted}get needsUpload(){return this._data.needsUpload&&!this.aborted}get isMissingAttachments(){return this.needsUpload&&!this._attachments}setEncrypting(){this._status=V.Encrypting,this._emitUpdate("status")}get contentForEncryption(){let e=Object.assign({},this._data.content);for(let t of du)delete e[t];return e}_preserveContentFields(e){let t=this._data.content;for(let s of du)t[s]!==void 0&&(e[s]=t[s])}setEncrypted(e,t){this._preserveContentFields(t),this._data.encryptedEventType=e,this._data.encryptedContent=t,this._data.needsEncryption=!1}setError(e){this._status=V.Error,this._error=e,this._emitUpdate("status")}setWaiting(){this._status=V.Waiting,this._emitUpdate("status")}get status(){return this._status}get error(){return this._error}get hasStartedSending(){return this._status===V.Sending||this._status===V.Sent}get attachmentsTotalBytes(){return this._attachmentsTotalBytes}get attachmentsSentBytes(){return this._attachments&&Object.values(this._attachments).reduce((e,t)=>e+t.sentBytes,0)}async uploadAttachments(e,t){if(!this.needsUpload)return;if(!this._attachments)throw new Error("attachments missing");if(this.needsEncryption){this._status=V.EncryptingAttachments,this._emitUpdate("status");for(let r of Object.values(this._attachments))if(await t.wrap("encrypt",()=>(t.set("size",r.size),r.encrypt())),this.aborted)throw new j}this._status=V.UploadingAttachments,this._emitUpdate("status");let s=Object.entries(this._attachments);s.sort(([,r],[,n])=>r.size-n.size);for(let[r,n]of s)await t.wrap("upload",o=>(o.set("size",n.size),n.upload(e,()=>{this._emitUpdate("attachmentsSentBytes")},o))),n.applyToContent(r,this.content);this._data.needsUpload=!1}async abort(){if(!this._aborted){if(this._aborted=!0,this._attachments)for(let e of Object.values(this._attachments))e.abort();this._sendRequest?.abort(),await this._removeFromQueueCallback()}}get aborted(){return this._aborted}async send(e,t){this._status=V.Sending,this._emitUpdate("status");let s=this._data.encryptedEventType||this._data.eventType,r=this._data.encryptedContent||this._data.content;s===de?this._sendRequest=e.redact(this.roomId,this._data.relatedEventId,this.txnId,r,{log:t}):this._sendRequest=e.send(this.roomId,s,this.txnId,r,{log:t});let n=await this._sendRequest.response();this._sendRequest=null,this._data.remoteId=n.event_id,t.set("id",this._data.remoteId),this._status=V.Sent,this._emitUpdate("status")}dispose(){if(this._attachments)for(let e of Object.values(this._attachments))e.dispose()}};var Y=class extends Zs{constructor(e,t){super(t);this._eventEntry=e,this._decryptionError=null,this._decryptionResult=null}clone(){let e=new Y(this._eventEntry,this._fragmentIdComparer);return e.updateFrom(this),e}updateFrom(e){e._decryptionResult&&!this._decryptionResult&&(this._decryptionResult=e._decryptionResult),e._decryptionError&&!this._decryptionError&&(this._decryptionError=e._decryptionError)}get event(){return this._eventEntry.event}get fragmentId(){return this._eventEntry.fragmentId}get entryIndex(){return this._eventEntry.eventIndex}get content(){return this._decryptionResult?.event?.content||this._eventEntry.event.content}get prevContent(){return Ys(this._eventEntry.event)}get eventType(){return this._decryptionResult?.event?.type||this._eventEntry.event.type}get stateKey(){return this._eventEntry.event.state_key}get sender(){return this._eventEntry.event.sender}get displayName(){return this._eventEntry.displayName}get avatarUrl(){return this._eventEntry.avatarUrl}get timestamp(){return this._eventEntry.event.origin_server_ts}get id(){return this._eventEntry.event.event_id}setDecryptionResult(e){this._decryptionResult=e}get isEncrypted(){return this._eventEntry.event.type==="m.room.encrypted"}get isDecrypted(){return!!this._decryptionResult?.event}get isVerified(){return this.isEncrypted&&this._decryptionResult?.isVerified}get isUnverified(){return this.isEncrypted&&this._decryptionResult?.isUnverified}setDecryptionError(e){this._decryptionError=e}get decryptionError(){return this._decryptionError}get relatedEventId(){return lu(this.event)}get isRedacted(){return super.isRedacted||Js(this._eventEntry.event)}get redactionReason(){let e=this._eventEntry.event.unsigned?.redacted_because;return e?e.content?.reason:super.redactionReason}get annotations(){return this._eventEntry.annotations}get relation(){let e=this._eventEntry.event.content;return e&&Le(e)||Le(this.content)}};function tr(i,e,t){return{fragmentId:i.fragmentId,eventIndex:i.eventIndex,roomId:e,event:t}}function Kt(i,e,t){t.isForward?i.push(e):i.unshift(e)}function mu(i,e,t){return t.isForward?i.concat(e):e.concat(i)}var ie="m.room.member",L=class{constructor(e){this._data=e}static fromUserId(e,t,s){return new L({roomId:e,userId:t,membership:s})}static fromMemberEvent(e,t){let s=t?.state_key;if(typeof s!="string")return;let r=t.content,n=Ys(t),o=r?.membership,a=r?.displayname||n?.displayname,l=r?.avatar_url||n?.avatar_url;return this._validateAndCreateMember(e,s,o,a,l)}static fromReplacingMemberEvent(e,t){let s=t&&t.state_key;if(typeof s!="string")return;let r=Ys(t);return this._validateAndCreateMember(e,s,r?.membership,r?.displayname,r?.avatar_url)}static _validateAndCreateMember(e,t,s,r,n){if(typeof s=="string")return new L({roomId:e,userId:t,membership:s,avatarUrl:n,displayName:r})}get membership(){return this._data.membership}get displayName(){return this._data.displayName}get name(){return this._data.displayName||this._data.userId}get avatarUrl(){return this._data.avatarUrl}get roomId(){return this._data.roomId}get userId(){return this._data.userId}serialize(){return this._data}equals(e){let t=this._data,s=e._data;return t.roomId===s.roomId&&t.userId===s.userId&&t.membership===s.membership&&t.displayName===s.displayName&&t.avatarUrl===s.avatarUrl}},sr=class{constructor(e,t){this.member=e,this.previousMembership=t}get roomId(){return this.member.roomId}get userId(){return this.member.userId}get membership(){return this.member.membership}get hasLeft(){return this.previousMembership==="join"&&this.membership!=="join"}get hasJoined(){return this.previousMembership!=="join"&&this.membership==="join"}};function rr(i){return typeof i=="number"}function wp(i,e){let t=[];for(;rr(i.previousId);){let s=e.get(i.previousId);if(!s)break;if(s.nextId!==i.id)throw new Error(`Previous fragment ${s.id} doesn't point back to ${i.id}`);e.delete(i.previousId),t.unshift(s),i=s}return t}function vp(i,e){let t=[];for(;rr(i.nextId);){let s=e.get(i.nextId);if(!s)break;if(s.previousId!==i.id)throw new Error(`Next fragment ${s.id} doesn't point back to ${i.id}`);e.delete(i.nextId),t.push(s),i=s}return t}function bp(i){let e=new Map;for(let s of i)e.set(s.id,s);let t=[];for(;e.size;){let s=e.values().next().value;e.delete(s.id);let r=wp(s,e),n=vp(s,e),o=r.concat(s,n);t.push(o)}return t.map(s=>new hu(s))}var Zr=class{constructor(e,t,s){this.id=e,this.previousId=t,this.nextId=s}},hu=class{constructor(e){this._idToSortIndex=new Map,e.forEach((t,s)=>{this._idToSortIndex.set(t.id,s)})}compare(e,t){let s=this._idToSortIndex.get(e);if(s===void 0)throw new Error(`first id ${e} isn't part of this island`);let r=this._idToSortIndex.get(t);if(r===void 0)throw new Error(`second id ${t} isn't part of this island`);return s-r}get fragmentIds(){return this._idToSortIndex.keys()}},Dn=class extends Error{get name(){return"CompareError"}},jt=class{constructor(e){this._fragmentsById=e.reduce((t,s)=>(t.set(s.id,s),t),new Map),this.rebuild(e)}_getIsland(e){let t=this._idToIsland.get(e);if(t===void 0)throw new Dn(`Unknown fragment id ${e}`);return t}compare(e,t){if(e===t)return 0;let s=this._getIsland(e),r=this._getIsland(t);if(s!==r)throw new Dn(`${e} and ${t} are on different islands, can't tell order`);return s.compare(e,t)}rebuild(e){let t=bp(e);this._idToIsland=new Map;for(let s of t)for(let r of s.fragmentIds)this._idToIsland.set(r,s)}add(e){let t=new Zr(e.id,e.previousId,e.nextId);this._fragmentsById.set(e.id,t),this.rebuild(this._fragmentsById.values())}append(e,t){let s=new Zr(e,t,null),r=this._fragmentsById.get(t);r&&(r.nextId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}prepend(e,t){let s=new Zr(e,null,t),r=this._fragmentsById.get(t);r&&(r.previousId=e),this._fragmentsById.set(e,s),this.rebuild(this._fragmentsById.values())}};function Ip(i){return"objectStore"in i?`${i.objectStore.name}.${i.name}`:i.name}function Sp(i){return"objectStore"in i?i.objectStore?.transaction?.db?.name:i.transaction?.db?.name}var Vn=class extends ue{constructor(e,t,s=null){let r=t&&"source"in t?t.source:t,n=r?Ip(r):"",o=r?Sp(r):"",a=`${e} on ${o}.${n}`;s&&(a+=": ",typeof s.name=="string"&&(a+=`(name: ${s.name}) `),typeof s.code=="number"&&(a+=`(code: ${s.code}) `)),s&&(a+=s.message);super(a,s);this.storeName=n,this.databaseName=o}},xs=class extends Vn{constructor(e){let t=e.target,s=t.source,r=t.error;super("IDBRequest failed",s,r);this.errorEvent=e}preventTransactionAbort(){this.errorEvent.preventDefault()}},Ze=class extends Vn{constructor(e,t,s,r){super(`${e}(${r.map(n=>JSON.stringify(n)).join(", ")}) failed`,t,s)}};var $t=!1,qn={done:!0},De={done:!1};function Ht(i){let e=i.toString(16);return"0".repeat(8-e.length)+e}function ir(i){return parseInt(i,16)}function Wt(i,e,t,s=window.indexedDB){let r=s.open(i,t);return r.onupgradeneeded=async n=>{let o=n.target,a=o.result,l=o.transaction,c=n.oldVersion;try{await e(a,l,c,t)}catch{try{l.abort()}catch{}}},z(r)}function z(i){return new Promise((e,t)=>{i.addEventListener("success",s=>{e(s.target.result),$t&&Promise._flush&&Promise._flush()}),i.addEventListener("error",s=>{let r=new xs(s);t(r),$t&&Promise._flush&&Promise._flush()})})}function mt(i){let e;return new Promise((t,s)=>{i.addEventListener("complete",()=>{t(),$t&&Promise._flush&&Promise._flush()}),i.addEventListener("abort",r=>{s(new j),$t&&Promise._flush&&Promise._flush()})})}function H(i,e){return new Promise((t,s)=>{i.onerror=r=>{s(new xs(r)),$t&&Promise._flush&&Promise._flush()},i.onsuccess=r=>{let n=r.target.result;if(!n){t(!1),$t&&Promise._flush&&Promise._flush();return}let o=e(n.value,n.key,n),a=o?.done,l=o?.jumpTo;a?(t(!0),$t&&Promise._flush&&Promise._flush()):l?n.continue(l):n.continue()}}).catch(t=>{throw new ue("iterateCursor failed",t)})}async function pu(i,e){let t=[];return await H(i,s=>(t.push(s),{done:e(t)})),t}var ei=class{constructor(e,t){this._target=e,this._transaction=t}get idbFactory(){return this._transaction.idbFactory}get IDBKeyRange(){return this._transaction.IDBKeyRange}get databaseName(){return this._transaction.databaseName}_openCursor(e,t){return e&&t?this._target.openCursor(e,t):e?this._target.openCursor(e):t?this._target.openCursor(null,t):this._target.openCursor()}supports(e){return this._target.supports(e)}get(e){return z(this._target.get(e))}getKey(e){return this._target.supports("getKey")?z(this._target.getKey(e)):z(this._target.get(e)).then(t=>{if(t){let s=this._target.keyPath;return typeof s=="string"&&(s=[s]),s.reduce((r,n)=>r[n],t)}})}reduce(e,t,s){return this._reduce(e,t,s,"next")}reduceReverse(e,t,s){return this._reduce(e,t,s,"prev")}selectLimit(e,t){return this._selectLimit(e,t,"next")}selectLimitReverse(e,t){return this._selectLimit(e,t,"prev")}selectWhile(e,t){return this._selectWhile(e,t,"next")}selectWhileReverse(e,t){return this._selectWhile(e,t,"prev")}async selectAll(e,t){let s=this._openCursor(e,t),r=[];return await H(s,n=>(r.push(n),De)),r}selectFirst(e){return this._find(e,()=>!0,"next")}selectLast(e){return this._find(e,()=>!0,"prev")}find(e,t){return this._find(e,t,"next")}findReverse(e,t){return this._find(e,t,"prev")}async findMaxKey(e){let t=this._target.openKeyCursor(e,"prev"),s;return await H(t,(r,n)=>(s=n,qn)),s}async iterateValues(e,t){let s=this._target.openCursor(e,"next");await H(s,(r,n,o)=>({done:t(r,n,o)}))}async iterateKeys(e,t){let s=this._target.openKeyCursor(e,"next");await H(s,(r,n,o)=>({done:t(n,o)}))}async findExistingKeys(e,t,s){let r=(d,p)=>t?-this.idbFactory.cmp(d,p):this.idbFactory.cmp(d,p),n=e.slice().sort(r),o=n[0],a=n[n.length-1],l=t?"prev":"next",c=this._target.openKeyCursor(this.IDBKeyRange.bound(o,a),l),u=0;await H(c,(d,p,f)=>{for(;u<n.length&&r(n[u],p)<0;)u+=1;let g=!1;if(n[u]===p){let w=f.primaryKey;g=s(p,w),u+=1}return g||u>=n.length?qn:{done:!1,jumpTo:n[u]}})}_reduce(e,t,s,r){let n=s,o=this._openCursor(e,r);return H(o,a=>(n=t(n,a),De))}_selectLimit(e,t,s){return this._selectUntil(e,r=>r.length===t,s)}async _selectUntil(e,t,s){let r=this._openCursor(e,s),n=[];return await H(r,o=>(n.push(o),{done:t(n,o)})),n}async _selectWhile(e,t,s){let r=this._openCursor(e,s),n=[];return await H(r,o=>{let a=t(o);return a&&n.push(o),{done:!a}}),n}async iterateWhile(e,t){let s=this._openCursor(e,"next");await H(s,r=>({done:!t(r)}))}async _find(e,t,s){let r=this._openCursor(e,s),n;if(await H(r,a=>{let l=t(a);return l&&(n=a),{done:l}}))return n}};var xt=!1;function Tt(i,e,t){let s=t?.name,r=t?.transaction?.db?.name;console.info(`${r}.${s}.${i}(${e.map(n=>JSON.stringify(n)).join(", ")})`)}var Bn=class{constructor(e){this._qt=e}get keyPath(){return this._qtStore.keyPath}get _qtStore(){return"objectStore"in this._qt?this._qt.objectStore:this._qt}supports(e){return!!this._qt[e]}openKeyCursor(e,t){try{return this._qt.openKeyCursor?(xt&&Tt("openKeyCursor",[e,t],this._qt),this._qt.openKeyCursor(e,t)):(xt&&Tt("openCursor",[e,t],this._qt),this.openCursor(e,t))}catch(s){throw new Ze("openKeyCursor",this._qt,s,[e,t])}}openCursor(e,t){try{return xt&&Tt("openCursor",[],this._qt),this._qt.openCursor(e,t)}catch(s){throw new Ze("openCursor",this._qt,s,[e,t])}}put(e,t){try{return xt&&Tt("put",[e,t],this._qt),this._qtStore.put(e,t)}catch(s){throw new Ze("put",this._qt,s,[e,t])}}add(e,t){try{return xt&&Tt("add",[e,t],this._qt),this._qtStore.add(e,t)}catch(s){throw new Ze("add",this._qt,s,[e,t])}}get(e){try{return xt&&Tt("get",[e],this._qt),this._qt.get(e)}catch(t){throw new Ze("get",this._qt,t,[e])}}getKey(e){try{return xt&&Tt("getKey",[e],this._qt),this._qt.getKey(e)}catch(t){throw new Ze("getKey",this._qt,t,[e])}}delete(e){try{return xt&&Tt("delete",[e],this._qt),this._qtStore.delete(e)}catch(t){throw new Ze("delete",this._qt,t,[e])}}index(e){try{return this._qtStore.index(e)}catch(t){throw new Ze("index",this._qt,t,[e])}}get indexNames(){return Array.from(this._qtStore.indexNames)}},Ts=class extends ei{constructor(e,t){super(new Bn(e),t)}get _idbStore(){return this._target}index(e){return new ei(new Bn(this._idbStore.index(e)),this._transaction)}put(e,t){let s=this._idbStore.put(e);this._prepareErrorLog(s,t,"put",void 0,e)}add(e,t){let s=this._idbStore.add(e);this._prepareErrorLog(s,t,"add",void 0,e)}async tryAdd(e,t){try{return await z(this._idbStore.add(e)),!0}catch(s){if(s instanceof xs)return t.log({l:"could not write",id:this._getKeys(e),e:s},t.level.Warn),s.preventTransactionAbort(),!1;throw s}}delete(e,t){let s=this._idbStore.delete(e);this._prepareErrorLog(s,t,"delete",e,void 0)}_prepareErrorLog(e,t,s,r,n){t&&t.ensureRefId(),z(e).catch(o=>{let a;n?a=this._getKeys(n):r&&(a=[r]),this._transaction.addWriteError(o,t,s,a)})}_getKeys(e){let t=[],{keyPath:s}=this._idbStore;try{t.push(this._readKeyPath(e,s))}catch{console.warn("could not read keyPath",s)}for(let r of this._idbStore.indexNames)try{let n=this._idbStore.index(r);t.push(this._readKeyPath(e,n.keyPath))}catch{console.warn("could not read index",r)}return t}_readKeyPath(e,t){if(Array.isArray(t)){let s=e;for(let r of t)if(typeof s=="object")s=s[r];else break;return s}else return e[t]}};function fu(i){return JSON.stringify(_u(i))}function gu(i){return yu(JSON.parse(i))}function _u(i){if(typeof i=="object"&&i!==null&&!Array.isArray(i)){if(i.byteLength)return{_type:i.constructor.name,value:Array.from(i)};let e={};for(let t in i)i.hasOwnProperty(t)&&(e[t]=_u(i[t]));return e}else return i}function yu(i){if(typeof i=="object"&&i!==null&&!Array.isArray(i)){if(typeof i._type=="string")switch(i._type){case"Int8Array":return Int8Array.from(i.value);case"Uint8Array":return Uint8Array.from(i.value);case"Uint8ClampedArray":return Uint8ClampedArray.from(i.value);case"Int16Array":return Int16Array.from(i.value);case"Uint16Array":return Uint16Array.from(i.value);case"Int32Array":return Int32Array.from(i.value);case"Uint32Array":return Uint32Array.from(i.value);case"Float32Array":return Float32Array.from(i.value);case"Float64Array":return Float64Array.from(i.value);case"BigInt64Array":return BigInt64Array.from(i.value);case"BigUint64Array":return BigUint64Array.from(i.value);default:return i.value}let e={};for(let t in i)i.hasOwnProperty(t)&&(e[t]=yu(i[t]));return e}else return i}var Rs=class{constructor(e,t){this._sessionStore=e,this._localStorage=t}get _localStorageKeyPrefix(){return`${this._sessionStore.databaseName}.session.`}async get(e){let t=await this._sessionStore.get(e);if(t)return t.value}_writeKeyToLocalStorage(e,t){try{let s=this._localStorageKeyPrefix+e,r=fu(t);this._localStorage.setItem(s,r)}catch(s){console.error("could not write to localStorage",s)}}writeE2EEIdentityToLocalStorage(){this._sessionStore.iterateValues(void 0,(e,t)=>(t.startsWith(_e)&&this._writeKeyToLocalStorage(t,e.value),!1))}async tryRestoreE2EEIdentityFromLocalStorage(e){let t=!1,s=this._localStorageKeyPrefix,r=s+_e;for(let n=0;n<this._localStorage.length;n+=1){let o=this._localStorage.key(n);if(o.startsWith(r)){let a=gu(this._localStorage.getItem(o)),l=o.substr(s.length),c=await this._sessionStore.getKey(l)===l;e.set(l,!c),c||(this._sessionStore.put({key:l,value:a}),t=!0)}}return t}set(e,t){e.startsWith(_e)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.put({key:e,value:t})}add(e,t){e.startsWith(_e)&&this._writeKeyToLocalStorage(e,t),this._sessionStore.add({key:e,value:t})}remove(e){e.startsWith(_e)&&this._localStorage.removeItem(this._localStorageKeyPrefix+e),this._sessionStore.delete(e)}};var ti=class{constructor(e){this._summaryStore=e}getAll(){return this._summaryStore.selectAll()}set(e){this._summaryStore.put(e)}get(e){return this._summaryStore.get(e)}async has(e){let t=await this._summaryStore.getKey(e);return e===t}remove(e){this._summaryStore.delete(e)}};var On=class{constructor(e){this._inviteStore=e}getAll(){return this._inviteStore.selectAll()}set(e){this._inviteStore.put(e)}remove(e){this._inviteStore.delete(e)}};var Re=(l=>(l[l.All=1]="All",l[l.Debug=2]="Debug",l[l.Detail=3]="Detail",l[l.Info=4]="Info",l[l.Warn=5]="Warn",l[l.Error=6]="Error",l[l.Fatal=7]="Fatal",l[l.Off=8]="Off",l))(Re||{}),ks=class{constructor(e){this._parentFilter=e}filter(e,t){return!(this._parentFilter&&!this._parentFilter.filter(e,t)||this._min!==void 0&&!Array.isArray(t)&&e.logLevel<this._min)}minLevel(e){return this._min=e,this}};function si(){}var ri=class{constructor(){this.item=new Rt(this)}log(){}run(e,t){return t(this.item)}wrapOrRun(e,t,s){return e?e.wrap(t,s):this.run(t,s)}runDetached(e,t){return new Promise(s=>s(t(this.item))).then(si,si),this.item}async export(){}get level(){return Re}},Rt=class{constructor(e){this.logger=e}wrap(e,t){return t(this)}log(){return this}set(){}runDetached(e,t){return new Promise(s=>s(t(this))).then(si,si),this}wrapDetached(e,t){return this.refDetached()}refDetached(){}ensureRefId(){}get level(){return Re}get duration(){return 0}catch(e){return e}child(){return this}finish(){}serialize(){}},nr=new ri;function Ue(i,e,t){return`${i}|${Ht(e)}|${Ht(t)}`}function Ep(i){let[e,t,s]=i.split("|");return{roomId:e,eventKey:new U(ir(t),ir(s))}}function ii(i,e){return`${i}|${e}`}function wu(i){let[e,t]=i.split("|");return{roomId:e,eventId:t}}var or=class{constructor(e,t,s,r,n=!1,o=!1){this._IDBKeyRange=e,this._only=t,this._lower=s,this._upper=r,this._lowerOpen=n,this._upperOpen=o}asIDBKeyRange(e){try{if(this._only)return this._IDBKeyRange.only(Ue(e,this._only.fragmentId,this._only.eventIndex));if(this._lower&&!this._upper)return this._IDBKeyRange.bound(Ue(e,this._lower.fragmentId,this._lower.eventIndex),Ue(e,this._lower.fragmentId,O.maxStorageKey),this._lowerOpen,!1);if(!this._lower&&this._upper)return this._IDBKeyRange.bound(Ue(e,this._upper.fragmentId,O.minStorageKey),Ue(e,this._upper.fragmentId,this._upper.eventIndex),!1,this._upperOpen);if(this._lower&&this._upper)return this._IDBKeyRange.bound(Ue(e,this._lower.fragmentId,this._lower.eventIndex),Ue(e,this._upper.fragmentId,this._upper.eventIndex),this._lowerOpen,this._upperOpen)}catch(t){throw new ue("IDBKeyRange failed with data: "+JSON.stringify(this),t)}}},Nn=class{constructor(e){this._timelineStore=e}onlyRange(e){return new or(this._timelineStore.IDBKeyRange,e)}upperBoundRange(e,t=!1){return new or(this._timelineStore.IDBKeyRange,void 0,void 0,e,void 0,t)}lowerBoundRange(e,t=!1){return new or(this._timelineStore.IDBKeyRange,void 0,e,void 0,t)}boundRange(e,t,s=!1,r=!1){return new or(this._timelineStore.IDBKeyRange,void 0,e,t,s,r)}async lastEvents(e,t,s){let r=U.maxKey;return r.fragmentId=t,this.eventsBefore(e,r,s)}async firstEvents(e,t,s){let r=U.minKey;return r.fragmentId=t,this.eventsAfter(e,r,s)}eventsAfter(e,t,s){let r=this.lowerBoundRange(t,!0).asIDBKeyRange(e);return this._timelineStore.selectLimit(r,s)}async eventsBefore(e,t,s){let r=this.upperBoundRange(t,!0).asIDBKeyRange(e),n=await this._timelineStore.selectLimitReverse(r,s);return n.reverse(),n}async getEventKeysForIds(e,t){let s=this._timelineStore.index("byEventId"),r=t.map(o=>ii(e,o)),n=new Map;return await s.findExistingKeys(r,!1,(o,a)=>{let{eventId:l}=wu(o),{eventKey:c}=Ep(a);return n.set(l,c),!1}),n}async findFirstOccurringEventId(e,t){let s=this._timelineStore.index("byEventId"),r=t.map(l=>ii(e,l)),n=new Array(r.length),o;function a(){for(let l=0;l<n.length;++l){if(n[l]===void 0)return;if(n[l]===!0)return r[l]}}return await s.findExistingKeys(r,!1,(l,c)=>{let u=r.indexOf(l);return n[u]=c,o=a(),!!o}),o&&wu(o).eventId}tryInsert(e,t){return e.key=Ue(e.roomId,e.fragmentId,e.eventIndex),e.eventIdKey=ii(e.roomId,e.event.event_id),this._timelineStore.tryAdd(e,t)}update(e){this._timelineStore.put(e)}get(e,t){return this._timelineStore.get(Ue(e,t.fragmentId,t.eventIndex))}getByEventId(e,t){return this._timelineStore.index("byEventId").get(ii(e,t))}removeAllForRoom(e){let t=Ue(e,O.minStorageKey,O.minStorageKey),s=Ue(e,O.maxStorageKey,O.maxStorageKey),r=this._timelineStore.IDBKeyRange.bound(t,s);this._timelineStore.delete(r)}};var J="\0",F="\u{10FFFF}";function et(i,e,t,s){return`${i}|${e}|${t}|${s}`}function vu(i){let[e,t,s,r]=i.split("|");return{roomId:e,targetEventId:t,relType:s,sourceEventId:r}}var Pn=class{constructor(e){this._store=e}add(e,t,s,r){this._store.add({key:et(e,t,s,r)})}remove(e,t,s,r){this._store.delete(et(e,t,s,r))}removeAllForTarget(e,t){let s=this._store.IDBKeyRange.bound(et(e,t,J,J),et(e,t,F,F),!0,!0);this._store.delete(s)}removeAllForRoom(e){let t=this._store.IDBKeyRange.bound(et(e,J,J,J),et(e,F,F,F),!0,!0);this._store.delete(t)}async getForTargetAndType(e,t,s){let r=this._store.IDBKeyRange.bound(et(e,t,s,J),et(e,t,s,F),!0,!0);return(await this._store.selectAll(r)).map(o=>vu(o.key))}async getAllForTarget(e,t){let s=this._store.IDBKeyRange.bound(et(e,t,J,J),et(e,t,F,F),!0,!0);return(await this._store.selectAll(s)).map(n=>vu(n.key))}};function bu(i,e,t){return`${i}|${e}|${t}`}var Fn=class{constructor(e){this._roomStateStore=e}get(e,t,s){let r=bu(e,t,s);return this._roomStateStore.get(r)}set(e,t){let s=bu(e,t.type,t.state_key),r={roomId:e,event:t,key:s};this._roomStateStore.put(r)}removeAllForRoom(e){let t=this._roomStateStore.IDBKeyRange.bound(e,`${e}|${F}`,!0,!0);this._roomStateStore.delete(t)}};function ni(i,e){return`${i}|${e}`}function xp(i){let[e,t]=i.split("|");return{roomId:e,userId:t}}var ar=class{constructor(e){this._roomMembersStore=e}get(e,t){return this._roomMembersStore.get(ni(e,t))}set(e){e.key=ni(e.roomId,e.userId),this._roomMembersStore.put(e)}getAll(e){let t=this._roomMembersStore.IDBKeyRange.lowerBound(ni(e,""));return this._roomMembersStore.selectWhile(t,s=>s.roomId===e)}async getAllUserIds(e){let t=[],s=this._roomMembersStore.IDBKeyRange.lowerBound(ni(e,""));return await this._roomMembersStore.iterateKeys(s,r=>{let n=xp(r);return n.roomId===e?(t.push(n.userId),!1):!0}),t}removeAllForRoom(e){let t=this._roomMembersStore.IDBKeyRange.bound(e,`${e}|${F}`,!0,!0);this._roomMembersStore.delete(t)}};function oi(i,e){return`${i}|${Ht(e)}`}var Un=class{constructor(e){this._store=e}_allRange(e){try{return this._store.IDBKeyRange.bound(oi(e,O.minStorageKey),oi(e,O.maxStorageKey))}catch(t){throw new ue(`error from IDBKeyRange with roomId ${e}`,t)}}all(e){return this._store.selectAll(this._allRange(e))}liveFragment(e){return this._store.findReverse(this._allRange(e),t=>typeof t.nextId!="number"&&typeof t.nextToken!="string")}add(e){e.key=oi(e.roomId,e.id),this._store.add(e)}update(e){this._store.put(e)}get(e,t){return this._store.get(oi(e,t))}removeAllForRoom(e){this._store.delete(this._allRange(e))}};function zt(i,e){return`${i}|${Ht(e)}`}function Tp(i){let[e,t]=i.split("|"),s=ir(t);return{roomId:e,queueIndex:s}}var Kn=class{constructor(e){this._eventStore=e}async getMaxQueueIndex(e){let t=this._eventStore.IDBKeyRange.bound(zt(e,O.minStorageKey),zt(e,O.maxStorageKey),!1,!1),s=await this._eventStore.findMaxKey(t);if(s)return Tp(s).queueIndex}remove(e,t){let s=this._eventStore.IDBKeyRange.only(zt(e,t));this._eventStore.delete(s)}async exists(e,t){let s=this._eventStore.IDBKeyRange.only(zt(e,t));return!!await this._eventStore.getKey(s)}add(e){e.key=zt(e.roomId,e.queueIndex),this._eventStore.add(e)}update(e){this._eventStore.put(e)}getAll(){return this._eventStore.selectAll()}removeAllForRoom(e){let t=zt(e,O.minStorageKey),s=zt(e,O.maxStorageKey),r=this._eventStore.IDBKeyRange.bound(t,s);this._eventStore.delete(r)}};var jn=class{constructor(e){this._store=e}get(e){return this._store.get(e)}set(e){this._store.put(e)}remove(e){this._store.delete(e)}};function Gt(i,e){return`${i}|${e}`}function Rp(i){let[e,t]=i.split("|");return{userId:e,deviceId:t}}var $n=class{constructor(e){this._store=e}getAllForUserId(e){let t=this._store.IDBKeyRange.lowerBound(Gt(e,""));return this._store.selectWhile(t,s=>s.userId===e)}async getAllDeviceIds(e){let t=[],s=this._store.IDBKeyRange.lowerBound(Gt(e,""));return await this._store.iterateKeys(s,r=>{let n=Rp(r);return n.userId===e?(t.push(n.deviceId),!1):!0}),t}get(e,t){return this._store.get(Gt(e,t))}set(e){e.key=Gt(e.userId,e.deviceId),this._store.put(e)}getByCurve25519Key(e){return this._store.index("byCurve25519Key").get(e)}remove(e,t){this._store.delete(Gt(e,t))}removeAllForUser(e){let t=this._store.IDBKeyRange.bound(Gt(e,J),Gt(e,F),!0,!0);this._store.delete(t)}};function lr(i,e){return`${i}|${e}`}function kp(i){let[e,t]=i.split("|");return{senderKey:e,sessionId:t}}var Hn=class{constructor(e){this._store=e}async getSessionIds(e){let t=[],s=this._store.IDBKeyRange.lowerBound(lr(e,""));return await this._store.iterateKeys(s,r=>{let n=kp(r);return n.senderKey===e?(t.push(n.sessionId),!1):!0}),t}getAll(e){let t=this._store.IDBKeyRange.lowerBound(lr(e,""));return this._store.selectWhile(t,s=>s.senderKey===e)}get(e,t){return this._store.get(lr(e,t))}set(e){e.key=lr(e.senderKey,e.sessionId),this._store.put(e)}remove(e,t){this._store.delete(lr(e,t))}};function cr(i,e,t){return`${i}|${e}|${t}`}var Wn=class{constructor(e){this._store=e}async has(e,t,s){let r=cr(e,t,s),n=await this._store.getKey(r);return r===n}get(e,t,s){return this._store.get(cr(e,t,s))}set(e){let t=e;t.key=cr(e.roomId,e.senderKey,e.sessionId),this._store.put(t)}removeAllForRoom(e){let t=this._store.IDBKeyRange.bound(cr(e,J,J),cr(e,F,F));this._store.delete(t)}};var zn=class{constructor(e){this._store=e}remove(e){this._store.delete(e)}get(e){return this._store.get(e)}set(e){this._store.put(e)}};function ai(i,e,t){return`${i}|${e}|${t}`}var Gn=class{constructor(e){this._store=e}get(e,t,s){return this._store.get(ai(e,t,s))}set(e,t,s,r){r.key=ai(e,t,s),this._store.put(r)}removeAllForRoom(e){let t=this._store.IDBKeyRange.bound(ai(e,J,J),ai(e,F,F));this._store.delete(t)}};function As(i,e){return`${i}|${e}`}var Qn=class{constructor(e){this._store=e}getAll(){return this._store.selectAll()}async getAllByTypeAndScope(e,t){let s=As(t,e),r=[];return await this._store.index("byScopeAndType").iterateWhile(s,n=>n.scopeTypeKey!==s?!1:(r.push(n),!0)),r}add(e){e.scopeTypeKey=As(e.scope,e.type),this._store.add(e)}update(e){this._store.put(e)}remove(e){this._store.delete(e)}async removeAllForScope(e){let t=this._store.IDBKeyRange.bound(As(e,J),As(e,F));await this._store.index("byScopeAndType").iterateValues(t,(r,n,o)=>(o.delete(),!0))}};var Yn=class{constructor(e){this._store=e}async get(e){return await this._store.get(e)}set(e){this._store.put(e)}};var Iu=class{constructor(e,t,s,r){this.error=e;this.refItem=t;this.operationName=s;this.keys=r}},li=class{constructor(e,t,s){this._txn=e,this._allowedStoreNames=t,this._stores={},this._storage=s,this._writeErrors=[]}get idbFactory(){return this._storage.idbFactory}get IDBKeyRange(){return this._storage.IDBKeyRange}get databaseName(){return this._storage.databaseName}get logger(){return this._storage.logger}_idbStore(e){if(!this._allowedStoreNames.includes(e))throw new ue(`Invalid store for transaction: ${e}, only ${this._allowedStoreNames.join(", ")} are allowed.`);return new Ts(this._txn.objectStore(e),this)}_store(e,t){if(!this._stores[e]){let s=this._idbStore(e);this._stores[e]=t(s)}return this._stores[e]}get session(){return this._store($.session,e=>new Rs(e,this._storage.localStorage))}get roomSummary(){return this._store($.roomSummary,e=>new ti(e))}get archivedRoomSummary(){return this._store($.archivedRoomSummary,e=>new ti(e))}get invites(){return this._store($.invites,e=>new On(e))}get timelineFragments(){return this._store($.timelineFragments,e=>new Un(e))}get timelineEvents(){return this._store($.timelineEvents,e=>new Nn(e))}get timelineRelations(){return this._store($.timelineRelations,e=>new Pn(e))}get roomState(){return this._store($.roomState,e=>new Fn(e))}get roomMembers(){return this._store($.roomMembers,e=>new ar(e))}get pendingEvents(){return this._store($.pendingEvents,e=>new Kn(e))}get userIdentities(){return this._store($.userIdentities,e=>new jn(e))}get deviceIdentities(){return this._store($.deviceIdentities,e=>new $n(e))}get olmSessions(){return this._store($.olmSessions,e=>new Hn(e))}get inboundGroupSessions(){return this._store($.inboundGroupSessions,e=>new Wn(e))}get outboundGroupSessions(){return this._store($.outboundGroupSessions,e=>new zn(e))}get groupSessionDecryptions(){return this._store($.groupSessionDecryptions,e=>new Gn(e))}get operations(){return this._store($.operations,e=>new Qn(e))}get accountData(){return this._store($.accountData,e=>new Yn(e))}async complete(e){try{await mt(this._txn)}catch(t){throw this._writeErrors.length?(this._logWriteErrors(e),this._writeErrors[0].error):t}}getCause(e){return e instanceof ue&&e.errcode==="AbortError"&&this._writeErrors.length?this._writeErrors[0].error:e}abort(e){try{this._txn.abort()}catch{e?.set("couldNotAbortTxn",!0)}this._writeErrors.length&&this._logWriteErrors(e)}addWriteError(e,t,s,r){(e.errcode!=="AbortError"||this._writeErrors.length===0)&&this._writeErrors.push(new Iu(e,t,s,r))}_logWriteErrors(e){let t=r=>{e||r.set("allowedStoreNames",this._allowedStoreNames);for(let n of this._writeErrors)r.wrap({l:n.operationName,id:n.keys},o=>{n.refItem&&o.refDetached(n.refItem),o.catch(n.error)})},s=`${this._writeErrors.length} storage write operation(s) failed`;e?e.wrap(s,t):this.logger.run(s,t)}};var Su="782rh281re38-boguskey",Jn=class{constructor(e,t,s,r,n,o){this._db=e,this.idbFactory=t,this.IDBKeyRange=s,this._hasWebkitEarlyCloseTxnBug=r,this.storeNames=$,this.localStorage=n,this.logger=o}_validateStoreNames(e){let t=e.findIndex(s=>!Nt.includes(s));if(t!==-1)throw new ue(`Tried top, a transaction unknown store ${e[t]}`)}async readTxn(e){this._validateStoreNames(e);try{let t=this._db.transaction(e,"readonly");return this._hasWebkitEarlyCloseTxnBug&&await z(t.objectStore(e[0]).get(Su)),new li(t,e,this)}catch(t){throw new ue("readTxn failed",t)}}async readWriteTxn(e){this._validateStoreNames(e);try{let t=this._db.transaction(e,"readwrite");return this._hasWebkitEarlyCloseTxnBug&&await z(t.objectStore(e[0]).get(Su)),new li(t,e,this)}catch(t){throw new ue("readWriteTxn failed",t)}}close(){this._db.close()}get databaseName(){return this._db.name}};async function Eu(i){let e=i.transaction(Nt,"readonly"),t={};return await Promise.all(Nt.map(async s=>{let r=t[s]=[],n=e.objectStore(s);await H(n.openCursor(),o=>(r.push(o),De))})),t}async function xu(i,e){let t=i.transaction(Nt,"readwrite");for(let s of Nt){let r=t.objectStore(s);for(let n of e[s])r.add(n)}await mt(t)}var Xn=0,Tu=1;function Zn(i,e,t){if(i){if(!i.roomIds.includes(t))return i.roomIds.push(t),i}else return i={userId:e,roomIds:[t],deviceTrackingStatus:Xn},i}function Mp(i){let e=i.device_id;return{userId:i.user_id,deviceId:e,ed25519Key:i.keys[`ed25519:${e}`],curve25519Key:i.keys[`curve25519:${e}`],algorithms:i.algorithms,displayName:i.unsigned?.device_display_name}}var eo=class{constructor({storage:e,getSyncToken:t,olmUtil:s,ownUserId:r,ownDeviceId:n}){this._storage=e,this._getSyncToken=t,this._identityChangedForRoom=null,this._olmUtil=s,this._ownUserId=r,this._ownDeviceId=n}async writeDeviceChanges(e,t,s){let{userIdentities:r}=t;s.set("changed",e.length),await Promise.all(e.map(async n=>{let o=await r.get(n);o&&(s.log({l:"outdated",id:n}),o.deviceTrackingStatus=Xn,r.set(o))}))}writeMemberChanges(e,t,s){return Promise.all(Array.from(t.values()).map(async r=>this._applyMemberChange(r,s)))}async trackRoom(e,t){if(e.isTrackingMembers||!e.isEncrypted)return;let s=await e.loadMemberList(t);try{let r=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary,this._storage.storeNames.userIdentities]),n;try{n=e.writeIsTrackingMembers(!0,r);let o=Array.from(s.members.values());t.set("members",o.length),await this._writeJoinedMembers(o,r)}catch(o){throw r.abort(),o}await r.complete(),e.applyIsTrackingMembersChanges(n)}finally{s.release()}}async _writeJoinedMembers(e,t){await Promise.all(e.map(async s=>{s.membership==="join"&&await this._writeMember(s,t)}))}async _writeMember(e,t){let{userIdentities:s}=t,r=await s.get(e.userId),n=Zn(r,e.userId,e.roomId);n&&s.set(n)}async _removeRoomFromUserIdentity(e,t,s){let{userIdentities:r,deviceIdentities:n}=s,o=await r.get(t);o&&(o.roomIds=o.roomIds.filter(a=>a!==e),o.roomIds.length===0?(r.remove(t),n.removeAllForUser(t)):r.set(o))}async _applyMemberChange(e,t){if(e.hasJoined)await this._writeMember(e.member,t);else if(e.hasLeft){let{roomId:s}=e;if(e.userId===this._ownUserId){let r=await t.roomMembers.getAllUserIds(s);await Promise.all(r.map(n=>this._removeRoomFromUserIdentity(s,n,t)))}else await this._removeRoomFromUserIdentity(s,e.userId,t)}}async _queryKeys(e,t,s){let r=await t.queryKeys({timeout:1e4,device_keys:e.reduce((l,c)=>(l[c]=[],l),{}),token:this._getSyncToken()},{log:s}).response(),n=s.wrap("verify",l=>this._filterVerifiedDeviceKeys(r.device_keys,l)),o=await this._storage.readWriteTxn([this._storage.storeNames.userIdentities,this._storage.storeNames.deviceIdentities]),a;try{a=(await Promise.all(n.map(async({userId:c,verifiedKeys:u})=>{let d=u.map(Mp);return await this._storeQueriedDevicesForUserId(c,d,o)}))).reduce((c,u)=>c.concat(u),[]),s.set("devices",a.length)}catch(l){throw o.abort(),l}return await o.complete(),a}async _storeQueriedDevicesForUserId(e,t,s){let r=await s.deviceIdentities.getAllDeviceIds(e);for(let l of r)t.every(c=>c.deviceId!==l)&&s.deviceIdentities.remove(e,l);let n=[],o=[];t=await Promise.all(t.map(async l=>{if(r.includes(l.deviceId)){let c=await s.deviceIdentities.get(l.userId,l.deviceId);c.ed25519Key!==l.ed25519Key&&n.push(c)}n.push(l),o.push(l)}));for(let l of o)s.deviceIdentities.set(l);let a=await s.userIdentities.get(e);return a.deviceTrackingStatus=Tu,s.userIdentities.set(a),n}_filterVerifiedDeviceKeys(e,t){let s=new Set;return Object.entries(e).map(([n,o])=>{let l=Object.entries(o).filter(([c,u])=>{let d=u.device_id;if(u.user_id!==n||d!==c)return!1;let f=u.keys?.[`ed25519:${c}`],g=u.keys?.[`curve25519:${c}`];if(typeof f!="string"||typeof g!="string")return!1;if(s.has(g))return t.log({l:"ignore device with duplicate curve25519 key",keys:u},t.level.Warn),!1;s.add(g);let w=this._hasValidSignature(u,t);return w||t.log({l:"ignore device with invalid signature",keys:u},t.level.Warn),w}).map(([,c])=>c);return{userId:n,verifiedKeys:l}})}_hasValidSignature(e,t){let s=e.device_id,r=e.user_id,n=e?.keys?.[`${Rn}:${s}`];return Qr(this._olmUtil,r,s,n,e,t)}async devicesForTrackedRoom(e,t,s){let r=await this._storage.readTxn([this._storage.storeNames.roomMembers,this._storage.storeNames.userIdentities]),n=await r.roomMembers.getAllUserIds(e);return await this._devicesForUserIds(e,n,r,t,s)}async devicesForRoomMembers(e,t,s,r){let n=await this._storage.readTxn([this._storage.storeNames.userIdentities]);return await this._devicesForUserIds(e,t,n,s,r)}async _devicesForUserIds(e,t,s,r,n){let a=(await Promise.all(t.map(w=>s.userIdentities.get(w)))).filter(w=>w&&w.roomIds.includes(e)),l=a.filter(w=>w.deviceTrackingStatus===Tu),c=a.filter(w=>w.deviceTrackingStatus===Xn);n.set("uptodate",l.length),n.set("outdated",c.length);let u;c.length&&(u=await this._queryKeys(c.map(w=>w.userId),r,n));let d=await this._storage.readTxn([this._storage.storeNames.deviceIdentities]),f=(await Promise.all(l.map(w=>d.deviceIdentities.getAllForUserId(w.userId)))).reduce((w,C)=>w.concat(C),[]);return u&&u.length&&(f=f.concat(u)),f.filter(w=>!(w.userId===this._ownUserId&&w.deviceId===this._ownDeviceId))}async getDeviceByCurve25519Key(e,t){return await t.deviceIdentities.getByCurve25519Key(e)}};var to=[Ap,Cp,Lp,Dp,Vp,qp,Bp,Op,Np,Pp,Fp,Up,Kp,jp];function Ap(i){i.createObjectStore("session",{keyPath:"key"}),i.createObjectStore("roomSummary",{keyPath:"roomId"}),i.createObjectStore("timelineFragments",{keyPath:"key"}),i.createObjectStore("timelineEvents",{keyPath:"key"}).createIndex("byEventId","eventIdKey",{unique:!0}),i.createObjectStore("roomState",{keyPath:"key"}),i.createObjectStore("pendingEvents",{keyPath:"key"})}async function Cp(i,e){let t=new ar(i.createObjectStore("roomMembers",{keyPath:"key"})),s=e.objectStore("roomState");await H(s.openCursor(),r=>{if(r.event.type===ie){s.delete(r.key);let n=L.fromMemberEvent(r.roomId,r.event);n&&t.set(n.serialize())}return De})}async function Lp(i,e,t){let s=e.objectStore("session");try{let r=1,n=await z(s.get(r));if(n){s.delete(r);let{syncToken:o,syncFilterId:a,serverVersions:l}=n.value,c=new Rs(s,t);c.set("sync",{token:o,filterId:a}),c.set("serverVersions",l)}}catch(r){e.abort(),console.error("could not migrate session",r.stack)}}function Dp(i){i.createObjectStore("userIdentities",{keyPath:"userId"}),i.createObjectStore("deviceIdentities",{keyPath:"key"}).createIndex("byCurve25519Key","curve25519Key",{unique:!0}),i.createObjectStore("olmSessions",{keyPath:"key"}),i.createObjectStore("inboundGroupSessions",{keyPath:"key"}),i.createObjectStore("outboundGroupSessions",{keyPath:"roomId"}),i.createObjectStore("groupSessionDecryptions",{keyPath:"key"}),i.createObjectStore("operations",{keyPath:"id"}).createIndex("byTypeAndScope","typeScopeKey",{unique:!1})}async function Vp(i,e){let t=e.objectStore("roomSummary"),s=e.objectStore("roomState"),r=[];await H(t.openCursor(),n=>(r.push(n),De));for(let n of r){let o=await z(s.get(`${n.roomId}|m.room.encryption|`));o&&(n.encryption=o?.event?.content,delete n.isEncrypted,t.put(n))}}function qp(i){i.createObjectStore("accountData",{keyPath:"type"})}function Bp(i){i.createObjectStore("invites",{keyPath:"roomId"})}function Op(i){i.createObjectStore("archivedRoomSummary",{keyPath:"summary.roomId"})}async function Np(i,e){try{let t=e.objectStore("operations");t.deleteIndex("byTypeAndScope"),await H(t.openCursor(),(s,r,n)=>{let{typeScopeKey:o}=s;delete s.typeScopeKey;let[a,l]=o.split("|");return s.scopeTypeKey=As(l,a),n.update(s),De}),t.createIndex("byScopeAndType","scopeTypeKey",{unique:!1})}catch(t){e.abort(),console.error("could not migrate operations",t.stack)}}function Pp(i){i.createObjectStore("timelineRelations",{keyPath:"key"})}async function Fp(i,e,t,s){let r=e.objectStore("roomSummary"),n=[];await H(r.openCursor(),c=>(c.isTrackingMembers&&n.push(c.roomId),De));let o=e.objectStore("outboundGroupSessions"),a=e.objectStore("userIdentities"),l=e.objectStore("roomMembers");for(let c of n){let u=!1,d=[],p=IDBKeyRange.bound(c,`${c}|${F}`,!0,!0);await s.wrap({l:"room",id:c},async f=>{await H(l.openCursor(p),g=>(g.membership==="join"&&d.push(g.userId),De)),f.set("joinedUserIds",d.length);for(let g of d){let w=await z(a.get(g)),C=w?.roomIds?.length,R=Zn(w,g,c);R&&(f.log({l:"fixing up",id:g,roomsBefore:C,roomsAfter:R.roomIds.length}),a.put(R),u=!0)}f.set("foundMissing",u),u&&o.delete(c)})}}async function Up(i,e){let t=e.objectStore("session"),s=await z(t.get("ssssKey"));s&&t.put({key:`${_e}ssssKey`,value:s.value})}async function Kp(i,e,t,s){let r=e.objectStore("session"),n={databaseName:i.name,get idbFactory(){throw new Error("unused")},get IDBKeyRange(){throw new Error("unused")},addWriteError(){}},o=new Rs(new Ts(r,n),t);o.writeE2EEIdentityToLocalStorage();let a=await o.tryRestoreE2EEIdentityFromLocalStorage(s);s.set("restored",a)}async function jp(i,e){for(let t of i.objectStoreNames){let s=e.objectStore(t);switch(t){case"inboundGroupSessions":case"outboundGroupSessions":case"olmSessions":case"operations":continue;case"session":{await H(s.openCursor(),(r,n,o)=>(n.startsWith(_e)||o.delete(),De));break}default:{s.clear();break}}}}async function Ru(i){let e="hydrogen_webkit_test_inactive_txn_bug";try{let t=await Wt(e,n=>{n.createObjectStore("test",{keyPath:"key"})},1,i),s=t.transaction(["test"],"readonly");await z(s.objectStore("test").get("somekey")),await new Promise(n=>setTimeout(n,0));let r=t.transaction(["test"],"readwrite");await Promise.resolve(),r.objectStore("test").add({key:"somekey",value:"foo"}),await mt(r),t.close()}catch(t){if(t.name==="TransactionInactiveError")return!0}return!1}var ku=i=>`hydrogen_session_${i}`,so=function(i,e,t,s){let r=(n,o,a,l)=>Hp(n,o,a,l,t,s);return Wt(ku(i),r,to.length,e)};async function $p(){let i=this;if(i?.navigator?.storage?.persist)return await i.navigator.storage.persist();if(i?.document.requestStorageAccess)try{return await i.document.requestStorageAccess(),!0}catch{return!1}else return!1}var ci=class{constructor(e,t=window.indexedDB,s=window.IDBKeyRange,r=window.localStorage){this._serviceWorkerHandler=e,this._idbFactory=t,this._IDBKeyRange=s,this._localStorage=r}async create(e,t){await this._serviceWorkerHandler?.preventConcurrentSessionAccess(e),$p().then(n=>{n||console.warn("no persisted storage, database can be evicted by browser")});let s=await Ru(this._idbFactory),r=await so(e,this._idbFactory,this._localStorage,t);return new Jn(r,this._idbFactory,this._IDBKeyRange,s,this._localStorage,t.logger)}delete(e){let t=ku(e),s=this._idbFactory.deleteDatabase(t);return z(s)}async export(e,t){let s=await so(e,this._idbFactory,this._localStorage,t);return await Eu(s)}async import(e,t,s){let r=await so(e,this._idbFactory,this._localStorage,s);return await xu(r,t)}};async function Hp(i,e,t,s,r,n){let o=t||0;return n.wrap({l:"storage migration",oldVersion:t,version:s},async a=>{for(let l=o;l<s;++l){let c=to[l];await a.wrap(`v${l+1}`,u=>c(i,e,r,u))}})}var Qt=class{constructor({roomId:e,ownUserId:t,fragmentIdComparer:s}){this._roomId=e,this._ownUserId=t,this._fragmentIdComparer=s}async writeRelation(e,t,s){let{relatedEventId:r}=e;if(r){let n=Xe(e.event);n&&n.rel_type&&t.timelineRelations.add(this._roomId,n.event_id,n.rel_type,e.id);let o=await t.timelineEvents.getByEventId(this._roomId,r);if(o){let a=await this._applyRelation(e,o,t,s);if(a)return a.map(l=>(t.timelineEvents.update(l),new Y(l,this._fragmentIdComparer)))}}return null}async writeGapRelation(e,t,s,r){let n=new Y(e,this._fragmentIdComparer),o=await this.writeRelation(n,s,r);if(t.isBackward&&!Js(e.event)){let a=await s.timelineRelations.getAllForTarget(this._roomId,n.id);if(a.length)for(let l of a){let c=await s.timelineEvents.getByEventId(this._roomId,l.sourceEventId);if(c){let u=new Y(c,this._fragmentIdComparer);await this._applyRelation(u,e,s,r)}}}return o}async _applyRelation(e,t,s,r){if(e.eventType===de)return r.wrap("redact",async n=>{let o=t.event,a=Xe(o);if(this._applyRedaction(e.event,t,s,n)){let c=[t];if(a){let u=await this._reaggregateRelation(o,a,s,n);u&&c.push(u)}return c}return null});{let n=Xe(e.event);if(n&&!Js(t.event)&&n.rel_type===Ce&&r.wrap("react",l=>this._aggregateAnnotation(e.event,t,l)))return[t]}return null}_applyRedaction(e,t,s,r){let n=t.event;r.set("redactionId",e.event_id),r.set("id",n.event_id);let o=Xe(n);o&&o.rel_type&&s.timelineRelations.remove(this._roomId,o.event_id,o.rel_type,n.event_id),s.timelineRelations.removeAllForTarget(this._roomId,n.event_id);for(let c of Object.keys(n))zp[c]||delete n[c];let{content:a}=n,l=Gp[n.type];for(let c of Object.keys(a))l?.[c]||delete a[c];return n.unsigned=n.unsigned||{},n.unsigned.redacted_because=e,delete t.annotations,!0}_aggregateAnnotation(e,t){let s=Xe(e);if(!s)return!1;let{annotations:r}=t;r||(t.annotations=r={});let n=r[s.key];n||(r[s.key]=n={count:0,me:!1,firstTimestamp:Number.MAX_SAFE_INTEGER});let o=e.sender===this._ownUserId;return n.me=n.me||o,n.count+=1,n.firstTimestamp=Math.min(n.firstTimestamp,e.origin_server_ts),!0}async _reaggregateRelation(e,t,s,r){return t.rel_type===Ce?r.wrap("reaggregate annotations",n=>this._reaggregateAnnotation(t.event_id,t.key,s,n)):null}async _reaggregateAnnotation(e,t,s,r){let n=await s.timelineEvents.getByEventId(this._roomId,e);if(!n||!n.annotations)return null;r.set("id",e);let o=await s.timelineRelations.getForTargetAndType(this._roomId,e,Ce);return r.set("relations",o.length),delete n.annotations[t],Wp(n.annotations)&&delete n.annotations,await Promise.all(o.map(async a=>{let l=await s.timelineEvents.getByEventId(this._roomId,a.sourceEventId);l||r.log({l:"missing annotation",id:a.sourceEventId}),Xe(l.event).key===t&&this._aggregateAnnotation(l.event,n,r)})),n}};function Wp(i){for(let e in i)if(i.hasOwnProperty(e))return!1;return!0}var zp=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(i,e){return i[e]=1,i},{}),Gp={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}};var ke=class{constructor(e){this.isForward=e}get isBackward(){return!this.isForward}asApiString(){return this.isForward?"f":"b"}reverse(){return this.isForward?ke.Backward:ke.Forward}static get Forward(){return Qp}static get Backward(){return Yp}},Qp=new ke(!0),Yp=new ke(!1);var me=class extends Qs{constructor(e,t,s){super(s);this._fragment=e,this._isFragmentStart=t}static start(e,t){return new me(e,!0,t)}static end(e,t){return new me(e,!1,t)}get started(){return this._isFragmentStart}get hasEnded(){return!this.started}get fragment(){return this._fragment}get fragmentId(){return this._fragment.id}get entryIndex(){return this.started?O.minStorageKey:O.maxStorageKey}get isGap(){return!!this.token&&!this.edgeReached}get token(){return this.started?this.fragment.previousToken:this.fragment.nextToken}set token(e){this.started?this.fragment.previousToken=e:this.fragment.nextToken=e}get edgeReached(){return this.started?this.fragment.startReached:this.fragment.endReached}set edgeReached(e){this.started?this.fragment.startReached=e:this.fragment.endReached=e}get linkedFragmentId(){return this.started?this.fragment.previousId:this.fragment.nextId}set linkedFragmentId(e){this.started?this.fragment.previousId=e:this.fragment.nextId=e}get hasLinkedFragment(){return rr(this.linkedFragmentId)}get direction(){return this.started?ke.Backward:ke.Forward}withUpdatedFragment(e){return new me(e,this._isFragmentStart,this._fragmentIdComparer)}createNeighbourEntry(e){return new me(e,!this._isFragmentStart,this._fragmentIdComparer)}addLocalRelation(){}removeLocalRelation(){}};function Xp(i){let e=new Set;return i.filter(t=>e.has(t.event_id)?!1:(e.add(t.event_id),!0))}var ui=class{constructor({roomId:e,fragmentIdComparer:t,memberWriter:s,relationWriter:r}){this._roomId=e,this._memberWriter=s,this._relationWriter=r,this._fragmentIdComparer=t,this._lastLiveKey=null}async load(e,t){let s=await e.timelineFragments.liveFragment(this._roomId);if(s){let[r]=await e.timelineEvents.lastEvents(this._roomId,s.id,1),n=r?r.eventIndex:U.defaultLiveKey.eventIndex;this._lastLiveKey=new U(s.id,n)}this._lastLiveKey&&t.set("live key",this._lastLiveKey.toString())}async _createLiveFragment(e,t){let s=await e.timelineFragments.liveFragment(this._roomId);if(s)return s;{t||(t=null);let r={roomId:this._roomId,id:U.defaultLiveKey.fragmentId,previousId:null,nextId:null,previousToken:t,nextToken:null};return e.timelineFragments.add(r),this._fragmentIdComparer.add(r),r}}async _replaceLiveFragment(e,t,s,r){let n=await r.timelineFragments.get(this._roomId,e);if(!n)throw new Error(`old live fragment doesn't exist: ${e}`);n.nextId=t,r.timelineFragments.update(n);let o={roomId:this._roomId,id:t,previousId:e,nextId:null,previousToken:s,nextToken:null};return r.timelineFragments.add(o),this._fragmentIdComparer.append(t,e),{oldFragment:n,newFragment:o}}async _ensureLiveFragment(e,t,s,r,n){if(e){if(s.limited){let o=e.fragmentId;e=e.nextFragmentKey();let{oldFragment:a,newFragment:l}=await this._replaceLiveFragment(o,e.fragmentId,s.prev_batch,r);t.push(me.end(a,this._fragmentIdComparer)),t.push(me.start(l,this._fragmentIdComparer)),n.log({l:"live fragment",limited:!0,id:e.fragmentId})}}else{let o=await this._createLiveFragment(r,s.prev_batch);e=new U(o.id,U.defaultLiveKey.eventIndex),t.push(me.start(o,this._fragmentIdComparer)),n.log({l:"live fragment",first:!0,id:e.fragmentId})}return e}async _writeStateEvents(e,t,s){let r=0;for(let n of e)n.type!==ie&&(t.roomState.set(this._roomId,n),r+=1);s.set("stateEvents",r)}async _writeTimeline(e,t,s,r,n,o){let a=[],l=[];if(e?.length){r=await this._ensureLiveFragment(r,a,t,n,o),o.set("timelineEvents",e.length);let c=0;for(let u of e){r=r.nextKey();let d=tr(r,this._roomId,u),p=await s.lookupMemberAtEvent(u.sender,u,n);if(p&&(d.displayName=p.displayName,d.avatarUrl=p.avatarUrl),!await n.timelineEvents.tryInsert(d,o))continue;let g=new Y(d,this._fragmentIdComparer);a.push(g);let w=await this._relationWriter.writeRelation(g,n,o);w&&l.push(...w),typeof u.state_key=="string"&&u.type!==ie&&(c+=1,n.roomState.set(this._roomId,u))}o.set("timelineStateEventCount",c)}return{currentKey:r,entries:a,updatedEntries:l}}async _handleRejoinOverlap(e,t,s){if(this._lastLiveKey){let{fragmentId:r}=this._lastLiveKey,[n]=await t.timelineEvents.lastEvents(this._roomId,r,1);if(n){let o=n.event.event_id,{events:a}=e,l=a.findIndex(c=>c.event_id===o);if(l!==-1)return s.set("overlap_event_id",o),Object.assign({},e,{limited:!1,events:a.slice(l+1)})}}return e.limited?e:(s.set("force_limited_without_overlap",!0),Object.assign({},e,{limited:!0}))}async writeSync(e,t,s,r,n){let{timeline:o}=e;n.set("isRejoin",t),t&&(o=await this._handleRejoinOverlap(o,r,n));let a;Array.isArray(o?.events)&&(a=Xp(o.events));let{state:l}=e,c;Array.isArray(l?.events)&&(c=l.events);let u=this._memberWriter.prepareMemberSync(c,a,s);c&&await this._writeStateEvents(c,r,n);let{currentKey:d,entries:p,updatedEntries:f}=await this._writeTimeline(a,o,u,this._lastLiveKey,r,n),g=await u.write(r);return{entries:p,updatedEntries:f,newLiveKey:d,memberChanges:g}}afterSync(e){this._lastLiveKey=e}get lastMessageKey(){return this._lastLiveKey}};var di=class{constructor(e){this.limit=e,this._entries=[]}get size(){return this._entries.length}_get(e){return this._getByIndexAndMoveUp(this._entries.findIndex(e))}_getByIndexAndMoveUp(e){if(e!==-1){let t=this._entries[e];return e>0&&(this._entries.splice(e,1),this._entries.unshift(t)),t}}_set(e,t){let s=t?this._entries.findIndex(t):-1;this._entries.unshift(e),s===-1?this._entries.length>this.limit&&(s=this._entries.length-1):s+=1,s!==-1&&(this.onEvictEntry(this._entries[s]),this._entries.splice(s,1))}onEvictEntry(e){}},ro=class extends di{constructor(e,t){super(e);this._keyFn=t}get(e){return this._get(t=>this._keyFn(t)===e)}set(e){let t=this._keyFn(e);this._set(e,s=>this._keyFn(s)===t)}};var mi=class{constructor(e){this._roomId=e,this._cache=new ro(5,t=>t.userId)}prepareMemberSync(e,t,s){return new Mu(this,e,t,s)}async _writeMember(e,t){let s=this._cache.get(e.userId);if(!s){let r=await t.roomMembers.get(this._roomId,e.userId);r&&(s=new L(r))}if(!s||!s.equals(e))return t.roomMembers.set(e.serialize()),this._cache.set(e),new sr(e,s?.membership)}async lookupMember(e,t){let s=this._cache.get(e);if(!s){let r=await t.roomMembers.get(this._roomId,e);r&&(s=new L(r),this._cache.set(s))}return s}},Mu=class{constructor(e,t,s,r){this._memberWriter=e,this._timelineEvents=s,this._hasFetchedMembers=r,this._newStateMembers=null,t&&(this._newStateMembers=this._stateEventsToMembers(t))}get _roomId(){return this._memberWriter._roomId}_stateEventsToMembers(e){let t;for(let s of e)if(s.type===ie){let r=L.fromMemberEvent(this._roomId,s);r&&(t||(t=new Map),t.set(r.userId,r))}return t}_timelineEventsToMembers(e){let t;for(let s=e.length-1;s>=0;s--){let r=e[s],n=r.state_key;if(r.type===ie&&!t?.has(n)){let o=L.fromMemberEvent(this._roomId,r);o&&(t||(t=new Map),t.set(o.userId,o))}}return t}async lookupMemberAtEvent(e,t,s){let r;return this._timelineEvents&&(r=this._findPrecedingMemberEventInTimeline(e,t),r)||(r=this._newStateMembers?.get(e),r)?r:await this._memberWriter.lookupMember(e,s)}async write(e){let t=new Map,s;if(this._timelineEvents&&(s=this._timelineEventsToMembers(this._timelineEvents)),this._newStateMembers){for(let r of this._newStateMembers.values())if(!s?.has(r.userId)){let n=await this._memberWriter._writeMember(r,e);n&&(!this._hasFetchedMembers&&!n.previousMembership&&(n.previousMembership=r.membership),t.set(n.userId,n))}}if(s)for(let r of s.values()){let n=await this._memberWriter._writeMember(r,e);n&&t.set(n.userId,n)}return t}_findPrecedingMemberEventInTimeline(e,t){let s=-1;for(let r=this._timelineEvents.length-1;r>=0;r--)if(this._timelineEvents[r].event_id===t.event_id){s=r;break}for(let r=s-1;r>=0;r--){let n=this._timelineEvents[r];if(n.type===ie&&n.state_key===e){let o=L.fromMemberEvent(this._roomId,n);if(o)return o}}}};var io=class{constructor({roomId:e,storage:t,fragmentIdComparer:s,relationWriter:r}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._relationWriter=r}async _findOverlappingEvents(e,t,s,r){let n=t.map(c=>c.event_id),o=await s.timelineEvents.getEventKeysForIds(this._roomId,n);r.set("existingEvents",o.size);let a=t.filter(c=>!o.has(c.event_id));r.set("nonOverlappingEvents",a.length);let l;if(e.hasLinkedFragment){r.set("linkedFragmentId",e.linkedFragmentId);for(let c of o.values())if(c.fragmentId===e.linkedFragmentId){r.set("foundLinkedFragment",!0);let u=await s.timelineFragments.get(this._roomId,e.linkedFragmentId);l=e.createNeighbourEntry(u);break}}return{nonOverlappingEvents:a,neighbourFragmentEntry:l}}async _findFragmentEdgeEventKey(e,t){let{fragmentId:s,direction:r}=e,n=await this._findFragmentEdgeEvent(s,r,t);return n?new U(n.fragmentId,n.eventIndex):U.defaultFragmentKey(e.fragmentId)}async _findFragmentEdgeEvent(e,t,s){if(t.isBackward){let[r]=await s.timelineEvents.firstEvents(this._roomId,e,1);return r}else{let[r]=await s.timelineEvents.lastEvents(this._roomId,e,1);return r}}async _storeEvents(e,t,s,r,n,o){let a=[],l=[],c=t;for(let u=0;u<e.length;++u){let d=e[u];c=c.nextKeyForDirection(s);let p=tr(c,this._roomId,d),f=this._findMember(d.sender,r,e,u,s);f&&(p.displayName=f.displayName,p.avatarUrl=f.avatarUrl);let g=await this._relationWriter.writeGapRelation(p,s,n,o);if(g&&l.push(...g),await n.timelineEvents.tryInsert(p,o)){let w=new Y(p,this._fragmentIdComparer);Kt(a,w,s)}}return{entries:a,updatedEntries:l}}_findMember(e,t,s,r,n){function o(c){return c.type===ie&&c.state_key===e}let a=n.isBackward?1:-1;for(let c=r+a;c>=0&&c<s.length;c+=a){let u=s[c];if(o(u))return L.fromMemberEvent(this._roomId,u)}for(let c=r;c>=0&&c<s.length;c-=a){let u=s[c];if(o(u))return L.fromReplacingMemberEvent(this._roomId,u)}let l=t?.find(o);if(l)return L.fromMemberEvent(this._roomId,l)}async _updateFragments(e,t,s,r,n,o){let{direction:a}=e,l=[];return Kt(r,e,a),t?(o.set("closedGapWith",t.fragmentId),t.token=null,e.token=null,n.timelineFragments.update(t.fragment),Kt(r,t,a),l.push(e.fragment),l.push(t.fragment)):e.token=s,n.timelineFragments.update(e.fragment),l}async writeFragmentFill(e,t,s,r){let{fragmentId:n,direction:o}=e,{chunk:a,start:l,state:c}=t,{end:u}=t;if(!Array.isArray(a))throw new Error("Invalid chunk in response");if(typeof u!="string")throw new Error("Invalid end token in response");let d=await s.timelineFragments.get(this._roomId,n);if(!d)throw new Error(`Unknown fragment: ${n}`);if(e=e.withUpdatedFragment(d),e.token!==l)throw new Error("start is not equal to prev_batch or next_batch");if(a.length===0)return e.edgeReached=!0,await s.timelineFragments.update(e.fragment),{entries:[e],updatedEntries:[],fragments:[]};let p=await this._findFragmentEdgeEventKey(e,s);r.set("lastKey",p.toString());let{nonOverlappingEvents:f,neighbourFragmentEntry:g}=await this._findOverlappingEvents(e,a,s,r),{entries:w,updatedEntries:C}=await this._storeEvents(f,p,o,c,s,r),R=await this._updateFragments(e,g,u,w,s,r);return{entries:w,updatedEntries:C,fragments:R}}};var Se=class extends qt{emitReset(){for(let e of this._handlers)e.onReset(this)}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t,this)}emitUpdate(e,t,s){for(let r of this._handlers)r.onUpdate(e,t,s,this)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t,this)}emitMove(e,t,s){for(let r of this._handlers)r.onMove(e,t,s,this)}};function Ke(i,e,t){let s=0,r=i.length;for(;s<r;){let n=s+r>>>1,o=t(e,i[n]);o>0?s=n+1:o<0?r=n:s=r=n}return r}var Me=class extends qt{emitReset(){for(let e of this._handlers)e.onReset()}emitAdd(e,t){for(let s of this._handlers)s.onAdd(e,t)}emitUpdate(e,t,...s){for(let r of this._handlers)r.onUpdate(e,t,...s)}emitRemove(e,t){for(let s of this._handlers)s.onRemove(e,t)}[Symbol.iterator](){throw new Error("unimplemented")}get size(){throw new Error("unimplemented")}get(e){throw new Error("unimplemented")}};var Ve=class extends Me{constructor(e){super();this._values=new Map(e)}update(e,t){let s=this._values.get(e);return s!==void 0?(this._values.set(e,s),this.emitUpdate(e,s,t),!0):!1}add(e,t){return this._values.has(e)?!1:(this._values.set(e,t),this.emitAdd(e,t),!0)}remove(e){let t=this._values.get(e);return t!==void 0?(this._values.delete(e),this.emitRemove(e,t),!0):!1}set(e,t){return this._values.has(e)?(this._values.set(e,t),this.update(e)):this.add(e,t)}reset(){this._values.clear(),this.emitReset()}get(e){return this._values.get(e)}get size(){return this._values.size}[Symbol.iterator](){return this._values.entries()}values(){return this._values.values()}keys(){return this._values.keys()}};var no=class extends Se{constructor(e,t){super();this._sourceMap=e,this._comparator=(s,r)=>t(s.value,r.value),this._sortedPairs=null,this._mapSubscription=null}onAdd(e,t){let s={key:e,value:t},r=Ke(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(r,0,s),this.emitAdd(r,t)}onRemove(e,t){let s={key:e,value:t},r=Ke(this._sortedPairs,s,this._comparator);this._sortedPairs.splice(r,1),this.emitRemove(r,t)}onUpdate(e,t,s){if(!this._sortedPairs)return;let r=this._sortedPairs.findIndex(a=>a.key===e);this._sortedPairs.splice(r,1);let n={key:e,value:t},o=Ke(this._sortedPairs,n,this._comparator);this._sortedPairs.splice(o,0,n),r!==o&&this.emitMove(r,o,t),this.emitUpdate(o,t,s)}onReset(){this._sortedPairs=[],this.emitReset()}onSubscribeFirst(){this._mapSubscription=this._sourceMap.subscribe(this),this._sortedPairs=new Array(this._sourceMap.size);let e=0;for(let[t,s]of this._sourceMap)this._sortedPairs[e]={key:t,value:s},++e;this._sortedPairs.sort(this._comparator),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._sortedPairs=null,this._mapSubscription=this._mapSubscription()}get(e){return this._sortedPairs[e].value}get length(){return this._sourceMap.size}[Symbol.iterator](){let e=this._sortedPairs.values();return{next(){let t=e.next();return t.value&&(t.value=t.value.value),t}}}};var oo=class extends Me{constructor(e,t){super();this._source=e,this._filter=t,this._included=null,this._subscription=null}setFilter(e){this._filter=e,this._subscription&&this._reapplyFilter()}_reapplyFilter(e=!1){if(this._filter){let t=this._included;this._included=this._included||new Map;for(let[s,r]of this._source){let n=this._filter(r,s);if(this._included.set(s,n),!e){let o=t?t.get(s):!0;this._emitForUpdate(o,n,s,r)}}}else{if(this._included&&!e)for(let[t,s]of this._source)this._included.get(t)||this.emitAdd(t,s);this._included=null}}onAdd(e,t){if(this._filter){let s=this._filter(t,e);if(this._included.set(e,s),!s)return}this.emitAdd(e,t)}onRemove(e,t){let s=!this._filter||this._included.get(e);this._included.delete(e),s&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!!this._included)if(this._filter){let r=this._included.get(e),n=this._filter(t,e);this._included.set(e,n),this._emitForUpdate(r,n,e,t,s)}else this.emitUpdate(e,t,s)}_emitForUpdate(e,t,s,r,n=null){e&&!t?this.emitRemove(s,r):!e&&t?this.emitAdd(s,r):e&&t&&this.emitUpdate(s,r,n)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._reapplyFilter(!0),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._included=null,this._subscription=this._subscription()}onReset(){this._reapplyFilter(),this.emitReset()}[Symbol.iterator](){return new Au(this._source,this._included)}get size(){let e=0;return this._included.forEach(t=>{t&&(e+=1)}),e}get(e){let t=this._source.get(e);if(t&&this._filter(t,e))return t}},Au=class{constructor(e,t){this._included=t,this._sourceIterator=e[Symbol.iterator]()}next(){for(;;){let e=this._sourceIterator.next();if(e.done)return e;let t=e.value[0];if(this._included.get(t))return e}}};var ao=class extends Me{constructor(e,t,s){super();this._source=e,this._mapper=t,this._updater=s,this._mappedValues=new Map}_emitSpontaneousUpdate(e,t){let s=this._mappedValues.get(e);s&&this.emitUpdate(e,s,t)}onAdd(e,t){let s=this._emitSpontaneousUpdate.bind(this,e),r=this._mapper(t,s);this._mappedValues.set(e,r),this.emitAdd(e,r)}onRemove(e){let t=this._mappedValues.get(e);this._mappedValues.delete(e)&&this.emitRemove(e,t)}onUpdate(e,t,s){if(!this._mappedValues)return;let r=this._mappedValues.get(e);r!==void 0&&(this._updater?.(r,s,t),this.emitUpdate(e,r,s))}onSubscribeFirst(){this._subscription=this._source.subscribe(this);for(let[e,t]of this._source){let s=this._emitSpontaneousUpdate.bind(this,e),r=this._mapper(t,s);this._mappedValues.set(e,r)}super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription(),this._mappedValues.clear()}onReset(){this._mappedValues.clear(),this.emitReset()}[Symbol.iterator](){return this._mappedValues.entries()}get size(){return this._mappedValues.size}get(e){return this._mappedValues.get(e)}};var lo=class extends Me{constructor(e){super();this._sources=e,this._subscriptions=null}onAdd(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){let r=this._getValueFromOccludedSources(e,t);r!==void 0&&this.emitRemove(t,r),this.emitAdd(t,s)}}onRemove(e,t,s){if(!this._isKeyAtSourceOccluded(e,t)){this.emitRemove(t,s);let r=this._getValueFromOccludedSources(e,t);r!==void 0&&this.emitAdd(t,r)}}onUpdate(e,t,s,r){!this._subscriptions||this._isKeyAtSourceOccluded(e,t)||this.emitUpdate(t,s,r)}onReset(){this.emitReset()}onSubscribeFirst(){this._subscriptions=this._sources.map(e=>new Lu(e,this).subscribe()),super.onSubscribeFirst()}_isKeyAtSourceOccluded(e,t){let s=this._sources.indexOf(e);for(let r=0;r<s;r+=1)if(this._sources[r].get(t)!==void 0)return!0;return!1}_getValueFromOccludedSources(e,t){let s=this._sources.indexOf(e);for(let r=s+1;r<this._sources.length;r+=1){let o=this._sources[r].get(t);if(o!==void 0)return o}}onUnsubscribeLast(){super.onUnsubscribeLast();for(let e of this._subscriptions)e.dispose()}[Symbol.iterator](){return new Cu(this._sources)}get size(){return this._sources.reduce((e,t)=>e+t.size,0)}get(e){for(let t of this._sources){let s=t.get(e);if(s)return s}return null}},Cu=class{constructor(e){this._sources=e,this._sourceIndex=-1,this._currentIterator=null,this._encounteredKeys=new Set}next(){let e;for(;!e;){if(!this._currentIterator){if(this._sourceIndex+=1,this._sources.length<=this._sourceIndex)return{done:!0};this._currentIterator=this._sources[this._sourceIndex][Symbol.iterator]()}let t=this._currentIterator.next();if(t.done){this._currentIterator=null;continue}else{let s=t.value[0];this._encounteredKeys.has(s)||(this._encounteredKeys.add(s),e=t)}}return e}},Lu=class{constructor(e,t){this._source=e,this._joinedMap=t,this._subscription=null}subscribe(){return this._subscription=this._source.subscribe(this),this}dispose(){this._subscription=this._subscription()}onAdd(e,t){this._joinedMap.onAdd(this._source,e,t)}onRemove(e,t){this._joinedMap.onRemove(this._source,e,t)}onUpdate(e,t,s){this._joinedMap.onUpdate(this._source,e,t,s)}onReset(){this._joinedMap.onReset(this._source)}};var ht=class extends Se{constructor(e=[]){super();this._items=e}append(e){this._items.push(e),this.emitAdd(this._items.length-1,e)}remove(e){let[t]=this._items.splice(e,1);this.emitRemove(e,t)}insertMany(e,t){for(let s of t)this.insert(e,s),e+=1}insert(e,t){this._items.splice(e,0,t),this.emitAdd(e,t)}move(e,t){if(e<this._items.length&&t<this._items.length){let[s]=this._items.splice(e,1);this._items.splice(t,0,s),this.emitMove(e,t,s)}}update(e,t,s=null){e<this._items.length&&(this._items[e]=t,this.emitUpdate(e,t,s))}get array(){return this._items}at(e){if(this._items&&e>=0&&e<this._items.length)return this._items[e]}get length(){return this._items.length}[Symbol.iterator](){return this._items.values()}};function hi(i,e,t,s){let r=e.findIndex(i);if(r!==-1){let n=e[r],o=s(n);return o!==!1&&t.emitUpdate(r,n,o),!0}return!1}var kt=class extends Se{constructor(e){super();this._items=[];this._comparator=e}setManyUnsorted(e){this.setManySorted(e)}setManySorted(e){for(let t of e)this.set(t)}findAndUpdate(e,t){return hi(e,this._items,this,t)}getAndUpdate(e,t,s=null){let r=this.indexOf(e);if(r!==-1){let n=this._items[r],o=t(n,e);this._items[r]=o,this.emitUpdate(r,o,s)}}update(e,t=null){let s=this.indexOf(e);s!==-1&&(this._items[s]=e,this.emitUpdate(s,e,t))}indexOf(e){let t=Ke(this._items,e,this._comparator);return t<this._items.length&&this._comparator(this._items[t],e)===0?t:-1}_getNext(e){let t=Ke(this._items,e,this._comparator);for(;t<this._items.length&&this._comparator(this._items[t],e)<=0;)t+=1;return this.get(t)}set(e,t=null){let s=Ke(this._items,e,this._comparator);s>=this._items.length||this._comparator(this._items[s],e)!==0?(this._items.splice(s,0,e),this.emitAdd(s,e)):(this._items[s]=e,this.emitUpdate(s,e,t))}get(e){return this._items[e]}remove(e){let t=this._items[e];this._items.splice(e,1),this.emitRemove(e,t)}get array(){return this._items}get length(){return this._items.length}[Symbol.iterator](){return new Du(this)}},Du=class{constructor(e){this._sortedArray=e,this._current=null}next(){if(this._sortedArray){if(this._current?this._current=this._sortedArray._getNext(this._current):this._current=this._sortedArray.get(0),this._current)return{value:this._current};this._sortedArray=null}if(!this._sortedArray)return{done:!0}}};var pi=class extends Se{constructor(e,t,s,r){super();this._sourceUnsubscribe=null;this._mappedValues=null;this._sourceList=e,this._mapper=t,this._updater=s,this._removeCallback=r}findAndUpdate(e,t){return hi(e,this._mappedValues,this,t)}get length(){return this._mappedValues.length}[Symbol.iterator](){return this._mappedValues.values()}};function co(i,e,t){i._mappedValues.splice(e,0,t),i.emitAdd(e,t)}function uo(i,e,t,s){let r=i._mappedValues[e];i._updater&&i._updater(r,s,t),i.emitUpdate(e,r,s)}function mo(i,e){let t=i._mappedValues[e];i._mappedValues.splice(e,1),i._removeCallback&&i._removeCallback(t),i.emitRemove(e,t)}function ho(i,e,t){let s=i._mappedValues[e];i._mappedValues.splice(e,1),i._mappedValues.splice(t,0,s),i.emitMove(e,t,s)}function po(i){i._mappedValues=[],i.emitReset()}var fi=class extends pi{constructor(){super(...arguments);this._eventQueue=null;this._flushing=!1}onSubscribeFirst(){this._sourceUnsubscribe=this._sourceList.subscribe(this),this._eventQueue=[],this._mappedValues=[];let e=0;for(let t of this._sourceList)this._eventQueue.push(new go(e,t)),e+=1;this._flush()}async _flush(){if(!this._flushing){this._flushing=!0;try{for(;this._eventQueue.length;)await this._eventQueue.shift().run(this)}finally{this._flushing=!1}}}onReset(){this._eventQueue&&(this._eventQueue.push(new Nu),this._flush())}onAdd(e,t){this._eventQueue&&(this._eventQueue.push(new go(e,t)),this._flush())}onUpdate(e,t,s){this._eventQueue&&(this._eventQueue.push(new qu(e,t,s)),this._flush())}onRemove(e){this._eventQueue&&(this._eventQueue.push(new Bu(e)),this._flush())}onMove(e,t){this._eventQueue&&(this._eventQueue.push(new Ou(e,t)),this._flush())}onUnsubscribeLast(){this._sourceUnsubscribe(),this._eventQueue=null,this._mappedValues=null}},go=class{constructor(e,t){this.index=e;this.value=t}async run(e){let t=await e._mapper(this.value);co(e,this.index,t)}},qu=class{constructor(e,t,s){this.index=e;this.value=t;this.params=s}async run(e){uo(e,this.index,this.value,this.params)}},Bu=class{constructor(e){this.index=e}async run(e){mo(e,this.index)}},Ou=class{constructor(e,t){this.fromIdx=e;this.toIdx=t}async run(e){ho(e,this.fromIdx,this.toIdx)}},Nu=class{async run(e){po(e)}};var gi=class extends Se{constructor(...e){super();this._sourceUnsubscribes=null;this._sourceLists=e}_offsetForSource(e){let t=this._sourceLists.indexOf(e),s=0;for(let r=0;r<t;++r)s+=this._sourceLists[r].length;return s}onSubscribeFirst(){this._sourceUnsubscribes=this._sourceLists.map(e=>e.subscribe(this))}onUnsubscribeLast(){for(let e of this._sourceUnsubscribes)e()}onReset(){this.emitReset();let e=0;for(let t of this)this.emitAdd(e,t),e+=1}onAdd(e,t,s){this.emitAdd(this._offsetForSource(s)+e,t)}onUpdate(e,t,s,r){!this._sourceUnsubscribes||this.emitUpdate(this._offsetForSource(r)+e,t,s)}onRemove(e,t,s){this.emitRemove(this._offsetForSource(s)+e,t)}onMove(e,t,s,r){let n=this._offsetForSource(r);this.emitMove(n+e,n+t,s)}get length(){let e=0;for(let t=0;t<this._sourceLists.length;++t)e+=this._sourceLists[t].length;return e}[Symbol.iterator](){let e=0,t=this._sourceLists[0][Symbol.iterator]();return{next:()=>{let s=t.next();for(;s.done;){if(e+=1,e>=this._sourceLists.length)return s;t=this._sourceLists[e][Symbol.iterator](),s=t.next()}return s}}}};Object.assign(Me.prototype,{sortValues(i){return new no(this,i)},mapValues(i,e){return new ao(this,i,e)},filterValues(i){return new oo(this,i)},join(...i){return new lo([this].concat(i))}});function _o(i){typeof i=="function"?i():i.dispose()}function ef(i){return i&&(typeof i=="function"||typeof i.dispose=="function")}var Yt=class{constructor(){this._disposables=[]}track(e){if(!ef(e))throw new Error("Not a disposable");return this.isDisposed?(console.warn("Disposables already disposed, disposing new value"),_o(e),e):(this._disposables.push(e),e)}untrack(e){if(this.isDisposed)return console.warn("Disposables already disposed, cannot untrack"),null;let t=this._disposables.indexOf(e);return t>=0&&this._disposables.splice(t,1),null}dispose(){if(this._disposables){for(let e of this._disposables)_o(e);this._disposables=null}}get isDisposed(){return this._disposables===null}disposeTracked(e){if(e==null||this.isDisposed)return null;let t=this._disposables.indexOf(e);if(t!==-1){let[s]=this._disposables.splice(t,1);_o(s)}else console.warn("disposable not found, did it leak?",e);return null}};var yo=class{constructor(e,t){this.decryptRequest=null,this._promise=e(this,t)}complete(){return this._promise}dispose(){this.decryptRequest&&(this.decryptRequest.dispose(),this.decryptRequest=null)}};async function tf(i,e,t,s,r,n){let o=[],a=n.timelineEvents,l=n.timelineFragments;for(;o.length<s&&e;){let c;t.isForward?c=await a.eventsAfter(i,e,s):c=await a.eventsBefore(i,e,s);let u=c.map(d=>new Y(d,r));if(o=mu(o,u,t),o.length<s){let d=await l.get(i,e.fragmentId),p=new me(d,t.isBackward,r);if(Kt(o,p,t),!p.token&&p.hasLinkedFragment){let f=await l.get(i,p.linkedFragmentId);r.add(f);let g=new me(f,t.isForward,r);Kt(o,g,t),e=g.asEventKey()}else e=null}}return o}var wo=class{constructor({roomId:e,storage:t,fragmentIdComparer:s}){this._roomId=e,this._storage=t,this._fragmentIdComparer=s,this._decryptEntries=null}enableEncryption(e){this._decryptEntries=e}get readTxnStores(){let e=[this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments];return this._decryptEntries&&e.push(this._storage.storeNames.inboundGroupSessions),e}readFrom(e,t,s,r){return new yo(async(n,o)=>{let a=await this._storage.readTxn(this.readTxnStores);return await this._readFrom(e,t,s,n,a,o)},r)}readFromEnd(e,t=null,s){return new yo(async(r,n)=>{let o=t||await this._storage.readTxn(this.readTxnStores),a=await o.timelineFragments.liveFragment(this._roomId),l;if(!a)l=[];else{this._fragmentIdComparer.add(a);let c=me.end(a,this._fragmentIdComparer),u=c.asEventKey();l=await this._readFrom(u,ke.Backward,e,r,o,n),l.unshift(c)}return l},s)}async _readFrom(e,t,s,r,n,o){let a=await tf(this._roomId,e,t,s,this._fragmentIdComparer,n);if(this._decryptEntries){r.decryptRequest=this._decryptEntries(a,n,o);try{await r.decryptRequest.complete()}finally{r.decryptRequest=null}}return a}};var ur=class{constructor(e){this._userId=e}get id(){return this._userId}};var Jt=class{constructor({roomId:e,storage:t,closeCallback:s,fragmentIdComparer:r,pendingEvents:n,clock:o,powerLevelsObservable:a}){this._roomId=e,this._storage=t,this._closeCallback=s,this._fragmentIdComparer=r,this._disposables=new Yt,this._pendingEvents=n,this._clock=o,this._remoteEntries=new kt((l,c)=>l.compare(c)),this._ownMember=null,this._timelineReader=new wo({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer}),this._readerRequest=null,this._allEntries=null,this.initializePowerLevels(a)}initializePowerLevels(e){e&&(this._powerLevels=e.get(),this._disposables.track(e.subscribe(t=>this._powerLevels=t)))}async load(e,t,s){let r=await this._storage.readTxn(this._timelineReader.readTxnStores.concat(this._storage.storeNames.roomMembers,this._storage.storeNames.roomState)),n=await r.roomMembers.get(this._roomId,e.id);n?this._ownMember=new L(n):this._ownMember=L.fromUserId(this._roomId,e.id,t);let o=this._disposables.track(this._timelineReader.readFromEnd(20,r,s));try{let a=await o.complete();this._setupEntries(a)}finally{this._disposables.disposeTracked(o)}}_setupEntries(e){this._remoteEntries.setManySorted(e),this._pendingEvents?this._localEntries=new fi(this._pendingEvents,t=>this._mapPendingEventToEntry(t),(t,s)=>{t.notifyUpdate(s)},t=>this._applyAndEmitLocalRelationChange(t,s=>s.removeLocalRelation(t))):this._localEntries=new ht,this._allEntries=new gi(this._remoteEntries,this._localEntries)}async _mapPendingEventToEntry(e){let t;e.eventType===de&&(t=await this._getOrLoadEntry(e.relatedTxnId,e.relatedEventId));let s=new Xr({pendingEvent:e,member:this._ownMember,clock:this._clock,redactingEntry:t});return this._applyAndEmitLocalRelationChange(s,r=>r.addLocalRelation(s)),s}_applyAndEmitLocalRelationChange(e,t){let s=r=>{let n=t(r);return n||!1};if(this._findAndUpdateRelatedEntry(e.pendingEvent.relatedTxnId,e.relatedEventId,s),e.redactingEntry){let r=e.redactingEntry.pendingEvent?.relatedTxnId;this._findAndUpdateRelatedEntry(r,e.redactingEntry.relatedEventId,s)}}_findAndUpdateRelatedEntry(e,t,s){let r=!1;e&&(r=this._localEntries.findAndUpdate(n=>n.id===e,s)),!r&&t&&this._remoteEntries.findAndUpdate(n=>n.id===t,s)}async getOwnAnnotationEntry(e,t){let s=await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations]),r=await s.timelineRelations.getForTargetAndType(this._roomId,e,Ce);for(let n of r){let o=await s.timelineEvents.getByEventId(this._roomId,n.sourceEventId);if(o&&o.event.sender===this._ownMember.userId&&Xe(o.event).key===t){let a=new Y(o,this._fragmentIdComparer);return this._addLocalRelationsToNewRemoteEntries([a]),a}}return null}updateOwnMember(e){this._ownMember=e}_addLocalRelationsToNewRemoteEntries(e){if(!!this._localEntries?.hasSubscriptions){for(let t of this._localEntries)if(t.relatedEventId&&e.find(r=>r.id===t.relatedEventId)?.addLocalRelation(t),t.redactingEntry){let s=t.redactingEntry.relatedEventId;e.find(n=>n.id===s)?.addLocalRelation(t)}}}static _entryUpdater(e,t){return t.updateFrom(e),t}replaceEntries(e){this._addLocalRelationsToNewRemoteEntries(e);for(let t of e)try{this._remoteEntries.getAndUpdate(t,Jt._entryUpdater)}catch(s){if(s.name==="CompareError")continue;throw s}}addEntries(e){this._addLocalRelationsToNewRemoteEntries(e),this._remoteEntries.setManySorted(e)}async loadAtTop(e){if(this._disposables.isDisposed)return!0;let t=this._remoteEntries.array.find(r=>!!r.eventType);if(!t)return!0;let s=this._disposables.track(this._timelineReader.readFrom(t.asEventKey(),ke.Backward,e));try{let r=await s.complete();return this.addEntries(r),r.length<e}finally{this._disposables.disposeTracked(s)}}async _getOrLoadEntry(e,t){if(e){for(let s of this._localEntries)if(s.id===e)return s}if(t){let s=this.getByEventId(t);if(s)return s;{let n=await(await this._storage.readWriteTxn([this._storage.storeNames.timelineEvents])).timelineEvents.getByEventId(this._roomId,t);if(n)return new Y(n,this._fragmentIdComparer)}}return null}getByEventId(e){for(let t=0;t<this._remoteEntries.length;t+=1){let s=this._remoteEntries.get(t);if(s.id===e)return s}return null}get entries(){return this._allEntries}get remoteEntries(){return this._remoteEntries.array}dispose(){this._closeCallback&&(this._disposables.dispose(),this._closeCallback(),this._closeCallback=null)}enableEncryption(e){this._timelineReader.enableEncryption(e)}get powerLevels(){return this._powerLevels}get me(){return this._ownMember}};async function rf({roomId:i,storage:e}){return(await(await e.readTxn([e.storeNames.roomMembers])).roomMembers.getAll(i)).map(r=>new L(r))}async function nf({summary:i,syncToken:e,roomId:t,hsApi:s,storage:r,setChangedMembersMap:n},o){let a=new Map;n(a);let l=await s.members(t,{at:e},{log:o}).response(),c=await r.readWriteTxn([r.storeNames.roomSummary,r.storeNames.roomMembers]),u,d;try{u=i.writeHasFetchedMembers(!0,c);let{roomMembers:p}=c,f=l.chunk;if(!Array.isArray(f))throw new Error("malformed");o.set("members",f.length),d=await Promise.all(f.map(async g=>{let w=g?.state_key;if(!w)throw new Error("malformed");let C=a.get(w);if(C)return C;{let R=L.fromMemberEvent(t,g);return R&&p.set(R.serialize()),R}}))}catch(p){throw c.abort(),p}finally{n(null)}return await c.complete(),i.applyChanges(u),d}async function Pu(i,e){let{summary:t}=i;return t.data.hasFetchedMembers?rf(i):e.wrapOrRun(i.log,"fetchMembers",s=>nf(i,s))}async function Fu(i,e){let t=await of(i),{summary:s}=i;return!s.data.hasFetchedMembers&&!t?e.wrapOrRun(i.log,"fetchMember",r=>af(i,r)):t}async function of({roomId:i,userId:e,storage:t}){let r=await(await t.readTxn([t.storeNames.roomMembers])).roomMembers.get(i,e);return r?new L(r):null}async function af({roomId:i,userId:e,hsApi:t,storage:s},r){let n;try{n=await t.state(i,"m.room.member",e,{log:r}).response()}catch(l){if(l.name==="HomeServerError"&&l.errcode==="M_NOT_FOUND")return null;throw l}let o=new L({roomId:i,userId:e,membership:n.membership,avatarUrl:n.avatar_url,displayName:n.displayname}),a=await s.readWriteTxn([s.storeNames.roomMembers]);try{a.roomMembers.set(o.serialize())}catch(l){throw a.abort(),l}return await a.complete(),o}var vo=class{constructor(e){this._retentionCount=1;this._freeCallback=e}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._freeCallback()}};var bo=class extends vo{constructor({members:e,closeCallback:t}){super(t);this._members=new Ve;for(let s of e)this._members.add(s.userId,s)}afterSync(e){for(let[t,s]of e.entries())this._members.set(t,s.member)}get members(){return this._members}};function lf(i,e,t){let s=e.joinCount+e.inviteCount-1;if(i.length>=s)if(i.length>1){let r=i[i.length-1];return i.slice(0,i.length-1).map(o=>o.name).join(", ")+" and "+r.name}else{let r=i[0];return r?r.name:(t.log({l:"could get get other member name",length:i.length,otherMember:!!r,otherMemberMembership:r?.membership}),"Unknown DM Name")}else return i.length<s?i.map(r=>r.name).join(", ")+` and ${s} others`:null}var Xt=class{constructor(e){this._roomId=e,this._members=new Map}async calculateChanges(e,t,s){let r=new Map,n=[];for(let o of this._members.keys())e.indexOf(o)===-1&&n.push(o);for(let[o,a]of t.entries())(this._members.has(o)||e.indexOf(o)!==-1)&&r.set(o,a.member);for(let o of e)if(!this._members.has(o)&&!r.has(o)){let a=await s.roomMembers.get(this._roomId,o);if(a){let l=new L(a);r.set(l.userId,l)}}return{updatedHeroMembers:r.values(),removedUserIds:n}}applyChanges({updatedHeroMembers:e,removedUserIds:t},s,r){for(let o of t)this._members.delete(o);for(let o of e)this._members.set(o.userId,o);let n=Array.from(this._members.values()).sort((o,a)=>o.name.localeCompare(a.name));this._roomName=lf(n,s,r)}get roomName(){return this._roomName}get roomAvatarUrl(){if(this._members.size===1)for(let e of this._members.values())return e.avatarUrl;return null}get roomAvatarColorId(){if(this._members.size===1)for(let e of this._members.keys())return e;return null}};var Io=class{constructor(e){this._map=new Map,this._notifyEmpty=e}observe(e,t=null){let s=this._map.get(e);return s||(s=new Uu(this,t,e),this._map.set(e,s)),s}updateEvents(e){for(let t=0;t<e.length;t+=1){let s=e[t];this._map.get(s.id)?.update(s)}}_remove(e){this._map.delete(e),this._map.size===0&&this._notifyEmpty()}},Uu=class extends Je{constructor(e,t,s){super();this._eventMap=e,this._entry=t,this._id=s,Promise.resolve().then(()=>{this.hasSubscriptions||(this._eventMap._remove(this._id),this._eventMap=null)})}subscribe(e){if(!this._eventMap)throw new Error("ObservedEvent expired, subscribe right after calling room.observeEvent()");return super.subscribe(e)}onUnsubscribeLast(){this._eventMap._remove(this._id),this._eventMap=null,super.onUnsubscribeLast()}update(e){this._entry=e,this.emit(this._entry)}get(){return this._entry}};function Ku(i){return i||nr.item}var ju="m.room.power_levels",pt=class{constructor({powerLevelEvent:e,createEvent:t,ownUserId:s,membership:r}){this._plEvent=e,this._createEvent=t,this._ownUserId=s,this._membership=r}canRedactFromSender(e){return e===this._ownUserId&&this._membership==="join"?!0:this.canRedact}canSendType(e){return this._myLevel>=this._getEventTypeLevel(e)}get canRedact(){return this._myLevel>=this._getActionLevel("redact")}get _myLevel(){return this._membership!=="join"?Number.MIN_SAFE_INTEGER:this.getUserLevel(this._ownUserId)}getUserLevel(e){if(this._plEvent){let t=this._plEvent.content?.users?.[e];if(typeof t!="number"&&(t=this._plEvent.content?.users_default),typeof t=="number")return t}else if(this._createEvent&&e===this._createEvent.content?.creator)return 100;return 0}_getActionLevel(e){let t=this._plEvent?.content[e];return typeof t=="number"?t:50}_getEventTypeLevel(e){let t=this._plEvent?.content.events?.[e];if(typeof t=="number")return t;{let s=this._plEvent?.content.events_default;return typeof s=="number"?s:0}}};var $u="m.room.encrypted",dr=class extends Ot{constructor({roomId:e,storage:t,hsApi:s,mediaRepository:r,emitCollectionChange:n,user:o,createRoomEncryption:a,getSyncToken:l,platform:c}){super();this._roomId=e,this._storage=t,this._hsApi=s,this._mediaRepository=r,this._summary=new An(e),this._fragmentIdComparer=new jt([]),this._emitCollectionChange=n,this._timeline=null,this._user=o,this._changedMembersDuringSync=null,this._memberList=null,this._createRoomEncryption=a,this._roomEncryption=null,this._getSyncToken=l,this._platform=c,this._observedEvents=null,this._powerLevels=null,this._powerLevelLoading=null,this._observedMembers=null}async _eventIdsToEntries(e,t){let s=[];return await Promise.all(e.map(async r=>{let n=await t.timelineEvents.getByEventId(this._roomId,r);n&&s.push(new Y(n,this._fragmentIdComparer))})),s}_getAdditionalTimelineRetryEntries(e,t){let s=this._roomEncryption.filterUndecryptedEventEntriesForKeys(this._timeline.remoteEntries,t),r=e.reduce((n,o)=>(n.add(o.id),n),new Set);return s=s.filter(n=>!r.has(n.id)),s}async notifyRoomKey(e,t,s){if(!this._roomEncryption)return;let r=await this._storage.readTxn([this._storage.storeNames.timelineEvents,this._storage.storeNames.inboundGroupSessions]),n=await this._eventIdsToEntries(t,r);if(this._timeline){let o=this._getAdditionalTimelineRetryEntries(n,[e]);n=n.concat(o)}if(n.length){await this._decryptEntries(Pe.Retry,n,r,s).complete(),this._timeline?.replaceEntries(n);let a=this._summary.data.applyTimelineEntries(n,!1,!1);await this._summary.writeAndApplyData(a,this._storage)&&this._emitUpdate()}}_setEncryption(e){return e&&!this._roomEncryption?(this._roomEncryption=e,this._timeline&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Pe.Timeline)),!0):!1}_decryptEntries(e,t,s,r=null){return new Hu(async(o,a)=>{if(s||(s=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions])),o.cancelled)return;let l=t.filter(g=>g.eventType===$u).map(g=>g.event);if(o.preparation=await this._roomEncryption.prepareDecryptAll(l,null,e,s),o.cancelled)return;let c=await o.preparation.decrypt();if(o.preparation=null,o.cancelled)return;let u=[this._storage.storeNames.groupSessionDecryptions],d=this._isTimelineOpen;d&&u.push(this._storage.storeNames.deviceIdentities);let p=await this._storage.readWriteTxn(u),f;try{f=await c.write(p,a),d&&await f.verifySenders(p)}catch(g){throw p.abort(),g}await p.complete(),f.applyToEntries(t),this._observedEvents&&this._observedEvents.updateEvents(t)},Ku(r))}async _getSyncRetryDecryptEntries(e,t,s){let n=(await Promise.all(e.map(async o=>{let a=await t.getEventIdsForMissingKey(o,s);if(a)return this._eventIdsToEntries(a,s)}))).reduce((o,a)=>a?o.concat(a):o,[]);if(this._timeline){let a=this._getAdditionalTimelineRetryEntries(n,e).map(l=>l.clone());n=n.concat(a)}return n}async load(e,t,s){s.set("id",this.id);try{if(e&&this._summary.load(e),this._summary.data.encryption){let r=this._createRoomEncryption(this,this._summary.data.encryption);this._setEncryption(r)}if(this._summary.data.needsHeroes){this._heroes=new Xt(this._roomId);let r=await this._heroes.calculateChanges(this._summary.data.heroes,[],t);this._heroes.applyChanges(r,this._summary.data,s)}}catch(r){throw new Ws(`Could not load room ${this._roomId}`,r)}}async observeMember(e){this._observedMembers||(this._observedMembers=new Map);let t=this._observedMembers.get(e);if(t)return t;let s=await Fu({summary:this._summary,roomId:this._roomId,userId:e,storage:this._storage,hsApi:this._hsApi},this._platform.logger);if(!s)return null;let r=new bs(s,()=>this._observedMembers.delete(e));return this._observedMembers.set(e,r),r}async loadMemberList(e=null){if(this._memberList)return this._memberList.retain(),this._memberList;{let t=await Pu({summary:this._summary,roomId:this._roomId,hsApi:this._hsApi,storage:this._storage,syncToken:this._getSyncToken(),setChangedMembersMap:s=>this._changedMembersDuringSync=s,log:e},this._platform.logger);return this._memberList=new bo({members:t,closeCallback:()=>{this._memberList=null}}),this._memberList}}fillGap(e,t,s=null){return this._platform.logger.wrapOrRun(s,"fillGap",async r=>{if(r.set("id",this.id),r.set("fragment",e.fragmentId),r.set("dir",e.direction.asApiString()),e.edgeReached){r.set("edgeReached",!0);return}let n=await this._hsApi.messages(this._roomId,{from:e.token,dir:e.direction.asApiString(),limit:t,filter:{lazy_load_members:!0,include_redundant_members:!0}},{log:r}).response(),o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineRelations,this._storage.storeNames.timelineFragments]),a,l;try{a=await this._writeGapFill(n.chunk,o,r);let c=new Qt({roomId:this._roomId,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});l=await new io({roomId:this._roomId,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,relationWriter:c}).writeFragmentFill(e,n,o,r)}catch(c){throw o.abort(),c}await o.complete(),this._roomEncryption&&await this._decryptEntries(Pe.Timeline,l.entries,null,r).complete();for(let c of l.fragments)this._fragmentIdComparer.add(c);a&&this._applyGapFill(a),this._timeline&&(this._timeline.replaceEntries(l.updatedEntries),this._timeline.addEntries(l.entries))})}async _writeGapFill(e,t,s){}_applyGapFill(){}get name(){if(this._heroes)return this._heroes.roomName;let e=this._summary.data;return e.name?e.name:e.canonicalAlias?e.canonicalAlias:null}get id(){return this._roomId}get avatarUrl(){return this._summary.data.avatarUrl?this._summary.data.avatarUrl:this._heroes?this._heroes.roomAvatarUrl:null}get avatarColorId(){return this._roomId}get lastMessageTimestamp(){return this._summary.data.lastMessageTimestamp}get isLowPriority(){let e=this._summary.data.tags;return!!(e&&e["m.lowpriority"])}get isEncrypted(){return!!this._summary.data.encryption}get isJoined(){return this.membership==="join"}get isLeft(){return this.membership==="leave"}get canonicalAlias(){return this._summary.data.canonicalAlias}get joinedMemberCount(){return this._summary.data.joinCount}get mediaRepository(){return this._mediaRepository}get membership(){return this._summary.data.membership}async _loadPowerLevels(){let e=await this._storage.readTxn([this._storage.storeNames.roomState]),t=await e.roomState.get(this._roomId,"m.room.power_levels","");if(t)return new pt({powerLevelEvent:t.event,ownUserId:this._user.id,membership:this.membership});let s=await e.roomState.get(this._roomId,"m.room.create","");if(s)return new pt({createEvent:s.event,ownUserId:this._user.id,membership:this.membership});{let r=this.membership;return new pt({ownUserId:this._user.id,membership:r})}}async observePowerLevels(){this._powerLevelLoading&&await this._powerLevelLoading;let e=this._powerLevels;if(!e){this._powerLevelLoading=this._loadPowerLevels();let t=await this._powerLevelLoading;e=new bs(t,()=>{this._powerLevels=null}),this._powerLevels=e,this._powerLevelLoading=null}return e}enableSessionBackup(e){this._roomEncryption?.enableSessionBackup(e),this._timeline&&e&&this._platform.logger.run("enableSessionBackup",t=>this._roomEncryption.restoreMissingSessionsFromBackup(this._timeline.remoteEntries,t))}get _isTimelineOpen(){return!!this._timeline}_emitUpdate(){this.emit("change"),this._emitCollectionChange(this)}openTimeline(e=null){return this._platform.logger.wrapOrRun(e,"open timeline",async t=>{if(t.set("id",this.id),this._timeline)throw new Error("not dealing with load race here for now");this._timeline=new Jt({roomId:this.id,storage:this._storage,fragmentIdComparer:this._fragmentIdComparer,pendingEvents:this._getPendingEvents(),closeCallback:()=>{this._timeline=null,this._roomEncryption&&this._roomEncryption.notifyTimelineClosed()},clock:this._platform.clock,logger:this._platform.logger,powerLevelsObservable:await this.observePowerLevels()});try{this._roomEncryption&&this._timeline.enableEncryption(this._decryptEntries.bind(this,Pe.Timeline)),await this._timeline.load(this._user,this.membership,t)}catch(s){throw this._timeline.dispose(),s}return this._timeline})}_getPendingEvents(){return null}observeEvent(e){this._observedEvents||(this._observedEvents=new Io(()=>{this._observedEvents=null}));let t=null;this._timeline&&(t=this._timeline.getByEventId(e));let s=this._observedEvents.observe(e,t);return t||this._readEventById(e).then(r=>{s.update(r)}).catch(r=>{console.warn(`could not load event ${e} from storage`,r)}),s}async _readEventById(e){let t=[this._storage.storeNames.timelineEvents];this.isEncrypted&&t.push(this._storage.storeNames.inboundGroupSessions);let s=await this._storage.readTxn(t),r=await s.timelineEvents.getByEventId(this._roomId,e);if(r){let n=new Y(r,this._fragmentIdComparer);return n.eventType===$u&&await this._decryptEntries(Pe.Timeline,[n],s).complete(),n}}dispose(){this._roomEncryption?.dispose(),this._timeline?.dispose()}},Hu=class{constructor(e,t){this._cancelled=!1,this.preparation=null,this._promise=t.wrap("decryptEntries",s=>e(this,s))}complete(){return this._promise}get cancelled(){return this._cancelled}dispose(){this._cancelled=!0,this.preparation&&this.preparation.dispose()}};function Zt(){let e=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);return"t"+"0".repeat(14-e.length)+e}function So(i){return i.startsWith("t")&&i.length===15}var _i=class{constructor({roomId:e,storage:t,hsApi:s,pendingEvents:r}){r=r||[],this._roomId=e,this._storage=t,this._hsApi=s,this._pendingEvents=new kt((n,o)=>n.queueIndex-o.queueIndex),this._pendingEvents.setManyUnsorted(r.map(n=>this._createPendingEvent(n))),this._isSending=!1,this._offline=!1,this._roomEncryption=null,this._currentQueueIndex=0}_createPendingEvent(e,t=null){let s=new er({data:e,remove:()=>this._removeEvent(s),emitUpdate:r=>this._pendingEvents.update(s,r),attachments:t});return s}enableEncryption(e){this._roomEncryption=e}_sendLoop(e){this._isSending=!0,this._sendLoopLogItem=e.runDetached("send queue flush",async t=>{try{for(let s of this._pendingEvents)await t.wrap("send event",async r=>{r.set("queueIndex",s.queueIndex);try{this._currentQueueIndex=s.queueIndex,await this._sendEvent(s,r)}catch(n){n instanceof ge?(this._offline=!0,r.set("offline",!0),s.setWaiting()):(r.catch(n),n.name==="HomeServerError"&&(n.statusCode===400||n.statusCode===403||n.statusCode===404)?(r.set("remove",!0),await s.abort()):s.setError(n))}finally{this._currentQueueIndex=0}})}finally{this._isSending=!1,this._sendLoopLogItem=null}})}async _sendEvent(e,t){if(e.needsUpload&&(await t.wrap("upload attachments",s=>e.uploadAttachments(this._hsApi,s)),await this._tryUpdateEvent(e)),e.needsEncryption){e.setEncrypting();let s=e.contentForEncryption,{type:r,content:n}=await t.wrap("encrypt",o=>this._roomEncryption.encrypt(e.eventType,s,this._hsApi,o));e.setEncrypted(r,n),await this._tryUpdateEvent(e)}if(e.needsSending){await e.send(this._hsApi,t);let s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{await this._tryUpdateEventWithTxn(e,s),await this._resolveRemoteIdInPendingRelations(e.txnId,e.remoteId,s)}catch(r){throw s.abort(),r}await s.complete()}}async _resolveRemoteIdInPendingRelations(e,t,s){let r=this._pendingEvents.array.filter(n=>n.relatedTxnId===e&&n.relatedEventId!==t);for(let n of r)n.setRelatedEventId(t),await this._tryUpdateEventWithTxn(n,s);return r}async removeRemoteEchos(e,t,s){let r=[];for(let n of e){let o=n.unsigned&&n.unsigned.transaction_id,a;if(o?a=this._pendingEvents.array.findIndex(l=>l.txnId===o):a=this._pendingEvents.array.findIndex(l=>l.remoteId===n.event_id),a!==-1){let l=this._pendingEvents.get(a),c=n.event_id;s.log({l:"removeRemoteEcho",queueIndex:l.queueIndex,remoteId:c,txnId:o}),t.pendingEvents.remove(l.roomId,l.queueIndex),r.push(l),await this._resolveRemoteIdInPendingRelations(o,c,t)}}return r}async _removeEvent(e){if(this._pendingEvents.array.indexOf(e)!==-1){let s=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{s.pendingEvents.remove(e.roomId,e.queueIndex)}catch{s.abort()}await s.complete();let r=this._pendingEvents.array.indexOf(e);r!==-1&&this._pendingEvents.remove(r)}e.dispose()}emitRemovals(e){for(let t of e){let s=this._pendingEvents.array.indexOf(t);s!==-1&&this._pendingEvents.remove(s),t.dispose()}}resumeSending(e){this._offline=!1,this._pendingEvents.length&&e.wrap("resumeSending",t=>{t.set("id",this._roomId),t.set("pendingEvents",this._pendingEvents.length),this._isSending||this._sendLoop(t),this._sendLoopLogItem&&t.refDetached(this._sendLoopLogItem)})}async enqueueEvent(e,t,s,r){let n=Le(t),o=null;if(n){let a=Xs(n);if(So(a)&&(o=a,Jr(n,null)),n.rel_type===Ce&&this._pendingEvents.array.some(c=>{let u=Le(c.content);return c.eventType===e&&u&&u.key===n.key&&(c.relatedTxnId===o||u.event_id===n.event_id)})){r.set("already_annotating",!0);return}}await this._enqueueEvent(e,t,s,o,null,r)}async _enqueueEvent(e,t,s,r,n,o){let a=await this._createAndStoreEvent(e,t,r,n,s);this._pendingEvents.set(a),o.set("queueIndex",a.queueIndex),o.set("pendingEvents",this._pendingEvents.length),!this._isSending&&!this._offline&&this._sendLoop(o),this._sendLoopLogItem&&o.refDetached(this._sendLoopLogItem)}async enqueueRedaction(e,t,s){if(this._pendingEvents.array.some(a=>a.eventType===de&&(a.relatedTxnId===e||a.relatedEventId===e))){s.set("already_redacting",!0);return}let n,o;if(So(e)){n=e;let a=e,l=this._pendingEvents.array.find(c=>c.txnId===a);if(l&&!l.remoteId&&l.status!==V.Sending){s.set("remove",n),await l.abort();return}else if(l)o=l.remoteId;else return}else{o=e;let a=this._pendingEvents.array.find(l=>l.remoteId===o);a&&(n=a.txnId)}s.set("relatedTxnId",n),s.set("relatedEventId",o),await this._enqueueEvent(de,{reason:t},null,n,o,s)}get pendingEvents(){return this._pendingEvents}async _tryUpdateEvent(e){let t=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]);try{this._tryUpdateEventWithTxn(e,t)}catch(s){throw t.abort(),s}await t.complete()}async _tryUpdateEventWithTxn(e,t){await t.pendingEvents.exists(e.roomId,e.queueIndex)&&t.pendingEvents.update(e.data)}async _createAndStoreEvent(e,t,s,r,n){let o=await this._storage.readWriteTxn([this._storage.storeNames.pendingEvents]),a;try{let l=o.pendingEvents,c=await l.getMaxQueueIndex(this._roomId)||0,d=Math.max(c,this._currentQueueIndex)+1,p=e!==de&&e!==au&&!!this._roomEncryption;a=this._createPendingEvent({roomId:this._roomId,queueIndex:d,eventType:e,content:t,relatedTxnId:s,relatedEventId:r,txnId:Zt(),needsEncryption:p,needsUpload:!!n},n),l.add(a.data)}catch(l){throw o.abort(),l}return await o.complete(),a}dispose(){for(let e of this._pendingEvents)e.dispose()}};var Eo=class{constructor({filename:e,blob:t,platform:s}){this._filename=e,this._unencryptedBlob=t,this._transferredBlob=this._unencryptedBlob,this._platform=s,this._mxcUrl=null,this._encryptionInfo=null,this._uploadRequest=null,this._aborted=!1,this._error=null,this._sentBytes=0}get size(){return this._transferredBlob.size}get sentBytes(){return this._sentBytes}abort(){this._uploadRequest?.abort()}get localPreview(){return this._unencryptedBlob}async encrypt(){if(this._encryptionInfo)throw new Error("already encrypted");let{info:e,blob:t}=await Zc(this._platform,this._transferredBlob);this._transferredBlob=t,this._encryptionInfo=e}async upload(e,t,s){this._uploadRequest=e.uploadAttachment(this._transferredBlob,this._filename,{uploadProgress:n=>{this._sentBytes=n,t()},log:s});let{content_uri:r}=await this._uploadRequest.response();this._mxcUrl=r}applyToContent(e,t){if(!this._mxcUrl)throw new Error("upload has not finished");let s=e.substr(0,e.lastIndexOf("url"));yi(`${s}info.size`,t,this._transferredBlob.size),yi(`${s}info.mimetype`,t,this._unencryptedBlob.mimeType),this._encryptionInfo?yi(`${s}file`,t,Object.assign(this._encryptionInfo,{mimetype:this._unencryptedBlob.mimeType,url:this._mxcUrl})):yi(`${s}url`,t,this._mxcUrl)}dispose(){this._unencryptedBlob.dispose(),this._transferredBlob.dispose()}};function yi(i,e,t){let s=i.split("."),r=e;for(let o=0;o<s.length-1;o+=1){let a=s[o];r[a]||(r[a]={}),r=r[a]}let n=s[s.length-1];r[n]=t}var uf="m.room.encrypted",wi=class extends dr{constructor(e){super(e);let{pendingEvents:t}=e,s=new Qt({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,ownUserId:this._user.id});this._syncWriter=new ui({roomId:this.id,fragmentIdComparer:this._fragmentIdComparer,relationWriter:s,memberWriter:new mi(this.id)}),this._sendQueue=new _i({roomId:this.id,storage:this._storage,hsApi:this._hsApi,pendingEvents:t})}_setEncryption(e){return super._setEncryption(e)?(this._sendQueue.enableEncryption(this._roomEncryption),!0):!1}async prepareSync(e,t,s,r,n,o){o.set("id",this.id),r&&o.set("newKeys",r.length);let a=this._summary.data.applySyncResponse(e,t);t==="join"&&s&&(a=a.applyInvite(s));let l=this._roomEncryption;!l&&a.encryption&&(o.set("enableEncryption",!0),l=this._createRoomEncryption(this,a.encryption));let c,u;if(l){let d=e?.timeline?.events||[];r&&(c=await this._getSyncRetryDecryptEntries(r,l,n),c.length&&(o.set("retry",c.length),d=d.concat(c.map(p=>p.event)))),d=d.filter(p=>p?.type===uf),d.length&&(u=await l.prepareDecryptAll(d,r,Pe.Sync,n))}return{roomEncryption:l,summaryChanges:a,decryptPreparation:u,decryptChanges:null,retryEntries:c}}async afterPrepareSync(e,t){e.decryptPreparation&&await t.wrap("decrypt",async s=>{s.set("id",this.id),e.decryptChanges=await e.decryptPreparation.decrypt(),e.decryptPreparation=null},t.level.Detail)}async writeSync(e,t,{summaryChanges:s,decryptChanges:r,roomEncryption:n,retryEntries:o},a,l){l.set("id",this.id);let c=s.isNewJoin(this._summary.data);c&&(a.roomState.removeAllForRoom(this.id),a.roomMembers.removeAllForRoom(this.id));let{entries:u,updatedEntries:d,newLiveKey:p,memberChanges:f}=await l.wrap("syncWriter",W=>this._syncWriter.writeSync(e,c,s.hasFetchedMembers,a,W),l.level.Detail);if(r){let W=await l.wrap("decryptChanges",P=>r.write(a,P));l.set("decryptionResults",W.results.size),l.set("decryptionErrors",W.errors.size),this._isTimelineOpen&&await W.verifySenders(a),W.applyToEntries(u),o?.length&&(W.applyToEntries(o),d.push(...o))}l.set("newEntries",u.length),l.set("updatedEntries",d.length);let g=!1;n&&this.isTrackingMembers&&f?.size&&(g=await n.writeMemberChanges(f,a,l),l.set("shouldFlushKeyShares",g));let w=u.concat(d);s=s.applyTimelineEntries(w,t,!this._isTimelineOpen,this._user.id),s.membership!=="join"?a.roomSummary.remove(this.id):s=this._summary.writeData(s,a),s&&l.set("summaryChanges",s.diff(this._summary.data));let C;s?.needsHeroes&&(this._heroes||(this._heroes=new Xt(this._roomId)),C=await this._heroes.calculateChanges(s.heroes,f,a));let R;Array.isArray(e.timeline?.events)&&(R=await this._sendQueue.removeRemoteEchos(e.timeline.events,a,l));let M=this._getPowerLevelsEvent(e);return{summaryChanges:s,roomEncryption:n,newEntries:u,updatedEntries:d,newLiveKey:p,removedPendingEvents:R,memberChanges:f,heroChanges:C,powerLevelsEvent:M,shouldFlushKeyShares:g}}afterSync(e,t){let{summaryChanges:s,newEntries:r,updatedEntries:n,newLiveKey:o,removedPendingEvents:a,memberChanges:l,powerLevelsEvent:c,heroChanges:u,roomEncryption:d}=e;if(t.set("id",this.id),this._syncWriter.afterSync(o),this._setEncryption(d),l.size){if(this._changedMembersDuringSync)for(let[f,g]of l.entries())this._changedMembersDuringSync.set(f,g.member);if(this._memberList&&this._memberList.afterSync(l),this._observedMembers&&this._updateObservedMembers(l),this._timeline){for(let[f,g]of l.entries())if(f===this._user.id){this._timeline.updateOwnMember(g.member);break}}}let p=!1;if(s&&(this._summary.applyChanges(s),this._summary.data.needsHeroes||(this._heroes=null),p=!0),this._heroes&&u){let f=this.name;this._heroes.applyChanges(u,this._summary.data,t),f!==this.name&&(p=!0)}c&&this._updatePowerLevels(c),p&&this._emitUpdate(),this._timeline&&(this._timeline.replaceEntries(n),this._timeline.addEntries(r)),this._observedEvents&&(this._observedEvents.updateEvents(n),this._observedEvents.updateEvents(r)),a&&this._sendQueue.emitRemovals(a)}_updateObservedMembers(e){for(let[t,s]of e){let r=this._observedMembers.get(t);r&&r.set(s.member)}}_getPowerLevelsEvent(e){let t=r=>r.state_key===""&&r.type===ju;return e.timeline?.events.find(t)??e.state?.events.find(t)}_updatePowerLevels(e){if(this._powerLevels){let t=new pt({powerLevelEvent:e,ownUserId:this._user.id,membership:this.membership});this._powerLevels.set(t)}}needsAfterSyncCompleted({shouldFlushKeyShares:e}){return e}async afterSyncCompleted(e,t){t.set("id",this.id),this._roomEncryption&&await this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,null,t)}start(e,t){if(this._roomEncryption){let s=e?.get("share_room_key");s&&t.wrapDetached("flush room keys",r=>(r.set("id",this.id),this._roomEncryption.flushPendingRoomKeyShares(this._hsApi,s,r)))}this._sendQueue.resumeSending(t)}async load(e,t,s){try{await super.load(e,t,s),await this._syncWriter.load(t,s)}catch(r){throw new Ws(`Could not load room ${this._roomId}`,r)}}async _writeGapFill(e,t,s){return await this._sendQueue.removeRemoteEchos(e,t,s)}_applyGapFill(e){this._sendQueue.emitRemovals(e)}sendEvent(e,t,s,r=null){return this._platform.logger.wrapOrRun(r,"send",n=>(n.set("id",this.id),this._sendQueue.enqueueEvent(e,t,s,n)))}sendRedaction(e,t,s=null){return this._platform.logger.wrapOrRun(s,"redact",r=>(r.set("id",this.id),this._sendQueue.enqueueRedaction(e,t,r)))}async ensureMessageKeyIsShared(e=null){if(!!this._roomEncryption)return this._platform.logger.wrapOrRun(e,"ensureMessageKeyIsShared",t=>(t.set("id",this.id),this._roomEncryption.ensureMessageKeyIsShared(this._hsApi,t)))}get avatarColorId(){return this._heroes?.roomAvatarColorId||this._roomId}get isUnread(){return this._summary.data.isUnread}get notificationCount(){return this._summary.data.notificationCount}get highlightCount(){return this._summary.data.highlightCount}get isTrackingMembers(){return this._summary.data.isTrackingMembers}async _getLastEventId(){let e=this._syncWriter.lastMessageKey;if(e)return(await(await this._storage.readTxn([this._storage.storeNames.timelineEvents])).timelineEvents.get(this._roomId,e))?.event?.event_id}async clearUnread(e=null){if(this.isUnread||this.notificationCount)return await this._platform.logger.wrapOrRun(e,"clearUnread",async t=>{t.set("id",this.id);let s=await this._storage.readWriteTxn([this._storage.storeNames.roomSummary]),r;try{r=this._summary.writeClearUnread(s)}catch(n){throw s.abort(),n}await s.complete(),this._summary.applyChanges(r),this._emitUpdate();try{let n=await this._getLastEventId();n&&await this._hsApi.receipt(this._roomId,"m.read",n)}catch(n){if(n.name!=="ConnectionError")throw n}})}leave(e=null){return this._platform.logger.wrapOrRun(e,"leave room",async t=>{t.set("id",this.id),await this._hsApi.leave(this.id,{log:t}).response()})}_getPendingEvents(){return this._sendQueue.pendingEvents}writeIsTrackingMembers(e,t){return this._summary.writeIsTrackingMembers(e,t)}applyIsTrackingMembersChanges(e){this._summary.applyChanges(e)}createAttachment(e,t){return new Eo({blob:e,filename:t,platform:this._platform})}dispose(){super.dispose(),this._sendQueue.dispose()}};var xo=class extends dr{constructor(e){super(e);this._releaseCallback=e.releaseCallback,this._forgetCallback=e.forgetCallback,this._retentionCount=1,this._kickDetails=null,this._kickedBy=null}retain(){this._retentionCount+=1}release(){this._retentionCount-=1,this._retentionCount===0&&this._releaseCallback()}async _getKickAuthor(e,t){let s=await t.roomMembers.get(this.id,e);return s?new L(s):L.fromUserId(this.id,e,"join")}async load(e,t,s){let{summary:r,kickDetails:n}=e;return this._kickDetails=n,this._kickDetails&&(this._kickedBy=await this._getKickAuthor(this._kickDetails.sender,t)),super.load(r,t,s)}async writeSync(e,t,s,r,n){if(n.set("id",this.id),s==="leave"){let o=df(t,this._user.id);if(o||e){let a=o||this._kickDetails,l;o&&(l=await this._getKickAuthor(o.sender,r));let c=e||this._summary.data;return r.archivedRoomSummary.set({summary:c.serialize(),kickDetails:a}),{kickDetails:a,kickedBy:l,summaryData:c}}}else s==="join"&&r.archivedRoomSummary.remove(this.id);return{}}afterSync({summaryData:e,kickDetails:t,kickedBy:s},r){r.set("id",this.id),e&&this._summary.applyChanges(e),t&&(this._kickDetails=t),s&&(this._kickedBy=s),this._emitUpdate()}get isKicked(){return this._kickDetails?.membership==="leave"}get isBanned(){return this._kickDetails?.membership==="ban"}get kickedBy(){return this._kickedBy}get kickReason(){return this._kickDetails?.reason}isArchived(){return!0}forget(e=null){return this._platform.logger.wrapOrRun(e,"forget room",async t=>{t.set("id",this.id),await this._hsApi.forget(this.id,{log:t}).response();let s=this._storage.storeNames,r=await this._storage.readWriteTxn([s.roomState,s.archivedRoomSummary,s.roomMembers,s.timelineEvents,s.timelineFragments,s.timelineRelations,s.pendingEvents,s.inboundGroupSessions,s.groupSessionDecryptions,s.operations]);r.roomState.removeAllForRoom(this.id),r.archivedRoomSummary.remove(this.id),r.roomMembers.removeAllForRoom(this.id),r.timelineEvents.removeAllForRoom(this.id),r.timelineFragments.removeAllForRoom(this.id),r.timelineRelations.removeAllForRoom(this.id),r.pendingEvents.removeAllForRoom(this.id),r.inboundGroupSessions.removeAllForRoom(this.id),r.groupSessionDecryptions.removeAllForRoom(this.id),await r.operations.removeAllForScope(this.id),await r.complete(),this._retentionCount=0,this._releaseCallback(),this._forgetCallback(this.id)})}join(e=null){return this._platform.logger.wrapOrRun(e,"rejoin archived room",async t=>{await this._hsApi.join(this.id,{log:t}).response()})}};function df(i,e){let t=kn(i,(s,r)=>(r.type===ie&&r.state_key===e&&r.sender!==r.state_key&&(s=r),s),null);if(t)return{membership:t.content?.membership,reason:t.content?.reason,sender:t.sender}}var N=class{constructor(e,t,s){this.joined=e,this.invited=t,this.archived=s}withInvited(){return this.invited?this:this.archived?N.invitedAndArchived:N.invited}withoutInvited(){return this.invited?this.joined?N.joined:this.archived?N.archived:N.none:this}withoutArchived(){return this.archived?this.invited?N.invited:N.none:this}};N.joined=new N(!0,!1,!1);N.archived=new N(!1,!1,!0);N.invited=new N(!1,!0,!1);N.invitedAndArchived=new N(!1,!0,!0);N.none=new N(!1,!1,!1);var To=class extends Ot{constructor({roomId:e,user:t,hsApi:s,mediaRepository:r,emitCollectionRemove:n,emitCollectionUpdate:o,platform:a}){super();this._roomId=e,this._user=t,this._hsApi=s,this._emitCollectionRemove=n,this._emitCollectionUpdate=o,this._mediaRepository=r,this._platform=a,this._inviteData=null,this._accepting=!1,this._rejecting=!1,this._accepted=!1,this._rejected=!1}get isInvite(){return!0}get id(){return this._roomId}get name(){return this._inviteData.name||this._inviteData.canonicalAlias}get isDirectMessage(){return this._inviteData.isDirectMessage}get avatarUrl(){return this._inviteData.avatarUrl}get avatarColorId(){return this._inviteData.avatarColorId||this.id}get timestamp(){return this._inviteData.timestamp}get isEncrypted(){return this._inviteData.isEncrypted}get inviter(){return this._inviter}get isPublic(){return this._inviteData.joinRule==="public"}get canonicalAlias(){return this._inviteData.canonicalAlias}async accept(e=null){await this._platform.logger.wrapOrRun(e,"acceptInvite",async t=>{this._accepting=!0,this._emitChange("accepting"),await this._hsApi.join(this._roomId,{log:t}).response()})}async reject(e=null){await this._platform.logger.wrapOrRun(e,"rejectInvite",async t=>{this._rejecting=!0,this._emitChange("rejecting"),await this._hsApi.leave(this._roomId,{log:t}).response()})}get accepting(){return this._accepting}get accepted(){return this._accepted}get rejecting(){return this._rejecting}get rejected(){return this._rejected}get mediaRepository(){return this._mediaRepository}_emitChange(e){this.emit("change"),this._emitCollectionUpdate(this,e)}load(e,t){t.set("id",this.id),this._inviteData=e,this._inviter=e.inviter?new L(e.inviter):null}async writeSync(e,t,s,r){if(e==="invite"){r.set("id",this.id),r.set("add",!0);let n=t.invite_state?.events;if(!Array.isArray(n))return null;let o=this._createSummaryData(n),a;!o.name&&!o.canonicalAlias&&(a=await this._createHeroes(n,r));let l=this._getMyInvite(n);if(!l)return null;let c=this._getInviter(l,n),u=this._createData(n,l,c,o,a);return s.invites.set(u),{inviteData:u,inviter:c}}else return r.set("id",this.id),r.set("membership",e),s.invites.remove(this.id),{removed:!0,membership:e}}afterSync(e,t){t.set("id",this.id),e&&(e.removed?(this._accepting=!1,this._rejecting=!1,e.membership==="join"?this._accepted=!0:this._rejected=!0,this.emit("change")):(this._inviteData=e.inviteData,this._inviter=e.inviter))}_createData(e,t,s,r,n){let o=n?n.roomName:r.name,a=n?n.roomAvatarUrl:r.avatarUrl,l=n?.roomAvatarColorId||this.id;return{roomId:this.id,isEncrypted:!!r.encryption,isDirectMessage:this._isDirectMessage(t),name:o,avatarUrl:a,avatarColorId:l,canonicalAlias:r.canonicalAlias,timestamp:this._platform.clock.now(),joinRule:this._getJoinRule(e),inviter:s?.serialize()}}_isDirectMessage(e){return!!e?.content?.is_direct}_createSummaryData(e){return e.reduce(Mn,new Fe(null,this.id))}async _createHeroes(e,t){let s=e.filter(u=>u.type===ie),r=s.filter(u=>u.state_key!==this._user.id),n=r.reduce((u,d)=>{let p=L.fromMemberEvent(this.id,d);return u.set(p.userId,new sr(p,null)),u},new Map),o=r.map(u=>u.state_key),a=new Xt(this.id),l=await a.calculateChanges(o,n,null),c=new Fe(null,this.id);return c.joinCount=s.reduce((u,d)=>u+(d.content?.membership==="join"?1:0),0),c.inviteCount=s.reduce((u,d)=>u+(d.content?.membership==="invite"?1:0),0),a.applyChanges(l,c,t),a}_getMyInvite(e){return e.find(t=>t.type===ie&&t.state_key===this._user.id)}_getInviter(e,t){let s=t.find(r=>r.type===ie&&r.state_key===e.sender);if(s)return L.fromMemberEvent(this.id,s)}_getJoinRule(e){let t=e.find(s=>s.type==="m.room.join_rules");return t?t.content?.join_rule:null}};var ft=class{constructor(e){this._description=e}static httpPusher(e,t,s,r){return new ft({kind:"http",append:!0,data:Object.assign({},r,{url:e+"/_matrix/push/v1/notify"}),pushkey:s,app_id:t,app_display_name:"Hydrogen",device_display_name:"Hydrogen",lang:"en"})}static createDefaultPayload(e){return{session_id:e}}async enable(e,t){try{t.set("endpoint",new URL(this._description.data.endpoint).host)}catch{t.set("endpoint",null)}await e.setPusher(this._description,{log:t}).response()}async disable(e,t){let s=Object.assign({},this._description,{kind:null});await e.setPusher(s,{log:t}).response()}serialize(){return this._description}equals(e){return this._description.app_id!==e._description.app_id||this._description.pushkey!==e._description.pushkey?!1:JSON.stringify(this._description.data)===JSON.stringify(e._description.data)}};function tt(i,e){return mr(i,e,()=>[],(t,s)=>t.push(s))}function mr(i,e,t,s){return i.reduce((r,n)=>{let o=e(n),a=r.get(o);return a||(a=t(),r.set(o,a)),s(a,n),r},new Map)}function Ro(i,e){return i.reduce((t,s)=>{let r=e(s);return t[r]?t[r]+=1:t[r]=1,t},{})}var ko=class{constructor({storage:e}){this._storage=e,this._olmDecryption=null,this._megolmDecryption=null}enableEncryption({olmDecryption:e,megolmDecryption:t}){this._olmDecryption=e,this._megolmDecryption=t}obtainSyncLock(e){return this._olmDecryption?.obtainDecryptionLock(e)}async prepareSync(e,t,s,r){r.set("messageTypes",Ro(e,a=>a.type));let n=e.filter(a=>a.type==="m.room.encrypted");if(!this._olmDecryption){r.log("can't decrypt, encryption not enabled",r.level.Warn);return}let o=n.filter(a=>a.content?.algorithm===Es);if(o.length){let a=await this._olmDecryption.decryptAll(o,t,s);r.set("decryptedTypes",Ro(a.results,c=>c.event?.type));for(let c of a.errors)r.child("decrypt_error").catch(c);let l=this._megolmDecryption.roomKeysFromDeviceMessages(a.results,r);return new Wu(a,l)}}async writeSync(e,t){e.olmDecryptChanges.write(t),await Promise.all(e.newRoomKeys.map(s=>this._megolmDecryption.writeRoomKey(s,t)))}},Wu=class{constructor(e,t){this.olmDecryptChanges=e,this.newRoomKeys=t,this.newKeysByRoom=tt(t,s=>s.roomId)}};var zu=vs(Tn());var hr=_e+"olmAccount",Mo=_e+"areDeviceKeysUploaded",vi=_e+"serverOTKCount";async function Gu(i,e,t,s,r){let n=i.pickle(e),o=await r.readWriteTxn([r.storeNames.session]);try{o.session.add(hr,n),o.session.add(Mo,t),o.session.add(vi,s)}catch(a){throw o.abort(),a}await o.complete()}var gt=class{static async load({olm:e,pickleKey:t,hsApi:s,userId:r,deviceId:n,olmWorker:o,txn:a}){let l=await a.session.get(hr);if(l){let c=new e.Account,u=await a.session.get(Mo);c.unpickle(t,l);let d=await a.session.get(vi);return new gt({pickleKey:t,hsApi:s,account:c,userId:r,deviceId:n,areDeviceKeysUploaded:u,serverOTKCount:d,olm:e,olmWorker:o})}}static async adoptDehydratedDevice({olm:e,dehydratedDevice:t,pickleKey:s,hsApi:r,userId:n,olmWorker:o,storage:a}){let l=t.adoptUnpickledOlmAccount(),c=JSON.parse(l.one_time_keys()),d=Object.entries(c.curve25519).length,p=!0;return await Gu(l,s,p,d,a),new gt({pickleKey:s,hsApi:r,account:l,userId:n,deviceId:t.deviceId,areDeviceKeysUploaded:p,serverOTKCount:d,olm:e,olmWorker:o})}static async create({olm:e,pickleKey:t,hsApi:s,userId:r,deviceId:n,olmWorker:o,storage:a}){let l=new e.Account;o?await o.createAccountAndOTKs(l,l.max_number_of_one_time_keys()):(l.create(),l.generate_one_time_keys(l.max_number_of_one_time_keys()));let c=!1,u=0;return a&&await Gu(l,t,c,u,a),new gt({pickleKey:t,hsApi:s,account:l,userId:r,deviceId:n,areDeviceKeysUploaded:c,serverOTKCount:u,olm:e,olmWorker:o})}constructor({pickleKey:e,hsApi:t,account:s,userId:r,deviceId:n,areDeviceKeysUploaded:o,serverOTKCount:a,olm:l,olmWorker:c}){this._olm=l,this._pickleKey=e,this._hsApi=t,this._account=s,this._userId=r,this._deviceId=n,this._areDeviceKeysUploaded=o,this._serverOTKCount=a,this._olmWorker=c,this._identityKeys=JSON.parse(this._account.identity_keys())}get identityKeys(){return this._identityKeys}setDeviceId(e){this._deviceId=e}async uploadKeys(e,t,s){let r=JSON.parse(this._account.one_time_keys()),n=Object.entries(r.curve25519);if(n.length||!this._areDeviceKeysUploaded){let o={};if(!this._areDeviceKeysUploaded){s.set("identity",!0);let c=JSON.parse(this._account.identity_keys());o.device_keys=this._deviceKeysPayload(c)}n.length&&(s.set("otks",!0),o.one_time_keys=this._oneTimeKeysPayload(n));let a=t?this._deviceId:void 0,l=await this._hsApi.uploadKeys(a,o,{log:s}).response();this._serverOTKCount=l?.one_time_key_counts?.signed_curve25519,s.set("serverOTKCount",this._serverOTKCount),await this._updateSessionStorage(e,c=>{n.length&&(this._account.mark_keys_as_published(),c?.set(hr,this._account.pickle(this._pickleKey)),c?.set(vi,this._serverOTKCount)),this._areDeviceKeysUploaded||(this._areDeviceKeysUploaded=!0,c?.set(Mo,this._areDeviceKeysUploaded))})}}async generateOTKsIfNeeded(e,t){let s=this._account.max_number_of_one_time_keys(),r=Math.floor(s/2);if(this._serverOTKCount<r){let n=JSON.parse(this._account.one_time_keys()),a=Object.entries(n.curve25519).length,l=r-a-this._serverOTKCount;return l>0&&await t.wrap("generate otks",c=>{c.set("max",s),c.set("server",this._serverOTKCount),c.set("unpublished",a),c.set("new",l),c.set("limit",r),this._account.generate_one_time_keys(l),this._updateSessionStorage(e,u=>{u.set(hr,this._account.pickle(this._pickleKey))})}),!0}return!1}createInboundOlmSession(e,t){let s=new this._olm.Session;try{return s.create_inbound_from(this._account,e,t),s}catch(r){throw s.free(),r}}async createOutboundOlmSession(e,t){let s=new this._olm.Session;try{return this._olmWorker?await this._olmWorker.createOutboundOlmSession(this._account,s,e,t):s.create_outbound(this._account,e,t),s}catch(r){throw s.free(),r}}writeRemoveOneTimeKey(e,t){this._account.remove_one_time_keys(e),t.session.set(hr,this._account.pickle(this._pickleKey))}writeSync(e,t,s){let r=e.signed_curve25519||0;if(Number.isSafeInteger(r)&&r!==this._serverOTKCount)return t.session.set(vi,r),s.set("otkCount",r),r}afterSync(e){Number.isSafeInteger(e)&&(this._serverOTKCount=e)}_deviceKeysPayload(e){let t={user_id:this._userId,device_id:this._deviceId,algorithms:[Es,Ie],keys:{}};for(let[s,r]of Object.entries(e))t.keys[`${s}:${this._deviceId}`]=r;return this.signObject(t),t}_oneTimeKeysPayload(e){let t={};for(let[s,r]of e){let n={key:r};this.signObject(n),t[`signed_curve25519:${s}`]=n}return t}async _updateSessionStorage(e,t){if(e){let s=await e.readWriteTxn([e.storeNames.session]);try{await t(s.session)}catch(r){throw s.abort(),r}await s.complete()}else await t(void 0)}signObject(e){let t=e.signatures||{},s=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=this._account.sign(zu.default.stringify(e)),e.signatures=t,s!==void 0&&(e.unsigned=s)}pickleWithKey(e){return this._account.pickle(e)}dispose(){this._account.free(),this._account=void 0}};var Cs=class{constructor(e,t){this._id=e,this._keyDescription=t}get id(){return this._id}get passphraseParams(){return this._keyDescription?.passphrase}get algorithm(){return this._keyDescription?.algorithm}async isCompatible(e,t){if(this.algorithm==="m.secret_storage.v1.aes-hmac-sha2"){let s=this._keyDescription;if(s.mac){let r=await mf(e.binaryKey,s.iv,t);return s.mac===r}else if(s.passphrase){let r=e.description._keyDescription;return r.passphrase?s.passphrase.algorithm===r.passphrase.algorithm&&s.passphrase.iterations===r.passphrase.iterations&&s.passphrase.salt===r.passphrase.salt:!1}}return!1}},_t=class{constructor(e,t){this._keyDescription=e,this._binaryKey=t}withDescription(e){return new _t(e,this._binaryKey)}get description(){return this._keyDescription}get id(){return this._keyDescription.id}get binaryKey(){return this._binaryKey}get algorithm(){return this._keyDescription.algorithm}};async function mf(i,e,t){let{crypto:s,encoding:r}=t,{utf8:n,base64:o}=r,{derive:a,aes:l,hmac:c}=s,u=o.decode(e),d=new Uint8Array(8),p="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",f=n.encode(""),g=await a.hkdf(i,d,f,"SHA-256",512),w=g.slice(0,32),C=g.slice(32),R=await l.encryptCTR({key:w,iv:u,data:n.encode(p)}),M=await c.compute(C,R,"SHA-256");return o.encode(M)}var hf=5e5,pf=256;async function Qu(i,e,t){let{passphraseParams:s}=i;if(!s)throw new Error("not a passphrase key");if(s.algorithm!=="m.pbkdf2")throw new Error(`Unsupported passphrase algorithm: ${s.algorithm}`);let{utf8:r}=t.encoding,n=await t.crypto.derive.pbkdf2(r.encode(e),s.iterations||hf,r.encode(s.salt),"SHA-512",s.bits||pf);return new _t(i,n)}var pr=[139,1];function Yu(i,e,t,s){let r=s.encoding.base58.decode(e.replace(/ /g,"")),n=0;for(let a of r)n^=a;if(n!==0)throw new Error("Incorrect parity");for(let a=0;a<pr.length;++a)if(r[a]!==pr[a])throw new Error("Incorrect prefix");if(r.length!==pr.length+t.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");let o=Uint8Array.from(r.slice(pr.length,pr.length+t.PRIVATE_KEY_LENGTH));return new _t(i,o)}var Ao=`${_e}ssssKey`,es=(t=>(t[t.RecoveryKey=0]="RecoveryKey",t[t.Passphrase=1]="Passphrase",t))(es||{});async function Ju(i){let e=await i.readTxn([i.storeNames.accountData]),s=(await e.accountData.get("m.secret_storage.default_key"))?.content?.key;if(!s)return;let r=await e.accountData.get(`m.secret_storage.key.${s}`);if(!!r)return new Cs(s,r.content)}async function Xu(i,e){e.session.set(Ao,{id:i.id,binaryKey:i.binaryKey})}async function Zu(i){let e=await i.session.get(Ao);if(!e)return;let t=await i.accountData.get(`m.secret_storage.key.${e.id}`);if(t)return new _t(new Cs(e.id,t.content),e.binaryKey)}async function ed(i){i.session.remove(Ao)}async function td(i,e,t,s,r){let n=await Ju(t);if(!n)throw new Error("Could not find a default secret storage key in account data");return await Co(i,e,n,s,r)}async function Co(i,e,t,s,r){let n;if(i===1)n=await Qu(t,e,s);else if(i===0)n=Yu(t,e,r,s);else throw new Error(`Invalid type: ${i}`);return n}async function sd(i,e,t){let s=await Ju(e);if(await s?.isCompatible(i,t))return i.withDescription(s)}var rd="org.matrix.msc2697.v1.olm.libolm_pickle";async function id(i,e,t,s){try{let r=await i.getDehydratedDevice({log:s}).response();if(r.device_data.algorithm===rd)return new od(r,e,t)}catch(r){r.name!=="HomeServerError"&&(s.error=r);return}}async function nd(i,e,t,s,r){let o=(await e.createDehydratedDevice({device_data:{algorithm:rd,account:i.pickleWithKey(t.binaryKey.slice()),passphrase:t.description?.passphraseParams||{}},initial_device_display_name:s}).response()).device_id;return i.setDeviceId(o),await i.uploadKeys(void 0,!0,r),o}var od=class{constructor(e,t,s){this._dehydratedDevice=e,this._olm=t,this._platform=s}async decrypt(e,t){let s=new Cs("dehydrated_device",this._dehydratedDevice.device_data.passphrase),r=await Co(e,t,s,this._platform,this._olm),n=new this._olm.Account;try{let o=this._dehydratedDevice.device_data.account;return n.unpickle(r.binaryKey.slice(),o),new ad(this._dehydratedDevice,n,r)}catch(o){if(n.free(),o.message==="OLM.BAD_ACCOUNT_KEY")return;throw o}}get deviceId(){return this._dehydratedDevice.device_id}},ad=class{constructor(e,t,s){this._dehydratedDevice=e,this._account=t,this._key=s}async claim(e,t){try{return(await e.claimDehydratedDevice(this.deviceId,{log:t}).response()).success}catch{return!1}}adoptUnpickledOlmAccount(){let e=this._account;return this._account=void 0,e}get deviceId(){return this._dehydratedDevice.device_id}get key(){return this._key}dispose(){this._account?.free(),this._account=void 0}};var Lo=class{tryTake(){return this._promise?!1:(this._promise=new Promise(e=>{this._resolve=e}),!0)}async take(){for(;!this.tryTake();)await this.released()}get isTaken(){return!!this._promise}release(){if(this._resolve){this._promise=void 0;let e=this._resolve;this._resolve=void 0,e()}}released(){return this._promise}},Do=class{constructor(e){this.locks=e}release(){for(let e of this.locks)e.release()}};function Vo(i,e,t,s){return{session:i.pickle(s),sessionId:i.session_id(),senderKey:e,lastUsed:t}}var Ls=class{constructor(e,t,s,r=!1){this.data=e,this._olm=s,this._pickleKey=t,this.isNew=r,this.isModified=r}static create(e,t,s,r,n){let o=Vo(t,e,n,r);return new Ls(o,r,s,!0)}get id(){return this.data.sessionId}load(){let e=new this._olm.Session;return e.unpickle(this._pickleKey,this.data.session),e}unload(e){e.free()}save(e){this.data.session=e.pickle(this._pickleKey),this.isModified=!0}};var fr=class{constructor(e,t,s){this.event=e,this.senderCurve25519Key=t,this.claimedEd25519Key=s,this._device=null,this._roomTracked=!0}setDevice(e){this._device=e}setRoomNotTrackedYet(){this._roomTracked=!1}get isVerified(){return this._device?this._device.ed25519Key===this.claimedEd25519Key:!1}get isUnverified(){return this._device?!this.isVerified:!this.isVerificationUnknown}get isVerificationUnknown(){return!this._device&&!this._roomTracked}};var ld=4;function qo(i){return i.type===0}function cd(i){i.sort((e,t)=>t.data.lastUsed-e.data.lastUsed)}var Bo=class{constructor({account:e,pickleKey:t,now:s,ownUserId:r,storage:n,olm:o,senderKeyLock:a}){this._account=e,this._pickleKey=t,this._now=s,this._ownUserId=r,this._storage=n,this._olm=o,this._senderKeyLock=a}async obtainDecryptionLock(e){let t=new Set;for(let r of e){let n=r.content?.sender_key;n&&t.add(n)}let s=await Promise.all(Array.from(t).map(r=>this._senderKeyLock.takeLock(r)));return new Do(s)}async decryptAll(e,t,s){try{let r=tt(e,u=>u.content?.sender_key),n=this._now(),o=await Promise.all(Array.from(r.entries()).map(([u,d])=>this._decryptAllForSenderKey(u,d,n,s))),a=o.reduce((u,d)=>u.concat(d.results),[]),l=o.reduce((u,d)=>u.concat(d.errors),[]),c=o.map(u=>u.senderKeyDecryption);return new dd(c,a,l,this._account,t)}catch(r){throw t.release(),r}}async _decryptAllForSenderKey(e,t,s,r){let n=await this._getSessions(e,r),o=new ud(e,n,this._olm,s),a=[],l=[];for(let c of t)try{let u=this._decryptForSenderKey(o,c,s);a.push(u)}catch(u){l.push(u)}return{results:a,errors:l,senderKeyDecryption:o}}_decryptForSenderKey(e,t,s){let r=e.senderKey,n=this._getMessageAndValidateEvent(t),o;try{o=e.decrypt(n)}catch(a){throw new G("OLM_BAD_ENCRYPTED_MESSAGE",t,{senderKey:r,error:a.message})}if(typeof o!="string"&&qo(n)){let a;try{a=this._createSessionAndDecrypt(r,n,s)}catch(l){throw new G(`Could not create inbound olm session: ${l.message}`,t,{senderKey:r,error:l})}e.addNewSession(a.session),o=a.plaintext}if(typeof o=="string"){let a;try{a=JSON.parse(o)}catch(l){throw new G("PLAINTEXT_NOT_JSON",t,{plaintext:o,error:l})}return this._validatePayload(a,t),new fr(a,r,a.keys.ed25519)}else throw new G("OLM_NO_MATCHING_SESSION",t,{knownSessionIds:e.sessions.map(a=>a.id)})}_createSessionAndDecrypt(e,t,s){let r,n=this._account.createInboundOlmSession(e,t.body);try{r=n.decrypt(t.type,t.body);let o=Ls.create(e,n,this._olm,this._pickleKey,s);return o.unload(n),{session:o,plaintext:r}}catch(o){throw n.free(),o}}_getMessageAndValidateEvent(e){let t=e.content?.ciphertext;if(!t)throw new G("OLM_MISSING_CIPHERTEXT",e);let s=t?.[this._account.identityKeys.curve25519];if(!s)throw new G("OLM_NOT_INCLUDED_IN_RECIPIENTS",e);return s}async _getSessions(e,t){let r=(await t.olmSessions.getAll(e)).map(n=>new Ls(n,this._pickleKey,this._olm));return cd(r),r}_validatePayload(e,t){if(e.sender!==t.sender)throw new G("OLM_FORWARDED_MESSAGE",t,{sentBy:t.sender,encryptedBy:e.sender});if(e.recipient!==this._ownUserId)throw new G("OLM_BAD_RECIPIENT",t,{recipient:e.recipient});if(e.recipient_keys?.ed25519!==this._account.identityKeys.ed25519)throw new G("OLM_BAD_RECIPIENT_KEY",t,{key:e.recipient_keys?.ed25519});if(!e.type)throw new G("missing type on payload",t,{payload:e});if(typeof e.keys?.ed25519!="string")throw new G("Missing or invalid claimed ed25519 key on payload",t,{payload:e})}},ud=class{constructor(e,t,s,r){this.senderKey=e,this.sessions=t,this._olm=s,this._timestamp=r}addNewSession(e){this.sessions.unshift(e)}decrypt(e){for(let t of this.sessions){let s=this._decryptWithSession(t,e);if(typeof s=="string")return cd(this.sessions),s}}getModifiedSessions(){return this.sessions.filter(e=>e.isModified)}get hasNewSessions(){return this.sessions.some(e=>e.isNew)}_decryptWithSession(e,t){let s=e.load();try{if(qo(t)&&!s.matches_inbound(t.body))return;try{let r=s.decrypt(t.type,t.body);return e.save(s),e.lastUsed=this._timestamp,r}catch(r){if(qo(t))throw new Error(`Error decrypting prekey message with existing session id ${e.id}: ${r.message}`);return}}finally{e.unload(s)}}},dd=class{constructor(e,t,s,r,n){this._senderKeyDecryptions=e,this._account=r,this.results=t,this.errors=s,this._lock=n}get hasNewSessions(){return this._senderKeyDecryptions.some(e=>e.hasNewSessions)}write(e){try{for(let t of this._senderKeyDecryptions){for(let s of t.getModifiedSessions())if(e.olmSessions.set(s.data),s.isNew){let r=s.load();try{this._account.writeRemoveOneTimeKey(r,e)}finally{s.unload(r)}}if(t.sessions.length>ld){let{senderKey:s,sessions:r}=t;for(let n=r.length-1;n>=ld;n-=1){let o=r[n];e.olmSessions.remove(s,o.id)}}}}finally{this._lock.release()}}};function ff(i){return i.reduce((e,t)=>!e||t<e?t:e,null)}var md="signed_curve25519",hd=20,Oo=class{constructor({account:e,olm:t,olmUtil:s,ownUserId:r,storage:n,now:o,pickleKey:a,senderKeyLock:l}){this._account=e,this._olm=t,this._olmUtil=s,this._ownUserId=r,this._storage=n,this._now=o,this._pickleKey=a,this._senderKeyLock=l}async encrypt(e,t,s,r,n){let o=[];for(let a=0;a<s.length;a+=hd){let l=s.slice(a,a+hd),c=await this._encryptForMaxDevices(e,t,l,r,n);o=o.concat(c)}return o}async _encryptForMaxDevices(e,t,s,r,n){let o=await Promise.all(s.map(a=>this._senderKeyLock.takeLock(a.curve25519Key)));try{let{devicesWithoutSession:a,existingEncryptionTargets:l}=await this._findExistingSessions(s),c=this._now(),u=[];try{if(a.length){let f=await n.wrap("create sessions",g=>this._createNewSessions(a,r,c,g));u=u.concat(f)}await this._loadSessions(l),u=u.concat(l);let d={l:"encrypt",targets:u.length},p=n.wrap(d,()=>u.map(f=>{let g=this._encryptForDevice(e,t,f);return new pd(g,f.device)}));return await this._storeSessions(u,c),p}finally{for(let d of u)d.dispose()}}finally{for(let a of o)a.release()}}async _findExistingSessions(e){let t=await this._storage.readTxn([this._storage.storeNames.olmSessions]),s=await Promise.all(e.map(async o=>await t.olmSessions.getSessionIds(o.curve25519Key))),r=e.filter((o,a)=>!s[a]?.length),n=e.map((o,a)=>{let l=s[a];if(l?.length>0){let c=ff(l);return Ds.fromSessionId(o,c)}}).filter(o=>!!o);return{devicesWithoutSession:r,existingEncryptionTargets:n}}_encryptForDevice(e,t,s){let{session:r,device:n}=s,o=JSON.stringify(this._buildPlainTextMessageForDevice(e,t,n)),a=r.encrypt(o);return{algorithm:Es,sender_key:this._account.identityKeys.curve25519,ciphertext:{[n.curve25519Key]:a}}}_buildPlainTextMessageForDevice(e,t,s){return{keys:{ed25519:this._account.identityKeys.ed25519},recipient_keys:{ed25519:s.ed25519Key},recipient:s.userId,sender:this._ownUserId,content:t,type:e}}async _createNewSessions(e,t,s,r){let n=await r.wrap("claim",o=>this._claimOneTimeKeys(t,e,o));try{for(let o of n){let{device:a,oneTimeKey:l}=o;o.session=await this._account.createOutboundOlmSession(a.curve25519Key,l)}await this._storeSessions(n,s)}catch(o){for(let a of n)a.dispose();throw o}return n}async _claimOneTimeKeys(e,t,s){let r=mr(t,l=>l.userId,()=>new Map,(l,c)=>l.set(c.deviceId,c)),n=Array.from(r.entries()).reduce((l,[c,u])=>(l[c]=Array.from(u.values()).reduce((d,p)=>(d[p.deviceId]=md,d),{}),l),{}),o=await e.claimKeys({timeout:1e4,one_time_keys:n},{log:s}).response();Object.keys(o.failures).length&&s.log({l:"failures",servers:Object.keys(o.failures)},s.level.Warn);let a=o?.one_time_keys;return this._verifyAndCreateOTKTargets(a,r,s)}_verifyAndCreateOTKTargets(e,t,s){let r=[];for(let[n,o]of Object.entries(e))for(let[a,l]of Object.entries(o)){let[c,u]=Object.entries(l)[0],[d]=c.split(":");if(d===md){let p=t.get(n)?.get(a);if(p&&Qr(this._olmUtil,n,a,p.ed25519Key,u,s)){let g=Ds.fromOTK(p,u.key);r.push(g)}}}return r}async _loadSessions(e){let t=await this._storage.readTxn([this._storage.storeNames.olmSessions]),s=!1;try{await Promise.all(e.map(async r=>{let n=await t.olmSessions.get(r.device.curve25519Key,r.sessionId);if(n&&!s){let o=new this._olm.Session;o.unpickle(this._pickleKey,n.session),r.session=o}}))}catch(r){s=!0;for(let n of e)n.dispose();throw r}}async _storeSessions(e,t){let s=await this._storage.readWriteTxn([this._storage.storeNames.olmSessions]);try{for(let r of e){let n=Vo(r.session,r.device.curve25519Key,t,this._pickleKey);s.olmSessions.set(n)}}catch(r){throw s.abort(),r}await s.complete()}},Ds=class{constructor(e,t,s){this.device=e,this.oneTimeKey=t,this.sessionId=s,this.session=null}static fromOTK(e,t){return new Ds(e,t,null)}static fromSessionId(e,t){return new Ds(e,null,t)}dispose(){this.session&&this.session.free()}},pd=class{constructor(e,t){this.content=e,this.device=t}};var No=class{constructor(e,t,s,r){this._roomId=e,this._results=t,this._errors=s,this._replayEntries=r}async write(e){return await Promise.all(this._replayEntries.map(async t=>{try{this._handleReplayAttack(this._roomId,t,e)}catch(s){this._errors.set(t.eventId,s)}})),{results:this._results,errors:this._errors}}async _handleReplayAttack(e,t,s){let{messageIndex:r,sessionId:n,eventId:o,timestamp:a}=t,l=await s.groupSessionDecryptions.get(e,n,r);if(l&&l.eventId!==o){let u=l.timestamp<a?o:l.eventId;throw this._results.delete(o),new G("MEGOLM_REPLAYED_INDEX",event,{messageIndex:r,badEventId:u,otherEventId:l.eventId})}l||s.groupSessionDecryptions.set(e,n,r,{eventId:o,timestamp:a})}};function gr(i,e){if(i)for(let[t,s]of i.entries())e.set(t,s)}var Po=class{constructor(e,t,s){this._roomId=e,this._sessionDecryptions=t,this._initialErrors=s}async decrypt(){try{let e=this._initialErrors,t=new Map,s=[];return await Promise.all(this._sessionDecryptions.map(async r=>{let n=await r.decryptAll();gr(n.errors,e),gr(n.results,t),s.push(...n.replayEntries)})),new No(this._roomId,t,e,s)}finally{this.dispose()}}dispose(){for(let e of this._sessionDecryptions)e.dispose()}};var Fo=class{constructor(e,t,s){this.sessionId=e,this.messageIndex=t,this.event=s}get eventId(){return this.event.event_id}get timestamp(){return this.event.origin_server_ts}};var Uo=class{constructor(e,t,s,r){this.key=e,this.events=t,this.olmWorker=s,this.keyLoader=r,this.decryptionRequests=s?[]:void 0}async decryptAll(){let e=[],t=new Map,s;return await this.keyLoader.useKey(this.key,async r=>{for(let n of this.events)try{let o=n.content.ciphertext,a;if(this.olmWorker){let d=this.olmWorker.megolmDecrypt(r,o);this.decryptionRequests.push(d),a=await d.response()}else a=r.decrypt(o);let{plaintext:l}=a,c;try{c=JSON.parse(l)}catch(d){throw new G("PLAINTEXT_NOT_JSON",n,{plaintext:l,err:d})}if(c.room_id!==this.key.roomId)throw new G("MEGOLM_WRONG_ROOM",n,{encryptedRoomId:c.room_id,eventRoomId:this.key.roomId});e.push(new Fo(this.key.sessionId,a.message_index,n));let u=new fr(c,this.key.senderKey,this.key.claimedEd25519Key);t.set(n.event_id,u)}catch(o){if(o.name==="AbortError")return;s||(s=new Map),s.set(n.event_id,o)}}),{results:t,errors:s,replayEntries:e}}dispose(){if(this.decryptionRequests)for(let e of this.decryptionRequests)e.abort()}};function Ko(i){return i.content?.sender_key}function jo(i){return i.content?.session_id}function gf(i){return i.content?.ciphertext}function fd(i){return typeof Ko(i)=="string"&&typeof jo(i)=="string"&&typeof gf(i)=="string"}var gd=class{constructor(){this.events=[]}get senderKey(){return Ko(this.events[0])}get sessionId(){return jo(this.events[0])}};function _r(i){return mr(i,e=>`${Ko(e)}|${jo(e)}`,()=>new gd,(e,t)=>e.events.push(t))}var $o=class{isForSession(e,t,s){return this.roomId===e&&this.senderKey===t&&this.sessionId===s}get isBetter(){return this._isBetter}set isBetter(e){this._isBetter=e}};function Ho(i,e){return i.first_known_index()<e.first_known_index()}var bi=class extends $o{checkBetterThanKeyInStorage(e,t){return this._checkBetterThanKeyInStorage(e,void 0,t)}async write(e,t){let s;if(this.isBetter===void 0&&await this._checkBetterThanKeyInStorage(e,(n,o)=>{s=n.pickle(o)},t),this.isBetter===!1)return!1;s||(s=await e.useKey(this,(n,o)=>n.pickle(o)));let r={roomId:this.roomId,senderKey:this.senderKey,sessionId:this.sessionId,session:s,claimedKeys:{ed25519:this.claimedEd25519Key}};return t.inboundGroupSessions.set(r),!0}get eventIds(){return this._eventIds}async _checkBetterThanKeyInStorage(e,t,s){if(this.isBetter!==void 0)return this.isBetter;let r=e.getCachedKey(this.roomId,this.senderKey,this.sessionId);if(!r){let n=await Wo(this.roomId,this.senderKey,this.sessionId,s);n&&(n.hasSession?r=n:n.eventIds&&(this._eventIds=n.eventIds))}if(r){let n=r;await e.useKey(this,async o=>{await e.useKey(n,(a,l)=>{this.isBetter=Ho(o,a),n.isBetter=!this.isBetter,this.isBetter&&t&&t(o,l)})})}else this.isBetter=!0;return this.isBetter}},_d=class extends bi{constructor(e){super();this._decryptionResult=e}get roomId(){return this._decryptionResult.event.content?.room_id}get senderKey(){return this._decryptionResult.senderCurve25519Key}get sessionId(){return this._decryptionResult.event.content?.session_id}get claimedEd25519Key(){return this._decryptionResult.claimedEd25519Key}get serializationKey(){return this._decryptionResult.event.content?.session_key}get serializationType(){return"create"}loadInto(e){e.create(this.serializationKey)}},yd=class extends bi{constructor(e,t,s){super();this._roomId=e,this._sessionId=t,this._backupInfo=s}get roomId(){return this._roomId}get senderKey(){return this._backupInfo.sender_key}get sessionId(){return this._sessionId}get claimedEd25519Key(){return this._backupInfo.sender_claimed_keys?.ed25519}get serializationKey(){return this._backupInfo.session_key}get serializationType(){return"import_session"}loadInto(e){e.import_session(this.serializationKey)}},wd=class extends $o{constructor(e){super();this.isBetter=!0,this.storageEntry=e}get roomId(){return this.storageEntry.roomId}get senderKey(){return this.storageEntry.senderKey}get sessionId(){return this.storageEntry.sessionId}get claimedEd25519Key(){return this.storageEntry.claimedKeys.ed25519}get eventIds(){return this.storageEntry.eventIds}get serializationKey(){return this.storageEntry.session||""}get serializationType(){return"unpickle"}loadInto(e,t){e.unpickle(t,this.serializationKey)}get hasSession(){return!!this.serializationKey}};function vd(i){let e=i.event.content?.session_key,t=new _d(i);if(typeof t.roomId=="string"&&typeof t.sessionId=="string"&&typeof t.senderKey=="string"&&typeof e=="string")return t}function bd(i,e,t){let s=t.session_key,r=t.sender_key,n=t.sender_claimed_keys?.ed25519;if(typeof i=="string"&&typeof e=="string"&&typeof r=="string"&&typeof s=="string"&&typeof n=="string")return new yd(i,e,t)}async function Wo(i,e,t,s){let r=await s.inboundGroupSessions.get(i,e,t);if(r)return new wd(r)}var zo=class{constructor(e,t){this.keyLoader=e,this.olmWorker=t}async addMissingKeyEventIds(e,t,s,r,n){let o=await n.inboundGroupSessions.get(e,t,s);if(!o?.session){if(o){let a=new Set(o.eventIds);for(let l of r)a.add(l);o.eventIds=Array.from(a)}else o={roomId:e,senderKey:t,sessionId:s,eventIds:r};n.inboundGroupSessions.set(o)}}async getEventIdsForMissingKey(e,t,s,r){let n=await r.inboundGroupSessions.get(e,t,s);if(n&&!n.session)return n.eventIds}async hasSession(e,t,s,r){return typeof(await r.inboundGroupSessions.get(e,t,s))?.session=="string"}async prepareDecryptAll(e,t,s,r){let n=new Map,o=[];for(let c of t)fd(c)?o.push(c):n.set(c.event_id,new G("MEGOLM_INVALID_EVENT",c));let a=_r(o),l=[];return await Promise.all(Array.from(a.values()).map(async c=>{let u=await this.getRoomKey(e,c.senderKey,c.sessionId,s,r);if(u)l.push(new Uo(u,c.events,this.olmWorker,this.keyLoader));else for(let d of c.events)n.set(d.event_id,new G("MEGOLM_NO_SESSION",d))})),new Po(e,l,n)}async getRoomKey(e,t,s,r,n){if(r){let l=r.find(c=>c.isForSession(e,t,s));if(l&&await l.checkBetterThanKeyInStorage(this.keyLoader,n))return l}let o=this.keyLoader.getCachedKey(e,t,s);if(o)return o;let a=await Wo(e,t,s,n);if(a&&a.serializationKey)return a}writeRoomKey(e,t){return e.write(this.keyLoader,t)}roomKeysFromDeviceMessages(e,t){let s=[];for(let r of e)r.event?.type!=="m.room_key"||r.event.content?.algorithm!==Ie||t.wrap("room_key",n=>{let o=vd(r);o?(n.set("roomId",o.roomId),n.set("id",o.sessionId),s.push(o)):(n.logLevel=n.level.Warn,n.set("invalid",!0))},t.level.Detail);return s}roomKeyFromBackup(e,t,s){return bd(e,t,s)}dispose(){this.keyLoader.dispose()}};var Go=class extends di{constructor(e,t,s){super(s);this.pickleKey=t,this.olm=e}getCachedKey(e,t,s){let r=this.findCachedKeyIndex(e,t,s);if(r!==-1)return this._getByIndexAndMoveUp(r).key}async useKey(e,t){let s=await this.allocateOperation(e);try{return await t(s.session,this.pickleKey)}finally{this.releaseOperation(s)}}get running(){return this._entries.some(e=>e.refCount!==0)}dispose(){for(let e=0;e<this._entries.length;e+=1)this._entries[e].dispose();this._entries.splice(0,this._entries.length)}async allocateOperation(e){let t;for(;(t=this.findIndexForAllocation(e))===-1;)await this.operationBecomesUnused();if(t<this.size){let s=this._getByIndexAndMoveUp(t);return s.isForKey(e)?(s.refCount+=1,s):(s.refCount=1,s.key=e,e.loadInto(s.session,this.pickleKey),s)}else{let s=new this.olm.InboundGroupSession;e.loadInto(s,this.pickleKey);let r=new Id(e,s);return this._set(r),r}}releaseOperation(e){e.refCount-=1,e.refCount<=0&&this.resolveUnusedOperation&&(this.resolveUnusedOperation(),this.operationBecomesUnusedPromise=this.resolveUnusedOperation=void 0)}operationBecomesUnused(){return this.operationBecomesUnusedPromise||(this.operationBecomesUnusedPromise=new Promise(e=>{this.resolveUnusedOperation=e})),this.operationBecomesUnusedPromise}findIndexForAllocation(e){let t=this.findIndexSameKey(e);return t===-1&&(this.size<this.limit?t=this.size:(t=this.findIndexSameSessionUnused(e),t===-1&&(t=this.findIndexOldestUnused()))),t}findCachedKeyIndex(e,t,s){return this._entries.reduce((r,n,o,a)=>{let l=r===-1?void 0:a[r];return n.isBest===!0&&n.isForSameSession(e,t,s)&&(!l||n.isBetter(l))?o:r},-1)}findIndexSameKey(e){return this._entries.findIndex(t=>t.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&t.isForKey(e))}findIndexSameSessionUnused(e){return this._entries.reduce((t,s,r,n)=>{let o=t===-1?void 0:n[t];return s.refCount===0&&s.isForSameSession(e.roomId,e.senderKey,e.sessionId)&&(!o||!s.isBetter(o))?r:t},-1)}findIndexOldestUnused(){for(let e=this._entries.length-1;e>=0;e-=1)if(this._entries[e].refCount===0)return e;return-1}},Id=class{constructor(e,t){this.key=e,this.session=t,this.refCount=1}isForSameSession(e,t,s){return this.key.roomId===e&&this.key.senderKey===t&&this.key.sessionId===s}isBetter(e){return Ho(this.session,e.session)}isForKey(e){return this.key.serializationKey===e.serializationKey&&this.key.serializationType===e.serializationType}dispose(){this.session.free(),this.session=void 0}get isBest(){return this.key.isBetter}};var yr=class{constructor({backupInfo:e,decryption:t,hsApi:s}){this._backupInfo=e,this._decryption=t,this._hsApi=s}async getSession(e,t,s){let r=await this._hsApi.roomKeyForRoomAndSession(this._backupInfo.version,e,t,{log:s}).response(),n=this._decryption.decrypt(r.session_data.ephemeral,r.session_data.mac,r.session_data.ciphertext);return JSON.parse(n)}get version(){return this._backupInfo.version}dispose(){this._decryption.free()}static async fromSecretStorage({platform:e,olm:t,secretStorage:s,hsApi:r,txn:n}){let o=await s.readSecret("m.megolm_backup.v1",n);if(o){let a=new Uint8Array(e.encoding.base64.decode(o)),l=await r.roomKeysVersion().response(),c=l.auth_data.public_key,u=new t.PkDecryption;try{let d=u.init_with_private_key(a);if(d!==c)throw new Error(`Bad backup key, public key does not match. Calculated ${d} but expected ${c}`)}catch(d){throw u.free(),d}return new yr({backupInfo:l,decryption:u,hsApi:r})}}};var Qo=class{constructor({pickleKey:e,olm:t,account:s,storage:r,now:n,ownDeviceId:o}){this._pickleKey=e,this._olm=t,this._account=s,this._storage=r,this._now=n,this._ownDeviceId=o}discardOutboundSession(e,t){t.outboundGroupSessions.remove(e)}async createRoomKeyMessage(e,t){let s=await t.outboundGroupSessions.get(e);if(s){let r=new this._olm.OutboundGroupSession;try{return r.unpickle(this._pickleKey,s.session),this._createRoomKeyMessage(r,e)}finally{r.free()}}}createWithheldMessage(e,t,s){return{algorithm:e.algorithm,code:t,reason:s,room_id:e.room_id,sender_key:this._account.identityKeys.curve25519,session_id:e.session_id}}async ensureOutboundSession(e,t){let s=new this._olm.OutboundGroupSession;try{let r=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]),n;try{let o=await r.outboundGroupSessions.get(e);n=this._readOrCreateSession(s,o,e,t,r),n&&this._writeSession(this._now(),s,e,r)}catch(o){throw r.abort(),o}return await r.complete(),n}finally{s.free()}}_readOrCreateSession(e,t,s,r,n){if(t&&e.unpickle(this._pickleKey,t.session),!t||this._needsToRotate(e,t.createdAt,r)){t&&(e.free(),e=new this._olm.OutboundGroupSession),e.create();let o=this._createRoomKeyMessage(e,s);return this._storeAsInboundSession(e,s,n),o}}_writeSession(e,t,s,r){r.outboundGroupSessions.set({roomId:s,session:t.pickle(this._pickleKey),createdAt:e})}async encrypt(e,t,s,r){let n=new this._olm.OutboundGroupSession;try{let o=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions,this._storage.storeNames.outboundGroupSessions]),a,l;try{let c=await o.outboundGroupSessions.get(e);a=this._readOrCreateSession(n,c,e,r,o),l=this._encryptContent(e,n,t,s);let u=a?this._now():c.createdAt;this._writeSession(u,n,e,o)}catch(c){throw o.abort(),c}return await o.complete(),new Sd(l,a)}finally{n&&n.free()}}_needsToRotate(e,t,s){let r=6048e5;Number.isSafeInteger(s?.rotation_period_ms)&&(r=s?.rotation_period_ms);let n=100;if(Number.isSafeInteger(s?.rotation_period_msgs)&&(n=s?.rotation_period_msgs),this._now()>t+r||e.message_index()>=n)return!0}_encryptContent(e,t,s,r){let n=JSON.stringify({room_id:e,type:s,content:r}),o=t.encrypt(n);return{algorithm:Ie,sender_key:this._account.identityKeys.curve25519,ciphertext:o,session_id:t.session_id(),device_id:this._ownDeviceId}}_createRoomKeyMessage(e,t){return{room_id:t,session_id:e.session_id(),session_key:e.session_key(),algorithm:Ie,chain_index:e.message_index()}}_storeAsInboundSession(e,t,s){let{identityKeys:r}=this._account,n={ed25519:r.ed25519},o=new this._olm.InboundGroupSession;try{o.create(e.session_key());let a={roomId:t,senderKey:r.curve25519,sessionId:o.session_id(),session:o.pickle(this._pickleKey),claimedKeys:n};return s.inboundGroupSessions.set(a),a}finally{o.free()}}},Sd=class{constructor(e,t){this.content=e,this.roomKeyMessage=t}};var Ed="m.room.encrypted",_f=60*1e3,Yo=class{constructor({room:e,deviceTracker:t,olmEncryption:s,megolmEncryption:r,megolmDecryption:n,encryptionParams:o,storage:a,sessionBackup:l,notifyMissingMegolmSession:c,clock:u}){this._room=e,this._deviceTracker=t,this._olmEncryption=s,this._megolmEncryption=r,this._megolmDecryption=n,this._encryptionParams=o,this._senderDeviceCache=new Map,this._storage=a,this._sessionBackup=l,this._notifyMissingMegolmSession=c,this._clock=u,this._isFlushingRoomKeyShares=!1,this._lastKeyPreShareTime=null,this._keySharePromise=null,this._disposed=!1}enableSessionBackup(e){this._sessionBackup&&!!e||(this._sessionBackup=e)}async restoreMissingSessionsFromBackup(e,t){let s=e.filter(u=>u.isEncrypted&&!u.isDecrypted&&u.event).map(u=>u.event),r=_r(s),n=Array.from(r.values()),o=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]),a=await Promise.all(n.map(async u=>this._megolmDecryption.hasSession(this._room.id,u.senderKey,u.sessionId,o))),l=n.filter((u,d)=>!a[d]);if(l.length)for(var c=l.length-1;c>=0;c--){let u=l[c];await t.wrap("session",d=>this._requestMissingSessionFromBackup(u.senderKey,u.sessionId,d))}}notifyTimelineClosed(){this._senderDeviceCache=new Map}async writeMemberChanges(e,t,s){let r=!1,n=Array.from(e.values());return n.some(o=>o.hasLeft)&&(s.log({l:"discardOutboundSession",leftUsers:n.filter(o=>o.hasLeft).map(o=>o.userId)}),this._megolmEncryption.discardOutboundSession(this._room.id,t)),n.some(o=>o.hasJoined)&&(r=await this._addShareRoomKeyOperationForNewMembers(n,t,s)),await this._deviceTracker.writeMemberChanges(this._room,e,t),r}async prepareDecryptAll(e,t,s,r){let n=new Map,o=[];for(let l of e)l.redacted_because||l.unsigned?.redacted_because||(l.content?.algorithm!==Ie&&n.set(l.event_id,new Error("Unsupported algorithm: "+l.content?.algorithm)),o.push(l));let a=await this._megolmDecryption.prepareDecryptAll(this._room.id,o,t,r);return new xd(a,n,s,this,e)}async _processDecryptionResults(e,t,s,r,n,o){let a=e.filter(c=>s.get(c.event_id)?.code==="MEGOLM_NO_SESSION");if(!a.length)return;let l=_r(a);r===Pe.Sync&&await Promise.all(Array.from(l.values()).map(async c=>{let u=c.events.map(d=>d.event_id);return this._megolmDecryption.addMissingKeyEventIds(this._room.id,c.senderKey,c.sessionId,u,n)})),!!this._sessionBackup&&o.wrapDetached("check key backup",async c=>{if(c.set("source",r),c.set("events",a.length),c.set("sessions",l.size),r===Pe.Sync){if(await this._clock.createTimeout(1e4).elapsed(),this._disposed)return;let u=await this._storage.readTxn([this._storage.storeNames.inboundGroupSessions]);await Promise.all(Array.from(l).map(async([d,p])=>{await this._megolmDecryption.hasSession(this._room.id,p.senderKey,p.sessionId,u)&&l.delete(d)}))}await Promise.all(Array.from(l.values()).map(u=>c.wrap("session",d=>this._requestMissingSessionFromBackup(u.senderKey,u.sessionId,d))))})}async _verifyDecryptionResult(e,t){let s=this._senderDeviceCache.get(e.senderCurve25519Key);s||(s=await this._deviceTracker.getDeviceByCurve25519Key(e.senderCurve25519Key,t),this._senderDeviceCache.set(e.senderCurve25519Key,s)),s?e.setDevice(s):this._room.isTrackingMembers||e.setRoomNotTrackedYet()}async _requestMissingSessionFromBackup(e,t,s){if(!this._sessionBackup){s.set("enabled",!1),this._notifyMissingMegolmSession();return}s.set("id",t),s.set("senderKey",e);try{let r=await this._sessionBackup.getSession(this._room.id,t,s);if(r?.algorithm===Ie){let n=this._megolmDecryption.roomKeyFromBackup(this._room.id,t,r);if(n){if(n.senderKey!==e){s.set("wrong_sender_key",n.senderKey),s.logLevel=s.level.Warn;return}let o=!1,a,l=await this._storage.readWriteTxn([this._storage.storeNames.inboundGroupSessions]);try{o=await this._megolmDecryption.writeRoomKey(n,l),s.set("isBetter",o),o&&(a=n.eventIds)}catch(c){throw l.abort(),c}await l.complete(),o&&await s.wrap("retryDecryption",c=>this._room.notifyRoomKey(n,a||[],c))}}else r?.algorithm&&s.set("unknown algorithm",r.algorithm)}catch(r){r.name==="HomeServerError"&&r.errcode==="M_NOT_FOUND"?(s.error=r,s.logLevel=s.level.Error):s.set("not_found",!0)}}getEventIdsForMissingKey(e,t){return this._megolmDecryption.getEventIdsForMissingKey(this._room.id,e.senderKey,e.sessionId,t)}async ensureMessageKeyIsShared(e,t){if(!(this._lastKeyPreShareTime?.measure()<_f)){this._lastKeyPreShareTime=this._clock.createMeasure();try{this._keySharePromise=(async()=>{let s=await this._megolmEncryption.ensureOutboundSession(this._room.id,this._encryptionParams);s&&await t.wrap("share key",r=>this._shareNewRoomKey(s,e,r))})(),await this._keySharePromise}finally{this._keySharePromise=null}}}async encrypt(e,t,s,r){this._keySharePromise&&(r.set("waitForRunningKeyShare",!0),await this._keySharePromise);let n=await r.wrap("megolm encrypt",()=>this._megolmEncryption.encrypt(this._room.id,e,t,this._encryptionParams));return n.roomKeyMessage&&await r.wrap("share key",o=>this._shareNewRoomKey(n.roomKeyMessage,s,o)),{type:Ed,content:n.content}}needsToShareKeys(e){for(let t of e.values())if(t.hasJoined)return!0;return!1}async _shareNewRoomKey(e,t,s){let r=await this._storage.readWriteTxn([this._storage.storeNames.operations]),n;try{n=this._writeRoomKeyShareOperation(e,null,r)}catch(o){throw r.abort(),o}await this._processShareRoomKeyOperation(n,t,s)}async _addShareRoomKeyOperationForNewMembers(e,t,s){let r=e.filter(o=>o.hasJoined).map(o=>o.userId),n=await this._megolmEncryption.createRoomKeyMessage(this._room.id,t);return n?(s.log({l:"share key for new members",userIds:r,id:n.session_id,chain_index:n.chain_index}),this._writeRoomKeyShareOperation(n,r,t),!0):!1}async flushPendingRoomKeyShares(e,t,s){if(!this._isFlushingRoomKeyShares){this._isFlushingRoomKeyShares=!0;try{t||(t=await(await this._storage.readTxn([this._storage.storeNames.operations])).operations.getAllByTypeAndScope("share_room_key",this._room.id));for(let r of t)r.type==="share_room_key"&&await s.wrap("operation",n=>this._processShareRoomKeyOperation(r,e,n))}finally{this._isFlushingRoomKeyShares=!1}}}_writeRoomKeyShareOperation(e,t,s){let n={id:Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(),type:"share_room_key",scope:this._room.id,userIds:t,roomKeyMessage:e};return s.operations.add(n),n}async _processShareRoomKeyOperation(e,t,s){s.set("id",e.id),await this._deviceTracker.trackRoom(this._room,s);let r;if(e.userIds===null){r=await this._deviceTracker.devicesForTrackedRoom(this._room.id,t,s);let a=Array.from(r.reduce((l,c)=>l.add(c.userId),new Set));e.userIds=a,await this._updateOperationsStore(l=>l.update(e))}else r=await this._deviceTracker.devicesForRoomMembers(this._room.id,e.userIds,t,s);let n=await s.wrap("olm encrypt",a=>this._olmEncryption.encrypt("m.room_key",e.roomKeyMessage,r,t,a)),o=r.filter(a=>!n.some(l=>l.device===a));await s.wrap("send",a=>this._sendMessagesToDevices(Ed,n,t,a)),o.length&&await s.wrap("missingDevices",async a=>{a.set("devices",o.map(u=>u.deviceId));let l=e.userIds.filter(u=>o.some(d=>d.userId===u));a.set("unsentUserIds",l),e.userIds=l,await this._updateOperationsStore(u=>u.update(e));let c=this._megolmEncryption.createWithheldMessage(e.roomKeyMessage,"m.no_olm","OTKs exhausted");await this._sendSharedMessageToDevices("org.matrix.room_key.withheld",c,o,t,a)}),await this._updateOperationsStore(a=>a.remove(e.id))}async _updateOperationsStore(e){let t=await this._storage.readWriteTxn([this._storage.storeNames.operations]);try{e(t.operations)}catch(s){throw t.abort(),s}await t.complete()}async _sendSharedMessageToDevices(e,t,s,r,n){let o=tt(s,c=>c.userId),a={messages:Array.from(o.entries()).reduce((c,[u,d])=>(c[u]=d.reduce((p,f)=>(p[f.deviceId]=t,p),{}),c),{})},l=Zt();await r.sendToDevice(e,a,l,{log:n}).response()}async _sendMessagesToDevices(e,t,s,r){r.set("messages",t.length);let n=tt(t,l=>l.device.userId),o={messages:Array.from(n.entries()).reduce((l,[c,u])=>(l[c]=u.reduce((d,p)=>(d[p.device.deviceId]=p.content,d),{}),l),{})},a=Zt();await s.sendToDevice(e,o,a,{log:r}).response()}filterUndecryptedEventEntriesForKeys(e,t){return e.filter(s=>{if(s.isEncrypted&&!s.isDecrypted){let{event:r}=s;if(r){let n=r.content?.sender_key,o=r.content?.session_id;return t.some(a=>n===a.senderKey&&o===a.sessionId)}}return!1})}dispose(){this._disposed=!0}},xd=class{constructor(e,t,s,r,n){this._megolmDecryptionPreparation=e,this._extraErrors=t,this._source=s,this._roomEncryption=r,this._events=n}async decrypt(){return new Td(await this._megolmDecryptionPreparation.decrypt(),this._extraErrors,this._source,this._roomEncryption,this._events)}dispose(){this._megolmDecryptionPreparation.dispose()}},Td=class{constructor(e,t,s,r,n){this._megolmDecryptionChanges=e,this._extraErrors=t,this._source=s,this._roomEncryption=r,this._events=n}async write(e,t){let{results:s,errors:r}=await this._megolmDecryptionChanges.write(e);return gr(this._extraErrors,r),await this._roomEncryption._processDecryptionResults(this._events,s,r,this._source,e,t),new Rd(s,r,this._roomEncryption)}},Rd=class{constructor(e,t,s){this.results=e,this.errors=t,this._roomEncryption=s}applyToEntries(e){for(let t of e){let s=this.results.get(t.id);if(s)t.setDecryptionResult(s);else{let r=this.errors.get(t.id);r&&t.setDecryptionError(r)}}}verifySenders(e){return Promise.all(Array.from(this.results.values()).map(t=>this._roomEncryption._verifyDecryptionResult(t,e)))}};var Jo=class{constructor(){this._map=new Map}async takeLock(e){let t=this._map.get(e);return t?await t.take():(t=new Lo,t.tryTake(),this._map.set(e,t)),t.released().then(()=>{Promise.resolve().then(()=>{t.isTaken||this._map.delete(e)})}),t}};var Xo=class{constructor({key:e,platform:t}){this._key=e,this._platform=t}async readSecret(e,t){let s=await t.accountData.get(e);if(!s)return;let r=s?.content?.encrypted?.[this._key.id];if(!r)throw new Error(`Secret ${s.type} is not encrypted for key ${this._key.id}`);if(this._key.algorithm==="m.secret_storage.v1.aes-hmac-sha2")return await this._decryptAESSecret(s.type,r);throw new Error(`Unsupported algorithm for key ${this._key.id}: ${this._key.algorithm}`)}async _decryptAESSecret(e,t){let{base64:s,utf8:r}=this._platform.encoding,n=await this._platform.crypto.derive.hkdf(this._key.binaryKey,new Uint8Array(8).buffer,r.encode(e),"SHA-256",512),o=n.slice(0,32),a=n.slice(32),l=s.decode(t.ciphertext);if(!await this._platform.crypto.hmac.verify(a,s.decode(t.mac),l,"SHA-256"))throw new Error("Bad MAC");let u=await this._platform.crypto.aes.decryptCTR({key:o,iv:s.decode(t.iv),data:l});return r.decode(u)}};var ts="DEFAULT_KEY",wr="pusher",Ii=class{constructor({storage:e,hsApi:t,sessionInfo:s,olm:r,olmWorker:n,platform:o,mediaRepository:a}){this._platform=o,this._storage=e,this._hsApi=t,this._mediaRepository=a,this._syncInfo=null,this._sessionInfo=s,this._rooms=new Ve,this._roomUpdateCallback=(l,c)=>this._rooms.update(l.id,c),this._activeArchivedRooms=new Map,this._invites=new Ve,this._inviteUpdateCallback=(l,c)=>this._invites.update(l.id,c),this._user=new ur(s.userId),this._deviceMessageHandler=new ko({storage:e}),this._olm=r,this._olmUtil=null,this._e2eeAccount=null,this._deviceTracker=null,this._olmEncryption=null,this._megolmEncryption=null,this._megolmDecryption=null,this._getSyncToken=()=>this.syncToken,this._olmWorker=n,this._sessionBackup=null,this._hasSecretStorageKey=new te(null),this._observedRoomStatus=new Map,r&&(this._olmUtil=new r.Utility,this._deviceTracker=new eo({storage:e,getSyncToken:this._getSyncToken,olmUtil:this._olmUtil,ownUserId:s.userId,ownDeviceId:s.deviceId})),this._createRoomEncryption=this._createRoomEncryption.bind(this),this._forgetArchivedRoom=this._forgetArchivedRoom.bind(this),this.needsSessionBackup=new te(!1)}get fingerprintKey(){return this._e2eeAccount?.identityKeys.ed25519}get hasSecretStorageKey(){return this._hasSecretStorageKey}get deviceId(){return this._sessionInfo.deviceId}get userId(){return this._sessionInfo.userId}async logout(e=void 0){await this._hsApi.logout({log:e}).response()}_setupEncryption(){let e=new Jo,t=new Bo({account:this._e2eeAccount,pickleKey:ts,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,senderKeyLock:e});this._olmEncryption=new Oo({account:this._e2eeAccount,pickleKey:ts,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownUserId:this._user.id,olmUtil:this._olmUtil,senderKeyLock:e}),this._megolmEncryption=new Qo({account:this._e2eeAccount,pickleKey:ts,olm:this._olm,storage:this._storage,now:this._platform.clock.now,ownDeviceId:this._sessionInfo.deviceId});let s=new Go(this._olm,ts,20);this._megolmDecryption=new zo(s,this._olmWorker),this._deviceMessageHandler.enableEncryption({olmDecryption:t,megolmDecryption:this._megolmDecryption})}_createRoomEncryption(e,t){if(!this._olmEncryption)throw new Error("creating room encryption before encryption got globally enabled");return t.algorithm!==Ie?null:new Yo({room:e,deviceTracker:this._deviceTracker,olmEncryption:this._olmEncryption,megolmEncryption:this._megolmEncryption,megolmDecryption:this._megolmDecryption,storage:this._storage,sessionBackup:this._sessionBackup,encryptionParams:t,notifyMissingMegolmSession:()=>{this._sessionBackup||this.needsSessionBackup.set(!0)},clock:this._platform.clock})}async enableSecretStorage(e,t){if(!this._olm)throw new Error("olm required");if(this._sessionBackup)return!1;let s=await td(e,t,this._storage,this._platform,this._olm),r=await this._storage.readTxn([this._storage.storeNames.accountData]);return await this._createSessionBackup(s,r),await this._writeSSSSKey(s),this._hasSecretStorageKey.set(!0),s}async _writeSSSSKey(e){let t=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{Xu(e,t)}catch(s){throw t.abort(),s}await t.complete()}async disableSecretStorage(){let e=await this._storage.readWriteTxn([this._storage.storeNames.session]);try{ed(e)}catch(t){throw e.abort(),t}if(await e.complete(),this._sessionBackup){for(let t of this._rooms.values())t.isEncrypted&&t.enableSessionBackup(void 0);this._sessionBackup?.dispose(),this._sessionBackup=void 0}this._hasSecretStorageKey.set(!1)}async _createSessionBackup(e,t){let s=new Xo({key:e,platform:this._platform});if(this._sessionBackup=await yr.fromSecretStorage({platform:this._platform,olm:this._olm,secretStorage:s,hsApi:this._hsApi,txn:t}),this._sessionBackup)for(let r of this._rooms.values())r.isEncrypted&&r.enableSessionBackup(this._sessionBackup);this.needsSessionBackup.set(!1)}get sessionBackup(){return this._sessionBackup}get hasIdentity(){return!!this._e2eeAccount}async createIdentity(e){this._olm&&(this._e2eeAccount||(this._e2eeAccount=await this._createNewAccount(this._sessionInfo.deviceId,this._storage),e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()),await this._e2eeAccount.generateOTKsIfNeeded(this._storage,e),await e.wrap("uploadKeys",t=>this._e2eeAccount.uploadKeys(this._storage,!1,t)))}async dehydrateIdentity(e,t){return t.set("deviceId",e.deviceId),this._olm?e.deviceId!==this.deviceId?(t.set("wrong_device",!0),!1):this._e2eeAccount?(t.set("account_already_setup",!0),!1):await e.claim(this._hsApi,t)?(this._e2eeAccount=await gt.adoptDehydratedDevice({dehydratedDevice:e,hsApi:this._hsApi,olm:this._olm,pickleKey:ts,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:this.deviceId,storage:this._storage}),t.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption(),!0):(t.set("already_claimed",!0),!1):(t.set("no_olm",!0),!1)}_createNewAccount(e,t=void 0){return gt.create({hsApi:this._hsApi,olm:this._olm,pickleKey:ts,userId:this._sessionInfo.userId,olmWorker:this._olmWorker,deviceId:e,storage:t})}setupDehydratedDevice(e,t=null){return this._platform.logger.wrapOrRun(t,"setupDehydratedDevice",async s=>{let r=await this._createNewAccount("temp-device-id");try{let n=await nd(r,this._hsApi,e,"Dehydrated device",s);return s.set("deviceId",n),n}finally{r.dispose()}})}async load(e){let t=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.roomSummary,this._storage.storeNames.invites,this._storage.storeNames.roomMembers,this._storage.storeNames.timelineEvents,this._storage.storeNames.timelineFragments,this._storage.storeNames.pendingEvents]);this._syncInfo=await t.session.get("sync"),this._olm&&(this._e2eeAccount=await gt.load({hsApi:this._hsApi,olm:this._olm,pickleKey:ts,userId:this._sessionInfo.userId,deviceId:this._sessionInfo.deviceId,olmWorker:this._olmWorker,txn:t}),this._e2eeAccount&&(e.set("keys",this._e2eeAccount.identityKeys),this._setupEncryption()));let s=await this._getPendingEventsByRoom(t),r=await t.invites.getAll(),n=Promise.all(r.map(async l=>{let c=this.createInvite(l.roomId);e.wrap("invite",u=>c.load(l,u)),this._invites.add(c.id,c)})),o=await t.roomSummary.getAll(),a=Promise.all(o.map(async l=>{let c=this.createRoom(l.roomId,s.get(l.roomId));await e.wrap("room",u=>c.load(l,t,u)),this._rooms.add(c.id,c)}));await Promise.all([n,a]);for(let[l,c]of this.invites){let u=this.rooms.get(l);u&&u.setInvite(c)}}dispose(){this._olmWorker?.dispose(),this._olmWorker=void 0,this._sessionBackup?.dispose(),this._sessionBackup=void 0,this._megolmDecryption?.dispose(),this._megolmDecryption=void 0,this._e2eeAccount?.dispose(),this._e2eeAccount=void 0;for(let e of this._rooms.values())e.dispose();this._rooms=void 0}async start(e,t,s){if(e){let a=await this._storage.readWriteTxn([this._storage.storeNames.session]);a.session.set("serverVersions",e),await a.complete()}if(!this._sessionBackup){t&&await s.wrap("SSSSKeyFromDehydratedDeviceKey",async c=>{let u=await sd(t.key,this._storage,this._platform);u&&(c.set("success",!0),await this._writeSSSSKey(u))});let a=await this._storage.readTxn([this._storage.storeNames.session,this._storage.storeNames.accountData]),l=await Zu(a);l&&await this._createSessionBackup(l,a),this._hasSecretStorageKey.set(!!l)}let n=await(await this._storage.readWriteTxn([this._storage.storeNames.operations])).operations.getAll(),o=tt(n,a=>a.scope);for(let a of this._rooms.values()){let l,c=o.get(a.id);c&&(l=tt(c,u=>u.type)),a.start(l,s)}}async _getPendingEventsByRoom(e){return(await e.pendingEvents.getAll()).reduce((s,r)=>{let n=s.get(r.roomId);return n?n.push(r):s.set(r.roomId,[r]),s},new Map)}get rooms(){return this._rooms}createRoom(e,t){return new wi({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:this._roomUpdateCallback,hsApi:this._hsApi,mediaRepository:this._mediaRepository,pendingEvents:t,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform})}_createArchivedRoom(e){let t=new xo({roomId:e,getSyncToken:this._getSyncToken,storage:this._storage,emitCollectionChange:()=>{},releaseCallback:()=>this._activeArchivedRooms.delete(e),forgetCallback:this._forgetArchivedRoom,hsApi:this._hsApi,mediaRepository:this._mediaRepository,user:this._user,createRoomEncryption:this._createRoomEncryption,platform:this._platform});return this._activeArchivedRooms.set(e,t),t}get invites(){return this._invites}createInvite(e){return new To({roomId:e,hsApi:this._hsApi,emitCollectionUpdate:this._inviteUpdateCallback,mediaRepository:this._mediaRepository,user:this._user,platform:this._platform})}async obtainSyncLock(e){let t=e.to_device?.events;if(Array.isArray(t)&&t.length)return await this._deviceMessageHandler.obtainSyncLock(t)}async prepareSync(e,t,s,r){let n=e.to_device?.events;if(Array.isArray(n)&&n.length)return await r.wrap("deviceMsgs",o=>this._deviceMessageHandler.prepareSync(n,t,s,o))}async writeSync(e,t,s,r,n){let o={syncInfo:null,e2eeAccountChanges:null},a=e.next_batch;if(a!==this.syncToken){let d={token:a,filterId:t};r.session.set("sync",d),o.syncInfo=d}let l=e.device_one_time_keys_count;this._e2eeAccount&&l&&(o.e2eeAccountChanges=this._e2eeAccount.writeSync(l,r,n));let c=e.device_lists;this._deviceTracker&&Array.isArray(c?.changed)&&c.changed.length&&await n.wrap("deviceLists",d=>this._deviceTracker.writeDeviceChanges(c.changed,r,d)),s&&await n.wrap("deviceMsgs",d=>this._deviceMessageHandler.writeSync(s,r,d));let u=e.account_data;if(Array.isArray(u?.events))for(let d of u.events)typeof d.type=="string"&&r.accountData.set(d);return o}afterSync({syncInfo:e,e2eeAccountChanges:t}){e&&(this._syncInfo=e),this._e2eeAccount&&this._e2eeAccount.afterSync(t)}async afterSyncCompleted(e,t,s){t||await this._e2eeAccount.generateOTKsIfNeeded(this._storage,s)&&await s.wrap("uploadKeys",n=>this._e2eeAccount.uploadKeys(this._storage,!1,n))}applyRoomCollectionChangesAfterSync(e,t,s){for(let r of t)r.shouldAdd?this._rooms.add(r.id,r.room):r.shouldRemove&&this._rooms.remove(r.id);for(let r of e)r.shouldAdd?this._invites.add(r.id,r.invite):r.shouldRemove&&this._invites.remove(r.id);if(this._observedRoomStatus.size!==0){for(let r of s)r.shouldAdd&&this._observedRoomStatus.get(r.id)?.set(N.archived);for(let r of t)r.shouldAdd&&this._observedRoomStatus.get(r.id)?.set(N.joined);for(let r of e){let n=this._observedRoomStatus.get(r.id);n&&(r.shouldAdd?n.set(n.get().withInvited()):r.shouldRemove&&n.set(n.get().withoutInvited()))}}}_forgetArchivedRoom(e){let t=this._observedRoomStatus.get(e);t&&t.set(t.get().withoutArchived())}get syncToken(){return this._syncInfo?.token}get syncFilterId(){return this._syncInfo?.filterId}get user(){return this._user}get mediaRepository(){return this._mediaRepository}enablePushNotifications(e){return e?this._enablePush():this._disablePush()}async _enablePush(){return this._platform.logger.run("enablePush",async e=>{let t=ft.createDefaultPayload(this._sessionInfo.id),s=await this._platform.notificationService.enablePush(ft,t);if(!s)return e.set("no_pusher",!0),!1;await s.enable(this._hsApi,e);let r=await this._storage.readWriteTxn([this._storage.storeNames.session]);return r.session.set(wr,s.serialize()),await r.complete(),!0})}async _disablePush(){return this._platform.logger.run("disablePush",async e=>{await this._platform.notificationService.disablePush();let s=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(wr);if(!s)return!0;await new ft(s).disable(this._hsApi,e);let n=await this._storage.readWriteTxn([this._storage.storeNames.session]);return n.session.remove(wr),await n.complete(),!0})}async arePushNotificationsEnabled(){return await this._platform.notificationService.isPushEnabled()?!!await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(wr):!1}async checkPusherEnabledOnHomeserver(){let t=await(await this._storage.readTxn([this._storage.storeNames.session])).session.get(wr);if(!t)return!1;let s=new ft(t);return((await this._hsApi.getPushers().response())?.pushers||[]).map(o=>new ft(o)).some(o=>o.equals(s))}async getRoomStatus(e){if(!!this._rooms.get(e))return N.joined;{let s=!!this._invites.get(e),n=await(await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary])).archivedRoomSummary.has(e);return s&&n?N.invitedAndArchived:s?N.invited:n?N.archived:N.none}}async observeRoomStatus(e){let t=this._observedRoomStatus.get(e);if(!t){let s=await this.getRoomStatus(e);t=new bs(s,()=>{this._observedRoomStatus.delete(e)}),this._observedRoomStatus.set(e,t)}return t}createOrGetArchivedRoomForSync(e){let t=this._activeArchivedRooms.get(e);return t?t.retain():t=this._createArchivedRoom(e),t}loadArchivedRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"loadArchivedRoom",async s=>{s.set("id",e);let r=this._activeArchivedRooms.get(e);if(r)return r.retain(),r;let n=await this._storage.readTxn([this._storage.storeNames.archivedRoomSummary,this._storage.storeNames.roomMembers]),o=await n.archivedRoomSummary.get(e);if(o){let a=this._createArchivedRoom(e);return await a.load(o,n,s),a}})}joinRoom(e,t=null){return this._platform.logger.wrapOrRun(t,"joinRoom",async s=>(await this._hsApi.joinIdOrAlias(e,{log:s}).response()).room_id)}};var Zo=class{constructor({username:e,password:t,homeserver:s}){this._username=e,this._password=t,this.homeserver=s}async login(e,t,s){return await e.passwordLogin(this._username,this._password,t,{log:s}).response()}};var ea=class{constructor({homeserver:e,loginToken:t}){this.homeserver=e,this._loginToken=t}async login(e,t,s){return await e.tokenLogin(this._loginToken,Zt(),t,{log:s}).response()}};var ta=class{constructor(e){this._homeserver=e}get homeserver(){return this._homeserver}createSSORedirectURL(e){return`${this._homeserver}/_matrix/client/r0/login/sso/redirect?redirectUrl=${e}`}};var A=fe("NotLoading","Login","LoginFailed","QueryAccount","AccountSetup","Loading","SessionSetup","Migrating","FirstSync","Error","Ready"),je=fe("Connection","Credentials","Unknown"),kd=class{constructor({platform:e,olmPromise:t,workerPromise:s}){this._platform=e,this._sessionStartedByReconnector=!1,this._status=new te(A.NotLoading),this._error=null,this._loginFailure=null,this._reconnector=null,this._session=null,this._sync=null,this._sessionId=null,this._storage=null,this._requestScheduler=null,this._olmPromise=t,this._workerPromise=s,this._accountSetup=void 0}createNewSessionId(){return Math.floor(this._platform.random()*Number.MAX_SAFE_INTEGER).toString()}get sessionId(){return this._sessionId}async startWithExistingSession(e){this._status.get()===A.NotLoading&&(this._status.set(A.Loading),await this._platform.logger.run("load session",async t=>{t.set("id",e);try{let s=await this._platform.sessionInfoStorage.get(e);if(!s)throw new Error("Invalid session id: "+e);await this._loadSessionInfo(s,null,t),t.set("status",this._status.get())}catch(s){t.catch(s),this._error=s,this._status.set(A.Error)}}))}_parseLoginOptions(e,t){let s=e.flows,r={homeserver:t};for(let n of s)n.type==="m.login.password"?r.password=(o,a)=>new Zo({homeserver:t,username:o,password:a}):n.type==="m.login.sso"&&s.find(o=>o.type==="m.login.token")?r.sso=new ta(t):n.type==="m.login.token"&&(r.token=o=>new ea({homeserver:t,loginToken:o}));return r}queryLogin(e){return new gn(async t=>{e=await Wc(e,(n,o)=>t(this._platform.request(n,o)));let s=new Et({homeserver:e,request:this._platform.request}),r=await t(s.getLoginFlows()).response();return this._parseLoginOptions(r,e)})}async startWithLogin(e,{inspectAccountSetup:t}={}){let s=this._status.get();s!==A.LoginFailed&&s!==A.NotLoading&&s!==A.Error||(this._resetStatus(),await this._platform.logger.run("login",async r=>{this._status.set(A.Login);let n=this._platform.clock,o;try{let l=this._platform.request,c=new Et({homeserver:e.homeserver,request:l}),u=await e.login(c,"Hydrogen",r),d=this.createNewSessionId();o={id:d,deviceId:u.device_id,userId:u.user_id,homeServer:e.homeserver,homeserver:e.homeserver,accessToken:u.access_token,lastUsed:n.now()},r.set("id",d)}catch(l){this._error=l,l.name==="HomeServerError"?(l.errcode==="M_FORBIDDEN"?this._loginFailure=je.Credentials:this._loginFailure=je.Unknown,r.set("loginFailure",this._loginFailure),this._status.set(A.LoginFailed)):l.name==="ConnectionError"?(this._loginFailure=je.Connection,this._status.set(A.LoginFailed)):this._status.set(A.Error);return}let a;t&&(a=await this._inspectAccountAfterLogin(o,r),a&&(o.deviceId=a.deviceId)),await this._platform.sessionInfoStorage.add(o);try{await this._loadSessionInfo(o,a,r),r.set("status",this._status.get())}catch(l){r.catch(l),a?.dispose(),this._error=l,this._status.set(A.Error)}}))}async _loadSessionInfo(e,t,s){s.set("appVersion",this._platform.version);let r=this._platform.clock;this._sessionStartedByReconnector=!1,this._status.set(A.Loading),this._reconnector=new wn({onlineStatus:this._platform.onlineStatus,retryDelay:new Ss(r.createTimeout),createMeasure:r.createMeasure});let n=new Et({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request,reconnector:this._reconnector});this._sessionId=e.id,this._storage=await this._platform.storageFactory.create(e.id,s);let o={id:e.id,deviceId:e.deviceId,userId:e.userId,homeserver:e.homeServer},a=await this._olmPromise,l=null;this._workerPromise&&(l=await this._workerPromise),this._requestScheduler=new In({hsApi:n,clock:r}),this._requestScheduler.start();let c=new vn({homeserver:e.homeServer,platform:this._platform});if(this._session=new Ii({storage:this._storage,sessionInfo:o,hsApi:this._requestScheduler.hsApi,olm:a,olmWorker:l,mediaRepository:c,platform:this._platform}),await this._session.load(s),t?(await s.wrap("dehydrateIdentity",u=>this._session.dehydrateIdentity(t,u)),await this._session.setupDehydratedDevice(t.key,s)):this._session.hasIdentity||(this._status.set(A.SessionSetup),await s.wrap("createIdentity",u=>this._session.createIdentity(u))),this._sync=new Gr({hsApi:this._requestScheduler.hsApi,storage:this._storage,session:this._session,logger:this._platform.logger}),this._reconnectSubscription=this._reconnector.connectionStatus.subscribe(u=>{u===Bt.Online&&this._platform.logger.runDetached("reconnect",async d=>{this._requestScheduler.start(),this._sync.start(),this._sessionStartedByReconnector=!0;let p=t;t=void 0,await d.wrap("session start",f=>this._session.start(this._reconnector.lastVersionsResponse,p,f))})}),await s.wrap("wait first sync",()=>this._waitForFirstSync()),!this._isDisposed&&(this._status.set(A.Ready),!this._sessionStartedByReconnector)){let u=await n.versions({timeout:1e4,log:s}).response();if(this._isDisposed)return;let d=t;t=void 0,await s.wrap("session start",p=>this._session.start(u,d,p))}}async _waitForFirstSync(){this._sync.start(),this._status.set(A.FirstSync),this._waitForFirstSyncHandle=this._sync.status.waitFor(e=>e===B.Stopped?this._sync.error?.name!=="ConnectionError":e===B.Syncing);try{if(await this._waitForFirstSyncHandle.promise,this._sync.status.get()===B.Stopped&&this._sync.error)throw this._sync.error}catch(e){if(e.name==="AbortError")return;throw e}finally{this._waitForFirstSyncHandle=null}}_inspectAccountAfterLogin(e,t){return t.wrap("inspectAccount",async s=>{this._status.set(A.QueryAccount);let r=new Et({homeserver:e.homeServer,accessToken:e.accessToken,request:this._platform.request}),n=await this._olmPromise,o;try{o=await id(r,n,this._platform,s)}catch(a){if(a.name==="HomeServerError")s.set("not_supported",!0);else throw a}if(o){let a,l=new Promise(u=>a=u);this._accountSetup=new Md(o,a),this._status.set(A.AccountSetup),await l;let c=this._accountSetup?._dehydratedDevice;return this._accountSetup=null,c}})}get accountSetup(){return this._accountSetup}get loadStatus(){return this._status}get loadError(){return this._error}get loginFailure(){return this._loginFailure}get sync(){return this._sync}get session(){return this._session}get reconnector(){return this._reconnector}get _isDisposed(){return!this._reconnector}logout(){return this._platform.logger.run("logout",async e=>{try{await this._session?.logout(e)}catch{}await this.deleteSession(e)})}dispose(){this._reconnectSubscription&&(this._reconnectSubscription(),this._reconnectSubscription=null),this._reconnector=null,this._requestScheduler&&(this._requestScheduler.stop(),this._requestScheduler=null),this._sync&&(this._sync.stop(),this._sync=null),this._session&&(this._session.dispose(),this._session=null),this._waitForFirstSyncHandle&&(this._waitForFirstSyncHandle.dispose(),this._waitForFirstSyncHandle=null),this._storage&&(this._storage.close(),this._storage=null)}async deleteSession(e){this._sessionId&&(this.dispose(),await Promise.all([e.wrap("storageFactory",()=>this._platform.storageFactory.delete(this._sessionId)),e.wrap("sessionInfoStorage",()=>this._platform.sessionInfoStorage.delete(this._sessionId))]),this._sessionId=null)}_resetStatus(){this._status.set(A.NotLoading),this._error=null,this._loginFailure=null}},Md=class{constructor(e,t){this._encryptedDehydratedDevice=e,this._dehydratedDevice=void 0,this._finishStage=t}get encryptedDehydratedDevice(){return this._encryptedDehydratedDevice}finish(e){this._dehydratedDevice=e,this._finishStage()}};var sa=class{constructor(e){this._allowsChild=e,this._path=new st([],e),this._observables=new Map,this._pathObservable=new te(this._path)}get pathObservable(){return this._pathObservable}get path(){return this._path}push(e,t=void 0){return this.applyPath(this.path.with(new Ee(e,t)))}applyPath(e){let t=this._path;this._path=e;for(let s=t.segments.length-1;s>=0;s-=1){let r=t.segments[s];this._path.get(r.type)||this._observables.get(r.type)?.emitIfChanged()}for(let s of this._path.segments)this._observables.get(s.type)?.emitIfChanged();this._pathObservable.set(this._path)}observe(e){let t=this._observables.get(e);return t||(t=new Ad(this,e),this._observables.set(e,t)),t}pathFrom(e){let t,s;for(s=0;s<e.length;s+=1){if(!this._allowsChild(t,e[s]))return new st(e.slice(0,s),this._allowsChild);t=e[s]}return new st(e,this._allowsChild)}segment(e,t){return new Ee(e,t)}};function yf(i,e){if(i===e)return!0;if(Array.isArray(i)&&Array.isArray(e)){let t=Math.max(i.length,e.length);for(let s=0;s<t;s+=1)if(i[s]!==e[s])return!1;return!0}return!1}var Ee=class{constructor(e,t){this.type=e,this.value=t===void 0?!0:t}},st=class{constructor(e=[],t){this._segments=e,this._allowsChild=t}clone(){return new st(this._segments.slice(),this._allowsChild)}with(e){let t=this._segments.length-1;do{if(this._allowsChild(this._segments[t],e)){let s=this._segments.slice(0,t+1);return s.push(e),new st(s,this._allowsChild)}t-=1}while(t>=-1);return null}until(e){let t=this._segments.findIndex(s=>s.type===e);return t!==-1?new st(this._segments.slice(0,t+1),this._allowsChild):new st([],this._allowsChild)}get(e){return this._segments.find(t=>t.type===e)}replace(e){let t=this._segments.findIndex(s=>s.type===e.type);if(t!==-1){let s=this._segments[t-1];if(this._allowsChild(s,e)){let r=this._segments[t+1];if(!r||this._allowsChild(e,r)){let n=this._segments.slice();return n[t]=e,new st(n,this._allowsChild)}}}return null}get segments(){return this._segments}},Ad=class extends Je{constructor(e,t){super();this._navigation=e,this._type=t,this._lastSetValue=e.path.get(t)?.value}get(){return this._navigation.path.get(this._type)?.value}emitIfChanged(){let e=this.get();yf(e,this._lastSetValue)||(this._lastSetValue=e,this.emit(e))}};var ra=class{constructor({history:e,navigation:t,parseUrlPath:s,stringifyPath:r}){this._history=e,this._navigation=t,this._parseUrlPath=s,this._stringifyPath=r,this._subscription=null,this._pathSubscription=null,this._isApplyingUrl=!1,this._defaultSessionId=this._getLastSessionId()}_getLastSessionId(){let t=this._urlAsNavPath(this._history.getLastUrl()||"").get("session")?.value;return typeof t=="string"?t:null}attach(){this._subscription=this._history.subscribe(e=>this._applyUrl(e)),this._pathSubscription=this._navigation.pathObservable.subscribe(e=>this._applyNavPathToHistory(e)),this._applyUrl(this._history.get())}dispose(){this._subscription=this._subscription(),this._pathSubscription=this._pathSubscription()}_applyNavPathToHistory(e){let t=this.urlForPath(e);t!==this._history.get()&&(this._isApplyingUrl?this._history.replaceUrlSilently(t):this._history.pushUrlSilently(t))}_applyNavPathToNavigation(e){this._isApplyingUrl=!0,this._navigation.applyPath(e),this._isApplyingUrl=!1}_urlAsNavPath(e){let t=this._history.urlAsPath(e);return this._navigation.pathFrom(this._parseUrlPath(t,this._navigation.path,this._defaultSessionId))}_applyUrl(e){let t=this._urlAsNavPath(e);this._applyNavPathToNavigation(t)}pushUrl(e){this._history.pushUrl(e)}tryRestoreLastUrl(){let e=this._urlAsNavPath(this._history.getLastUrl()||"");return e.segments.length!==0?(this._applyNavPathToNavigation(e),!0):!1}urlForSegments(e){let t=this._navigation.path;for(let s of e)if(t=t.with(s),!t)return;return this.urlForPath(t)}urlForSegment(e,t){return this.urlForSegments([this._navigation.segment(e,t)])}urlUntilSegment(e){return this.urlForPath(this._navigation.path.until(e))}urlForPath(e){return this._history.pathAsUrl(this._stringifyPath(e))}openRoomActionUrl(e){let t=`${this._stringifyPath(this._navigation.path.until("session"))}/open-room/${e}`;return this._history.pathAsUrl(t)}createSSOCallbackURL(){return window.location.origin}normalizeUrl(){this._history.replaceUrlSilently(`${window.location.origin}/${window.location.hash}`)}};function Cd(){return new sa(vf)}function wf({history:i,navigation:e}){return new ra({history:i,navigation:e,stringifyPath:Sf,parseUrlPath:If})}function vf(i,e){let{type:t}=e;switch(i?.type){case void 0:return t==="login"||t==="session"||t==="sso";case"session":return t==="room"||t==="rooms"||t==="settings";case"rooms":return t==="room"||t==="empty-grid-tile";case"room":return t==="lightbox"||t==="right-panel";case"right-panel":return t==="details"||t==="members"||t==="member";default:return!1}}function bf(i,e,t){if(i.value.includes(e))return i;{let s=t.get("empty-grid-tile"),r=t.get("room"),n=0;s?n=s.value:r&&(n=i.value.indexOf(r.value));let o=i.value.slice();return o[n]=e,new Ee("rooms",o)}}function Ld(i,e,t=!0){i.push(new Ee("right-panel")),i.push(new Ee(e,t))}function vr(i,e){let t=i.path.segments,s=t.findIndex(n=>n.type==="right-panel"),r=e;return s!==-1&&(r=e.until("room"),r=r.with(t[s]),r=r.with(t[s+1])),r}function If(i,e,t){let s=i.substr(1).split("/"),r=s[Symbol.iterator](),n=[],o;for(;!(o=r.next()).done;){let a=o.value;if(a==="rooms"){let l=r.next().value;if(l===void 0)break;let c=l.split(",");n.push(new Ee(a,c));let u=parseInt(r.next().value||"0",10),d=c[u];d?n.push(new Ee("room",d)):n.push(new Ee("empty-grid-tile",u))}else if(a==="open-room"){let l=r.next().value;if(!l)break;let c=e.get("rooms");if(c&&n.push(bf(c,l,e)),n.push(new Ee("room",l)),s.findIndex(p=>p==="open-room")>=s.length-2){let p=e.segments,f=p.findIndex(g=>g.type==="right-panel");f!==-1&&n.push(...p.slice(f))}}else if(a==="last-session"){let l=e.get("session");typeof l?.value!="string"&&t&&(l=new Ee("session",t)),l&&n.push(l)}else if(a==="details"||a==="members")Ld(n,a);else if(a==="member"){let l=r.next().value;if(!l)break;Ld(n,a,l)}else if(a.includes("loginToken")){let l=a.split("=").pop();n.push(new Ee("sso",l))}else{let l=r.next().value;n.push(new Ee(a,l))}}return n}function Sf(i){let e="",t;for(let s of i.segments){switch(s.type){case"rooms":e+=`/rooms/${s.value.join(",")}`;break;case"empty-grid-tile":e+=`/${s.value}`;break;case"room":t?.type==="rooms"?e+=`/${t.value.indexOf(s.value)}`:e+=`/${s.type}/${s.value}`;break;case"right-panel":case"sso":continue;default:e+=`/${s.type}`,s.value&&s.value!==!0&&(e+=`/${s.value}`)}t=s}return e}function Dd(i,e,t,s){let r=i(e),n=!1;return r.elapsed().then(()=>{n=!0,t.abort()},()=>{}),s.then(o=>(r.abort(),o),o=>{throw r.abort(),o.name==="AbortError"&&n?new ge(`Request timed out after ${e}ms`,!0):o})}function Si(i,e=Math.random){return i.includes("?")?i=i+"&":i=i+"?",i+`_cacheBuster=${Math.ceil(e()*Number.MAX_SAFE_INTEGER)}`}var Vd=class{constructor(e,t){this._promise=e,this._xhr=t}abort(){this._xhr.abort()}response(){return this._promise}};function Ef(i,{method:e,headers:t,timeout:s,format:r,uploadProgress:n}){let o=new XMLHttpRequest;if(n&&o.upload.addEventListener("progress",a=>n(a.loaded)),o.open(e,i),r==="buffer"&&(o.responseType="arraybuffer"),t)for(let[a,l]of t.entries())try{o.setRequestHeader(a,l)}catch(c){console.info(`Could not set ${a} header: ${c.message}`)}return s&&(o.timeout=s),o}function xf(i,e,t){return new Promise((s,r)=>{i.addEventListener("load",()=>s(i)),i.addEventListener("abort",()=>r(new j)),i.addEventListener("error",()=>r(new ge(`Error ${e} ${t}`))),i.addEventListener("timeout",()=>r(new ge(`Timeout ${e} ${t}`,!0)))})}function Ei(i,e){let{cache:t,format:s,body:r,method:n}=e;t||(i=Si(i));let o=Ef(i,e),a=xf(o,n,i).then(l=>{let{status:c}=l,u=null;return s==="buffer"?u=l.response:l.getResponseHeader("Content-Type")==="application/json"&&(u=JSON.parse(l.responseText)),{status:c,body:u}});return r?.nativeBlob&&(r=r.nativeBlob),o.send(r||null),new Vd(a,o)}var ia=class{constructor(e,t){if(t)this.promise=e,this._controller=t;else{let s=new Promise((r,n)=>{this._controller={abort(){let o=new Error("fetch request aborted");o.name="AbortError",n(o)}}});this.promise=Promise.race([e,s])}}abort(){this._controller.abort()}response(){return this.promise}};function qd(i,e){return function(s,r){if(e?.haltRequests)return new ia(new Promise(()=>{}),{});if(r?.uploadProgress)return Ei(s,r);let{method:n,headers:o,body:a,timeout:l,format:c,cache:u=!1}=r,d=typeof AbortController=="function"?new AbortController:null;a?.nativeBlob&&(a=a.nativeBlob);let p={method:n,body:a};if(d&&(p=Object.assign(p,{signal:d.signal})),u||(s=Si(s)),p=Object.assign(p,{mode:"cors",credentials:"omit",referrer:"no-referrer",cache:"default"}),o){let w=new Headers;for(let[C,R]of o.entries())w.append(C,R);p.headers=w}let f=fetch(s,p).then(async w=>{let{status:C}=w,R;try{c==="json"?R=await w.json():c==="buffer"&&(R=await w.arrayBuffer())}catch(M){if(!(M.name==="SyntaxError"&&C>=400))throw M}return{status:C,body:R}},w=>{throw w.name==="AbortError"?new j:w instanceof TypeError?new ge(`${n} ${s}: ${w.message}`):w}),g=new ia(f,d);return l&&(g.promise=Dd(i,l,g,g.promise)),g}}var na=class{constructor(e){this._name=e}getAll(){let e=localStorage.getItem(this._name);if(e){let t=JSON.parse(e);if(Array.isArray(t))return Promise.resolve(t)}return Promise.resolve([])}async updateLastUsed(e,t){let s=await this.getAll();if(s){let r=s.find(n=>n.id===e);r&&(r.lastUsed=t,localStorage.setItem(this._name,JSON.stringify(s)))}}async get(e){let t=await this.getAll();if(t)return t.find(s=>s.id===e)}async add(e){let t=await this.getAll();t.push(e),localStorage.setItem(this._name,JSON.stringify(t))}async delete(e){let t=await this.getAll();t=t.filter(s=>s.id!==e),localStorage.setItem(this._name,JSON.stringify(t))}};var oa=class{constructor(e){this._prefix=e}async setInt(e,t){this._set(e,t)}async getInt(e,t=0){let s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?parseInt(s,10):t}async setBool(e,t){this._set(e,t)}async getBool(e,t=!1){let s=window.localStorage.getItem(`${this._prefix}${e}`);return typeof s=="string"?s==="true":t}async setString(e,t){this._set(e,t)}async getString(e){return window.localStorage.getItem(`${this._prefix}${e}`)}async remove(e){window.localStorage.removeItem(`${this._prefix}${e}`)}async _set(e,t){window.localStorage.setItem(`${this._prefix}${e}`,t)}};var aa=class{constructor(){this._encoder=null,this._decoder=null}encode(e){return this._encoder||(this._encoder=new TextEncoder),this._encoder.encode(e)}decode(e){return this._decoder||(this._decoder=new TextDecoder),this._decoder.decode(e)}};var xi=vs(ca()),ua=class{encodeUnpadded(e){let t=xi.default.encode(e),s=t.indexOf("=");return s!==-1?t.substr(0,s):t}encode(e){return xi.default.encode(e)}decode(e){return xi.default.decode(e)}};var Ia=vs(cm()),Sa=class{encode(e){return Ia.default.encode(e)}decode(e){return Ia.default.decode(e)}};var Ea=class{constructor(){this.utf8=new aa,this.base64=new ua,this.base58=new Sa}};var xa=class{constructor(e){this._workerPool=e}megolmDecrypt(e,t){let s=e.export_session(e.first_known_index());return this._workerPool.send({type:"megolm_decrypt",ciphertext:t,sessionKey:s})}async createAccountAndOTKs(e,t){let s;window.msCrypto&&(s=[window.msCrypto.getRandomValues(new Uint8Array(64)),window.msCrypto.getRandomValues(new Uint8Array(t*32))]);let r=await this._workerPool.send({type:"olm_create_account_otks",randomValues:s,otkAmount:t}).response();e.unpickle("",r)}async createOutboundOlmSession(e,t,s,r){let n=e.pickle(""),o;window.msCrypto&&(o=[window.msCrypto.getRandomValues(new Uint8Array(64))]);let a=await this._workerPool.send({type:"olm_create_outbound",accountPickle:n,theirIdentityKey:s,theirOneTimeKey:r,randomValues:o}).response();t.unpickle("",a)}dispose(){this._workerPool.dispose()}};var At=class{constructor(e,t,s,r){this._logger=s,this.start=s._now(),this._values=typeof e=="string"?{l:e}:e,this.logLevel=t,this._filterCreator=r}runDetached(e,t,s,r){return this._logger.runDetached(e,t,s,r)}wrapDetached(e,t,s,r){this.refDetached(this.runDetached(e,t,s,r))}refDetached(e,t){e.ensureRefId(),this.log({ref:e.values.refId},t)}ensureRefId(){this._values.refId||this.set("refId",this._logger._createRefId())}wrap(e,t,s,r){return this.child(e,s,r).run(t)}get duration(){if(this.end)return this.end-this.start}durationWithoutType(e){let t=this.durationOfType(e);if(this.duration&&t)return this.duration-t}durationOfType(e){return this._values.t===e?this.duration:this._children?this._children.reduce((t,s)=>{let r=s.durationOfType(e);return t+(r??0)},0):0}log(e,t){let s=this.child(e,t);return s.end=s.start,s}set(e,t){if(typeof e=="object"){let s=e;Object.assign(this._values,s)}else this._values[e]=t}serialize(e,t,s){if(this._filterCreator)try{e=this._filterCreator(new ks(e),this)}catch(o){console.error("Error creating log filter",o)}let r=null;if(this._children&&(r=this._children.reduce((o,a)=>{let l=a.serialize(e,this.start,!1);return l&&(o===null&&(o=[]),o.push(l)),o},null)),e&&!e.filter(this,r))return;let n={s:typeof t=="number"?this.start-t:this.start,d:this.duration,v:this._values,l:this.logLevel};return this.error&&(n.e={stack:this.error.stack,name:this.error.name,message:this.error.message.split(`
`)[0]}),s&&(n.f=!0),r&&(n.c=r),n}run(e){this.end!==void 0&&console.trace("log item is finished, additional logs will likely not be recorded");try{let t=e(this);return t instanceof Promise?t.then(s=>(this.finish(),s),s=>{throw this.catch(s)}):(this.finish(),t)}catch(t){throw this.catch(t)}}finish(){if(this.end===void 0){if(this._children)for(let e of this._children)e.finish();this.end=this._logger._now()}}get level(){return Re}catch(e){return this.error=e,this.logLevel=Re.Error,this.finish(),e}child(e,t,s){this.end&&console.trace("log item is finished, additional logs will likely not be recorded"),t||(t=this.logLevel||Re.Info);let r=new At(e,t,this._logger,s);return this._children||(this._children=[]),this._children.push(r),r}get logger(){return this._logger}get values(){return this._values}get children(){return this._children}};var Ir=class{constructor({platform:e,serializedTransformer:t=s=>s}){this._openItems=new Set;this._platform=e,this._serializedTransformer=t}log(e,t=Re.Info){let s=new At(e,t,this);s.end=s.start,this._persistItem(s,void 0,!1)}wrapOrRun(e,t,s,r,n){return e?e.wrap(t,s,r,n):this.run(t,s,r,n)}runDetached(e,t,s,r){s||(s=Re.Info);let n=new At(e,s,this);return this._run(n,t,s,!1,r),n}run(e,t,s,r){s===void 0&&(s=Re.Info);let n=new At(e,s,this);return this._run(n,t,s,!0,r)}_run(e,t,s,r,n){this._openItems.add(e);let o=()=>{let a=new ks;if(n)try{a=n(a,e)}catch(l){console.error("Error while creating log filter",l)}else a=a.minLevel(s);try{this._persistItem(e,a,!1)}catch(l){console.error("Could not persist log item",l)}this._openItems.delete(e)};try{let a=e.run(t);if(a instanceof Promise){if(a=a.then(l=>(o(),l),l=>{if(o(),r)throw l}),r)return a}else if(o(),r)return a}catch(a){if(o(),r)throw a}}_finishOpenItems(){for(let e of this._openItems){e.finish();try{this._persistItem(e,new ks,!0)}catch(t){console.error("Could not serialize log item",t)}}this._openItems.clear()}get level(){return Re}_now(){return this._platform.clock.now()}_createRefId(){return Math.round(this._platform.random()*Number.MAX_SAFE_INTEGER)}};var Ta=class extends Ir{constructor(e){super(e);let{name:t,flushInterval:s=60*1e3,limit:r=3e3}=e;this._name=t,this._limit=r,this._queuedItems=this._loadQueuedItems(),window.addEventListener("pagehide",this,!1),this._flushInterval=this._platform.clock.createInterval(()=>this._tryFlush(),s)}dispose(){window.removeEventListener("pagehide",this,!1),this._flushInterval.dispose()}handleEvent(e){e.type==="pagehide"&&this._finishAllAndFlush()}async _tryFlush(){let e=await this._openDB();try{let t=e.transaction(["logs"],"readwrite"),s=t.objectStore("logs"),r=this._queuedItems.length;for(let o of this._queuedItems)s.add(o);let n=await z(s.count());if(n>this._limit){let o=n-this._limit+Math.round(.1*this._limit);await H(s.openCursor(),(a,l,c)=>(c.delete(),o-=1,{done:o===0}))}await mt(t),this._queuedItems.splice(0,r)}catch(t){console.error("Could not flush logs",t)}finally{try{e.close()}catch{}}}_finishAllAndFlush(){this._finishOpenItems(),this.log({l:"pagehide, closing logs",t:"navigation"}),this._persistQueuedItems(this._queuedItems)}_loadQueuedItems(){let e=`${this._name}_queuedItems`;try{let t=window.localStorage.getItem(e);if(t)return window.localStorage.removeItem(e),JSON.parse(t)}catch(t){console.error("Could not load queued log items",t)}return[]}_openDB(){return Wt(this._name,e=>e.createObjectStore("logs",{keyPath:"id",autoIncrement:!0}),1)}_persistItem(e,t,s){let r=e.serialize(t,void 0,s);if(r){let n=this._serializedTransformer(r);this._queuedItems.push({json:JSON.stringify(n)})}}_persistQueuedItems(e){try{window.localStorage.setItem(`${this._name}_queuedItems`,JSON.stringify(e))}catch(t){console.error("Could not persist queued log items in localStorage, they will likely be lost",t)}}async export(){let e=await this._openDB();try{let s=e.transaction(["logs"],"readonly").objectStore("logs"),n=(await pu(s.openCursor(),()=>!1)).concat(this._queuedItems);return new um(n,this,this._platform)}finally{try{e.close()}catch{}}}async _removeItems(e){let t=await this._openDB();try{let s=t.transaction(["logs"],"readwrite"),r=s.objectStore("logs");for(let n of e)if(typeof n.id=="number")r.delete(n.id);else{let o=this._queuedItems.indexOf(n);o===-1&&this._queuedItems.splice(o,1)}await mt(s)}finally{try{t.close()}catch{}}}},um=class{constructor(e,t,s){this._items=e,this._logger=t,this._platform=s}get count(){return this._items.length}removeFromStore(){return this._logger._removeItems(this._items)}asBlob(){let e={formatVersion:1,appVersion:this._platform.updateService?.version,items:this._items.map(n=>JSON.parse(n.json))},t=JSON.stringify(e),s=this._platform.encoding.utf8.encode(t);return this._platform.createBlob(s,"application/json")}};var Ra=class extends Ir{_persistItem(e){dm(e)}async export(){}},ag=["l","id"];function lg(i){return Object.entries(i).filter(([e])=>!ag.includes(e)).reduce((e,[t,s])=>(e=e||{},e[t]=s,e),null)}function dm(i){let e=`${cg(i)} (${i.duration}ms)`,t=lg(i.values),s=i.children||t;if(s?(i.error?console.group(e):console.groupCollapsed(e),i.error&&console.error(i.error)):i.error?console.error(i.error):console.log(e),t&&console.table(t),i.children)for(let r of i.children)dm(r);s&&console.groupEnd()}function cg(i){return i.values.t==="network"?`${i.values.method} ${i.values.url}`:i.values.l&&typeof i.values.id!="undefined"?`${i.values.l} ${i.values.id}`:i.values.l&&typeof i.values.status!="undefined"?`${i.values.l} (${i.values.status})`:i.values.l&&i.error?`${i.values.l} failed`:typeof i.values.ref!="undefined"?`ref ${i.values.ref}`:i.values.l||i.values.type}function ka(i){return typeof i!="object"||"nodeType"in i||Array.isArray(i)}function wt(i,e){return Object.entries(i).reduce((t,[s,r])=>(typeof r=="function"&&(r=r(e)),r?t+(t.length?" ":"")+s:t),"")}function Ct(i,e,t){e==="className"&&(e="class"),t===!1?i.removeAttribute(e):(t===!0&&(t=e),i.setAttribute(e,t))}function mm(i,e,t){return hm(Ci,i,e,t)}function hm(i,e,t,s){t&&ka(t)&&(s=t,t=void 0);let r=document.createElementNS(i,e);if(t)for(let[n,o]of Object.entries(t))typeof o=="object"&&(o=o!==null&&n==="className"?wt(o,void 0):!1),Ct(r,n,o);if(s){Array.isArray(s)||(s=[s]);for(let n of s)typeof n=="string"&&(n=Be(n)),r.appendChild(n)}return r}function Be(i){return document.createTextNode(i)}var Ci="http://www.w3.org/1999/xhtml",ug="http://www.w3.org/2000/svg",Ma={[Ci]:["br","a","ol","ul","li","div","h1","h2","h3","h4","h5","h6","p","strong","em","span","img","section","main","article","aside","del","blockquote","table","thead","tbody","tr","th","td","hr","pre","code","button","time","input","textarea","label","form","progress","output","video"],[ug]:["svg","circle"]},x={};for(let[i,e]of Object.entries(Ma))for(let t of e)x[t]=function(s,r){return hm(i,t,s,r)};function vt(i,e){let t;try{t=i.mount(e)}catch(s){t=dg(s)}return t}function dg(i){let e=new Error().stack,t=null;return e&&(t=e.split(`
`)[1]),x.div([x.h2("Something went wrong\u2026"),x.h3(i.message),x.p(`This occurred while running ${t}.`),x.pre(i.stack)])}function Aa(i,e,t){if(e===i.childElementCount)i.appendChild(t);else{let r=i.children[e];i.insertBefore(t,r)}}function pm(i){i.innerHTML=""}var $e=class{constructor({list:e,onItemClick:t,className:s,tagName:r="ul",parentProvidesUpdates:n=!0},o){this._onItemClick=t,this._list=e,this._className=s,this._tagName=r,this._root=void 0,this._subscription=void 0,this._childCreator=o,this._childInstances=void 0,this._mountArgs={parentProvidesUpdates:n}}root(){return this._root}update(e){if(e.list){if(this._subscription)for(this._unloadList();this._root.lastChild;)this._root.lastChild.remove();this._list=e.list,this.loadList()}}mount(){let e={};this._className&&(e.className=this._className);let t=this._root=mm(this._tagName,e);return this.loadList(),this._onItemClick&&t.addEventListener("click",this),t}handleEvent(e){e.type==="click"&&this._handleClick(e)}unmount(){this._list&&this._unloadList()}_handleClick(e){if(e.target===this._root||!this._onItemClick)return;let t=e.target;for(;t.parentNode!==this._root;)t=t.parentNode;let s=Array.prototype.indexOf.call(this._root.childNodes,t),r=this._childInstances[s];r&&this._onItemClick(r,e)}_unloadList(){this._subscription=this._subscription();for(let e of this._childInstances)e.unmount();this._childInstances=void 0}loadList(){if(!this._list)return;this._subscription=this._list.subscribe(this),this._childInstances=[];let e=document.createDocumentFragment();for(let t of this._list){let s=this._childCreator(t);this._childInstances.push(s),e.appendChild(vt(s,this._mountArgs))}this._root.appendChild(e)}onReset(){for(let e of this._childInstances)e.root().remove(),e.unmount();this._childInstances.length=0}onAdd(e,t){this.addChild(e,t)}onRemove(e,t){this.removeChild(e)}onMove(e,t,s){this.moveChild(e,t)}onUpdate(e,t,s){this.updateChild(e,t,s)}addChild(e,t){let s=this._childCreator(t);this._childInstances.splice(e,0,s),Aa(this._root,e,vt(s,this._mountArgs))}removeChild(e){let[t]=this._childInstances.splice(e,1);t.root().remove(),t.unmount()}moveChild(e,t){let[s]=this._childInstances.splice(e,1);this._childInstances.splice(t,0,s),s.root().remove(),Aa(this._root,t,s.root())}updateChild(e,t,s){if(this._childInstances){let r=this._childInstances[e];r&&r.update(t,s)}}recreateItem(e,t){if(this._childInstances){let s=this._childCreator(t);if(!s)this.onRemove(e,t);else{let[r]=this._childInstances.splice(e,1,s);this._root.replaceChild(s.mount(this._mountArgs),r.root()),r.unmount()}}}getChildInstanceByIndex(e){return this._childInstances?.[e]}};var Sr=class{constructor(e){this._value=e,this._boundUpdateFromValue=null}subscribeOnMount(e){e&&e.parentProvidesUpdates||this._subscribe()}unmount(){this._unsubscribe()}get value(){return this._value}_updateFromValue(e){this.update(this._value,e)}_subscribe(){typeof this._value?.on=="function"&&(this._boundUpdateFromValue=this._updateFromValue.bind(this),this._value.on("change",this._boundUpdateFromValue))}_unsubscribe(){this._boundUpdateFromValue&&(typeof this._value.off=="function"&&this._value.off("change",this._boundUpdateFromValue),this._boundUpdateFromValue=null)}};function mg(i){for(let e of Object.values(i))if(typeof e=="function")return!0;return!1}var y=class extends Sr{constructor(e,t){super(e);this._eventListeners=void 0;this._bindings=void 0;this._root=void 0;this._subViews=void 0;this._render=t}_attach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:r}of this._eventListeners)e.addEventListener(t,s,r)}_detach(){if(this._eventListeners)for(let{node:e,name:t,fn:s,useCapture:r}of this._eventListeners)e.removeEventListener(t,s,r)}mount(e){let t=new Ca(this);try{if(this._render)this._root=this._render(t,this._value);else if(this.render)this._root=this.render(t,this._value);else throw new Error("no render function passed in, or overriden in subclass")}finally{t.close()}return this.subscribeOnMount(e),this._attach(),this._root}unmount(){if(this._detach(),super.unmount(),this._subViews)for(let e of this._subViews)e.unmount()}root(){return this._root}update(e,t){if(this._value=e,this._bindings)for(let s of this._bindings)s()}_addEventListener(e,t,s,r=!1){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push({node:e,name:t,fn:s,useCapture:r})}_addBinding(e){this._bindings||(this._bindings=[]),this._bindings.push(e)}addSubView(e){this._subViews||(this._subViews=[]),this._subViews.push(e)}removeSubView(e){if(!this._subViews)return;let t=this._subViews.indexOf(e);t!==-1&&this._subViews.splice(t,1)}updateSubViews(e,t){if(this._subViews)for(let s of this._subViews)s.update(e,t)}},Ca=class{constructor(e){this._closed=!1;this._templateView=e}close(){this._closed=!0}_addBinding(e){this._closed&&console.trace("Adding a binding after render will likely cause memory leaks"),this._templateView._addBinding(e)}get _value(){return this._templateView.value}addEventListener(e,t,s,r=!1){this._templateView._addEventListener(e,t,s,r)}_addAttributeBinding(e,t,s){let r,n=()=>{let o=s(this._value);r!==o&&(r=o,Ct(e,t,o))};this._addBinding(n),n()}_addClassNamesBinding(e,t){this._addAttributeBinding(e,"className",s=>wt(t,s))}_addTextBinding(e){let t=e(this._value),s=Be(t),r=t,n=()=>{let o=e(this._value);r!==o&&(r=o,s.textContent=o+"")};return this._addBinding(n),s}_isEventHandler(e,t){return e.startsWith("on")&&e.length>2&&typeof t=="function"}_setNodeAttributes(e,t){for(let[s,r]of Object.entries(t))if(typeof r=="object"){if(s!=="className"||r===null)continue;mg(r)?this._addClassNamesBinding(e,r):Ct(e,s,wt(r,this._value))}else if(this._isEventHandler(s,r)){let n=s.substr(2,1).toLowerCase()+s.substr(3),o=r;this._templateView._addEventListener(e,n,o)}else typeof r=="function"?this._addAttributeBinding(e,s,r):Ct(e,s,r)}_setNodeChildren(e,t){Array.isArray(t)||(t=[t]);for(let s of t)typeof s=="function"?s=this._addTextBinding(s):typeof s=="string"&&(s=Be(s)),e.appendChild(s)}_addReplaceNodeBinding(e,t){let s=e(this._value),r=t(null),n=()=>{let o=e(this._value);if(s!==o){s=o;let a=t(r);r.parentNode&&r.parentNode.replaceChild(a,r),r=a}};return this._addBinding(n),r}el(e,t,s){return this.elNS(Ci,e,t,s)}elNS(e,t,s,r){s!==void 0&&ka(s)&&(r=s,s=void 0);let n=document.createElementNS(e,t);return s&&this._setNodeAttributes(n,s),r&&this._setNodeChildren(n,r),n}view(e,t){return this._templateView.addSubView(e),vt(e,t)}mapView(e,t){return this._addReplaceNodeBinding(e,s=>{if(s&&s.nodeType!==Node.COMMENT_NODE){let n=this._templateView._subViews;if(n){let o=n.findIndex(a=>a.root()===s);if(o!==-1){let[a]=n.splice(o,1);a.unmount()}}}let r=t(e(this._value));return r?this.view(r):document.createComment("node binding placeholder")})}map(e,t){return this.mapView(e,s=>new y(this._value,(r,n)=>{let o=t(s,r,n);return o||document.createComment("map placeholder")}))}ifView(e,t){return this.mapView(s=>!!e(s),s=>s?t(this._value):null)}if(e,t){return this.ifView(e,s=>new y(s,t))}mapSideEffect(e,t){let s=e(this._value),r=()=>{let n=e(this._value);s!==n&&(t(n,s),s=n)};this._addBinding(r),t(s,void 0)}};for(let[i,e]of Object.entries(Ma))for(let t of e)Ca.prototype[t]=function(s,r){return this.elNS(i,t,s,r)};function He(i,e,t=void 0){let s=!!i.avatarUrl(e),r=wt({avatar:!0,[`size-${e}`]:!0,[`usercolor${i.avatarColorNumber}`]:!s});t&&(r+=` ${t}`);let n=s?La(i,e):Be(i.avatarLetter),o=x.div({className:r},[n]);return s&&(Ct(o,"data-avatar-letter",i.avatarLetter),Ct(o,"data-avatar-color",i.avatarColorNumber)),o}function La(i,e){let t=e.toString();return x.img({src:i.avatarUrl(e),width:t,height:t,title:i.avatarTitle})}function hg(i){let e=i.target,t=e.parentElement;return e.tagName==="IMG"&&t.classList.contains("avatar")}function Da(i){if(!hg(i))return;let e=i.target.parentElement,t=e.getAttribute("data-avatar-color");e.classList.add(`usercolor${t}`);let s=e.getAttribute("data-avatar-letter");e.textContent=s}var We=class extends Sr{constructor(e,t){super(e);this._root=null,this._avatarUrl=null,this._avatarTitle=null,this._avatarLetter=null,this._size=t}_avatarUrlChanged(){return this.value.avatarUrl(this._size)!==this._avatarUrl?(this._avatarUrl=this.value.avatarUrl(this._size),!0):!1}_avatarTitleChanged(){return this.value.avatarTitle!==this._avatarTitle?(this._avatarTitle=this.value.avatarTitle,!0):!1}_avatarLetterChanged(){return this.value.avatarLetter!==this._avatarLetter?(this._avatarLetter=this.value.avatarLetter,!0):!1}mount(e){return this._avatarUrlChanged(),this._avatarLetterChanged(),this._avatarTitleChanged(),this._root=He(this.value,this._size),this.subscribeOnMount(e),this._root}root(){return this._root}update(e){if(this._avatarUrlChanged()){let s=`usercolor${e.avatarColorNumber}`;e.avatarUrl(this._size)?(this._root.replaceChild(La(e,this._size),this._root.firstChild),this._root.classList.remove(s)):(this._root.textContent=e.avatarLetter,this._root.classList.add(s))}let t=!!e.avatarUrl(this._size);if(this._avatarTitleChanged()&&t){let s=this._root.firstChild;s.tagName==="IMG"&&s.setAttribute("title",e.avatarTitle)}this._avatarLetterChanged()&&!t&&(this._root.textContent=e.avatarLetter)}};var Va=class extends y{render(e,t){let s={active:r=>r.isOpen,hidden:r=>r.hidden};return e.li({className:s},[e.a({href:t.url},[e.view(new We(t,32),{parentProvidesUpdates:!0}),e.div({className:"description"},[e.div({className:{name:!0,unread:r=>r.isUnread}},r=>r.name),e.div({className:{badge:!0,highlighted:r=>r.isHighlighted,hidden:r=>!r.badgeCount}},r=>r.badgeCount)])])])}update(e,t){super.update(e),this.updateSubViews(e,t)}};var qa;function he(i,e=void 0){return qa===void 0&&(qa=document.querySelector(".hydrogen")),qa?.classList.contains("legacy")?i.div({className:"spinner"},[i.div(),i.div(),i.div(),i.div()]):i.svg({className:Object.assign({spinner:!0},e),viewBox:"0 0 100 100"},i.circle({cx:"50%",cy:"50%",r:"45%",pathLength:"100"}))}var Ba=class extends y{render(e,t){let s={active:r=>r.isOpen,hidden:r=>r.hidden};return e.li({className:s},[e.a({href:t.url},[He(t,32),e.div({className:"description"},[e.div({className:"name"},t.name),e.map(r=>r.busy,r=>r?he(e):e.div({className:"badge highlighted"},"!"))])])])}};var fm=class extends y{render(e,t){let s=()=>{r.value="",r.blur(),n.blur(),t.clear()},r=e.input({type:"text",placeholder:t?.label,"aria-label":t?.label,autocomplete:t?.autocomplete,enterkeyhint:"search",name:t?.name,onInput:o=>t.set(o.target.value),onKeydown:o=>{(o.key==="Escape"||o.key==="Esc")&&s()},onFocus:()=>r.select()}),n=e.button({onClick:s,title:t.i18n`Clear`,"aria-label":t.i18n`Clear`});return e.div({className:"FilterField"},[r,n])}},Oa=class extends y{render(e,t){let s=o=>o.gridEnabled?o.i18n`Show single room`:o.i18n`Enable grid layout`,r=e.view(new $e({className:"RoomList",list:t.tileViewModels},o=>o.kind==="invite"?new Ba(o):new Va(o))),n=e.div({className:"utilities"},[e.a({className:"button-utility close-session",href:t.closeUrl,"aria-label":t.i18n`Back to account list`,title:t.i18n`Back to account list`}),e.view(new fm({i18n:t.i18n,label:t.i18n`Filter rooms`,name:"room-filter",autocomplete:!0,set:o=>{t.setFilter(o)&&(r.scrollTop=0)},clear:()=>t.clearFilter()})),e.button({onClick:()=>t.toggleGrid(),className:{"button-utility":!0,grid:!0,on:o=>o.gridEnabled},title:s,"aria-label":s}),e.a({className:"button-utility settings",href:t.settingsUrl,"aria-label":t.i18n`Settings`,title:t.i18n`Settings`})]);return e.div({className:"LeftPanel"},[n,r])}};var ns=class{constructor(e,t=null){this._view=e,this._target=null,this._arrangement=null,this._scroller=null,this._fakeRoot=null,this._trackingTemplateView=null,this._closeCallback=t}_getPopupContainer(){let e=this._target.closest(".hydrogen"),t=e.querySelector(".popupContainer");return t||(t=x.div({className:"popupContainer"}),e.appendChild(t)),t}trackInTemplateView(e){this._trackingTemplateView=e,this._trackingTemplateView.addSubView(this)}showRelativeTo(e,t=0){this._target=e,this._verticalPadding=t,this._scroller=pg(this._target),this._view.mount(),this._getPopupContainer().appendChild(this._popup),this._position(),this._scroller&&document.body.addEventListener("scroll",this,!0),setTimeout(()=>{document.body.addEventListener("click",this,!1)},10)}get isOpen(){return!!this._view}close(){this._view&&(this._view.unmount(),this._trackingTemplateView.removeSubView(this),this._scroller&&document.body.removeEventListener("scroll",this,!0),document.body.removeEventListener("click",this,!1),this._popup.remove(),this._view=null,this._closeCallback&&this._closeCallback())}get _popup(){return this._view.root()}handleEvent(e){e.type==="scroll"?this._position()||this.close():e.type==="click"&&this._onClick(e)}_onClick(){this.close()}_position(){let e=this._target.getBoundingClientRect(),t=this._popup.clientWidth,s=this._popup.clientHeight,r=(this._scroller?this._scroller:document.documentElement).getBoundingClientRect();if(e.top>r.bottom||e.left>r.right||e.bottom<r.top||e.right<r.left)return!1;if(r.bottom>=e.bottom+s)this._popup.style.top=`${e.bottom+this._verticalPadding}px`;else if(r.top<=e.top-s)this._popup.style.top=`${e.top-s-this._verticalPadding}px`;else return!1;if(r.right>=e.right+t)this._popup.style.left=`${e.left}px`;else if(r.left<=e.left-t)this._popup.style.left=`${e.right-t}px`;else return!1;return!0}root(){return this._fakeRoot}mount(){return this._fakeRoot=document.createComment("popup"),this._fakeRoot}unmount(){this.close()}update(){}};function pg(i){let e=i;do if(e=e.parentElement,e.scrollHeight>e.clientHeight){let s=window.getComputedStyle(e).getPropertyValue("overflow-y");if(s==="auto"||s==="scroll")return e}while(e!==document.body)}var X=class extends y{static option(e,t){return new gm(e,t)}constructor(e){super();this._options=e}render(e){return e.ul({className:"menu",role:"menu"},this._options.map(t=>t.toDOM(e)))}},gm=class{constructor(e,t){this.label=e,this.callback=t,this.icon=null,this.destructive=!1}setIcon(e){return this.icon=e,this}setDestructive(){return this.destructive=!0,this}toDOM(e){let t={destructive:this.destructive};return this.icon&&(t.icon=!0,t[this.icon]=!0),e.li({className:t},e.button({className:"menu-item",onClick:this.callback},this.label))}};var Na=class extends y{render(e){let t={GapView:!0,isLoading:s=>s.isLoading,isAtTop:s=>s.isAtTop};return e.li({className:t},[he(e),e.div(s=>s.isLoading?s.i18n`Loading more messages `:s.i18n`Not loading!`),e.if(s=>s.error,s=>s.strong(r=>r.error))])}onClick(){}};var Pa=class extends $e{constructor(e){let t={className:"Timeline_messageReactions",tagName:"div",list:e.reactions,onItemClick:s=>s.onClick()};super(t,s=>new _m(s))}},_m=class extends y{render(e,t){return e.button({className:{active:s=>s.isActive,pending:s=>s.isPending}},[t.key," ",s=>`${s.count}`])}onClick(){this.value.toggle()}};var ze=class extends y{constructor(e,t=!0,s="li"){super(e);this._menuPopup=null,this._tagName=s,this._interactive=t}render(e,t){let s=[this.renderMessageBody(e,t)];this._interactive&&s.push(e.button({className:"Timeline_messageOptions"},"\u22EF"));let r=e.el(this._tagName,{className:{Timeline_message:!0,own:t.isOwn,unsent:t.isUnsent,unverified:t.isUnverified,disabled:!this._interactive,continuation:o=>o.isContinuation}},s);e.mapSideEffect(o=>o.isContinuation,(o,a)=>{if(o&&a===!1)r.removeChild(r.querySelector(".Timeline_messageAvatar")),r.removeChild(r.querySelector(".Timeline_messageSender"));else if(!o){let l=x.a({href:t.memberPanelLink,className:"Timeline_messageAvatar"},[He(t,30)]),c=x.div({className:`Timeline_messageSender usercolor${t.avatarColorNumber}`},t.displayName);r.insertBefore(l,r.firstChild),r.insertBefore(c,r.firstChild)}});let n=null;return e.mapSideEffect(o=>o.reactions,o=>{o&&this._interactive&&!n?(n=new Pa(o),this.addSubView(n),r.appendChild(vt(n))):!o&&n&&(r.removeChild(n.root()),n.unmount(),this.removeSubView(n),n=null)}),r}onClick(e){e.target.className==="Timeline_messageOptions"&&this._toggleMenu(e.target)}_toggleMenu(e){if(this._menuPopup&&this._menuPopup.isOpen)this._menuPopup.close();else{let t=this.createMenuOptions(this.value);if(!t.length)return;this.root().classList.add("menuOpen");let s=()=>this.root().classList.remove("menuOpen");this._menuPopup=new ns(new X(t),s),this._menuPopup.trackInTemplateView(this),this._menuPopup.showRelativeTo(e,2)}}createMenuOptions(e){let t=[];return e.canReact&&e.shape!=="redacted"&&(t.push(new ym(e)),t.push(X.option(e.i18n`Reply`,()=>e.startReply()))),e.canAbortSending?t.push(X.option(e.i18n`Cancel`,()=>e.abortSending())):e.canRedact&&t.push(X.option(e.i18n`Delete`,()=>e.redact()).setDestructive()),t}renderMessageBody(){}},ym=class{constructor(e){this._vm=e}toDOM(e){let t=["\u{1F44D}","\u{1F44E}","\u{1F604}","\u{1F389}","\u{1F615}","\u2764\uFE0F","\u{1F680}","\u{1F440}"].map(r=>e.button({onClick:()=>this._vm.react(r)},r)),s=e.button({onClick:()=>{let r=prompt("Enter your reaction (emoji)");r&&this._vm.react(r)}},"\u2026");return e.li({className:"quick-reactions"},[...t,s])}};var Fa=class extends ze{renderMessageBody(e,t){let s=e.time({className:{hidden:!t.date}},t.date+" "+t.time),r=e.div({className:{Timeline_messageBody:!0,statusMessage:n=>n.shape==="message-status"}});return e.mapSideEffect(n=>n.body,n=>{for(;r.lastChild;)r.removeChild(r.lastChild);for(let o of n.parts)r.appendChild(wm(o));r.appendChild(s)}),r}};function fg(i){let e=i.items.map(s=>x.li(os(s))),t=i.startOffset;return t?x.ol({start:t},e):x.ul(e)}function gg(i){let e={src:i.src};return i.width&&(e.width=i.width),i.height&&(e.height=i.height),i.alt&&(e.alt=i.alt),i.title&&(e.title=i.title),x.img(e)}function _g(i){let e=`avatar size-12 usercolor${i.avatarColorNumber}`,t=x.div({class:e},Be(i.avatarInitials)),s=os(i.children);return s.unshift(t),x.a({class:"pill",href:i.href,rel:"noopener",target:"_blank"},s)}function yg(i){let e=[];if(i.head){let s=i.head.map(r=>x.th(os(r)));e.push(x.thead(x.tr(s)))}let t=[];for(let s of i.body){let r=s.map(n=>x.td(os(n)));t.push(x.tr(r))}return e.push(x.tbody(t)),x.table(e)}var wg={header:i=>x["h"+Math.min(6,i.level)](os(i.inlines)),codeblock:i=>x.pre(x.code(Be(i.text))),table:i=>yg(i),code:i=>x.code(Be(i.text)),text:i=>Be(i.text),link:i=>x.a({href:i.url,className:"link",target:"_blank",rel:"noopener"},os(i.inlines)),pill:_g,format:i=>x[i.format](os(i.children)),rule:()=>x.hr(),list:fg,image:gg,newline:()=>x.br()};function wm(i){let e=wg[i.type];return e?e(i):Be(`[unknown part type ${i.type}]`)}function os(i){return Array.from(i,wm)}var Er=class extends ze{renderMessageBody(e,t){let r=`padding-top: ${t.height/t.width*100}%;`;t.platform.isIE11&&(r=`height: ${t.height}px`);let n=[e.div({className:"spacer",style:r}),this.renderMedia(e,t),e.time(t.date+" "+t.time)];if(t.isPending){let o=e.div({className:{sendStatus:!0,hidden:l=>!l.sendStatus}},l=>l.sendStatus),a=e.progress({min:0,max:100,value:l=>l.uploadPercentage,className:{hidden:l=>!l.isUploading}});n.push(o,a)}return e.div({className:"Timeline_messageBody"},[e.div({className:"media",style:`max-width: ${t.width}px`},n),e.if(o=>o.error,o=>o.p({className:"error"},t.error))])}};var Ua=class extends Er{renderMedia(e,t){let s=e.img({loading:"lazy",src:r=>r.thumbnailUrl,alt:r=>r.label,title:r=>r.label,style:`max-width: ${t.width}px; max-height: ${t.height}px;`});return t.isPending?s:e.a({href:t.lightboxUrl},s)}};function Ns(i,e){return new Promise((t,s)=>{let r,n=a=>{r(),s(a.target.error)},o=()=>{r(),t()};r=()=>{i.removeEventListener(e,o),i.removeEventListener("error",n)},i.addEventListener(e,o),i.addEventListener("error",n)})}var Ka=class extends Er{renderMedia(e){let t=e.video({src:s=>s.videoUrl||`data:${s.mimeType},`,title:s=>s.label,controls:!0,preload:"none",poster:s=>s.thumbnailUrl,onPlay:this._onPlay.bind(this),style:s=>`max-width: ${s.width}px; max-height: ${s.height}px;${s.isPending?"z-index: -1":""}`});return t.addEventListener("error",this._onError.bind(this)),t}async _onPlay(e){let t=this.value;if(!t.videoUrl)try{let s=e.target;await t.loadVideo();let r=Ns(s,"loadeddata");s.load(),await r,s.play()}catch{}}_onError(e){let t=this.value,s=e.target,r=s.error;if(r instanceof window.MediaError&&r.code===4)if(!s.src.startsWith("data:"))t.setViewError(new Error(`this browser does not support videos of type ${t.mimeType}.`));else return;else t.setViewError(r)}};var ja=class extends ze{renderMessageBody(e,t){let s=[];return t.isPending?s.push(r=>r.label):s.push(e.button({className:"link",onClick:()=>t.download()},r=>r.label),e.time(t.date+" "+t.time)),e.p({className:"Timeline_messageBody statusMessage"},s)}};var $a=class extends ze{renderMessageBody(e,t){return e.p({className:"Timeline_messageBody statusMessage"},t.label)}};var Ha=class extends y{render(e){return e.li({className:"AnnouncementView"},e.div(t=>t.announcement))}onClick(){}};var Wa=class extends ze{renderMessageBody(e){return e.p({className:"Timeline_messageBody statusMessage"},t=>t.description)}createMenuOptions(e){let t=super.createMenuOptions(e);return e.isRedacting&&t.push(X.option(e.i18n`Cancel`,()=>e.abortPendingRedaction())),t}};function Li(i){switch(i.shape){case"gap":return Na;case"announcement":return Ha;case"message":case"message-status":return Fa;case"image":return Ua;case"video":return Ka;case"file":return ja;case"missing-attachment":return $a;case"redacted":return Wa}}function vm(i){return i.offsetTop+i.clientHeight}function bm(i,e,t=i.children.length-1){for(var s=t;s>=0;s--)if(i.children[s].offsetTop<e)return s;return 0}var Di=class extends y{constructor(){super(...arguments);this.anchoredBottom=0;this.stickToBottom=!0}render(e,t){requestAnimationFrame(()=>{this.restoreScrollPosition()}),this.tilesView=new Im(t.tiles,()=>this.restoreScrollPosition());let s=e.div({className:"Timeline"},[e.div({className:"Timeline_scroller bottom-aligned-scroll",onScroll:()=>this.onScroll()},e.view(this.tilesView)),e.button({className:{Timeline_jumpDown:!0,hidden:r=>!r.showJumpDown},title:"Jump down",onClick:()=>this.jumpDown()})]);return typeof ResizeObserver=="function"&&(this.resizeObserver=new ResizeObserver(()=>{this.restoreScrollPosition()}),this.resizeObserver.observe(s)),s}get scrollNode(){return this.root().firstElementChild}get tilesNode(){return this.tilesView.root()}jumpDown(){let{scrollNode:e}=this;this.stickToBottom=!0,e.scrollTop=e.scrollHeight}unmount(){super.unmount(),this.resizeObserver&&(this.resizeObserver.unobserve(this.root()),this.resizeObserver=void 0)}restoreScrollPosition(){let{scrollNode:e,tilesNode:t}=this,s=e.clientHeight-t.clientHeight;if(s>0){t.style.setProperty("margin-top",`${s}px`);let r=this.value.tiles.length;this.updateVisibleRange(0,r-1)}else if(t.style.removeProperty("margin-top"),this.stickToBottom)e.scrollTop=e.scrollHeight;else if(this.anchoredNode){let r=vm(this.anchoredNode);if(r!==this.anchoredBottom){let n=r-this.anchoredBottom;typeof e.scrollBy=="function"?e.scrollBy(0,n):e.scrollTop=e.scrollTop+n,this.anchoredBottom=r}}}onScroll(){let{scrollNode:e,tilesNode:t}=this,{scrollHeight:s,scrollTop:r,clientHeight:n}=e,o;if(this.stickToBottom=Math.abs(s-(r+n))<1,this.stickToBottom)o=this.value.tiles.length-1;else{let l=r+n,c=bm(t,l);this.anchoredNode=t.childNodes[c],this.anchoredBottom=vm(this.anchoredNode),o=c}let a=bm(t,r,o);this.updateVisibleRange(a,o)}updateVisibleRange(e,t){let s=this.tilesView.getChildInstanceByIndex(e),r=this.tilesView.getChildInstanceByIndex(t);this.value.setVisibleTileRange(s?.value,r?.value)}},Im=class extends $e{constructor(e,t){let s={list:e,onItemClick:(r,n)=>r.onClick(n)};super(s,r=>{let n=Li(r);if(n)return new n(r)});this.onChanged=t}onReset(){super.onReset(),this.onChanged()}onUpdate(e,t,s){if(s==="shape"){let r=Li(t),n=this.getChildInstanceByIndex(e);if(!r||!(n instanceof r)){super.recreateItem(e,t);return}}super.onUpdate(e,t,s),this.onChanged()}onAdd(e,t){super.onAdd(e,t),this.onChanged()}onRemove(e,t){super.onRemove(e,t),this.onChanged()}onMove(e,t,s){super.onMove(e,t,s),this.onChanged()}};var za=class extends y{render(e,t){return e.div({className:"TimelineLoadingView"},[he(e),e.div(t.isEncrypted?t.i18n`Loading encrypted messages`:t.i18n`Loading messages`)])}};var Ga=class extends y{constructor(e){super(e);this._input=null,this._attachmentPopup=null,this._focusInput=null,this._rafResizeHandle=void 0}render(e,t){this._input=e.textarea({enterkeyhint:"send",onKeydown:n=>this._onKeyDown(n),onInput:()=>{t.setInput(this._input.value),this._input.value?this._adjustHeight():this._clearHeight()},placeholder:t.isEncrypted?"Send an encrypted message\u2026":"Send a message\u2026",rows:"1"}),this._focusInput=()=>this._input.focus(),this.value.on("focus",this._focusInput);let s=e.map(n=>n.replyViewModel,(n,o)=>{let a=n&&Li(n);return a?o.div({className:"MessageComposer_replyPreview"},[o.span({className:"replying"},"Replying"),o.button({className:"cancel",onClick:()=>this._clearReplyingTo()},"Close"),o.view(new a(n,!1,"div"))]):null}),r=e.div({className:"MessageComposer_input"},[this._input,e.button({className:"sendFile",title:t.i18n`Pick attachment`,onClick:n=>this._toggleAttachmentMenu(n)},t.i18n`Send file`),e.button({className:"send",title:t.i18n`Send`,onClick:()=>this._trySend()},t.i18n`Send`)]);return e.div({className:{MessageComposer:!0,MessageComposer_canSend:n=>n.canSend}},[s,r])}unmount(){this._focusInput&&this.value.off("focus",this._focusInput),super.unmount()}_clearReplyingTo(){this.value.clearReplyingTo()}async _trySend(){this._input.focus();let{value:e}=this._input,t=()=>{this._input.value=e,this._adjustHeight()};this._input.value="",this._clearHeight();try{await this.value.sendMessage(e)||t()}catch(s){t(),console.error(s)}}_onKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this._trySend())}_toggleAttachmentMenu(e){if(this._attachmentPopup&&this._attachmentPopup.isOpen)this._attachmentPopup.close();else{let t=this.value;this._attachmentPopup=new ns(new X([X.option(t.i18n`Send video`,()=>t.sendVideo()).setIcon("video"),X.option(t.i18n`Send picture`,()=>t.sendPicture()).setIcon("picture"),X.option(t.i18n`Send file`,()=>t.sendFile()).setIcon("file")])),this._attachmentPopup.trackInTemplateView(this),this._attachmentPopup.showRelativeTo(e.target,12)}}_adjustHeight(){this._rafResizeHandle||(this._rafResizeHandle=window.requestAnimationFrame(()=>{let e=this._input.scrollHeight;this._input.style.height=`${e}px`,this._rafResizeHandle=void 0}))}_clearHeight(){this._input.style.removeProperty("height")}};var Qa=class extends y{render(e){return e.div({className:"RoomArchivedView"},e.h3(t=>t.description))}};var Ps=class extends y{constructor(e){super(e);this._optionsPopup=null}render(e,t){let s;return t.composerViewModel.kind==="composer"?s=new Ga(t.composerViewModel):t.composerViewModel.kind==="archived"&&(s=new Qa(t.composerViewModel)),e.main({className:"RoomView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close room`}),e.view(new We(t,32)),e.div({className:"room-description"},[e.h2(r=>r.name)]),e.button({className:"button-utility room-options","aria-label":t.i18n`Room options`,onClick:r=>this._toggleOptionsMenu(r)})]),e.div({className:"RoomView_body"},[e.div({className:"RoomView_error"},r=>r.error),e.mapView(r=>r.timelineViewModel,r=>r?new Di(r):new za(t)),e.view(s)])])}_toggleOptionsMenu(e){if(this._optionsPopup&&this._optionsPopup.isOpen)this._optionsPopup.close();else{let t=this.value,s=[];if(s.push(X.option(t.i18n`Room details`,()=>t.openDetailsPanel())),t.canLeave&&s.push(X.option(t.i18n`Leave room`,()=>this._confirmToLeaveRoom()).setDestructive()),t.canForget&&s.push(X.option(t.i18n`Forget room`,()=>t.forgetRoom()).setDestructive()),t.canRejoin&&s.push(X.option(t.i18n`Rejoin room`,()=>t.rejoinRoom())),!s.length)return;this._optionsPopup=new ns(new X(s)),this._optionsPopup.trackInTemplateView(this),this._optionsPopup.showRelativeTo(e.target,10)}}_confirmToLeaveRoom(){confirm(this.value.i18n`Are you sure you want to leave "${this.value.name}"?`)&&this.value.leaveRoom()}};var Ya=class extends y{render(e,t){return e.main({className:"UnknownRoomView middle"},e.div([e.h2([t.i18n`You are currently not in ${t.roomIdOrAlias}.`,e.br(),t.i18n`Want to join it?`]),e.button({className:"button-action primary",onClick:()=>t.join(),disabled:s=>s.busy},t.i18n`Join room`),e.if(s=>s.error,s=>s.p({className:"error"},t.error))]))}};var xr=class extends y{render(e,t){let s=[];t.isDirectMessage&&s.push(He(t,128,"InviteView_dmAvatar"));let r;return t.isDirectMessage?r=[e.strong(t.name),` (${t.inviter?.id}) wants to chat with you.`]:t.inviter?r=[He(t.inviter,24),e.strong(t.inviter.name),` (${t.inviter.id}) invited you.`]:r="You were invited to join.",s.push(e.p({className:"InviteView_inviter"},r)),t.isDirectMessage||s.push(e.div({className:"InviteView_roomProfile"},[He(t,64,"InviteView_roomAvatar"),e.h3(t.name),e.p({className:"InviteView_roomDescription"},t.roomDescription)])),e.main({className:"InviteView middle"},[e.div({className:"RoomHeader middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close invite`}),He(t,32),e.div({className:"room-description"},[e.h2(n=>n.name)])]),e.if(n=>n.error,n=>n.div({className:"RoomView_error"},o=>o.error)),e.div({className:"InviteView_body"},[e.div({className:"InviteView_invite"},[...s,e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary",disabled:n=>n.busy,onClick:()=>t.accept()},t.i18n`Accept`)),e.div({className:"InviteView_buttonRow"},e.button({className:"button-action primary destructive",disabled:n=>n.busy,onClick:()=>t.reject()},t.i18n`Reject`))])])])}};var Ja=class extends y{render(e,t){let s=e.a({href:t.closeUrl,title:t.i18n`Close`,className:"close"}),r=e.div({role:"img","aria-label":l=>l.name,title:l=>l.name,className:{picture:!0,hidden:l=>!l.imageUrl},style:l=>`background-image: url('${l.imageUrl}'); max-width: ${l.imageWidth}px; max-height: ${l.imageHeight}px;`}),n=e.div({className:{loading:!0,hidden:l=>!!l.imageUrl}},[he(e),e.div(t.i18n`Loading image`)]),o=e.div({className:"details"},[e.strong(l=>l.name),e.br(),"uploaded by ",e.strong(l=>l.sender),l=>` at ${l.time} on ${l.date}.`]),a=e.div({role:"dialog",className:"lightbox",onClick:l=>this.clickToClose(l),onKeydown:l=>this.closeOnEscKey(l)},[r,n,o,s]);return vg(e,a),a}clickToClose(e){e.target===this.root()&&this.value.close()}closeOnEscKey(e){(e.key==="Escape"||e.key==="Esc")&&this.value.close()}};function vg(i,e){let t=bg(e),s=t[0],r=t[t.length-1];i.addEventListener(e,"keydown",n=>{n.key==="Tab"&&(n.shiftKey?document.activeElement===s&&(r.focus(),n.preventDefault()):document.activeElement===r&&(s.focus(),n.preventDefault()))},!0),Promise.resolve().then(()=>{s.focus()})}function bg(i){return i.querySelectorAll("a[href], button, textarea, input, select")}var ot=class{constructor(e,t=void 0){typeof e=="function"&&!t&&(t=e,e=null),this._root=t?t(x,e):this.render(x,e)}mount(){return this._root}root(){return this._root}unmount(){}update(){}};var Xa=class extends y{render(e,t){return e.div({className:{SessionStatusView:!0,hidden:s=>!s.isShown}},[he(e,{hidden:s=>!s.isWaiting}),e.p(s=>s.statusLabel),e.if(s=>s.isConnectNowShown,s=>s.button({className:"link",onClick:()=>t.connectNow()},"Retry now")),e.if(s=>s.isSecretStorageShown,s=>s.a({href:t.setupSessionBackupUrl},"Go to settings")),e.if(s=>s.canDismiss,s=>s.div({className:"end"},s.button({className:"dismiss",onClick:()=>t.dismiss()})))])}};var Za=class extends y{render(e,t){let s=[];for(let r=0;r<t.height*t.width;r+=1)s.push(e.div({onClick:()=>t.focusTile(r),onFocusin:()=>t.focusTile(r),className:{container:!0,[`tile${r}`]:!0,focused:n=>n.focusIndex===r}},e.mapView(n=>n.roomViewModelAt(r),n=>n?n.kind==="invite"?new xr(n):new Ps(n):new ot(o=>o.div({className:"room-placeholder"},[o.h2({className:"focused"},t.i18n`Select a room on the left`),o.h2({className:"unfocused"},t.i18n`Click to select this tile`)])))));return s.push(e.div({className:r=>`focus-ring tile${r.focusIndex}`})),e.div({className:"RoomGridView middle layout3x2"},s)}};var Tr=class extends y{render(e,t){return e.mapView(s=>s.status,s=>{switch(s){case"Enabled":return new y(t,Ig);case"SetupKey":return new y(t,Sg);case"SetupPhrase":return new y(t,Eg);case"Pending":return new ot(t,r=>r.p(t.i18n`Waiting to go online`))}})}};function Ig(i,e){let t=[i.p([e.i18n`Session backup is enabled, using backup version ${e.backupVersion}. `,i.button({onClick:()=>e.disable()},e.i18n`Disable`)])];return e.dehydratedDeviceId&&t.push(i.p(e.i18n`A dehydrated device id was set up with id ${e.dehydratedDeviceId} which you can use during your next login with your secret storage key.`)),i.div(t)}function Sg(i,e){let t=i.button({className:"link",onClick:()=>e.showPhraseSetup()},e.i18n`use a security phrase`);return i.div([i.p(e.i18n`Enter your secret storage security key below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security key is a code of 12 groups of 4 characters separated by a space that Element created for you when setting up security.`),Em(i),Sm(i,e,e.i18n`Security key`,(s,r)=>e.enterSecurityKey(s,r)),i.p([e.i18n`Alternatively, you can `,t,e.i18n` if you have one.`])])}function Eg(i,e){let t=i.button({className:"link",onClick:()=>e.showKeySetup()},e.i18n`use your security key`);return i.div([i.p(e.i18n`Enter your secret storage security phrase below to ${e.purpose}, which will enable you to decrypt messages received before you logged into this session. The security phrase is a freeform secret phrase you optionally chose when setting up security in Element. It is different from your password to login, unless you chose to set them to the same value.`),Em(i),Sm(i,e,e.i18n`Security phrase`,(s,r)=>e.enterSecurityPhrase(s,r)),i.p([e.i18n`You can also `,t,e.i18n`.`])])}function Sm(i,e,t,s){let r,n=()=>s(o.value,r?.checked||!1),o=i.input({type:"password",disabled:l=>l.isBusy,placeholder:t}),a=[i.p([o,i.button({disabled:l=>l.isBusy,onClick:n},e.decryptAction)])];if(e.offerDehydratedDeviceSetup){r=i.input({type:"checkbox",id:"enable-dehydrated-device"});let l=i.a({href:"https://github.com/uhoreg/matrix-doc/blob/dehydration/proposals/2697-device-dehydration.md",target:"_blank",rel:"noopener"},"more info");a.push(i.p([r,i.label({for:r.id},[e.i18n`Back up my device as well (`,l,")"])]))}return i.div({className:"row"},[i.div({className:"label"},t),i.div({className:"content"},a)])}function Em(i){return i.if(e=>e.error,(e,t)=>e.div([e.p({className:"error"},s=>s.i18n`Could not enable session backup: ${s.error}.`),e.p(t.i18n`Try double checking that you did not mix up your security key, security phrase and login password as explained above.`)]))}var el=class extends y{render(e,t){let s=t.version;t.showUpdateButton&&(s=e.span([t.version,e.button({onClick:()=>t.checkForUpdate()},t.i18n`Check for updates`)]));let r=(o,a,l,c="")=>o.div({className:`row ${c}`},[o.div({className:"label"},a),o.div({className:"content"},l)]),n=[];return n.push(e.h3("Session"),r(e,t.i18n`User ID`,t.userId),r(e,t.i18n`Session ID`,t.deviceId,"code"),r(e,t.i18n`Session key`,t.fingerprintKey,"code"),r(e,"",e.button({onClick:()=>{confirm(t.i18n`Are you sure you want to log out?`)&&t.logout()},disabled:o=>o.isLoggingOut},t.i18n`Log out`))),n.push(e.h3("Session Backup"),e.view(new Tr(t.sessionBackupViewModel))),n.push(e.h3("Notifications"),e.map(o=>o.pushNotifications.supported,(o,a)=>{if(o===null)return a.p(t.i18n`Loading`);if(o){let l=u=>u.pushNotifications.enabled?u.i18n`Push notifications are enabled`:u.i18n`Push notifications are disabled`,c=u=>u.pushNotifications.enabled?u.i18n`Disable`:u.i18n`Enable`;return r(a,l,a.button({onClick:()=>t.togglePushNotifications(),disabled:u=>u.pushNotifications.updating},c))}else return a.p(t.i18n`Push notifications are not supported on this browser`)}),e.if(o=>o.pushNotifications.supported&&o.pushNotifications.enabled,o=>o.div([o.p(["If you think push notifications are not being delivered, ",o.button({className:"link",onClick:()=>t.checkPushEnabledOnServer()},"check")," if they got disabled on the server"]),o.map(a=>a.pushNotifications.enabledOnServer,(a,l)=>{if(a===!0)return l.p("Push notifications are still enabled on the server, so everything should be working. Sometimes notifications can get dropped if they can't be delivered within a given time.");if(a===!1)return l.p("Push notifications have been disabled on the server, likely due to a bug. Please re-enable them by clicking Disable and then Enable again above.")}),o.map(a=>a.pushNotifications.serverError,(a,l)=>{if(a)return l.p("Couldn't not check on server: "+a.message)})]))),n.push(e.h3("Preferences"),r(e,t.i18n`Scale down images when sending`,this._imageCompressionRange(e,t))),n.push(e.h3("Application"),r(e,t.i18n`Version`,s),r(e,t.i18n`Storage usage`,o=>`${o.storageUsage} / ${o.storageQuota}`),r(e,t.i18n`Debug logs`,e.button({onClick:()=>t.exportLogs()},"Export")),e.p(["Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited, the usernames of other users and the names of files you send. They do not contain messages. For more information, review our ",e.a({href:"https://element.io/privacy",target:"_blank",rel:"noopener"},"privacy policy"),"."])),e.main({className:"Settings middle"},[e.div({className:"middle-header"},[e.a({className:"button-utility close-middle",href:t.closeUrl,title:t.i18n`Close settings`}),e.h2("Settings")]),e.div({className:"SettingsBody"},n)])}_imageCompressionRange(e,t){let s=32,r=Math.ceil(t.minSentImageSizeLimit/s)*s,n=(Math.floor(t.maxSentImageSizeLimit/s)+1)*s,o=a=>t.setSentImageSizeLimit(parseInt(a.target.value,10));return[e.input({type:"range",step:s,min:r,max:n,value:a=>a.sentImageSizeLimit||n,onInput:o,onChange:o})," ",e.output(a=>a.sentImageSizeLimit?a.i18n`resize to ${a.sentImageSizeLimit}px`:a.i18n`no resizing`)]}};var tl=class extends y{render(e,t){let s=()=>t.isEncrypted?t.i18n`On`:t.i18n`Off`;return e.div({className:"RoomDetailsView"},[e.div({className:"RoomDetailsView_avatar"},[e.view(new We(t,52)),e.mapView(r=>r.isEncrypted,r=>new xm(r))]),e.div({className:"RoomDetailsView_name"},[e.h2(r=>r.name)]),this._createRoomAliasDisplay(t),e.div({className:"RoomDetailsView_rows"},[this._createRightPanelButtonRow(e,t.i18n`People`,{MemberCount:!0},r=>r.memberCount,()=>t.openPanel("members")),this._createRightPanelRow(e,t.i18n`Encryption`,{EncryptionStatus:!0},s)])])}_createRoomAliasDisplay(e){return e.canonicalAlias?x.div({className:"RoomDetailsView_id"},[e.canonicalAlias]):""}_createRightPanelRow(e,t,s,r){let n=wt({RoomDetailsView_label:!0,...s});return e.div({className:"RoomDetailsView_row"},[e.div({className:n},[t]),e.div({className:"RoomDetailsView_value"},r)])}_createRightPanelButtonRow(e,t,s,r,n){let o=wt({RoomDetailsView_label:!0,...s});return e.button({className:"RoomDetailsView_row",onClick:n},[e.div({className:o},[t]),e.div({className:"RoomDetailsView_value"},r)])}},xm=class extends y{render(e,t){return e.div({className:"EncryptionIconView"},[e.div({className:t?"EncryptionIconView_encrypted":"EncryptionIconView_unencrypted"})])}};var sl=class{constructor(e,t){this.start=e;this.end=t}get length(){return this.end-this.start}contains(e){return e.start>=this.start&&e.end<=this.end}containsIndex(e){return e>=this.start&&e<this.end}toLocalIndex(e){return e-this.start}intersects(e){return e.start<this.end&&this.start<e.end}forEachInIterator(e,t){let s=0;for(s=0;s<this.start;s+=1)e.next();for(s=0;s<this.length;s+=1){let r=e.next();if(r.done)break;t(r.value,this.start+s)}}[Symbol.iterator](){return new Tm(this)}reverseIterable(){return new Rm(this)}clampIndex(e,t=this.end-1){return Math.min(Math.max(this.start,e),t)}getIndexZone(e){return e<this.start?Lt.Before:e<this.end?Lt.Inside:Lt.After}},Lt=(s=>(s[s.Before=1]="Before",s[s.Inside=2]="Inside",s[s.After=3]="After",s))(Lt||{}),Tm=class{constructor(e){this.range=e;this.idx=e.start-1}next(){return this.idx<this.range.end-1?(this.idx+=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}},Rm=class{constructor(e){this.range=e;this.idx=e.end}[Symbol.iterator](){return this}next(){return this.idx>this.range.start?(this.idx-=1,{value:this.idx,done:!1}):{value:void 0,done:!0}}};function xg(i,e){let t=0;for(;t<e;)if(t+=1,i.next().done)return!1;return!0}function Vi(i,e){if(xg(i,e)){let t=i.next();if(!t.done)return t.value}}var as=(n=>(n[n.Move=0]="Move",n[n.Add=1]="Add",n[n.Remove=2]="Remove",n[n.RemoveAndAdd=3]="RemoveAndAdd",n[n.UpdateRange=4]="UpdateRange",n))(as||{}),ls=class extends sl{constructor(e,t,s,r=t-e){super(e,t);this._totalLength=s;this._viewportItemCount=r}expand(e){if(this.length===0)return this;let t=Math.max(0,this.start-e),s=Math.min(this.totalLength,this.end+e);return new ls(t,s,this.totalLength,this._viewportItemCount)}get totalLength(){return this._totalLength}get viewportItemCount(){return this._viewportItemCount}static fromViewport(e,t,s,r){let n=Math.min(Math.max(0,Math.floor(r/t)),e),o=e-n,a=s!==0?Math.ceil(s/t):0,l=Math.min(a,o);return new ls(n,n+l,e,a)}queryAdd(e,t,s){let r=this.viewportItemCount>this.length?this.end:this.end-1;if(e<=r){let n=this.clampIndex(e,r),o=n===e?t:Vi(s[Symbol.iterator](),n);return this.createAddResult(n,o)}else return{type:4,newRange:this.deriveRange(1,0)}}queryRemove(e,t){if(e<this.end){let s=this.clampIndex(e);return this.createRemoveResult(s,t)}else return{type:4,newRange:this.deriveRange(-1,0)}}queryMove(e,t,s,r){let n=this.getIndexZone(e),o=this.getIndexZone(t);if(n===o){if(n===Lt.Before||n===Lt.After)return;if(n===Lt.Inside)return{type:0,fromIdx:e,toIdx:t}}else{let a=this.clampIndex(t),l=this.clampIndex(e),c=a===t?s:Vi(r[Symbol.iterator](),a);return{type:3,removeIdx:l,addIdx:a,value:c}}}createAddResult(e,t){if(this.viewportItemCount>this.length)return{type:1,addIdx:e,value:t,newRange:this.deriveRange(1,1)};{let s=this.clampIndex(Number.MAX_SAFE_INTEGER);return{type:3,removeIdx:s,addIdx:e,value:t,newRange:this.deriveRange(1,0)}}}createRemoveResult(e,t){if(this.end<this.totalLength){let s=this.clampIndex(Number.MAX_SAFE_INTEGER),r=Vi(t[Symbol.iterator](),s);return{type:3,removeIdx:e,value:r,addIdx:s,newRange:this.deriveRange(-1,0)}}else if(this.start!==0){let s=this.deriveRange(-1,0,1),r=s.start,n=Vi(t[Symbol.iterator](),r);return{type:3,removeIdx:e,value:n,addIdx:r,newRange:s}}else return{type:2,removeIdx:e,newRange:this.deriveRange(-1,0)}}deriveRange(e,t,s=0){let r=this.start-s,n=this.totalLength+e,o=Math.min(Math.max(r,this.end-s+t),n);return new ls(r,o,n,this.viewportItemCount)}};var rl=class extends $e{constructor({itemHeight:e,overflowItems:t=20,...s},r){super(s,r);this.itemHeight=e,this.overflowItems=t}handleEvent(e){e.type==="scroll"?this.handleScroll():super.handleEvent(e)}handleScroll(){let e=this._getVisibleRange();if(e.length!==0&&!this.renderRange.contains(e)){let t=this.renderRange;this.renderRange=e.expand(this.overflowItems),this.renderUpdate(t,this.renderRange)}}async loadList(){if(await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>requestAnimationFrame(t)),!this._list)return;this._subscription=this._list.subscribe(this);let e=this._getVisibleRange();this.renderRange=e.expand(this.overflowItems),this._childInstances=[],this.reRenderFullRange(this.renderRange)}_getVisibleRange(){let{clientHeight:e,scrollTop:t}=this.root();if(e===0)throw new Error("LazyListView height is 0");return ls.fromViewport(this._list.length,this.itemHeight,e,t)}reRenderFullRange(e){pm(this._listElement);let t=document.createDocumentFragment(),s=this._list[Symbol.iterator]();this._childInstances.length=0,e.forEachInIterator(s,r=>{let n=this._childCreator(r);this._childInstances.push(n),t.appendChild(vt(n,this._mountArgs))}),this._listElement.appendChild(t),this.adjustPadding(e)}renderUpdate(e,t){if(t.intersects(e)){for(let s of e.reverseIterable())if(!t.containsIndex(s)){let r=s-e.start;this.removeChild(r)}t.forEachInIterator(this._list[Symbol.iterator](),(s,r)=>{if(!e.containsIndex(r)){let n=r-t.start;this.addChild(n,s)}}),this.adjustPadding(t)}else this.reRenderFullRange(t)}adjustPadding(e){let t=e.start*this.itemHeight,s=(e.totalLength-e.end)*this.itemHeight,r=this._listElement.style;r.paddingTop=`${t}px`,r.paddingBottom=`${s}px`}mount(){let e=super.mount();return this.scrollContainer=x.div({className:"LazyListParent"},e),this.scrollContainer.addEventListener("scroll",this),this.scrollContainer}unmount(){this.root().removeEventListener("scroll",this),this.scrollContainer=void 0,super.unmount()}root(){return this.scrollContainer}get _listElement(){return super.root()}onAdd(e,t){let s=this.renderRange.queryAdd(e,t,this._list);this.applyRemoveAddResult(s)}onRemove(e,t){let s=this.renderRange.queryRemove(e,this._list);this.applyRemoveAddResult(s)}onMove(e,t,s){let r=this.renderRange.queryMove(e,t,s,this._list);r&&(r.type===as.Move?this.moveChild(this.renderRange.toLocalIndex(r.fromIdx),this.renderRange.toLocalIndex(r.toIdx)):this.applyRemoveAddResult(r))}onUpdate(e,t,s){this.renderRange.containsIndex(e)&&this.updateChild(this.renderRange.toLocalIndex(e),t,s)}applyRemoveAddResult(e){(e.type===as.Remove||e.type===as.RemoveAndAdd)&&this.removeChild(this.renderRange.toLocalIndex(e.removeIdx)),e.newRange&&(this.renderRange=e.newRange,this.adjustPadding(this.renderRange)),(e.type===as.Add||e.type===as.RemoveAndAdd)&&this.addChild(this.renderRange.toLocalIndex(e.addIdx),e.value)}};var il=class extends y{render(e,t){return e.li({className:"MemberTileView"},e.a({href:t.detailsUrl},[e.view(new We(t,32)),e.div({className:"MemberTileView_name"},s=>s.name)]))}};var nl=class extends rl{constructor(e){super({list:e.memberTileViewModels,className:"MemberListView",itemHeight:40},t=>new il(t))}};var ol=class extends y{render(e){return e.div({className:"LoadingView"},[he(e),"Loading"])}};var al=class extends y{render(e,t){return e.div({className:"MemberDetailsView"},[e.view(new We(t,128)),e.div({className:"MemberDetailsView_name"},e.h2(s=>s.name)),e.div({className:"MemberDetailsView_id"},t.userId),this._createSection(e,t.i18n`Role`,s=>s.role),this._createSection(e,t.i18n`Security`,t.isEncrypted?t.i18n`Messages in this room are end-to-end encrypted.`:t.i18n`Messages in this room are not end-to-end encrypted.`),this._createOptions(e,t)])}_createSection(e,t,s){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t),e.div({className:"MemberDetailsView_value"},s)])}_createOptions(e,t){return e.div({className:"MemberDetailsView_section"},[e.div({className:"MemberDetailsView_label"},t.i18n`Options`),e.div({className:"MemberDetailsView_options"},[e.a({href:t.linkToUser,target:"_blank",rel:"noopener"},t.i18n`Open Link to User`)])])}};var ll=class extends y{render(e){return e.div({className:"RightPanelView"},[e.ifView(t=>t.activeViewModel,t=>new km(t)),e.mapView(t=>t.activeViewModel,t=>this._viewFromType(t))])}_viewFromType(e){switch(e?.type){case"room-details":return new tl(e);case"member-list":return new nl(e);case"member-details":return new al(e);default:return new ol}}},km=class extends y{render(e,t){return e.div({className:"RightPanelView_buttons"},[e.button({className:{back:!0,"button-utility":!0,hide:!t.activeViewModel.shouldShowBackButton},onClick:()=>t.showPreviousPanel()}),e.button({className:"close button-utility",onClick:()=>t.closePanel()})])}};var qi=class extends y{render(e,t){return e.div({className:{SessionView:!0,"middle-shown":s=>!!s.activeMiddleViewModel,"right-shown":s=>!!s.rightPanelViewModel}},[e.view(new Xa(t.sessionStatusViewModel)),e.view(new Oa(t.leftPanelViewModel)),e.mapView(s=>s.activeMiddleViewModel,()=>t.roomGridViewModel?new Za(t.roomGridViewModel):t.settingsViewModel?new el(t.settingsViewModel):t.currentRoomViewModel?t.currentRoomViewModel.kind==="invite"?new xr(t.currentRoomViewModel):t.currentRoomViewModel.kind==="room"?new Ps(t.currentRoomViewModel):new Ya(t.currentRoomViewModel):new ot(s=>s.div({className:"room-placeholder"},s.h2(t.i18n`Choose a room on the left side.`)))),e.mapView(s=>s.lightboxViewModel,s=>s?new Ja(s):null),e.mapView(s=>s.rightPanelViewModel,s=>s?new ll(s):null)])}};function Bi(i){return DEFINE_GLOBAL_HASH?i.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web/releases/tag/v0.2.22"},`Hydrogen v0.2.22 (${DEFINE_GLOBAL_HASH}) on Github`):i.a({target:"_blank",href:"https://github.com/vector-im/hydrogen-web"},"Hydrogen on Github")}var cl=class extends y{render(e,t){let s=o=>!!o.isBusy,r=e.input({id:"username",type:"text",placeholder:t.i18n`Username`,disabled:s}),n=e.input({id:"password",type:"password",placeholder:t.i18n`Password`,disabled:s});return e.div({className:"PasswordLoginView form"},[e.if(o=>o.error,o=>o.div({className:"error"},a=>a.error)),e.form({onSubmit:o=>{o.preventDefault(),t.login(r.value,n.value)}},[e.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage))),e.div({className:"form-row"},[e.label({for:"username"},t.i18n`Username`),r]),e.div({className:"form-row"},[e.label({for:"password"},t.i18n`Password`),n]),e.div({className:"button-row"},[e.button({className:"button-action primary",type:"submit",disabled:s},t.i18n`Log In`)])])])}};var ul=class extends y{render(e,t){return e.div({className:"Settings"},[e.h3(t.i18n`Restore your encrypted history?`),e.ifView(s=>s.decryptDehydratedDeviceViewModel,s=>new Tr(s.decryptDehydratedDeviceViewModel)),e.map(s=>s.deviceDecrypted,(s,r)=>s?r.p(t.i18n`That worked out, you're good to go!`):r.p(t.i18n`This will claim the dehydrated device ${t.dehydratedDeviceId}, and will set up a new one.`)),e.div({className:"button-row"},[e.button({className:"button-action primary",onClick:()=>{t.finish()},type:"button"},s=>s.deviceDecrypted?s.i18n`Continue`:s.i18n`Continue without restoring`)])])}};var bt=class extends y{render(e){let t=e.if(r=>r.hasError,(r,n)=>r.button({onClick:()=>n.exportLogs()},n.i18n`Export logs`)),s=e.if(r=>r.hasError,(r,n)=>r.button({onClick:()=>n.logout()},n.i18n`Log out`));return e.div({className:"SessionLoadStatusView"},[e.p({className:"status"},[he(e,{hidden:r=>!r.loading}),e.p(r=>r.loadLabel),t,s]),e.ifView(r=>r.accountSetupViewModel,r=>new ul(r.accountSetupViewModel))])}};var dl=class extends y{render(e){return e.div({className:"CompleteSSOView"},[e.p({className:"CompleteSSOView_title"},"Finishing up your SSO Login"),e.if(t=>t.errorMessage,(t,s)=>t.p({className:"error"},s.i18n(s.errorMessage))),e.mapView(t=>t.loadViewModel,t=>t?new bt(t):null)])}};var ml=class extends y{render(e,t){let s=r=>r.isBusy;return e.div({className:"PreSessionScreen"},[e.button({className:"button-utility LoginView_back",onClick:()=>t.goBack(),disabled:s}),e.div({className:"logo"}),e.h1([t.i18n`Sign In`]),e.mapView(r=>r.completeSSOLoginViewModel,r=>r?new dl(r):null),e.if(r=>r.showHomeserver,(r,n)=>r.div({className:"LoginView_sso form form-row"},[r.label({for:"homeserver"},n.i18n`Homeserver`),r.input({id:"homeserver",type:"text",placeholder:n.i18n`Your matrix homeserver`,value:n.homeserver,disabled:s,onInput:o=>n.setHomeserver(o.target.value),onChange:()=>n.queryHomeserver()}),r.p({className:{LoginView_forwardInfo:!0,hidden:o=>!o.resolvedHomeserver}},o=>o.i18n`You will connect to ${o.resolvedHomeserver}.`),r.if(o=>o.errorMessage,(o,a)=>o.p({className:"error"},a.i18n(a.errorMessage)))])),e.if(r=>r.isFetchingLoginOptions,r=>r.div({className:"LoginView_query-spinner"},[he(r),r.p("Fetching available login options...")])),e.mapView(r=>r.passwordLoginViewModel,r=>r?new cl(r):null),e.if(r=>r.passwordLoginViewModel&&r.startSSOLoginViewModel,r=>r.p({className:"LoginView_separator"},t.i18n`or`)),e.mapView(r=>r.startSSOLoginViewModel,r=>r?new Mm(r):null),e.mapView(r=>r.loadViewModel,r=>r?new bt(r):null),e.p(Bi(e))])}},Mm=class extends y{render(e,t){return e.div({className:"StartSSOLoginView"},e.button({className:"StartSSOLoginView_button button-action secondary",type:"button",onClick:()=>t.startSSOLogin(),disabled:s=>s.isBusy},t.i18n`Log in with SSO`))}};var hl=class extends y{render(e,t){return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionLoadView"},[e.view(new bt(t))]),e.div({className:{"button-row":!0,hidden:s=>s.loading}},e.a({className:"button-action primary",href:t.backUrl},t.i18n`Go back`))])}};var Am=class extends y{_onDeleteClick(){confirm("Are you sure?")&&this.value.delete()}_onClearClick(){confirm("Are you sure?")&&this.value.clear()}render(e,t){return e.li([e.a({className:"session-info",href:t.openUrl},[e.div({className:`avatar usercolor${t.avatarColorNumber}`},s=>s.avatarInitials),e.div({className:"user-id"},s=>s.label)])])}},pl=class extends y{render(e,t){let s=new $e({list:t.sessions,parentProvidesUpdates:!1},r=>new Am(r));return e.div({className:"PreSessionScreen"},[e.div({className:"logo"}),e.div({className:"SessionPickerView"},[e.h1(["Continue as \u2026"]),e.view(s),e.div({className:"button-row"},[e.a({className:"button-action primary",href:t.cancelUrl},t.i18n`Sign In`)]),e.ifView(r=>r.loadViewModel,()=>new bt(t.loadViewModel)),e.p(Bi(e))])])}};var Oi=class extends y{render(e,t){return e.mapView(s=>s.activeSection,s=>{switch(s){case"error":return new ot(r=>r.div({className:"StatusView"},[r.h1("Something went wrong"),r.p(t.errorText)]));case"session":return new qi(t.sessionViewModel);case"login":return new ml(t.loginViewModel);case"picker":return new pl(t.sessionPickerViewModel);case"redirecting":return new ot(r=>r.p("Redirecting..."));case"loading":return new hl(t.sessionLoadViewModel);default:throw new Error(`Unknown section: ${t.activeSection}`)}})}};var Cm=class{constructor(e){this._reject=null,this._handle=null,this._promise=new Promise((t,s)=>{this._reject=s,this._handle=setTimeout(()=>{this._reject=null,t()},e)})}elapsed(){return this._promise}abort(){this._reject&&(this._reject(new j),clearTimeout(this._handle),this._handle=null,this._reject=null)}dispose(){this.abort()}},Lm=class{constructor(e,t){this._handle=setInterval(t,e)}dispose(){this._handle&&(clearInterval(this._handle),this._handle=null)}},Dm=class{constructor(){this._start=window.performance.now()}measure(){return window.performance.now()-this._start}},fl=class{createMeasure(){return new Dm}createTimeout(e){return new Cm(e)}createInterval(e,t){return new Lm(t,e)}now(){return Date.now()}};var gl=class{constructor(){this._waitingForReply=new Map,this._messageIdCounter=0,this._navigation=null,this._registration=null,this._registrationPromise=null,this._currentController=null,this.haltRequests=!1}setNavigation(e){this._navigation=e}registerAndStart(e){this._registrationPromise=(async()=>{navigator.serviceWorker.addEventListener("message",this),navigator.serviceWorker.addEventListener("controllerchange",this),this._registration=await navigator.serviceWorker.register(e),await navigator.serviceWorker.ready,this._currentController=navigator.serviceWorker.controller,this._registration.addEventListener("updatefound",this),this._registrationPromise=null,this._registration.waiting&&this._registration.active&&this._proposeUpdate(),console.log("Service Worker registered")})()}_onMessage(e){let{data:t}=e,s=t.replyTo;if(s){let r=this._waitingForReply.get(s);r&&(this._waitingForReply.delete(s),r(t.payload))}if(t.type==="hasSessionOpen"){let r=this._navigation.observe("session").get()===t.payload.sessionId;e.source.postMessage({replyTo:t.id,payload:r})}else if(t.type==="hasRoomOpen"){let r=this._navigation.observe("session").get()===t.payload.sessionId,n=this._navigation.observe("room").get()===t.payload.roomId;e.source.postMessage({replyTo:t.id,payload:r&&n})}else if(t.type==="closeSession"){let{sessionId:r}=t.payload;this._closeSessionIfNeeded(r).finally(()=>{e.source.postMessage({replyTo:t.id})})}else t.type==="haltRequests"?(this.haltRequests=!0,e.source.postMessage({replyTo:t.id})):t.type==="openRoom"&&this._navigation.push("room",t.payload.roomId)}_closeSessionIfNeeded(e){let t=this._navigation?.path.get("session");return e&&t?.value===e?new Promise(s=>{let r=this._navigation.pathObservable.subscribe(n=>{let o=n.get("session");(!o||o.value!==e)&&(r(),s())});this._navigation.push("session")}):Promise.resolve()}async _proposeUpdate(){if(document.hidden)return;let e=await this._sendAndWaitForReply("version",null,this._registration.waiting);confirm(`Version ${e.version} (${e.buildHash}) is available. Reload to apply?`)&&(await this._sendAndWaitForReply("haltRequests"),this._send("skipWaiting",null,this._registration.waiting))}handleEvent(e){switch(e.type){case"message":this._onMessage(e);break;case"updatefound":this._registration.installing.addEventListener("statechange",this);break;case"statechange":{e.target.state==="installed"&&(this._proposeUpdate(),e.target.removeEventListener("statechange",this));break}case"controllerchange":this._currentController?document.location.reload():this._currentController=navigator.serviceWorker.controller;break}}async _send(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),s.postMessage({type:e,payload:t})}async _sendAndWaitForReply(e,t,s=void 0){this._registrationPromise&&await this._registrationPromise,s||(s=this._registration.active),this._messageIdCounter+=1;let r=this._messageIdCounter,n=new Promise(o=>{this._waitingForReply.set(r,o)});return s.postMessage({type:e,id:r,payload:t}),await n}async checkForUpdate(){this._registrationPromise&&await this._registrationPromise,this._registration.update()}get version(){return"0.2.22"}get buildHash(){return DEFINE_GLOBAL_HASH}async preventConcurrentSessionAccess(e){return this._sendAndWaitForReply("closeSession",{sessionId:e})}async getRegistration(){return this._registrationPromise&&await this._registrationPromise,this._registration}};var _l=class{constructor(e,t){this._serviceWorkerHandler=e,this._pushConfig=t}async enablePush(e,t){let s=await this._serviceWorkerHandler?.getRegistration();if(s?.pushManager){let n=(await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._pushConfig.applicationServerKey})).toJSON(),o=n.keys.p256dh,a={endpoint:n.endpoint,auth:n.keys.auth,events_only:!0,default_payload:t};return e.httpPusher(this._pushConfig.gatewayUrl,this._pushConfig.appId,o,a)}}async disablePush(){let e=await this._serviceWorkerHandler?.getRegistration();if(e?.pushManager){let t=await e.pushManager.getSubscription();t&&await t.unsubscribe()}}async isPushEnabled(){let e=await this._serviceWorkerHandler?.getRegistration();return e?.pushManager?!!await e.pushManager.getSubscription():!1}async supportsPush(){if(!this._pushConfig)return!1;let e=await this._serviceWorkerHandler?.getRegistration();return e&&"pushManager"in e}async enableNotifications(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}async supportsNotifications(){return"Notification"in window}async areNotificationsEnabled(){return"Notification"in window?Notification.permission==="granted":!1}async showNotification(e,t=void 0){if("Notification"in window){new Notification(e,{body:t});return}(await this._serviceWorkerHandler?.getRegistration())?.showNotification(e,{body:t})}};var yl=class extends Je{handleEvent(e){e.type==="hashchange"&&(this.emit(this.get()),this._storeHash(this.get()))}get(){return document.location.search.includes("loginToken")?document.location.search:document.location.hash}replaceUrlSilently(e){window.history.replaceState(null,null,e),this._storeHash(e)}pushUrlSilently(e){window.history.pushState(null,null,e),this._storeHash(e)}pushUrl(e){document.location.hash=e}urlAsPath(e){return e.startsWith("#")?e.substr(1):e}pathAsUrl(e){return`#${e}`}onSubscribeFirst(){window.addEventListener("hashchange",this)}onUnsubscribeLast(){window.removeEventListener("hashchange",this)}_storeHash(e){window.localStorage?.setItem("hydrogen_last_url_hash",e)}getLastUrl(){return window.localStorage?.getItem("hydrogen_last_url_hash")}};var wl=class extends Je{constructor(){super();this._onOffline=this._onOffline.bind(this),this._onOnline=this._onOnline.bind(this)}_onOffline(){this.emit(!1)}_onOnline(){this.emit(!0)}get(){return navigator.onLine}onSubscribeFirst(){window.addEventListener("offline",this._onOffline),window.addEventListener("online",this._onOnline)}onUnsubscribeLast(){window.removeEventListener("offline",this._onOffline),window.removeEventListener("online",this._onOnline)}};var vl=vs(ca());function ye(i,e){return i instanceof Promise?i:new Promise((t,s)=>{i.oncomplete=r=>t(r.target.result),i.onerror=()=>s(new Error("Crypto error on "+e))})}var Vm=class{constructor(e){this._subtleCrypto=e}async verify(e,t,s,r){let n={name:"HMAC",hash:{name:cs(r)}},o=await ye(this._subtleCrypto.importKey("raw",e,n,!1,["verify"]),"importKey");return await ye(this._subtleCrypto.verify(n,o,t,s),"verify")}async compute(e,t,s){let r={name:"HMAC",hash:{name:cs(s)}},n=await ye(this._subtleCrypto.importKey("raw",e,r,!1,["sign"]),"importKey"),o=await ye(this._subtleCrypto.sign(r,n,t),"sign");return new Uint8Array(o)}},qm=class{constructor(e,t,s){this._subtleCrypto=e,this._crypto=t,this._cryptoExtras=s}async pbkdf2(e,t,s,r,n){if(!this._subtleCrypto.deriveBits)throw new Error("PBKDF2 is not supported");let o=await ye(this._subtleCrypto.importKey("raw",e,{name:"PBKDF2"},!1,["deriveBits"]),"importKey"),a=await ye(this._subtleCrypto.deriveBits({name:"PBKDF2",salt:s,iterations:t,hash:cs(r)},o,n),"deriveBits");return new Uint8Array(a)}async hkdf(e,t,s,r,n){if(!this._subtleCrypto.deriveBits)return this._cryptoExtras.hkdf(this._crypto,e,t,s,r,n);let o=await ye(this._subtleCrypto.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),"importKey"),a=await ye(this._subtleCrypto.deriveBits({name:"HKDF",salt:t,info:s,hash:cs(r)},o,n),"deriveBits");return new Uint8Array(a)}},Bm=class{constructor(e,t){this._subtleCrypto=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:r,counterLength:n=64}){let o={name:"AES-CTR",counter:s,length:n},a;try{let l=e||t,c=t?"jwk":"raw";a=await ye(this._subtleCrypto.importKey(c,l,o,!1,["decrypt"]),"importKey")}catch(l){throw new Error(`Could not import key for AES-CTR decryption: ${l.message}`)}try{let l=await ye(this._subtleCrypto.decrypt(o,a,r),"decrypt");return new Uint8Array(l)}catch(l){throw new Error(`Could not decrypt with AES-CTR: ${l.message}`)}}async encryptCTR({key:e,jwkKey:t,iv:s,data:r}){let n={name:"AES-CTR",counter:s,length:64},o,a=e||t,l=t?"jwk":"raw";try{o=await ye(this._subtleCrypto.importKey(l,a,n,!1,["encrypt"]),"importKey")}catch(c){throw new Error(`Could not import key for AES-CTR encryption: ${c.message}`)}try{let c=await ye(this._subtleCrypto.encrypt(n,o,r),"encrypt");return new Uint8Array(c)}catch(c){throw new Error(`Could not encrypt with AES-CTR: ${c.message}`)}}async generateKey(e,t=256){let s=await ye(this._subtleCrypto.generateKey({name:"AES-CTR",length:t},!0,["encrypt","decrypt"]));return ye(this._subtleCrypto.exportKey(e,s))}async generateIV(){return Om(this._crypto)}};function Om(i){let e=i.getRandomValues(new Uint8Array(8)),t=new Uint8Array(16);for(let s=0;s<e.length;s+=1)t[s]=e[s];return t}function Nm(i){if(i.alg!=="A256CTR")throw new Error(`Unknown algorithm: ${i.alg}`);if(!i.key_ops.includes("decrypt"))throw new Error("decrypt missing from key_ops");if(i.kty!=="oct")throw new Error(`Invalid key type, "oct" expected: ${i.kty}`);let t=i.k.replace(/-/g,"+").replace(/_/g,"/");return vl.default.decode(t)}function Tg(i){let e=vl.default.encode(i),t=e.indexOf("=");return t!==-1?e.substr(0,t):e}function Rg(i){return Tg(i).replace(/\+/g,"-").replace(/\//g,"_")}function kg(i){return{alg:"A256CTR",ext:!0,k:Rg(i),key_ops:["encrypt","decrypt"],kty:"oct"}}var Pm=class{constructor(e,t){this._aesjs=e,this._crypto=t}async decryptCTR({key:e,jwkKey:t,iv:s,data:r,counterLength:n=64}){if(n!==64)throw new Error(`Unsupported counter length: ${n}`);t&&(e=Nm(t));let o=this._aesjs;var a=new o.ModeOfOperation.ctr(new Uint8Array(e),new o.Counter(new Uint8Array(s)));return a.decrypt(new Uint8Array(r))}async encryptCTR({key:e,jwkKey:t,iv:s,data:r}){t&&(e=Nm(t));let n=this._aesjs;var o=new n.ModeOfOperation.ctr(new Uint8Array(e),new n.Counter(new Uint8Array(s)));return o.encrypt(new Uint8Array(r))}async generateKey(e,t=256){let s=crypto.getRandomValues(new Uint8Array(t/8));return e==="jwk"&&(s=kg(s)),s}async generateIV(){return Om(this._crypto)}};function cs(i){if(i!=="SHA-256"&&i!=="SHA-512")throw new Error(`Invalid hash name: ${i}`);return i}var bl=class{constructor(e){let t=window.crypto||window.msCrypto,s=t.subtle||t.webkitSubtle;this._subtleCrypto=s,!s.deriveBits&&e?.aesjs?this.aes=new Pm(e.aesjs,t):this.aes=new Bm(s,t),this.hmac=new Vm(s),this.derive=new qm(s,this,e)}async digest(e,t){return await ye(this._subtleCrypto.digest(cs(e),t))}digestSize(e){switch(cs(e)){case"SHA-512":return 64;case"SHA-256":return 32;default:throw new Error(`Not implemented for ${cs(e)}`)}}};async function Fm(){if(navigator?.storage?.estimate){let{quota:i,usage:e}=await navigator.storage.estimate();return{quota:i,usage:e}}else return{quota:null,usage:null}}var Um=class{constructor(e){this.worker=e,this.busy=!1}attach(e){this.worker.addEventListener("message",e),this.worker.addEventListener("error",e)}detach(e){this.worker.removeEventListener("message",e),this.worker.removeEventListener("error",e)}},Km=class{constructor(e,t){this._promise=new Promise((s,r)=>{this._resolve=s,this._reject=r}),this._message=e,this._pool=t,this._worker=null}abort(){this._isNotDisposed&&(this._pool._abortRequest(this),this._dispose())}response(){return this._promise}_dispose(){this._reject=null,this._resolve=null}get _isNotDisposed(){return this._resolve&&this._reject}},Il=class{constructor(e,t){this._workers=[];for(let s=0;s<t;++s){let r=new Um(new Worker(e));r.attach(this),this._workers[s]=r}this._requests=new Map,this._counter=0,this._pendingFlag=!1,this._init=null}init(){let e=new Promise((t,s)=>{this._init={resolve:t,reject:s}});return this.sendAll({type:"ping"}).then(this._init.resolve,this._init.reject).finally(()=>{this._init=null}),e}handleEvent(e){if(e.type==="message"){let t=e.data,s=this._requests.get(t.replyToId);if(s){if(s._worker.busy=!1,s._isNotDisposed){if(t.type==="success")s._resolve(t.payload);else if(t.type==="error"){let r=new Error(t.message);r.stack=t.stack,s._reject(r)}s._dispose()}this._requests.delete(t.replyToId)}this._sendPending()}else e.type==="error"&&(this._init&&this._init.reject(new Error("worker error during init")),console.error("worker error",e))}_getPendingRequest(){for(let e of this._requests.values())if(!e._worker)return e}_getFreeWorker(){for(let e of this._workers)if(!e.busy)return e}_sendPending(){this._pendingFlag=!1;let e;do{e=!1;let t=this._getPendingRequest();if(t){let s=this._getFreeWorker();s&&(this._sendWith(t,s),e=!0)}}while(e)}_sendWith(e,t){e._worker=t,t.busy=!0,t.worker.postMessage(e._message)}_enqueueRequest(e){this._counter+=1,e.id=this._counter;let t=new Km(e,this);return this._requests.set(e.id,t),t}send(e){let t=this._enqueueRequest(e),s=this._getFreeWorker();return s&&this._sendWith(t,s),t}sendAll(e){let t=this._workers.map(s=>{let r=this._enqueueRequest(Object.assign({},e));return this._sendWith(r,s),r.response()});return Promise.all(t)}dispose(){for(let e of this._workers)e.detach(this),e.worker.terminate()}_trySendPendingInNextTick(){this._pendingFlag||(this._pendingFlag=!0,Promise.resolve().then(()=>{this._sendPending()}))}_abortRequest(e){e._reject(new j),e._worker&&(e._worker.busy=!1),this._requests.delete(e._message.id),this._trySendPendingInNextTick()}};var us=class{static async fromBlob(e){let t=await $m(e),{width:s,height:r}=t;return new us(e,s,r,t)}constructor(e,t,s,r){this.blob=e,this.width=t,this.height=s,this._domElement=r}get maxDimension(){return Math.max(this.width,this.height)}async _getDomElement(){return this._domElement||(this._domElement=await $m(this.blob)),this._domElement}async scale(e){let t=this.width/this.height,s=Math.min(1,e/(t>=1?this.width:this.height)),r=Math.round(this.width*s),n=Math.round(this.height*s),o=document.createElement("canvas");o.width=r,o.height=n;let a=o.getContext("2d"),l=await this._getDomElement();a.drawImage(l,0,0,r,n);let c=this.blob.mimeType==="image/jpeg"?"image/jpeg":"image/png",u;if(o.toBlob)u=await new Promise(p=>o.toBlob(p,c));else if(o.msToBlob)c="image/png",u=o.msToBlob();else throw new Error("canvas can't be turned into blob");let d=Ne.fromBlob(u);return new us(d,r,n,null)}dispose(){this.blob.dispose()}},Rr=class extends us{get duration(){if(typeof this._domElement.duration=="number")return Math.round(this._domElement.duration*1e3)}static async fromBlob(e){let t=await Mg(e),{videoWidth:s,videoHeight:r}=t;return new Rr(e,s,r,t)}};function jm(){let i=document.createElement("canvas");i.width=1,i.height=1;let e=i.getContext("2d"),t=[Math.round(Math.random()*255),Math.round(Math.random()*255),Math.round(Math.random()*255)];e.fillStyle=`rgb(${t[0]}, ${t[1]}, ${t[2]})`,e.fillRect(0,0,1,1);let s=e.getImageData(0,0,1,1).data;return s[0]===t[0]&&s[1]===t[1]&&s[2]===t[2]}async function $m(i){let e=document.createElement("img"),t=Ns(e,"load");return e.src=i.url,await t,e}async function Mg(i){let e=document.createElement("video");e.muted=!0;let t=Ns(e,"loadedmetadata");e.src=i.url,e.load(),await t;let s=Ns(e,"seeked");return await new Promise(r=>setTimeout(r,200)),e.currentTime=.1,await s,e}async function Hm(i,e,t,s,r){let n=i.querySelector("iframe.downloadSandbox");if(!n){n=document.createElement("iframe"),n.setAttribute("sandbox","allow-scripts allow-downloads allow-downloads-without-user-activation"),n.setAttribute("src",e),n.className="hidden downloadSandbox",i.appendChild(n);let o;await new Promise((a,l)=>{o=()=>{n.removeEventListener("load",a),n.removeEventListener("error",l)},n.addEventListener("load",a),n.addEventListener("error",l)}),o()}if(r){let o=await t.readAsBuffer();n.contentWindow.postMessage({type:"downloadBuffer",buffer:o,mimeType:t.mimeType,filename:s},"*")}else n.contentWindow.postMessage({type:"downloadBlob",blob:t.nativeBlob,filename:s},"*")}var zm=vs(Wm()),Gm=class{constructor(e){this._bodyNode=e}get rootNodes(){return Array.from(this._bodyNode.childNodes)}getChildNodes(e){return Array.from(e.childNodes)}getAttributeNames(e){return Array.from(e.getAttributeNames())}getAttributeValue(e,t){return e.getAttribute(t)}isTextNode(e){return e.nodeType===Node.TEXT_NODE}getNodeText(e){return e.textContent}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}getNodeElementName(e){return e.tagName}},Ag={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|xxx|mxc):|[^a-z]|[a-z+.-]+(?:[^a-z+.-:]|$))/i,ADD_TAGS:["mx-reply"]};function Qm(i){let e=zm.default.sanitize(i,Ag),t=new DOMParser().parseFromString(e,"text/html").body;return new Gm(t)}function Ym(i){return new Promise(function(e,t){var s=document.createElement("script");s.setAttribute("src",i),s.onload=e,s.onerror=t,document.body.appendChild(s)})}async function Cg(i){return window.msCrypto&&!window.crypto&&(window.crypto=window.msCrypto),i?(window.WebAssembly?(await Ym(i.wasmBundle),await window.Olm.init({locateFile:()=>i.wasm})):(await Ym(i.legacyBundle),await window.Olm.init()),window.Olm):null}function Lg(i){return i.startsWith("/")?i:new URL(i,document.location.href).pathname}async function Dg(i){let e=new Il(i.worker,4);return await e.init(),await e.sendAll({type:"load_olm",path:Lg(i.olm.legacyBundle)}),new xa(e)}function Vg(i){if(!window.visualViewport)return;let e=()=>{let t=i.querySelector(".SessionView");if(!t)return;let s=i.querySelector(".bottom-aligned-scroll"),r,n,o;s&&(r=s.scrollTop,n=s.offsetHeight);let a=t.offsetTop+t.offsetHeight-window.visualViewport.height;i.style.setProperty("--ios-viewport-height",window.visualViewport.height.toString()+"px"),i.style.setProperty("--ios-viewport-top",a.toString()+"px"),s&&(o=s.offsetHeight,s.scrollTop=r+n-o)};return window.visualViewport.addEventListener("resize",e),()=>{window.visualViewport.removeEventListener("resize",e)}}var Jm=class{constructor(e,t,s=null,r=null){this._config=t,this._container=e,this.settingsStorage=new oa("hydrogen_setting_v1_"),this.clock=new fl,this.encoding=new Ea,this.random=Math.random,this._createLogger(r?.development),this.history=new yl,this.onlineStatus=new wl,this._serviceWorkerHandler=null,t.serviceWorker&&"serviceWorker"in navigator&&(this._serviceWorkerHandler=new gl,this._serviceWorkerHandler.registerAndStart(t.serviceWorker)),this.notificationService=new _l(this._serviceWorkerHandler,t.push),this.crypto=new bl(s),this.storageFactory=new ci(this._serviceWorkerHandler),this.sessionInfoStorage=new na("hydrogen_sessions_v1"),this.estimateStorageUsage=Fm,typeof fetch=="function"?this.request=qd(this.clock.createTimeout,this._serviceWorkerHandler):this.request=Ei;let n=!!window.MSInputMethodContext&&!!document.documentMode;this.isIE11=n;let o=/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1&&!window.MSStream;this.isIOS=o,this._disposables=new Yt}_createLogger(e){let t=s=>(s.e?.stack&&(s.e.stack=s.e.stack.replace(/\/\?loginToken=(.+)/,"?loginToken=<snip>")),s);e?this.logger=new Ra({platform:this}):this.logger=new Ta({name:"hydrogen_logs",platform:this,serializedTransformer:t})}get updateService(){return this._serviceWorkerHandler}loadOlm(){return Cg(this._config.olm)}get config(){return this._config}async loadOlmWorker(){if(!window.WebAssembly)return await Dg(this._config)}createAndMountRootView(e){if(this.isIE11&&(this._container.className+=" legacy"),this.isIOS){this._container.className+=" ios";let s=Vg(this._container);s&&this._disposables.track(s)}this._container.addEventListener("error",Da,!0),this._disposables.track(()=>this._container.removeEventListener("error",Da,!0)),window.__hydrogenViewModel=e;let t=new Oi(e);this._container.appendChild(t.mount())}setNavigation(e){this._serviceWorkerHandler?.setNavigation(e)}createBlob(e,t){return Ne.fromBuffer(e,t)}saveFileAs(e,t){navigator.msSaveBlob?navigator.msSaveBlob(e.nativeBlob,t):Hm(this._container,this._config.downloadSandbox,e,t,this.isIOS)}openFile(e=null){let t=document.createElement("input");t.setAttribute("type","file"),t.className="hidden",e&&t.setAttribute("accept",e);let s=new Promise(r=>{let n=()=>{t.removeEventListener("change",n,!0);let o=t.files[0];this._container.removeChild(t),o?r({name:o.name,blob:Ne.fromBlob(o)}):r()};t.addEventListener("change",n,!0)});return this._container.appendChild(t),t.click(),s}openUrl(e){location.href=e}parseHTML(e){return Qm(e)}async loadImage(e){return us.fromBlob(e)}async loadVideo(e){return Rr.fromBlob(e)}hasReadPixelPermission(){return jm()}get devicePixelRatio(){return window.devicePixelRatio||1}get version(){return"0.2.22"}dispose(){this._disposables.dispose()}};var S=class extends Ot{constructor(e={}){super();this.disposables=null,this._isDisposed=!1,this._options=e}childOptions(e){let{navigation:t,urlCreator:s,platform:r}=this._options;return Object.assign({navigation:t,urlCreator:s,platform:r},e)}getOption(e){return this._options[e]}track(e){return this.disposables||(this.disposables=new Yt),this.disposables.track(e)}untrack(e){return this.disposables?this.disposables.untrack(e):null}dispose(){this.disposables&&this.disposables.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}disposeTracked(e){return this.disposables?this.disposables.disposeTracked(e):null}i18n(e,...t){let s="";for(let r=0;r<e.length;++r)s=s+e[r],r<t.length&&(s=s+t[r]);return s}updateOptions(e){this._options=Object.assign(this._options,e)}emitChange(e){this._options.emitChange?this._options.emitChange(e):this.emit("change",e)}get platform(){return this._options.platform}get clock(){return this._options.platform.clock}get logger(){return this.platform.logger}get urlCreator(){return this._options.urlCreator}get navigation(){return this._options.navigation}};function Z(i){let e=i.charAt(0);return(e==="!"||e==="@"||e==="#")&&(e=i.charAt(1)),e.toUpperCase()}function qg(i){let e=0,t,s;if(i.length===0)return e;for(t=0;t<i.length;t++)s=i.charCodeAt(t),e=(e<<5)-e+s,e|=0;return Math.abs(e)}function ee(i){return qg(i)%8+1}function we(i,e,t,s){if(i){let r=e*t.devicePixelRatio;return s.mxcUrlThumbnail(i,r,r,"crop")}return null}var Xm=["invite","room"],kr=class extends S{constructor(e){super(e);this._isOpen=!1,this._hidden=!1}get hidden(){return this._hidden}set hidden(e){e!==this._hidden&&(this._hidden=e,this.emitChange("hidden"))}close(){this._isOpen&&(this._isOpen=!1,this.emitChange("isOpen"))}open(){this._isOpen||(this._isOpen=!0,this.emitChange("isOpen"))}get isOpen(){return this._isOpen}compare(e){return e.kind!==this.kind?Xm.indexOf(this.kind)-Xm.indexOf(e.kind):0}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this._avatarSource.avatarColorId)}avatarUrl(e){return we(this._avatarSource.avatarUrl,e,this.platform,this._avatarSource.mediaRepository)}get avatarTitle(){return this.name}};var xl=class extends kr{constructor(e){super(e);let{room:t}=e;this._room=t,this._url=this.urlCreator.openRoomActionUrl(this._room.id)}get kind(){return"room"}get url(){return this._url}compare(e){let t=super.compare(e);if(t!==0)return t;let s=this._room,r=e._room;if(s.isLowPriority!==r.isLowPriority)return s.isLowPriority?1:-1;let n=s.lastMessageTimestamp,o=r.lastMessageTimestamp,a=Number.isSafeInteger(n),l=Number.isSafeInteger(o);if(a!==l)return l?1:-1;let c=o-n;if(c===0||!l||!a){let u=this.name.localeCompare(e.name);return u===0?this._room.id.localeCompare(e._room.id):u}return c}get isUnread(){return this._room.isUnread}get name(){return this._room.name||this.i18n`Empty Room`}get badgeCount(){return this._room.notificationCount}get isHighlighted(){return this._room.highlightCount!==0}get _avatarSource(){return this._room}};var Tl=class extends kr{constructor(e){super(e);let{invite:t}=e;this._invite=t,this._url=this.urlCreator.openRoomActionUrl(this._invite.id)}get busy(){return this._invite.accepting||this._invite.rejecting}get kind(){return"invite"}get url(){return this._url}compare(e){let t=super.compare(e);return t!==0?t:e._invite.timestamp-this._invite.timestamp}get name(){return this._invite.name}get _avatarSource(){return this._invite}};var Rl=class{constructor(e){this._parts=e.split(" ").map(t=>t.toLowerCase().trim())}matches(e){let t=e.name.toLowerCase();return this._parts.every(s=>t.includes(s))}};var kl=class extends Me{constructor(e,t){super();this._source=e,this._apply=t,this._subscription=null}hasApply(){return!!this._apply}setApply(e){this._apply=e,e&&this.applyOnce(this._apply)}applyOnce(e){for(let[t,s]of this._source)e(t,s)}onAdd(e,t){this._apply&&this._apply(e,t),this.emitAdd(e,t)}onRemove(e,t){this.emitRemove(e,t)}onUpdate(e,t,s){this._apply&&this._apply(e,t,s),this.emitUpdate(e,t,s)}onSubscribeFirst(){this._subscription=this._source.subscribe(this),this._apply&&this.applyOnce(this._apply),super.onSubscribeFirst()}onUnsubscribeLast(){super.onUnsubscribeLast(),this._subscription=this._subscription()}onReset(){this._apply&&this.applyOnce(this._apply),this.emitReset()}[Symbol.iterator](){return this._source[Symbol.iterator]()}get size(){return this._source.size}get(e){return this._source.get(e)}};var Ml=class extends S{constructor(e){super(e);let{rooms:t,invites:s}=e;this._tileViewModelsMap=this._mapTileViewModels(t,s),this._tileViewModelsFilterMap=new kl(this._tileViewModelsMap),this._tileViewModels=this._tileViewModelsFilterMap.sortValues((r,n)=>r.compare(n)),this._currentTileVM=null,this._setupNavigation(),this._closeUrl=this.urlCreator.urlForSegment("session"),this._settingsUrl=this.urlCreator.urlForSegment("settings")}_mapTileViewModels(e,t){return t.join(e).mapValues((s,r)=>{let n;return s.isInvite?n=new Tl(this.childOptions({invite:s,emitChange:r})):n=new xl(this.childOptions({room:s,emitChange:r})),this.navigation.path.get("room")?.value===s.id&&(n.open(),this._updateCurrentVM(n)),n})}_updateCurrentVM(e){this._currentTileVM?.close(),this._currentTileVM=e}get closeUrl(){return this._closeUrl}get settingsUrl(){return this._settingsUrl}_setupNavigation(){let e=this.navigation.observe("room");this.track(e.subscribe(s=>this._open(s)));let t=this.navigation.observe("rooms");this.gridEnabled=!!t.get(),this.track(t.subscribe(s=>{let r=this.gridEnabled^!!s;this.gridEnabled=!!s,r&&this.emitChange("gridEnabled")}))}_open(e){this._currentTileVM?.close(),this._currentTileVM=null,e&&(this._currentTileVM=this._tileViewModelsMap.get(e),this._currentTileVM?.open())}toggleGrid(){let e=this.navigation.path.get("room"),t=this.navigation.path.until("session");this.gridEnabled?e&&(t=t.with(e),t=vr(this.navigation,t)):e?(t=t.with(this.navigation.segment("rooms",[e.value])),t=t.with(e),t=vr(this.navigation,t)):(t=t.with(this.navigation.segment("rooms",[])),t=t.with(this.navigation.segment("empty-grid-tile",0))),this.navigation.applyPath(t)}get tileViewModels(){return this._tileViewModels}clearFilter(){this._tileViewModelsFilterMap.setApply(null),this._tileViewModelsFilterMap.applyOnce((e,t)=>t.hidden=!1)}setFilter(e){if(e=e.trim(),e.length===0)return this.clearFilter(),!1;{let t=!this._tileViewModelsFilterMap.hasApply(),s=new Rl(e);return this._tileViewModelsFilterMap.setApply((r,n)=>{n.hidden=!s.matches(n)}),t}}};var ve=class{constructor(e,t,s,r){this._remove=e,this._update=t,this._replace=s,this._updateParams=r}get shouldReplace(){return this._replace}get shouldRemove(){return this._remove}get shouldUpdate(){return this._update}get updateParams(){return this._updateParams}static Remove(){return new ve(!0,!1,!1,null)}static Update(e){return new ve(!1,!0,!1,e)}static Nothing(){return new ve(!1,!1,!1,null)}static Replace(e){return new ve(!1,!1,!0,e)}};var Al=class extends Se{constructor(e,t){super();this._entries=e,this._tiles=null,this._entrySubscription=null,this._tileCreator=t,this._emitSpontanousUpdate=this._emitSpontanousUpdate.bind(this)}_emitSpontanousUpdate(e,t){let s=e.lowerEntry,r=this._findTileIdx(s);this.emitUpdate(r,e,t)}onSubscribeFirst(){this._entrySubscription=this._entries.subscribe(this),this._populateTiles()}_populateTiles(){this._tiles=[];let e=null;for(let s of this._entries)(!e||!e.tryIncludeEntry(s))&&(e=this._tileCreator(s),e&&this._tiles.push(e));let t=null;for(let s of this._tiles)t&&t.updateNextSibling(s),s.updatePreviousSibling(t),t=s;t&&t.updateNextSibling(null);for(let s of this._tiles)s.setUpdateEmit(this._emitSpontanousUpdate)}_findTileIdx(e){return Ke(this._tiles,e,(t,s)=>-s.compareEntry(t))}_findTileAtIdx(e,t){let s=this._getTileAtIdx(t);if(s&&s.compareEntry(e)===0)return s}_getTileAtIdx(e){return e>=0&&e<this._tiles.length?this._tiles[e]:null}onUnsubscribeLast(){this._entrySubscription=this._entrySubscription();for(let e=0;e<this._tiles.length;e+=1)this._tiles[e].dispose();this._tiles=null}onReset(){this._buildInitialTiles(),this.emitReset()}onAdd(e,t){let s=this._findTileIdx(t),r=this._getTileAtIdx(s-1);if(r&&r.tryIncludeEntry(t)){this.emitUpdate(s-1,r);return}let n=this._getTileAtIdx(s);if(n&&n.tryIncludeEntry(t)){this.emitUpdate(s,n);return}let o=this._tileCreator(t);o&&(r&&(r.updateNextSibling(o),o.updatePreviousSibling(r)),n&&(o.updateNextSibling(n),n.updatePreviousSibling(o)),this._tiles.splice(s,0,o),this.emitAdd(s,o),o.setUpdateEmit(this._emitSpontanousUpdate))}onUpdate(e,t,s){if(!this._tiles)return;let r=this._findTileIdx(t),n=this._findTileAtIdx(t,r);if(n){let o=n.updateEntry(t,s);if(o.shouldReplace){let a=this._tileCreator(t);a?(this._replaceTile(r,n,a,o.updateParams),a.setUpdateEmit(this._emitSpontanousUpdate)):this._removeTile(r,n)}o.shouldRemove&&this._removeTile(r,n),o.shouldUpdate&&this.emitUpdate(r,n,o.updateParams)}}_replaceTile(e,t,s,r){t.dispose();let n=this._getTileAtIdx(e-1),o=this._getTileAtIdx(e+1);this._tiles[e]=s,n?.updateNextSibling(s),s.updatePreviousSibling(n),s.updateNextSibling(o),o?.updatePreviousSibling(s),this.emitUpdate(e,s,r)}_removeTile(e,t){let s=this._getTileAtIdx(e-1),r=this._getTileAtIdx(e+1);this._tiles.splice(e,1),t.dispose(),this.emitRemove(e,t),s?.updateNextSibling(r),r?.updatePreviousSibling(s)}onRemove(e,t){let s=this._findTileIdx(t),r=this._findTileAtIdx(t,s);r&&(r.removeEntry(t)?this._removeTile(s,r):this.emitUpdate(s,r))}onMove(){}[Symbol.iterator](){return this._tiles.values()}get length(){return this._tiles.length}getFirst(){return this._tiles[0]}getTileIndex(e){let t=Ke(this._tiles,e,(r,n)=>r.compare(n));return this._tiles[t]?.compare(e)===0?t:-1}sliceIterator(e,t){return this._tiles.slice(e,t)[Symbol.iterator]()}};var Ni=class extends S{constructor(e){super(e);let{timeline:t,tilesCreator:s}=e;this._timeline=this.track(t),this._tiles=new Al(t.entries,s),this._startTile=null,this._endTile=null,this._topLoadingPromise=null,this._requestedStartTile=null,this._requestedEndTile=null,this._requestScheduled=!1,this._showJumpDown=!1}setVisibleTileRange(e,t){this._requestedStartTile=e,this._requestedEndTile=t,this._requestScheduled||(Promise.resolve().then(()=>{this._setVisibleTileRange(this._requestedStartTile,this._requestedEndTile),this._requestScheduled=!1}),this._requestScheduled=!0)}_setVisibleTileRange(e,t){let s;if(e&&t){this._startTile=e,this._endTile=t;let r=this._tiles.getTileIndex(this._startTile),n=this._tiles.getTileIndex(this._endTile);for(let o of this._tiles.sliceIterator(r,n+1))o.notifyVisible();s=r<10,this._setShowJumpDown(n<this._tiles.length-1)}else s=!0,this._setShowJumpDown(!1);s&&!this._topLoadingPromise&&(this._topLoadingPromise=this._timeline.loadAtTop(10).then(r=>{this._topLoadingPromise=null,r||this.setVisibleTileRange(this._requestedStartTile,this._requestedEndTile)}))}get tiles(){return this._tiles}_setShowJumpDown(e){this._showJumpDown!==e&&(this._showJumpDown=e,this.emitChange("showJumpDown"))}get showJumpDown(){return this._showJumpDown}};var Cl=class extends S{constructor(e){super();this._roomVM=e,this._isEmpty=!0,this._replyVM=null}setReplyingTo(e){(new Boolean(e)!==new Boolean(this._replyVM)||!this._replyVM?.id.equals(e.asEventKey()))&&(this._replyVM=this.disposeTracked(this._replyVM),e&&(this._replyVM=this.track(this._roomVM._createTile(e))),this.emitChange("replyViewModel"),this.emit("focus"))}clearReplyingTo(){this.setReplyingTo(null)}get replyViewModel(){return this._replyVM}get isEncrypted(){return this._roomVM.isEncrypted}async sendMessage(e){let t=await this._roomVM._sendMessage(e,this._replyVM);return t&&(this._isEmpty=!0,this.emitChange("canSend"),this.clearReplyingTo()),t}sendPicture(){this._roomVM._pickAndSendPicture()}sendFile(){this._roomVM._pickAndSendFile()}sendVideo(){this._roomVM._pickAndSendVideo()}get canSend(){return!this._isEmpty}async setInput(e){let t=this._isEmpty;this._isEmpty=e.length===0,t&&!this._isEmpty&&this._roomVM._room.ensureMessageKeyIsShared(),t!==this._isEmpty&&this.emitChange("canSend")}get kind(){return"composer"}};var Ge=class extends S{constructor(e){super(e);this._entry=e.entry}get shape(){return null}get isContinuation(){return!1}get hasDateSeparator(){return!1}get id(){return this._entry.asEventKey()}get isPending(){return this._entry.isPending}get isUnsent(){return this._entry.isPending&&this._entry.pendingEvent.status!==V.Sent}get canAbortSending(){return this._entry.isPending&&!this._entry.pendingEvent.hasStartedSending}abortSending(){this._entry.pendingEvent?.abort()}setUpdateEmit(e){this.updateOptions({emitChange:t=>{e&&e(this,t)}})}get upperEntry(){return this._entry}get lowerEntry(){return this._entry}compare(e){return this.upperEntry.compare(e.upperEntry)}compareEntry(e){return this._entry.compare(e)}updateEntry(e,t){let s=this.shape==="redacted";return!e.isGap&&e.isRedacted!==s?ve.Replace("shape"):(this._entry=e,ve.Update(t))}removeEntry(){return!0}tryIncludeEntry(){return!1}updatePreviousSibling(){}updateNextSibling(){}notifyVisible(){}dispose(){this.setUpdateEmit(null),super.dispose()}get _room(){return this._roomVM.room}get _roomVM(){return this._options.roomVM}get _timeline(){return this._options.timeline}get _powerLevels(){return this._timeline.powerLevels}get _ownMember(){return this._options.timeline.me}};var Ll=class extends Ge{constructor(e){super(e);this._loading=!1,this._error=null,this._isAtTop=!0,this._siblingChanged=!1}async fill(){if(!this._loading&&!this._entry.edgeReached){this._loading=!0,this.emitChange("isLoading");try{await this._room.fillGap(this._entry,10)}catch(e){throw console.error(`room.fillGap(): ${e.message}:
${e.stack}`),this._error=e,this.emitChange("error"),e}finally{this._loading=!1,this.emitChange("isLoading")}return!0}return!1}async notifyVisible(){let e=0,t;this._siblingChanged=!1;do t=await this.fill(),e=e+1;while(e<10&&!this._siblingChanged&&t&&!this.isDisposed)}get isAtTop(){return this._isAtTop}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!e;this._isAtTop!==t&&(this._isAtTop=t,this.emitChange("isAtTop")),this._siblingChanged=!0}updateNextSibling(){this._siblingChanged=!0}updateEntry(e,t){return super.updateEntry(e,t),e.isGap?ve.Nothing():ve.Remove()}get shape(){return"gap"}get isLoading(){return this._loading}get error(){return this._error?`Could not load ${this._entry.prev_batch?"previous":"next"} messages: ${this._error.message}`:null}};var Dl=class{constructor(e){this._parentTile=e,this._map=new Ve,this._reactions=this._map.sortValues((t,s)=>t._compare(s))}update(e,t){if(e){for(let s in e)if(e.hasOwnProperty(s)){let r=e[s],n=this._map.get(s);n?n._tryUpdate(r)&&this._map.update(s):this._map.add(s,new Vl(s,r,null,this._parentTile))}}if(t)for(let[s,r]of t.entries()){let n=this._map.get(s);n?(n._tryUpdatePending(r),this._map.update(s)):this._map.add(s,new Vl(s,null,r,this._parentTile))}for(let s of this._map.keys()){let r=t?.has(s),n=e?.hasOwnProperty(s);!n&&!r?this._map.remove(s):n?r||this._map.get(s)._tryUpdatePending(null)&&this._map.update(s):this._map.get(s)._tryUpdate(null)&&this._map.update(s)}}get reactions(){return this._reactions}getReaction(e){return this._map.get(e)}},Vl=class{constructor(e,t,s,r){this._key=e,this._annotation=t,this._pending=s,this._parentTile=r,this._isToggling=!1}_tryUpdate(e){let t=!!this._annotation!=!!e,r=this._annotation&&e&&(e.me!==this._annotation.me||e.count!==this._annotation.count||e.firstTimestamp!==this._annotation.firstTimestamp);return t||r?(this._annotation=e,!0):!1}_tryUpdatePending(e){return!e&&!this._pending?!1:(this._pending=e,!0)}get key(){return this._key}get count(){return(this._pending?.count||0)+(this._annotation?.count||0)}get isPending(){return this._pending!==null}get isActive(){return this._annotation?.me||this.isPending}get firstTimestamp(){let e=Number.MAX_SAFE_INTEGER;return this._annotation&&(e=Math.min(e,this._annotation.firstTimestamp)),this._pending&&(e=Math.min(e,this._pending.firstTimestamp)),e}_compare(e){if(e===this)return 0;if(this.count!==e.count)return e.count-this.count;{let t=this.firstTimestamp-e.firstTimestamp;return t===0?this.key<e.key?-1:1:t}}async toggle(e=null){if(this._isToggling){console.log("busy toggling reaction already");return}this._isToggling=!0;try{await this._parentTile.toggleReaction(this.key,e)}finally{this._isToggling=!1}}};var pe=class extends Ge{constructor(e){super(e);this._date=this._entry.timestamp?new Date(this._entry.timestamp):null,this._isContinuation=!1,this._reactions=null,(this._entry.annotations||this._entry.pendingAnnotations)&&this._updateReactions()}get _mediaRepository(){return this._room.mediaRepository}get displayName(){return this._entry.displayName||this.sender}get sender(){return this._entry.sender}get memberPanelLink(){return`${this.urlCreator.urlUntilSegment("room")}/member/${this.sender}`}get avatarColorNumber(){return ee(this._entry.sender)}avatarUrl(e){return we(this._entry.avatarUrl,e,this.platform,this._mediaRepository)}get avatarLetter(){return Z(this.sender)}get avatarTitle(){return this.displayName}get date(){return this._date&&this._date.toLocaleDateString({},{month:"numeric",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get isOwn(){return this._entry.sender===this._ownMember.userId}get isContinuation(){return this._isContinuation}get isUnverified(){return this._entry.isUnverified}_getContent(){return this._entry.content}updatePreviousSibling(e){super.updatePreviousSibling(e);let t=!1;if(e&&e instanceof pe&&e.sender===this.sender){let s=this._entry.timestamp,r=e._entry.timestamp;t=s-r<5*60*1e3}t!==this._isContinuation&&(this._isContinuation=t,this.emitChange("isContinuation"))}updateEntry(e,t){let s=super.updateEntry(e,t);return s.shouldUpdate&&this._updateReactions(),s}startReply(){this._roomVM.startReply(this._entry)}reply(e,t,s=null){return this._room.sendEvent("m.room.message",this._entry.reply(e,t),null,s)}redact(e,t){return this._room.sendRedaction(this._entry.id,e,t)}get canRedact(){return this._powerLevels.canRedactFromSender(this._entry.sender)}get reactions(){return this.shape!=="redacted"?this._reactions:null}get canReact(){return this._powerLevels.canSendType("m.reaction")}react(e,t=null){return this.logger.wrapOrRun(t,"react",async s=>{if(!this.canReact){s.set("powerlevel_lacking",!0);return}if(this._entry.haveAnnotation(e)){s.set("already_reacted",!0);return}let r=this._entry.pendingAnnotations?.get(e)?.redactionEntry;r&&!r.pendingEvent.hasStartedSending?(s.set("abort_redaction",!0),await r.pendingEvent.abort()):await this._room.sendEvent("m.reaction",this._entry.annotate(e),null,s)})}redactReaction(e,t=null){return this.logger.wrapOrRun(t,"redactReaction",async s=>{if(!this._powerLevels.canRedactFromSender(this._ownMember.userId)){s.set("powerlevel_lacking",!0);return}if(!this._entry.haveAnnotation(e)){s.set("not_yet_reacted",!0);return}let r=this._entry.pendingAnnotations?.get(e)?.annotationEntry;r||(r=await this._timeline.getOwnAnnotationEntry(this._entry.id,e)),r?await this._room.sendRedaction(r.id,null,s):s.set("no_reaction",!0)})}toggleReaction(e,t=null){return this.logger.wrapOrRun(t,"toggleReaction",async s=>{this._entry.haveAnnotation(e)?await this.redactReaction(e,s):await this.react(e,s)})}_updateReactions(){let{annotations:e,pendingAnnotations:t}=this._entry;!e&&!t?this._reactions&&(this._reactions=null):(this._reactions||(this._reactions=new Dl(this)),this._reactions.update(e,t))}};var Bg="(?:https|http|ftp):\\/\\/",Zm="[^\\s.,?!)]",eh="[a-zA-Z0-9:.\\[\\]-]",Og=`${eh}*(?=${eh})${Zm}`,Ng=`(?:[\\/#](?:[^\\s]*${Zm})?)`,Pg=`${Bg}${Og}${Ng}?`,th=new RegExp(Pg,"gi");function Pi(i,e){let t=i.matchAll(th),s=0;for(let n of t){let o=i.slice(s,n.index);e(o,!1),e(n[0],!0);let a=n[0].length;s=n.index+a}let r=i.slice(s);e(r,!1)}function sh(i){let e=[],t=i.split(`
`),s=(r,n)=>{n?e.push(new Mr(r,[new Dt(r)])):e.push(new Dt(r))};for(let r=0;r<t.length;r+=1){let n=t[r];n.length&&Pi(n,s),r>=t.length-1||e.push(new Ui)}return new Ar(i,e)}function rh(i){return new Ar(i,[new Dt(i)])}var ql=class{constructor(e,t){this.level=e,this.inlines=t}get type(){return"header"}},Fi=class{constructor(e,t){this.language=e,this.text=t}get type(){return"codeblock"}},Bl=class{constructor(e,t){this.items=t,this.startOffset=e}get type(){return"list"}},Ol=class{constructor(e,t){this.head=e,this.body=t}get type(){return"table"}},Nl=class{get type(){return"rule"}},Ui=class{get type(){return"newline"}},Fs=class{constructor(e,t){this.format=e.toLowerCase(),this.children=t}get type(){return"format"}},Pl=class{constructor(e,t,s,r,n){this.src=e,this.width=t,this.height=s,this.alt=r,this.title=n}get type(){return"image"}},Fl=class{constructor(e,t,s){this.id=e,this.href=t,this.children=s}get type(){return"pill"}get avatarColorNumber(){return ee(this.id)}get avatarInitials(){return Z(this.id)}},Mr=class{constructor(e,t){this.url=e,this.inlines=t}get type(){return"link"}},Dt=class{constructor(e){this.text=e}get type(){return"text"}};function Fg(i){return i.type==="format"&&i.format==="blockquote"}var Ar=class{constructor(e,t){this.sourceString=e,this.parts=t}insertEmote(e){let t=0;for(;t<this.parts.length&&Fg(this.parts[t]);t++);this.parts.splice(t,0,new Dt(e))}};var Us=fe("Plain","Html"),Cr=class extends pe{constructor(e){super(e);this._messageBody=null,this._format=null}get shape(){return"message"}_parseBody(e){return rh(e)}_getBodyFormat(){return Us.Plain}get body(){let e=this._getBody(),t=this._getBodyFormat();return(!this._messageBody||this._messageBody.sourceString!==e||this._format!==t)&&(this._messageBody=this._parseBody(e,t),this._format=t),this._messageBody}};var Ug=["EM","STRONG","CODE","DEL","SPAN"],Kg=["DIV","BLOCKQUOTE"],jg=["https","http","ftp","mailto","magnet"].map(i=>`${i}://`),$g="https://matrix.to",ih=`${$g}/#/`,nh=class{constructor(e,t,s){this.allowReplies=s,this.result=e,this.mediaRepository=t}parsePillLink(e){if(!e.startsWith(ih))return null;let t=e.substring(ih.length);return t[0]==="@"?t:null}parseLink(e,t){let s=this.result.getAttributeValue(e,"href"),r=s?.toLowerCase();if(!r||!jg.some(o=>r.startsWith(o)))return new Fs("span",t);let n=this.parsePillLink(s);return n?new Fl(n,s,t):new Mr(s,t)}parseList(e){let t=this.result,s=null;t.getNodeElementName(e)==="OL"&&(s=parseInt(t.getAttributeValue(e,"start"))||1);let r=[];for(let n of t.getChildNodes(e)){if(t.getNodeElementName(n)!=="LI")continue;let o=this.parseAnyNodes(t.getChildNodes(n));r.push(o)}return new Bl(s,r)}_ensureElement(e,t){return e&&this.result.isElementNode(e)&&this.result.getNodeElementName(e)===t}parseCodeBlock(e){let t=this.result,s;for(let o of t.getChildNodes(e)){s=o;break}let r=null;if(!this._ensureElement(s,"CODE"))return new Fi(r,this.result.getNodeText(e));let n=t.getAttributeValue(s,"class")||"";for(let o of n.split(" "))if(o.startsWith("language-")&&!o.startsWith("language-_")){r=o.substring(9);break}return new Fi(r,this.result.getNodeText(s))}parseImage(e){let t=this.result,s=t.getAttributeValue(e,"src")||"",r=this.mediaRepository.mxcUrl(s);if(!r)return null;let n=parseInt(t.getAttributeValue(e,"width"))||null,o=parseInt(t.getAttributeValue(e,"height"))||null,a=t.getAttributeValue(e,"alt"),l=t.getAttributeValue(e,"title");return new Pl(r,n,o,a,l)}parseTableRow(e,t){let s=[];for(let r of this.result.getChildNodes(e)){if(!this._ensureElement(r,t))continue;let n=this.result.getChildNodes(r),o=this.parseInlineNodes(n);s.push(o)}return s}parseTableHead(e){let t=null;for(let s of this.result.getChildNodes(e)){t=s;break}return this._ensureElement(t,"TR")?this.parseTableRow(t,"TH"):null}parseTableBody(e){let t=[];for(let s of this.result.getChildNodes(e))!this._ensureElement(s,"TR")||t.push(this.parseTableRow(s,"TD"));return t}parseTable(e){let t=Array.from(this.result.getChildNodes(e)),s,r;return this._ensureElement(t[0],"THEAD")&&this._ensureElement(t[1],"TBODY")?(s=this.parseTableHead(t[0]),r=this.parseTableBody(t[1])):this._ensureElement(t[0],"TBODY")&&(s=null,r=this.parseTableBody(t[0])),new Ol(s,r)}parseInlineElement(e){let t=this.result,s=t.getNodeElementName(e),r=t.getChildNodes(e);switch(s){case"A":{let n=this.parseInlineNodes(r);return this.parseLink(e,n)}case"BR":return new Ui;default:{if(!Ug.includes(s))return null;let n=this.parseInlineNodes(r);return new Fs(s,n)}}}parseInlineNode(e){return this.result.isElementNode(e)?this.parseInlineElement(e):null}parseBlockElement(e){let t=this.result,s=t.getNodeElementName(e),r=t.getChildNodes(e);switch(s){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":{let n=this.parseInlineNodes(r);return new ql(parseInt(s[1]),n)}case"UL":case"OL":return this.parseList(e);case"PRE":return this.parseCodeBlock(e);case"HR":return new Nl;case"IMG":return this.parseImage(e);case"P":{let n=this.parseInlineNodes(r);return new Fs(s,n)}case"TABLE":return this.parseTable(e);default:{if(!Kg.includes(s))return null;let n=this.parseAnyNodes(r);return new Fs(s,n)}}}parseBlockNode(e){return this.result.isElementNode(e)?this.parseBlockElement(e):null}_parseTextParts(e,t){if(!this.result.isTextNode(e))return!1;let s=(r,n)=>{n?t.push(new Mr(r,[new Dt(r)])):t.push(new Dt(r))};return Pi(this.result.getNodeText(e),s),!0}_isAllowedNode(e){return this.allowReplies||!this._ensureElement(e,"MX-REPLY")}_parseInlineNodes(e,t){for(let s of e){if(this._parseTextParts(s,t))continue;let r=this.parseInlineNode(s);if(r){t.push(r);continue}this._isAllowedNode(s)&&this._parseInlineNodes(this.result.getChildNodes(s),t)}}parseInlineNodes(e){let t=[];return this._parseInlineNodes(e,t),t}_parseAnyNodes(e,t){for(let s of e){if(this._parseTextParts(s,t))continue;let r=this.parseInlineNode(s)||this.parseBlockNode(s);if(r){t.push(r);continue}this._isAllowedNode(s)&&this._parseAnyNodes(this.result.getChildNodes(s),t)}}parseAnyNodes(e){let t=[];return this._parseAnyNodes(e,t),t}};function oh(i,e,t,s){let r=i.parseHTML(s),o=new nh(r,e,t).parseAnyNodes(r.rootNodes);return new Ar(s,o)}var Ul=class extends Cr{_getContentString(e){return this._getContent()?.[e]||""}_getPlainBody(){return this._getContentString("body")}_getFormattedBody(){return this._getContentString("formatted_body")}_getBody(){return this._getBodyFormat()===Us.Html?this._getFormattedBody():this._getPlainBody()}_getBodyFormat(){return this._getContent()?.format==="org.matrix.custom.html"?Us.Html:Us.Plain}_parseBody(e,t){let s;return t===Us.Html?s=oh(this.platform,this._mediaRepository,this._entry.isReply,e):s=sh(e),this._getContent()?.msgtype==="m.emote"&&s.insertEmote(`* ${this.displayName} `),s}};var Ki=class extends pe{get shape(){return"redacted"}get description(){let{redactionReason:e}=this._entry;return this.isRedacting?e?this.i18n`This message is being deleted (${e})`:this.i18n`This message is being deleted`:e?this.i18n`This message has been deleted (${e}).`:this.i18n`This message has been deleted.`}get isRedacting(){return this._entry.isRedacting}get canRedact(){return!1}abortPendingRedaction(){return this._entry.abortPendingRedaction()}};var Hg=300,Wg=400,Lr=class extends pe{constructor(e){super(e);this._decryptedThumbnail=null,this._decryptedFile=null,this._error=null,this.isPending||this._tryLoadEncryptedThumbnail()}get isUploading(){return this.isPending&&this._entry.pendingEvent.status===V.UploadingAttachments}get uploadPercentage(){let{pendingEvent:e}=this._entry;return e&&Math.round(e.attachmentsSentBytes/e.attachmentsTotalBytes*100)}get sendStatus(){let{pendingEvent:e}=this._entry;switch(e?.status){case V.Waiting:return this.i18n`Waiting`;case V.EncryptingAttachments:case V.Encrypting:return this.i18n`Encrypting`;case V.UploadingAttachments:return this.i18n`Uploading`;case V.Sending:return this.i18n`Sending`;case V.Error:return this.i18n`Error: ${e.error.message}`;default:return""}}get thumbnailUrl(){if(this._decryptedThumbnail)return this._decryptedThumbnail.url;{let e=this._getContent().info?.thumbnail_url;if(e)return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}if(this._entry.isPending){let e=this._entry.pendingEvent.getAttachment("info.thumbnail_url");return e&&e.localPreview.url}if(this._isMainResourceImage()){if(this._decryptedFile)return this._decryptedFile.url;{let e=this._getContent()?.url;if(typeof e=="string")return this._mediaRepository.mxcUrlThumbnail(e,this.width,this.height,"scale")}}return""}get width(){let e=this._getContent()?.info;return Math.round(e?.w*this._scaleFactor())}get height(){let e=this._getContent()?.info;return Math.round(e?.h*this._scaleFactor())}get mimeType(){return this._getContent()?.info?.mimetype}get label(){return this._getContent().body}get error(){return this._error?`Could not load media: ${this._error.message}`:null}setViewError(e){this._error=e,this.emitChange("error")}async _loadEncryptedFile(e){let t=await this._mediaRepository.downloadEncryptedFile(e,!0);if(this.isDisposed){t.dispose();return}return this.track(t)}async _tryLoadEncryptedThumbnail(){try{let e=this._getContent().info?.thumbnail_file,t=this._getContent().file;e?(this._decryptedThumbnail=await this._loadEncryptedFile(e),this.emitChange("thumbnailUrl")):t&&this._isMainResourceImage()&&(this._decryptedFile=await this._loadEncryptedFile(t),this.emitChange("thumbnailUrl"))}catch(e){this._error=e,this.emitChange("error")}}_scaleFactor(){let e=this._getContent()?.info,t=Hg/e?.h,s=Wg/e?.w;return Math.min(s,t,1)}_isMainResourceImage(){return!0}};var Kl=class extends Lr{constructor(e){super(e);this._lightboxUrl=this.urlCreator.urlForSegments([this.navigation.segment("room",this._room.id),this.navigation.segment("lightbox",this._entry.id)])}get lightboxUrl(){return this.isPending?"":this._lightboxUrl}get shape(){return"image"}};var jl=class extends Lr{async loadVideo(){let e=this._getContent().file;e&&!this._decryptedFile&&(this._decryptedFile=await this._loadEncryptedFile(e),this.emitChange("videoUrl"))}get videoUrl(){if(this._decryptedFile)return this._decryptedFile.url;let e=this._getContent()?.url;return typeof e=="string"?this._mediaRepository.mxcUrl(e):""}get shape(){return"video"}_isMainResourceImage(){return!1}};function ah(i,e=2){if(Number.isSafeInteger(i)){let t=Math.min(3,Math.floor(Math.log(i)/Math.log(1024))),s=Math.round(i/Math.pow(1024,t)).toFixed(e);switch(t){case 0:return`${s} bytes`;case 1:return`${s} KB`;case 2:return`${s} MB`;case 3:return`${s} GB`}}return""}var $l=class extends pe{constructor(e){super(e);this._downloadError=null,this._downloading=!1}async download(){if(this._downloading||this.isPending)return;let e=this._getContent(),t=e.body;this._downloading=!0,this.emitChange("label");let s;try{s=await this._mediaRepository.downloadAttachment(e),this.platform.saveFileAs(s,t)}catch(r){this._downloadError=r}finally{s?.dispose(),this._downloading=!1}this.emitChange("label")}get label(){if(this._downloadError)return`Could not download file: ${this._downloadError.message}`;let t=this._getContent().body;if(this._entry.isPending){let{pendingEvent:s}=this._entry;switch(s?.status){case V.Waiting:return this.i18n`Waiting to send ${t}`;case V.EncryptingAttachments:case V.Encrypting:return this.i18n`Encrypting ${t}`;case V.UploadingAttachments:{let r=Math.round(s.attachmentsSentBytes/s.attachmentsTotalBytes*100);return this.i18n`Uploading ${t}: ${r}%`}case V.Sending:case V.Sent:return this.i18n`Sending ${t}`;case V.Error:return this.i18n`Error: could not send ${t}: ${s.error.message}`;default:return`Unknown send status for ${t}`}}else{let s=ah(this._getContent().info?.size);return this._downloading?this.i18n`Downloading ${t} (${s})`:this.i18n`Download ${t} (${s})`}}get shape(){return"file"}};var Hl=class extends pe{get mapsLink(){let e=this._getContent().geo_uri,[t,s]=e.split(":")[1].split(",");return`maps:${t} ${s}`}get label(){return`${this.sender} sent their location, click to see it in maps.`}};var Wl=class extends Ge{get shape(){return"announcement"}get announcement(){let e=this._entry.content;return`${this._entry.displayName||this._entry.sender} named the room "${e?.name}"`}};var zl=class extends Ge{get shape(){return"announcement"}get announcement(){let{sender:e,content:t,prevContent:s,stateKey:r}=this._entry,n=this._entry.displayName||e,o=e===r?n:this._entry.content?.displayname||r,a=t&&t.membership,l=s&&s.membership;if(l==="join"&&a==="join"){if(t.avatar_url!==s.avatar_url)return`${n} changed their avatar`;if(t.displayname!==s.displayname)return t.displayname?`${s.displayname??r} changed their name to ${t.displayname}`:`${r} removed their name (${s.displayname})`}else{if(a==="join")return`${o} joined the room`;if(a==="invite")return`${o} was invited to the room by ${n}`;if(l==="invite"){if(a==="join")return`${o} accepted the invitation to join the room`;if(a==="leave")return`${o} declined the invitation to join the room`}else if(a==="leave"){if(r===e)return`${o} left the room`;{let c=t.reason;return`${o} was kicked from the room by ${n}${c?`: ${c}`:""}`}}else if(a==="ban")return`${o} was banned from the room by ${n}`}return`${e} membership changed to ${t.membership}`}};var Gl=class extends Cr{updateEntry(e,t){let s=super.updateEntry(e,t);return e.eventType!=="m.room.encrypted"?ve.Replace("shape"):s}get shape(){return"message-status"}_getBody(){let e=this._entry.decryptionError,t=e?.code,s;return t==="MEGOLM_NO_SESSION"?s=this.i18n`The sender hasn't sent us the key for this message yet.`:s=e?.message||this.i18n`Could not decrypt message because of unknown reason.`,s}};var Ql=class extends Ge{get shape(){return"announcement"}get announcement(){let e=this._entry.displayName||this._entry.sender;return this.i18n`${e} has enabled end-to-end encryption`}};var Yl=class extends pe{get shape(){return"missing-attachment"}get label(){let e=this._getContent().body;return this._getContent().msgtype==="m.image"?this.i18n`The image ${e} wasn't fully sent previously and could not be recovered.`:this.i18n`The file ${e} wasn't fully sent previously and could not be recovered.`}};function lh(i){return function(t,s){let r=Object.assign({entry:t,emitUpdate:s},i);if(t.isGap)return new Ll(r);if(t.isPending&&t.pendingEvent.isMissingAttachments)return new Yl(r);if(t.eventType)switch(t.eventType){case"m.room.message":{if(t.isRedacted)return new Ki(r);let n=t.content;switch(n&&n.msgtype){case"m.text":case"m.notice":case"m.emote":return new Ul(r);case"m.image":return new Kl(r);case"m.video":return new jl(r);case"m.file":return new $l(r);case"m.location":return new Hl(r);default:return null}}case"m.room.name":return new Wl(r);case"m.room.member":return new zl(r);case"m.room.encrypted":return t.isRedacted?new Ki(r):new Gl(r);case"m.room.encryption":return new Ql(r);default:return null}}}var Dr=class extends S{constructor(e){super(e);let{room:t}=e;this._room=t,this._timelineVM=null,this._tilesCreator=null,this._onRoomChange=this._onRoomChange.bind(this),this._timelineError=null,this._sendError=null,this._composerVM=null,t.isArchived?this._composerVM=new ch(this.childOptions({archivedRoom:t})):this._composerVM=new Cl(this),this._clearUnreadTimout=null,this._closeUrl=this.urlCreator.urlUntilSegment("session")}async load(){this._room.on("change",this._onRoomChange);try{let e=await this._room.openTimeline();this._tilesCreator=lh(this.childOptions({roomVM:this,timeline:e})),this._timelineVM=this.track(new Ni(this.childOptions({tilesCreator:this._tilesCreator,timeline:e}))),this.emitChange("timelineViewModel")}catch(e){console.error(`room.openTimeline(): ${e.message}:
${e.stack}`),this._timelineError=e,this.emitChange("error")}this._clearUnreadAfterDelay()}async _clearUnreadAfterDelay(){if(!(this._room.isArchived||this._clearUnreadTimout)){this._clearUnreadTimout=this.clock.createTimeout(2e3);try{await this._clearUnreadTimout.elapsed(),await this._room.clearUnread(),this._clearUnreadTimout=null}catch(e){if(e.name!=="AbortError")throw e}}}focus(){this._clearUnreadAfterDelay()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange),this._room.isArchived&&this._room.release(),this._clearUnreadTimout&&(this._clearUnreadTimout.abort(),this._clearUnreadTimout=null)}_onRoomChange(){this._room.isArchived&&this._composerVM.emitChange(),this.emitChange()}get kind(){return"room"}get closeUrl(){return this._closeUrl}get name(){return this._room.name||this.i18n`Empty Room`}get id(){return this._room.id}get timelineViewModel(){return this._timelineVM}get isEncrypted(){return this._room.isEncrypted}get error(){return this._timelineError?`Something went wrong loading the timeline: ${this._timelineError.message}`:this._sendError?`Something went wrong sending your message: ${this._sendError.message}`:""}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this._room.avatarColorId)}avatarUrl(e){return we(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}get canLeave(){return this._room.isJoined}leaveRoom(){this._room.leave()}get canForget(){return this._room.isArchived}forgetRoom(){this._room.forget()}get canRejoin(){return this._room.isArchived}rejoinRoom(){this._room.join()}_createTile(e){return this._tilesCreator(e)}async _sendMessage(e,t){if(!this._room.isArchived&&e){try{let s="m.text";e.startsWith("/me ")&&(e=e.substr(4).trim(),s="m.emote"),t?await t.reply(s,e):await this._room.sendEvent("m.room.message",{msgtype:s,body:e})}catch(s){return console.error(`room.sendMessage(): ${s.message}:
${s.stack}`),this._sendError=s,this._timelineError=null,this.emitChange("error"),!1}return!0}return!1}async _pickAndSendFile(){try{let e=await this.platform.openFile();return e?this._sendFile(e):void 0}catch(e){console.error(e)}}async _sendFile(e){let t={body:e.name,msgtype:"m.file"};await this._room.sendEvent("m.room.message",t,{url:this._room.createAttachment(e.blob,e.name)})}async _pickAndSendVideo(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}let e=await this.platform.openFile("video/*");if(!e)return;if(!e.blob.mimeType.startsWith("video/"))return this._sendFile(e);let t;try{t=await this.platform.loadVideo(e.blob)}catch(l){throw l instanceof window.MediaError&&l.code===4?new Error(`this browser does not support videos of type ${e?.blob.mimeType}.`):l}let s={body:e.name,msgtype:"m.video",info:zg(t)},r={url:this._room.createAttachment(t.blob,e.name)},o=await this.platform.settingsStorage.getInt("sentImageSizeLimit")||Math.min(t.maxDimension,800),a=await t.scale(o);s.info.thumbnail_info=ji(a),r["info.thumbnail_url"]=this._room.createAttachment(a.blob,e.name),await this._room.sendEvent("m.room.message",s,r)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}async _pickAndSendPicture(){try{if(!this.platform.hasReadPixelPermission()){alert("Please allow canvas image data access, so we can scale your images down.");return}let e=await this.platform.openFile("image/*");if(!e)return;if(!e.blob.mimeType.startsWith("image/"))return this._sendFile(e);let t=await this.platform.loadImage(e.blob),s=await this.platform.settingsStorage.getInt("sentImageSizeLimit");s&&t.maxDimension>s&&(t=await t.scale(s));let r={body:e.name,msgtype:"m.image",info:ji(t)},n={url:this._room.createAttachment(t.blob,e.name)};if(t.maxDimension>600){let o=await t.scale(400);r.info.thumbnail_info=ji(o),n["info.thumbnail_url"]=this._room.createAttachment(o.blob,e.name)}await this._room.sendEvent("m.room.message",r,n)}catch(e){this._sendError=e,this.emitChange("error"),console.error(e.stack)}}get room(){return this._room}get composerViewModel(){return this._composerVM}openDetailsPanel(){let e=this.navigation.path.until("room");e=e.with(this.navigation.segment("right-panel",!0)),e=e.with(this.navigation.segment("details",!0)),this.navigation.applyPath(e)}startReply(e){this._room.isArchived||this._composerVM.setReplyingTo(e)}};function ji(i){return{w:i.width,h:i.height,mimetype:i.blob.mimeType,size:i.blob.size}}function zg(i){let e=ji(i);return e.duration=i.duration,e}var ch=class extends S{constructor(e){super(e);this._archivedRoom=e.archivedRoom}get description(){return this._archivedRoom.isKicked?this._archivedRoom.kickReason?this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were kicked from the room by ${this._archivedRoom.kickedBy.name}.`:this._archivedRoom.isBanned?this._archivedRoom.kickReason?this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name} because: ${this._archivedRoom.kickReason}`:this.i18n`You were banned from the room by ${this._archivedRoom.kickedBy.name}.`:this.i18n`You left this room`}get kind(){return"archived"}};var Jl=class extends S{constructor(e){super(e);let{roomIdOrAlias:t,session:s}=e;this._session=s,this.roomIdOrAlias=t,this._error=null,this._busy=!1}get error(){return this._error?.message}async join(){this._busy=!0,this.emitChange("busy");try{let e=await this._session.joinRoom(this.roomIdOrAlias);this.navigation.push("room",e)}catch(e){this._error=e,this._busy=!1,this.emitChange("error")}}get busy(){return this._busy}get kind(){return"unknown"}};var Xl=class extends S{constructor(e){super(e);let{invite:t,mediaRepository:s}=e;this._invite=t,this._mediaRepository=s,this._onInviteChange=this._onInviteChange.bind(this),this._error=null,this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._invite.on("change",this._onInviteChange),this._inviter=null,this._invite.inviter&&(this._inviter=new uh(this._invite.inviter,s,this.platform)),this._roomDescription=this._createRoomDescription()}get kind(){return"invite"}get closeUrl(){return this._closeUrl}get name(){return this._invite.name}get id(){return this._invite.id}get isEncrypted(){return this._invite.isEncrypted}get isDirectMessage(){return this._invite.isDirectMessage}get inviter(){return this._inviter}get busy(){return this._invite.accepting||this._invite.rejecting}get error(){return this._error?`Something went wrong: ${this._error.message}`:""}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this._invite.avatarColorId)}avatarUrl(e){return we(this._invite.avatarUrl,e,this.platform,this._mediaRepository)}_createRoomDescription(){let e=[];return this._invite.isPublic?e.push("Public room"):e.push("Private room"),this._invite.canonicalAlias&&e.push(this._invite.canonicalAlias),e.join(" \u2022 ")}get roomDescription(){return this._roomDescription}get avatarTitle(){return this.name}focus(){}async accept(){try{await this._invite.accept()}catch(e){this._error=e,this.emitChange("error")}}async reject(){try{await this._invite.reject()}catch(e){this._error=e,this.emitChange("error")}}_onInviteChange(){this.emitChange()}dispose(){super.dispose(),this._invite.off("change",this._onInviteChange)}},uh=class{constructor(e,t,s){this._member=e,this._mediaRepository=t,this._platform=s}get id(){return this._member.userId}get name(){return this._member.name}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this._member.userId)}avatarUrl(e){return we(this._member.avatarUrl,e,this._platform,this._mediaRepository)}get avatarTitle(){return this.name}};var Zl=class extends S{constructor(e){super(e);this._eventId=e.eventId,this._unencryptedImageUrl=null,this._decryptedImage=null,this._closeUrl=this.urlCreator.urlUntilSegment("room"),this._eventEntry=null,this._date=null,this._subscribeToEvent(e.room,e.eventId)}_subscribeToEvent(e,t){let s=e.observeEvent(t);this.track(s.subscribe(r=>{this._loadEvent(e,r)})),this._loadEvent(e,s.get())}async _loadEvent(e,t){if(!t)return;let{mediaRepository:s}=e;this._eventEntry=t;let{content:r}=this._eventEntry;this._date=this._eventEntry.timestamp?new Date(this._eventEntry.timestamp):null,r.url?(this._unencryptedImageUrl=s.mxcUrl(r.url),this.emitChange("imageUrl")):r.file&&(this._decryptedImage=this.track(await s.downloadEncryptedFile(r.file)),this.emitChange("imageUrl"))}get imageWidth(){return this._eventEntry?.content?.info?.w}get imageHeight(){return this._eventEntry?.content?.info?.h}get name(){return this._eventEntry?.content?.body}get sender(){return this._eventEntry?.displayName}get imageUrl(){return this._decryptedImage?this._decryptedImage.url:this._unencryptedImageUrl?this._unencryptedImageUrl:""}get date(){return this._date&&this._date.toLocaleDateString({},{weekday:"long",year:"numeric",month:"long",day:"numeric"})}get time(){return this._date&&this._date.toLocaleTimeString({},{hour:"numeric",minute:"2-digit"})}get closeUrl(){return this._closeUrl}close(){this.platform.history.pushUrl(this.closeUrl)}};var be=fe("Disconnected","Connecting","FirstSync","Sending","Syncing","SyncError"),ec=class extends S{constructor(e){super(e);let{sync:t,reconnector:s,session:r}=e;this._sync=t,this._reconnector=s,this._status=this._calculateState(s.connectionStatus.get(),t.status.get()),this._session=r,this._setupSessionBackupUrl=this.urlCreator.urlForSegment("settings"),this._dismissSecretStorage=!1}start(){let e=()=>this._updateStatus();this.track(this._sync.status.subscribe(e)),this.track(this._reconnector.connectionStatus.subscribe(e)),this.track(this._session.needsSessionBackup.subscribe(()=>{this.emitChange()}))}get setupSessionBackupUrl(){return this._setupSessionBackupUrl}get isShown(){return this._session.needsSessionBackup.get()&&!this._dismissSecretStorage||this._status!==be.Syncing}get statusLabel(){switch(this._status){case be.Disconnected:{let e=Math.round(this._reconnector.retryIn/1e3);return this.i18n`Disconnected, trying to reconnect in ${e}s`}case be.Connecting:return this.i18n`Trying to reconnect now`;case be.FirstSync:return this.i18n`Catching up with your conversations`;case be.SyncError:return this.i18n`Sync failed because of ${this._sync.error}`}return this._session.needsSessionBackup.get()?this.i18n`Set up session backup to decrypt older messages.`:""}get isWaiting(){switch(this._status){case be.Connecting:case be.FirstSync:return!0;default:return!1}}_updateStatus(){let e=this._calculateState(this._reconnector.connectionStatus.get(),this._sync.status.get());e!==this._status&&(e===be.Disconnected?this._retryTimer=this.track(this.clock.createInterval(()=>{this.emitChange("statusLabel")},1e3)):this._retryTimer=this.disposeTracked(this._retryTimer),this._status=e,this.emitChange())}_calculateState(e,t){if(e!==Bt.Online)switch(e){case Bt.Reconnecting:return be.Connecting;case Bt.Waiting:return be.Disconnected}else if(t!==B.Syncing)switch(t){case B.InitialSync:case B.CatchupSync:return be.FirstSync;case B.Stopped:return be.SyncError}else return be.Syncing}get isConnectNowShown(){return this._status===be.Disconnected}get isSecretStorageShown(){return this._status===be.Syncing&&this._session.needsSessionBackup.get()&&!this._dismissSecretStorage}get canDismiss(){return this.isSecretStorageShown}dismiss(){this.isSecretStorageShown&&(this._dismissSecretStorage=!0,this.emitChange())}connectNow(){this.isConnectNowShown&&this._reconnector.tryNow()}};function dh(i){return i.map((e,t)=>{if(!i.slice(0,t).includes(e))return e})}var tc=class extends S{constructor(e){super(e);this._width=e.width,this._height=e.height,this._createRoomViewModelObservable=e.createRoomViewModelObservable,this._selectedIndex=0,this._viewModelsObservables=[],this._setupNavigation()}_setupNavigation(){let e=this.navigation.observe("empty-grid-tile");this.track(e.subscribe(s=>{typeof s=="number"&&this._setFocusIndex(s)})),typeof e.get()=="number"&&(this._selectedIndex=e.get());let t=this.navigation.observe("room");this.track(t.subscribe(s=>{s&&this._setFocusRoom(s)}))}roomViewModelAt(e){return this._viewModelsObservables[e]?.get()}get focusIndex(){return this._selectedIndex}get width(){return this._width}get height(){return this._height}_switchToRoom(e){let t=this.navigation.path.until("rooms");t=t.with(this.navigation.segment("room",e)),t=vr(this.navigation,t),this.navigation.applyPath(t)}focusTile(e){if(e===this._selectedIndex)return;let t=this._viewModelsObservables[e];t?this._switchToRoom(t.id):this.navigation.push("empty-grid-tile",e)}initializeRoomIdsAndTransferVM(e,t){e=dh(e);let s=!1;if(t){let n=e.indexOf(t.id);n!==-1&&(this._viewModelsObservables[n]=this.track(t),t.subscribe(o=>this._refreshRoomViewModel(o)),s=!0)}this.setRoomIds(e);let r=this.navigation.path.get("room");if(r){let n=this._viewModelsObservables.findIndex(o=>o&&o.id===r.value);n!==-1&&(this._selectedIndex=n)}return s}setRoomIds(e){e=dh(e);let t=!1,s=this._height*this._width;for(let r=0;r<s;r+=1){let n=e[r],o=this._viewModelsObservables[r];if(!o&&n||o&&o.id!==n){if(o&&(this._viewModelsObservables[r]=this.disposeTracked(o)),n){let a=this._createRoomViewModelObservable(n);this._viewModelsObservables[r]=this.track(a),a.subscribe(l=>this._refreshRoomViewModel(l)),a.initialize()}t=!0}}return t&&this.emitChange(),t}_refreshRoomViewModel(e){this.emitChange(),e?.focus()}releaseRoomViewModel(e){let t=this._viewModelsObservables.findIndex(s=>s&&s.id===e);if(t!==-1){let s=this._viewModelsObservables[t];return this.untrack(s),s.unsubscribeAll(),this._viewModelsObservables[t]=null,s}}_setFocusIndex(e){if(e===this._selectedIndex||e>=this._width*this._height)return;this._selectedIndex=e,this._viewModelsObservables[this._selectedIndex]?.get()?.focus(),this.emitChange("focusIndex")}_setFocusRoom(e){let t=this._viewModelsObservables.findIndex(s=>s?.id===e);t>=0&&this._setFocusIndex(t)}};var Te=fe("Enabled","SetupKey","SetupPhrase","Pending"),sc=class extends S{constructor(e){super(e);this._session=e.session,this._error=null,this._isBusy=!1,this._dehydratedDeviceId=void 0,this._status=void 0,this._reevaluateStatus(),this.track(this._session.hasSecretStorageKey.subscribe(()=>{this._reevaluateStatus()&&this.emitChange("status")}))}_reevaluateStatus(){if(this._isBusy)return!1;let e,t=this._session.hasSecretStorageKey.get();t===!0?e=this._session.sessionBackup?Te.Enabled:Te.SetupKey:t===!1?e=Te.SetupKey:e=Te.Pending;let s=e!==this._status;return this._status=e,s}get decryptAction(){return this.i18n`Set up`}get purpose(){return this.i18n`set up session backup`}offerDehydratedDeviceSetup(){return!0}get dehydratedDeviceId(){return this._dehydratedDeviceId}get isBusy(){return this._isBusy}get backupVersion(){return this._session.sessionBackup?.version}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===Te.SetupKey&&(this._status=Te.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===Te.SetupPhrase&&(this._status=Te.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t,s){if(t)try{this._isBusy=!0,this.emitChange("isBusy");let r=await this._session.enableSecretStorage(e,t);s&&(this._dehydratedDeviceId=await this._session.setupDehydratedDevice(r))}catch(r){console.error(r),this._error=r,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}enterSecurityPhrase(e,t){this._enterCredentials(es.Passphrase,e,t)}enterSecurityKey(e,t){this._enterCredentials(es.RecoveryKey,e,t)}async disable(){try{this._isBusy=!0,this.emitChange("isBusy"),await this._session.disableSecretStorage()}catch(e){console.error(e),this._error=e,this.emitChange("error")}finally{this._isBusy=!1,this._reevaluateStatus(),this.emitChange("")}}};var mh=class{constructor(){this.supported=null,this.enabled=!1,this.updating=!1,this.enabledOnServer=null,this.serverError=null}};function Gg(i){let e=4,t=Math.ceil(i.length/e),s="";for(let r=0;r<t;r+=1)s+=(s.length?" ":"")+i.slice(r*e,(r+1)*e);return s}var rc=class extends S{constructor(e){super(e);this._updateService=e.updateService;let{sessionContainer:t}=e;this._sessionContainer=t,this._sessionBackupViewModel=this.track(new sc(this.childOptions({session:this._session}))),this._closeUrl=this.urlCreator.urlUntilSegment("session"),this._estimate=null,this.sentImageSizeLimit=null,this.minSentImageSizeLimit=400,this.maxSentImageSizeLimit=4e3,this.pushNotifications=new mh,this._isLoggingOut=!1}get _session(){return this._sessionContainer.session}async logout(){this._isLoggingOut=!0,await this._sessionContainer.logout(),this.emitChange("isLoggingOut"),this.navigation.push("session",!0)}get isLoggingOut(){return this._isLoggingOut}setSentImageSizeLimit(e){e>this.maxSentImageSizeLimit||e<this.minSentImageSizeLimit?(this.sentImageSizeLimit=null,this.platform.settingsStorage.remove("sentImageSizeLimit")):(this.sentImageSizeLimit=Math.round(e),this.platform.settingsStorage.setInt("sentImageSizeLimit",e)),this.emitChange("sentImageSizeLimit")}async load(){this._estimate=await this.platform.estimateStorageUsage(),this.sentImageSizeLimit=await this.platform.settingsStorage.getInt("sentImageSizeLimit"),this.pushNotifications.supported=await this.platform.notificationService.supportsPush(),this.pushNotifications.enabled=await this._session.arePushNotificationsEnabled(),this.emitChange("")}get closeUrl(){return this._closeUrl}get fingerprintKey(){let e=this._session.fingerprintKey;return e?Gg(e):null}get deviceId(){return this._session.deviceId}get userId(){return this._session.userId}get version(){let{updateService:e}=this.platform;return e?`${e.version} (${e.buildHash})`:this.i18n`development version`}checkForUpdate(){this.platform.updateService?.checkForUpdate()}get showUpdateButton(){return!!this.platform.updateService}get sessionBackupViewModel(){return this._sessionBackupViewModel}get storageQuota(){return this._formatBytes(this._estimate?.quota)}get storageUsage(){return this._formatBytes(this._estimate?.usage)}_formatBytes(e){return typeof e=="number"?Math.round(e/(1024*1024)).toFixed(1)+" MB":this.i18n`unknown`}async exportLogs(){let e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async togglePushNotifications(){this.pushNotifications.updating=!0,this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null,this.emitChange("pushNotifications.updating");try{await this._session.enablePushNotifications(!this.pushNotifications.enabled)&&(this.pushNotifications.enabled=!this.pushNotifications.enabled,this.pushNotifications.enabled&&this.platform.notificationService.showNotification(this.i18n`Push notifications are now enabled`))}finally{this.pushNotifications.updating=!1,this.emitChange("pushNotifications.updating")}}async checkPushEnabledOnServer(){this.pushNotifications.enabledOnServer=null,this.pushNotifications.serverError=null;try{this.pushNotifications.enabledOnServer=await this._session.checkPusherEnabledOnHomeserver(),this.emitChange("pushNotifications.enabledOnServer")}catch(e){this.pushNotifications.serverError=e,this.emitChange("pushNotifications.serverError")}}};var $i=class extends te{constructor(e,t){super(null);this._statusSubscription=null,this._sessionViewModel=e,this.id=t}async initialize(){let{session:e}=this._sessionViewModel._sessionContainer,t=await e.observeRoomStatus(this.id);this.set(await this._statusToViewModel(t.get())),this._statusSubscription=t.subscribe(async s=>{this.get()?.dispose(),this.set(await this._statusToViewModel(s))})}async _statusToViewModel(e){return e.invited?this._sessionViewModel._createInviteViewModel(this.id):e.joined?this._sessionViewModel._createRoomViewModel(this.id):e.archived?await this._sessionViewModel._createArchivedRoomViewModel(this.id):this._sessionViewModel._createUnknownRoomViewModel(this.id)}dispose(){this._statusSubscription&&(this._statusSubscription=this._statusSubscription()),this.unsubscribeAll(),this.get()?.dispose()}};var ic=class extends S{constructor(e){super(e);this._room=e.room,this._onRoomChange=this._onRoomChange.bind(this),this._room.on("change",this._onRoomChange)}get type(){return"room-details"}get shouldShowBackButton(){return!1}get previousSegmentName(){return!1}get roomId(){return this._room.id}get canonicalAlias(){return this._room.canonicalAlias}get name(){return this._room.name}get isEncrypted(){return!!this._room.isEncrypted}get memberCount(){return this._room.joinedMemberCount}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this._room.avatarColorId)}avatarUrl(e){return we(this._room.avatarUrl,e,this.platform,this._room.mediaRepository)}get avatarTitle(){return this.name}_onRoomChange(){this.emitChange()}dispose(){super.dispose(),this._room.off("change",this._onRoomChange)}openPanel(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}};var nc=class extends S{constructor(e){super(e);this._member=this._options.member,this._mediaRepository=e.mediaRepository,this._previousName=null,this._nameChanged=!0}get name(){return`${this._member.name}${this._disambiguationPart}`}get _disambiguationPart(){return this._disambiguate?` (${this.userId})`:""}get userId(){return this._member.userId}get previousName(){return this._previousName}get nameChanged(){return this._nameChanged}get detailsUrl(){let e=this.navigation.path.get("room").value;return`${this.urlCreator.openRoomActionUrl(e)}/member/${this._member.userId}`}_updatePreviousName(e){let t=this._member.name;t!==e?(this._previousName=t,this._nameChanged=!0):this._nameChanged=!1}setDisambiguation(e){this._disambiguate=e,this.emitChange()}updateFrom(e){this._updatePreviousName(e.name),this._member=e}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this.userId)}avatarUrl(e){return we(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}};function hh(i){let e=new Intl.Collator,t=s=>s.charAt(0)==="@"?s.slice(1):s;return function(r,n){let o=i.getUserLevel(r.userId),a=i.getUserLevel(n.userId);if(o!==a)return a-o;let l=t(r.name),c=t(n.name);return e.compare(l,c)}}var oc=class{constructor(){this._map=new Map}_unDisambiguate(e,t){let s=t.indexOf(e);if(s!==-1){let[r]=t.splice(s,1);r.setDisambiguation(!1)}}_handlePreviousName(e){let t=e.previousName;if(typeof t!="string")return;let s=this._map.get(t);if(Array.isArray(s)){if(this._unDisambiguate(e,s),s.length===1){let r=s[0];r.setDisambiguation(!1),this._map.set(t,r)}}else this._map.delete(t)}_updateMap(e){let t=e.name,s=this._map.get(t);if(s){if(Array.isArray(s))return s.findIndex(r=>r.userId===e.userId)!==-1?void 0:(s.push(e),s);if(e.userId!==s.userId){let r=[s,e];return this._map.set(t,r),r}}else this._map.set(t,e)}disambiguate(e){if(!e.nameChanged)return;this._handlePreviousName(e),this._updateMap(e)?.forEach(s=>s.setDisambiguation(!0))}};var ac=class extends S{constructor(e){super(e);let t=e.members,s=e.powerLevelsObservable;this.track(s.subscribe(()=>{}));let r=s.get();this.memberTileViewModels=this._mapTileViewModels(t.members.filterValues(n=>n.membership==="join")).sortValues(hh(r)),this.nameDisambiguator=new oc,this.mediaRepository=e.mediaRepository}get type(){return"member-list"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"details"}_mapTileViewModels(e){let t=(r,n)=>{let o=this.mediaRepository,a=new nc(this.childOptions({member:r,emitChange:n,mediaRepository:o}));return this.nameDisambiguator.disambiguate(a),a},s=(r,n,o)=>{r.updateFrom(o),this.nameDisambiguator.disambiguate(r)};return e.mapValues(t,s)}};var lc=class extends S{constructor(e){super(e);this._observableMember=e.observableMember,this._mediaRepository=e.mediaRepository,this._member=this._observableMember.get(),this._isEncrypted=e.isEncrypted,this._powerLevelsObservable=e.powerLevelsObservable,this.track(this._powerLevelsObservable.subscribe(()=>this._onPowerLevelsChange())),this.track(this._observableMember.subscribe(()=>this._onMemberChange()))}get name(){return this._member.name}get userId(){return this._member.userId}get type(){return"member-details"}get shouldShowBackButton(){return!0}get previousSegmentName(){return"members"}get role(){return this.powerLevel>=100?this.i18n`Admin`:this.powerLevel>=50?this.i18n`Moderator`:this.powerLevel===0?this.i18n`Default`:this.i18n`Custom (${this.powerLevel})`}_onMemberChange(){this._member=this._observableMember.get(),this.emitChange("member")}_onPowerLevelsChange(){this.emitChange("role")}get avatarLetter(){return Z(this.name)}get avatarColorNumber(){return ee(this.userId)}avatarUrl(e){return we(this._member.avatarUrl,e,this.platform,this._mediaRepository)}get avatarTitle(){return this.name}get isEncrypted(){return this._isEncrypted}get powerLevel(){return this._powerLevelsObservable.get()?.getUserLevel(this._member.userId)}get linkToUser(){return`https://matrix.to/#/${this._member.userId}`}};var cc=class extends S{constructor(e){super(e);this._room=e.room,this._members=null,this._setupNavigation()}get activeViewModel(){return this._activeViewModel}async _getMemberListArguments(){this._members||(this._members=await this._room.loadMemberList(),this.track(()=>this._members.release()));let e=this._room,t=await this._room.observePowerLevels();return{members:this._members,powerLevelsObservable:t,mediaRepository:e.mediaRepository}}async _getMemberDetailsArguments(){let t=this.navigation.path.get("member").value,s=await this._room.observeMember(t);if(!s)return!1;let r=this._room.isEncrypted,n=await this._room.observePowerLevels();return{observableMember:s,isEncrypted:r,powerLevelsObservable:n,mediaRepository:this._room.mediaRepository}}_setupNavigation(){this._hookUpdaterToSegment("details",ic,()=>({room:this._room})),this._hookUpdaterToSegment("members",ac,()=>this._getMemberListArguments()),this._hookUpdaterToSegment("member",lc,()=>this._getMemberDetailsArguments(),()=>{let e=`${this.urlCreator.urlUntilSegment("room")}/members`;this.urlCreator.pushUrl(e)})}_hookUpdaterToSegment(e,t,s,r){let n=this.navigation.observe(e),o=this._setupUpdater(e,t,s,r);this.track(n.subscribe(o))}_setupUpdater(e,t,s,r){let n=async(o=!1)=>{if(o||(this._activeViewModel=this.disposeTracked(this._activeViewModel)),!!this.navigation.path.get(e)?.value){let l=await s();if(!l&&r){r();return}this._activeViewModel=this.track(new t(this.childOptions(l)))}this.emitChange("activeViewModel")};return n(!0),n}closePanel(){let e=this.navigation.path.until("room");this.navigation.applyPath(e)}showPreviousPanel(){let e=this.activeViewModel.previousSegmentName;if(e){let t=this.navigation.path.until("room");t=t.with(this.navigation.segment("right-panel",!0)),t=t.with(this.navigation.segment(e,!0)),this.navigation.applyPath(t)}}};var Hi=class extends S{constructor(e){super(e);let{sessionContainer:t}=e;this._sessionContainer=this.track(t),this._sessionStatusViewModel=this.track(new ec(this.childOptions({sync:t.sync,reconnector:t.reconnector,session:t.session}))),this._leftPanelViewModel=this.track(new Ml(this.childOptions({invites:this._sessionContainer.session.invites,rooms:this._sessionContainer.session.rooms}))),this._settingsViewModel=null,this._roomViewModelObservable=null,this._gridViewModel=null,this._setupNavigation()}_setupNavigation(){let e=this.navigation.observe("rooms");this.track(e.subscribe(o=>{this._updateGrid(o)})),e.get()&&this._updateGrid(e.get());let t=this.navigation.observe("room");this.track(t.subscribe(o=>{this._gridViewModel||this._updateRoom(o),this._updateRightPanel()})),this._gridViewModel||this._updateRoom(t.get());let s=this.navigation.observe("settings");this.track(s.subscribe(o=>{this._updateSettings(o)})),this._updateSettings(s.get());let r=this.navigation.observe("lightbox");this.track(r.subscribe(o=>{this._updateLightbox(o)})),this._updateLightbox(r.get());let n=this.navigation.observe("right-panel");this.track(n.subscribe(()=>this._updateRightPanel())),this._updateRightPanel()}get id(){return this._sessionContainer.sessionId}start(){this._sessionStatusViewModel.start()}get activeMiddleViewModel(){return this._roomViewModelObservable?.get()||this._gridViewModel||this._settingsViewModel}get roomGridViewModel(){return this._gridViewModel}get leftPanelViewModel(){return this._leftPanelViewModel}get sessionStatusViewModel(){return this._sessionStatusViewModel}get settingsViewModel(){return this._settingsViewModel}get currentRoomViewModel(){return this._roomViewModelObservable?.get()}get rightPanelViewModel(){return this._rightPanelViewModel}_updateGrid(e){let t=!(this._gridViewModel&&e),s=this.navigation.path.get("room");if(e)this._gridViewModel?this._gridViewModel.setRoomIds(e):(this._gridViewModel=this.track(new tc(this.childOptions({width:3,height:2,createRoomViewModelObservable:r=>new $i(this,r)}))),this._roomViewModelObservable?.unsubscribeAll(),this._gridViewModel.initializeRoomIdsAndTransferVM(e,this._roomViewModelObservable)?this._roomViewModelObservable=this.untrack(this._roomViewModelObservable):this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)));else if(this._gridViewModel&&!e){if(s){let r=this._gridViewModel.releaseRoomViewModel(s.value);r&&(this._roomViewModelObservable=this.track(r),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}))}this._gridViewModel=this.disposeTracked(this._gridViewModel)}t&&this.emitChange("activeMiddleViewModel")}_createRoomViewModel(e){let t=this._sessionContainer.session.rooms.get(e);if(t){let s=new Dr(this.childOptions({room:t}));return s.load(),s}return null}_createUnknownRoomViewModel(e){return new Jl(this.childOptions({roomIdOrAlias:e,session:this._sessionContainer.session}))}async _createArchivedRoomViewModel(e){let t=await this._sessionContainer.session.loadArchivedRoom(e);if(t){let s=new Dr(this.childOptions({room:t}));return s.load(),s}return null}_createInviteViewModel(e){let t=this._sessionContainer.session.invites.get(e);return t?new Xl(this.childOptions({invite:t,mediaRepository:this._sessionContainer.session.mediaRepository})):null}_updateRoom(e){if(this._roomViewModelObservable?.id===e)return;if(this._roomViewModelObservable&&(this._roomViewModelObservable=this.disposeTracked(this._roomViewModelObservable)),!e){this.emitChange("activeMiddleViewModel");return}let t=new $i(this,e);this._roomViewModelObservable=this.track(t),this._roomViewModelObservable.subscribe(()=>{this.emitChange("activeMiddleViewModel")}),t.initialize()}_updateSettings(e){this._settingsViewModel&&(this._settingsViewModel=this.disposeTracked(this._settingsViewModel)),e&&(this._settingsViewModel=this.track(new rc(this.childOptions({sessionContainer:this._sessionContainer}))),this._settingsViewModel.load()),this.emitChange("activeMiddleViewModel")}_updateLightbox(e){if(this._lightboxViewModel&&(this._lightboxViewModel=this.disposeTracked(this._lightboxViewModel)),e){let t=this._roomFromNavigation();this._lightboxViewModel=this.track(new Zl(this.childOptions({eventId:e,room:t})))}this.emitChange("lightboxViewModel")}get lightboxViewModel(){return this._lightboxViewModel}_roomFromNavigation(){let e=this.navigation.path.get("room")?.value;return this._sessionContainer.session.rooms.get(e)}_updateRightPanel(){if(this._rightPanelViewModel=this.disposeTracked(this._rightPanelViewModel),!!this.navigation.path.get("right-panel")?.value){let t=this._roomFromNavigation();this._rightPanelViewModel=this.track(new cc(this.childOptions({room:t})))}this.emitChange("rightPanelViewModel")}};var uc=class extends S{constructor(e){super();this._accountSetup=e,this._dehydratedDevice=void 0,this._decryptDehydratedDeviceViewModel=void 0,this._accountSetup.encryptedDehydratedDevice&&(this._decryptDehydratedDeviceViewModel=new ph(this,t=>{this._dehydratedDevice=t,this._decryptDehydratedDeviceViewModel=void 0,this.emitChange("deviceDecrypted")}))}get decryptDehydratedDeviceViewModel(){return this._decryptDehydratedDeviceViewModel}get deviceDecrypted(){return!!this._dehydratedDevice}get dehydratedDeviceId(){return this._accountSetup.encryptedDehydratedDevice.deviceId}finish(){this._accountSetup.finish(this._dehydratedDevice)}},ph=class extends S{constructor(e,t){super();this._accountSetupViewModel=e,this._isBusy=!1,this._status=Te.SetupKey,this._error=void 0,this._decryptedCallback=t}get decryptAction(){return this.i18n`Restore`}get purpose(){return this.i18n`claim your dehydrated device`}get offerDehydratedDeviceSetup(){return!1}get dehydratedDeviceId(){return this._accountSetupViewModel._dehydratedDevice?.deviceId}get isBusy(){return this._isBusy}get backupVersion(){return 0}get status(){return this._status}get error(){return this._error?.message}showPhraseSetup(){this._status===Te.SetupKey&&(this._status=Te.SetupPhrase,this.emitChange("status"))}showKeySetup(){this._status===Te.SetupPhrase&&(this._status=Te.SetupKey,this.emitChange("status"))}async _enterCredentials(e,t){if(t)try{this._isBusy=!0,this.emitChange("isBusy");let{encryptedDehydratedDevice:s}=this._accountSetupViewModel._accountSetup,r=await s.decrypt(e,t);this._decryptedCallback(r)}catch(s){console.error(s),this._error=s,this.emitChange("error")}finally{this._isBusy=!1,this.emitChange("")}}enterSecurityPhrase(e){this._enterCredentials(es.Passphrase,e)}enterSecurityKey(e){this._enterCredentials(es.RecoveryKey,e)}disable(){}};var Vr=class extends S{constructor(e){super(e);let{sessionContainer:t,ready:s,homeserver:r,deleteSessionOnCancel:n}=e;this._sessionContainer=t,this._ready=s,this._homeserver=r,this._deleteSessionOnCancel=n,this._loading=!1,this._error=null,this.backUrl=this.urlCreator.urlForSegment("session",!0),this._accountSetupViewModel=void 0}async start(){if(!this._loading)try{this._loading=!0,this.emitChange("loading"),this._waitHandle=this._sessionContainer.loadStatus.waitFor(s=>(s===A.AccountSetup?this._accountSetupViewModel=new uc(this._sessionContainer.accountSetup):this._accountSetupViewModel=void 0,this.emitChange("loadLabel"),s===A.FirstSync&&this._sessionContainer.sync.status.get()===B.CatchupSync||s===A.LoginFailed||s===A.Error||s===A.Ready));try{await this._waitHandle.promise}catch{return}let e=this._sessionContainer.loadStatus.get(),t=this._sessionContainer.loadError;if(e===A.FirstSync||e===A.Ready){let s=this._sessionContainer;this._sessionContainer=null,this._ready(s)}t&&console.error("session load error",t)}catch(e){this._error=e,console.error("error thrown during session load",e.stack)}finally{this._loading=!1,this.emitChange("loading")}}dispose(){this._sessionContainer&&(this._sessionContainer.dispose(),this._sessionContainer=null),this._waitHandle&&(this._waitHandle.dispose(),this._waitHandle=null)}get loading(){let e=this._sessionContainer;return e&&e.loadStatus.get()===A.AccountSetup?!1:this._loading}get loadLabel(){let e=this._sessionContainer,t=this._getError();if(t||e&&e.loadStatus.get()===A.Error)return`Something went wrong: ${t&&t.message}.`;if(e)switch(e.loadStatus.get()){case A.QueryAccount:return"Querying account encryption setup\u2026";case A.AccountSetup:return"";case A.SessionSetup:return"Setting up your encryption keys\u2026";case A.Loading:return"Loading your conversations\u2026";case A.FirstSync:return"Getting your conversations from the server\u2026";default:return this._sessionContainer.loadStatus.get()}return"Preparing\u2026"}_getError(){return this._error||this._sessionContainer?.loadError}get hasError(){return!!this._getError()}async exportLogs(){let e=await this.logger.export();this.platform.saveFileAs(e.asBlob(),`hydrogen-logs-${this.platform.clock.now()}.json`)}async logout(){await this._sessionContainer.logout(),this.navigation.push("session",!0)}get accountSetupViewModel(){return this._accountSetupViewModel}};var dc=class extends S{constructor(e){super(e);let{loginOptions:t,attemptLogin:s}=e;this._loginOptions=t,this._attemptLogin=s,this._isBusy=!1,this._errorMessage=""}get isBusy(){return this._isBusy}get errorMessage(){return this._errorMessage}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async login(e,t){this._errorMessage="",this.emitChange("errorMessage");let s=await this._attemptLogin(this._loginOptions.password(e,t)),r="";switch(s){case je.Credentials:r=this.i18n`Your username and/or password don't seem to be correct.`;break;case je.Connection:r=this.i18n`Can't connect to ${this._loginOptions.homeserver}.`;break;case je.Unknown:r=this.i18n`Something went wrong while checking your login and password.`;break}r&&this._showError(r)}};var mc=class extends S{constructor(e){super(e);this._sso=e.loginOptions.sso,this._isBusy=!1}get isBusy(){return this._isBusy}setBusy(e){this._isBusy=e,this.emitChange("isBusy")}async startSSOLogin(){await this.platform.settingsStorage.setString("sso_ongoing_login_homeserver",this._sso.homeserver);let e=this._sso.createSSORedirectURL(this.urlCreator.createSSOCallbackURL());this.platform.openUrl(e)}};var hc=class extends S{constructor(e){super(e);let{loginToken:t,sessionContainer:s,attemptLogin:r}=e;this._loginToken=t,this._sessionContainer=s,this._attemptLogin=r,this._errorMessage="",this.performSSOLoginCompletion()}get errorMessage(){return this._errorMessage}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}async performSSOLoginCompletion(){if(!this._loginToken)return;let e=await this.platform.settingsStorage.getString("sso_ongoing_login_homeserver"),t;try{t=await this._sessionContainer.queryLogin(e).result}catch(n){this._showError(n.message);return}if(!t.token){this.navigation.push("session");return}let s=await this._attemptLogin(t.token(this._loginToken)),r="";switch(s){case je.Credentials:r=this.i18n`Your login token is invalid.`;break;case je.Connection:r=this.i18n`Can't connect to ${e}.`;break;case je.Unknown:r=this.i18n`Something went wrong while checking your login token.`;break}r&&this._showError(r)}};var pc=class extends S{constructor(e){super(e);let{ready:t,defaultHomeserver:s,createSessionContainer:r,loginToken:n}=e;this._createSessionContainer=r,this._ready=t,this._loginToken=n,this._sessionContainer=this._createSessionContainer(),this._loginOptions=null,this._passwordLoginViewModel=null,this._startSSOLoginViewModel=null,this._completeSSOLoginViewModel=null,this._loadViewModel=null,this._loadViewModelSubscription=null,this._homeserver=s,this._queriedHomeserver=null,this._errorMessage="",this._hideHomeserver=!1,this._isBusy=!1,this._abortHomeserverQueryTimeout=null,this._abortQueryOperation=null,this._initViewModels()}get passwordLoginViewModel(){return this._passwordLoginViewModel}get startSSOLoginViewModel(){return this._startSSOLoginViewModel}get completeSSOLoginViewModel(){return this._completeSSOLoginViewModel}get homeserver(){return this._homeserver}get resolvedHomeserver(){return this._loginOptions?.homeserver}get errorMessage(){return this._errorMessage}get showHomeserver(){return!this._hideHomeserver}get loadViewModel(){return this._loadViewModel}get isBusy(){return this._isBusy}get isFetchingLoginOptions(){return!!this._abortQueryOperation}goBack(){this.navigation.push("session")}async _initViewModels(){this._loginToken?(this._hideHomeserver=!0,this._completeSSOLoginViewModel=this.track(new hc(this.childOptions({sessionContainer:this._sessionContainer,attemptLogin:e=>this.attemptLogin(e),loginToken:this._loginToken}))),this.emitChange("completeSSOLoginViewModel")):await this.queryHomeserver()}_showPasswordLogin(){this._passwordLoginViewModel=this.track(new dc(this.childOptions({loginOptions:this._loginOptions,attemptLogin:e=>this.attemptLogin(e)}))),this.emitChange("passwordLoginViewModel")}_showSSOLogin(){this._startSSOLoginViewModel=this.track(new mc(this.childOptions({loginOptions:this._loginOptions}))),this.emitChange("startSSOLoginViewModel")}_showError(e){this._errorMessage=e,this.emitChange("errorMessage")}_setBusy(e){this._isBusy=e,this._passwordLoginViewModel?.setBusy(e),this._startSSOLoginViewModel?.setBusy(e),this.emitChange("isBusy")}async attemptLogin(e){this._setBusy(!0),this._sessionContainer.startWithLogin(e,{inspectAccountSetup:!0});let t=this._sessionContainer.loadStatus;return await t.waitFor(n=>n!==A.Login).promise,this._setBusy(!1),t.get()===A.LoginFailed?this._sessionContainer.loginFailure:(this._hideHomeserver=!0,this.emitChange("hideHomeserver"),this._disposeViewModels(),this._createLoadViewModel(),null)}_createLoadViewModel(){this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription),this._loadViewModel=this.disposeTracked(this._loadViewModel),this._loadViewModel=this.track(new Vr(this.childOptions({ready:e=>{this._sessionContainer=null,this._ready(e)},sessionContainer:this._sessionContainer,homeserver:this._homeserver}))),this._loadViewModel.start(),this.emitChange("loadViewModel"),this._loadViewModelSubscription=this.track(this._loadViewModel.disposableOn("change",()=>{this._loadViewModel.loading||(this._loadViewModelSubscription=this.disposeTracked(this._loadViewModelSubscription)),this._setBusy(!1)}))}_disposeViewModels(){this._startSSOLoginViewModel=this.disposeTracked(this._ssoLoginViewModel),this._passwordLoginViewModel=this.disposeTracked(this._passwordLoginViewModel),this._completeSSOLoginViewModel=this.disposeTracked(this._completeSSOLoginViewModel),this.emitChange("disposeViewModels")}async setHomeserver(e){this._homeserver=e,this._loginOptions=null,this._queriedHomeserver=null,this._showError(""),this._disposeViewModels(),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange(),this.disposeTracked(this._abortHomeserverQueryTimeout);let t=this.clock.createTimeout(1e3);this._abortHomeserverQueryTimeout=this.track(()=>t.abort());try{await t.elapsed()}catch(s){if(s.name==="AbortError")return;throw s}this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this.queryHomeserver()}async queryHomeserver(){if(!(this._homeserver===this._queriedHomeserver||this._homeserver==="")){this._queriedHomeserver=this._homeserver,this._abortHomeserverQueryTimeout=this.disposeTracked(this._abortHomeserverQueryTimeout),this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation);try{let e=this._sessionContainer.queryLogin(this._homeserver);this._abortQueryOperation=this.track(()=>e.abort()),this.emitChange("isFetchingLoginOptions"),this._loginOptions=await e.result,this.emitChange("resolvedHomeserver")}catch(e){if(e.name==="AbortError")return;this._loginOptions=null}finally{this._abortQueryOperation=this.disposeTracked(this._abortQueryOperation),this.emitChange("isFetchingLoginOptions")}this._loginOptions?(this._loginOptions.sso&&this._showSSOLogin(),this._loginOptions.password&&this._showPasswordLogin(),!this._loginOptions.sso&&!this._loginOptions.password&&this._showError("This homeserver supports neither SSO nor password based login flows")):this._showError(`Could not query login methods supported by ${this.homeserver}`)}}dispose(){super.dispose(),this._sessionContainer&&this._sessionContainer.deleteSession()}};var fh=class extends S{constructor(e,t){super(e);this._pickerVM=t,this._sessionInfo=e.sessionInfo,this._isDeleting=!1,this._isClearing=!1,this._error=null,this._exportDataUrl=null}get error(){return this._error&&this._error.message}get id(){return this._sessionInfo.id}get openUrl(){return this.urlCreator.urlForSegment("session",this.id)}get label(){let{userId:e,comment:t}=this._sessionInfo;return t?`${e} (${t})`:e}get sessionInfo(){return this._sessionInfo}get exportDataUrl(){return this._exportDataUrl}get avatarColorNumber(){return ee(this._sessionInfo.userId)}get avatarInitials(){return Z(this._sessionInfo.userId)}},fc=class extends S{constructor(e){super(e);this._sessions=new kt((t,s)=>t.id.localeCompare(s.id)),this._loadViewModel=null,this._error=null}async load(){let e=await this.platform.sessionInfoStorage.getAll();this._sessions.setManyUnsorted(e.map(t=>new fh(this.childOptions({sessionInfo:t}),this)))}get loadViewModel(){return this._loadViewModel}get sessions(){return this._sessions}get cancelUrl(){return this.urlCreator.urlForSegment("login")}};var gh=class extends S{constructor(e){super(e);this._createSessionContainer=e.createSessionContainer,this._error=null,this._sessionPickerViewModel=null,this._sessionLoadViewModel=null,this._loginViewModel=null,this._sessionViewModel=null,this._pendingSessionContainer=null}async load(){this.track(this.navigation.observe("login").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("session").subscribe(()=>this._applyNavigation())),this.track(this.navigation.observe("sso").subscribe(()=>this._applyNavigation())),this._applyNavigation(!0)}async _applyNavigation(e){let t=this.navigation.path.get("login"),s=this.navigation.path.get("session")?.value,r=this.navigation.path.get("sso")?.value;if(t)this.activeSection!=="login"&&this._showLogin();else if(s===!0)this.activeSection!=="picker"&&this._showPicker();else if(s){if(!this._sessionViewModel||this._sessionViewModel.id!==s)if(this._pendingSessionContainer&&this._pendingSessionContainer.sessionId===s){let n=this._pendingSessionContainer;this._pendingSessionContainer=null,this._showSession(n)}else this._pendingSessionContainer&&(this._pendingSessionContainer.dispose(),this._pendingSessionContainer=null),this._showSessionLoader(s)}else if(r)this.urlCreator.normalizeUrl(),this.activeSection!=="login"&&this._showLogin(r);else try{if(!(e&&this.urlCreator.tryRestoreLastUrl())){let n=await this.platform.sessionInfoStorage.getAll();n.length===0?this.navigation.push("login"):n.length===1?this.navigation.push("session",n[0].id):this.navigation.push("session")}}catch(n){this._setSection(()=>this._error=n)}}async _showPicker(){this._setSection(()=>{this._sessionPickerViewModel=new fc(this.childOptions())});try{await this._sessionPickerViewModel.load()}catch(e){this._setSection(()=>this._error=e)}}_showLogin(e){this._setSection(()=>{this._loginViewModel=new pc(this.childOptions({defaultHomeserver:this.platform.config.defaultHomeServer,createSessionContainer:this._createSessionContainer,ready:t=>{this._pendingSessionContainer=t,this.navigation.push("session",t.sessionId)},loginToken:e}))})}_showSession(e){this._setSection(()=>{this._sessionViewModel=new Hi(this.childOptions({sessionContainer:e})),this._sessionViewModel.start()})}_showSessionLoader(e){let t=this._createSessionContainer();t.startWithExistingSession(e),this._setSection(()=>{this._sessionLoadViewModel=new Vr(this.childOptions({sessionContainer:t,ready:s=>this._showSession(s)})),this._sessionLoadViewModel.start()})}get activeSection(){return this._error?"error":this._sessionViewModel?"session":this._loginViewModel?"login":this._sessionPickerViewModel?"picker":this._sessionLoadViewModel?"loading":"redirecting"}_setSection(e){this._error=null,this._sessionPickerViewModel=this.disposeTracked(this._sessionPickerViewModel),this._sessionLoadViewModel=this.disposeTracked(this._sessionLoadViewModel),this._loginViewModel=this.disposeTracked(this._loginViewModel),this._sessionViewModel=this.disposeTracked(this._sessionViewModel),e(),this._sessionPickerViewModel&&this.track(this._sessionPickerViewModel),this._sessionLoadViewModel&&this.track(this._sessionLoadViewModel),this._loginViewModel&&this.track(this._loginViewModel),this._sessionViewModel&&this.track(this._sessionViewModel),this.emitChange("activeSection")}get error(){return this._error}get sessionViewModel(){return this._sessionViewModel}get loginViewModel(){return this._loginViewModel}get sessionPickerViewModel(){return this._sessionPickerViewModel}get sessionLoadViewModel(){return this._sessionLoadViewModel}};export{A as LoadStatus,Jm as Platform,wi as Room,Ps as RoomView,Dr as RoomViewModel,Oi as RootView,gh as RootViewModel,Ii as Session,kd as SessionContainer,qi as SessionView,Hi as SessionViewModel,Gr as Sync,Jt as Timeline,Di as TimelineView,Ni as TimelineViewModel,Cd as createNavigation,wf as createRouter};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! @license DOMPurify 2.3.4 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/2.3.4/LICENSE */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
/**
 * @license
 * Based off baseSortedIndex function in Lodash <https://lodash.com/>
 * Copyright JS Foundation and other contributors <https://js.foundation/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */
//# sourceMappingURL=hydrogen-web.js.map
